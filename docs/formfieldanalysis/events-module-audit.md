# Form Field Wiring Audit: Events Module

**Audited:** 2026-02-12
**Baseline:** docs/FORM-FIELDS-REFERENCE.md
**DB Tables:** `class_events`, `class_material_tracking`

## Summary

| Metric | Count |
|--------|-------|
| Fields checked | 25 |
| Forward path PASS | 24 |
| Forward path WARN | 1 |
| Forward path FAIL | 0 |
| Reverse path PASS | 22 |
| Reverse path WARN | 3 |
| Reverse path FAIL | 0 |
| Dynamic wiring PASS | 5 |
| Dynamic wiring FAIL | 0 |
| Orphaned DB columns | 2 |
| Orphaned form fields | 0 |

---

## Sub-Audit 1: Event Tasks (`[wecoza_event_tasks]`)

### Forward Path (Form -> DB)

| Field | HTML | Controller | Sanitize | Validate | Repo Whitelist | DB Column | Status |
|-------|------|-----------|----------|----------|----------------|-----------|--------|
| `class_id` (AJAX) | `data-class-id` on panel | `getPostInt()` | `absint` via typed getter | `> 0` | N/A (reads `classes`) | `classes.class_id` | PASS |
| `task_id` (AJAX) | `data-task-id` on list items | `getPostString()` | String type | `!== ''` | N/A | Derived from `event_dates` | PASS |
| `task_action` (AJAX) | `data-action` on buttons | `getPostString()` | String type | `in_array(['complete','reopen'])` | N/A | Method dispatch | PASS |
| `note` (AJAX) | `.wecoza-task-note` input | `getPostString()` | `trim()` | JS `note_required` check | N/A | `classes.event_dates` JSONB | PASS |
| `nonce` (AJAX) | `data-nonce` on container | `check_ajax_referer` | WP nonce verification | N/A | N/A | N/A | PASS |

### Reverse Path (DB -> Form)

| DB Column | Repo Fetch | Controller Pass | Field Mapping | Escaping | Edit Pre-pop | Status |
|-----------|-----------|-----------------|---------------|----------|-------------|--------|
| `classes.*` (joined) | `ClassTaskRepository::fetchClasses()` SELECT with JOINs | Via `ClassTaskService` -> `ClassTaskPresenter` | Direct name match | `esc_html()`, `esc_attr()` throughout | N/A (read-only display) | PASS |
| `event_dates` (JSONB) | Included in SELECT `*` | `TaskManager::buildTasksFromEvents()` | JSONB parsed by TaskManager | `esc_html()` on task labels/notes | Task note pre-populated via `$task['note']` | PASS |

### Dynamic Data Wiring

| Field | Source Type | AJAX Registered | JS Calls | Cascade Complete | Hidden Updated | Status |
|-------|-----------|-----------------|----------|-----------------|----------------|--------|
| Search input (`data-role="tasks-search"`) | Client-side filter | N/A | N/A | N/A | N/A | PASS |
| Filter select (`data-role="open-task-filter"`) | Presenter-generated options | N/A | N/A | N/A | N/A | PASS |

---

## Sub-Audit 2: Material Tracking (`[wecoza_material_tracking]`)

### Forward Path (Form -> DB)

| Field | HTML | Controller | Sanitize | Validate | Repo Whitelist | DB Column | Status |
|-------|------|-----------|----------|----------|----------------|-----------|--------|
| `class_id` (AJAX) | `data-class-id` on checkbox | `absint($_POST['class_id'])` | `absint()` | `> 0` | N/A | `classes.class_id` | PASS |
| `event_index` (AJAX) | `data-event-index` on checkbox | `absint($_POST['event_index'])` | `absint()` | `!== null` | N/A | `classes.event_dates` JSONB index | PASS |
| `nonce` (AJAX) | `data-nonce` on checkbox | `check_ajax_referer` | WP nonce verification | N/A | N/A | N/A | PASS |

### Reverse Path (DB -> Form)

| DB Column | Repo Fetch | Controller Pass | Field Mapping | Escaping | Edit Pre-pop | Status |
|-----------|-----------|-----------------|---------------|----------|-------------|--------|
| `classes.event_dates` JSONB | `getTrackingDashboardData()` CROSS JOIN LATERAL | Via `MaterialTrackingDashboardService` -> `MaterialTrackingPresenter` | Direct field extraction from JSONB | `esc_html()`, `esc_attr()` | Checkbox state from `delivery_status` | PASS |
| `class_material_tracking.*` | LEFT JOIN in dashboard query | Presenter formats badges | Direct column names | HTML generated in presenter | N/A (display only) | WARN |

**Note:** `notification_badge_html` and `status_badge_html` are output without `esc_html()` in `list-item.php:55-61`, but the HTML is generated by `MaterialTrackingPresenter` with hard-coded safe markup. Safe but not following the escaping-at-output convention.

### Dynamic Data Wiring

| Field | Source Type | AJAX Registered | JS Calls | Cascade Complete | Hidden Updated | Status |
|-------|-----------|-----------------|----------|-----------------|----------------|--------|
| Search input (`#material-tracking-search`) | Client-side filter | N/A | N/A | N/A | N/A | PASS |
| Status filter (`#status-filter`) | Hardcoded options | N/A | N/A | N/A | N/A | PASS |

---

## Sub-Audit 3: AI Summary Notifications (`[wecoza_insert_update_ai_summary]`)

### Forward Path (Form -> DB)

| Field | HTML | Controller | Sanitize | Validate | Repo Whitelist | DB Column | Status |
|-------|------|-----------|----------|----------|----------------|-----------|--------|
| `event_id` (mark viewed) | `data-event-id` on item | `filter_input(INPUT_POST, FILTER_VALIDATE_INT)` | Filter validates int | `> 0` | `ClassEventRepository::markViewed()` | `class_events.viewed_at` | PASS |
| `event_id` (acknowledge) | `data-event-id` on button | `filter_input(INPUT_POST, FILTER_VALIDATE_INT)` | Filter validates int | `> 0` | `ClassEventRepository::markAcknowledged()` | `class_events.acknowledged_at` | PASS |
| `nonce` (AJAX) | `data-nonce` on wrapper | `check_ajax_referer` | WP nonce verification | N/A | N/A | N/A | PASS |

### Reverse Path (DB -> Form)

| DB Column | Repo Fetch | Controller Pass | Field Mapping | Escaping | Edit Pre-pop | Status |
|-----------|-----------|-----------------|---------------|----------|-------------|--------|
| `event_id` | `getTimeline()` / `findByEntity()` | `NotificationDashboardService.transformForDisplay()` | Direct | `esc_attr()` | N/A | PASS |
| `event_type` | SELECT `*` | Transform extracts | Via `EventType->value` | `esc_html()` | N/A | PASS |
| `event_data` (JSONB) | SELECT `*` | Transform extracts `new_row` | class_code, class_subject from JSONB | `esc_html()` | N/A | PASS |
| `ai_summary` (JSONB) | SELECT `*` | Transform extracts summary text | `ai_summary['summary']` | **WARN: `summary_html` output unescaped** | N/A | WARN |
| `viewed_at` | SELECT `*` | Transform formats timestamp | `is_read = isViewed()` | `esc_attr()` on data attr | Read state reflected in CSS class | PASS |
| `acknowledged_at` | SELECT `*` | Transform formats timestamp | `is_acknowledged = isAcknowledged()` | `esc_attr()` on data attr | Button disabled if acknowledged | PASS |
| `notification_status` | SELECT `*` | Transform passes through | Direct | `esc_html(strtoupper())` | Status badge rendered | PASS |
| `created_at` | SELECT `*` | `formatTimestamp()` | Direct | `esc_html()` | Displayed as "F j, Y g:i a" | PASS |

### Dynamic Data Wiring

| Field | Source Type | AJAX Registered | JS Calls | Cascade Complete | Hidden Updated | Status |
|-------|-----------|-----------------|----------|-----------------|----------------|--------|
| Search input (`data-role="ai-search"`) | Client-side filter | N/A | N/A | N/A | N/A | PASS |
| Operation filter (`data-role="operation-filter"`) | Hardcoded options (INSERT/UPDATE/DELETE) | N/A | N/A | N/A | N/A | PASS |
| Unread filter (`data-role="unread-filter"`) | Client-side toggle | N/A | N/A | N/A | N/A | PASS |

---

## Sub-Audit 4: Admin Notification Settings (WP Admin)

### Forward Path (Form -> DB)

| Field | HTML | Controller | Sanitize | Validate | Repo Whitelist | DB Column | Status |
|-------|------|-----------|----------|----------|----------------|-----------|--------|
| `wecoza_ai_summary_enabled` | checkbox + hidden default=0 | `sanitizeCheckbox()` | `(string)(int)(bool)` | WP Settings API | N/A | `wp_options` | PASS |
| `wecoza_ai_summary_api_key` | password input | `sanitizeApiKey()` | Via `OpenAIConfig` | sk-... format | N/A | `wp_options` | PASS |
| `wecoza_notification_recipients[CLASS_INSERT]` | textarea | `sanitizeRecipientSettings()` | `sanitize_email()` + `filter_var(FILTER_VALIDATE_EMAIL)` | Invalid emails rejected with admin notice | N/A | `wp_options` | PASS |
| `wecoza_notification_recipients[CLASS_UPDATE]` | textarea | `sanitizeRecipientSettings()` | Same | Same | N/A | `wp_options` | PASS |
| `wecoza_notification_recipients[LEARNER_ADD]` | textarea | `sanitizeRecipientSettings()` | Same | Same | N/A | `wp_options` | PASS |
| `wecoza_notification_recipients[LEARNER_REMOVE]` | textarea | `sanitizeRecipientSettings()` | Same | Same | N/A | `wp_options` | PASS |
| `wecoza_notification_recipients[STATUS_CHANGE]` | textarea | `sanitizeRecipientSettings()` | Same | Same | N/A | `wp_options` | PASS |
| `event_type` (AJAX test) | `data-event-type` on button | `sanitize_text_field()` | `sanitize_text_field()` | `!== ''` | N/A | N/A (email only) | PASS |
| `nonce` (AJAX test) | `data-nonce` on button | `check_ajax_referer` | WP nonce verification | N/A | N/A | N/A | PASS |

### Reverse Path (DB -> Form)

| DB Column | Repo Fetch | Controller Pass | Field Mapping | Escaping | Edit Pre-pop | Status |
|-----------|-----------|-----------------|---------------|----------|-------------|--------|
| `wecoza_ai_summary_enabled` | `get_option()` | `renderAiEnabledField()` | Direct | `checked()` WP helper | Checkbox state | PASS |
| `wecoza_ai_summary_api_key` | `OpenAIConfig::getApiKey()` | `renderAiApiKeyField()` | Masked display | `esc_html()` | Password field intentionally blank | PASS |
| `wecoza_notification_recipients` | `NotificationSettings::getAllRecipientSettings()` | `renderRecipientsField()` | Per-event-type array | `esc_textarea()` | Comma-separated emails pre-populated | PASS |

---

## Orphan Detection

### DB Columns Without Form Fields

| Table | Column | Data Type | Possible Reason |
|-------|--------|-----------|----------------|
| `class_material_tracking` | `materials_delivered_at` | `timestamp` | **Never set to a value.** `markDelivered()` updates `classes.event_dates` JSONB, not this column. The column exists in schema but has no write path. |
| `class_material_tracking` | `delivery_status` = 'delivered' | `varchar(20)` | **'delivered' state unreachable.** `markNotificationSent()` sets to 'notified', but no code path sets to 'delivered'. Constraint allows it (`pending`, `notified`, `delivered`) but only first two are used. |

**Note:** All `class_events` columns are system-managed (populated by `EventDispatcher`, `AISummaryService`, cron jobs, and AJAX handlers). No orphans - all columns have clear read/write paths.

### Form Fields Without DB Columns

| Field | Type | UI-Only? | Notes |
|-------|------|----------|-------|
| Search input (`data-role="tasks-search"`) | search | Yes | Client-side filter only |
| Filter select (`data-role="open-task-filter"`) | select | Yes | Client-side filter only |
| Search input (`data-role="ai-search"`) | search | Yes | Client-side filter only |
| Operation filter (`data-role="operation-filter"`) | select | Yes | Client-side filter only |
| Unread filter (`data-role="unread-filter"`) | checkbox | Yes | Client-side filter only |
| Search input (`#material-tracking-search`) | search | Yes | Client-side filter only |
| Status filter (`#status-filter`) | select | Yes | Client-side filter only |
| All nonces | hidden | Yes | CSRF tokens |

All are correctly identified as UI-only. No orphans.

### Unused AJAX Endpoints

| Action | Registered In | Called From JS? |
|--------|--------------|-----------------|
| `wecoza_events_task_update` | `TaskController.php:43` | Yes - inline JS in `EventTasksShortcode.php` |
| `wecoza_mark_material_delivered` | `MaterialTrackingController.php:41` | Yes - inline JS in `dashboard.php` |
| `wecoza_mark_notification_viewed` | `AISummaryShortcode.php:60` | Yes - inline JS in `AISummaryShortcode.php` |
| `wecoza_mark_notification_acknowledged` | `AISummaryShortcode.php:61` | Yes - inline JS in `AISummaryShortcode.php` |
| `wecoza_send_test_notification` | `SettingsPage.php:93` | Yes - inline JS in `SettingsPage.php` + `notification-settings.php` |

**All endpoints are called.** No orphaned AJAX endpoints.

### JS Selectors Targeting Missing DOM

| Selector | JS File | Found In View? |
|----------|---------|----------------|
| `#stat-pending` | `dashboard.php` inline JS | Yes - `statistics.php:30` (`id="stat-<?php echo esc_attr($key); ?>"`) |
| `#stat-completed` | `dashboard.php` inline JS | Yes - same pattern |
| `.stat-item` | `dashboard.php` inline JS | Yes - `statistics.php:27` |
| `#material-tracking-search` | `dashboard.php` inline JS | Yes - `dashboard.php:31` |
| `#status-filter` | `dashboard.php` inline JS | Yes - `dashboard.php:41` |
| `#refresh-dashboard` | `dashboard.php` inline JS | Yes - `dashboard.php:46` |
| `#last-updated` | `dashboard.php` inline JS | Yes - `dashboard.php:121` |
| `#visible-count` | `dashboard.php` inline JS | Yes - `dashboard.php:122` |
| `#total-count` | `dashboard.php` inline JS | Yes - `dashboard.php:123` |
| `[data-role="mark-read-btn"]` | `item.php:92` button | **Not explicitly handled** - works incidentally via parent `summary-item` click |

**All selectors resolve** to existing DOM elements.

---

## Issues

### Critical (Broken Wiring)

None found.

### Warning (Missing Best Practice)

1. **`summary_html` output without explicit escaping** - `card.php:54`, `timeline.php:120`, `item.php:79` output `$summary['summary_html']` without `esc_html()`. Mitigated by `AISummaryPresenter::formatSummaryAsHtml()` which escapes each line with `esc_html()` before wrapping in HTML tags. **Risk: Low** - if the AI summary text were injected before reaching the presenter, it would be escaped. However, the pattern of outputting pre-built HTML without late escaping deviates from WordPress escaping best practices.
   - Files: `views/events/ai-summary/card.php:54`, `views/events/ai-summary/timeline.php:120`, `views/events/ai-summary/item.php:79`

2. **`notification_badge_html` / `status_badge_html` unescaped output** - `views/events/material-tracking/list-item.php:55,60` output presenter-generated HTML directly. Same mitigation as above (presenter generates safe hard-coded HTML). **Risk: Low**.

3. **`class_material_tracking.materials_delivered_at` never updated** - The column exists in schema with a clear purpose (track when materials were physically delivered) but `MaterialTrackingRepository::markDelivered()` updates `classes.event_dates` JSONB instead. The column is effectively dead.
   - File: `src/Events/Repositories/MaterialTrackingRepository.php:86-135`

4. **`class_material_tracking.delivery_status` 'delivered' state unreachable** - The CHECK constraint allows `pending`, `notified`, `delivered` but no code path sets the value to `delivered`. Only `markNotificationSent()` changes this column (to `notified`).
   - File: `src/Events/Repositories/MaterialTrackingRepository.php:51-77`

### Info (Observations)

1. **All form interactions are AJAX-driven** - The Events module has no traditional form POST handling. All data mutations happen via `wp_ajax_*` handlers. This is a clean pattern.

2. **Event data is system-generated** - The `class_events` table is populated exclusively by `EventDispatcher` (triggered by class/learner operations), not by direct user form input. Users only interact with events via view/acknowledge actions.

3. **Task data lives in `classes.event_dates` JSONB** - The Event Tasks sub-module reads/writes task state to the `classes` table's `event_dates` JSONB column, not to `class_events`. This is by design (tasks are derived from class event dates).

4. **`item.php` "Mark Read" button** - The `data-role="mark-read-btn"` button in `views/events/ai-summary/item.php:90-95` has no dedicated JS handler. It works incidentally because clicking it triggers the parent `summary-item` click handler which calls `markAsViewed()`. The button provides visual affordance but is functionally redundant with the auto-mark-on-click behavior.

5. **Duplicate test notification JS** - The test notification click handler JS is defined in both `SettingsPage.php:320-346` and `views/events/admin/notification-settings.php:80-112`. The `notification-settings.php` view template appears to be unused (the settings page renders fields directly via `SettingsPage::renderRecipientsField()`).

6. **Admin settings use WP Options API** - All admin settings (`wecoza_ai_summary_enabled`, `wecoza_ai_summary_api_key`, `wecoza_notification_recipients`) are stored in `wp_options`, not PostgreSQL. This is correct for WordPress settings.

---

## Recommendations

1. **Decide on `class_material_tracking` table purpose** - Either:
   - (a) Update `MaterialTrackingRepository::markDelivered()` to also set `materials_delivered_at = NOW()` and `delivery_status = 'delivered'` on the `class_material_tracking` table, keeping it in sync with `classes.event_dates` JSONB. Path: `src/Events/Repositories/MaterialTrackingRepository.php:86-135`
   - (b) Remove the `materials_delivered_at` column and simplify the `delivery_status` CHECK constraint to only `('pending', 'notified')` since 'delivered' is never used. Requires a migration.
   - **Recommended: Option (a)** - adds a single SQL statement to `markDelivered()` for data consistency.

2. **Add dedicated handler for `mark-read-btn`** in `AISummaryShortcode.php` inline JS to make the button behavior explicit rather than incidental. Low priority since it works correctly today.

3. **Remove duplicate JS** in `views/events/admin/notification-settings.php` if the file is unused, or consolidate the test notification handler into a single location.
