# Milestone v2.0: Clients Integration

**Status:** SHIPPED 2026-02-12
**Phases:** 21-25
**Total Plans:** 10

## Overview

Integrated standalone wecoza-clients-plugin into wecoza-core as unified Clients module — client CRUD, location management, sites hierarchy, Google Maps integration, CSV export. Eliminates standalone plugin dependency, consolidates to single codebase with consistent patterns.

## Phases

### Phase 21: Foundation Architecture

**Goal**: Establish Clients module namespace, database, views, and integration hooks
**Depends on**: Phase 20 (v1.3 complete)
**Plans**: 2 plans

Plans:
- [x] 21-01: Foundation — autoloader, config, ViewHelpers, 4 Models, 2 Repositories
- [x] 21-02: Controllers, Views, JS assets, AJAX handlers, wecoza-core.php wiring

**Details:**
- Registered WeCoza\Clients\ namespace with PSR-4 autoloading
- Migrated 4 Models from DatabaseService to wecoza_db() singleton
- Created 2 Repositories with column whitelisting security
- Migrated 6 view templates and 6 JavaScript assets
- Created ClientAjaxHandlers with AjaxSecurity patterns
- Wired Clients module into wecoza-core.php entry point

### Phase 22: Client Management

**Goal**: Full client CRUD with hierarchy, search, filter, CSV export, and statistics
**Depends on**: Phase 21
**Plans**: 2 plans

Plans:
- [x] 22-01: Shortcode rendering verification and wiring fixes
- [x] 22-02: AJAX endpoint testing and end-to-end CRUD verification

**Details:**
- Fixed hydrate() bug in ClientsModel and LocationsModel (array return pattern)
- Added CRUD convenience methods to PostgresConnection
- Implemented soft-delete with deleted_at timestamp column
- Verified all 6 shortcodes render correctly
- Fixed core CRUD AJAX endpoints and JS-PHP connectivity
- Fixed secondary AJAX endpoints (sites, locations, hierarchy)

### Phase 23: Location Management

**Goal**: Location CRUD with Google Maps autocomplete, geocoordinates, and duplicate detection
**Depends on**: Phase 21
**Plans**: 2 plans

Plans:
- [x] 23-01: Shortcode rendering, DOM wiring fixes, and method signature corrections
- [x] 23-02: AJAX endpoint fixes and end-to-end CRUD verification

**Details:**
- Fixed DOM ID mismatches between JS and view templates
- Fixed controller method calling correct model method (updateById)
- Fixed AJAX action names and localization keys
- Removed Google Maps from list page (server-side ILIKE search only)
- Added submit button visibility on AJAX error for user recovery

### Phase 24: Sites Hierarchy

**Goal**: Head sites and sub-sites with parent-child relationships and location hydration
**Depends on**: Phase 22, Phase 23
**Plans**: 2 plans

Plans:
- [x] 24-01: Verify and fix site creation AJAX wiring, form-to-handler data flow
- [x] 24-02: Verify client listing hydration, modal display, cache invalidation

**Details:**
- Fixed inline script AJAX action names and nonce in clients table
- Cached getTableColumns() results per table per request (~16 redundant queries eliminated)
- Removed redundant getHeadSite() call (already hydrated by getById)
- Added cache refresh after sub-site save operations
- Verified all 5 standalone site AJAX endpoints end-to-end

### Phase 25: Integration Testing & Cleanup

**Goal**: Verify full integration and remove standalone plugin artifacts
**Depends on**: Phase 21, Phase 22, Phase 23, Phase 24
**Plans**: 2 plans

Plans:
- [x] 25-01: E2E feature parity testing, standalone plugin deactivation verification
- [x] 25-02: Repository cleanup (.integrate/done/wecoza-clients-plugin removal)

**Details:**
- Created 44-check automated feature parity test (100% pass)
- Human-verified standalone plugin deactivation with zero breakage
- Removed .integrate/ staging area from repository
- Confirmed .gitignore covers integration workspace

---

## Milestone Summary

**Key Decisions:**
- Full integration into wecoza-core (not wrapper/bridge pattern)
- Models return arrays from getById(), not model instances
- CRUD convenience methods added to PostgresConnection
- Soft-delete via deleted_at timestamp, queries filter WHERE deleted_at IS NULL
- JS localization uses camelCase keys matching existing conventions
- Inline script fixes preferred over extracting to separate JS files
- Cache getTableColumns() results to eliminate redundant schema queries

**Issues Resolved:**
- hydrate() method not available on non-BaseModel models
- DOM ID mismatches between JS and view templates
- AJAX action name inconsistencies (missing wecoza_ prefix)
- Nonce action name standardization across inline scripts
- Google Maps incorrectly loaded on list page (not needed)
- Redundant information_schema queries in model constructors

**Issues Deferred:**
- None from v2.0

**Technical Debt Incurred:**
- None from v2.0

**Pre-existing from v1.3 (carried forward):**
- AJAX handler wecoza_mark_material_delivered needs event_index parameter
- Controllers pass deprecated notification_type/days_range params to service

---

_For current project status, see .planning/ROADMAP.md_
