# Milestone v3.1: Form Field Wiring Fixes

**Status:** ✅ SHIPPED 2026-02-13
**Phases:** 31-35
**Total Plans:** 8

## Overview

Fix all critical, warning, and cleanup issues from comprehensive form field wiring audits across 5 modules. Addressed 6 critical issues (data loss, broken wiring), 28 warnings (security, sanitization, dead code). Source audits in `docs/formfieldanalysis/*.md` provided exact file paths, line numbers, and recommended fixes.

## Phases

### Phase 31: Learners Module Fixes

**Goal**: Fix all critical data loss bugs and security warnings in Learners module forms.
**Depends on**: None
**Plans**: 2 plans

Plans:
- [x] 31-01: Verify all 10 LRNR requirements against current code (safety-first)
- [x] 31-02: Implement remaining fixes (XSS patch, doc cleanup, dead code removal)

**Details:**
- 10 requirements (LRNR-01 through LRNR-10)
- 7 of 10 already fixed by prior commit e47bc30
- XSS vulnerability in showAlert() fixed using DOM construction (.text() instead of .html())
- Legacy template deleted, dead code removed
- All nopriv AJAX registrations removed

### Phase 32: Classes Module Fixes

**Goal**: Fix critical reverse path bugs and security issues in Classes module forms.
**Depends on**: None
**Plans**: 2 plans

Plans:
- [x] 32-01: Surgical fixes — data integrity, security, sanitization, view pre-selection (CLS-01 to CLS-07, CLS-09)
- [x] 32-02: DB migration — agents/supervisors from static arrays to DB queries with caching (CLS-08)

**Details:**
- 9 requirements (CLS-01 through CLS-09)
- Fixed order_nr reverse path (data loss on update)
- Set class_agent from initial_class_agent on create
- Removed nopriv from QA write endpoints
- Sanitized date arrays and FK IDs
- Replaced hardcoded agent/supervisor arrays with DB queries + 12hr transient caching

### Phase 33: Agents Module Fixes

**Goal**: Fix postal code reverse path bug and add missing server-side validation.
**Depends on**: None
**Plans**: 2 plans

Plans:
- [x] 33-01: Validation hardening + whitelist cleanup (AGT-02, AGT-03, AGT-04, AGT-05)
- [x] 33-02: DRY refactor — extract shared display methods into AgentDisplayService (AGT-06)

**Details:**
- 6 requirements (AGT-01 through AGT-06)
- Added server-side validation for 14 HTML-required fields
- Sanitized working areas with absint()
- Removed dead columns from repository whitelists
- Created AgentDisplayService with 4 shared methods, eliminating ~200 lines of duplication

### Phase 34: Clients Module Fixes

**Goal**: Remove duplicate AJAX submission and unify nonce handling across client forms.
**Depends on**: None
**Plans**: 1 plan

Plans:
- [x] 34-01: Fix all 5 CLT requirements — remove inline handler, add nonce field, clean whitelists, unify nonces, remove unused endpoints

**Details:**
- 5 requirements (CLT-01 through CLT-05)
- Removed 208-line inline script (duplicate of client-capture.js)
- Added wp_nonce_field to capture form
- Unified nonce action to clients_nonce_action
- Removed phantom client_town_id from whitelists
- Removed 7 unused AJAX endpoints (171 lines)

### Phase 35: Events Module Fixes

**Goal**: Add late escaping for presenter-generated HTML and sync tracking table with JSONB.
**Depends on**: None
**Plans**: 1 plan

Plans:
- [x] 35-01: Late escaping for presenter HTML, tracking table sync in markDelivered(), remove duplicate JS file

**Details:**
- 4 requirements (EVT-01 through EVT-04)
- Added wp_kses_post() late escaping on all presenter-generated HTML (5 output points)
- Synced class_material_tracking table in markDelivered() (materials_delivered_at + delivery_status)
- Deleted orphaned notification-settings.php (113 lines, never loaded)

---

## Milestone Summary

**Key Decisions:**
- Form field wiring audit before fixes (comprehensive audit identifies all issues before coding)
- Module-by-module fix approach (independent scopes, testable per module)
- Safe to delete legacy learner-form.view.php (dead code, zero references)
- XSS vulnerability in learners-app.js showAlert() using .html() (security risk)
- Sponsors feature is fully implemented, not orphaned (audit claim was incorrect)
- Keep nopriv on read-only QA endpoints (site requires auth for all pages)
- Use !isset or === '' for quantum score validation (empty(0) returns true)
- Supervisors drawn from same agents pool (no supervisor column in DB)
- Removed entire 208-line inline script from update form (all in client-capture.js)
- Use wp_kses_post() for presenter HTML (allows intended markup, strips dangerous tags)
- Do NOT wrap tracking table sync in transaction (JSONB is source of truth)
- Delete notification-settings.php entirely (never loaded, zero references)

**Issues Resolved:**
- XSS vulnerability in Learners showAlert function
- Data loss: order_nr overwritten on class update
- Data loss: class_agent null on new class creation
- Double AJAX submission on every client update
- Unauthenticated access to QA write endpoints
- 7 unused AJAX endpoints increasing attack surface
- Hardcoded fake agent/supervisor names in class forms
- Unescaped presenter-generated HTML in Events views
- Tracking table delivery_status never reaching 'delivered'
- ~200 lines of duplicated display code in Agents module

**Issues Deferred:**
- AJAX handler needs event_index parameter support (v1.3 tech debt)
- Controllers pass deprecated params to service (v1.3 tech debt)
- agent_meta table doesn't exist (v3.0 FEAT-02)

**Technical Debt Incurred:**
- None significant — this milestone was specifically about reducing tech debt

---

_For current project status, see .planning/ROADMAP.md_
