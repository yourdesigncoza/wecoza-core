---
phase: 50-ajax-endpoints
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Classes/Ajax/AttendanceAjaxHandlers.php
  - src/Classes/Services/AttendanceService.php
  - wecoza-core.php
  - src/Classes/Controllers/ClassController.php
autonomous: true
requirements: [UI-06, ATT-05]

must_haves:
  truths:
    - "wecoza_attendance_get_sessions returns session list with correct status and action state for each session"
    - "wecoza_attendance_capture creates a session record, calls logHours() for each learner, and returns success"
    - "wecoza_attendance_mark_exception creates a zero-hours session with the correct exception status"
    - "wecoza_attendance_get_detail returns per-learner hours breakdown for a captured session"
    - "wecoza_attendance_admin_delete reverses hours from tracking accumulators and removes the session record"
    - "All five endpoints validate nonce and return structured JSON error responses on failure"
  artifacts:
    - path: "src/Classes/Ajax/AttendanceAjaxHandlers.php"
      provides: "Five AJAX handler functions + registration function"
      contains: "register_attendance_ajax_handlers"
    - path: "src/Classes/Services/AttendanceService.php"
      provides: "getSessionDetail service wrapper for repository getSessionsWithLearnerHours"
      contains: "getSessionDetail"
    - path: "wecoza-core.php"
      provides: "require_once for AttendanceAjaxHandlers.php"
      contains: "AttendanceAjaxHandlers"
    - path: "src/Classes/Controllers/ClassController.php"
      provides: "wp_localize_script attendance config (nonce + ajaxUrl) on single class display"
      contains: "attendanceNonce"
  key_links:
    - from: "src/Classes/Ajax/AttendanceAjaxHandlers.php"
      to: "src/Classes/Services/AttendanceService.php"
      via: "new AttendanceService() in each handler"
      pattern: "new AttendanceService"
    - from: "wecoza-core.php"
      to: "src/Classes/Ajax/AttendanceAjaxHandlers.php"
      via: "require_once"
      pattern: "AttendanceAjaxHandlers"
    - from: "src/Classes/Controllers/ClassController.php"
      to: "wp_localize_script"
      via: "attendanceNonce in WeCozaSingleClass localization"
      pattern: "attendanceNonce"
---

<objective>
Create all five AJAX handlers for attendance operations — get sessions, capture, mark exception, get detail, admin delete — with nonce validation, input normalization (camelCase to snake_case), range validation (0 <= hours_present <= scheduledHours), and structured JSON responses. Wire registration into wecoza-core.php and add attendance nonce config to ClassController.

Purpose: Connect the complete backend service layer (AttendanceService from Phase 49) to the frontend, making all attendance operations callable via AJAX.
Output: Working AJAX endpoints ready for Phase 51 JS to consume.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/49-backend-logic/49-02-SUMMARY.md

Key source files to read:
@src/Classes/Services/AttendanceService.php
@src/Classes/Repositories/AttendanceRepository.php
@src/Learners/Ajax/ProgressionAjaxHandlers.php (pattern reference)
@src/Classes/Controllers/ClassController.php
@wecoza-core.php (around line 658 — where to add require_once)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AttendanceAjaxHandlers with five handlers, service wrapper, and wiring</name>
  <files>
    src/Classes/Ajax/AttendanceAjaxHandlers.php
    src/Classes/Services/AttendanceService.php
    wecoza-core.php
    src/Classes/Controllers/ClassController.php
  </files>
  <action>
**1. Add `getSessionDetail()` wrapper to AttendanceService**

Open `src/Classes/Services/AttendanceService.php`. Add a new public method below `deleteAndReverseHours()`:

```php
/**
 * Get per-learner hours breakdown for a captured session.
 *
 * Service wrapper around AttendanceRepository::getSessionsWithLearnerHours().
 * Phase 50 audit: repository method should be accessed through service, not directly.
 *
 * @param int $sessionId Session ID
 * @return array Per-learner hours rows
 * @throws Exception if session not found
 */
public function getSessionDetail(int $sessionId): array
{
    $session = $this->repository->findById($sessionId);

    if (!$session) {
        throw new Exception("Session not found: {$sessionId}");
    }

    return [
        'session'  => $session,
        'learners' => $this->repository->getSessionsWithLearnerHours($sessionId),
    ];
}
```

**2. Create `src/Classes/Ajax/AttendanceAjaxHandlers.php`**

Follow the exact pattern from `src/Learners/Ajax/ProgressionAjaxHandlers.php`:
- Namespace: `WeCoza\Classes\Ajax`
- Use `check_ajax_referer()` with nonce action `wecoza_attendance_nonce` and key `nonce`
- All handlers use try/catch wrapping `wp_send_json_success` / `wp_send_json_error`
- No `nopriv` actions (site requires login per CLAUDE.md)

**Nonce helper:** Create a private helper at the top of the file:

```php
function verify_attendance_nonce(): void {
    if (!check_ajax_referer('wecoza_attendance_nonce', 'nonce', false)) {
        wp_send_json_error(['message' => 'Security check failed']);
        exit;
    }
}
```

**Handler 1: `handle_attendance_get_sessions()`**
- Action: `wecoza_attendance_get_sessions`
- Method: GET
- Params: `class_id` (required, intval)
- Calls: `$service->generateSessionList((int) $classId)`
- Returns: `wp_send_json_success(['sessions' => $sessions])`

**Handler 2: `handle_attendance_capture()`**
- Action: `wecoza_attendance_capture`
- Method: POST
- Params: `class_id` (intval), `session_date` (sanitize_text_field, validate YYYY-MM-DD regex), `learner_hours` (array)
- **Input normalization (CRITICAL from audit):** The POST `learner_hours` array may contain camelCase keys from JS. Normalize each entry:
  ```php
  $normalizedHours = [];
  foreach ($rawLearnerHours as $entry) {
      $learnerId    = isset($entry['learner_id']) ? (int) $entry['learner_id'] : (isset($entry['learnerId']) ? (int) $entry['learnerId'] : 0);
      $hoursPresent = isset($entry['hours_present']) ? (float) $entry['hours_present'] : (isset($entry['hoursPresent']) ? (float) $entry['hoursPresent'] : 0.0);

      if ($learnerId <= 0) {
          continue; // skip invalid entries
      }

      $normalizedHours[] = [
          'learner_id'    => $learnerId,
          'hours_present' => $hoursPresent,
      ];
  }
  ```
- **Range validation (CRITICAL from audit):** After normalization, fetch scheduled hours from the session list for this date:
  ```php
  $sessions = $service->generateSessionList($classId);
  $scheduledHours = 0.0;
  foreach ($sessions as $s) {
      if ($s['date'] === $sessionDate) {
          $scheduledHours = (float) $s['scheduled_hours'];
          break;
      }
  }

  foreach ($normalizedHours as $entry) {
      if ($entry['hours_present'] < 0 || $entry['hours_present'] > $scheduledHours) {
          throw new Exception("hours_present must be between 0 and {$scheduledHours} for learner {$entry['learner_id']}");
      }
  }
  ```
- Calls: `$service->captureAttendance($classId, $sessionDate, $normalizedHours, get_current_user_id())`
- Returns: `wp_send_json_success($result)` (result contains session_id, captured_count, errors)

**Handler 3: `handle_attendance_mark_exception()`**
- Action: `wecoza_attendance_mark_exception`
- Method: POST
- Params: `class_id` (intval), `session_date` (sanitize_text_field + YYYY-MM-DD regex), `exception_type` (sanitize_key, camelCase normalize from `exceptionType`), `notes` (optional, sanitize_textarea_field)
- Calls: `$service->markException($classId, $sessionDate, $exceptionType, get_current_user_id(), $notes)`
- Returns: `wp_send_json_success($result)` (result contains session_id, status)

**Handler 4: `handle_attendance_get_detail()`**
- Action: `wecoza_attendance_get_detail`
- Method: GET
- Params: `session_id` (required, intval)
- Calls: `$service->getSessionDetail((int) $sessionId)`
- Returns: `wp_send_json_success($result)` (result contains session, learners)

**Handler 5: `handle_attendance_admin_delete()`**
- Action: `wecoza_attendance_admin_delete`
- Method: POST
- Params: `session_id` (required, intval)
- **Capability check:** `current_user_can('manage_options')` — admin-only for delete
- Calls: `$service->deleteAndReverseHours((int) $sessionId, get_current_user_id())`
- Returns: `wp_send_json_success(['deleted' => true, 'session_id' => $sessionId])`

**Registration function:** `register_attendance_ajax_handlers()` with `add_action('init', ...)` at bottom of file, registering all five as `wp_ajax_` only (no nopriv).

**3. Wire into wecoza-core.php**

After the ProgressionAjaxHandlers require_once block (around line 659), add:

```php
/*
|--------------------------------------------------------------------------
| Load Attendance AJAX Handlers
|--------------------------------------------------------------------------
|
| AJAX handlers for class attendance operations: session list, capture,
| mark exception, session detail, and admin delete.
|
*/

require_once WECOZA_CORE_PATH .
    "src/Classes/Ajax/AttendanceAjaxHandlers.php";
```

**4. Add attendance nonce to ClassController localize**

In `ClassController::enqueueAndLocalizeSingleClassScript()`, add `attendanceNonce` to the `WeCozaSingleClass` localize array:

```php
'attendanceNonce' => wp_create_nonce('wecoza_attendance_nonce'),
```

Add it after the existing `classNonce` entry in the wp_localize_script call.
  </action>
  <verify>
    <automated>cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core && php -l src/Classes/Ajax/AttendanceAjaxHandlers.php && php -l src/Classes/Services/AttendanceService.php && php -l wecoza-core.php && php -l src/Classes/Controllers/ClassController.php && echo "All files pass lint check"</automated>
    <manual>
1. Verify src/Classes/Ajax/AttendanceAjaxHandlers.php exists with 5 handler functions + register function
2. Verify getSessionDetail() method exists on AttendanceService
3. Verify wecoza-core.php has require_once for AttendanceAjaxHandlers.php
4. Verify ClassController localize includes attendanceNonce
5. Grep for check_ajax_referer in all 5 handlers
    </manual>
  </verify>
  <done>
    - Five AJAX handlers exist in src/Classes/Ajax/AttendanceAjaxHandlers.php: get_sessions, capture, mark_exception, get_detail, admin_delete
    - All five handlers verify nonce via check_ajax_referer('wecoza_attendance_nonce', 'nonce', false)
    - handle_attendance_capture normalizes camelCase POST keys to snake_case before passing to service
    - handle_attendance_capture validates 0 <= hours_present <= scheduledHours before service call
    - handle_attendance_admin_delete checks manage_options capability
    - getSessionDetail() service wrapper added to AttendanceService
    - wecoza-core.php requires AttendanceAjaxHandlers.php
    - ClassController localizes attendanceNonce into WeCozaSingleClass
    - All files pass PHP lint check
  </done>
</task>

</tasks>

<verification>
1. `php -l` passes for all 4 modified files
2. `grep -c 'check_ajax_referer' src/Classes/Ajax/AttendanceAjaxHandlers.php` returns 5 (one per handler)
3. `grep 'attendanceNonce' src/Classes/Controllers/ClassController.php` finds the localize entry
4. `grep 'AttendanceAjaxHandlers' wecoza-core.php` finds the require_once line
5. `grep 'getSessionDetail' src/Classes/Services/AttendanceService.php` finds the new service method
6. `grep 'hours_present.*scheduledHours' src/Classes/Ajax/AttendanceAjaxHandlers.php` finds range validation
7. `grep 'hoursPresent.*hours_present' src/Classes/Ajax/AttendanceAjaxHandlers.php` finds camelCase normalization
</verification>

<success_criteria>
- All five AJAX actions (wecoza_attendance_get_sessions, wecoza_attendance_capture, wecoza_attendance_mark_exception, wecoza_attendance_get_detail, wecoza_attendance_admin_delete) are registered and callable
- Nonce validation on every endpoint via check_ajax_referer
- Input normalization handles both camelCase and snake_case POST keys
- Range validation enforces 0 <= hours_present <= scheduledHours before service call
- Admin delete requires manage_options capability
- All endpoints return structured JSON via wp_send_json_success/wp_send_json_error
- Frontend JS config available via WeCozaSingleClass.attendanceNonce
</success_criteria>

<output>
After completion, create `.planning/phases/50-ajax-endpoints/50-01-SUMMARY.md`
</output>
