---
phase: 51-frontend
plan: 02
type: execute
wave: 2
depends_on: ["51-01"]
files_modified:
  - assets/js/classes/attendance-capture.js
autonomous: false
requirements: [ATT-01, ATT-02, ATT-03, ATT-04, UI-01, UI-02, UI-03, UI-04, UI-05]

must_haves:
  truths:
    - "On page load, session list fetches from wecoza_attendance_get_sessions and populates the table"
    - "Summary cards show correct counts for total, captured, and pending sessions"
    - "Month tabs are dynamically generated from session dates and clicking a tab filters the table"
    - "Clicking Capture on a pending session opens the capture modal with all enrolled learners pre-filled"
    - "Hours_trained column in capture modal is read-only and auto-populated from scheduled_hours"
    - "Hours_present defaults to scheduled_hours and is adjustable down in 0.5-step increments with min 0"
    - "Hours_absent auto-calculates as hours_trained minus hours_present in real time"
    - "Submitting the capture modal calls wecoza_attendance_capture and updates the table row on success"
    - "Clicking View on a captured session fetches detail via wecoza_attendance_get_detail and shows read-only breakdown"
    - "Admin delete button calls wecoza_attendance_admin_delete and refreshes the session list"
    - "Exception modal submits to wecoza_attendance_mark_exception with selected type"
  artifacts:
    - path: "assets/js/classes/attendance-capture.js"
      provides: "Complete attendance UI interactivity: session list, month filter, capture modal, view-detail modal, exception modal, admin delete"
      min_lines: 250
  key_links:
    - from: "assets/js/classes/attendance-capture.js"
      to: "wecoza_attendance_get_sessions"
      via: "jQuery AJAX GET on page load"
      pattern: "wecoza_attendance_get_sessions"
    - from: "assets/js/classes/attendance-capture.js"
      to: "wecoza_attendance_capture"
      via: "jQuery AJAX POST on submit"
      pattern: "wecoza_attendance_capture"
    - from: "assets/js/classes/attendance-capture.js"
      to: "wecoza_attendance_get_detail"
      via: "jQuery AJAX GET on view click"
      pattern: "wecoza_attendance_get_detail"
    - from: "assets/js/classes/attendance-capture.js"
      to: "wecoza_attendance_mark_exception"
      via: "jQuery AJAX POST on exception submit"
      pattern: "wecoza_attendance_mark_exception"
    - from: "assets/js/classes/attendance-capture.js"
      to: "wecoza_attendance_admin_delete"
      via: "jQuery AJAX POST on admin delete"
      pattern: "wecoza_attendance_admin_delete"
---

<objective>
Build the attendance-capture.js module that populates the attendance section with live data, handles month filtering, capture modal interactions, view-detail display, exception marking, and admin delete.

Purpose: This is the final plan of v6.0 — wires the UI shell from Plan 01 to the AJAX endpoints from Phase 50, making the attendance capture feature fully functional end-to-end.
Output: assets/js/classes/attendance-capture.js — single JS module providing complete attendance UI interactivity
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/51-frontend/51-01-SUMMARY.md
@.planning/phases/50-ajax-endpoints/50-01-SUMMARY.md
@src/Classes/Ajax/AttendanceAjaxHandlers.php
@views/classes/components/single-class/attendance.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create attendance-capture.js with session list rendering and month filter</name>
  <files>assets/js/classes/attendance-capture.js</files>
  <action>
Create `assets/js/classes/attendance-capture.js` as a jQuery IIFE module following the progression-admin.js pattern.

**Module structure:**

```javascript
/**
 * Attendance Capture JavaScript Module
 *
 * Provides all interactive functionality for the attendance section on
 * the single class display page: session list loading, month filtering,
 * capture modal, view-detail modal, exception modal, and admin delete.
 *
 * Config passed via window.WeCozaSingleClass:
 *   - classId, ajaxUrl, attendanceNonce, learnerIds, isAdmin
 *
 * @package WeCoza_Classes
 * @since 1.0.0
 */
(function($) {
    'use strict';

    const config = window.WeCozaSingleClass || {};
    if (!config.classId) return; // Not on single class page

    let allSessions   = [];     // Full session list from server
    let currentMonth  = 'all';  // Active month filter

    // =========================================================
    // DOM READY
    // =========================================================
    $(document).ready(function() {
        loadSessions();
        bindEvents();
    });
```

**SECTION 1: SESSION LIST LOADING (loadSessions function)**

```javascript
function loadSessions() {
    $('#attendance-sessions-tbody').html(
        '<tr><td colspan="6" class="text-center text-muted py-3"><span class="spinner-border spinner-border-sm me-2"></span>Loading sessions...</td></tr>'
    );

    $.ajax({
        url:  config.ajaxUrl,
        type: 'GET',
        data: {
            action:   'wecoza_attendance_get_sessions',
            nonce:    config.attendanceNonce,
            class_id: config.classId
        },
        success: function(response) {
            if (response.success && response.data && response.data.sessions) {
                allSessions = response.data.sessions;
                updateSummaryCards();
                buildMonthTabs();
                renderSessionTable();
            } else {
                showAlert('#attendance-alert', (response.data && response.data.message) || 'Failed to load sessions.', 'danger');
            }
        },
        error: function() {
            showAlert('#attendance-alert', 'Server error loading sessions.', 'danger');
        }
    });
}
```

**SECTION 2: SUMMARY CARDS (updateSummaryCards)**

```javascript
function updateSummaryCards() {
    const total    = allSessions.length;
    const captured = allSessions.filter(s => s.status === 'captured').length;
    const exceptions = allSessions.filter(s => s.status === 'client_cancelled' || s.status === 'agent_absent').length;
    const pending  = allSessions.filter(s => s.status === 'pending').length;

    $('#att-total-sessions').text(total);
    $('#att-captured-count').text(captured + exceptions);
    $('#att-pending-count').text(pending);
}
```

Note: "Captured" card shows captured + exceptions (all sessions that have been acted on). "Pending" shows those not yet captured.

**SECTION 3: MONTH TABS (buildMonthTabs)**

Extract unique YYYY-MM values from `allSessions`. For each month, create a tab button with `data-month="YYYY-MM"` and display as "MMM YYYY" (e.g., "Jan 2026"). Insert after the hardcoded "All" tab in `#attendance-month-tabs`. Use `Date` to format month names.

```javascript
function buildMonthTabs() {
    const $tabs = $('#attendance-month-tabs');
    // Remove all tabs except the "All" tab
    $tabs.find('li:not(:first)').remove();

    const months = new Map();
    allSessions.forEach(function(s) {
        const ym = s.date.substring(0, 7); // "YYYY-MM"
        if (!months.has(ym)) {
            const d = new Date(s.date + 'T00:00:00');
            const label = d.toLocaleString('en-US', { month: 'short', year: 'numeric' });
            months.set(ym, label);
        }
    });

    months.forEach(function(label, ym) {
        $tabs.append(
            '<li class="nav-item"><button class="nav-link" data-month="' + ym + '">' + label + '</button></li>'
        );
    });
}
```

**SECTION 4: RENDER SESSION TABLE (renderSessionTable)**

Filter `allSessions` by `currentMonth`. For each session, generate a `<tr>`:

```javascript
function renderSessionTable() {
    const filtered = currentMonth === 'all'
        ? allSessions
        : allSessions.filter(s => s.date.substring(0, 7) === currentMonth);

    if (filtered.length === 0) {
        $('#attendance-sessions-tbody').html(
            '<tr><td colspan="6" class="text-center text-muted py-3">No sessions found for this period.</td></tr>'
        );
        return;
    }

    let html = '';
    filtered.forEach(function(s) {
        const statusBadge = getStatusBadge(s.status);
        const actionBtn   = getActionButton(s);
        const timeRange   = s.start_time + ' - ' + s.end_time;
        const hours       = parseFloat(s.scheduled_hours).toFixed(1);

        html += '<tr data-date="' + s.date + '" data-session-id="' + (s.session_id || '') + '">'
            + '<td class="align-middle ps-3">' + s.date + '</td>'
            + '<td class="align-middle">' + s.day + '</td>'
            + '<td class="align-middle">' + timeRange + '</td>'
            + '<td class="align-middle">' + hours + '</td>'
            + '<td class="align-middle">' + statusBadge + '</td>'
            + '<td class="align-middle text-end pe-3">' + actionBtn + '</td>'
            + '</tr>';
    });

    $('#attendance-sessions-tbody').html(html);
}
```

**STATUS BADGE HELPER (getStatusBadge)**

Map status to badge class:
- `pending` -> `badge-phoenix-secondary` with label "Pending"
- `captured` -> `badge-phoenix-success` with label "Captured"
- `client_cancelled` -> `badge-phoenix-warning` with label "Client Cancelled"
- `agent_absent` -> `badge-phoenix-danger` with label "Agent Absent"

Return: `<span class="badge badge-phoenix badge-phoenix-{class}">{label}</span>`

**ACTION BUTTON HELPER (getActionButton)**

- If `status === 'pending'`: return two buttons in a `btn-group`:
  1. `<button class="btn btn-sm btn-phoenix-primary btn-capture" data-date="...">Capture</button>`
  2. `<button class="btn btn-sm btn-subtle-warning btn-exception" data-date="..."><i class="bi bi-exclamation-triangle"></i></button>`
- If `status === 'captured'`: return `<button class="btn btn-sm btn-subtle-info btn-view-detail" data-session-id="...">View</button>`
- If `status === 'client_cancelled'` or `agent_absent`: return `<span class="text-muted">-</span>` (no action, unless admin, then show View if session_id exists)
- Admin users (`config.isAdmin`) on non-pending sessions with a session_id also see a small View button

**SECTION 5: EVENT BINDING (bindEvents)**

```javascript
function bindEvents() {
    // Month tab click
    $('#attendance-month-tabs').on('click', '.nav-link', function() {
        $('#attendance-month-tabs .nav-link').removeClass('active');
        $(this).addClass('active');
        currentMonth = $(this).data('month');
        renderSessionTable();
    });

    // Capture button click
    $('#attendance-sessions-tbody').on('click', '.btn-capture', function() {
        openCaptureModal($(this).data('date'));
    });

    // Exception button click
    $('#attendance-sessions-tbody').on('click', '.btn-exception', function() {
        openExceptionModal($(this).data('date'));
    });

    // View detail button click
    $('#attendance-sessions-tbody').on('click', '.btn-view-detail', function() {
        openDetailModal($(this).data('session-id'));
    });

    // Submit capture
    $('#btn-submit-capture').on('click', submitCapture);

    // Submit exception
    $('#btn-submit-exception').on('click', submitException);

    // Admin delete
    $('#btn-admin-delete-session').on('click', adminDeleteSession);

    // Hours present input change -> auto-calculate hours absent
    $('#capture-learners-tbody').on('input change', '.hours-present-input', function() {
        const $row = $(this).closest('tr');
        const trained = parseFloat($row.find('.hours-trained-val').text()) || 0;
        const present = parseFloat($(this).val()) || 0;
        const absent  = Math.max(0, trained - present);
        $row.find('.hours-absent-val').text(absent.toFixed(1));
    });
}
```

**SECTION 6: CAPTURE MODAL (openCaptureModal, submitCapture)**

`openCaptureModal(date)`:
- Find the session from `allSessions` by date
- Set `#capture-session-info` text to date + " (" + day + ")"
- Set `#capture-hours-info` to "Scheduled: X.X hours"
- Build learner table rows from `config.learnerIds` (array of objects with `id`/`learner_id`, `first_name`, `surname` or just `name`). For each learner:

```html
<tr data-learner-id="{id}">
  <td class="align-middle ps-3">{name}</td>
  <td class="align-middle text-center"><span class="hours-trained-val">{scheduled_hours}</span></td>
  <td class="align-middle text-center">
    <input type="number" class="form-control form-control-sm hours-present-input"
           value="{scheduled_hours}" min="0" max="{scheduled_hours}" step="0.5"
           style="width: 80px; display: inline-block;">
  </td>
  <td class="align-middle text-center"><span class="hours-absent-val">0.0</span></td>
</tr>
```

The learner_ids array from PHP may contain objects with different shapes. Handle both:
- `{ id: N, first_name: "...", surname: "..." }` (newer format)
- `{ learner_id: N, name: "..." }` (older format)
- Extract ID as `learner.id || learner.learner_id` and name as `learner.first_name ? (learner.first_name + ' ' + learner.surname) : (learner.name || 'Unknown')`

Store the current capture date in a module-level variable `captureDate`.

Show the modal: `new bootstrap.Modal('#attendanceCaptureModal').show();` (or `$('#attendanceCaptureModal').modal('show')` for jQuery Bootstrap 5).

`submitCapture()`:
- Disable submit button, show spinner
- Collect learner_hours array: for each row in `#capture-learners-tbody`, read `data-learner-id` and `.hours-present-input` value
- POST to `wecoza_attendance_capture`:
  ```javascript
  $.ajax({
      url: config.ajaxUrl,
      type: 'POST',
      data: {
          action: 'wecoza_attendance_capture',
          nonce: config.attendanceNonce,
          class_id: config.classId,
          session_date: captureDate,
          learner_hours: learnerHours  // array of {learner_id, hours_present}
      },
      ...
  });
  ```
- On success: close modal, show success toast/alert, reload sessions via `loadSessions()`
- On error: show error in `#capture-alert`
- Re-enable button in `complete` callback

**SECTION 7: EXCEPTION MODAL (openExceptionModal, submitException)**

`openExceptionModal(date)`:
- Store date in module-level `exceptionDate`
- Set `#exception-session-info` to "Date: " + date
- Reset form fields (select to "", textarea to "")
- Show modal

`submitException()`:
- Validate exception_type is selected
- POST to `wecoza_attendance_mark_exception`:
  ```javascript
  data: {
      action: 'wecoza_attendance_mark_exception',
      nonce: config.attendanceNonce,
      class_id: config.classId,
      session_date: exceptionDate,
      exception_type: $('#exception-type-select').val(),
      notes: $('#exception-notes').val()
  }
  ```
- On success: close modal, reload sessions
- On error: show alert

**SECTION 8: VIEW DETAIL MODAL (openDetailModal)**

`openDetailModal(sessionId)`:
- Store sessionId in module-level `detailSessionId`
- Show loading state in detail tbody
- GET `wecoza_attendance_get_detail` with `session_id`
- On success: populate `#detail-session-info` with session date/day, `#detail-status-badge` with status badge, `#detail-learners-tbody` with learner rows (read-only: learner_name, hours_trained, hours_present, hours_absent)
- Show modal

**SECTION 9: ADMIN DELETE (adminDeleteSession)**

`adminDeleteSession()`:
- Confirm with `window.confirm('Are you sure? This will reverse all hours logged for this session.')`
- POST to `wecoza_attendance_admin_delete`:
  ```javascript
  data: {
      action: 'wecoza_attendance_admin_delete',
      nonce: config.attendanceNonce,
      session_id: detailSessionId
  }
  ```
- On success: close detail modal, reload sessions, show success alert
- On error: show error alert

**SECTION 10: UTILITY HELPERS**

```javascript
function showAlert(selector, message, type) {
    $(selector).html(
        '<div class="alert alert-subtle-' + type + ' d-flex align-items-center">'
        + '<i class="bi bi-' + (type === 'danger' ? 'exclamation-triangle' : 'check-circle') + '-fill me-2"></i>'
        + '<span>' + message + '</span>'
        + '</div>'
    );
    // Auto-dismiss success after 5 seconds
    if (type === 'success') {
        setTimeout(function() { $(selector).html(''); }, 5000);
    }
}

function showToast(message, type) {
    showAlert('#attendance-alert', message, type);
}
```

Close the IIFE: `})(jQuery);`

**Key conventions:**
- Use `'use strict';` inside IIFE
- Access config from `window.WeCozaSingleClass` (already localized by Plan 01)
- All AJAX calls include `nonce: config.attendanceNonce`
- Button disable/enable pattern during AJAX to prevent double-submit
- Use Bootstrap 5 modal API (`bootstrap.Modal.getOrCreateInstance` for show/hide)
- Match Phoenix badge classes: `badge-phoenix badge-phoenix-{variant}`
- 4-space indentation matching project conventions
  </action>
  <verify>
    <automated>grep -c "wecoza_attendance_get_sessions\|wecoza_attendance_capture\|wecoza_attendance_get_detail\|wecoza_attendance_mark_exception\|wecoza_attendance_admin_delete" assets/js/classes/attendance-capture.js</automated>
    <manual>Verify all 5 AJAX actions referenced, month tabs built, capture modal populates learners with hours inputs, hours_absent auto-calculates</manual>
  </verify>
  <done>attendance-capture.js references all 5 AJAX endpoints, builds month tabs from session dates, populates capture modal with enrolled learners and hours_trained/hours_present/hours_absent fields, auto-calculates hours_absent on input change, view-detail shows read-only breakdown, admin delete with confirmation, exception modal with type select</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify attendance UI end-to-end</name>
  <files>assets/js/classes/attendance-capture.js</files>
  <action>
Human verification of the complete attendance capture UI. Navigate to a single class page and verify all interactive features.

Steps:
1. Navigate to `/app/display-single-class/?class_id=XXX` (use an active class)
2. Scroll to the Attendance section — verify card with summary cards, month tabs, session table
3. Click "Capture" on a pending session — verify modal with enrolled learners and hours inputs
4. Adjust hours_present — verify hours_absent auto-updates
5. Submit capture — verify success and table row updates
6. Click "View" on captured session — verify read-only breakdown
7. Test exception marking on another pending session
8. (Admin) Verify delete button in view modal
  </action>
  <verify>Manual browser testing — all 8 steps pass</verify>
  <done>All attendance features verified working: session list, summary cards, month filter, capture modal with auto-calc, view detail, exception marking, admin delete</done>
</task>

</tasks>

<verification>
1. `wc -l assets/js/classes/attendance-capture.js` — expect 250+ lines
2. `grep -c "wecoza_attendance_" assets/js/classes/attendance-capture.js` — expect 5 (one per AJAX action)
3. `grep -q "hours-present-input" assets/js/classes/attendance-capture.js` — hours input exists
4. `grep -q "hours-absent-val" assets/js/classes/attendance-capture.js` — auto-calc target exists
5. `grep -q "data-month" assets/js/classes/attendance-capture.js` — month filter wiring
6. Navigate to single class page — attendance section visible with live session data
</verification>

<success_criteria>
- Session list loads on page ready and populates table with date/day/time/hours/status/action columns
- Summary cards show correct total/captured/pending counts
- Month tabs dynamically generated from session dates; clicking filters table
- Capture modal shows enrolled learners with hours_trained (read-only), hours_present (editable, step=0.5, max=scheduled), hours_absent (auto-calculated)
- Submit capture calls AJAX endpoint and refreshes session list
- View detail shows read-only per-learner hours for captured sessions
- Exception modal submits client_cancelled or agent_absent and refreshes list
- Admin delete confirms, calls endpoint, refreshes list
</success_criteria>

<output>
After completion, create `.planning/phases/51-frontend/51-02-SUMMARY.md`
</output>
