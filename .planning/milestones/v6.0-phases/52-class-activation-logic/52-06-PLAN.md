---
phase: 52-class-activation-logic
plan: 06
type: execute
wave: 4
depends_on: [52-05]
files_modified:
  - assets/js/classes/single-class-display.js
autonomous: false
requirements: [WEC-179, WEC-180]

must_haves:
  truths:
    - "Clicking Activate button opens modal, collects order_nr, sends AJAX, reloads on success"
    - "Clicking Stop button opens modal, collects reason + notes, sends AJAX, reloads on success"
    - "Clicking Reactivate button shows confirm, sends AJAX, reloads on success"
    - "AJAX failure shows toast with error message (CC6)"
    - "Status history loads when panel expanded and renders table of transitions"
  artifacts:
    - path: "assets/js/classes/single-class-display.js"
      provides: "Event handlers for activate, stop, reactivate, history load"
      contains: "wecoza_class_status_update"
  key_links:
    - from: "assets/js/classes/single-class-display.js"
      to: "src/Classes/Ajax/ClassStatusAjaxHandler.php"
      via: "jQuery AJAX to wecoza_class_status_update action"
      pattern: "wecoza_class_status_update"
    - from: "assets/js/classes/single-class-display.js"
      to: "views/classes/components/single-class-display.view.php"
      via: "DOM element IDs: btn-confirm-activate, btn-confirm-stop, btn-reactivate-class, statusHistoryCollapse, etc."
      pattern: "btn-confirm-activate|btn-confirm-stop|btn-reactivate-class"
---

<objective>
Implement the JavaScript event handlers for class status management — activate, stop, reactivate, and history loading — in single-class-display.js. Includes a human verification checkpoint.

Purpose: Wires the UI created in Plan 05 to the AJAX endpoints. This is the final piece making status transitions interactive.
Output: Updated single-class-display.js with status action handlers.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-class-activation-logic/52-RESEARCH.md
@/home/laudes/.claude/plans/snoopy-wobbling-fountain.md
@.planning/phases/52-class-activation-logic/52-05-SUMMARY.md

Key references:
- single-class-display.js: assets/js/classes/single-class-display.js — existing JS file for single class page
- WeCozaSingleClass: localized config with classNonce, classId, classStatus, isAttendanceLocked, orderNr (from Plans 01/03)
- AJAX actions: wecoza_class_status_update, wecoza_class_status_history (from Plan 05)
- DOM IDs from Plan 05: btn-confirm-activate, btn-confirm-stop, btn-reactivate-class, activate-order-nr, stop-reason, stop-notes, statusHistoryCollapse, status-history-content
- Research: define showToast locally (separate IIFE scope from attendance-capture.js)
- Research: use bootstrap.Modal.getOrCreateInstance() pattern
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add status action handlers and history loader to single-class-display.js</name>
  <files>assets/js/classes/single-class-display.js</files>
  <action>
Add the following to `assets/js/classes/single-class-display.js`. Wrap in a jQuery ready block or append to the existing document-ready handler if one exists. Use `WeCozaSingleClass` localized config for `ajaxurl`, `classNonce`, and `classId`.

**A. Local showToast utility** (CC6 — define locally since attendance-capture.js has its own scoped version):
```javascript
function showStatusToast(message, type) {
    var bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-warning';
    var $toast = $('<div>').addClass('toast align-items-center text-white border-0 show ' + bgClass)
        .css({ position: 'fixed', top: '20px', right: '20px', zIndex: 9999, minWidth: '260px' })
        .html('<div class="d-flex"><div class="toast-body">' + $('<span>').text(message).html() + '</div>' +
              '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>');
    $('body').append($toast);
    setTimeout(function() { $toast.fadeOut(400, function() { $(this).remove(); }); }, 4000);
}
```

**B. Activate Class handler** — bind to `#btn-confirm-activate` click:
```javascript
$('#btn-confirm-activate').on('click', function() {
    var orderNr = $('#activate-order-nr').val().trim();
    if (!orderNr) {
        showStatusToast('Please enter an order number.', 'danger');
        return;
    }
    var $btn = $(this);
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Processing...');

    $.post(WeCozaSingleClass.ajaxUrl, {
        action: 'wecoza_class_status_update',
        nonce: WeCozaSingleClass.classNonce,
        class_id: WeCozaSingleClass.classId,
        new_status: 'active',
        order_nr: orderNr
    }, function(response) {
        if (response.success) {
            showStatusToast('Class activated successfully.', 'success');
            setTimeout(function() { location.reload(); }, 1000);
        } else {
            showStatusToast(response.data?.message || 'Activation failed.', 'danger');
            $btn.prop('disabled', false).html('<i class="bi bi-check-circle me-1"></i>Activate');
        }
    }).fail(function() {
        showStatusToast('Network error. Please try again.', 'danger');
        $btn.prop('disabled', false).html('<i class="bi bi-check-circle me-1"></i>Activate');
    });
});
```

**C. Stop Class handler** — bind to `#btn-confirm-stop` click:
```javascript
$('#btn-confirm-stop').on('click', function() {
    var reason = $('#stop-reason').val();
    if (!reason) {
        showStatusToast('Please select a stop reason.', 'danger');
        return;
    }
    var notes = $('#stop-notes').val().trim();
    var $btn = $(this);
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Processing...');

    $.post(WeCozaSingleClass.ajaxUrl, {
        action: 'wecoza_class_status_update',
        nonce: WeCozaSingleClass.classNonce,
        class_id: WeCozaSingleClass.classId,
        new_status: 'stopped',
        stop_reason: reason,
        notes: notes
    }, function(response) {
        if (response.success) {
            showStatusToast('Class stopped.', 'success');
            setTimeout(function() { location.reload(); }, 1000);
        } else {
            showStatusToast(response.data?.message || 'Stop failed.', 'danger');
            $btn.prop('disabled', false).html('<i class="bi bi-stop-circle me-1"></i>Stop Class');
        }
    }).fail(function() {
        showStatusToast('Network error. Please try again.', 'danger');
        $btn.prop('disabled', false).html('<i class="bi bi-stop-circle me-1"></i>Stop Class');
    });
});
```

**D. Reactivate Class handler** — bind to `#btn-reactivate-class` click:
```javascript
$('#btn-reactivate-class').on('click', function() {
    if (!confirm('Are you sure you want to reactivate this class?')) return;
    var $btn = $(this);
    $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Processing...');

    $.post(WeCozaSingleClass.ajaxUrl, {
        action: 'wecoza_class_status_update',
        nonce: WeCozaSingleClass.classNonce,
        class_id: WeCozaSingleClass.classId,
        new_status: 'active'
    }, function(response) {
        if (response.success) {
            showStatusToast('Class reactivated.', 'success');
            setTimeout(function() { location.reload(); }, 1000);
        } else {
            showStatusToast(response.data?.message || 'Reactivation failed.', 'danger');
            $btn.prop('disabled', false).html('<i class="bi bi-arrow-counterclockwise me-1"></i>Reactivate Class');
        }
    }).fail(function() {
        showStatusToast('Network error. Please try again.', 'danger');
        $btn.prop('disabled', false).html('<i class="bi bi-arrow-counterclockwise me-1"></i>Reactivate Class');
    });
});
```

**E. Status History loader** — load when history panel is expanded:
```javascript
var historyLoaded = false;
$('#statusHistoryCollapse').on('show.bs.collapse', function() {
    if (historyLoaded) return;
    historyLoaded = true;

    $.post(WeCozaSingleClass.ajaxUrl, {
        action: 'wecoza_class_status_history',
        nonce: WeCozaSingleClass.classNonce,
        class_id: WeCozaSingleClass.classId
    }, function(response) {
        if (response.success && response.data.history.length > 0) {
            var html = '<table class="table table-sm fs-10"><thead><tr>' +
                '<th>Date</th><th>From</th><th>To</th><th>Reason</th><th>Changed By</th><th>Notes</th></tr></thead><tbody>';
            response.data.history.forEach(function(row) {
                html += '<tr>' +
                    '<td>' + $('<span>').text(row.changed_at).html() + '</td>' +
                    '<td><span class="badge badge-phoenix fs-10 badge-phoenix-' +
                        (row.old_status === 'active' ? 'success' : row.old_status === 'stopped' ? 'danger' : 'warning') + '">' +
                        $('<span>').text(row.old_status).html() + '</span></td>' +
                    '<td><span class="badge badge-phoenix fs-10 badge-phoenix-' +
                        (row.new_status === 'active' ? 'success' : row.new_status === 'stopped' ? 'danger' : 'warning') + '">' +
                        $('<span>').text(row.new_status).html() + '</span></td>' +
                    '<td>' + $('<span>').text(row.reason || '-').html() + '</td>' +
                    '<td>' + $('<span>').text(row.changed_by_name || 'Unknown').html() + '</td>' +
                    '<td>' + $('<span>').text(row.notes || '-').html() + '</td>' +
                '</tr>';
            });
            html += '</tbody></table>';
            $('#status-history-content').html(html);
        } else if (response.success) {
            $('#status-history-content').html('<p class="text-body-tertiary mb-0">No status changes recorded.</p>');
        } else {
            $('#status-history-content').html('<p class="text-danger mb-0">Failed to load history.</p>');
        }
    }).fail(function() {
        $('#status-history-content').html('<p class="text-danger mb-0">Failed to load history.</p>');
    });
});
```

All user-facing text from AJAX responses is XSS-safe (rendered through jQuery `.text()` then `.html()` for escaping). Button text uses i18n where possible through PHP-rendered labels; JS-only text (toasts) is English-only as per existing codebase convention.
  </action>
  <verify>
    <automated>grep -q "wecoza_class_status_update" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/assets/js/classes/single-class-display.js && grep -q "btn-confirm-activate" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/assets/js/classes/single-class-display.js && grep -q "statusHistoryCollapse" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/assets/js/classes/single-class-display.js && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>All five JS handlers implemented: activate (with order_nr), stop (with reason + notes), reactivate (with confirm), error toasts on failure, and lazy-loaded status history table.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete status management flow</name>
  <files>None — human verification only</files>
  <action>
Human verifies the complete class status management system end-to-end.

Prerequisites:
1. Execute `schema/class_status_migration.sql` against PostgreSQL
2. Also execute `schema/class_attendance_sessions.sql` if not already done (Phase 48)

Test sequence:
1. Classes listing — verify Draft/Active/Stopped badges appear correctly
2. Event tasks — verify class status badge alongside task status badge
3. Draft class attendance lock — verify lock alert instead of capture UI
4. Single class status card — verify 6th summary card
5. Manager activate — click Activate, enter order number, verify transition
6. Active class attendance — verify full capture UI
7. Manager stop — select reason, verify transition
8. Stopped class attendance lock — verify lock alert
9. Manager reactivate — confirm, verify transition
10. Status history — expand panel, verify transitions table
11. Idempotency — direct AJAX call for same-state returns 400
12. Non-admin — verify status management section hidden
  </action>
  <verify>
    <automated>echo "CHECKPOINT — requires human verification"</automated>
    <manual>Execute all 12 test steps above and confirm each passes</manual>
  </verify>
  <done>All 12 verification steps pass. Complete status management system works end-to-end: activate, stop, reactivate, badges, attendance lock, history.</done>
</task>

</tasks>

<verification>
1. All AJAX calls use correct action names and include nonce
2. Button disabled state prevents double-submit
3. Error toasts render correctly on AJAX failure
4. History table renders with badges for old/new status
5. XSS protection via jQuery text/html encoding
6. Page reload after successful transition refreshes all server-rendered badges
</verification>

<success_criteria>
- Complete end-to-end status management workflow works: activate, stop, reactivate
- Visual feedback (toasts) on success and failure
- Status history provides audit trail
- All 12 verification steps pass human review
</success_criteria>

<output>
After completion, create `.planning/phases/52-class-activation-logic/52-06-SUMMARY.md`
</output>
