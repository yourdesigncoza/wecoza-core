---
phase: 52-class-activation-logic
plan: 03
type: execute
wave: 2
depends_on: [52-01]
files_modified:
  - views/classes/components/single-class/attendance.php
  - src/Classes/Controllers/ClassController.php
  - src/Classes/Ajax/AttendanceAjaxHandlers.php
autonomous: true
requirements: [WEC-179]

must_haves:
  truths:
    - "Draft class attendance page shows lock alert instead of capture UI"
    - "Stopped class attendance page shows lock alert instead of capture UI"
    - "Active class attendance page shows full capture UI"
    - "AJAX capture/exception endpoints return 403 for non-active classes"
    - "JS receives isAttendanceLocked and classStatus via WeCozaSingleClass"
  artifacts:
    - path: "views/classes/components/single-class/attendance.php"
      provides: "Activation gate with lock alert for non-active classes"
      contains: "wecoza_resolve_class_status"
    - path: "src/Classes/Controllers/ClassController.php"
      provides: "classStatus and isAttendanceLocked in localized JS data"
      contains: "isAttendanceLocked"
    - path: "src/Classes/Ajax/AttendanceAjaxHandlers.php"
      provides: "Server-side guard rejecting capture/exception for non-active classes"
      contains: "require_active_class"
  key_links:
    - from: "views/classes/components/single-class/attendance.php"
      to: "core/Helpers/functions.php"
      via: "wecoza_resolve_class_status() for lock decision"
      pattern: "wecoza_resolve_class_status"
    - from: "src/Classes/Ajax/AttendanceAjaxHandlers.php"
      to: "classes table"
      via: "require_active_class queries class_status"
      pattern: "require_active_class"
---

<objective>
Lock attendance capture on non-active classes — both visually (PHP view + JS config) and server-side (AJAX guard).

Purpose: Implements Q2:A — payment requires order, so only active classes (with order_nr) can have attendance captured. Prevents data entry on draft/stopped classes.
Output: Lock alert in attendance view, classStatus in JS config, server-side guard in AJAX handlers.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-class-activation-logic/52-RESEARCH.md
@/home/laudes/.claude/plans/snoopy-wobbling-fountain.md
@.planning/phases/51-frontend/51-01-SUMMARY.md

Key references:
- attendance.php: views/classes/components/single-class/attendance.php — created in Phase 51, has empty($class) check at top
- ClassController: src/Classes/Controllers/ClassController.php — enqueueAndLocalizeSingleClassScript() at ~line 463, localized data array
- AttendanceAjaxHandlers: src/Classes/Ajax/AttendanceAjaxHandlers.php — handle_attendance_capture() and handle_attendance_mark_exception() need guards
- Research code example: attendance lock gate pattern with alert-subtle-warning
</context>

<tasks>

<task type="auto">
  <name>Task 1: Attendance view lock gate + JS localization</name>
  <files>views/classes/components/single-class/attendance.php, src/Classes/Controllers/ClassController.php</files>
  <action>
**A. views/classes/components/single-class/attendance.php** — Add activation gate after the existing `empty($class)` check (before the main attendance UI):
```php
$classStatus = wecoza_resolve_class_status($class);
$isAttendanceLocked = $classStatus !== 'active';

if ($isAttendanceLocked) {
    $lockMsg = $classStatus === 'stopped'
        ? __('This class has been stopped. Attendance capture is locked.', 'wecoza-core')
        : __('This class is in draft status. Attendance capture is not available until the class is activated.', 'wecoza-core');
    ?>
    <div class="card mb-3">
        <div class="card-body">
            <h5 class="card-title mb-3"><?= esc_html__('Attendance', 'wecoza-core'); ?></h5>
            <div class="alert alert-subtle-warning d-flex align-items-center mb-0">
                <i class="bi bi-lock-fill me-3 fs-4"></i>
                <div><?= esc_html($lockMsg); ?></div>
            </div>
        </div>
    </div>
    <?php
    return;
}
```
This early return prevents the entire attendance UI from rendering on non-active classes, showing a clear lock message instead.

**B. src/Classes/Controllers/ClassController.php** — In `enqueueAndLocalizeSingleClassScript()` (~line 463), add to the localized data array (where `attendanceNonce` etc. are defined):
```php
$classStatus = wecoza_resolve_class_status($class);
```
Then add to the localize array:
```php
'classStatus'          => $classStatus,
'isAttendanceLocked'   => $classStatus !== 'active',
```
Compute `$classStatus` once and reuse (avoid calling helper twice per Research Pitfall 2). Place near the existing `attendanceNonce` entry for logical grouping.

Also add `'orderNr' => $class['order_nr'] ?? ''` to the localized data — Plan 05 (manager JS) needs this.
  </action>
  <verify>
    <automated>grep -q "wecoza_resolve_class_status" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/views/classes/components/single-class/attendance.php && grep -q "isAttendanceLocked" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Classes/Controllers/ClassController.php && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Non-active classes show lock alert instead of attendance UI. JS config includes classStatus and isAttendanceLocked. orderNr available in localized data.</done>
</task>

<task type="auto">
  <name>Task 2: Server-side AJAX guard for attendance on non-active classes</name>
  <files>src/Classes/Ajax/AttendanceAjaxHandlers.php</files>
  <action>
Add a helper function `require_active_class(int $classId): void` in the `WeCoza\Classes\Ajax` namespace (same file as other attendance helpers):

```php
function require_active_class(int $classId): void
{
    $pdo = wecoza_db()->getPdo();
    $stmt = $pdo->prepare('SELECT class_status, order_nr FROM classes WHERE class_id = :class_id');
    $stmt->execute([':class_id' => $classId]);
    $row = $stmt->fetch(\PDO::FETCH_ASSOC);

    if (!$row) {
        wp_send_json_error(['message' => __('Class not found.', 'wecoza-core')], 404);
        exit;
    }

    $status = wecoza_resolve_class_status($row);
    if ($status !== 'active') {
        wp_send_json_error(['message' => __('Attendance capture is only allowed for active classes.', 'wecoza-core')], 403);
        exit;
    }
}
```

Call `require_active_class($classId)` at the top of:
1. `handle_attendance_capture()` — after nonce check and `absint($classId)` extraction
2. `handle_attendance_mark_exception()` — after nonce check and `absint($classId)` extraction

Do NOT add to `handle_attendance_get_sessions()`, `handle_attendance_get_detail()`, or `handle_attendance_admin_delete()` — viewing sessions and admin delete should work on any status.
  </action>
  <verify>
    <automated>grep -q "require_active_class" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Classes/Ajax/AttendanceAjaxHandlers.php && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Capture and exception AJAX endpoints reject non-active classes with 403. View/delete endpoints remain accessible on all statuses.</done>
</task>

</tasks>

<verification>
1. Draft class single-class page shows lock alert in attendance section
2. Stopped class single-class page shows lock alert in attendance section
3. Active class single-class page shows full attendance UI
4. Direct AJAX call to capture endpoint with draft class_id returns 403
5. Direct AJAX call to exception endpoint with stopped class_id returns 403
6. JS config contains classStatus and isAttendanceLocked values
</verification>

<success_criteria>
- Attendance UI locked on draft and stopped classes with clear user messaging
- Server-side guard prevents bypass of UI lock via direct AJAX calls
- Active classes unaffected — full attendance capture works as before
</success_criteria>

<output>
After completion, create `.planning/phases/52-class-activation-logic/52-03-SUMMARY.md`
</output>
