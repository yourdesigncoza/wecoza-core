---
phase: 52-class-activation-logic
plan: 05
type: execute
wave: 3
depends_on: [52-01, 52-02]
files_modified:
  - src/Classes/Ajax/ClassStatusAjaxHandler.php
  - wecoza-core.php
  - views/classes/components/single-class-display.view.php
autonomous: true
requirements: [WEC-179, WEC-180]

must_haves:
  truths:
    - "Manager can activate a draft class by providing an order number via AJAX"
    - "Manager can stop an active class by selecting a reason via AJAX"
    - "Manager can reactivate a stopped class via AJAX"
    - "Status transitions are wrapped in DB transactions"
    - "Idempotent — same-state transitions rejected with 400"
    - "Status history recorded for every transition"
    - "Activate modal, stop modal, and status buttons visible to manage_options users"
    - "Status history panel shows past transitions with user names"
  artifacts:
    - path: "src/Classes/Ajax/ClassStatusAjaxHandler.php"
      provides: "AJAX handlers for status update + status history"
      contains: "handle_class_status_update"
    - path: "wecoza-core.php"
      provides: "require_once for ClassStatusAjaxHandler"
      contains: "ClassStatusAjaxHandler"
    - path: "views/classes/components/single-class-display.view.php"
      provides: "Status buttons + activate modal + stop modal + history panel"
      contains: "wecoza_class_status_update"
  key_links:
    - from: "src/Classes/Ajax/ClassStatusAjaxHandler.php"
      to: "classes table + class_status_history table"
      via: "PDO transaction with UPDATE + INSERT"
      pattern: "beginTransaction"
    - from: "src/Classes/Ajax/ClassStatusAjaxHandler.php"
      to: "src/Events/Services/TaskManager.php"
      via: "TaskManager::normaliseOrderNumber() for order_nr sanitization"
      pattern: "normaliseOrderNumber"
    - from: "views/classes/components/single-class-display.view.php"
      to: "src/Classes/Ajax/ClassStatusAjaxHandler.php"
      via: "AJAX action wecoza_class_status_update"
      pattern: "wecoza_class_status_update"
---

<objective>
Create the ClassStatusAjaxHandler for manager status transitions (activate/stop/reactivate) with full transaction safety, and add the status management UI (buttons + modals + history panel) to the single class display view.

Purpose: Implements Q4:A (activate with order number), Q5 (manager stop/restart), and status history. The AJAX handler enforces idempotency (CC3), transactions (CC2), input sanitization (CC4), and order_nr_metadata compatibility (CC7).
Output: New AJAX handler file, updated wecoza-core.php, updated single-class-display view.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-class-activation-logic/52-RESEARCH.md
@/home/laudes/.claude/plans/snoopy-wobbling-fountain.md
@.planning/phases/50-ajax-endpoints/50-01-SUMMARY.md

Key references:
- AJAX pattern: src/Classes/Ajax/AttendanceAjaxHandlers.php — namespace, procedural, init registration
- wecoza-core.php: require_once section at ~line 671
- single-class-display.view.php: action buttons at ~lines 120-131, full view structure
- TaskManager::normaliseOrderNumber() now public static (from Plan 02)
- classNonce already exists in WeCozaSingleClass localized data (ClassController ~line 497)
- Research: cross-DB JOIN impossible — use get_userdata() for WP user names
- Research: status button placement recommendation — separate card below action buttons
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClassStatusAjaxHandler with status transitions + history endpoint</name>
  <files>src/Classes/Ajax/ClassStatusAjaxHandler.php, wecoza-core.php</files>
  <action>
**A. Create `src/Classes/Ajax/ClassStatusAjaxHandler.php`** (new file):

Namespace: `WeCoza\Classes\Ajax`
Follow procedural pattern from AttendanceAjaxHandlers.php.

**Shared nonce helper:**
```php
function verify_class_status_nonce(): void {
    if (!check_ajax_referer('wecoza_class_nonce', 'nonce', false)) {
        wp_send_json_error(['message' => __('Security check failed.', 'wecoza-core')]);
        exit;
    }
}
```

**Handler 1: `handle_class_status_update()`**

1. Call `verify_class_status_nonce()`
2. Require `manage_options` capability: `if (!current_user_can('manage_options')) { wp_send_json_error(['message' => 'Insufficient permissions.'], 403); exit; }`
3. Extract and sanitize inputs (CC4):
   - `$classId = absint($_POST['class_id'] ?? 0);`
   - `$newStatus` = whitelist validate against `['active', 'stopped']`
   - `$orderNr` = `sanitize_text_field($_POST['order_nr'] ?? '')`
   - `$stopReason` = whitelist validate against `['programme_ended', 'temporary_hold', 'annual_stop']` (only required when stopping)
   - `$notes` = `sanitize_textarea_field($_POST['notes'] ?? '')`
4. Fetch current class status: query `SELECT class_status, order_nr FROM classes WHERE class_id = :id`; use `wecoza_resolve_class_status()` on result
5. **Idempotency guard (CC3):** if `$currentStatus === $newStatus`, return `wp_send_json_error(['message' => 'Class is already ' . $newStatus . '.'], 400)`
6. **Transition validation:**
   - `draft → active`: require non-empty `$orderNr`; normalize via `\WeCoza\Events\Services\TaskManager::normaliseOrderNumber($orderNr)`
   - `active → stopped`: require valid `$stopReason`
   - `stopped → active`: no extra requirements (order_nr already exists)
   - Any other transition: reject with 400
7. **DB Transaction (CC2):**
   ```php
   $pdo = wecoza_db()->getPdo();
   $pdo->beginTransaction();
   try {
       // For draft→active: UPDATE classes SET class_status='active', order_nr=:order_nr, order_nr_metadata=:metadata, updated_at=NOW()
       // Write order_nr_metadata JSON: {"completed_by": $currentUserId, "completed_at": date('Y-m-d H:i:s')} (CC7)
       // For active→stopped: UPDATE classes SET class_status='stopped', updated_at=NOW()
       // For stopped→active: UPDATE classes SET class_status='active', updated_at=NOW()

       // INSERT INTO class_status_history
       $histStmt = $pdo->prepare(
           "INSERT INTO class_status_history (class_id, old_status, new_status, reason, notes, changed_by)
            VALUES (:class_id, :old_status, :new_status, :reason, :notes, :changed_by)"
       );
       $histStmt->execute([
           ':class_id'   => $classId,
           ':old_status'  => $currentStatus,
           ':new_status'  => $newStatus,
           ':reason'      => $newStatus === 'stopped' ? $stopReason : null,
           ':notes'       => $notes ?: null,
           ':changed_by'  => get_current_user_id(),
       ]);

       $pdo->commit();
   } catch (\Exception $e) {
       $pdo->rollBack();
       wecoza_log('Class status transition failed: ' . $e->getMessage(), 'error');
       wp_send_json_error(['message' => __('Status update failed. Please try again.', 'wecoza-core')], 500);
       exit;
   }
   ```
8. Return success: `wp_send_json_success(['status' => $newStatus, 'message' => 'Class status updated.'])`

**Handler 2: `handle_class_status_history()`**

1. Call `verify_class_status_nonce()`
2. Extract: `$classId = absint($_POST['class_id'] ?? 0)`
3. Query `class_status_history` ordered by `changed_at DESC`:
   ```sql
   SELECT id, old_status, new_status, reason, notes, changed_by, changed_at
   FROM class_status_history WHERE class_id = :class_id ORDER BY changed_at DESC
   ```
4. Resolve WP user names in PHP (no cross-DB JOIN per Research Pitfall 7):
   ```php
   foreach ($rows as &$row) {
       $user = get_userdata((int) $row['changed_by']);
       $row['changed_by_name'] = $user ? $user->display_name : __('Unknown', 'wecoza-core');
   }
   ```
5. Return: `wp_send_json_success(['history' => $rows])`

**Registration function:**
```php
function register_class_status_ajax_handlers(): void {
    add_action('wp_ajax_wecoza_class_status_update',  __NAMESPACE__ . '\handle_class_status_update');
    add_action('wp_ajax_wecoza_class_status_history', __NAMESPACE__ . '\handle_class_status_history');
}
add_action('init', __NAMESPACE__ . '\register_class_status_ajax_handlers');
```

**B. wecoza-core.php** — Add require_once near the existing AJAX handler requires (~line 671):
```php
require_once __DIR__ . '/src/Classes/Ajax/ClassStatusAjaxHandler.php';
```
  </action>
  <verify>
    <automated>test -f /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Classes/Ajax/ClassStatusAjaxHandler.php && grep -q "handle_class_status_update" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Classes/Ajax/ClassStatusAjaxHandler.php && grep -q "beginTransaction" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Classes/Ajax/ClassStatusAjaxHandler.php && grep -q "ClassStatusAjaxHandler" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/wecoza-core.php && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>ClassStatusAjaxHandler.php created with two endpoints, transaction-safe status transitions, idempotency guards, input sanitization, order_nr_metadata compatibility, and WP user name resolution. Wired into wecoza-core.php.</done>
</task>

<task type="auto">
  <name>Task 2: Status management UI — buttons, modals, and history panel in single class display</name>
  <files>views/classes/components/single-class-display.view.php</files>
  <action>
Add status management section to the single class display view. Use `wecoza_resolve_class_status()` for status check (CC1). Only visible to `manage_options` users.

**A. Status management buttons** — Add after the existing action buttons section (~line 131), inside a `current_user_can('manage_options')` check:

```php
<?php if (current_user_can('manage_options')): ?>
<?php $classStatus = wecoza_resolve_class_status($class); ?>
<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title mb-3"><?= esc_html__('Class Status Management', 'wecoza-core'); ?></h5>
        <div class="d-flex gap-2 align-items-center">
            <?php if ($classStatus === 'draft'): ?>
                <button type="button" class="btn btn-phoenix-success btn-sm" data-bs-toggle="modal" data-bs-target="#activateClassModal">
                    <i class="bi bi-check-circle me-1"></i><?= esc_html__('Activate Class', 'wecoza-core'); ?>
                </button>
            <?php elseif ($classStatus === 'active'): ?>
                <span class="badge badge-phoenix badge-phoenix-success me-2"><i class="bi bi-check-circle me-1"></i><?= esc_html__('Active', 'wecoza-core'); ?></span>
                <button type="button" class="btn btn-phoenix-danger btn-sm" data-bs-toggle="modal" data-bs-target="#stopClassModal">
                    <i class="bi bi-stop-circle me-1"></i><?= esc_html__('Stop Class', 'wecoza-core'); ?>
                </button>
            <?php elseif ($classStatus === 'stopped'): ?>
                <span class="badge badge-phoenix badge-phoenix-danger me-2"><i class="bi bi-stop-circle me-1"></i><?= esc_html__('Stopped', 'wecoza-core'); ?></span>
                <button type="button" class="btn btn-phoenix-success btn-sm" id="btn-reactivate-class">
                    <i class="bi bi-arrow-counterclockwise me-1"></i><?= esc_html__('Reactivate Class', 'wecoza-core'); ?>
                </button>
            <?php endif; ?>
        </div>
    </div>
</div>
<?php endif; ?>
```

**B. Activate Modal** — Add after the status management card (still inside manage_options check):
```html
<div class="modal fade" id="activateClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><?= esc_html__('Activate Class', 'wecoza-core'); ?></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><?= esc_html__('Enter the order number to activate this class.', 'wecoza-core'); ?></p>
                <div class="mb-3">
                    <label for="activate-order-nr" class="form-label"><?= esc_html__('Order Number', 'wecoza-core'); ?></label>
                    <input type="text" class="form-control" id="activate-order-nr" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><?= esc_html__('Cancel', 'wecoza-core'); ?></button>
                <button type="button" class="btn btn-phoenix-success btn-sm" id="btn-confirm-activate">
                    <i class="bi bi-check-circle me-1"></i><?= esc_html__('Activate', 'wecoza-core'); ?>
                </button>
            </div>
        </div>
    </div>
</div>
```

**C. Stop Modal** — Add after activate modal:
```html
<div class="modal fade" id="stopClassModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><?= esc_html__('Stop Class', 'wecoza-core'); ?></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><?= esc_html__('Select a reason for stopping this class.', 'wecoza-core'); ?></p>
                <div class="mb-3">
                    <label for="stop-reason" class="form-label"><?= esc_html__('Reason', 'wecoza-core'); ?></label>
                    <select class="form-select" id="stop-reason" required>
                        <option value=""><?= esc_html__('Select reason...', 'wecoza-core'); ?></option>
                        <option value="programme_ended"><?= esc_html__('Programme Ended', 'wecoza-core'); ?></option>
                        <option value="temporary_hold"><?= esc_html__('Temporary Hold / Pause', 'wecoza-core'); ?></option>
                        <option value="annual_stop"><?= esc_html__('Annual Stop', 'wecoza-core'); ?></option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="stop-notes" class="form-label"><?= esc_html__('Notes (optional)', 'wecoza-core'); ?></label>
                    <textarea class="form-control" id="stop-notes" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><?= esc_html__('Cancel', 'wecoza-core'); ?></button>
                <button type="button" class="btn btn-phoenix-danger btn-sm" id="btn-confirm-stop">
                    <i class="bi bi-stop-circle me-1"></i><?= esc_html__('Stop Class', 'wecoza-core'); ?>
                </button>
            </div>
        </div>
    </div>
</div>
```

**D. Status History Panel** — Add after modals (still inside manage_options check):
```html
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0">
            <button class="btn btn-link btn-sm text-decoration-none p-0 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#statusHistoryCollapse">
                <i class="bi bi-clock-history me-1"></i><?= esc_html__('Status History', 'wecoza-core'); ?>
            </button>
        </h5>
    </div>
    <div id="statusHistoryCollapse" class="collapse">
        <div class="card-body">
            <div id="status-history-content">
                <p class="text-body-tertiary"><?= esc_html__('Loading...', 'wecoza-core'); ?></p>
            </div>
        </div>
    </div>
</div>
```
The history panel starts collapsed. JS will load history on expand and populate `#status-history-content` with a table.

Close the `manage_options` check after the history panel: `<?php endif; ?>`

All strings use `__()` / `esc_html__()` with 'wecoza-core' text domain (CC5).
  </action>
  <verify>
    <automated>grep -q "activateClassModal" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/views/classes/components/single-class-display.view.php && grep -q "stopClassModal" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/views/classes/components/single-class-display.view.php && grep -q "statusHistoryCollapse" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/views/classes/components/single-class-display.view.php && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Single class display has status management card (Activate/Stop/Reactivate buttons), activate modal with order_nr input, stop modal with reason dropdown and notes, and collapsible status history panel. All gated behind manage_options capability.</done>
</task>

</tasks>

<verification>
1. ClassStatusAjaxHandler has transaction-wrapped status transitions
2. Idempotency guard rejects same-state transitions with 400
3. draft→active requires non-empty order_nr
4. active→stopped requires valid stop_reason from whitelist
5. stopped→active reactivation works
6. order_nr_metadata written on activation (CC7)
7. Status history records all transitions
8. Single class view shows correct button per current status
9. Modals have proper form inputs
10. History panel loads on expand
</verification>

<success_criteria>
- Manager can activate/stop/reactivate classes through the UI
- All transitions are atomic and idempotent
- Status history provides full audit trail
- Non-managers cannot see status management controls
</success_criteria>

<output>
After completion, create `.planning/phases/52-class-activation-logic/52-05-SUMMARY.md`
</output>
