# Milestone v1.3: Fix Material Tracking Dashboard

**Status:** SHIPPED 2026-02-06
**Phases:** 19
**Total Plans:** 2

## Overview

Rewired the Material Tracking Dashboard to show classes with "Deliveries" events from `classes.event_dates` JSONB instead of only showing cron-created notification records from `class_material_tracking`. The dashboard now queries user-entered delivery events as its primary data source, with cron notification data shown as supplementary info.

## Phases

### Phase 19: Material Tracking Dashboard Data Source Fix

**Goal**: Rewire the Material Tracking Dashboard to show classes with "Deliveries" events from `classes.event_dates` JSONB instead of only showing cron-created notification records.

**Depends on**: Phase 18 (Notification System â€” provides event_dates JSONB structure)

**Plans**: 2 plans

Plans:

- [x] 19-01: Rewrite repository JSONB queries and service filter logic
- [x] 19-02: Update presenter, views, and shortcode for new data shape

**Details:**

**Plan 19-01 (Repository & Service):**
- Rewrote `MaterialTrackingRepository` to query `classes.event_dates` JSONB using `CROSS JOIN LATERAL jsonb_array_elements()` for Deliveries-type events
- LEFT JOIN `class_material_tracking` for supplementary cron notification data
- Updated `MaterialTrackingDashboardService` filter logic: event-based status ('pending', 'completed') replaces cron-based ('notified', 'delivered')
- Removed `days_range` filter (events exist permanently in JSONB)
- Added text search for class code, subject, and client name
- Preserved all 5 existing cron methods unchanged

**Plan 19-02 (Presentation Layer):**
- Updated `MaterialTrackingPresenter` to map event_dates fields to display format
- Added event status badges (Pending/Completed) using Phoenix badge classes
- Supplementary cron notification badges (7d/5d) shown where cron records exist
- Added Delivery Date column to dashboard table
- Simplified filters: Status (All/Pending/Completed) + Search only
- Updated statistics from total/pending/notified/delivered to total/pending/completed
- Shortcode simplified to accept only `limit` and `status` attributes

**Files modified:**
- `src/Events/Repositories/MaterialTrackingRepository.php`
- `src/Events/Services/MaterialTrackingDashboardService.php`
- `src/Events/Views/Presenters/MaterialTrackingPresenter.php`
- `src/Events/Shortcodes/MaterialTrackingShortcode.php`
- `views/events/material-tracking/dashboard.php`
- `views/events/material-tracking/list-item.php`
- `views/events/material-tracking/statistics.php`

---

## Milestone Summary

**Key Decisions:**

- Query event_dates JSONB as primary data source, LEFT JOIN class_material_tracking for supplementary cron info
- Status filter uses event-based values ('pending', 'completed') instead of cron values ('notified', 'delivered')
- Remove days_range filter (events exist permanently, not time-windowed)
- Map 'delivered' to 'completed' in service layer for backward compatibility
- Event-based status badges as primary, cron notification badges as supplementary
- Remove notification type filter from UI (supplementary dimension)
- Pass event_index in checkbox actions for per-event tracking

**Issues Resolved:**

- Fixed "0 records" issue where dashboard was empty until cron created tracking records
- Dashboard now shows all classes with Deliveries events regardless of cron status
- Unified event-based and cron-based data into single dashboard view

**Issues Deferred:**

- AJAX handler (wecoza_mark_material_delivered) still expects old signature without event_index parameter
- Controllers still call service with old notification_type and days_range parameters
- Need future update to AJAX handler to mark specific event as completed in event_dates JSONB

**Technical Debt Incurred:**

- AJAX mark-as-delivered handler needs update to accept event_index and update event_dates JSONB directly
- Controller layer not yet updated to remove deprecated parameter passing

---

_For current project status, see .planning/ROADMAP.md_
