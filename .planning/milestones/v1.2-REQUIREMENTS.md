# Requirements Archive: v1.2 Event Tasks Refactor

**Archived:** 2026-02-05
**Status:** ✅ SHIPPED

This is the archived requirements specification for v1.2.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: WeCoza Core v1.2 - Event Tasks Refactor

**Defined:** 2026-02-03
**Core Value:** Single source of truth for all WeCoza functionality

## v1.2 Requirements

Requirements for Event Tasks Refactor milestone. Replaces trigger-based task system with manual event capture.

### Database Cleanup

- [x] **DB-01**: Drop PostgreSQL trigger `log_class_change_trigger` on classes table
- [x] **DB-02**: Drop trigger function `log_class_change()`
- [x] **DB-03**: Drop `class_change_logs` table

### Task System Refactor

- [x] **TASK-01**: Rewrite TaskManager to build tasks from `classes.event_dates` JSONB
- [x] **TASK-02**: Implement Agent Order Number as special always-present task
- [x] **TASK-03**: Generate task IDs as `agent-order` and `event-{index}`
- [x] **TASK-04**: Derive task labels from event type and description

### Data Sync

- [x] **SYNC-01**: Update TaskController to write completion to `event_dates` JSONB
- [x] **SYNC-02**: Add `completed_by` field to event schema (WordPress user ID)
- [x] **SYNC-03**: Add `completed_at` field to event schema (ISO timestamp)
- [x] **SYNC-04**: Implement reopen behavior (preserve notes, clear completion metadata)
- [x] **SYNC-05**: Write Agent Order Number completion to `classes.order_nr` field

### Repository & Service Changes

- [x] **REPO-01**: Simplify ClassTaskRepository to query classes directly (no JOIN to change logs)
- [x] **REPO-02**: Update ClassTaskService to pass class data to TaskManager
- [x] **REPO-03**: Update FormDataProcessor to handle completion metadata fields

### Presentation Layer

- [x] **UI-01**: Update ClassTaskPresenter to present event-based tasks
- [x] **UI-02**: Preserve existing UI interaction (Open/Completed columns, Complete/Reopen buttons)
- [x] **UI-03**: Show all classes in dashboard (even those with no events)

### Code Cleanup

- [x] **CLEAN-01**: Remove `src/Events/Models/ClassChangeSchema.php`
- [x] **CLEAN-02**: Remove `src/Events/Services/ClassChangeListener.php`
- [x] **CLEAN-03**: Remove `src/Events/Services/TaskTemplateRegistry.php`
- [x] **CLEAN-04**: Remove `src/Events/Repositories/ClassChangeLogRepository.php`
- [x] **CLEAN-05**: Remove `src/Events/Models/ClassChangeLogDTO.php`
- [x] **CLEAN-06**: Remove `src/Events/Enums/ChangeOperation.php`

### Notification System (Phase 18)

- [x] **NOTIF-01**: Create `class_events` table for application-level event storage
- [x] **NOTIF-02**: Implement event dispatching via Action Scheduler on class/learner changes
- [x] **NOTIF-03**: Email notifications sent immediately on class create + major updates (dates, status, learners)
- [x] **NOTIF-04**: Email notifications sent on learner changes (add/remove/update)
- [x] **NOTIF-05**: AI summaries (GPT) enrich notification emails with change explanations
- [x] **NOTIF-06**: Multiple configurable recipients per notification type
- [x] **NOTIF-07**: Dashboard shortcode with timeline, unread filter, task management
- [x] **NOTIF-08**: Full audit trail (sent, viewed, acknowledged timestamps)

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| DB-01 | Phase 13 | Done |
| DB-02 | Phase 13 | Done |
| DB-03 | Phase 13 | Done |
| TASK-01 | Phase 14 | Done |
| TASK-02 | Phase 14 | Done |
| TASK-03 | Phase 14 | Done |
| TASK-04 | Phase 14 | Done |
| SYNC-01 | Phase 15 | Done |
| SYNC-02 | Phase 15 | Done |
| SYNC-03 | Phase 15 | Done |
| SYNC-04 | Phase 15 | Done |
| SYNC-05 | Phase 15 | Done |
| REPO-01 | Phase 14 | Done |
| REPO-02 | Phase 14 | Done |
| REPO-03 | Phase 15 | Done |
| UI-01 | Phase 16 | Done |
| UI-02 | Phase 16 | Done |
| UI-03 | Phase 16 | Done |
| CLEAN-01 | Phase 17 | Done |
| CLEAN-02 | Phase 17 | Done |
| CLEAN-03 | Phase 17 | Done |
| CLEAN-04 | Phase 17 | Done |
| CLEAN-05 | Phase 17 | Done |
| CLEAN-06 | Phase 17 | Done |
| NOTIF-01 | Phase 18 | Done |
| NOTIF-02 | Phase 18 | Done |
| NOTIF-03 | Phase 18 | Done |
| NOTIF-04 | Phase 18 | Done |
| NOTIF-05 | Phase 18 | Done |
| NOTIF-06 | Phase 18 | Done |
| NOTIF-07 | Phase 18 | Done |
| NOTIF-08 | Phase 18 | Done |

**Coverage:**
- v1.2 requirements: 32 total
- Mapped to phases: 32
- Unmapped: 0 ✓

---

## Milestone Summary

**Shipped:** 32 of 32 v1.2 requirements
**Adjusted:** None
**Dropped:** None

---
*Archived: 2026-02-05 as part of v1.2 milestone completion*
