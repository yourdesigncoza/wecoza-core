# Milestone v1.2: Event Tasks Refactor

**Status:** ✅ SHIPPED 2026-02-05
**Phases:** 13-18
**Total Plans:** 16

## Overview

Replace trigger-based task system with manual event capture integration. Tasks will be derived from user-entered events in the class form instead of auto-generated from database INSERT/UPDATE operations.

## Phases

### Phase 13: Database Cleanup

**Goal**: Remove PostgreSQL trigger infrastructure that auto-generates tasks from class changes.
**Depends on**: None
**Plans**: 1 plan

Plans:
- [x] 13-01: Drop trigger, function, and table (manual SQL execution)

**Details:**
- Dropped `log_class_change_trigger` on classes table
- Dropped `log_class_change()` function
- Dropped `class_change_logs` table
- Breaking change — old task system stops working

---

### Phase 14: Task System Refactor

**Goal**: Rewrite core task services to build tasks from event_dates JSONB instead of change logs.
**Depends on**: Phase 13
**Plans**: 2 plans

Plans:
- [x] 14-01: Add buildTasksFromEvents() factory method to TaskManager
- [x] 14-02: Update repository and service for direct class queries

**Details:**
- TaskManager builds TaskCollection from `classes.event_dates` array
- Agent Order Number task always present (writes to `classes.order_nr`)
- Task IDs: `agent-order` and `event-{index}`
- ClassTaskRepository queries classes directly (no JOIN to change logs)

---

### Phase 15: Bidirectional Sync

**Goal**: Implement synchronization between task dashboard and class form event data.
**Depends on**: Phase 14
**Plans**: 2 plans

Plans:
- [x] 15-01: Foundation methods (JSONB update, notes preservation, metadata passthrough)
- [x] 15-02: TaskController refactor (class_id, completion/reopen persistence)

**Details:**
- Task completion updates `event_dates[N].status`, `completed_by`, `completed_at`
- Reopen preserves notes field, clears completion metadata
- Agent Order Number writes value to `classes.order_nr`
- FormDataProcessor handles completion metadata on form save

---

### Phase 16: Presentation Layer

**Goal**: Update UI components to display event-based tasks with existing interaction patterns.
**Depends on**: Phase 15
**Plans**: 2 plans

Plans:
- [x] 16-01: Fix JavaScript AJAX parameter (log_id to class_id) and clean view templates
- [x] 16-02: UI verification checkpoint

**Details:**
- ClassTaskPresenter formats event-based tasks
- Open/Completed columns, Complete/Reopen buttons work
- Badge shows "OPEN +N" for pending tasks
- All classes appear (even those with zero events)

---

### Phase 17: Code Cleanup

**Goal**: Remove deprecated files that are no longer used after refactor.
**Depends on**: Phases 13-16
**Plans**: 1 plan

Plans:
- [x] 17-01: Delete deprecated files, clean TaskManager dead methods, update Container and test file

**Details:**
- 6 files deleted: ClassChangeController, ClassChangeSchema, ClassChangeListener, TaskTemplateRegistry, ClassChangeLogRepository, AISummaryDisplayService
- 2 files already deleted: ClassChangeLogDTO, ChangeOperation
- TaskManager dead methods removed (queried dropped table)
- Container.php TaskTemplateRegistry references removed
- Test file updated with skip notices

---

### Phase 18: Notification System

**Goal**: Implement email and dashboard notifications for class and learner changes using application-level events.
**Depends on**: Phase 13 (independent data path)
**Plans**: 8 plans

Plans:
- [x] 18-01: Database schema (class_events table) + repository + DTOs + enums
- [x] 18-02: EventDispatcher service for capturing application events
- [x] 18-03: Update NotificationProcessor/Enricher/Emailer for new schema
- [x] 18-04: Dashboard service + shortcode + presenter updates
- [x] 18-05: Controller integration (dispatch events from class/learner changes)
- [x] 18-06: Enable hooks in wecoza-core.php + multi-recipient settings
- [x] 18-07: Admin settings UI for recipient configuration
- [x] 18-08: Dashboard view templates + verification checkpoint

**Details:**
- New `class_events` table for application-level events
- Action Scheduler job queue for async processing
- 3-stage pipeline: Detect → Enrich (AI) → Send
- Multiple configurable recipients per event type
- Dashboard with timeline, unread filter, click-to-mark-viewed

---

## Milestone Summary

**Key Decisions:**

- Replace triggers with manual events — user controls events explicitly
- Agent Order Number always present — confirms class activation
- Bidirectional sync — dashboard ↔ form stay in sync
- Task IDs: agent-order, event-{index} — predictable access pattern
- JSONB for event_data and ai_summary — flexible schema
- Application-level events (not triggers) — more flexible, testable
- Action Scheduler for async — reliable job queue

**Issues Resolved:**

- Trigger-based tasks created confusion (auto-generated vs user-entered)
- class_change_logs table accumulating stale data
- log_id references scattered throughout codebase

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- Phase 13 lacks SUMMARY.md (manual SQL execution)
- Some test sections replaced with skip notices (acceptable cleanup)

---

*For current project status, see .planning/ROADMAP.md*
