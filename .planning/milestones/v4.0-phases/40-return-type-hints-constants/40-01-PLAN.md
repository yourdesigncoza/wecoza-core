---
phase: 40-return-type-hints-constants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - core/Abstract/AppConstants.php
  - core/Abstract/BaseRepository.php
  - core/Abstract/BaseModel.php
  - src/Learners/Controllers/LearnerController.php
  - src/Learners/Services/LearnerService.php
  - src/Learners/Services/ProgressionService.php
  - src/Learners/Repositories/LearnerProgressionRepository.php
  - src/Learners/Models/LearnerModel.php
  - src/Learners/Models/LearnerProgressionModel.php
  - src/Events/Repositories/ClassEventRepository.php
  - src/Events/Repositories/MaterialTrackingRepository.php
  - src/Events/Services/NotificationDashboardService.php
  - src/Events/Services/MaterialTrackingDashboardService.php
  - src/Events/Services/AISummaryService.php
  - src/Events/Services/NotificationProcessor.php
  - src/Classes/Repositories/ClassRepository.php
  - src/Classes/Controllers/ClassController.php
  - src/Clients/Repositories/ClientRepository.php
  - src/Clients/Repositories/LocationRepository.php
  - src/Clients/Models/LocationsModel.php
  - src/Clients/Ajax/ClientAjaxHandlers.php
  - src/Clients/Services/ClientService.php
  - src/Agents/Repositories/AgentRepository.php
  - src/Agents/Ajax/AgentsAjaxHandlers.php
  - src/Agents/Services/AgentService.php
  - src/Agents/Controllers/AgentsController.php
autonomous: true

must_haves:
  truths:
    - "AppConstants class exists with SCREAMING_SNAKE_CASE pagination, timeout, and bounds constants"
    - "All magic number pagination defaults (10, 20, 50) replaced with AppConstants references"
    - "All magic number timeout values (30, 120) replaced with AppConstants or class-level constants"
    - "Max bounds clamp (100 in AgentService) uses AppConstants reference"
  artifacts:
    - path: "core/Abstract/AppConstants.php"
      provides: "Shared constants for pagination, timeouts, bounds"
      contains: "DEFAULT_PAGE_SIZE"
    - path: "core/Abstract/BaseRepository.php"
      provides: "Updated findAll/findBy/paginate defaults referencing AppConstants"
      contains: "AppConstants::DEFAULT_PAGE_SIZE"
  key_links:
    - from: "src/Learners/Controllers/LearnerController.php"
      to: "core/Abstract/AppConstants.php"
      via: "use statement + constant reference"
      pattern: "AppConstants::DEFAULT_PAGE_SIZE"
    - from: "core/Abstract/BaseRepository.php"
      to: "core/Abstract/AppConstants.php"
      via: "use statement + constant reference"
      pattern: "AppConstants::DEFAULT_PAGE_SIZE"
---

<objective>
Create AppConstants class and extract all magic numbers (pagination limits, timeouts, bounds) to named constants across all modules.

Purpose: Eliminate magic numbers from business logic (CONST-01 through CONST-04), making values discoverable and changeable from a single location.
Output: AppConstants class + all magic number references replaced across ~25 files.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/Abstract/BaseRepository.php
@core/Abstract/BaseModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AppConstants class with shared pagination, timeout, and bounds constants</name>
  <files>core/Abstract/AppConstants.php</files>
  <action>
Create `core/Abstract/AppConstants.php` in namespace `WeCoza\Core\Abstract` with the following constants:

```php
class AppConstants
{
    // Pagination defaults (CONST-01)
    public const DEFAULT_PAGE_SIZE = 50;         // Default for list views (learners, events, classes)
    public const SEARCH_RESULT_LIMIT = 10;       // Default for search/autocomplete dropdowns
    public const SHORTCODE_DEFAULT_LIMIT = 20;   // Default for shortcode pagination
    public const MAX_PAGE_SIZE = 100;            // Upper bound for per_page parameter

    // Timeout values (CONST-02)
    public const API_TIMEOUT_SECONDS = 30;       // External API call timeout
    public const LOCK_TTL_SECONDS = 120;         // Process lock time-to-live

    // Progress/score limits (CONST-03)
    public const PROGRESS_MAX_PERCENT = 100;     // Maximum progress percentage

    // Pagination bounds
    public const MIN_PAGE = 1;                   // Minimum page number
    public const MIN_PAGE_SIZE = 1;              // Minimum per_page value
}
```

Use `declare(strict_types=1)` and standard WeCoza file header. Guard with `if (!defined('ABSPATH')) exit;`.

Do NOT touch Events module's existing `private const` values (LOCK_TTL, TIMEOUT_SECONDS, BATCH_LIMIT, DEFAULT_LIMIT in shortcodes) — those are correctly scoped as class-level constants already.
  </action>
  <verify>Run `php -l core/Abstract/AppConstants.php` — no syntax errors. Confirm all constants use SCREAMING_SNAKE_CASE.</verify>
  <done>AppConstants.php exists with all shared constants defined using SCREAMING_SNAKE_CASE naming.</done>
</task>

<task type="auto">
  <name>Task 2: Replace magic numbers with AppConstants references across all modules</name>
  <files>
    core/Abstract/BaseRepository.php
    core/Abstract/BaseModel.php
    src/Learners/Controllers/LearnerController.php
    src/Learners/Services/LearnerService.php
    src/Learners/Services/ProgressionService.php
    src/Learners/Repositories/LearnerProgressionRepository.php
    src/Learners/Models/LearnerModel.php
    src/Events/Repositories/ClassEventRepository.php
    src/Events/Repositories/MaterialTrackingRepository.php
    src/Events/Services/NotificationDashboardService.php
    src/Events/Services/MaterialTrackingDashboardService.php
    src/Classes/Repositories/ClassRepository.php
    src/Classes/Controllers/ClassController.php
    src/Clients/Repositories/ClientRepository.php
    src/Clients/Repositories/LocationRepository.php
    src/Clients/Models/LocationsModel.php
    src/Clients/Ajax/ClientAjaxHandlers.php
    src/Clients/Services/ClientService.php
    src/Agents/Repositories/AgentRepository.php
    src/Agents/Ajax/AgentsAjaxHandlers.php
    src/Agents/Services/AgentService.php
    src/Agents/Controllers/AgentsController.php
  </files>
  <action>
Add `use WeCoza\Core\Abstract\AppConstants;` to each file and replace magic numbers:

**Core layer:**
- `BaseRepository::findAll()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `BaseRepository::findBy()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `BaseRepository::paginate()` default `$perPage = 20` → `$perPage = AppConstants::SHORTCODE_DEFAULT_LIMIT`
- `BaseModel::getAll()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`

**Learners module:**
- `LearnerController` line 105: `?? 50` → `?? AppConstants::DEFAULT_PAGE_SIZE`
- `LearnerController` line 271: `'limit' => 10` → `'limit' => AppConstants::SEARCH_RESULT_LIMIT`
- `LearnerService::getLearners()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `ProgressionService::getProgressionsForAdmin()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `LearnerProgressionRepository::findWithFilters()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `LearnerModel::getAll()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`

**Events module** (only method signature defaults, NOT existing class-level constants):
- `ClassEventRepository::findPendingForProcessing()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `ClassEventRepository::findByEntity()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `ClassEventRepository::getTimeline()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `NotificationDashboardService::getTimeline()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `NotificationDashboardService::getByEntity()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `MaterialTrackingRepository::getTrackingDashboardData()` default `$limit = 50` → `$limit = AppConstants::DEFAULT_PAGE_SIZE`
- `MaterialTrackingDashboardService` line 32: `: 50` → `: AppConstants::DEFAULT_PAGE_SIZE`

**Classes module:**
- `ClassRepository` lines 496, 727: `: 50` → `: AppConstants::DEFAULT_PAGE_SIZE`
- `ClassController` line 375: `'limit' => 50` → `'limit' => AppConstants::DEFAULT_PAGE_SIZE`

**Clients module:**
- `ClientRepository::searchClients()` default `$limit = 20` → `$limit = AppConstants::SHORTCODE_DEFAULT_LIMIT`
- `LocationRepository::findByCoordinates()` default `$limit = 10` → `$limit = AppConstants::SEARCH_RESULT_LIMIT`
- `LocationRepository` line 175: `LIMIT 10` — leave as raw SQL (hardcoded in query string, not a parameter)
- `LocationsModel` line 155: `LIMIT 10` — leave as raw SQL
- `LocationsModel` line 178: `: 10` → `: AppConstants::SEARCH_RESULT_LIMIT`
- `ClientAjaxHandlers` line 158: `10` → `AppConstants::SEARCH_RESULT_LIMIT`
- `ClientService::searchClients()` default `$limit = 10` → `$limit = AppConstants::SEARCH_RESULT_LIMIT`

**Agents module:**
- `AgentRepository` line 274: `'limit' => 100` → `'limit' => AppConstants::MAX_PAGE_SIZE`
- `AgentsController` line 159: `'per_page' => 10` → `'per_page' => AppConstants::SEARCH_RESULT_LIMIT`
- `AgentsAjaxHandlers` line 72: `10` in fallback → `AppConstants::SEARCH_RESULT_LIMIT`
- `AgentService` line 573: `min(100, $perPage)` → `min(AppConstants::MAX_PAGE_SIZE, $perPage)`

Do NOT change:
- Events `private const` values (already class-scoped constants)
- Raw SQL `LIMIT 10` in query strings (would need parameterization, out of scope)
- Validation length limits (e.g., `max_length:50`) — these are domain rules, not magic numbers
- Percentage calculations like `* 100` in ProgressionModel — mathematical identity, not a magic number
  </action>
  <verify>
Run `grep -rn 'limit = 50\|limit = 20\|limit = 10\|per_page.*10\b' src/ core/ --include="*.php" | grep -v 'const \|private const\|LIMIT 10\|max_length\|min_length'` — should return zero or only justified exceptions. Run `php -l` on all modified files.
  </verify>
  <done>All pagination magic numbers replaced with AppConstants references. No bare numeric pagination defaults remain in method signatures or fallback values.</done>
</task>

</tasks>

<verification>
1. `php -l core/Abstract/AppConstants.php` passes
2. `grep -rn 'AppConstants::' src/ core/ --include="*.php" | wc -l` shows 25+ references
3. `grep -rn 'public const' core/Abstract/AppConstants.php` shows all constants in SCREAMING_SNAKE_CASE
4. No broken imports — `php -l` passes on all modified files
</verification>

<success_criteria>
- AppConstants class exists with pagination, timeout, and bounds constants
- All method signature defaults reference AppConstants instead of bare numbers
- Events module's existing class-level constants left untouched
- Zero magic pagination numbers in method signatures (grep verification passes)
</success_criteria>

<output>
After completion, create `.planning/phases/40-return-type-hints-constants/40-01-SUMMARY.md`
</output>
