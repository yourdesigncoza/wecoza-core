---
phase: 37-model-architecture-unification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Agents/Models/AgentModel.php
autonomous: true

must_haves:
  truths:
    - "AgentService can create, validate, and save agents using AgentModel (new AgentModel($data), ->validate(), ->get_errors())"
    - "AgentModel validation rejects invalid email, invalid SA ID, missing required fields, and duplicate email/ID"
    - "Agent convenience methods return correct values (get_display_name, get_preferred_areas, has_quantum_qualification, get_status_label)"
    - "AgentModel data-bag pattern works: get('field'), set('field', val), get_data(), to_array() all return expected data"
  artifacts:
    - path: "src/Agents/Models/AgentModel.php"
      provides: "AgentModel extending BaseModel with preserved validation and agent-specific methods"
      contains: "class AgentModel extends BaseModel"
  key_links:
    - from: "src/Agents/Services/AgentService.php"
      to: "src/Agents/Models/AgentModel.php"
      via: "new AgentModel($data), validate(), get_errors()"
      pattern: "new AgentModel|->validate\\(|->get_errors\\("
---

<objective>
Migrate AgentModel to extend BaseModel while preserving its data-bag pattern, modification tracking, comprehensive validation, and all consumer-facing methods.

Purpose: Eliminate architectural inconsistency where AgentModel is a standalone class not inheriting from BaseModel. After migration, AgentModel inherits BaseModel's table/primaryKey statics, abstract method contracts, and database access infrastructure while retaining its data-bag pattern, agent-specific validation, form helpers, and convenience methods. Note: AgentModel's get()/set() are NOT duplicates of BaseModel (which has no such methods); only to_array() is consolidated with BaseModel's toArray().

Output: Refactored AgentModel.php extending BaseModel with zero changes to consumer code (AgentService, AgentRepository consumers).
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/Abstract/BaseModel.php
@src/Agents/Models/AgentModel.php
@src/Agents/Services/AgentService.php
@src/Learners/Models/LearnerModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AgentModel to extend BaseModel</name>
  <files>src/Agents/Models/AgentModel.php</files>
  <action>
Refactor AgentModel to extend BaseModel while preserving its data-bag pattern (`$data[]` array) and all consumer-facing behavior.

**NOTE on "duplicate methods" (design doc clarification):** Code analysis confirms BaseModel has NO explicit `get()` or `set()` methods. It only has `__get` magic and `fill()`. AgentModel's `get($key, $default)` and `set($key, $value)` operate on a `$data[]` array bag, which is a fundamentally different mechanism from BaseModel's typed-property access. These are NOT duplicates. The only true naming duplicate is `to_array()` vs BaseModel's `toArray()` — this will be consolidated.

**Implementation steps:**

1. **Add BaseModel extension:**
   - Add `use WeCoza\Core\Abstract\BaseModel;`
   - Change to `class AgentModel extends BaseModel`

2. **Configure BaseModel statics:**
   - `protected static string $table = 'agents';`
   - `protected static string $primaryKey = 'agent_id';`
   - `protected static array $casts = [];`
   - `protected static array $fillable = [];` (all allowed — data-bag manages own fields)
   - `protected static array $guarded = [];` (no guarding — data-bag pattern)

3. **Override constructor:**
   - Call `parent::__construct([])` first (skip BaseModel hydration)
   - Then do existing logic: if numeric → load(); if array → set_data()

4. **Keep all data-bag properties:** `$data`, `$modified`, `$errors`, `$defaults` — no conflicts with BaseModel

5. **Override BaseModel magic methods:**
   - `__get($name)` — keep AgentModel's version (delegates to data-bag `get()`)
   - `__isset($name)` — keep AgentModel's version (checks data-bag)
   - `__set($name, $value)` — keep AgentModel's version (BaseModel has no __set)

6. **Keep `get()` and `set()` methods as-is** — they are NOT duplicates of BaseModel (BaseModel has no such methods). They operate on the `$data[]` bag with modification tracking.

7. **Consolidate `to_array()` with `toArray()`:**
   - Override BaseModel's `toArray()` with AgentModel's logic: merge defaults + data + id
   - Keep `to_array()` as a backward-compatible alias that calls `$this->toArray()`

8. **Satisfy BaseModel abstract methods:**
   - `getById(int $id): ?static` — new static method: `$instance = new static(); return $instance->load($id) ? $instance : null;`
   - `save(): bool` — change return type from `bool|int` to `bool`. Return `true` on success (callers already have `$instance->id` for the ID). AgentService does not call save() directly, so this is safe.
   - `update(): bool` — new method extracting the update branch from save(): `if (!$this->id) return false; $repo = new AgentRepository(); return $repo->updateAgent($this->id, $this->get_save_data());`
   - `delete(): bool` — already exists with correct signature, keep as-is

9. **Preserve ALL agent-specific methods unchanged:**
   - Data: `load()`, `set_data()`, `get_data()`, `get_save_data()`
   - Access: `get()`, `set()`, `is_modified()`, `get_modified_fields()`
   - Validation: `validate()`, `get_errors()`, `is_valid_date()`
   - Form helpers: `get_form_field()`, `set_form_field()`, `set_form_data()`, `get_form_data()`
   - Display: `get_display_name()`, `get_initials()`, `get_status_label()`
   - Domain: `get_preferred_areas()`, `set_preferred_areas()`, `has_quantum_qualification()`
   - Serialization: `to_json()`

**IMPORTANT:** Do NOT change how AgentModel stores data internally. The `$data[]` bag pattern is the source of truth. BaseModel's typed-property infrastructure is inherited but overridden where it conflicts with the data-bag approach.
  </action>
  <verify>
Run `php -l src/Agents/Models/AgentModel.php` to verify no syntax errors.
Run `grep -n "extends BaseModel" src/Agents/Models/AgentModel.php` to confirm extension.
Run `grep -n "function toArray" src/Agents/Models/AgentModel.php` to confirm single toArray.
Run `grep -n "function to_array" src/Agents/Models/AgentModel.php` to confirm alias exists.
  </verify>
  <done>
AgentModel extends BaseModel. BaseModel abstract methods (getById, save, update, delete) all satisfied. Data-bag pattern preserved. to_array() consolidated to call toArray(). All agent-specific methods unchanged. Validation framework intact.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify AgentModel consumers and run full validation</name>
  <files>src/Agents/Services/AgentService.php</files>
  <action>
After Task 1 refactors AgentModel, verify that all consumer code compiles and integrates correctly:

1. **Syntax-check all consumer files:**
   - `php -l src/Agents/Models/AgentModel.php`
   - `php -l src/Agents/Services/AgentService.php`
   - `php -l src/Agents/Repositories/AgentRepository.php`
   - `php -l src/Agents/Ajax/AgentAjaxHandlers.php` (if exists)
   - Run: `find src/Agents/ -name "*.php" -exec php -l {} \;`

2. **Verify critical consumer patterns still work:**

   a. **AgentService::handleAgentFormSubmission()** (line ~129):
      ```php
      $agentModel = new AgentModel($data);        // Constructor must accept array
      $isValid = $agentModel->validate([...]);     // validate() must accept ?array context
      $agentModel->get_errors();                   // get_errors() must return array
      ```
      Confirm all three calls are compatible with refactored model.

   b. **AgentModel internal calls:**
      - `$this->get('field_name')` — must still work on $data bag
      - `$this->set('field_name', $value)` — must still work
      - `$this->get_data()` — must return merged defaults + data
      - `$this->to_array()` — must return complete data with id

3. **Confirm no method signature breaks:**
   - Grep for all external calls to AgentModel across the entire src/ directory
   - Check each call site against new signatures
   - `save()` now returns `bool` not `bool|int` — verify no caller depends on int return

4. **Verify toArray consolidation:**
   - `grep -n "function toArray" src/Agents/Models/AgentModel.php` — should exist (overrides BaseModel)
   - `grep -n "function to_array" src/Agents/Models/AgentModel.php` — should exist as backward-compatible alias calling toArray()
   - Confirm no independent duplicate toArray exists

5. **Verify get/set methods are retained correctly:**
   - `grep -n "function get(" src/Agents/Models/AgentModel.php` — must exist (NOT a BaseModel duplicate; BaseModel has no get() method)
   - `grep -n "function set(" src/Agents/Models/AgentModel.php` — must exist (NOT a duplicate; operates on data-bag)
   - These methods are agent-specific data-bag accessors, distinct from BaseModel's __get magic

6. **Run full PHP syntax check:**
   ```bash
   find src/Agents/ -name "*.php" -exec php -l {} \;
   ```
  </action>
  <verify>
All PHP files in src/Agents/ pass `php -l` syntax check.
`grep -rn "AgentModel" src/Agents/ --include="*.php"` shows all usages — verify none broken.
`grep -rn "extends BaseModel" src/Agents/Models/AgentModel.php` confirms extension.
  </verify>
  <done>
All AgentModel consumers (AgentService, AgentRepository, AgentAjaxHandlers) work unchanged. AgentModel extends BaseModel. toArray()/to_array() consolidated. get()/set() retained as data-bag accessors. Validation intact. PHP lint passes on all files.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Agents/Models/AgentModel.php` — no syntax errors
2. `grep "class AgentModel extends BaseModel" src/Agents/Models/AgentModel.php` — confirms extension
3. All PHP files in `src/Agents/` pass syntax check
4. No changes to BaseModel.php (LearnerModel, ClassModel unaffected)
5. AgentService::handleAgentFormSubmission() works with refactored model
6. Both ClientsModel and AgentModel extend BaseModel (MDL-01 + MDL-02)
7. AgentModel's toArray() overrides BaseModel's; to_array() is a backward-compatible alias (no independent duplicate)
8. AgentModel's get()/set() are retained as data-bag accessors (distinct from BaseModel's __get magic — not duplicates)
</verification>

<success_criteria>
- AgentModel class declaration reads `class AgentModel extends BaseModel`
- BaseModel's abstract methods (getById, save, update, delete) all satisfied
- Data-bag pattern ($data array) preserved for backward compatibility
- to_array() consolidated with toArray() (no independent duplicate)
- AgentModel::validate() preserves ALL validation rules (required, email, SA ID, phone, uniqueness)
- AgentService code unchanged — new AgentModel($data), validate(), get_errors() all work
- PHP lint passes on all files in src/Agents/
</success_criteria>

<output>
After completion, create `.planning/phases/37-model-architecture-unification/37-02-SUMMARY.md`
</output>
