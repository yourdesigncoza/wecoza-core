---
phase: 36-service-layer-extraction
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Clients/Services/ClientService.php
  - src/Clients/Controllers/ClientsController.php
  - src/Clients/Ajax/ClientAjaxHandlers.php
autonomous: true

must_haves:
  truths:
    - "ClientService contains all client CRUD workflow, form submission handling, site management, and data sanitization"
    - "ClientsController shortcode methods are thin — parse params, delegate to service, pass to view"
    - "ClientAjaxHandlers delegates save/delete/search to ClientService — no duplicate business logic"
    - "The ~160-line handleFormSubmission and ~120-line saveClient logic consolidated into ONE ClientService method"
    - "All existing AJAX endpoints return identical responses (backward compatible)"
  artifacts:
    - path: "src/Clients/Services/ClientService.php"
      provides: "Client CRUD workflow, form submission, site management, data sanitization, CSV export"
      contains: "class ClientService"
    - path: "src/Clients/Controllers/ClientsController.php"
      provides: "Thin controller with shortcode rendering delegating to ClientService"
      contains: "ClientService"
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "AJAX handlers delegating to ClientService — no duplicate business logic"
      contains: "ClientService"
  key_links:
    - from: "src/Clients/Controllers/ClientsController.php"
      to: "src/Clients/Services/ClientService.php"
      via: "lazy property"
      pattern: "clientService"
    - from: "src/Clients/Ajax/ClientAjaxHandlers.php"
      to: "src/Clients/Services/ClientService.php"
      via: "property injection"
      pattern: "clientService"
    - from: "src/Clients/Services/ClientService.php"
      to: "src/Clients/Models/ClientsModel.php"
      via: "internal model usage"
      pattern: "ClientsModel"
---

<objective>
Extract client business logic from ClientsController and ClientAjaxHandlers into a dedicated ClientService class, eliminating significant code duplication (DRY).

Purpose: This is the highest-value extraction (SVC-03). ClientsController::handleFormSubmission() (~160 lines) and ClientAjaxHandlers::saveClient() (~120 lines) share ~80% identical logic for validation, site saving, and communications logging. Similarly, sanitizeFormData() and sanitizeClientFormData() are near-duplicates. ClientService consolidates all this into a single source of truth.

Output: ClientService.php with unified business logic; both ClientsController and ClientAjaxHandlers delegate to it; ~280 lines of duplicate code eliminated.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Clients/Controllers/ClientsController.php
@src/Clients/Ajax/ClientAjaxHandlers.php
@src/Clients/Models/ClientsModel.php
@src/Clients/Models/SitesModel.php
@src/Clients/Repositories/ClientRepository.php
@core/Abstract/BaseController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClientService with unified business logic (DRY extraction)</name>
  <files>src/Clients/Services/ClientService.php</files>
  <action>
Create `src/Clients/Services/ClientService.php` in namespace `WeCoza\Clients\Services`.

This is the biggest DRY win of Phase 36. The following logic is DUPLICATED between ClientsController::handleFormSubmission() and ClientAjaxHandlers::saveClient():
- Client data validation
- Site validation (head site vs sub-site)
- Error merging for site fields
- Client create/update logic
- Site save logic (head site vs sub-site with fallback)
- Communication type logging
- Final client reload

The service consolidates ALL of this into a single method.

**1. Unified form submission** — the centerpiece method:
```php
/**
 * Handle client form submission (create or update)
 *
 * Single source of truth for both controller and AJAX handler.
 *
 * @param array $rawData Raw POST data
 * @param int $clientId Client ID (0 for new)
 * @return array ['success' => bool, 'client' => array|null, 'errors' => array, 'message' => string, 'data' => array]
 */
public function handleClientSubmission(array $rawData, int $clientId = 0): array
```

This method must:
a. Call `sanitizeFormData($rawData)` to get `$clientData` and `$siteData`
b. Validate client via `$model->validate($clientData, $clientId)`
c. Validate site (head or sub-site) via SitesModel
d. Merge site errors into client errors with proper field mapping (site_name, client_town_id, site_place_id)
e. Return errors early if any
f. Create or update client
g. Verify site ownership via `ensureSiteBelongsToClient()`
h. Save site (head or sub-site with fallback options)
i. Log communication type change if applicable
j. Reload and return client

This replaces BOTH `ClientsController::handleFormSubmission()` (~160 lines) and the core of `ClientAjaxHandlers::saveClient()` (~120 lines).

**2. Data sanitization** — unified from two near-identical methods:
```php
public function sanitizeFormData(array $data): array
```
Consolidates `ClientsController::sanitizeFormData()` and `ClientAjaxHandlers::sanitizeClientFormData()` into ONE method. Returns `['client' => array, 'site' => array]`.

**3. Client CRUD wrappers:**
- `getClient(int $id): ?array` — delegates to ClientsModel::getById()
- `getClients(array $params): array` — delegates to ClientsModel::getAll()
- `getClientCount(array $params): int` — delegates to ClientsModel::count()
- `deleteClient(int $id): bool` — delegates to ClientsModel::delete()
- `searchClients(string $search, int $limit): array` — delegates to ClientsModel::getAll()
- `getStatistics(): array` — delegates to ClientsModel::getStatistics()
- `getMainClients(): array` — delegates to ClientsModel::getMainClients()

**4. Client details for modal** (from AJAX handler):
- `getClientDetails(int $clientId): ?array` — loads client, builds edit URL, resolves main client name

**5. Form data preparation:**
- `prepareFormData(int $clientId): array` — returns all dropdown data, location data, sites data, main clients list needed for capture/update forms
- `filterClientDataForForm(array $client): array` — moved from controller

**6. CSV export:**
- `exportClientsAsCsv(): array` — returns `['headers' => array, 'rows' => array]` (data only, not HTTP response)

**7. Location/site helpers:**
- `getBranchClients(int $clientId): array` — delegates to SitesModel::getSitesByClient()
- `getLocationHierarchy(): array` — delegates to SitesModel::getLocationHierarchy()

Constructor instantiates ClientsModel (which provides access to SitesModel and CommunicationsModel):
```php
class ClientService
{
    private ClientsModel $model;

    public function __construct()
    {
        $this->model = new ClientsModel();
    }

    private function getSitesModel(): SitesModel
    {
        return $this->model->getSitesModel();
    }
}
```

Use `declare(strict_types=1)` and proper PHPDoc.
  </action>
  <verify>
Run `php -l src/Clients/Services/ClientService.php` — syntax OK.
Grep for `class ClientService` — exists.
Grep for `handleClientSubmission` — exists (the unified method).
Grep for `sanitizeFormData` — exists once in service (not duplicated).
Verify public methods: handleClientSubmission, sanitizeFormData, getClient, getClients, getClientCount, deleteClient, searchClients, getStatistics, getMainClients, getClientDetails, prepareFormData, filterClientDataForForm, exportClientsAsCsv, getBranchClients, getLocationHierarchy.
  </verify>
  <done>
ClientService.php exists with unified handleClientSubmission() method replacing two duplicate implementations. Data sanitization consolidated. All client CRUD, form preparation, and export logic centralized. PHP syntax valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ClientsController and ClientAjaxHandlers to use ClientService</name>
  <files>
src/Clients/Controllers/ClientsController.php
src/Clients/Ajax/ClientAjaxHandlers.php
  </files>
  <action>
**ClientsController refactor:**

1. Replace `protected $model = null;` and `getModel()` with `private ?ClientService $clientService = null;` and lazy getter `getClientService(): ClientService`.
2. Remove `getSitesModel()` — service handles site access internally.
3. Add `use WeCoza\Clients\Services\ClientService;` import.

4. **Refactor `captureClientShortcode()`** — currently loads dropdown data, handles form submission, builds location data (~110 lines). After refactor:
   ```php
   public function captureClientShortcode($atts)
   {
       if (!current_user_can('manage_wecoza_clients')) {
           return '<p>...</p>';
       }
       $atts = shortcode_atts(['id' => 0], $atts);

       $client = null;
       $errors = [];
       $success = false;

       if ($atts['id']) {
           $client = $this->getClientService()->getClient($atts['id']);
           if (!$client) { return '<p>Client not found.</p>'; }
       }

       // Handle form submission via service
       if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['nonce']) && !wp_doing_ajax()) {
           if (!wp_verify_nonce($_POST['nonce'], 'clients_nonce_action')) {
               $errors[] = __('Security check failed.', 'wecoza-core');
           } else {
               $result = $this->getClientService()->handleClientSubmission($_POST, (int) $atts['id']);
               $success = $result['success'];
               if ($success) {
                   $client = $result['client'];
               } else {
                   $errors = $result['errors'];
                   // Merge submitted data for form re-population
                   if (!empty($result['data']['client'])) {
                       $client = array_merge(is_array($client) ? $client : [], $result['data']['client']);
                   }
               }
           }
       }

       // Get form data (dropdowns, locations, sites, main clients)
       $formData = $this->getClientService()->prepareFormData($client['id'] ?? 0);

       return wecoza_view('clients/components/client-capture-form', array_merge(
           ['client' => $client, 'errors' => $errors, 'success' => $success],
           $formData
       ), true);
   }
   ```
   Target: ~35 lines (was ~110).

5. **Refactor `updateClientShortcode()`** — similar pattern, delegate to service:
   - Permission check, parse URL params, load client via service
   - Form submission via `handleClientSubmission()`
   - Form data via `prepareFormData()`
   - Target: ~40 lines (was ~120). The massive location/site data assembly block is now in `prepareFormData()`.

6. **Refactor `displayClientsShortcode()`** — delegate to service:
   - Parse query params from $_GET
   - Call `$this->getClientService()->getClients($params)`, `getClientCount($params)`, `getStatistics()`
   - Pass to view
   - Target: ~30 lines (was ~60)

7. **Remove methods moved to service:**
   - `handleFormSubmission()` (~160 lines — the big one)
   - `sanitizeFormData()` (~60 lines)
   - `filterClientDataForForm()` (~65 lines)
   - `getLocalizationPayload()` — keep this in controller (it's presentation/asset concern)

**ClientAjaxHandlers refactor:**

1. Add `private ClientService $clientService;` property, initialize in constructor.
2. Remove `private ClientRepository $clientRepository;` and `private LocationRepository $locationRepository;` — service owns data access.
3. Add `use WeCoza\Clients\Services\ClientService;` import.

4. **Refactor `saveClient()`** — the biggest win. Replace ~120 lines of duplicate logic with:
   ```php
   public function saveClient()
   {
       AjaxSecurity::requireNonce('clients_nonce_action');
       if (!current_user_can('manage_wecoza_clients')) {
           AjaxSecurity::sendError('Permission denied.', 403);
       }
       try {
           $clientId = isset($_POST['id']) ? intval($_POST['id']) : 0;
           $result = $this->clientService->handleClientSubmission($_POST, $clientId);

           if (!$result['success']) {
               AjaxSecurity::sendError('Validation errors', 400, ['errors' => $result['errors']]);
           }

           AjaxSecurity::sendSuccess([
               'client' => $result['client'],
               'message' => $result['message'],
           ]);
       } catch (\Throwable $e) {
           wecoza_log('Error saving client: ' . $e->getMessage(), 'error');
           AjaxSecurity::sendError('An error occurred while saving the client.', 500);
       }
   }
   ```
   Target: ~20 lines (was ~120). This is the DRY centerpiece.

5. **Refactor `getClient()`** — use `$this->clientService->getClient($clientId)`.
6. **Refactor `getClientDetails()`** — use `$this->clientService->getClientDetails($clientId)`.
7. **Refactor `deleteClient()`** — use `$this->clientService->deleteClient($clientId)`.
8. **Refactor `searchClients()`** — use `$this->clientService->searchClients($search, $limit)`.
9. **Refactor `getBranchClients()`** — use `$this->clientService->getBranchClients($clientId)`.
10. **Refactor `exportClients()`** — use `$this->clientService->exportClientsAsCsv()` for data, keep HTTP headers/CSV output in handler.
11. **Refactor `getLocations()`** — use `$this->clientService->getLocationHierarchy()`.
12. **Keep `checkLocationDuplicates()`** as-is (uses LocationsModel directly, minor).

13. **Remove `sanitizeClientFormData()`** (~50 lines of duplicate code — now in service).

**CRITICAL: Backward compatibility** — ALL AJAX action names must remain unchanged:
- `wecoza_save_client`, `wecoza_get_client`, `wecoza_get_client_details`
- `wecoza_delete_client`, `wecoza_search_clients`, `wecoza_get_branch_clients`
- `wecoza_export_clients`, `wecoza_get_locations`, `wecoza_check_location_duplicates`

Response formats must be identical.

**Target: No method exceeds 100 lines.** The `saveClient()` handler drops from ~120 to ~20 lines.
  </action>
  <verify>
Run `php -l src/Clients/Controllers/ClientsController.php` and `php -l src/Clients/Ajax/ClientAjaxHandlers.php` — both pass.
Grep ClientsController for `ClientService` — found.
Grep ClientsController for `handleFormSubmission` — NOT found (moved to service).
Grep ClientsController for `sanitizeFormData` — NOT found (moved to service).
Grep ClientAjaxHandlers for `ClientService` — found.
Grep ClientAjaxHandlers for `sanitizeClientFormData` — NOT found (moved to service).
Grep ClientAjaxHandlers for `ClientRepository` — NOT found (service owns it).
Count lines of saveClient() in handlers — under 25 lines.
All 9 AJAX action names still registered.
  </verify>
  <done>
ClientsController and ClientAjaxHandlers delegate all business logic to ClientService. The ~160-line handleFormSubmission and ~120-line saveClient consolidated into one ~100-line ClientService::handleClientSubmission(). Data sanitization deduplicated. No method exceeds 100 lines. All 9 AJAX endpoints unchanged.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Clients/Services/ClientService.php` — syntax OK
2. `php -l src/Clients/Controllers/ClientsController.php` — syntax OK
3. `php -l src/Clients/Ajax/ClientAjaxHandlers.php` — syntax OK
4. Grep for `class ClientService` — exists
5. Grep ClientsController for `handleFormSubmission\|sanitizeFormData\|filterClientDataForForm` — NOT found (all in service)
6. Grep ClientAjaxHandlers for `sanitizeClientFormData\|ClientRepository\|LocationRepository` — NOT found (all in service)
7. All 9 AJAX action names still registered
8. No method exceeds 100 lines in controller or handlers
</verification>

<success_criteria>
- ClientService.php exists with handleClientSubmission() as unified form submission method
- ~280 lines of duplicate code eliminated (handleFormSubmission + saveClient + two sanitize methods)
- ClientsController captureClientShortcode under 40 lines (was ~110)
- ClientsController updateClientShortcode under 45 lines (was ~120)
- ClientAjaxHandlers saveClient under 25 lines (was ~120)
- All 9 AJAX endpoints return identical response formats
- No method exceeds 100 lines
</success_criteria>

<output>
After completion, create `.planning/phases/36-service-layer-extraction/36-03-SUMMARY.md`
</output>
