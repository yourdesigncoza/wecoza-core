---
phase: 39-repository-pattern-enforcement
plan: 02
type: execute
wave: 2
depends_on: [39-01]
files_modified:
  - src/Agents/Repositories/AgentRepository.php
  - src/Classes/Repositories/ClassRepository.php
  - src/Events/Repositories/ClassEventRepository.php
  - src/Learners/Repositories/LearnerProgressionRepository.php
  - src/Events/Repositories/ClassTaskRepository.php
  - src/Events/Repositories/MaterialTrackingRepository.php
  - src/Clients/Repositories/LocationRepository.php
autonomous: true

must_haves:
  truths:
    - "AgentRepository CRUD methods delegate to BaseRepository parent methods"
    - "ClassRepository insert/update/delete delegate to parent methods"
    - "ClassEventRepository simple lookups use findBy"
    - "Dynamic column names (from variables/user input) use quoteIdentifier(); hardcoded string literals documented as safe"
    - "All remaining manual SQL has justified bypass comments (// Complex query:)"
  artifacts:
    - path: "src/Agents/Repositories/AgentRepository.php"
      provides: "Refactored agent CRUD using parent methods"
      contains: "parent::insert"
    - path: "src/Classes/Repositories/ClassRepository.php"
      provides: "Refactored class CRUD using parent methods"
      contains: "parent::insert"
    - path: "src/Events/Repositories/ClassEventRepository.php"
      provides: "Refactored event lookups using findBy"
      contains: "findBy"
  key_links:
    - from: "src/Agents/Repositories/AgentRepository.php"
      to: "core/Abstract/BaseRepository.php"
      via: "parent::insert, parent::update, parent::delete calls"
      pattern: "parent::(insert|update|delete)"
    - from: "src/Classes/Repositories/ClassRepository.php"
      to: "core/Abstract/BaseRepository.php"
      via: "parent::insert, parent::update, parent::delete calls"
      pattern: "parent::(insert|update|delete)"
---

<objective>
Refactor AgentRepository, ClassRepository, and ClassEventRepository to use BaseRepository methods. Add quoteIdentifier() and justified bypass comments across all remaining repositories.

Purpose: REPO-03 (AgentRepository), REPO-05 (quoteIdentifier), REPO-06 (justified bypass documentation) -- complete the repository pattern enforcement.

Output: Refactored repositories with parent method delegation, quoteIdentifier usage, and justified bypass documentation.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/39-repository-pattern-enforcement/39-01-SUMMARY.md
@core/Abstract/BaseRepository.php
@src/Agents/Repositories/AgentRepository.php
@src/Classes/Repositories/ClassRepository.php
@src/Events/Repositories/ClassEventRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor AgentRepository and ClassEventRepository to use BaseRepository methods</name>
  <files>src/Agents/Repositories/AgentRepository.php, src/Events/Repositories/ClassEventRepository.php</files>
  <action>
**AgentRepository refactoring:**

1. `createAgent()` -- Currently uses `wecoza_db()->insert('agents', $cleanData)`.
   - Refactor to use `parent::insert($cleanData)` which handles column whitelisting via getAllowedInsertColumns().
   - The sanitization step (`sanitizeAgentData`) stays.
   - Timestamps stay.
   - Return type: parent::insert returns `?int`. The current method returns `int|false`. Adjust to match by converting: `$result = parent::insert($cleanData); return $result ?? false;`
   - Actually, keep the existing return type signature for backward compatibility. Convert null to false.

2. `updateAgent()` -- Currently uses `wecoza_db()->update('agents', $cleanData, 'agent_id = :agent_id', ...)`.
   - Refactor to use `parent::update($agentId, $cleanData)` which handles column whitelisting via getAllowedUpdateColumns().
   - Keep sanitization.
   - parent::update() takes (int $id, array $data) and uses static::$primaryKey internally.
   - The method signature stays: `public function updateAgent(int $agentId, array $data): bool`

3. `deleteAgent()` -- Currently calls `$this->updateAgent($agentId, ['status' => 'deleted'])`.
   - This is already a soft-delete pattern. It correctly delegates to updateAgent. Keep as-is.
   - However, updateAgent now uses parent::update, so this chain works.

4. `deleteAgentPermanently()` -- Currently uses `wecoza_db()->delete('agents', 'agent_id = :agent_id', ...)`.
   - Refactor to use `parent::delete($agentId)` after deleting related data.

5. Add `// Complex query:` comments to all justified methods:
   - `getAgent()` -- `// Complex query: LEFT JOIN to locations table for dual-read address resolution`
   - `getAgentByEmail()` -- `// Complex query: LEFT JOIN to locations table for dual-read address resolution`
   - `getAgentByIdNumber()` -- `// Complex query: LEFT JOIN to locations table for dual-read address resolution`
   - `getAgents()` -- `// Complex query: LEFT JOIN + LIKE search + status filter + pagination`
   - `countAgents()` -- `// Complex query: COUNT with LIKE search + status filter`
   - `addAgentMeta()` -- `// Complex query: operates on agent_meta table (not $table)`
   - `getAgentMeta()` -- `// Complex query: operates on agent_meta table (not $table)`
   - `updateAgentMeta()` -- `// Complex query: operates on agent_meta table (not $table)`
   - `deleteAgentMeta()` -- `// Complex query: operates on agent_meta table (not $table)`
   - `addAgentNote()` -- `// Complex query: operates on agent_notes table (not $table)`
   - `getAgentNotes()` -- `// Complex query: operates on agent_notes table (not $table)`
   - `deleteAgentNotes()` -- `// Complex query: operates on agent_notes table (not $table)`
   - `addAgentAbsence()` -- `// Complex query: operates on agent_absences table (not $table)`
   - `getAgentAbsences()` -- `// Complex query: operates on agent_absences table with date range filter`
   - `deleteAgentAbsences()` -- `// Complex query: operates on agent_absences table (not $table)`

6. **quoteIdentifier for dynamic column names (REPO-05):** AgentRepository has 3 methods where ORDER BY column comes from a variable:
   - `getAgents()` -- the `$orderby` variable in ORDER BY clause. Wrap: `$this->quoteIdentifier($orderby)`
   - `getAgentNotes()` -- `$args['orderby']` in ORDER BY. Validate against allowlist first, then wrap: `$this->quoteIdentifier($args['orderby'])`
   - `getAgentAbsences()` -- `$args['orderby']` in ORDER BY. Validate against allowlist first, then wrap: `$this->quoteIdentifier($args['orderby'])`
   - All other AgentRepository column names are hardcoded literals (safe). No quoting needed for those.

**ClassEventRepository refactoring:**

1. `findPendingForProcessing()` -- Currently manual SQL with `WHERE notification_status = 'pending' ORDER BY created_at ASC LIMIT :limit`.
   - Replace with: `return array_map(fn($row) => ClassEventDTO::fromRow($row), $this->findBy(['notification_status' => 'pending'], $limit, 0, 'created_at', 'ASC'));`
   - 'notification_status' is already in getAllowedFilterColumns().

2. `findByEntity()` -- Currently manual SQL with entity_type + entity_id criteria.
   - Replace with: `return array_map(fn($row) => ClassEventDTO::fromRow($row), $this->findBy(['entity_type' => $entityType, 'entity_id' => $entityId], $limit, 0, 'created_at', 'DESC'));`
   - Both columns are in getAllowedFilterColumns().

3. Add `// Complex query:` comments to justified methods:
   - `updateAiSummary()` -- `// Complex query: json_encode + CURRENT_TIMESTAMP in single UPDATE`
   - `markSent()` -- `// Complex query: SET multiple columns with CURRENT_TIMESTAMP`
   - `markViewed()` -- `// Complex query: conditional UPDATE with IS NULL check`
   - `markAcknowledged()` -- `// Complex query: conditional UPDATE with IS NULL check`
   - `getTimeline()` -- `// Complex query: cursor-based pagination with optional WHERE`
   - `getUnreadCount()` -- `// Complex query: COUNT with IS NULL condition (not supported by parent::count criteria)`

**Important:** All public method signatures must remain identical. Only internal implementations change. Run `php -l` on both files.
  </action>
  <verify>
Run `php -l src/Agents/Repositories/AgentRepository.php` and `php -l src/Events/Repositories/ClassEventRepository.php` -- both pass. grep for `parent::insert` in AgentRepository. grep for `parent::update` in AgentRepository. grep for `parent::delete` in AgentRepository. grep for `$this->findBy` in ClassEventRepository. grep for `quoteIdentifier` in AgentRepository -- should show 3 occurrences (getAgents, getAgentNotes, getAgentAbsences ORDER BY).
  </verify>
  <done>
AgentRepository::createAgent() uses parent::insert(). AgentRepository::updateAgent() uses parent::update(). AgentRepository::deleteAgentPermanently() uses parent::delete(). AgentRepository dynamic ORDER BY columns use quoteIdentifier(). ClassEventRepository::findPendingForProcessing() and findByEntity() use $this->findBy(). All justified methods have bypass comments. Both files pass syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2a: Refactor ClassRepository CRUD to use BaseRepository parent methods</name>
  <files>src/Classes/Repositories/ClassRepository.php</files>
  <action>
**ClassRepository CRUD refactoring:**

1. `insertClass()` -- Currently builds manual INSERT SQL.
   - Refactor to use `parent::insert($filteredData)`. The parent already handles column filtering via getAllowedInsertColumns(), so remove the manual filterAllowedColumns call at the top (parent does it).
   - The existing code calls `$this->filterAllowedColumns()` then builds SQL. parent::insert() also calls filterAllowedColumns internally. So just call `return parent::insert($data);`
   - parent::insert returns `?int` and insertClass returns `?int` -- types match.

2. `updateClass()` -- Currently builds manual UPDATE SQL.
   - Refactor to use `parent::update($id, $data)`. Parent handles column filtering.
   - Return type: parent returns bool, updateClass returns bool -- matches.

3. `deleteClass()` -- Currently builds manual DELETE with `?` placeholder.
   - Refactor to use `parent::delete($id)`.

4. Remove the duplicate `filterAllowedColumns()` override in ClassRepository -- BaseRepository already has this exact method. The ClassRepository override is identical to the parent. Delete it.

5. Add `// Complex query:` comments to justified static methods:
   - `getClients()` -- `// Complex query: static context, reads from clients table (not $table)`
   - `getSites()` -- `// Complex query: static context, JOIN sites + locations tables`
   - `getLearners()` -- `// Complex query: static context, dual CTE with 5-table JOIN for progression context`
   - `getAgents()` -- `// Complex query: static context, reads from agents table (not $table)`
   - `getSupervisors()` -- `// Complex query: static context, reads from agents table (not $table)`
   - `getAllClasses()` -- `// Complex query: static context with dynamic ORDER BY + JOIN to clients`
   - `getSingleClass()` -- `// Complex query: delegates to ClassModel::getById then enriches with multiple lookups`
   - `getSiteAddresses()` -- `// Complex query: static context, JOIN sites + locations tables`
   - `getCachedClassNotes()` -- `// Complex query: static context, reads JSONB column from classes table`

Run `php -l` on ClassRepository.php.
  </action>
  <verify>
Run `php -l src/Classes/Repositories/ClassRepository.php` -- must pass. grep for `parent::insert` in ClassRepository. grep for `parent::update` in ClassRepository. grep for `parent::delete` in ClassRepository. grep for "Complex query:" in ClassRepository -- should find comments on all justified methods.
  </verify>
  <done>
ClassRepository CRUD methods (insertClass, updateClass, deleteClass) delegate to parent methods. Duplicate filterAllowedColumns override removed. All justified static methods have `// Complex query:` bypass comments. File passes php -l syntax check.
  </done>
</task>

<task type="auto">
  <name>Task 2b: Add quoteIdentifier policy + bypass comments across remaining repositories</name>
  <files>src/Learners/Repositories/LearnerProgressionRepository.php, src/Events/Repositories/ClassTaskRepository.php, src/Events/Repositories/MaterialTrackingRepository.php, src/Clients/Repositories/LocationRepository.php</files>
  <action>
**quoteIdentifier policy (REPO-05):**

Policy: `quoteIdentifier()` is required where column names come from variables or user input. Hardcoded string literals in SQL are safe and do not need quoting.

For dynamic column names (from variables/user input), apply quoteIdentifier():
- `AgentRepository::getAgents()` -- the `$orderby` variable in ORDER BY clause. Wrap: `$this->quoteIdentifier($orderby)` (done in Task 1 alongside AgentRepository refactoring)
- `AgentRepository::getAgentNotes()` -- `$args['orderby']` in ORDER BY. Validate against allowlist first, then quote. (done in Task 1)
- `AgentRepository::getAgentAbsences()` -- `$args['orderby']` in ORDER BY. Validate then quote. (done in Task 1)

For repositories with only hardcoded column names, add the following documentation comment near the class docblock or before the first query method:
```php
// quoteIdentifier: all column names in this repository are hardcoded literals (safe)
```

Repositories needing this safe-audit comment:
- LearnerProgressionRepository (all column names hardcoded)
- ClassTaskRepository (all column names hardcoded)
- MaterialTrackingRepository (all column names hardcoded)
- LocationRepository (all column names hardcoded)

**Justified bypass comments for remaining repositories:**

LearnerProgressionRepository -- add `// Complex query:` comments:
- `baseQuery()` -- `// Complex query: 4-table JOIN for full progression context`
- `findCurrentForLearner()` -- `// Complex query: base query + status filter (uses baseQuery JOINs)`
- `findAllForLearner()` -- `// Complex query: base query + learner filter (uses baseQuery JOINs)`
- `findHistoryForLearner()` -- `// Complex query: base query + completed status filter (uses baseQuery JOINs)`
- `findByClass()` -- `// Complex query: base query + class filter with optional status (uses baseQuery JOINs)`
- `findByProduct()` -- `// Complex query: base query + product filter with optional status (uses baseQuery JOINs)`
- `insert()` -- `// Complex query: custom column whitelist with transaction and cache clear`
- `update()` -- `// Complex query: custom column whitelist with cache clear`
- `delete()` -- `// Complex query: manual DELETE with cache clear (could use parent but needs cache clear)`
- `logHours()` -- `// Complex query: operates on learner_hours_log table (not $table)`
- `getHoursLog()` -- `// Complex query: reads from learner_hours_log table (not $table)`
- `getHoursLogForLearner()` -- `// Complex query: JOIN learner_hours_log + products with date range filter`
- `getMonthlyProgressions()` -- `// Complex query: 5-table JOIN with date range for monthly report`
- `findWithFilters()` -- `// Complex query: dynamic JOIN + multi-criteria filter with pagination`
- `countWithFilters()` -- `// Complex query: dynamic JOIN + multi-criteria COUNT`
- `savePortfolioFile()` -- `// Complex query: operates on learner_progression_portfolios table (not $table)`
- `getPortfolioFiles()` -- `// Complex query: reads from learner_progression_portfolios table (not $table)`

ClassTaskRepository -- add comments:
- `fetchClasses()` -- `// Complex query: 4-table JOIN with dynamic WHERE and ORDER BY`

MaterialTrackingRepository -- add comments:
- `markNotificationSent()` -- `// Complex query: UPSERT (ON CONFLICT DO UPDATE) not supported by BaseRepository`
- `markDelivered()` -- `// Complex query: nested jsonb_set operations on classes table`
- `wasNotificationSent()` -- `// Complex query: EXISTS-style check on specific columns`
- `getDeliveryStatus()` -- `// Complex query: pivots notification_type rows into status object`
- `getTrackingRecords()` -- `// Complex query: column-specific SELECT with ORDER BY notification_type`
- `getTrackingDashboardData()` -- `// Complex query: CROSS JOIN LATERAL with JSONB array elements + multi-table JOIN`
- `getTrackingStatistics()` -- `// Complex query: CROSS JOIN LATERAL with JSONB + conditional aggregation`

LocationRepository -- add comments:
- `findByCoordinates()` -- `// Complex query: Haversine formula distance calculation`
- `checkDuplicates()` -- `// Complex query: LOWER() case-insensitive matching with optional exclude`

Run `php -l` on ALL 4 modified files.
  </action>
  <verify>
Run `php -l` on all modified files: LearnerProgressionRepository.php, ClassTaskRepository.php, MaterialTrackingRepository.php, LocationRepository.php. All must pass. grep for "Complex query:" across all 4 files -- should find comments in every file. grep for "quoteIdentifier: all column names" across all 4 files -- should find the safe-audit comment.
  </verify>
  <done>
All 4 repositories have justified bypass comments on every manual SQL query. Each has the `// quoteIdentifier: all column names in this repository are hardcoded literals (safe)` audit comment. All files pass php -l syntax check.
  </done>
</task>

</tasks>

<verification>
1. `php -l` passes on ALL modified repository files (7 files)
2. AgentRepository: grep shows parent::insert, parent::update, parent::delete usage
3. ClassRepository: grep shows parent::insert, parent::update, parent::delete usage
4. ClassEventRepository: grep shows $this->findBy usage in findPendingForProcessing and findByEntity
5. grep -r "Complex query:" across all src/**/Repositories/*.php shows comments in every repository
6. grep -r "quoteIdentifier" in AgentRepository shows dynamic ORDER BY columns quoted
7. grep -r "quoteIdentifier: all column names" shows safe-audit comments in repositories with only hardcoded columns
8. No public method signatures changed (backward compatible)
9. Combined with Plan 01: 80%+ of simple queries now use BaseRepository methods
</verification>

<success_criteria>
1. AgentRepository createAgent/updateAgent/deleteAgentPermanently use parent methods
2. ClassRepository insertClass/updateClass/deleteClass use parent methods
3. ClassEventRepository findPendingForProcessing/findByEntity use findBy
4. Every justified manual SQL query has a `// Complex query:` comment
5. quoteIdentifier() used where column names come from variables/user input (AgentRepository ORDER BY)
6. Repositories with only hardcoded column names have `// quoteIdentifier: all column names ... are hardcoded literals (safe)` comment
7. All modified files pass php -l
8. No breaking changes to public APIs
</success_criteria>

<output>
After completion, create `.planning/phases/39-repository-pattern-enforcement/39-02-SUMMARY.md`
</output>
