---
phase: 42-lookup-table-crud-infrastructure-qualifications-shortcode
plan: 02
type: execute
wave: 2
depends_on: ["42-01"]
files_modified:
  - views/lookup-tables/manage.view.php
  - assets/js/lookup-tables/lookup-table-manager.js
autonomous: false
requirements: []

must_haves:
  truths:
    - "Admin can see all existing qualifications in a Phoenix-styled table"
    - "Admin can add a new qualification via inline form row and it appears in the table without page reload"
    - "Admin can edit an existing qualification inline and save changes via AJAX"
    - "Admin can delete a qualification with confirmation dialog"
    - "Success/error feedback shows via Phoenix alert pattern after each operation"
    - "Non-admin users see a permission denied message"
  artifacts:
    - path: "views/lookup-tables/manage.view.php"
      provides: "Phoenix-styled CRUD table template"
      contains: "table-sm"
    - path: "assets/js/lookup-tables/lookup-table-manager.js"
      provides: "AJAX CRUD operations + inline editing + delete confirm"
      contains: "WeCozaLookupTables"
  key_links:
    - from: "assets/js/lookup-tables/lookup-table-manager.js"
      to: "wp_ajax_wecoza_lookup_table"
      via: "jQuery.ajax POST to WeCozaLookupTables.ajax_url"
      pattern: "wecoza_lookup_table"
    - from: "views/lookup-tables/manage.view.php"
      to: "assets/js/lookup-tables/lookup-table-manager.js"
      via: "data attributes on table element consumed by JS"
      pattern: "data-table-key"
    - from: "src/LookupTables/Controllers/LookupTableController.php"
      to: "views/lookup-tables/manage.view.php"
      via: "wecoza_view('lookup-tables/manage', ...)"
      pattern: "lookup-tables/manage"
---

<objective>
Build the frontend view template and JavaScript for the Lookup Table Manager. Phoenix-styled table with inline add/edit, delete confirmation, and AJAX-driven CRUD operations.

Purpose: Give admins a clean UI to manage reference data (qualifications, placement levels) without raw SQL.

Output: 1 PHP view template + 1 JS file providing complete inline CRUD experience.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/42-lookup-table-crud-infrastructure-qualifications-shortcode/CONTEXT.md
@.planning/phases/42-lookup-table-crud-infrastructure-qualifications-shortcode/42-01-SUMMARY.md
@core/Abstract/BaseController.php
@src/Agents/Controllers/AgentsController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manage.view.php template and lookup-table-manager.js</name>
  <files>
    views/lookup-tables/manage.view.php
    assets/js/lookup-tables/lookup-table-manager.js
  </files>
  <action>
**manage.view.php** (`views/lookup-tables/manage.view.php`):

Receives from controller: `$tableKey`, `$config`, `$nonce`

Structure (Phoenix patterns from `/home/laudes/zoot/projects/phoenix/phoenix-extracted`):

```
<div class="card mb-3" id="lookup-table-<?= esc_attr($tableKey) ?>">
  <!-- Card header with title -->
  <div class="card-header border-bottom border-translucent">
    <h5 class="mb-0"><?= esc_html($config['title']) ?></h5>
  </div>

  <!-- Alert container for success/error messages (hidden by default) -->
  <div id="lookup-alert-<?= esc_attr($tableKey) ?>" class="mx-3 mt-3" style="display:none;"></div>

  <div class="card-body p-0">
    <table class="table table-sm fs-9 mb-0"
           data-table-key="<?= esc_attr($tableKey) ?>"
           data-pk="<?= esc_attr($config['pk']) ?>"
           id="lookup-table-body-<?= esc_attr($tableKey) ?>">
      <thead>
        <tr>
          <th class="align-middle ps-3" style="width:50px">#</th>
          <!-- Dynamic column headers from config labels -->
          <?php foreach ($config['labels'] as $label): ?>
            <th class="align-middle"><?= esc_html($label) ?></th>
          <?php endforeach; ?>
          <th class="align-middle text-end pe-3" style="width:120px">Actions</th>
        </tr>
      </thead>
      <tbody id="lookup-rows-<?= esc_attr($tableKey) ?>">
        <!-- Inline "Add New" row -->
        <tr class="lookup-add-row" id="lookup-add-row-<?= esc_attr($tableKey) ?>">
          <td class="align-middle ps-3">
            <span class="badge badge-phoenix badge-phoenix-success fs-10">New</span>
          </td>
          <?php foreach ($config['columns'] as $col): ?>
            <td class="align-middle">
              <input type="text"
                     class="form-control form-control-sm lookup-add-input"
                     data-column="<?= esc_attr($col) ?>"
                     placeholder="Enter <?= esc_attr($col) ?>">
            </td>
          <?php endforeach; ?>
          <td class="align-middle text-end pe-3">
            <button type="button" class="btn btn-sm btn-phoenix-success lookup-btn-add"
                    data-table-key="<?= esc_attr($tableKey) ?>"
                    title="Add">
              <span class="fas fa-plus"></span> Add
            </button>
          </td>
        </tr>
        <!-- Data rows populated by JS on load -->
      </tbody>
    </table>
  </div>

  <!-- Loading spinner (shown during AJAX calls) -->
  <div id="lookup-loading-<?= esc_attr($tableKey) ?>" class="text-center py-3" style="display:none;">
    <div class="spinner-border spinner-border-sm text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<!-- Hidden config for JS (nonce passed from controller, columns as JSON) -->
<script type="application/json" id="lookup-config-<?= esc_attr($tableKey) ?>">
<?= wp_json_encode([
    'tableKey' => $tableKey,
    'pk'       => $config['pk'],
    'columns'  => $config['columns'],
    'labels'   => $config['labels'],
]) ?>
</script>
```

All output properly escaped with `esc_html()`, `esc_attr()`, `wp_json_encode()`.

**lookup-table-manager.js** (`assets/js/lookup-tables/lookup-table-manager.js`):

jQuery-based, IIFE pattern `(function($) { ... })(jQuery)`, wrapped in `$(document).ready()`.

Key behaviors:

1. **Initialization**: Find all `[data-table-key]` tables on page. For each, read config from `#lookup-config-{key}` JSON script tag. Call `loadRows(tableKey)`.

2. **loadRows(tableKey)**: AJAX POST to `WeCozaLookupTables.ajax_url` with:
   - `action: 'wecoza_lookup_table'`
   - `sub_action: 'list'`
   - `table_key: tableKey`
   - `nonce: WeCozaLookupTables.nonce`
   Show loading spinner during request. On success, render rows. On error, show alert.

3. **renderRows(tableKey, items, config)**: Clear existing data rows (not the add row). For each item, create a `<tr>` with:
   - Row number `<td>`
   - Each column value in a `<td>` with `data-column` and `data-id` attributes, text content escaped
   - Actions `<td>` with edit (pencil) and delete (trash) buttons:
     ```html
     <button class="btn btn-sm btn-phoenix-primary lookup-btn-edit" data-id="{pk_value}" data-table-key="{tableKey}" title="Edit">
       <span class="fas fa-pencil-alt"></span>
     </button>
     <button class="btn btn-sm btn-phoenix-danger lookup-btn-delete ms-1" data-id="{pk_value}" data-table-key="{tableKey}" title="Delete">
       <span class="fas fa-trash-alt"></span>
     </button>
     ```

4. **Add handler** (delegated click on `.lookup-btn-add`):
   - Read values from `.lookup-add-input` inputs in the add row
   - Validate at least one non-empty value exists (skip if all blank)
   - POST `sub_action: 'create'` with column values
   - On success: clear inputs, reload rows, show success alert
   - On error: show error alert

5. **Edit handler** (delegated click on `.lookup-btn-edit`):
   - Find the row, replace each column `<td>` text with `<input>` pre-filled with current value
   - Change edit button to save button (checkmark icon, `.lookup-btn-save` class)
   - Change delete button to cancel button (times icon, `.lookup-btn-cancel` class)

6. **Save handler** (delegated click on `.lookup-btn-save`):
   - Read input values from the editing row
   - POST `sub_action: 'update'` with `id` and column values
   - On success: reload rows, show success alert
   - On error: show error alert, keep editing state

7. **Cancel handler** (delegated click on `.lookup-btn-cancel`):
   - Reload rows to restore original state

8. **Delete handler** (delegated click on `.lookup-btn-delete`):
   - Show `confirm('Are you sure you want to delete this item?')` dialog
   - If confirmed, POST `sub_action: 'delete'` with `id`
   - On success: reload rows, show success alert
   - On error: show error alert

9. **showAlert(tableKey, type, message)**: Helper to show Phoenix-styled alert in `#lookup-alert-{tableKey}`:
   ```html
   <div class="alert alert-subtle-{type} alert-dismissible fade show" role="alert">
     {message}
     <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
   </div>
   ```
   Where type = 'success' or 'danger'. Auto-dismiss after 5 seconds.

10. **showLoading(tableKey, show)**: Toggle spinner visibility.

All event handlers use event delegation on `document` to handle dynamically created elements.

AJAX error handling: if `response.success === false`, extract message from `response.data.message`. If network error, show generic "An error occurred" message.
  </action>
  <verify>
    - File exists: `views/lookup-tables/manage.view.php`
    - File exists: `assets/js/lookup-tables/lookup-table-manager.js`
    - PHP lint: `php -l views/lookup-tables/manage.view.php` passes
    - JS has no obvious syntax errors (check for balanced braces, no trailing commas in objects)
    - grep confirms: `data-table-key`, `WeCozaLookupTables`, `wecoza_lookup_table`, `sub_action`, `lookup-btn-add`, `lookup-btn-edit`, `lookup-btn-delete`, `showAlert`
  </verify>
  <done>
    View renders Phoenix-styled table with inline add row, dynamic column headers from config, and data rows populated by JS. JavaScript handles full CRUD lifecycle via AJAX with inline editing, delete confirmation, and alert feedback.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Lookup Table CRUD in browser</name>
  <action>
    Built: Complete Lookup Table Manager with inline CRUD for qualifications table. Phoenix-styled table with add/edit/delete functionality via AJAX.

    Verify steps:
    1. Navigate to the WordPress page containing [wecoza_manage_qualifications] shortcode
    2. Verify the card renders with title "Manage Qualifications"
    3. Verify existing qualifications load into the table
    4. Test ADD: Type a new qualification in the "Add" row input, click the green "Add" button. Verify it appears in the table and a success alert shows
    5. Test EDIT: Click the pencil icon on any row. Verify the cell becomes an input. Change the value and click the checkmark. Verify the update persists
    6. Test DELETE: Click the trash icon on any row. Confirm the dialog. Verify the row is removed and a success alert shows
    7. Test CANCEL: Click edit, then click the X (cancel). Verify the row reverts to display mode
    8. Verify non-admin users see a permission error (if testable)
  </action>
  <verify>Type "approved" if all CRUD operations work correctly, or describe any issues</verify>
  <done>All CRUD operations (add, edit, delete, cancel) work correctly in browser with proper feedback and Phoenix styling</done>
</task>

</tasks>

<verification>
1. All files from Plan 01 and Plan 02 exist and pass lint
2. Shortcode renders a table with data from learner_qualifications
3. Add/Edit/Delete operations work via AJAX
4. Security: nonce + capability enforced
5. Phoenix styling applied (table-sm, badge-phoenix, btn-phoenix-* classes)
6. Error states handled (network errors, validation failures)
</verification>

<success_criteria>
- Admin user can perform full CRUD on qualifications via inline table UI
- No page reloads needed for any operation
- Phoenix theme styling consistent with rest of application
- Delete has confirmation dialog
- Success/error feedback visible after each operation
- Non-admin users blocked from access
</success_criteria>

<output>
After completion, create `.planning/phases/42-lookup-table-crud-infrastructure-qualifications-shortcode/42-02-SUMMARY.md`
</output>
