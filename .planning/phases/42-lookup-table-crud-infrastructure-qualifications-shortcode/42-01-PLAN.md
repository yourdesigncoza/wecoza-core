---
phase: 42-lookup-table-crud-infrastructure-qualifications-shortcode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wecoza-core.php
  - src/LookupTables/Repositories/LookupTableRepository.php
  - src/LookupTables/Ajax/LookupTableAjaxHandler.php
  - src/LookupTables/Controllers/LookupTableController.php
autonomous: true
requirements: []

must_haves:
  truths:
    - "LookupTableRepository can CRUD any configured lookup table via config-driven table/pk/columns"
    - "AJAX handler validates nonce + manage_options capability before any write operation"
    - "Shortcode [wecoza_manage_qualifications] is registered and renders view output"
    - "Autoloader resolves WeCoza\\LookupTables\\ namespace to src/LookupTables/"
  artifacts:
    - path: "src/LookupTables/Repositories/LookupTableRepository.php"
      provides: "Config-driven generic CRUD repository"
      contains: "class LookupTableRepository"
    - path: "src/LookupTables/Ajax/LookupTableAjaxHandler.php"
      provides: "Single AJAX endpoint for all lookup table operations"
      contains: "class LookupTableAjaxHandler"
    - path: "src/LookupTables/Controllers/LookupTableController.php"
      provides: "Shortcode registration + asset enqueuing + table config"
      contains: "class LookupTableController"
  key_links:
    - from: "wecoza-core.php"
      to: "src/LookupTables/Controllers/LookupTableController.php"
      via: "new \\WeCoza\\LookupTables\\Controllers\\LookupTableController()"
      pattern: "LookupTableController"
    - from: "wecoza-core.php"
      to: "src/LookupTables/Ajax/LookupTableAjaxHandler.php"
      via: "new \\WeCoza\\LookupTables\\Ajax\\LookupTableAjaxHandler()"
      pattern: "LookupTableAjaxHandler"
    - from: "src/LookupTables/Ajax/LookupTableAjaxHandler.php"
      to: "src/LookupTables/Repositories/LookupTableRepository.php"
      via: "constructor injection or instantiation"
      pattern: "LookupTableRepository"
---

<objective>
Build the complete backend infrastructure for the generic Lookup Table Manager: a config-driven repository, AJAX handler, and controller with shortcode registration.

Purpose: Enable admin CRUD on simple reference tables (learner_qualifications, learner_placement_level) via a single reusable module, avoiding per-table duplication.

Output: 3 new PHP classes + wecoza-core.php registration. Frontend view/JS in Plan 02.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-lookup-table-crud-infrastructure-qualifications-shortcode/CONTEXT.md
@core/Abstract/BaseRepository.php
@core/Abstract/BaseController.php
@core/Helpers/AjaxSecurity.php
@src/Agents/Ajax/AgentsAjaxHandlers.php
@src/Agents/Controllers/AgentsController.php
@wecoza-core.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LookupTableRepository + LookupTableAjaxHandler</name>
  <files>
    src/LookupTables/Repositories/LookupTableRepository.php
    src/LookupTables/Ajax/LookupTableAjaxHandler.php
  </files>
  <action>
**LookupTableRepository** (`src/LookupTables/Repositories/LookupTableRepository.php`):
- Namespace: `WeCoza\LookupTables\Repositories`
- Do NOT extend BaseRepository (BaseRepository uses static $table, but this repo needs runtime table config)
- Instead, inject PostgresConnection directly (same pattern: `PostgresConnection::getInstance()`)
- Constructor takes a config array: `['table' => string, 'pk' => string, 'columns' => string[]]`
- Methods:
  - `findAll(): array` — SELECT * FROM {table} ORDER BY {pk} ASC, returns PDO::FETCH_ASSOC array
  - `findById(int $id): ?array` — SELECT * FROM {table} WHERE {pk} = :id
  - `insert(array $data): ?int` — INSERT only whitelisted columns (from config `columns`), RETURNING {pk}
  - `update(int $id, array $data): bool` — UPDATE only whitelisted columns WHERE {pk} = :id
  - `delete(int $id): bool` — DELETE FROM {table} WHERE {pk} = :id
- All SQL uses parameterized queries via PDO prepared statements
- Column whitelisting: filter $data keys against config `columns` array before INSERT/UPDATE
- Use `quoteIdentifier()` helper (copy pattern from BaseRepository) for table/column names in SQL
- Wrap each method in try/catch, log errors via `wecoza_log()`, return null/false/[] on failure

**LookupTableAjaxHandler** (`src/LookupTables/Ajax/LookupTableAjaxHandler.php`):
- Namespace: `WeCoza\LookupTables\Ajax`
- Follow AgentsAjaxHandlers pattern: constructor calls `registerHandlers()`
- Single AJAX action: `wp_ajax_wecoza_lookup_table` (no nopriv)
- The handler method `handleRequest()` reads `$_POST['sub_action']` to dispatch: `list`, `create`, `update`, `delete`
- Also reads `$_POST['table_key']` (e.g., 'qualifications') to look up table config
- Table config constant `TABLES` (same as in CONTEXT.md) lives HERE in the handler, not in controller:

```php
private const TABLES = [
    'qualifications' => [
        'table'      => 'learner_qualifications',
        'pk'         => 'id',
        'columns'    => ['qualification'],
        'labels'     => ['Qualification'],
        'title'      => 'Manage Qualifications',
        'capability' => 'manage_options',
    ],
    'placement_levels' => [
        'table'      => 'learner_placement_level',
        'pk'         => 'placement_level_id',
        'columns'    => ['level', 'level_desc'],
        'labels'     => ['Level Code', 'Description'],
        'title'      => 'Manage Placement Levels',
        'capability' => 'manage_options',
    ],
];
```

- Security per sub_action:
  - `list`: `AjaxSecurity::requireNonce('lookup_table_nonce')` only (read operation)
  - `create`, `update`, `delete`: `AjaxSecurity::requireAuth('lookup_table_nonce', $config['capability'])` (nonce + capability)
- Dispatch:
  - `list`: instantiate `LookupTableRepository($config)`, call `findAll()`, return via `AjaxSecurity::sendSuccess(['items' => $items])`
  - `create`: sanitize each column value via `wecoza_sanitize_value($value, 'string')`, call `insert()`, return new ID
  - `update`: require `$_POST['id']` as valid int, sanitize columns, call `update()`, return success bool
  - `delete`: require `$_POST['id']` as valid int, call `delete()`, return success bool
- If `table_key` not found in TABLES, send error "Invalid table." with 400
- If `sub_action` unknown, send error "Invalid action." with 400

Also add a public static method `getTableConfig(string $key): ?array` so the Controller can access config for view rendering.
  </action>
  <verify>
    - Files exist at correct paths
    - `php -l src/LookupTables/Repositories/LookupTableRepository.php` passes (no syntax errors)
    - `php -l src/LookupTables/Ajax/LookupTableAjaxHandler.php` passes
    - grep confirms: `class LookupTableRepository`, `class LookupTableAjaxHandler`, `TABLES` constant, `findAll`, `insert`, `update`, `delete`, `handleRequest`, `requireAuth`
  </verify>
  <done>
    Repository performs config-driven CRUD on any table specified in TABLES. AJAX handler dispatches list/create/update/delete with proper nonce + capability checks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LookupTableController + register in wecoza-core.php</name>
  <files>
    src/LookupTables/Controllers/LookupTableController.php
    wecoza-core.php
  </files>
  <action>
**LookupTableController** (`src/LookupTables/Controllers/LookupTableController.php`):
- Namespace: `WeCoza\LookupTables\Controllers`
- Extends `BaseController`
- `registerHooks()`:
  - `add_action('init', [$this, 'registerShortcodes'])`
  - `add_action('wp_enqueue_scripts', [$this, 'enqueueAssets'])`
- `registerShortcodes()`:
  - `add_shortcode('wecoza_manage_qualifications', [$this, 'renderManageTable'])`
  - NOTE: placement_levels shortcode registered in Phase 43, but wire it now too since the infrastructure supports it:
    `add_shortcode('wecoza_manage_placement_levels', [$this, 'renderManageTable'])`
- `renderManageTable(array|string $atts = [], string $content = '', string $tag = ''): string`:
  - Determine table_key from shortcode tag: map `'wecoza_manage_qualifications' => 'qualifications'`, `'wecoza_manage_placement_levels' => 'placement_levels'`
  - Get config via `LookupTableAjaxHandler::getTableConfig($tableKey)`
  - If null, return error div
  - Check capability: `if (!current_user_can($config['capability']))` return permission error div
  - Return `$this->render('lookup-tables/manage', ['tableKey' => $tableKey, 'config' => $config, 'nonce' => wp_create_nonce('lookup_table_nonce')])`
- `enqueueAssets()`:
  - Only enqueue if current post/page has one of the lookup table shortcodes (use `has_shortcode()` check on both shortcode names)
  - Register + enqueue `wecoza-lookup-table-manager` JS:
    - Handle: `wecoza-lookup-table-manager`
    - Src: `WECOZA_CORE_URL . 'assets/js/lookup-tables/lookup-table-manager.js'`
    - Deps: `['jquery']`
    - Version: `WECOZA_CORE_VERSION`
    - In footer: `true`
  - `wp_localize_script('wecoza-lookup-table-manager', 'WeCozaLookupTables', ['ajax_url' => admin_url('admin-ajax.php'), 'nonce' => wp_create_nonce('lookup_table_nonce')])`

**wecoza-core.php** modifications:
1. Add namespace mapping to autoloader array:
   `'WeCoza\\LookupTables\\' => WECOZA_CORE_PATH . 'src/LookupTables/',`
   Add this after the `'WeCoza\\Dev\\'` line.

2. Add module initialization in the `plugins_loaded` callback, after the Agents Module block and before Dev Toolbar:
```php
// Initialize Lookup Tables Module
if (class_exists(\WeCoza\LookupTables\Controllers\LookupTableController::class)) {
    new \WeCoza\LookupTables\Controllers\LookupTableController();
}
if (class_exists(\WeCoza\LookupTables\Ajax\LookupTableAjaxHandler::class)) {
    new \WeCoza\LookupTables\Ajax\LookupTableAjaxHandler();
}
```
  </action>
  <verify>
    - `php -l src/LookupTables/Controllers/LookupTableController.php` passes
    - `php -l wecoza-core.php` passes
    - grep wecoza-core.php confirms: `LookupTables` in autoloader, `LookupTableController` instantiation, `LookupTableAjaxHandler` instantiation
    - grep Controller confirms: `wecoza_manage_qualifications`, `wecoza_manage_placement_levels`, `enqueueAssets`, `renderManageTable`
  </verify>
  <done>
    Shortcodes registered, autoloader maps namespace, assets enqueued conditionally, controller renders view with config data. Module fully wired into plugin lifecycle.
  </done>
</task>

</tasks>

<verification>
1. `php -l` passes on all 3 new PHP files and wecoza-core.php
2. Autoloader includes `WeCoza\\LookupTables\\` namespace
3. Both shortcodes registered
4. AJAX action `wecoza_lookup_table` registered
5. Table config contains both qualifications and placement_levels entries
6. Security: nonce + capability checks on write operations
</verification>

<success_criteria>
- All 3 new PHP classes created with correct namespaces
- wecoza-core.php has autoloader entry + module initialization
- Repository is config-driven (no hardcoded table names)
- AJAX handler dispatches CRUD operations with security checks
- Controller registers shortcodes and conditionally enqueues assets
- No PHP syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/42-lookup-table-crud-infrastructure-qualifications-shortcode/42-01-SUMMARY.md`
</output>
