---
phase: 02-database-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Services/MaterialNotificationService.php
  - src/Events/Support/FieldMapper.php
  - src/Events/Views/Presenters/ClassTaskPresenter.php
autonomous: true

must_haves:
  truths:
    - "Material notification queries execute without delivery_date column errors"
    - "FieldMapper no longer references non-existent delivery_date column"
    - "ClassTaskPresenter displays classes without relying on delivery_date field"
  artifacts:
    - path: "src/Events/Services/MaterialNotificationService.php"
      provides: "Material notification queries"
      contains: "findClassesByDaysUntilStart"
    - path: "src/Events/Support/FieldMapper.php"
      provides: "Field label mappings"
      contains: "FIELD_MAPPINGS"
    - path: "src/Events/Views/Presenters/ClassTaskPresenter.php"
      provides: "Task presenter display logic"
      contains: "presentItem"
  key_links:
    - from: "src/Events/Services/MaterialNotificationService.php"
      to: "classes table"
      via: "SQL SELECT query"
      pattern: "SELECT.*FROM classes"
---

<objective>
Remove all PHP references to the dropped `delivery_date` column from the Events module.

Purpose: The `delivery_date` column was removed from the `classes` table, but PHP code still references it. This causes SQL errors when the code executes. Must clean up before trigger migration to ensure consistent schema usage.

Output: Three PHP files updated with delivery_date references removed. All Events module code executes without "column delivery_date does not exist" errors.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-database-migration/02-RESEARCH.md

# Files to modify
@src/Events/Services/MaterialNotificationService.php
@src/Events/Support/FieldMapper.php
@src/Events/Views/Presenters/ClassTaskPresenter.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove delivery_date from MaterialNotificationService SQL query</name>
  <files>src/Events/Services/MaterialNotificationService.php</files>
  <action>
Update the `findClassesByDaysUntilStart()` method (around line 63-94):

1. Remove `c.delivery_date,` from the SELECT clause (line 71)
2. Update `buildEmailBody()` method to not use delivery_date:
   - Line 189-190 references `$class['delivery_date']` - remove this
   - The email body should use `original_start_date` instead for any date display

The query should select from classes without delivery_date since that column no longer exists.

WHY: The delivery_date column was dropped from the classes table. Any SQL referencing it will fail with "column does not exist" error.
  </action>
  <verify>
Run: `grep -n "delivery_date" src/Events/Services/MaterialNotificationService.php`
Expected: No matches (0 lines returned)
  </verify>
  <done>MaterialNotificationService SQL queries and methods no longer reference delivery_date column</done>
</task>

<task type="auto">
  <name>Task 2: Remove delivery_date from FieldMapper and ClassTaskPresenter</name>
  <files>
src/Events/Support/FieldMapper.php
src/Events/Views/Presenters/ClassTaskPresenter.php
  </files>
  <action>
**FieldMapper.php** (line 30):
Remove the mapping entry:
```php
'delivery_date' => 'Delivery Date',
```
from the FIELD_MAPPINGS constant array.

**ClassTaskPresenter.php** (around line 100):
The line `$dueDate = $this->formatDueDate((string) ($row['delivery_date'] ?? ''), $startDate);` references delivery_date.

Update to use only `original_start_date` for due date calculation, or remove due_date display entirely if it's not meaningful without delivery_date.

Option 1 (preferred): Change to use original_start_date as fallback:
```php
$dueDate = $this->formatDueDate((string) ($row['original_start_date'] ?? ''), $startDate);
```

Option 2: Remove due_date from display entirely by setting to empty or N/A.

WHY: delivery_date column no longer exists in database. PHP code accessing it will get null/empty values, leading to incorrect display or errors.
  </action>
  <verify>
Run: `grep -rn "delivery_date" src/Events/Support/ src/Events/Views/`
Expected: No matches (0 lines returned)
  </verify>
  <done>FieldMapper and ClassTaskPresenter no longer reference delivery_date column</done>
</task>

<task type="auto">
  <name>Task 3: Verify no remaining delivery_date references in Events module</name>
  <files>src/Events/</files>
  <action>
Perform comprehensive search across entire Events module:

1. Search for any remaining delivery_date references:
   `grep -rn "delivery_date" src/Events/`

2. If any found, update those files to remove references

3. Verify the MaterialNotificationService can be instantiated without errors by checking PHP syntax:
   `php -l src/Events/Services/MaterialNotificationService.php`
   `php -l src/Events/Support/FieldMapper.php`
   `php -l src/Events/Views/Presenters/ClassTaskPresenter.php`

WHY: Ensures complete cleanup - no hidden references that would cause runtime errors.
  </action>
  <verify>
Run all three checks:
1. `grep -rn "delivery_date" src/Events/` - Expected: No matches
2. `php -l src/Events/Services/MaterialNotificationService.php` - Expected: No syntax errors
3. `php -l src/Events/Support/FieldMapper.php` - Expected: No syntax errors
4. `php -l src/Events/Views/Presenters/ClassTaskPresenter.php` - Expected: No syntax errors
  </verify>
  <done>Zero delivery_date references exist in Events module, all PHP files pass syntax check</done>
</task>

</tasks>

<verification>
1. `grep -rn "delivery_date" src/Events/` returns no matches
2. All modified PHP files pass `php -l` syntax check
3. No SQL errors when Events module code references classes table
</verification>

<success_criteria>
- delivery_date removed from MaterialNotificationService SQL query (line 71)
- delivery_date removed from MaterialNotificationService buildEmailBody method (lines 189-190)
- delivery_date mapping removed from FieldMapper FIELD_MAPPINGS constant
- ClassTaskPresenter updated to not rely on delivery_date field
- Zero grep matches for "delivery_date" in src/Events/
- All three modified files pass PHP syntax validation
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-migration/02-01-SUMMARY.md`
</output>
