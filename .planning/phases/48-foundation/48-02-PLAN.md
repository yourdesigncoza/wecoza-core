---
phase: 48-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - schema/class_attendance_sessions.sql
  - src/Learners/Services/ProgressionService.php
  - src/Learners/Models/LearnerProgressionModel.php
autonomous: true
requirements:
  - BACK-01
  - BACK-02
  - BACK-03

must_haves:
  truths:
    - "class_attendance_sessions schema SQL file exists and defines the table with all required columns and constraints"
    - "ProgressionService::logHours() accepts optional session_id and created_by parameters without breaking existing callers"
    - "LearnerProgressionModel::addHours() accepts optional session_id and created_by and passes them through to the repository logHours() call"
  artifacts:
    - path: "schema/class_attendance_sessions.sql"
      provides: "CREATE TABLE statement for class_attendance_sessions with unique constraint on (class_id, session_date)"
      contains: "CREATE TABLE"
    - path: "src/Learners/Services/ProgressionService.php"
      provides: "logHours() with optional session_id and created_by parameters"
      contains: "session_id"
    - path: "src/Learners/Models/LearnerProgressionModel.php"
      provides: "addHours() with optional session_id and created_by, passed to repository"
      contains: "session_id"
  key_links:
    - from: "src/Learners/Services/ProgressionService.php"
      to: "src/Learners/Models/LearnerProgressionModel.php"
      via: "logHours() calls addHours() passing session_id and created_by"
      pattern: "addHours.*session_id.*created_by"
    - from: "src/Learners/Models/LearnerProgressionModel.php"
      to: "src/Learners/Repositories/LearnerProgressionRepository.php"
      via: "addHours() passes session_id and created_by in the logHours data array"
      pattern: "session_id.*=>.*sessionId"
---

<objective>
Create the class_attendance_sessions schema SQL and extend logHours/addHours signatures with session_id and created_by parameters (backward-compatible).

Purpose: Phase 49+ needs a sessions table for tracking attendance session state. The logHours pipeline needs session_id and created_by for audit trail. Both changes must be backward-compatible — existing callers that don't pass the new params continue to work unchanged.

Output: 1 new SQL file, 2 PHP files updated with extended signatures.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@src/Learners/Services/ProgressionService.php
@src/Learners/Models/LearnerProgressionModel.php
@src/Learners/Repositories/LearnerProgressionRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create class_attendance_sessions schema SQL</name>
  <files>
    schema/class_attendance_sessions.sql
  </files>
  <action>
Create `schema/class_attendance_sessions.sql` with a CREATE TABLE statement for the class_attendance_sessions table.

**Important:** This is a SQL file for the user to execute manually — do NOT attempt to run it. The database access is read-only.

Table design decisions (Claude's discretion per CONTEXT.md):

Columns:
- `session_id` SERIAL PRIMARY KEY
- `class_id` INTEGER NOT NULL — FK to classes(class_id)
- `session_date` DATE NOT NULL — the scheduled date of this session
- `status` VARCHAR(30) NOT NULL DEFAULT 'pending' — one of: pending, captured, client_cancelled, agent_absent
- `scheduled_hours` NUMERIC(5,1) NOT NULL — hours from the class schedule for this session
- `notes` TEXT — optional notes (e.g., cancellation reason)
- `captured_by` INTEGER — WP user ID of the person who captured/marked this session (NULL until captured)
- `captured_at` TIMESTAMP — when the session was captured/marked
- `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP

Constraints:
- UNIQUE constraint on (class_id, session_date) — prevents duplicate sessions per SESS-03
- CHECK constraint on status: status IN ('pending', 'captured', 'client_cancelled', 'agent_absent')

Use `created_by` = WP user ID (not agent record ID) for consistency with the learner_hours_log.created_by column and WordPress conventions.

Add a header comment explaining the table purpose and the status values.

Include `IF NOT EXISTS` for idempotent execution.

Add an index on `class_id` for efficient lookups by class (the unique constraint already creates an index on the composite, but a single-column index helps when filtering by class only).
  </action>
  <verify>
    <automated>test -f schema/class_attendance_sessions.sql && grep -c "CREATE TABLE" schema/class_attendance_sessions.sql</automated>
    <manual>Verify the SQL file contains CREATE TABLE IF NOT EXISTS, UNIQUE (class_id, session_date), CHECK on status, all required columns</manual>
  </verify>
  <done>schema/class_attendance_sessions.sql exists with idempotent CREATE TABLE, unique constraint on (class_id, session_date), status CHECK constraint, all columns defined per design.</done>
</task>

<task type="auto">
  <name>Task 2: Extend logHours and addHours signatures with session_id and created_by</name>
  <files>
    src/Learners/Services/ProgressionService.php
    src/Learners/Models/LearnerProgressionModel.php
  </files>
  <action>
**Key context:** The repository layer (`LearnerProgressionRepository::logHours()`) already whitelists `session_id` and `created_by` in its column array and passes them to the INSERT. The `learner_hours_log` table already has these columns. So only the PHP method signatures on the service and model need extending.

In ProgressionService.php, update `logHours()` (line 230):

Current signature:
```php
public function logHours(int $learnerId, float $hoursTrained, float $hoursPresent, string $source = 'manual', ?string $notes = null): bool
```

New signature (add two optional params at the end):
```php
public function logHours(int $learnerId, float $hoursTrained, float $hoursPresent, string $source = 'manual', ?string $notes = null, ?int $sessionId = null, ?int $createdBy = null): bool
```

Update the call to `$progression->addHours()` (line 237) to pass the new params:
```php
return $progression->addHours($hoursTrained, $hoursPresent, $source, $notes, $sessionId, $createdBy);
```

In LearnerProgressionModel.php, update `addHours()` (line 315):

Current signature:
```php
public function addHours(float $trained, float $present, string $source = 'manual', ?string $notes = null): bool
```

New signature:
```php
public function addHours(float $trained, float $present, string $source = 'manual', ?string $notes = null, ?int $sessionId = null, ?int $createdBy = null): bool
```

Update the `self::getRepository()->logHours()` call inside addHours (lines 321-331) to include the new fields in the data array:
```php
self::getRepository()->logHours([
    'learner_id' => $this->learnerId,
    'class_type_subject_id' => $this->classTypeSubjectId,
    'class_id' => $this->classId,
    'tracking_id' => $this->trackingId,
    'log_date' => wp_date('Y-m-d'),
    'hours_trained' => $trained,
    'hours_present' => $present,
    'source' => $source,
    'session_id' => $sessionId,
    'created_by' => $createdBy,
    'notes' => $notes,
]);
```

The repository's column whitelist already includes session_id and created_by, so null values will be filtered out by array_intersect_key and won't be included in the INSERT when not provided. This preserves backward compatibility — existing callers that don't pass session_id/created_by will work exactly as before.
  </action>
  <verify>
    <automated>grep -n "session_id\|created_by" src/Learners/Services/ProgressionService.php src/Learners/Models/LearnerProgressionModel.php | grep -c "sessionId\|session_id\|createdBy\|created_by"</automated>
    <manual>Verify both signatures have ?int $sessionId = null, ?int $createdBy = null at the end. Verify addHours data array includes session_id and created_by keys.</manual>
  </verify>
  <done>ProgressionService::logHours() and LearnerProgressionModel::addHours() both accept optional session_id and created_by. The values flow through to LearnerProgressionRepository::logHours() which already handles them. Existing callers are unaffected.</done>
</task>

</tasks>

<verification>
1. `test -f schema/class_attendance_sessions.sql` — file exists
2. `grep "UNIQUE" schema/class_attendance_sessions.sql` — unique constraint on (class_id, session_date)
3. `grep "sessionId" src/Learners/Services/ProgressionService.php` — parameter present in logHours signature
4. `grep "sessionId" src/Learners/Models/LearnerProgressionModel.php` — parameter present in addHours signature
5. `grep "'session_id'" src/Learners/Models/LearnerProgressionModel.php` — key present in logHours data array
</verification>

<success_criteria>
- BACK-01: ProgressionService::logHours() has optional $sessionId and $createdBy params with null defaults
- BACK-02: LearnerProgressionModel::addHours() has optional $sessionId and $createdBy params, passes them to repository logHours() data array
- BACK-03: schema/class_attendance_sessions.sql contains complete CREATE TABLE with unique (class_id, session_date) constraint, status CHECK, and all required columns
</success_criteria>

<output>
After completion, create `.planning/phases/48-foundation/48-02-SUMMARY.md`
</output>
