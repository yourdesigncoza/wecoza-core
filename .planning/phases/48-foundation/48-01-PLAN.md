---
phase: 48-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Models/LearnerProgressionModel.php
  - src/Learners/Services/ProgressionService.php
  - src/Learners/Repositories/LearnerProgressionRepository.php
  - src/Learners/Repositories/LearnerRepository.php
  - src/Classes/Repositories/ClassRepository.php
  - views/learners/components/learner-progressions.php
  - views/classes/components/single-class/modal-learners.php
  - assets/js/learners/progression-admin.js
autonomous: true
requirements:
  - PROG-01
  - PROG-02
  - PROG-03

must_haves:
  truths:
    - "Progress percentage for an in-progress LP is calculated from hours_trained divided by subject_duration, not hours_present"
    - "Hours completion check compares hours_trained against subject_duration, not hours_present"
    - "Overall learner progress aggregation for in-progress LPs uses hours_trained, not hours_present"
    - "SQL-level progress calculations in ClassRepository and LearnerRepository use hours_trained"
    - "View templates display hours_trained as the numerator in progress display (X / Y hrs)"
  artifacts:
    - path: "src/Learners/Models/LearnerProgressionModel.php"
      provides: "getProgressPercentage() using hoursTrained, isHoursComplete() using hoursTrained"
      contains: "hoursTrained / .*subjectDuration"
    - path: "src/Learners/Services/ProgressionService.php"
      provides: "getLearnerOverallProgress() using getHoursTrained()"
      contains: "getHoursTrained"
    - path: "src/Learners/Repositories/LearnerProgressionRepository.php"
      provides: "getReportSummaryStats avg_progress using hours_trained"
      contains: "lpt.hours_trained / cts.subject_duration"
    - path: "src/Learners/Repositories/LearnerRepository.php"
      provides: "SQL progress calculations using hours_trained"
      contains: "lpt.hours_trained / cts.subject_duration"
    - path: "src/Classes/Repositories/ClassRepository.php"
      provides: "SQL progress calculation using hours_trained"
      contains: "lpt.hours_trained / cts.subject_duration"
  key_links:
    - from: "src/Learners/Models/LearnerProgressionModel.php"
      to: "src/Learners/Services/ProgressionService.php"
      via: "getProgressPercentage() called by service methods"
      pattern: "getProgressPercentage\\(\\)"
    - from: "src/Learners/Services/ProgressionService.php"
      to: "views/learners/components/learner-progressions.php"
      via: "getCurrentLPDetails() returns progress_percentage used in template"
      pattern: "progress_percentage"
    - from: "assets/js/learners/progression-admin.js"
      to: "progress bar column rendering"
      via: "Variable extraction parses row.hours_trained for progress bar percentage"
      pattern: "hours_trained.*duration"
    - from: "views/classes/components/single-class/modal-learners.php"
      to: "progress bar tooltip display"
      via: "title attribute uses $hoursTrained not $hoursPresent as numerator"
      pattern: "hoursTrained.*productDuration"
---

<objective>
Fix all progress percentage calculations and display to use hours_trained instead of hours_present, per Mario's clarification that progress tracks training delivery not just attendance.

Purpose: Learner progression bars and percentage displays currently use hours_present (time physically present) but should use hours_trained (actual training hours delivered). This is a data semantics fix that must be consistent across PHP model methods, SQL queries, view templates, and JS.

Output: All 8 files updated — progress calculation uses hours_trained everywhere.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Learners/Models/LearnerProgressionModel.php
@src/Learners/Services/ProgressionService.php
@src/Learners/Repositories/LearnerProgressionRepository.php
@src/Learners/Repositories/LearnerRepository.php
@src/Classes/Repositories/ClassRepository.php
@views/learners/components/learner-progressions.php
@views/classes/components/single-class/modal-learners.php
@assets/js/learners/progression-admin.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix PHP model and service progress calculations</name>
  <files>
    src/Learners/Models/LearnerProgressionModel.php
    src/Learners/Services/ProgressionService.php
  </files>
  <action>
In LearnerProgressionModel.php:

1. `getProgressPercentage()` (line 182): Change `$this->hoursPresent` to `$this->hoursTrained`:
   ```php
   return min(100, round(($this->hoursTrained / $this->subjectDuration) * 100, 1));
   ```

2. `isHoursComplete()` (line 198): Change `$this->hoursPresent` to `$this->hoursTrained`:
   ```php
   return $this->subjectDuration && $this->hoursTrained >= $this->subjectDuration;
   ```

In ProgressionService.php:

3. `getLearnerOverallProgress()` (line 286): Change `$progression->getHoursPresent()` to `$progression->getHoursTrained()`:
   ```php
   $totalCompletedHours += $progression->getHoursTrained();
   ```
  </action>
  <verify>
    <automated>grep -n "hoursTrained.*subjectDuration\|getHoursTrained" src/Learners/Models/LearnerProgressionModel.php src/Learners/Services/ProgressionService.php | grep -c "hoursTrained\|getHoursTrained"</automated>
    <manual>Confirm hoursPresent no longer appears in getProgressPercentage, isHoursComplete, or getLearnerOverallProgress</manual>
  </verify>
  <done>getProgressPercentage() divides hoursTrained by subjectDuration. isHoursComplete() compares hoursTrained against subjectDuration. getLearnerOverallProgress() sums getHoursTrained() for in-progress LPs.</done>
</task>

<task type="auto">
  <name>Task 2: Fix SQL-level progress calculations and view templates</name>
  <files>
    src/Classes/Repositories/ClassRepository.php
    src/Learners/Repositories/LearnerRepository.php
    src/Learners/Repositories/LearnerProgressionRepository.php
    views/learners/components/learner-progressions.php
    views/classes/components/single-class/modal-learners.php
    assets/js/learners/progression-admin.js
  </files>
  <action>
SQL changes (all are `lpt.hours_present / cts.subject_duration` -> `lpt.hours_trained / cts.subject_duration`):

1. ClassRepository.php line 243: Change the active_progress_pct CASE expression:
   ```sql
   LEAST(100, ROUND((lpt.hours_trained / cts.subject_duration) * 100, 1))
   ```
   Also rename the column alias on line 239 from `active_hours_present` to `active_hours_trained` and the field reference from `lpt.hours_present` to `lpt.hours_trained`.

2. LearnerRepository.php line 487: Same change for the active_progress_pct CTE:
   ```sql
   LEAST(100, ROUND((lpt.hours_trained / cts.subject_duration) * 100, 1))
   ```
   Also rename `active_hours_present` alias to `active_hours_trained` (line 483).

3. LearnerRepository.php line 579: Same change for the progress_pct query:
   ```sql
   LEAST(100, ROUND((lpt.hours_trained / cts.subject_duration) * 100, 1))
   ```
   Note: line 573 already selects `lpt.hours_present` and `lpt.hours_trained` — keep both for the detail view, but the progress_pct must use hours_trained.

4. LearnerProgressionRepository.php line 625 (getReportSummaryStats): Change the avg_progress CASE:
   ```sql
   THEN (lpt.hours_trained / cts.subject_duration::float) * 100
   ```
   Also update the docstring on line 607 from "hours_present/subject_duration" to "hours_trained/subject_duration".

View template changes (display numerator):

5. views/learners/components/learner-progressions.php line 101: Change `$currentLP['hours_present']` to `$currentLP['hours_trained']` in the progress bar label.

6. views/learners/components/learner-progressions.php line 262: Change `$lp['hours_present']` to `$lp['hours_trained']` in the completed LP history display.

7. views/classes/components/single-class/modal-learners.php line 164: Change `$lpDetails['hours_present']` to `$lpDetails['hours_trained']` in the modal hours display.

8. assets/js/learners/progression-admin.js line 630: Change `data.hours_present` to `data.hours_trained` and update the label text from 'present' to 'trained':
   ```js
   .text('Hours: ' + (data.hours_trained || 0) + ' / ' + (data.subject_duration || 0) + ' trained')
   ```

9. assets/js/learners/progression-admin.js lines 153-154 (progress bar column): Change the variable extraction and calculation from hours_present to hours_trained:
   - Line 153: Change `const present = parseFloat(row.hours_present) || 0` to `const trained = parseFloat(row.hours_trained) || 0`
   - Line 154: Change `(present / duration)` to `(trained / duration)`:
   ```js
   const trained    = parseFloat(row.hours_trained) || 0;
   const pct        = duration > 0 ? Math.min(100, Math.round((trained / duration) * 100)) : 0;
   ```
   Without this change, the progress bar column still renders percentages based on hours_present.

10. views/classes/components/single-class/modal-learners.php line 193: Change the progress bar tooltip from `$hoursPresent` to `$hoursTrained` as the numerator. The variable `$hoursTrained` is already extracted at line 182 — just use it in the title attribute:
   ```php
   title="<?php echo esc_attr($hoursTrained); ?> / <?php echo esc_attr($productDuration); ?> hrs"
   ```
   Without this change, the tooltip still displays hours_present contradicting the "X / Y hrs" display requirement.
  </action>
  <verify>
    <automated>grep -rn "hours_present.*subject_duration\|hours_present.*cts\.\|hours_present.*hrs" src/Classes/Repositories/ClassRepository.php src/Learners/Repositories/LearnerRepository.php src/Learners/Repositories/LearnerProgressionRepository.php views/learners/components/learner-progressions.php views/classes/components/single-class/modal-learners.php assets/js/learners/progression-admin.js | grep -v "lpt.hours_present," | wc -l</automated>
    <automated>grep -c "const present.*hours_present" assets/js/learners/progression-admin.js</automated>
    <automated>grep -c "hoursPresent.*productDuration" views/classes/components/single-class/modal-learners.php</automated>
    <manual>First automated check should return 0 — no remaining hours_present-based progress calculations or display numerators. Second check should return 0 — JS progress bar variable no longer uses hours_present. Third check should return 0 — modal tooltip no longer uses hoursPresent as numerator.</manual>
  </verify>
  <done>All SQL CASE expressions calculating progress_pct use hours_trained. All view templates show hours_trained as numerator (including modal tooltip). JS admin panel shows hours_trained in both the progress bar column (lines 153-154) and the detail label (line 630). The hours_present column is still SELECTed where needed for other purposes but is not used for progress calculations.</done>
</task>

</tasks>

<verification>
1. `grep -rn "hoursPresent.*subjectDuration" src/Learners/Models/LearnerProgressionModel.php` returns 0 matches
2. `grep -rn "getHoursPresent" src/Learners/Services/ProgressionService.php | grep -v "getCurrentLPDetails\|checkForActiveLPCollision\|getProgressionHistory"` returns 0 matches (only display-related calls remain)
3. `grep -rn "hours_present / cts.subject_duration" src/ | wc -l` returns 0
4. `grep -rn "hours_present.*hrs\|hours_present.*subject_duration" views/ | wc -l` returns 0
5. `grep -c "const present.*hours_present" assets/js/learners/progression-admin.js` returns 0 (JS progress bar uses hours_trained)
6. `grep -c "hoursPresent.*productDuration" views/classes/components/single-class/modal-learners.php` returns 0 (modal tooltip uses hoursTrained)
</verification>

<success_criteria>
- PROG-01: getProgressPercentage() uses hoursTrained, not hoursPresent
- PROG-02: isHoursComplete() compares hoursTrained >= subjectDuration
- PROG-03: getLearnerOverallProgress() uses getHoursTrained() for in-progress LPs
- All SQL progress calculations use lpt.hours_trained
- All view/JS display shows hours_trained as progress numerator
</success_criteria>

<output>
After completion, create `.planning/phases/48-foundation/48-01-SUMMARY.md`
</output>
