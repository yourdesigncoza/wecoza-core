---
phase: 33-agents-module-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Agents/Controllers/AgentsController.php
  - src/Agents/Repositories/AgentRepository.php
autonomous: true

must_haves:
  truths:
    - "Server rejects agent form submission when any of 14 HTML-required fields are empty"
    - "Working area fields are sanitized with absint() at controller level before reaching repository"
    - "agent_notes column cannot be set via agent create/update (managed via separate table)"
    - "residential_town_id column cannot be set via agent create (no form field populates it)"
  artifacts:
    - path: "src/Agents/Controllers/AgentsController.php"
      provides: "Server-side validation for 14 missing required fields + absint() for working areas"
      contains: "empty($data['title'])"
    - path: "src/Agents/Repositories/AgentRepository.php"
      provides: "Cleaned whitelists without agent_notes and residential_town_id"
  key_links:
    - from: "src/Agents/Controllers/AgentsController.php"
      to: "src/Agents/Repositories/AgentRepository.php"
      via: "collectFormData() feeds sanitized data into repository CRUD methods"
      pattern: "absint.*preferred_working_area"
---

<objective>
Fix server-side validation gaps, add defense-in-depth sanitization, and clean up dead columns in the Agents module.

Purpose: Close security gaps where HTML-only validation can be bypassed, add controller-level sanitization for working area FKs, and remove orphaned columns from repository whitelists to reduce attack surface.
Output: Hardened AgentsController validation and sanitized collectFormData, cleaned AgentRepository whitelists.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-agents-module-fixes/33-RESEARCH.md
@src/Agents/Controllers/AgentsController.php
@src/Agents/Repositories/AgentRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add server-side validation for 14 missing required fields and sanitize working areas (AGT-02, AGT-03)</name>
  <files>src/Agents/Controllers/AgentsController.php</files>
  <action>
Two changes in AgentsController.php:

**AGT-02 — validateFormData() (currently lines 570-664):**
Add 14 missing required field validations AFTER the existing 11 validations (before the ID type validation block). The 14 fields to add:

1. `title` — `if (empty($data['title'])) { $errors['title'] = __('Title is required.', 'wecoza-core'); }`
2. `residential_suburb` — same pattern, message "Suburb is required."
3. `subjects_registered` — "Subjects registered is required."
4. `highest_qualification` — "Highest qualification is required."
5. `agent_training_date` — "Agent training date is required."
6. `quantum_assessment` — Use `!isset($data['quantum_assessment']) || $data['quantum_assessment'] === ''` (numeric field, 0 is valid), message "Quantum assessment is required."
7. `quantum_maths_score` — Same pattern as quantum_assessment, "Quantum maths score is required."
8. `quantum_science_score` — Same pattern, "Quantum science score is required."
9. `signed_agreement_date` — `empty()` check, "Signed agreement date is required."
10. `bank_name` — "Bank name is required."
11. `account_holder` — "Account holder is required."
12. `bank_account_number` — "Account number is required."
13. `bank_branch_code` — "Branch code is required."
14. `account_type` — "Account type is required."

Note: For quantum score fields, use `!isset() || === ''` instead of `empty()` because `empty(0)` returns true but 0 is a valid score value. The processNumericField() method already returns null for empty strings.

**AGT-03 — collectFormData() (currently lines 452-454):**
Change the 3 working area lines from raw `$_POST` access to `absint()` wrapped:
```php
'preferred_working_area_1' => absint($_POST['preferred_working_area_1'] ?? 0),
'preferred_working_area_2' => absint($_POST['preferred_working_area_2'] ?? 0),
'preferred_working_area_3' => absint($_POST['preferred_working_area_3'] ?? 0),
```

Note: The repository's `sanitizeWorkingArea()` already converts 0 to null for FK safety, so passing absint(0) is safe — it will become null at repository level.
  </action>
  <verify>
Grep for the new validation strings to confirm they exist:
```bash
grep -c "is required" src/Agents/Controllers/AgentsController.php
```
Should return 25+ (11 existing + 14 new).

Grep for absint on working areas:
```bash
grep "absint.*preferred_working_area" src/Agents/Controllers/AgentsController.php
```
Should return 3 lines.

Run PHP syntax check:
```bash
php -l src/Agents/Controllers/AgentsController.php
```
  </verify>
  <done>
validateFormData() contains validation checks for all 25 required fields (11 existing + 14 new). collectFormData() applies absint() to all 3 working area fields before repository receives them.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove dead columns from repository whitelists (AGT-04, AGT-05)</name>
  <files>src/Agents/Repositories/AgentRepository.php</files>
  <action>
**AGT-04 — Remove `agent_notes` from whitelists and sanitization:**
1. In `getAllowedInsertColumns()` (line 120): Remove `'agent_notes',` from the array. Agent notes are managed via the separate `agent_notes` table with `addAgentNote()`/`getAgentNotes()`.
2. In `sanitizeAgentData()` (line 538): Remove `'agent_notes' => 'sanitize_textarea_field',` from the $fields array.

**AGT-05 — Remove `residential_town_id` from whitelists and sanitization:**
1. In `getAllowedInsertColumns()` (line 123): Remove `'residential_town_id',` from the array. No form field populates this column.
2. In `sanitizeAgentData()` (line 547): Remove `'residential_town_id' => 'absint',` from the $fields array.

Note: `getAllowedUpdateColumns()` derives from `getAllowedInsertColumns()` via `array_diff`, so removing from insert automatically removes from update too.
  </action>
  <verify>
Verify columns are removed:
```bash
grep -n "agent_notes" src/Agents/Repositories/AgentRepository.php
```
Should only show results in the agent_notes table methods (addAgentNote, getAgentNotes, deleteAgentNotes), NOT in getAllowedInsertColumns or sanitizeAgentData.

```bash
grep -n "residential_town_id" src/Agents/Repositories/AgentRepository.php
```
Should return 0 results.

Run PHP syntax check:
```bash
php -l src/Agents/Repositories/AgentRepository.php
```
  </verify>
  <done>
`agent_notes` removed from getAllowedInsertColumns and sanitizeAgentData (still present in notes-specific methods which is correct). `residential_town_id` fully removed from repository. Both columns can no longer be set via form submission.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Agents/Controllers/AgentsController.php` passes (no syntax errors)
2. `php -l src/Agents/Repositories/AgentRepository.php` passes (no syntax errors)
3. `grep -c "is required" src/Agents/Controllers/AgentsController.php` returns 25+
4. `grep "absint.*preferred_working_area" src/Agents/Controllers/AgentsController.php` returns 3 matches
5. `grep "agent_notes" src/Agents/Repositories/AgentRepository.php` shows no results in whitelist/sanitization sections
6. `grep "residential_town_id" src/Agents/Repositories/AgentRepository.php` returns 0 results
</verification>

<success_criteria>
- All 14 previously unvalidated required fields now have server-side validation in validateFormData()
- Working areas sanitized at controller level with absint() for defense-in-depth
- agent_notes and residential_town_id removed from insert/update whitelists and sanitization map
- No PHP syntax errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/33-agents-module-fixes/33-01-SUMMARY.md`
</output>
