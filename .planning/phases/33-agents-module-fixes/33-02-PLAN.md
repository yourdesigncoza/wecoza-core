---
phase: 33-agents-module-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Agents/Services/AgentDisplayService.php
  - src/Agents/Controllers/AgentsController.php
  - src/Agents/Ajax/AgentsAjaxHandlers.php
autonomous: true

must_haves:
  truths:
    - "Agent list page renders identically after refactor (same statistics, same table, same pagination)"
    - "AJAX pagination returns identical JSON response after refactor"
    - "No duplicated display logic exists between controller and AJAX handler"
  artifacts:
    - path: "src/Agents/Services/AgentDisplayService.php"
      provides: "Shared display methods: getAgentStatistics, mapAgentFields, mapSortColumn, getDisplayColumns"
      exports: ["getAgentStatistics", "mapAgentFields", "mapSortColumn", "getDisplayColumns"]
      min_lines: 80
    - path: "src/Agents/Controllers/AgentsController.php"
      provides: "Controller delegates to AgentDisplayService instead of private methods"
      contains: "AgentDisplayService::"
    - path: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      provides: "AJAX handler delegates to AgentDisplayService instead of private methods"
      contains: "AgentDisplayService::"
  key_links:
    - from: "src/Agents/Controllers/AgentsController.php"
      to: "src/Agents/Services/AgentDisplayService.php"
      via: "use statement + static method calls"
      pattern: "AgentDisplayService::getAgentStatistics"
    - from: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      to: "src/Agents/Services/AgentDisplayService.php"
      via: "use statement + static method calls"
      pattern: "AgentDisplayService::mapAgentFields"
---

<objective>
Extract 4 duplicated display methods from AgentsController and AgentsAjaxHandlers into a shared AgentDisplayService class (DRY refactor).

Purpose: Eliminate ~200 lines of code duplication between the controller and AJAX handler. Both currently contain identical implementations of getAgentStatistics, mapAgentFields, mapSortColumn, and getDisplayColumns. Future changes would need to be made in two places, risking drift.
Output: New AgentDisplayService.php with shared methods, controller and AJAX handler updated to delegate.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-agents-module-fixes/33-RESEARCH.md
@src/Agents/Controllers/AgentsController.php
@src/Agents/Ajax/AgentsAjaxHandlers.php
@src/Agents/Services/WorkingAreasService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgentDisplayService with extracted methods (AGT-06)</name>
  <files>src/Agents/Services/AgentDisplayService.php</files>
  <action>
Create new file `src/Agents/Services/AgentDisplayService.php` in the `WeCoza\Agents\Services` namespace (PSR-4 autoloaded, same pattern as existing `WorkingAreasService`).

Extract these 4 methods as public static methods (matching the existing static pattern in WorkingAreasService):

1. **`getAgentStatistics(): array`** — Move from AgentsController.php lines 856-938. Queries agents table for total, active, SACE registered, quantum qualified counts. Include the try/catch with error fallback returning zeros. Extract the empty statistics return into a private static `getEmptyStatistics()` helper method.

2. **`mapAgentFields(array $agent): array`** — Move from AgentsController.php lines 743-761. Maps database column names to frontend display field names (agent_id->id, surname->last_name, tel_number->phone, email_address->email, etc).

3. **`mapSortColumn(string $column): string`** — Move from AgentsController.php lines 769-778. Maps frontend sort column names to database column names (last_name->surname, phone->tel_number, email->email_address).

4. **`getDisplayColumns(string $columns_setting): array`** — Move from AgentsController.php lines 786-814. Returns array of column key=>label pairs, filtered by $columns_setting if provided.

Follow the existing service class conventions:
- `<?php` tag, namespace declaration, ABSPATH check
- PHPDoc class comment with `@package WeCoza\Agents` and `@since 3.0.0`
- PHPDoc on each method noting it was "Extracted from AgentsController and AgentsAjaxHandlers"
- Use `wecoza_db()` for database access (same as the source code)
- Use `wecoza_log()` for error logging (same as the source code)
  </action>
  <verify>
Run PHP syntax check:
```bash
php -l src/Agents/Services/AgentDisplayService.php
```

Verify all 4 methods exist:
```bash
grep -c "public static function" src/Agents/Services/AgentDisplayService.php
```
Should return 4.

Verify namespace is correct:
```bash
grep "namespace WeCoza" src/Agents/Services/AgentDisplayService.php
```
  </verify>
  <done>
AgentDisplayService.php exists with 4 public static methods and 1 private helper. File passes PHP syntax check. Namespace matches PSR-4 autoloading convention.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace duplicated methods in controller and AJAX handler with service calls (AGT-06)</name>
  <files>src/Agents/Controllers/AgentsController.php, src/Agents/Ajax/AgentsAjaxHandlers.php</files>
  <action>
**In AgentsController.php:**

1. Add use statement at top (after existing use statements, around line 18):
   ```php
   use WeCoza\Agents\Services\AgentDisplayService;
   ```

2. In `renderAgentsList()` method, replace private method calls with service calls:
   - Line ~201: `$sort_column = $this->mapSortColumn($sort_column);` -> `$sort_column = AgentDisplayService::mapSortColumn($sort_column);`
   - Line ~217: `$agents[] = $this->mapAgentFields($agent);` -> `$agents[] = AgentDisplayService::mapAgentFields($agent);`
   - Line ~229: `$statistics = $this->getAgentStatistics();` -> `$statistics = AgentDisplayService::getAgentStatistics();`
   - Line ~232: `$columns = $this->getDisplayColumns($atts['columns']);` -> `$columns = AgentDisplayService::getDisplayColumns($atts['columns']);`

3. DELETE the 4 private methods (they are now in the service):
   - `private function mapAgentFields(array $agent): array` (lines 743-761)
   - `private function mapSortColumn(string $column): string` (lines 769-778)
   - `private function getDisplayColumns(string $columns_setting): array` (lines 786-814)
   - `private function getAgentStatistics(): array` (lines 856-938)

   Keep ALL other private methods intact (collectFormData, processTextField, processDateField, processNumericField, validateFormData, handleFileUploads, uploadFile, getEditUrl, getViewUrl, getBackUrl, detectAgentIdFromUrl, determineFormMode).

**In AgentsAjaxHandlers.php:**

1. Add use statement at top (after existing use statements, around line 15):
   ```php
   use WeCoza\Agents\Services\AgentDisplayService;
   ```

2. In `handlePagination()` method, replace private method calls with service calls:
   - Line ~80: `$orderby = $this->mapSortColumn($orderby);` -> `$orderby = AgentDisplayService::mapSortColumn($orderby);`
   - Line ~96: `$agents[] = $this->mapAgentFields($agent);` -> `$agents[] = AgentDisplayService::mapAgentFields($agent);`
   - Line ~108: `$statistics = $this->getAgentStatistics();` -> `$statistics = AgentDisplayService::getAgentStatistics();`
   - Line ~114: `$columns = $this->getDisplayColumns('');` -> `$columns = AgentDisplayService::getDisplayColumns('');`

3. DELETE the 4 private methods:
   - `private function getAgentStatistics(): array` (lines 199-281)
   - `private function mapAgentFields(array $agent): array` (lines 318-336)
   - `private function mapSortColumn(string $column): string` (lines 344-353)
   - `private function getDisplayColumns(string $columns_setting): array` (lines 361-389)

   Keep `getStatisticsHtml()` in AgentsAjaxHandlers — it is NOT duplicated (only exists in the AJAX handler for generating HTML response).
  </action>
  <verify>
Run PHP syntax checks:
```bash
php -l src/Agents/Controllers/AgentsController.php
php -l src/Agents/Ajax/AgentsAjaxHandlers.php
```

Verify no duplicate methods remain:
```bash
grep -c "private function getAgentStatistics" src/Agents/Controllers/AgentsController.php src/Agents/Ajax/AgentsAjaxHandlers.php
```
Both should return 0.

```bash
grep -c "private function mapAgentFields" src/Agents/Controllers/AgentsController.php src/Agents/Ajax/AgentsAjaxHandlers.php
```
Both should return 0.

Verify service is being used:
```bash
grep "AgentDisplayService::" src/Agents/Controllers/AgentsController.php src/Agents/Ajax/AgentsAjaxHandlers.php
```
Should show 4 calls in each file (8 total).

Verify getStatisticsHtml still exists in AJAX handler (NOT deleted):
```bash
grep "getStatisticsHtml" src/Agents/Ajax/AgentsAjaxHandlers.php
```
Should return 2+ matches (method definition + call).
  </verify>
  <done>
Controller and AJAX handler both delegate to AgentDisplayService for all 4 shared methods. Private duplicates removed from both files. getStatisticsHtml preserved in AJAX handler. Both files pass PHP syntax check. Net code reduction ~200 lines.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Agents/Services/AgentDisplayService.php` passes
2. `php -l src/Agents/Controllers/AgentsController.php` passes
3. `php -l src/Agents/Ajax/AgentsAjaxHandlers.php` passes
4. `grep -c "AgentDisplayService::" src/Agents/Controllers/AgentsController.php` returns 4
5. `grep -c "AgentDisplayService::" src/Agents/Ajax/AgentsAjaxHandlers.php` returns 4
6. `grep -c "private function getAgentStatistics" src/Agents/Controllers/AgentsController.php` returns 0
7. `grep -c "private function mapAgentFields" src/Agents/Ajax/AgentsAjaxHandlers.php` returns 0
8. `grep "getStatisticsHtml" src/Agents/Ajax/AgentsAjaxHandlers.php` shows method still exists
</verification>

<success_criteria>
- AgentDisplayService.php exists with 4 shared static methods
- AgentsController.php uses AgentDisplayService for all display-related calls
- AgentsAjaxHandlers.php uses AgentDisplayService for all display-related calls
- No duplicated display methods remain in either file
- getStatisticsHtml remains in AJAX handler (it is unique, not duplicated)
- All 3 files pass PHP syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/33-agents-module-fixes/33-02-SUMMARY.md`
</output>
