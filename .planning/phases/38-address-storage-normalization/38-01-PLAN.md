---
phase: 38-address-storage-normalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - db/migrations/38-01-agent-address-to-locations.sql
  - db/migrations/38-01-agent-address-to-locations.php
autonomous: false

must_haves:
  truths:
    - "Migration SQL adds location_id column to agents table as FK to locations.location_id"
    - "Migration PHP script copies all non-empty agent addresses to locations table and sets FK"
    - "Count of agent addresses before migration equals count of new location records after migration"
    - "Agent rows have location_id set pointing to their corresponding location record"
  artifacts:
    - path: "db/migrations/38-01-agent-address-to-locations.sql"
      provides: "DDL to add location_id column to agents table"
      contains: "ALTER TABLE agents ADD COLUMN location_id"
    - path: "db/migrations/38-01-agent-address-to-locations.php"
      provides: "Data migration script that copies agent addresses to locations table and sets FK"
      contains: "INSERT INTO public.locations"
  key_links:
    - from: "db/migrations/38-01-agent-address-to-locations.php"
      to: "public.locations"
      via: "INSERT addresses from agents into locations, UPDATE agents.location_id"
      pattern: "INSERT INTO.*locations.*SELECT.*FROM agents"
---

<objective>
Create migration scripts (SQL schema + PHP data migration) to add a `location_id` FK column to the agents table and copy existing agent addresses into the shared `public.locations` table.

Purpose: Enables agent addresses to be stored in the shared locations table (same as clients/learners), eliminating denormalized address columns. The agents table will gain a `location_id` FK pointing to the locations table. Old address columns are preserved for the dual-write period (Phase 38-02).

Output: Two migration files — SQL DDL for schema change, PHP script for data migration. Both are run manually by the user.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Clients/Models/LocationsModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migration and PHP data migration scripts</name>
  <files>db/migrations/38-01-agent-address-to-locations.sql, db/migrations/38-01-agent-address-to-locations.php</files>
  <action>
Create two migration files in `db/migrations/`:

**File 1: `38-01-agent-address-to-locations.sql`** — DDL schema change

Contains these statements (wrapped in a transaction):

1. Add `location_id` column to agents table:
```sql
ALTER TABLE agents ADD COLUMN location_id INTEGER DEFAULT NULL;
```

2. Add FK constraint from agents.location_id to public.locations.location_id:
```sql
ALTER TABLE agents ADD CONSTRAINT fk_agents_location
  FOREIGN KEY (location_id) REFERENCES public.locations(location_id)
  ON DELETE SET NULL;
```

3. Add index for FK lookups:
```sql
CREATE INDEX idx_agents_location_id ON agents(location_id);
```

Include a header comment explaining the purpose and that old address columns are preserved for the dual-write period.

**File 2: `38-01-agent-address-to-locations.php`** — Data migration script

A standalone PHP script that:
1. Bootstraps WordPress (`wp-load.php` — relative path from plugin dir)
2. Gets the PostgreSQL connection via `wecoza_db()`
3. Counts agents with non-empty addresses BEFORE migration (stores for verification)
4. For each agent with a non-empty `residential_address_line`:
   a. Checks if a matching location already exists in `public.locations` (match on street_address + suburb + town + province + postal_code, case-insensitive)
   b. If match found: reuse existing location_id
   c. If no match: INSERT into `public.locations` with this column mapping:
      - `street_address` ← `agents.residential_address_line` (plus `address_line_2` appended if not empty, separated by ", ")
      - `suburb` ← `agents.residential_suburb`
      - `town` ← `agents.city`
      - `province` ← `agents.province`
      - `postal_code` ← `agents.residential_postal_code`
      - `longitude` ← NULL
      - `latitude` ← NULL
      - `created_at` ← current timestamp
      - `updated_at` ← current timestamp
   d. UPDATE agents SET location_id = {new_location_id} WHERE agent_id = {agent_id}
5. Counts location records created and agents updated
6. Outputs summary: agents processed, locations created, locations reused, agents updated
7. Verifies: count of agents with location_id set equals count of agents with non-empty addresses

The script MUST:
- Use transactions (BEGIN/COMMIT) for atomicity
- Include a `--dry-run` CLI flag that shows what would happen without committing
- Use parameterized queries (not string interpolation) for SQL injection prevention
- Handle the case where location_id column doesn't exist yet (error message suggesting running SQL first)
- Be idempotent (skip agents that already have location_id set)

The column mapping between agents table and locations table:
| agents column              | locations column |
|---------------------------|-----------------|
| residential_address_line  | street_address  |
| address_line_2            | (appended to street_address) |
| residential_suburb        | suburb          |
| city                      | town            |
| province                  | province        |
| residential_postal_code   | postal_code     |

IMPORTANT: Do NOT use `entity_type`/`entity_id` columns — the locations table is a pure address table. The linking is done via agents.location_id FK, matching the pattern used by sites.place_id → locations.location_id.
  </action>
  <verify>
1. Both files exist in db/migrations/ directory
2. SQL file contains ALTER TABLE, CONSTRAINT, and INDEX statements
3. PHP file contains WordPress bootstrap, connection handling, INSERT/UPDATE logic, dry-run support, and verification output
4. PHP file uses parameterized queries (`:param` syntax, not string concatenation)
5. Run `php -l db/migrations/38-01-agent-address-to-locations.php` — no syntax errors
  </verify>
  <done>
Two migration files exist: SQL DDL adds location_id column with FK and index; PHP script copies agent addresses to locations table with duplicate detection, dry-run support, idempotency, and verification output. Both files pass syntax checks.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify and run migration scripts</name>
  <files>db/migrations/38-01-agent-address-to-locations.sql, db/migrations/38-01-agent-address-to-locations.php</files>
  <action>
User reviews and runs the migration scripts:
1. Review SQL DDL and PHP migration logic
2. Run SQL migration against the database
3. Run PHP migration with --dry-run first, then for real
  </action>
  <verify>
1. Review `db/migrations/38-01-agent-address-to-locations.sql` — verify DDL is correct
2. Review `db/migrations/38-01-agent-address-to-locations.php` — verify migration logic
3. Run the SQL migration manually against your database
4. Run the PHP migration in dry-run mode: `php db/migrations/38-01-agent-address-to-locations.php --dry-run`
5. If dry-run looks correct, run without flag: `php db/migrations/38-01-agent-address-to-locations.php`
6. Verify output shows all 17 agents processed with matching location records
  </verify>
  <done>User confirms migration ran successfully — all agents have location_id set, location records created in locations table. Type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
- SQL file adds location_id column to agents table with FK constraint and index
- PHP migration script processes all agents with addresses
- Dry-run mode shows planned changes without committing
- Post-migration: count of agents with location_id matches count of agents with non-empty addresses
- No duplicate locations created for identical addresses
</verification>

<success_criteria>
- Two migration files exist in db/migrations/
- SQL DDL is syntactically correct for PostgreSQL
- PHP script is idempotent and handles edge cases (empty addresses, duplicates, missing column)
- User confirms successful migration run
</success_criteria>

<output>
After completion, create `.planning/phases/38-address-storage-normalization/38-01-SUMMARY.md`
</output>
