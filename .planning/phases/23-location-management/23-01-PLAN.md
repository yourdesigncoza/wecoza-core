---
phase: 23-location-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Clients/Controllers/LocationsController.php
  - src/Clients/Models/LocationsModel.php
  - views/clients/components/location-capture-form.view.php
  - assets/js/clients/location-capture.js
autonomous: false

must_haves:
  truths:
    - "[wecoza_locations_capture] renders the location capture form without PHP errors"
    - "[wecoza_locations_list] renders a table of existing locations with pagination"
    - "[wecoza_locations_edit] renders a pre-filled form for an existing location"
    - "Google Maps autocomplete widget replaces the plain text input when API key is set"
    - "Manual entry fields remain fully editable when Google Maps is unavailable"
  artifacts:
    - path: "src/Clients/Controllers/LocationsController.php"
      provides: "3 shortcode handlers, asset enqueuing, form submission handling"
      contains: "updateById"
    - path: "views/clients/components/location-capture-form.view.php"
      provides: "Location capture/edit form with duplicate check UI"
      contains: "wecoza-clients-form-container"
    - path: "assets/js/clients/location-capture.js"
      provides: "Google Maps PlaceAutocompleteElement integration"
      contains: "wecoza_clients_google_address_container"
  key_links:
    - from: "assets/js/clients/location-capture.js"
      to: "views/clients/components/location-capture-form.view.php"
      via: "DOM element IDs"
      pattern: "wecoza_clients_google_address_(container|search)"
    - from: "views/clients/components/location-capture-form.view.php"
      to: "inline script duplicate check"
      via: "CSS selector"
      pattern: "wecoza-clients-form-container"
    - from: "src/Clients/Controllers/LocationsController.php"
      to: "src/Clients/Models/LocationsModel.php"
      via: "updateById method call"
      pattern: "updateById\\("
---

<objective>
Fix shortcode rendering, DOM wiring, and method signature mismatches for all 3 location shortcodes.

Purpose: The Phase 21 migration introduced several naming mismatches between JS, views, and PHP that prevent location forms from functioning. This plan fixes them systematically.
Output: All 3 location shortcodes rendering correctly, Google Maps autocomplete wiring valid, form submission calling correct model methods.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-location-management/23-RESEARCH.md
@.planning/phases/22-client-management/22-01-SUMMARY.md
@.planning/phases/22-client-management/22-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix DOM ID mismatches, CSS selector mismatch, and controller method call</name>
  <files>
    src/Clients/Controllers/LocationsController.php
    src/Clients/Models/LocationsModel.php
    views/clients/components/location-capture-form.view.php
    assets/js/clients/location-capture.js
  </files>
  <action>
Fix the following known mismatches found during code review:

**1. JS element ID mismatch (location-capture.js lines 19-20, 84):**
The external JS file uses camelCase IDs (`wecozaClients_google_address_container`, `wecozaClients_google_address_search`) but the view template uses underscore IDs (`wecoza_clients_google_address_container`, `wecoza_clients_google_address_search`).

Fix: Change the JS file to use underscore IDs matching the view:
- Line 19: `getElementById('wecoza_clients_google_address_container')`
- Line 20: `getElementById('wecoza_clients_google_address_search')`
- Line 84: `getElementById('wecoza_clients_google_address_search')`

**2. Inline script CSS selector mismatch (location-capture-form.view.php line 142):**
The inline `<script>` in the view uses `.wecoza-locations-form-container form` but the actual div class is `.wecoza-clients-form-container`.

Fix: Change line 142 from:
`var form = document.querySelector('.wecoza-locations-form-container form');`
to:
`var form = document.querySelector('.wecoza-clients-form-container form');`

**3. Controller update method mismatch (LocationsController.php line 314):**
The controller calls `$this->getModel()->update($id, $data)` but the model's `update()` method accepts no parameters and returns false. The correct method is `updateById($id, $data)`.

Fix: Change line 314 from:
`$updated = $this->getModel()->update($id, $data);`
to:
`$updated = $this->getModel()->updateById($id, $data);`

**4. Verify all 3 shortcodes are registered:**
Check that registerShortcodes() is called and all 3 shortcodes work:
- `wecoza_locations_capture` -> captureLocationShortcode
- `wecoza_locations_list` -> listLocationsShortcode
- `wecoza_locations_edit` -> editLocationShortcode

Run: `grep -n 'add_shortcode.*locations' src/Clients/Controllers/LocationsController.php` to confirm.

**5. Verify view paths:**
Check that the view references match actual file paths:
- `wecoza_view('clients/components/location-capture-form', ...)` -> `views/clients/components/location-capture-form.view.php` (exists)
- `wecoza_view('clients/display/locations-list', ...)` -> `views/clients/display/locations-list.view.php` (exists)

**6. Verify the LocationsModel constructor doesn't break:**
It instantiates SitesModel in constructor. Confirm SitesModel class exists and loads:
`grep -n 'class SitesModel' src/Clients/Models/SitesModel.php`
  </action>
  <verify>
Run these checks:
1. `grep -n 'wecoza_clients_google_address' assets/js/clients/location-capture.js` - should show underscore IDs (3 occurrences)
2. `grep -n 'wecoza-clients-form-container' views/clients/components/location-capture-form.view.php` - should appear in both div and inline script
3. `grep -n 'updateById' src/Clients/Controllers/LocationsController.php` - should show the fix
4. `grep -n 'function updateById' src/Clients/Models/LocationsModel.php` - confirm method exists in model
5. `php -l src/Clients/Controllers/LocationsController.php` - no syntax errors
6. `php -l src/Clients/Models/LocationsModel.php` - no syntax errors
7. `php -l views/clients/components/location-capture-form.view.php` - no syntax errors
  </verify>
  <done>
All 3 naming mismatches fixed: JS element IDs match view template, inline script CSS selector matches div class, controller calls updateById() matching model method. All PHP files pass lint check.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed DOM ID wiring, CSS selector, and controller method call for all 3 location shortcodes</what-built>
  <how-to-verify>
    1. Visit the page with [wecoza_locations_capture] shortcode
       - Form should render with all fields (street address, suburb, town, province, postal code, latitude, longitude)
       - If Google Maps API key is set: autocomplete widget should appear in search field
       - If no API key: warning alert should show, manual entry fields should work
    2. Visit the page with [wecoza_locations_list] shortcode
       - Table should show existing locations with columns: ID, Street Address, Suburb, Town, Province, Postal Code, Actions
       - Edit button should link to edit page with correct location_id
    3. Visit the page with [wecoza_locations_edit]?mode=update&amp;location_id=X (use a valid ID from the list)
       - Form should render pre-filled with location data
       - All fields should be editable
    4. Check browser console for JavaScript errors on capture page - should be clean
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- All 3 shortcodes render without PHP fatal errors
- DOM element IDs in JS match view template IDs
- Inline script CSS selector matches actual container class
- Controller update method calls model's updateById()
- Browser console clean of JS errors on location pages
</verification>

<success_criteria>
- [wecoza_locations_capture] renders full form with Google Maps autocomplete field
- [wecoza_locations_list] renders table with existing locations
- [wecoza_locations_edit] renders pre-filled form for given location_id
- No PHP errors in debug.log from location shortcodes
- No JavaScript console errors on location pages
</success_criteria>

<output>
After completion, create `.planning/phases/23-location-management/23-01-SUMMARY.md`
</output>
