---
phase: 23-location-management
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/Clients/Controllers/LocationsController.php
  - src/Clients/Ajax/ClientAjaxHandlers.php
  - views/clients/components/location-capture-form.view.php
  - assets/js/clients/location-capture.js
autonomous: false

must_haves:
  truths:
    - "User can create a location with suburb, town, postal code, province and coordinates"
    - "System warns about duplicate locations before saving via AJAX check"
    - "Submit button appears only after duplicate check is performed"
    - "User can edit an existing location and changes persist"
    - "Location list shows all locations with working search and pagination"
    - "Location hierarchy cache refreshes after create/update"
  artifacts:
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "AJAX handler for duplicate checking"
      contains: "checkLocationDuplicates"
    - path: "views/clients/components/location-capture-form.view.php"
      provides: "Form with correct AJAX action name"
      contains: "wecoza_check_location_duplicates"
    - path: "src/Clients/Controllers/LocationsController.php"
      provides: "Localization with camelCase keys matching JS conventions"
      contains: "ajaxUrl"
  key_links:
    - from: "views/clients/components/location-capture-form.view.php"
      to: "src/Clients/Ajax/ClientAjaxHandlers.php"
      via: "AJAX action name"
      pattern: "wecoza_check_location_duplicates"
    - from: "views/clients/components/location-capture-form.view.php"
      to: "wp_localize_script wecoza_ajax"
      via: "wecoza_ajax.ajaxUrl"
      pattern: "ajaxUrl"
    - from: "src/Clients/Models/LocationsModel.php"
      to: "wecoza_db()->insert"
      via: "PostgresConnection CRUD"
      pattern: "wecoza_db\\(\\)->insert"
    - from: "src/Clients/Models/LocationsModel.php"
      to: "src/Clients/Models/SitesModel.php"
      via: "refreshLocationCache after create/update"
      pattern: "refreshLocationCache"
---

<objective>
Verify and fix AJAX endpoints for location duplicate checking, test full location create/update cycle, and confirm list search/pagination.

Purpose: With shortcodes rendering (Plan 01), this plan ensures the interactive functionality works end-to-end: AJAX duplicate check, form submission creating/updating locations, list filtering.
Output: Fully working location CRUD with duplicate detection, search, and pagination.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-location-management/23-RESEARCH.md
@.planning/phases/23-location-management/23-01-SUMMARY.md
@.planning/phases/22-client-management/22-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AJAX action name mismatch, localization keys, and security</name>
  <files>
    src/Clients/Controllers/LocationsController.php
    views/clients/components/location-capture-form.view.php
    src/Clients/Ajax/ClientAjaxHandlers.php
  </files>
  <action>
Fix the following AJAX connectivity issues:

**1. AJAX action name mismatch:**
The inline script in location-capture-form.view.php sends `action: 'check_location_duplicates'` (line 224) but the AJAX handler is registered as `wp_ajax_wecoza_check_location_duplicates`. WordPress AJAX requires the action value to match the hook suffix.

Fix in location-capture-form.view.php: Change line 224 from:
`formData.append('action', 'check_location_duplicates');`
to:
`formData.append('action', 'wecoza_check_location_duplicates');`

**2. Localization key mismatch (ajax_url vs ajaxUrl):**
Phase 22 standardized camelCase localization keys for client JS (see 22-02-SUMMARY.md). The location controller still uses `ajax_url` (line 97).

Fix in LocationsController.php enqueueAssets(): Change the wecoza_ajax localization from:
```php
'ajax_url' => admin_url('admin-ajax.php'),
```
to:
```php
'ajaxUrl' => admin_url('admin-ajax.php'),
```

Then update the inline script in location-capture-form.view.php that reads `wecoza_ajax.ajax_url` (line 230) to:
`wecoza_ajax.ajaxUrl`

**3. Remove nopriv handler for duplicate check:**
The `wp_ajax_nopriv_wecoza_check_location_duplicates` handler (ClientAjaxHandlers.php line 45) allows non-authenticated users to check duplicates. Per CLAUDE.md, the entire WP environment requires login. Remove this line to prevent unauthenticated access.

Fix in ClientAjaxHandlers.php: Remove line 45:
`add_action('wp_ajax_nopriv_wecoza_check_location_duplicates', array($this, 'checkLocationDuplicates'));`

**4. Verify duplicate check error handling shows submit on network error:**
The inline script catch block at line 260 calls `hideSubmit()` after error. Per research (Pitfall 7), the submit button should show on error too so users can proceed.

Fix in location-capture-form.view.php: Change the catch block from:
```javascript
}).catch(function(error) {
    showDuplicateAlert('Error checking duplicates: ' + error.message, 'danger');
    hideSubmit();
```
to:
```javascript
}).catch(function(error) {
    showDuplicateAlert('Error checking duplicates: ' + error.message, 'danger');
    showSubmit();
```

**5. Verify the full CRUD flow works by code review:**

For CREATE: Check that LocationsModel::create() calls wecoza_db()->insert() and refreshes cache.
Verify: `grep -n 'insert\|refreshLocationCache' src/Clients/Models/LocationsModel.php`

For UPDATE: Check that LocationsModel::updateById() calls wecoza_db()->update() and refreshes cache.
Verify: `grep -n 'update\|refreshLocationCache' src/Clients/Models/LocationsModel.php`

For LIST: Check that LocationsModel::getAll() and count() use proper ILIKE search.
Verify: `grep -n 'ILIKE\|getAll\|count' src/Clients/Models/LocationsModel.php`

For DUPLICATE CHECK: Check that checkDuplicates() uses wecoza_db()->getAll() not DatabaseService.
Verify: `grep -n 'wecoza_db\|DatabaseService' src/Clients/Models/LocationsModel.php`
  </action>
  <verify>
1. `grep -n "wecoza_check_location_duplicates" views/clients/components/location-capture-form.view.php` - action name correct
2. `grep -n "ajaxUrl" src/Clients/Controllers/LocationsController.php` - camelCase key
3. `grep -n "ajaxUrl" views/clients/components/location-capture-form.view.php` - matches localization
4. `grep -c "nopriv.*check_location" src/Clients/Ajax/ClientAjaxHandlers.php` - should return 0
5. `grep -n "showSubmit" views/clients/components/location-capture-form.view.php` - shows in catch block
6. `grep -c "DatabaseService" src/Clients/Models/LocationsModel.php` - should return 0 (uses wecoza_db())
7. `php -l src/Clients/Controllers/LocationsController.php` - no syntax errors
8. `php -l src/Clients/Ajax/ClientAjaxHandlers.php` - no syntax errors
9. `php -l views/clients/components/location-capture-form.view.php` - no syntax errors
  </verify>
  <done>
AJAX action name matches handler registration, localization keys use camelCase, nopriv handler removed, error handling shows submit button on failure. All location CRUD methods use wecoza_db() correctly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixed AJAX connectivity for location duplicate checking and form submission, standardized localization keys, improved error handling</what-built>
  <how-to-verify>
    1. **Duplicate Check Test:**
       - Go to [wecoza_locations_capture] page
       - Enter a street address, suburb, or town that exists in the database
       - Click "Check Duplicates" button
       - Should show duplicate warning OR "No duplicates found" success message
       - Submit button should appear after check completes

    2. **Create Location Test:**
       - Fill in all required fields (street address, suburb, town, province, postal code, latitude, longitude)
       - Use test data: street="1 Test Street", suburb="Sandton", town="Johannesburg", province="Gauteng", postal="2196", lat="-26.1076", lng="28.0567"
       - Click "Check Duplicates" first, then "Save Location"
       - Should show success message
       - New location should appear in [wecoza_locations_list]

    3. **Edit Location Test:**
       - Go to [wecoza_locations_list] and click Edit on the test location
       - Change the suburb to "Rosebank"
       - Click "Check Duplicates", then save
       - Should show success, go back to list to verify change persisted

    4. **Search Test:**
       - On [wecoza_locations_list], search for "Sandton" or "Johannesburg"
       - Should filter results to matching locations
       - Clear search should show all locations again

    5. **Check browser console** - should be clean of errors throughout all tests
    6. **Check debug.log** - no PHP errors from location operations
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- AJAX duplicate check responds with correct JSON structure
- Location create saves to database and refreshes location cache
- Location update persists changes via updateById()
- Location list search filters by ILIKE on address fields
- No JavaScript console errors during any operation
- No PHP errors in debug.log
</verification>

<success_criteria>
- LOC-01: User can create location with suburb, town, postal code, province - VERIFIED
- LOC-04: System stores latitude/longitude for locations - VERIFIED
- LOC-05: User can view list of all locations with search and pagination - VERIFIED
- LOC-06: User can edit an existing location - VERIFIED
- LOC-07: System detects and warns about duplicate locations - VERIFIED
- SC-03: [wecoza_locations_capture] renders location creation form - VERIFIED
- SC-04: [wecoza_locations_list] renders locations table with search/pagination - VERIFIED
- SC-05: [wecoza_locations_edit] renders location edit form - VERIFIED
- LOC-02/LOC-03 (Google Maps autocomplete + manual fallback) covered by Plan 01 rendering verification
</success_criteria>

<output>
After completion, create `.planning/phases/23-location-management/23-02-SUMMARY.md`
</output>
