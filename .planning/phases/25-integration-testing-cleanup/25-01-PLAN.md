---
phase: 25-integration-testing-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/clients-feature-parity.php
autonomous: false

must_haves:
  truths:
    - "All 6 client/location shortcodes registered and rendering in integrated module"
    - "All 16 AJAX endpoints registered and responding in integrated module"
    - "Integrated module operates identically with standalone plugin deactivated"
  artifacts:
    - path: "tests/integration/clients-feature-parity.php"
      provides: "Automated feature parity verification script"
      contains: "ClientsParityTest"
  key_links:
    - from: "tests/integration/clients-feature-parity.php"
      to: "src/Clients/Controllers/ClientsController.php"
      via: "shortcode_exists() checks"
      pattern: "shortcode_exists"
    - from: "tests/integration/clients-feature-parity.php"
      to: "src/Clients/Ajax/ClientAjaxHandlers.php"
      via: "wp_filter AJAX hook checks"
      pattern: "wp_filter.*wp_ajax_wecoza_"
---

<objective>
Create automated feature parity test script and verify integrated Clients module works identically to standalone plugin. Then deactivate standalone plugin and confirm no breakage.

Purpose: Satisfies CLN-01 requirement -- standalone wecoza-clients-plugin can be deactivated after migration verified. Ensures no regression before cleanup.
Output: Feature parity test script + human-verified deactivation confirmation.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/security-test.php
@src/Clients/Ajax/ClientAjaxHandlers.php
@src/Clients/Controllers/ClientsController.php
@src/Clients/Controllers/LocationsController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create automated feature parity test script</name>
  <files>tests/integration/clients-feature-parity.php</files>
  <action>
Create `tests/integration/clients-feature-parity.php` following the established test pattern from `tests/security-test.php` (CLI-only guard, wp-load.php bootstrap, class-based runner with pass/fail tracking).

The test script must verify:

**1. Shortcode registration (6 shortcodes):**
- `wecoza_capture_clients`
- `wecoza_display_clients`
- `wecoza_update_clients`
- `wecoza_locations_capture`
- `wecoza_locations_list`
- `wecoza_locations_edit`
Use `shortcode_exists()` for each.

**2. AJAX endpoint registration (16 endpoints):**
Client endpoints:
- `wp_ajax_wecoza_save_client`
- `wp_ajax_wecoza_get_client`
- `wp_ajax_wecoza_get_client_details`
- `wp_ajax_wecoza_delete_client`
- `wp_ajax_wecoza_search_clients`
- `wp_ajax_wecoza_get_branch_clients`
- `wp_ajax_wecoza_export_clients`
- `wp_ajax_wecoza_get_main_clients`

Location endpoints:
- `wp_ajax_wecoza_get_locations`
- `wp_ajax_wecoza_save_location`
- `wp_ajax_wecoza_check_location_duplicates`

Site endpoints:
- `wp_ajax_wecoza_save_sub_site`
- `wp_ajax_wecoza_get_head_sites`
- `wp_ajax_wecoza_get_sub_sites`
- `wp_ajax_wecoza_delete_sub_site`
- `wp_ajax_wecoza_get_sites_hierarchy`

Check via `global $wp_filter` that each hook has callbacks registered.

**3. Namespace verification:**
- Verify `\WeCoza\Clients\Controllers\ClientsController` class exists
- Verify `\WeCoza\Clients\Controllers\LocationsController` class exists
- Verify `\WeCoza\Clients\Ajax\ClientAjaxHandlers` class exists
- Verify `\WeCoza\Clients\Models\ClientsModel` class exists
- Verify `\WeCoza\Clients\Models\LocationsModel` class exists
- Verify `\WeCoza\Clients\Models\SitesModel` class exists
- Verify `\WeCoza\Clients\Repositories\ClientRepository` class exists
- Verify `\WeCoza\Clients\Repositories\LocationRepository` class exists

**4. Database connectivity:**
- Verify `wecoza_db()` can connect
- Verify `clients` table exists and is queryable (SELECT 1 FROM clients LIMIT 1)
- Verify `locations` table exists and is queryable
- Verify `sites` table exists and is queryable

**5. View template existence:**
- Verify view files exist in `views/clients/` directory
- Check for `views/clients/display/` and `views/clients/components/` directories

**6. No standalone plugin dependency check:**
- Check that no code in `src/Clients/` references `WeCozaClients` namespace
- Check that no code references `WECOZA_CLIENTS_PLUGIN_` constants

Structure: single `ClientsParityTest` class with `run()` method, same `pass()`/`fail()`/`printResults()` pattern as `SecurityTestRunner`. Include exit code 1 on any failure. Support both `php tests/integration/clients-feature-parity.php` and `wp eval-file tests/integration/clients-feature-parity.php` execution.
  </action>
  <verify>
Run: `cd /opt/lampp/htdocs/wecoza && php wp-content/plugins/wecoza-core/tests/integration/clients-feature-parity.php`
All tests should pass (0 failed). Script should exit with code 0.
  </verify>
  <done>Feature parity test script runs, all checks pass, confirms integrated module has all shortcodes, AJAX endpoints, classes, database tables, and views.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Deactivate standalone plugin and verify no breakage</name>
  <what-built>
Automated feature parity test confirms the integrated Clients module in wecoza-core provides all 6 shortcodes, 16 AJAX endpoints, 8 classes, 3 database tables, and view templates. The integrated module is fully operational.
  </what-built>
  <how-to-verify>
1. Go to WordPress admin: Plugins page
2. Find "WeCoza Clients Plugin" (standalone) and click "Deactivate"
3. Navigate to the Clients listing page and verify it still renders correctly
4. Navigate to the Client capture form page and verify it renders
5. Navigate to the Locations listing page and verify it renders
6. Navigate to the Locations capture form page and verify it renders
7. Try creating or editing a client -- verify AJAX save works
8. Try creating or editing a location -- verify AJAX save works
9. Run the parity test again from CLI:
   `cd /opt/lampp/htdocs/wecoza && php wp-content/plugins/wecoza-core/tests/integration/clients-feature-parity.php`
10. Check debug.log for any new errors:
    `tail -50 /opt/lampp/htdocs/wecoza/wp-content/debug.log`
11. If any issues found: reactivate standalone plugin, note the issue
  </how-to-verify>
  <resume-signal>Type "approved" if all pages render and AJAX works without standalone plugin, or describe issues found.</resume-signal>
</task>

</tasks>

<verification>
- Feature parity test script exists at `tests/integration/clients-feature-parity.php`
- All tests pass with 0 failures
- Standalone plugin successfully deactivated without breaking functionality
- All client/location/site pages render correctly
- AJAX operations (save, search, delete) work correctly
- No new errors in debug.log
</verification>

<success_criteria>
- CLN-01 satisfied: Standalone wecoza-clients-plugin deactivated without breaking any functionality
- All 6 shortcodes render via integrated module only
- All 16 AJAX endpoints respond via integrated module only
- Feature parity test passes with standalone plugin inactive
</success_criteria>

<output>
After completion, create `.planning/phases/25-integration-testing-cleanup/25-01-SUMMARY.md`
</output>
