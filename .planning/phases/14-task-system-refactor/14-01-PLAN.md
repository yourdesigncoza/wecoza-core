---
phase: 14-task-system-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Services/TaskManager.php
autonomous: true

must_haves:
  truths:
    - "TaskManager has buildTasksFromEvents() method that accepts class array"
    - "Agent Order Number task always present in returned TaskCollection"
    - "Event tasks have IDs formatted as event-{index}"
    - "Task labels format as {type}: {description} or just {type}"
  artifacts:
    - path: "src/Events/Services/TaskManager.php"
      provides: "Task building from event_dates JSONB"
      exports: ["buildTasksFromEvents", "buildAgentOrderTask", "buildEventTask"]
  key_links:
    - from: "src/Events/Services/TaskManager.php::buildTasksFromEvents"
      to: "buildAgentOrderTask + buildEventTask"
      via: "method composition"
      pattern: "buildAgentOrderTask.*buildEventTask"
---

<objective>
Refactor TaskManager to build TaskCollection from classes.event_dates JSONB array instead of class_change_logs.

Purpose: Core logic change from trigger-based tasks to event-based tasks.
Output: TaskManager with new buildTasksFromEvents() factory method.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-task-system-refactor/14-RESEARCH.md

@src/Events/Services/TaskManager.php
@src/Events/Models/Task.php
@src/Events/Models/TaskCollection.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add buildTasksFromEvents factory method to TaskManager</name>
  <files>src/Events/Services/TaskManager.php</files>
  <action>
Add three new methods to TaskManager class:

1. `buildTasksFromEvents(array $class): TaskCollection`
   - Create new TaskCollection
   - Add Agent Order Number task via buildAgentOrderTask()
   - Decode event_dates from JSON (handle null/empty as empty array)
   - Loop through events, add each via buildEventTask()
   - Return TaskCollection

2. `buildAgentOrderTask(array $class): Task`
   - Get order_nr from class array (null if missing)
   - Determine status: completed if order_nr is non-null AND non-empty string
   - Return Task with:
     - id: 'agent-order'
     - label: 'Agent Order Number'
     - status: derived from order_nr presence
     - note: order_nr value (or null)
     - completedBy/completedAt: null (Phase 15 adds this)

3. `buildEventTask(int $index, array $event): Task`
   - Format label: "{type}: {description}" if description non-empty, else just "{type}"
   - Derive status from event['status'] field using match expression:
     - 'Completed' -> Task::STATUS_COMPLETED
     - 'Pending', 'Cancelled', default -> Task::STATUS_OPEN
   - Return Task with:
     - id: "event-{$index}"
     - label: formatted label
     - status: derived from event status
     - note: event['notes'] or null
     - completedBy/completedAt: null (Phase 15 adds this)

IMPORTANT: Keep all existing methods (getTasksWithTemplate, markTaskCompleted, etc.) - they will be removed in Phase 17. This allows gradual migration.

Use private visibility for buildAgentOrderTask() and buildEventTask() - they are internal helpers.
  </action>
  <verify>
Manually verify in PHP:
```php
$tm = new \WeCoza\Events\Services\TaskManager();
$class = [
  'order_nr' => null,
  'event_dates' => json_encode([
    ['type' => 'Training', 'description' => 'Week 1', 'status' => 'Pending'],
    ['type' => 'Material Delivery', 'description' => '', 'status' => 'Completed']
  ])
];
$tasks = $tm->buildTasksFromEvents($class);
var_dump(count($tasks->all())); // Should be 3
var_dump($tasks->get('agent-order')->getStatus()); // Should be 'open'
var_dump($tasks->get('event-0')->getLabel()); // Should be 'Training: Week 1'
var_dump($tasks->get('event-1')->getLabel()); // Should be 'Material Delivery'
var_dump($tasks->get('event-1')->getStatus()); // Should be 'completed'
```
  </verify>
  <done>
buildTasksFromEvents() returns TaskCollection with Agent Order Number task + one task per event, correct IDs and labels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle edge cases in task building</name>
  <files>src/Events/Services/TaskManager.php</files>
  <action>
Update buildTasksFromEvents() and buildAgentOrderTask() to handle edge cases:

1. In buildAgentOrderTask():
   - Check order_nr explicitly: `$orderNr !== null && $orderNr !== ''`
   - Empty string is INCOMPLETE (status = open)
   - Null is INCOMPLETE (status = open)
   - Non-empty string is COMPLETED (status = completed)

2. In buildTasksFromEvents():
   - If event_dates is null: treat as empty array
   - If event_dates is invalid JSON: treat as empty array (log warning via wecoza_log)
   - If event_dates is empty string: treat as empty array
   - Result: Class with no events still returns TaskCollection with Agent Order Number task

3. In buildEventTask():
   - If event['type'] is missing/empty: use 'Unknown Event' as fallback
   - Trim description before checking if empty
   - Handle missing 'status' field (default to 'Pending')
   - Handle missing 'notes' field (default to null)

PITFALL from research: Do NOT filter events in SQL - PostgreSQL has no JSONB statistics. Do PHP filtering after fetch.
  </action>
  <verify>
Test edge cases:
```php
$tm = new \WeCoza\Events\Services\TaskManager();

// Empty event_dates
$class1 = ['order_nr' => '', 'event_dates' => null];
$tasks1 = $tm->buildTasksFromEvents($class1);
var_dump(count($tasks1->all())); // 1 (only Agent Order Number)
var_dump($tasks1->get('agent-order')->getStatus()); // 'open' (empty string = incomplete)

// Order number set
$class2 = ['order_nr' => 'ORD-123', 'event_dates' => '[]'];
$tasks2 = $tm->buildTasksFromEvents($class2);
var_dump($tasks2->get('agent-order')->getStatus()); // 'completed'
var_dump($tasks2->get('agent-order')->getNote()); // 'ORD-123'

// Invalid JSON
$class3 = ['order_nr' => null, 'event_dates' => 'not json'];
$tasks3 = $tm->buildTasksFromEvents($class3);
var_dump(count($tasks3->all())); // 1 (Agent Order Number only, bad JSON ignored)
```
  </verify>
  <done>
Edge cases handled: null/empty event_dates, empty order_nr, invalid JSON, missing event fields.
  </done>
</task>

</tasks>

<verification>
1. TaskManager::buildTasksFromEvents() exists and is public
2. Method returns TaskCollection instance
3. Agent Order Number task always present (ID: 'agent-order')
4. Event tasks have IDs 'event-0', 'event-1', etc.
5. Task labels formatted correctly
6. Status derived from event['status'] and order_nr presence
7. All existing methods still work (backward compatibility)
</verification>

<success_criteria>
- buildTasksFromEvents($class) returns TaskCollection with correct tasks
- Agent Order Number status derived from order_nr field
- Event task labels format as "{type}: {description}" or "{type}"
- Empty/null event_dates returns collection with only Agent Order Number
- Existing trigger-based methods still functional (no breaking changes)
</success_criteria>

<output>
After completion, create `.planning/phases/14-task-system-refactor/14-01-SUMMARY.md`
</output>
