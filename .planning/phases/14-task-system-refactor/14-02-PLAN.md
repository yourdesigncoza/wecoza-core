---
phase: 14-task-system-refactor
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/Events/Repositories/ClassTaskRepository.php
  - src/Events/Services/ClassTaskService.php
autonomous: true

must_haves:
  truths:
    - "ClassTaskRepository queries classes table directly (no JOIN to class_change_logs)"
    - "ClassTaskRepository returns event_dates and order_nr fields"
    - "ClassTaskService uses buildTasksFromEvents() instead of getTasksWithTemplate()"
    - "All classes appear in dashboard (even those with zero events)"
  artifacts:
    - path: "src/Events/Repositories/ClassTaskRepository.php"
      provides: "Direct class queries with event_dates"
      contains: "event_dates"
    - path: "src/Events/Services/ClassTaskService.php"
      provides: "Orchestration using new TaskManager methods"
      contains: "buildTasksFromEvents"
  key_links:
    - from: "src/Events/Services/ClassTaskService.php"
      to: "src/Events/Services/TaskManager.php::buildTasksFromEvents"
      via: "method call"
      pattern: "taskManager->buildTasksFromEvents"
    - from: "src/Events/Services/ClassTaskService.php"
      to: "src/Events/Repositories/ClassTaskRepository.php"
      via: "repository fetch"
      pattern: "repository->fetchClasses"
---

<objective>
Update ClassTaskRepository and ClassTaskService to use new event-based task building.

Purpose: Complete the wiring from database to TaskManager using new architecture.
Output: Repository and service using direct class queries and buildTasksFromEvents().
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-task-system-refactor/14-RESEARCH.md
@.planning/phases/14-task-system-refactor/14-01-SUMMARY.md

@src/Events/Repositories/ClassTaskRepository.php
@src/Events/Services/ClassTaskService.php
@src/Events/Services/TaskManager.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify ClassTaskRepository to query classes directly</name>
  <files>src/Events/Repositories/ClassTaskRepository.php</files>
  <action>
Refactor fetchClasses() method to:

1. Remove the LATERAL JOIN to class_change_logs - no longer needed
2. Add `c.event_dates` and `c.order_nr` to the SELECT list
3. Keep all existing class fields (class_id, client_id, class_type, class_code, etc.)
4. Keep LEFT JOINs to clients and agents - still needed for display

Updated SQL structure:
```sql
SELECT
    c.class_id,
    c.client_id,
    c.class_type,
    c.class_subject,
    c.class_code,
    c.original_start_date,
    c.initial_class_agent,
    c.class_agent,
    ia.agent_id AS initial_agent_id,
    ia.first_name AS initial_agent_first,
    ia.surname AS initial_agent_surname,
    ia.initials AS initial_agent_initials,
    pa.agent_id AS primary_agent_id,
    pa.first_name AS primary_agent_first,
    pa.surname AS primary_agent_surname,
    pa.initials AS primary_agent_initials,
    c.exam_class,
    c.exam_type,
    c.seta_funded,
    COALESCE(c.seta, cl.seta) AS seta_name,
    c.stop_restart_dates,
    c.updated_at,
    c.order_nr,         -- NEW: For Agent Order Number task
    c.event_dates,      -- NEW: For event tasks
    cl.client_name
FROM classes c
LEFT JOIN clients cl ON cl.client_id = c.client_id
LEFT JOIN agents ia ON ia.agent_id = c.initial_class_agent
LEFT JOIN agents pa ON pa.agent_id = c.class_agent
{$whereClause}
ORDER BY c.original_start_date {$orderDirection} NULLS LAST, c.class_id {$orderDirection}
LIMIT :limit;
```

REMOVE these lines:
- The LATERAL JOIN block (lines ~91-98 in current file)
- References to l.log_id, l.operation, l.changed_at

Update getAllowedOrderColumns() and getAllowedFilterColumns() to remove log-related columns:
- Remove: 'log_id', 'operation', 'changed_at'
- Keep: 'class_id', 'original_start_date'

Also update static $table and $primaryKey:
- $table = 'classes' (was 'class_change_logs')
- $primaryKey = 'class_id' (was 'log_id')
  </action>
  <verify>
```php
$repo = new \WeCoza\Events\Repositories\ClassTaskRepository();
$classes = $repo->fetchClasses(5, 'desc', null);
var_dump(array_keys($classes[0] ?? [])); // Should include 'event_dates', 'order_nr'
var_dump(isset($classes[0]['log_id'])); // Should be false (removed)
```
  </verify>
  <done>
ClassTaskRepository queries classes table directly, returns event_dates and order_nr, no JOIN to change logs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ClassTaskService to use buildTasksFromEvents()</name>
  <files>src/Events/Services/ClassTaskService.php</files>
  <action>
Refactor getClassTasks() method to:

1. Remove TaskTemplateRegistry dependency from constructor and class property
   - Remove: `private TaskTemplateRegistry $templateRegistry;`
   - Remove: `$this->templateRegistry = $templateRegistry ?? new TaskTemplateRegistry();`

2. Update getClassTasks() loop:
   - REMOVE: Check for log_id and skip if missing
   - REMOVE: Get operation from row
   - REMOVE: Call to getTasksWithTemplate()
   - ADD: Call to buildTasksFromEvents($row)
   - KEEP: All classes manageable (no skip logic)

Updated loop structure:
```php
$items = [];
foreach ($rows as $row) {
    // Build tasks from event_dates (no log_id needed)
    $tasks = $this->taskManager->buildTasksFromEvents($row);

    $items[] = [
        'row' => $row,
        'tasks' => $tasks,
        'class_id' => (int) $row['class_id'],
        'manageable' => true,  // All classes manageable now
        'open_count' => count($tasks->open()),
    ];
}
```

REMOVE from return array:
- 'log_id' key
- 'operation' key

CRITICAL: This means ALL classes appear in dashboard, even those with no events. The only task they'll have is Agent Order Number.
  </action>
  <verify>
```php
$service = new \WeCoza\Events\Services\ClassTaskService();
$result = $service->getClassTasks(5, 'desc', false, null);

// Verify structure
var_dump(isset($result[0]['log_id'])); // Should be false (removed)
var_dump(isset($result[0]['operation'])); // Should be false (removed)
var_dump(isset($result[0]['class_id'])); // Should be true
var_dump($result[0]['manageable']); // Should be true

// Verify tasks built
$tasks = $result[0]['tasks'] ?? null;
var_dump($tasks instanceof \WeCoza\Events\Models\TaskCollection); // true
var_dump($tasks->has('agent-order')); // true (always present)
```
  </verify>
  <done>
ClassTaskService uses buildTasksFromEvents(), no log_id dependency, all classes appear in dashboard.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update tests to reflect new architecture</name>
  <files>tests/Events/TaskManagementTest.php</files>
  <action>
Update TaskManagementTest.php to verify new architecture instead of old trigger-based system:

1. REMOVE tests that check for:
   - class_change_logs table existence
   - PostgreSQL trigger existence (classes_log_insert_update)
   - log_class_change() function existence
   - TaskTemplateRegistry templates

2. UPDATE tests to verify:
   - TaskManager::buildTasksFromEvents() method exists
   - ClassTaskRepository::fetchClasses() returns event_dates field
   - ClassTaskService::getClassTasks() returns items without log_id

3. ADD new tests:
   - Test buildTasksFromEvents() with sample class data
   - Test Agent Order Number always present
   - Test event task ID format (event-{index})

Update the requirements verification section at bottom:
```php
$requirements = [
    'TASK-01' => 'TaskManager builds tasks from event_dates JSONB',
    'TASK-02' => 'Agent Order Number always present with order_nr status',
    'TASK-03' => 'Task IDs: agent-order and event-{index}',
    'TASK-04' => 'Task labels: {type}: {description} or {type}',
    'REPO-01' => 'ClassTaskRepository queries classes directly',
    'REPO-02' => 'ClassTaskService uses buildTasksFromEvents()'
];
```
  </action>
  <verify>
Run test file:
```bash
wp eval-file tests/Events/TaskManagementTest.php --path=/opt/lampp/htdocs/wecoza
```
Should pass with updated requirements verification.
  </verify>
  <done>
Tests updated to verify new event-based task architecture, old trigger-based tests removed.
  </done>
</task>

</tasks>

<verification>
1. ClassTaskRepository.fetchClasses() returns rows with event_dates and order_nr
2. No LATERAL JOIN to class_change_logs in repository SQL
3. ClassTaskService.getClassTasks() calls buildTasksFromEvents()
4. Service return array has class_id but not log_id
5. All classes appear in result (no skip logic)
6. Tests pass with new architecture
</verification>

<success_criteria>
- Repository query is simpler (no JOIN to change logs)
- Service uses new TaskManager methods
- All classes visible in dashboard (manageable=true always)
- Return structure has class_id, tasks, open_count (no log_id, operation)
- Tests verify new requirements TASK-01..04, REPO-01..02
</success_criteria>

<output>
After completion, create `.planning/phases/14-task-system-refactor/14-02-SUMMARY.md`
</output>
