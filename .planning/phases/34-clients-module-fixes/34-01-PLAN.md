---
phase: 34-clients-module-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - views/clients/components/client-update-form.view.php
  - views/clients/components/client-capture-form.view.php
  - src/Clients/Repositories/ClientRepository.php
  - src/Clients/Ajax/ClientAjaxHandlers.php
autonomous: true

must_haves:
  truths:
    - "Client update form fires exactly one AJAX request per submit (no duplicate)"
    - "Client capture form includes wp_nonce_field for non-AJAX fallback"
    - "All client forms and controllers use clients_nonce_action as nonce action string"
    - "client_town_id does not appear in ClientRepository insert/update whitelists"
    - "7 unused AJAX endpoints are deregistered and their handler methods removed"
  artifacts:
    - path: "views/clients/components/client-update-form.view.php"
      provides: "Update form without inline submit handler, nonce action fixed to clients_nonce_action"
      contains: "wp_nonce_field('clients_nonce_action'"
    - path: "views/clients/components/client-capture-form.view.php"
      provides: "Capture form with wp_nonce_field for non-AJAX fallback"
      contains: "wp_nonce_field('clients_nonce_action'"
    - path: "src/Clients/Repositories/ClientRepository.php"
      provides: "Clean column whitelists without phantom client_town_id"
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "Only active AJAX endpoints registered (10 kept, 7 removed)"
  key_links:
    - from: "views/clients/components/client-update-form.view.php"
      to: "src/Clients/Controllers/ClientsController.php"
      via: "wp_nonce_field action must match wp_verify_nonce action"
      pattern: "clients_nonce_action"
    - from: "views/clients/components/client-capture-form.view.php"
      to: "src/Clients/Controllers/ClientsController.php"
      via: "wp_nonce_field action must match wp_verify_nonce action"
      pattern: "clients_nonce_action"
    - from: "assets/js/clients/client-capture.js"
      to: "src/Clients/Ajax/ClientAjaxHandlers.php"
      via: "JS submit handler calls wecoza_save_client which must remain registered"
      pattern: "wecoza_save_client"
---

<objective>
Fix all 5 CLT requirements in the Clients module: remove duplicate AJAX submission, add missing nonce field, remove phantom column from whitelists, unify nonce actions, and delete unused AJAX endpoints.

Purpose: Eliminate duplicate AJAX calls on every client update, fix broken non-AJAX fallback on capture form, reduce attack surface by removing 7 unused endpoints, and clean dead code from repository whitelists.

Output: 4 modified files with all client form wiring issues resolved.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-clients-module-fixes/34-RESEARCH.md
@docs/formfieldanalysis/clients-audit.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix forms - remove inline handler, add nonce field, unify nonce action (CLT-01, CLT-02, CLT-04)</name>
  <files>
    views/clients/components/client-update-form.view.php
    views/clients/components/client-capture-form.view.php
  </files>
  <action>
**client-update-form.view.php** (3 changes):

1. **CLT-04 (nonce action fix):** On line 122, change:
   ```php
   <?php wp_nonce_field('wecoza_clients_ajax', 'nonce'); ?>
   ```
   to:
   ```php
   <?php wp_nonce_field('clients_nonce_action', 'nonce'); ?>
   ```
   This aligns the update form nonce with what `ClientsController::updateClientShortcode()` line 215 and all AJAX handlers expect (`clients_nonce_action`).

2. **CLT-01 (remove duplicate submit handler):** Delete the ENTIRE inline `<script>` block at lines 401-607. This block contains:
   - A duplicate `form.addEventListener('submit', ...)` using Fetch API (lines 407-446) that fires alongside `client-capture.js`'s jQuery handler, causing TWO AJAX requests per submit. The Fetch handler also lacks the `action` FormData field, so it fails silently while the jQuery handler succeeds.
   - Sub-client checkbox toggle logic (lines 448-479) -- this is ALSO duplicated in `client-capture.js` which handles sub-client toggling via jQuery.
   - Province/Town/Suburb cascade logic (lines 482-605) -- this is ALSO handled by `client-capture.js` which manages location dropdowns.

   After deletion, the `</form>` closing tag at line 398 should be followed only by `</div>` (the container close). The external `client-capture.js` already handles ALL of this functionality (form submission, sub-client toggle, location cascade) for both create and update forms.

3. **Verify no orphaned references:** After removing the inline script, ensure the form still has its `id="clients-form"` (line 121) and `novalidate` attribute that `client-capture.js` depends on.

**client-capture-form.view.php** (1 change):

4. **CLT-02 + CLT-04 (add nonce field):** After line 117 (`<form id="clients-form" ...>`), add:
   ```php
   <?php wp_nonce_field('clients_nonce_action', 'nonce'); ?>
   ```
   This provides non-AJAX fallback compatibility. Currently the capture form has NO `wp_nonce_field()`, so if JavaScript is disabled, the form POST fails the nonce check in `ClientsController::captureClientShortcode()` line 407. The action string `clients_nonce_action` matches the controller verification.

**DO NOT modify** `client-capture.js` -- it already uses the correct nonce from `wp_localize_script` (`wecozaClients.nonce`) which is generated with `wp_create_nonce('clients_nonce_action')` in `ClientsController` line 81.

**DO NOT modify** LocationsController or location forms -- the `submit_locations_form` nonce action for locations is a separate concern not in scope for Phase 34 (per research: "NOT in scope for Phase 34").
  </action>
  <verify>
1. `grep -n "wecoza_clients_ajax" views/clients/components/client-update-form.view.php` returns NO matches (old nonce action removed)
2. `grep -n "wp_nonce_field('clients_nonce_action'" views/clients/components/client-update-form.view.php` returns exactly 1 match
3. `grep -n "wp_nonce_field('clients_nonce_action'" views/clients/components/client-capture-form.view.php` returns exactly 1 match
4. `grep -c "addEventListener\|\.on('submit'" views/clients/components/client-update-form.view.php` returns 0 (no inline JS handlers remain)
5. `wc -l views/clients/components/client-update-form.view.php` shows significantly fewer lines (~399 instead of ~607, confirming 208 lines of inline script removed)
  </verify>
  <done>
- Update form nonce action is `clients_nonce_action` (matches controller + AJAX handlers)
- Update form has zero inline JavaScript (entire script block removed)
- Capture form has `wp_nonce_field('clients_nonce_action', 'nonce')` for non-AJAX fallback
- `client-capture.js` remains untouched and handles all form functionality
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean repository whitelists and remove unused AJAX endpoints (CLT-03, CLT-05)</name>
  <files>
    src/Clients/Repositories/ClientRepository.php
    src/Clients/Ajax/ClientAjaxHandlers.php
  </files>
  <action>
**ClientRepository.php** (CLT-03 -- 2 deletions):

1. In `getAllowedInsertColumns()` (line 82): Remove `'client_town_id',` from the return array. This column does NOT exist in the `clients` database table. Location data is stored via `SitesModel::saveHeadSite()` using `place_id` in the `sites` table, not directly on the clients table.

2. In `getAllowedUpdateColumns()` (line 108): Remove `'client_town_id',` from the return array. Same reason -- phantom column that doesn't exist in schema.

**ClientAjaxHandlers.php** (CLT-05 -- remove 7 endpoints):

3. In `registerHandlers()`, remove these 7 `add_action` lines:
   - Line 39: `add_action('wp_ajax_wecoza_get_main_clients', ...)` -- dropdown populated server-side, not via AJAX
   - Line 43: `add_action('wp_ajax_wecoza_save_location', ...)` -- handler returns "Not implemented yet"
   - Line 47: `add_action('wp_ajax_wecoza_save_sub_site', ...)`
   - Line 48: `add_action('wp_ajax_wecoza_get_head_sites', ...)`
   - Line 49: `add_action('wp_ajax_wecoza_get_sub_sites', ...)`
   - Line 50: `add_action('wp_ajax_wecoza_delete_sub_site', ...)`
   - Line 51: `add_action('wp_ajax_wecoza_get_sites_hierarchy', ...)`

   Grep confirmed ZERO JavaScript calls to any of these 7 action names across all `assets/js/` files.

4. Remove the corresponding 7 handler methods:
   - `getMainClients()` method (lines 371-382)
   - `saveLocation()` method (lines 402-412)
   - `saveSubSite()` method (lines 446-481)
   - `getHeadSites()` method (lines 486-502)
   - `getSubSites()` method (lines 507-523)
   - `deleteSubSite()` method (lines 528-550)
   - `getSitesHierarchy()` method (lines 555-571)

5. **KEEP** these 10 active endpoints and their methods:
   - `wecoza_save_client` (saveClient)
   - `wecoza_get_client` (getClient)
   - `wecoza_get_client_details` (getClientDetails)
   - `wecoza_delete_client` (deleteClient)
   - `wecoza_search_clients` (searchClients)
   - `wecoza_get_branch_clients` (getBranchClients)
   - `wecoza_export_clients` (exportClients)
   - `wecoza_get_locations` (getLocations)
   - `wecoza_check_location_duplicates` (checkLocationDuplicates)
   - `sanitizeClientFormData` (private helper, used by saveClient)

6. Update the comment blocks in `registerHandlers()` to reflect the cleaned structure:
   ```php
   // Client AJAX handlers
   add_action('wp_ajax_wecoza_save_client', ...);
   add_action('wp_ajax_wecoza_get_client', ...);
   add_action('wp_ajax_wecoza_get_client_details', ...);
   add_action('wp_ajax_wecoza_delete_client', ...);
   add_action('wp_ajax_wecoza_search_clients', ...);
   add_action('wp_ajax_wecoza_get_branch_clients', ...);
   add_action('wp_ajax_wecoza_export_clients', ...);

   // Location AJAX handlers
   add_action('wp_ajax_wecoza_get_locations', ...);
   add_action('wp_ajax_wecoza_check_location_duplicates', ...);
   ```

**DO NOT remove** the `SitesModel` import at the top of `ClientAjaxHandlers.php` -- it's still used by `saveClient()` (line 68) and `getBranchClients()` (line 300).
  </action>
  <verify>
1. `grep -n "client_town_id" src/Clients/Repositories/ClientRepository.php` returns NO matches
2. `grep -c "add_action" src/Clients/Ajax/ClientAjaxHandlers.php` returns 9 (down from 16, confirming 7 removed)
3. `grep -n "wecoza_get_main_clients\|wecoza_save_location\|wecoza_save_sub_site\|wecoza_get_head_sites\|wecoza_get_sub_sites\|wecoza_delete_sub_site\|wecoza_get_sites_hierarchy" src/Clients/Ajax/ClientAjaxHandlers.php` returns NO matches
4. `grep -n "function getMainClients\|function saveLocation\|function saveSubSite\|function getHeadSites\|function getSubSites\|function deleteSubSite\|function getSitesHierarchy" src/Clients/Ajax/ClientAjaxHandlers.php` returns NO matches (handler methods removed)
5. `grep -n "function saveClient\|function getClient\b\|function getClientDetails\|function deleteClient\|function searchClients\|function getBranchClients\|function exportClients\|function getLocations\|function checkLocationDuplicates\|function sanitizeClientFormData" src/Clients/Ajax/ClientAjaxHandlers.php` returns 10 matches (all active handlers preserved)
6. PHP syntax check: `php -l src/Clients/Ajax/ClientAjaxHandlers.php` returns "No syntax errors"
7. PHP syntax check: `php -l src/Clients/Repositories/ClientRepository.php` returns "No syntax errors"
  </verify>
  <done>
- `client_town_id` removed from both insert and update whitelists in ClientRepository
- 7 unused AJAX endpoints deregistered from registerHandlers()
- 7 corresponding handler methods deleted from ClientAjaxHandlers
- 10 active endpoints and their handler methods preserved intact
- No PHP syntax errors in either file
  </done>
</task>

</tasks>

<verification>
Run all verification checks across all 4 modified files:

1. **CLT-01 verified:** `grep -c "<script>" views/clients/components/client-update-form.view.php` returns 0 (inline script block removed)
2. **CLT-02 verified:** `grep "wp_nonce_field" views/clients/components/client-capture-form.view.php` returns match with `clients_nonce_action`
3. **CLT-03 verified:** `grep "client_town_id" src/Clients/Repositories/ClientRepository.php` returns 0 matches
4. **CLT-04 verified:** `grep -r "wecoza_clients_ajax" views/clients/` returns 0 matches AND `grep -r "wp_nonce_field.*clients_nonce_action" views/clients/` returns 2 matches (both forms)
5. **CLT-05 verified:** `grep -c "add_action.*wp_ajax" src/Clients/Ajax/ClientAjaxHandlers.php` returns 9 (was 16, 7 removed)
6. **No regression:** `php -l` passes on all 4 modified files
</verification>

<success_criteria>
1. Client update form fires exactly ONE AJAX request per submit (inline Fetch handler removed, only client-capture.js jQuery handler remains)
2. Client capture form has wp_nonce_field('clients_nonce_action', 'nonce') for non-AJAX fallback
3. Both client forms use 'clients_nonce_action' as nonce action string, matching controllers and AJAX handlers
4. ClientRepository whitelists have no 'client_town_id' entries
5. ClientAjaxHandlers registers exactly 9 endpoints (7 unused removed)
6. All 10 active AJAX handler methods preserved and functional
7. Zero PHP syntax errors across all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/34-clients-module-fixes/34-01-SUMMARY.md`
</output>
