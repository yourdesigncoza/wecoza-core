---
phase: 27-controllers-views-ajax
plan: 03
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - assets/js/agents/agents-app.js
  - assets/js/agents/agent-form-validation.js
  - assets/js/agents/agents-ajax-pagination.js
  - assets/js/agents/agents-table-search.js
  - assets/js/agents/agent-delete.js
autonomous: true

must_haves:
  truths:
    - "All 5 JS files exist in assets/js/agents/"
    - "All JS files reference wecozaAgents (unified localization object)"
    - "All JS files access response.data.* not response.* directly"
    - "All AJAX action names use wecoza_agents_ prefix"
    - "Zero references to old localization objects (agents_nonce, wecoza_agents_ajax, wecoZaAgentsDelete)"
  artifacts:
    - path: "assets/js/agents/agents-app.js"
      provides: "Main agent application JS — form validation, ID toggle"
      contains: "wecozaAgents"
    - path: "assets/js/agents/agent-form-validation.js"
      provides: "SA ID/passport validation, initials generation, Google Places"
      contains: "validateSAID"
    - path: "assets/js/agents/agents-ajax-pagination.js"
      provides: "AJAX pagination for agent table"
      contains: "wecoza_agents_paginate"
    - path: "assets/js/agents/agents-table-search.js"
      provides: "Client-side table search with debouncing"
      contains: "agents_init_table_search"
    - path: "assets/js/agents/agent-delete.js"
      provides: "AJAX delete with confirmation"
      contains: "wecoza_agents_delete"
  key_links:
    - from: "assets/js/agents/agents-ajax-pagination.js"
      to: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      via: "AJAX POST with action wecoza_agents_paginate"
      pattern: "action.*wecoza_agents_paginate"
    - from: "assets/js/agents/agent-delete.js"
      to: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      via: "AJAX POST with action wecoza_agents_delete"
      pattern: "action.*wecoza_agents_delete"
---

<objective>
Migrate all 5 JavaScript files to assets/js/agents/ with unified localization (wecozaAgents), correct response.data.* access pattern, and standardized AJAX action names.

Purpose: Frontend interactivity for agent forms (validation, Google Places), agent table (pagination, search), and agent management (delete).
Output: 5 JavaScript files in assets/js/agents/
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-controllers-views-ajax/27-RESEARCH.md
@.planning/phases/27-controllers-views-ajax/27-01-SUMMARY.md

Source JS (read for migration, do NOT modify):
@.integrate/wecoza-agents-plugin/assets/js/agents-app.js
@.integrate/wecoza-agents-plugin/assets/js/agent-form-validation.js
@.integrate/wecoza-agents-plugin/assets/js/agents-ajax-pagination.js
@.integrate/wecoza-agents-plugin/assets/js/agents-table-search.js
@.integrate/wecoza-agents-plugin/assets/js/agent-delete.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate agents-app.js and agent-form-validation.js</name>
  <files>
assets/js/agents/agents-app.js
assets/js/agents/agent-form-validation.js
  </files>
  <action>
Create the `assets/js/agents/` directory and migrate 2 JS files.

**1. `assets/js/agents/agents-app.js`**

Copy from `.integrate/wecoza-agents-plugin/assets/js/agents-app.js` with these transformations:

**Bug #3 fix — Unified localization:** The source references `wecoza_agents` (snake_case) as the localization object. Replace ALL references:
- `wecoza_agents.ajax_url` → `wecozaAgents.ajaxUrl`
- `wecoza_agents.nonce` → `wecozaAgents.nonce`
- `wecoza_agents.debug` → `wecozaAgents.debug`
- `wecoza_agents.i18n.*` → flatten into `wecozaAgents.*` (e.g., `wecozaAgents.errorText`, `wecozaAgents.loadingText`)

The source agents-app.js is the main application file with:
- Loader container hide after 2 seconds
- Bootstrap form validation (was-validated class)
- SA ID / Passport toggle fields
- Real-time SA ID validation with Luhn checksum
- Real-time passport validation
- Form submit validation integration

**Important:** The source has SA ID validation duplicated between agents-app.js and agent-form-validation.js. The app.js version has the validation inline. agent-form-validation.js has a more comprehensive version with Google Places integration.

**Strategy:** Keep agents-app.js as a lightweight bootstrapper (loader hide, form validation triggers) and let agent-form-validation.js handle the heavy validation. Remove duplicate SA ID validation from agents-app.js if it's already in agent-form-validation.js. OR keep both since they handle different aspects (app.js does toggle + inline validation, form-validation.js does comprehensive field validation + Google Places).

**Preserve:**
- jQuery IIFE wrapper
- `'use strict';`
- All DOM selectors that match view template element IDs (#agents-form, #sa_id_option, #passport_option, #sa_id_field, #passport_field, #sa_id_no, #passport_number)
- Bootstrap 5 validation pattern (was-validated class on submit)

**2. `assets/js/agents/agent-form-validation.js`**

Copy from `.integrate/wecoza-agents-plugin/assets/js/agent-form-validation.js` with transformations:

This file handles:
- `validateSAID()` function (Luhn checksum for 13-digit SA IDs)
- Select2 destruction on agent form (prevent theme conflicts)
- ID type toggle (sa_id vs passport radio buttons)
- Bootstrap needs-validation form handling
- Real-time SA ID validation with custom validity messages
- SA ID input restriction (numbers only, max 13 chars)
- Auto-generate initials from name fields
- Google Places Autocomplete integration (new API + old API fallback)

**Transformations:**
- NO localization object references needed in this file (it's pure client-side validation)
- BUT if it references any localization for AJAX, update to `wecozaAgents.*`
- Preserve all `validateSAID()` logic exactly (checksum algorithm must not change)
- Preserve Google Places integration with both new (`PlaceAutocompleteElement`) and old (`google.maps.places.Autocomplete`) API paths
- Preserve initials generation logic
- Preserve address field population from Google Places (address_line_1, residential_suburb, city_town, postal_code, province_region)
- Keep all DOM selectors matching view template IDs

**No localization changes needed** — this file doesn't reference any localization objects in the source. It uses direct DOM manipulation and the Google Maps API.
  </action>
  <verify>
```bash
ls -la assets/js/agents/agents-app.js
ls -la assets/js/agents/agent-form-validation.js

# Check unified localization in app.js
grep "wecozaAgents" assets/js/agents/agents-app.js
grep "wecoza_agents\b" assets/js/agents/agents-app.js | wc -l       # 0 (old snake_case object gone)
grep "agents_nonce" assets/js/agents/agents-app.js | wc -l           # 0 (old localization object gone)

# Check validation functions preserved
grep "validateSAID\|validateSaId" assets/js/agents/agent-form-validation.js
grep "initializeGooglePlaces" assets/js/agents/agent-form-validation.js
grep "generateInitials" assets/js/agents/agent-form-validation.js
```
  </verify>
  <done>agents-app.js uses unified wecozaAgents localization object. agent-form-validation.js preserves SA ID checksum, Google Places integration, initials generation. Zero old localization references.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate pagination, search, and delete JS files</name>
  <files>
assets/js/agents/agents-ajax-pagination.js
assets/js/agents/agents-table-search.js
assets/js/agents/agent-delete.js
  </files>
  <action>
Migrate 3 JS files with localization unification and response access fixes.

**1. `assets/js/agents/agents-ajax-pagination.js`**

Copy from `.integrate/wecoza-agents-plugin/assets/js/agents-ajax-pagination.js` with transformations:

**Bug #3 fix — Localization unification:**
- `wecoza_agents_ajax.ajax_url` → `wecozaAgents.ajaxUrl`
- `wecoza_agents_ajax.nonce` → `wecozaAgents.paginationNonce`
- `wecoza_agents_ajax.loading_text` → `wecozaAgents.loadingText`
- `wecoza_agents_ajax.error_text` → `wecozaAgents.errorText`

**Bug #10 fix — Action name:**
- `action: 'wecoza_agents_paginate'` — already correct, keep as-is

**Bug #4 fix — Response access:**
- Check all `response.data.*` access patterns — the source already uses `response.success && response.data` pattern correctly. Verify no direct `response.message` or `response.table_html` access.
- Source line 187: `response.data.table_html` — correct
- Source line 190: `response.data.pagination_html` — correct
- Source line 194: `response.data.statistics_html` — correct
- All looks correct. Keep as-is.

**Preserve:**
- jQuery IIFE wrapper with `'use strict'`
- Pagination state object (currentState)
- All SELECTORS constants (#agents-container, #agents-display-data, .fixed-table-pagination, etc.)
- URL history management (pushState)
- Debounced search integration
- Public API (window.WeCozaAgentsAjaxPagination)
- Scroll to table on page change

**2. `assets/js/agents/agents-table-search.js`**

Copy from `.integrate/wecoza-agents-plugin/assets/js/agents-table-search.js` with transformations:

This file does CLIENT-SIDE search only (no AJAX). It filters visible table rows by searching cell text.

- No localization object references in source — no changes needed
- Preserve all search logic (debounce, column matching, status indicator)
- Preserve exportClasses() function (CSV export)
- Preserve public API (window.WeCozaAgentsSearch)
- Preserve all SELECTORS (must match view template element IDs/classes)

**No changes needed** unless source references localization objects. Check and confirm.

**3. `assets/js/agents/agent-delete.js`**

Copy from `.integrate/wecoza-agents-plugin/assets/js/agent-delete.js` with transformations:

**Bug #3 fix — Localization unification:**
- `wecoZaAgentsDelete.ajaxUrl` → `wecozaAgents.ajaxUrl`
- `wecoZaAgentsDelete.nonce` → `wecozaAgents.nonce` (use main nonce, controller verifies with `agents_nonce_action`)
- `wecoZaAgentsDelete.confirmText` → `wecozaAgents.confirmDeleteText`
- `wecoZaAgentsDelete.successText` → `wecozaAgents.deleteSuccessText`
- `wecoZaAgentsDelete.errorText` → `wecozaAgents.deleteErrorText`

**Bug #10 fix — Action name:**
- `action: 'wecoza_delete_agent'` → `action: 'wecoza_agents_delete'` (standardized prefix)

**Bug #4 fix — Response access:**
- Source line 41: `response.success` — correct (WordPress standard)
- Source line 50: `response.data.message` — correct
- Source line 53: `response.data.message` — correct
- All correct. Keep as-is.

**Preserve:**
- jQuery document.ready wrapper
- Event delegation on `button[data-agent-id]` with `.bi-trash` check
- Confirmation dialog
- Button loading state (icon swap)
- Row fadeOut on success
- Statistics update function
- Success/error message display
  </action>
  <verify>
```bash
ls -la assets/js/agents/agents-ajax-pagination.js
ls -la assets/js/agents/agents-table-search.js
ls -la assets/js/agents/agent-delete.js

# Check unified localization
grep "wecozaAgents" assets/js/agents/agents-ajax-pagination.js
grep "wecozaAgents" assets/js/agents/agent-delete.js

# Check NO old localization objects
grep "wecoza_agents_ajax\b" assets/js/agents/agents-ajax-pagination.js | wc -l   # 0
grep "wecoZaAgentsDelete" assets/js/agents/agent-delete.js | wc -l               # 0
grep "agents_nonce\b" assets/js/agents/ -r | wc -l                                # 0

# Check correct AJAX action names
grep "wecoza_agents_paginate" assets/js/agents/agents-ajax-pagination.js
grep "wecoza_agents_delete" assets/js/agents/agent-delete.js

# Check response.data.* pattern (no direct response.message)
grep "response\.message\b" assets/js/agents/ -r | wc -l  # 0
grep "response\.data\." assets/js/agents/ -r | head -5    # should show correct usage
```
  </verify>
  <done>All 3 JS files use unified wecozaAgents localization, correct wecoza_agents_ prefixed action names, response.data.* access pattern, zero old localization references (wecoza_agents_ajax, wecoZaAgentsDelete, agents_nonce).</done>
</task>

</tasks>

<verification>
```bash
# All 5 JS files exist
ls assets/js/agents/agents-app.js
ls assets/js/agents/agent-form-validation.js
ls assets/js/agents/agents-ajax-pagination.js
ls assets/js/agents/agents-table-search.js
ls assets/js/agents/agent-delete.js

# Zero old localization objects across ALL JS files
grep -r "wecoza_agents_ajax\b\|wecoZaAgentsDelete\|agents_nonce\b" assets/js/agents/ | wc -l  # 0

# Unified localization used
grep -r "wecozaAgents\." assets/js/agents/ | head -10  # should show consistent usage

# Correct AJAX action names
grep -r "action.*wecoza_agents_" assets/js/agents/  # should show wecoza_agents_paginate and wecoza_agents_delete

# No direct response property access (Bug #4)
grep -r "response\.message\b\|response\.table_html\b\|response\.pagination_html\b" assets/js/agents/ | wc -l  # 0
```
</verification>

<success_criteria>
- All 5 JS files exist in assets/js/agents/
- All files reference wecozaAgents unified localization object with camelCase keys
- Zero references to old objects (agents_nonce, wecoza_agents_ajax, wecoZaAgentsDelete)
- AJAX pagination uses action: 'wecoza_agents_paginate'
- AJAX delete uses action: 'wecoza_agents_delete'
- All response access uses response.data.* pattern
- SA ID validation (Luhn checksum) preserved exactly
- Google Places integration preserved (new + old API fallback)
- Initials generation preserved
- Client-side table search preserved
- CSV export function preserved
- All DOM selectors match view template element IDs
</success_criteria>

<output>
After completion, create `.planning/phases/27-controllers-views-ajax/27-03-SUMMARY.md`
</output>
