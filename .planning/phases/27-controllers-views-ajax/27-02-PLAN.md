---
phase: 27-controllers-views-ajax
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - views/agents/components/agent-capture-form.view.php
  - views/agents/components/agent-fields.view.php
  - views/agents/display/agent-display-table.view.php
  - views/agents/display/agent-display-table-rows.view.php
  - views/agents/display/agent-pagination.view.php
  - views/agents/display/agent-single-display.view.php
autonomous: true

must_haves:
  truths:
    - "All 6 view templates exist with .view.php extension"
    - "All template includes use wecoza_view() or wecoza_component(), not load_template()"
    - "All views have ABSPATH guard"
    - "FormHelpers references use WeCoza\\Agents\\Helpers\\FormHelpers namespace"
    - "No WECOZA_AGENTS_* constants or wecoza_agents_log() references"
  artifacts:
    - path: "views/agents/components/agent-capture-form.view.php"
      provides: "Agent add/edit form with all fields, file uploads, validation"
      contains: "wp_nonce_field"
    - path: "views/agents/components/agent-fields.view.php"
      provides: "Reusable field partials for agent form"
      contains: "FormHelpers"
    - path: "views/agents/display/agent-display-table.view.php"
      provides: "Main agent list table with search, stats, pagination"
      contains: "agents-container"
    - path: "views/agents/display/agent-display-table-rows.view.php"
      provides: "Table row partial for AJAX refresh"
      contains: "esc_html"
    - path: "views/agents/display/agent-pagination.view.php"
      provides: "Pagination controls partial for AJAX refresh"
      contains: "page-link"
    - path: "views/agents/display/agent-single-display.view.php"
      provides: "Single agent detail view"
      contains: "back_url"
  key_links:
    - from: "views/agents/display/agent-display-table.view.php"
      to: "views/agents/display/agent-display-table-rows.view.php"
      via: "wecoza_view include for table rows"
      pattern: "wecoza_view.*agent-display-table-rows"
    - from: "views/agents/display/agent-display-table.view.php"
      to: "views/agents/display/agent-pagination.view.php"
      via: "wecoza_view include for pagination"
      pattern: "wecoza_view.*agent-pagination"
    - from: "views/agents/components/agent-fields.view.php"
      to: "standalone utility partial"
      via: "helper functions for form field rendering (not included by capture form)"
      pattern: "wecoza_agents_render_text_field"
---

<objective>
Migrate all 6 view templates from the standalone agents plugin to wecoza-core's `views/agents/` directory using `.view.php` extension and `wecoza_view()` pattern.

Purpose: Templates provide the HTML output for all 3 shortcodes and AJAX partial responses.
Output: 6 view template files in views/agents/components/ and views/agents/display/
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-controllers-views-ajax/27-RESEARCH.md
@.planning/phases/27-controllers-views-ajax/27-01-SUMMARY.md

Source templates (read for migration, do NOT modify):
@.integrate/wecoza-agents-plugin/templates/forms/agent-capture-form.php
@.integrate/wecoza-agents-plugin/templates/partials/agent-fields.php
@.integrate/wecoza-agents-plugin/templates/display/agent-display-table.php
@.integrate/wecoza-agents-plugin/templates/display/agent-display-table-rows.php
@.integrate/wecoza-agents-plugin/templates/display/agent-pagination.php
@.integrate/wecoza-agents-plugin/templates/display/agent-single-display.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate form component views (capture form + fields)</name>
  <files>
views/agents/components/agent-capture-form.view.php
views/agents/components/agent-fields.view.php
  </files>
  <action>
Create the `views/agents/components/` directory and migrate 2 form templates.

**1. `views/agents/components/agent-capture-form.view.php`**

Copy from `.integrate/wecoza-agents-plugin/templates/forms/agent-capture-form.php` with these transformations:

- Add ABSPATH guard at top: `if (!defined('ABSPATH')) { exit; }`
- Change namespace import: `use WeCoza\Agents\Helpers\FormHelpers;` (same — already correct in source)
- Keep all existing HTML structure, form fields, and FormHelpers calls
- Change text domain: ALL `'wecoza-agents-plugin'` instances → `'wecoza-core'`
- The capture form does NOT include agent-fields.php via load_template (verified: all form fields are inline in agent-capture-form.php). No template include replacement needed for this file.
- Preserve all FormHelpers calls: `FormHelpers::get_field_value()`, `FormHelpers::get_error_class()`, `FormHelpers::display_field_error()`
- Preserve `wp_nonce_field('submit_agent_form', 'wecoza_agents_form_nonce');`
- Preserve `selected()`, `esc_attr()`, `esc_html()` calls
- Preserve form ID `agents-form` (JS depends on it)
- Preserve `enctype="multipart/form-data"` for file uploads
- Preserve all CSS classes (Bootstrap 5 + ydcoza-compact-form)
- The `$agent`, `$errors`, `$mode`, `$atts`, `$working_areas` variables are passed by the controller

**2. `views/agents/components/agent-fields.view.php`**

The source file `.integrate/wecoza-agents-plugin/templates/partials/agent-fields.php` EXISTS (verified, 13KB). It contains reusable helper functions for rendering form field components (`wecoza_agents_render_text_field`, `wecoza_agents_render_select_field`, etc.). The capture form does NOT include this file — it uses FormHelpers directly. However, this file is still valuable as a utility partial.

Copy from `.integrate/wecoza-agents-plugin/templates/partials/agent-fields.php` with these transformations:
- ABSPATH guard
- Text domain change: `'wecoza-agents-plugin'` → `'wecoza-core'`
- Rename helper functions from `wecoza_agents_render_*` to `wecoza_render_agent_*` to match core naming convention (or keep as-is since they're wrapped in `function_exists` guards)
- No template include calls needed (this is a leaf utility file)
- Keep all form field rendering helper functions
  </action>
  <verify>
```bash
ls -la views/agents/components/
php -l views/agents/components/agent-capture-form.view.php
php -l views/agents/components/agent-fields.view.php
grep "ABSPATH" views/agents/components/agent-capture-form.view.php
grep "FormHelpers" views/agents/components/agent-capture-form.view.php
grep "wecoza-agents-plugin" views/agents/components/agent-capture-form.view.php | wc -l  # expect 0
grep "load_template" views/agents/components/agent-capture-form.view.php | wc -l  # expect 0
```
  </verify>
  <done>Both form component views exist with .view.php extension, ABSPATH guards, correct text domain (wecoza-core), FormHelpers integration, and wecoza_view() for any template includes.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate display views (table, rows, pagination, single)</name>
  <files>
views/agents/display/agent-display-table.view.php
views/agents/display/agent-display-table-rows.view.php
views/agents/display/agent-pagination.view.php
views/agents/display/agent-single-display.view.php
  </files>
  <action>
Create the `views/agents/display/` directory and migrate 4 display templates.

**1. `views/agents/display/agent-display-table.view.php`**

Copy from `.integrate/wecoza-agents-plugin/templates/display/agent-display-table.php` with transformations:
- ABSPATH guard
- Text domain: `'wecoza-agents-plugin'` → `'wecoza-core'`
- Template includes:
  - OLD: `$this->load_template('agent-display-table-rows.php', [...], 'display')`
  - NEW: `echo wecoza_view('agents/display/agent-display-table-rows', [...], true);`
  - OLD: `$this->load_template('agent-pagination.php', [...], 'display')`
  - NEW: `echo wecoza_view('agents/display/agent-pagination', [...], true);`
- Remove any `$this->get_edit_url()`, `$this->get_view_url()`, `$this->get_sort_url()` calls. These should be replaced with:
  - Edit URL: `add_query_arg(['update' => '', 'agent_id' => $agent['id']], home_url('/new-agents/'))`
  - View URL: `add_query_arg('agent_id', $agent['id'], home_url('/app/agent-view/'))`
  - Sort URL: `add_query_arg(['orderby' => $column, 'order' => $new_order])`
  - OR: pass these URLs as template variables from the controller (preferred — controller computes, view displays)
- Keep all HTML structure: Bootstrap table, search input, statistics badges, etc.
- Keep element IDs that JS depends on: `#agents-container`, `#agents-display-data`, `#alert-container`, `.search-input`, `.fixed-table-pagination`
- Preserve data attributes JS depends on: `data-sortable="true"`, `data-page`, `data-per-page`
- The `$agents`, `$total_agents`, `$current_page`, `$per_page`, `$total_pages`, `$start_index`, `$end_index`, `$search_query`, `$sort_column`, `$sort_order`, `$columns`, `$atts`, `$can_manage`, `$statistics` variables are passed from controller

**2. `views/agents/display/agent-display-table-rows.view.php`**

Copy from `.integrate/wecoza-agents-plugin/templates/display/agent-display-table-rows.php`:
- ABSPATH guard
- Text domain change
- This is a partial used by both initial render and AJAX pagination refresh
- Keep all `esc_html()` output escaping
- Uses mapped agent fields ($agent['id'], $agent['first_name'], $agent['last_name'], etc.)
- Action buttons: View, Edit, Delete with correct URLs
- Delete button: `data-agent-id="<?php echo esc_attr($agent['id']); ?>"` (JS delete handler depends on this)
- Variables: `$agents`, `$columns`, `$can_manage`, `$show_actions`

**3. `views/agents/display/agent-pagination.view.php`**

Copy from `.integrate/wecoza-agents-plugin/templates/display/agent-pagination.php`:
- ABSPATH guard
- Text domain change
- Keep pagination structure with `data-page` attributes for AJAX pagination JS
- Keep per-page dropdown with `data-per-page` attributes
- Variables: `$current_page`, `$total_pages`, `$per_page`, `$start_index`, `$end_index`, `$total_agents`

**4. `views/agents/display/agent-single-display.view.php`**

Copy from `.integrate/wecoza-agents-plugin/templates/display/agent-single-display.php`:
- ABSPATH guard
- Text domain change
- Replace any `$this->format_date()` calls with `date_i18n($date_format, strtotime($date))` or pass pre-formatted dates from controller
- Replace `$this->format_phone()` with inline formatting or pass from controller
- Keep back button with `$back_url`
- Variables: `$agent_id`, `$agent`, `$error`, `$back_url`, `$can_manage`, `$date_format`

**CRITICAL for ALL views:**
- NO `$this->` references (views are standalone files, not class methods)
- NO `load_template()` calls — use `wecoza_view()` or `wecoza_component()`
- NO `WECOZA_AGENTS_*` constants
- NO `wecoza_agents_log()` — use `wecoza_log()` if needed
- ALL variables come from `extract($data)` in wecoza_view() — they're automatically available
  </action>
  <verify>
```bash
ls -la views/agents/display/
php -l views/agents/display/agent-display-table.view.php
php -l views/agents/display/agent-display-table-rows.view.php
php -l views/agents/display/agent-pagination.view.php
php -l views/agents/display/agent-single-display.view.php

# Check all views have ABSPATH guard
grep -c "ABSPATH" views/agents/display/*.view.php  # 4 files, each should have 1

# No legacy references
grep -r "load_template" views/agents/ --include="*.php" | wc -l           # 0
grep -r "WECOZA_AGENTS_" views/agents/ --include="*.php" | wc -l          # 0
grep -r "wecoza-agents-plugin" views/agents/ --include="*.php" | wc -l    # 0
grep -r '$this->' views/agents/ --include="*.php" | wc -l                  # 0
```
  </verify>
  <done>All 4 display views exist with .view.php extension, ABSPATH guards, correct text domain, wecoza_view() for includes, zero $this-> references, zero legacy constants, and proper data variable usage.</done>
</task>

</tasks>

<verification>
```bash
# All 6 views exist
ls views/agents/components/agent-capture-form.view.php
ls views/agents/components/agent-fields.view.php
ls views/agents/display/agent-display-table.view.php
ls views/agents/display/agent-display-table-rows.view.php
ls views/agents/display/agent-pagination.view.php
ls views/agents/display/agent-single-display.view.php

# All pass syntax check
find views/agents/ -name "*.view.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"

# No legacy references across all views
grep -r "load_template\|WECOZA_AGENTS_\|wecoza-agents-plugin\|wecoza_agents_log" views/agents/ --include="*.php" | wc -l  # 0

# No $this-> references (views are standalone)
grep -r '$this->' views/agents/ --include="*.php" | wc -l  # 0

# All have ABSPATH guard
find views/agents/ -name "*.view.php" -exec grep -L "ABSPATH" {} \;  # should return nothing
```
</verification>

<success_criteria>
- All 6 view files exist in views/agents/ with .view.php extension
- All views have ABSPATH guard
- All template includes use wecoza_view() pattern
- Zero load_template(), $this->, WECOZA_AGENTS_*, wecoza-agents-plugin references
- FormHelpers calls preserved with correct WeCoza\Agents\Helpers namespace
- All element IDs preserved for JS compatibility (agents-form, agents-container, agents-display-data, etc.)
- All data attributes preserved for JS (data-agent-id, data-page, data-per-page, data-sortable)
- All PHP files pass syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/27-controllers-views-ajax/27-02-SUMMARY.md`
</output>
