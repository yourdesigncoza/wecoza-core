---
phase: 27-controllers-views-ajax
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Agents/Controllers/AgentsController.php
  - src/Agents/Ajax/AgentsAjaxHandlers.php
  - wecoza-core.php
autonomous: true

must_haves:
  truths:
    - "AgentsController extends BaseController and registers 3 shortcodes"
    - "AgentsAjaxHandlers registers 2 AJAX endpoints with AjaxSecurity pattern"
    - "wecoza-core.php initializes both AgentsController and AgentsAjaxHandlers"
    - "Zero nopriv AJAX handlers registered anywhere"
    - "Unified wecozaAgents localization object with camelCase keys"
    - "Assets enqueued conditionally via shouldEnqueueAssets()"
  artifacts:
    - path: "src/Agents/Controllers/AgentsController.php"
      provides: "Controller with 3 shortcodes, asset enqueuing, localization"
      contains: "extends BaseController"
    - path: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      provides: "AJAX handlers for paginate and delete with AjaxSecurity"
      contains: "AjaxSecurity::requireNonce"
    - path: "wecoza-core.php"
      provides: "Module initialization for Agents"
      contains: "AgentsController"
  key_links:
    - from: "src/Agents/Controllers/AgentsController.php"
      to: "src/Agents/Repositories/AgentRepository.php"
      via: "getRepository() lazy loader"
      pattern: "new AgentRepository"
    - from: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      to: "src/Agents/Repositories/AgentRepository.php"
      via: "constructor injection"
      pattern: "new AgentRepository"
    - from: "wecoza-core.php"
      to: "src/Agents/Controllers/AgentsController.php"
      via: "new instantiation in plugins_loaded"
      pattern: "new.*AgentsController"
---

<objective>
Create the PHP backbone for the Agents module: controller with 3 shortcodes, standalone AJAX handlers with AjaxSecurity pattern, and wecoza-core.php wiring.

Purpose: Establish the MVC entry points that connect Phase 26's data layer (AgentRepository + AgentModel) to the frontend (views + JS coming in Plans 02/03).
Output: AgentsController.php, AgentsAjaxHandlers.php, wecoza-core.php wiring
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-foundation-architecture/26-02-SUMMARY.md
@.planning/phases/27-controllers-views-ajax/27-RESEARCH.md

Source files (read for migration, do NOT modify):
@.integrate/wecoza-agents-plugin/src/Shortcodes/CaptureAgentShortcode.php
@.integrate/wecoza-agents-plugin/src/Shortcodes/DisplayAgentShortcode.php
@.integrate/wecoza-agents-plugin/src/Shortcodes/SingleAgentShortcode.php
@.integrate/wecoza-agents-plugin/src/Shortcodes/AbstractShortcode.php

Existing patterns (reference only):
@core/Abstract/BaseController.php
@core/Helpers/AjaxSecurity.php
@wecoza-core.php (lines 159-243 for module init pattern)
@src/Clients/Controllers/ClientsController.php (recent reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1a: Create AgentsController skeleton — shortcode renderers, asset enqueuing, and localization</name>
  <files>src/Agents/Controllers/AgentsController.php</files>
  <action>
Create `src/Agents/Controllers/AgentsController.php` extending BaseController. This task builds the controller skeleton with all public-facing methods. Task 1b will add the private form-handling helpers.

**Namespace:** `WeCoza\Agents\Controllers`

**Imports:**
- `WeCoza\Core\Abstract\BaseController`
- `WeCoza\Agents\Repositories\AgentRepository`
- `WeCoza\Agents\Models\AgentModel`
- `WeCoza\Agents\Services\WorkingAreasService`
- `WeCoza\Agents\Helpers\FormHelpers`
- `WeCoza\Agents\Helpers\ValidationHelper`

**Properties:**
- `private ?AgentRepository $repository = null;`

**registerHooks():**
- `add_action('init', [$this, 'registerShortcodes']);`
- `add_action('wp_enqueue_scripts', [$this, 'enqueueAssets']);`
- NO AJAX registrations here (those go in AgentsAjaxHandlers)

**registerShortcodes():**
- `add_shortcode('wecoza_capture_agents', [$this, 'renderCaptureForm']);`
- `add_shortcode('wecoza_display_agents', [$this, 'renderAgentsList']);`
- `add_shortcode('wecoza_single_agent', [$this, 'renderSingleAgent']);`

**getRepository():** Lazy-load pattern (create if null, return).

**renderCaptureForm($atts):**
Migrate from CaptureAgentShortcode. Key logic:
- `shortcode_atts(['mode' => 'add', 'agent_id' => 0, 'redirect_after_save' => ''], $atts)`
- Detect agent_id from URL (check `$_GET['update']` + `$_GET['agent_id']`, or `$_GET['agent_id']` directly, or shortcode atts)
- If edit mode + agent_id > 0: load agent via `$this->getRepository()->getAgent($agent_id)`
- Handle form submission if POST + nonce valid:
  - Call `$this->collectFormData()` to sanitize POST data
  - Call `$this->validateFormData($data, $current_agent)` for validation
  - Check duplicate email/ID number via repository
  - Save via `$this->getRepository()->createAgent()` or `updateAgent()`
  - Call `$this->handleFileUploads($agent_id, $current_agent)` for file uploads
- Render view: `return $this->render('agents/components/agent-capture-form', $data, true);`
- Data includes: `$agent`, `$errors`, `$mode`, `$atts`, `$working_areas` (from WorkingAreasService)
- Permission check: `current_user_can('edit_others_posts')` for editor+ access. Return error div if denied.

**renderAgentsList($atts):**
Migrate from DisplayAgentShortcode. Key logic:
- `shortcode_atts(['per_page' => 10, 'show_search' => true, 'show_filters' => true, 'show_pagination' => true, 'show_actions' => true, 'columns' => ''], $atts)`
- Get current_page, per_page, search_query, sort_column, sort_order from `$_GET`
- Query agents via `$this->getRepository()->getAgents($args)` with pagination, search, sort
- Get total count via `$this->getRepository()->countAgents($args)`
- Get statistics via `$this->getAgentStatistics()`
- Map agent fields via `$this->mapAgentFields()` for frontend display
- Determine display columns via `$this->getDisplayColumns()`
- Render view: `return $this->render('agents/display/agent-display-table', $data, true);`

**renderSingleAgent($atts):**
Migrate from SingleAgentShortcode. Key logic:
- `shortcode_atts(['agent_id' => 0], $atts)`
- Get agent_id from shortcode atts or `$_GET['agent_id']`
- Load agent via `$this->getRepository()->getAgent($agent_id)`
- Transform via `FormHelpers::map_database_to_form()` if agent found
- Render view: `return $this->render('agents/display/agent-single-display', $data, true);`
- Data: `$agent_id`, `$agent`, `$error`, `$back_url`, `$can_manage`, `$date_format`

**enqueueAssets():**
- Call `shouldEnqueueAssets()` first, return if false
- Enqueue Google Maps API if key available (from `get_option('wecoza_google_maps_api_key')`)
- Enqueue 5 JS files:
  1. `wecoza-agents-app` (agents-app.js, depends on ['jquery'])
  2. `wecoza-agent-form-validation` (agent-form-validation.js, depends on ['jquery', 'google-maps-api'])
  3. `wecoza-agents-ajax-pagination` (agents-ajax-pagination.js, depends on ['jquery', 'wecoza-agents-app'])
  4. `wecoza-agents-table-search` (agents-table-search.js, depends on ['jquery', 'wecoza-agents-app'])
  5. `wecoza-agents-delete` (agent-delete.js, depends on ['jquery', 'wecoza-agents-app'])
- All enqueued from `WECOZA_CORE_URL . 'assets/js/agents/'`
- All use `WECOZA_CORE_VERSION` for versioning
- All loaded in footer (true)
- **UNIFIED LOCALIZATION** (Bug #3 fix): Single `wp_localize_script()` call on `wecoza-agents-app`:
```php
wp_localize_script('wecoza-agents-app', 'wecozaAgents', [
    'ajaxUrl' => admin_url('admin-ajax.php'),
    'nonce' => wp_create_nonce('agents_nonce_action'),
    'deleteNonce' => wp_create_nonce('wecoza_delete_agent'),
    'paginationNonce' => wp_create_nonce('wecoza_agents_pagination'),
    'debug' => defined('WP_DEBUG') && WP_DEBUG,
    'loadingText' => __('Loading...', 'wecoza-core'),
    'errorText' => __('Error loading agents. Please try again.', 'wecoza-core'),
    'confirmDeleteText' => __('Are you sure you want to delete this agent? This action cannot be undone.', 'wecoza-core'),
    'deleteSuccessText' => __('Agent deleted successfully.', 'wecoza-core'),
    'deleteErrorText' => __('Error deleting agent. Please try again.', 'wecoza-core'),
    'urls' => [
        'displayAgents' => home_url('/app/agents/'),
        'viewAgent' => home_url('/app/agent-view/'),
        'captureAgent' => home_url('/new-agents/'),
    ],
]);
```

**shouldEnqueueAssets():**
```php
global $post;
if (!$post) return false;
$shortcodes = ['wecoza_capture_agents', 'wecoza_display_agents', 'wecoza_single_agent'];
foreach ($shortcodes as $shortcode) {
    if (has_shortcode($post->post_content, $shortcode)) return true;
}
return false;
```

**CRITICAL Bug fixes during migration:**
- NO `DatabaseService` references — use `wecoza_db()` for statistics queries
- NO `WECOZA_AGENTS_*` constants — use `WECOZA_CORE_*`
- NO `wecoza_agents_log()` — use `wecoza_log()`
- Text domain: `wecoza-core` not `wecoza-agents-plugin`

**Note:** Leave private helper method stubs (collectFormData, validateFormData, handleFileUploads, mapAgentFields, etc.) with `// TODO: Task 1b` comments. Task 1b will fill in the implementations.
  </action>
  <verify>
```bash
php -l src/Agents/Controllers/AgentsController.php
grep "extends BaseController" src/Agents/Controllers/AgentsController.php
grep -c "add_shortcode" src/Agents/Controllers/AgentsController.php  # expect 3
grep "wecozaAgents" src/Agents/Controllers/AgentsController.php      # unified localization
grep "shouldEnqueueAssets" src/Agents/Controllers/AgentsController.php
grep -c "nopriv" src/Agents/Controllers/AgentsController.php          # expect 0
grep "DatabaseService" src/Agents/Controllers/AgentsController.php    # expect nothing
grep "WECOZA_AGENTS_" src/Agents/Controllers/AgentsController.php     # expect nothing
```
  </verify>
  <done>AgentsController skeleton created: extends BaseController, registerHooks, registerShortcodes (3), 3 render methods, enqueueAssets with unified wecozaAgents localization, shouldEnqueueAssets. Zero nopriv, zero legacy references. Helper stubs ready for Task 1b.</done>
</task>

<task type="auto">
  <name>Task 1b: Complete AgentsController form handling helpers</name>
  <files>src/Agents/Controllers/AgentsController.php</files>
  <action>
Fill in all private helper method implementations in AgentsController.php (replacing the stubs left by Task 1a). These are migrated from CaptureAgentShortcode and DisplayAgentShortcode source files.

**Methods to implement:**

**collectFormData():** Migrate from CaptureAgentShortcode::collect_form_data().
- Collect and sanitize each field from `$_POST`: title, first_name, surname, gender, race, id_type, sa_id_no, passport_number, tel_number, email_address, address_line_1, residential_suburb, city, province_region, postal_code, working_area_1-5, teaching_subjects, teaching_qualifications, agent_training_date, quantum_maths_score, quantum_science_score, quantum_comprehension_score, sace_number, sace_expiry_date, bank_name, account_holder, account_number, branch_code, account_type, status, notes
- Use `sanitize_text_field()`, `sanitize_email()`, `intval()`, `floatval()` as appropriate per field type

**validateFormData($data, $current_agent):** Migrate from CaptureAgentShortcode validation logic.
- Required fields: first_name, surname, tel_number, email_address
- SA ID validation via ValidationHelper::validateSAID() when id_type = 'sa_id'
- Passport validation when id_type = 'passport'
- Duplicate email check via repository (exclude current agent on edit)
- Duplicate ID number check via repository (exclude current agent on edit)
- Return array of field => error_message pairs

**handleFileUploads($agent_id, $current_agent):** Migrate from CaptureAgentShortcode file upload handling.
- Process signed_agreement_file and criminal_record_file from `$_FILES`
- Call `$this->uploadFile()` for each
- Return array of file paths to merge into agent data

**uploadFile($field_name, $agent_id):** Migrate from CaptureAgentShortcode::upload_file().
- Validate file exists in `$_FILES[$field_name]`
- Allowed types: pdf, doc, docx
- Use `wp_handle_upload()` with `['test_form' => false]`
- Return file path on success, null on failure

**mapAgentFields($agent):** Migrate from DisplayAgentShortcode::map_agent_fields().
- Map DB column names to frontend display names:
  - `surname` → `last_name`
  - `tel_number` → `phone`
  - `email_address` → `email`
  - `city` → `city_town`
- Keep: id, first_name, status, sa_id_no, sace_number
- Return mapped array

**mapSortColumn($column):** Map frontend sort column names back to DB column names.
- `last_name` → `surname`
- `phone` → `tel_number`
- `email` → `email_address`
- Return original column if no mapping exists

**getDisplayColumns($columns_setting):** Migrate from DisplayAgentShortcode.
- Parse comma-separated columns string from shortcode atts
- Default columns: ['first_name', 'last_name', 'email', 'phone', 'city_town', 'status']
- Return array of column identifiers

**getEditUrl($agent_id):** Return `add_query_arg(['update' => '', 'agent_id' => $agent_id], home_url('/new-agents/'))`

**getViewUrl($agent_id):** Return `add_query_arg('agent_id', $agent_id, home_url('/app/agent-view/'))`

**getBackUrl():** Return `home_url('/app/agents/')`

**getAgentStatistics():** Migrate from DisplayAgentShortcode::get_agent_statistics().
- Use `wecoza_db()` for direct COUNT queries:
  - Total agents (status != 'deleted')
  - Active agents (status = 'active')
  - SACE registered (sace_number IS NOT NULL AND != '')
  - Quantum qualified (quantum_maths_score > 0 OR quantum_science_score > 0)
- Return array with label, count, badge, badge_type

**CRITICAL:** All source code comes from the existing shortcode classes — this is a migration, not greenfield development. Read the source files referenced in `<context>` and translate method-by-method.
  </action>
  <verify>
```bash
php -l src/Agents/Controllers/AgentsController.php
grep -c "function collectFormData\|function validateFormData\|function handleFileUploads\|function uploadFile\|function mapAgentFields\|function mapSortColumn\|function getDisplayColumns\|function getEditUrl\|function getViewUrl\|function getBackUrl\|function getAgentStatistics" src/Agents/Controllers/AgentsController.php  # expect 11
grep "TODO" src/Agents/Controllers/AgentsController.php | wc -l  # expect 0 (all stubs filled)
grep "wecoza_db" src/Agents/Controllers/AgentsController.php  # exists (for statistics)
grep "wp_handle_upload" src/Agents/Controllers/AgentsController.php  # exists (for file uploads)
```
  </verify>
  <done>All 11 private helper methods implemented in AgentsController: collectFormData, validateFormData, handleFileUploads, uploadFile, mapAgentFields, mapSortColumn, getDisplayColumns, getEditUrl, getViewUrl, getBackUrl, getAgentStatistics. Zero TODO stubs remaining.</done>
</task>

<task type="auto">
  <name>Task 2: Create AgentsAjaxHandlers with AjaxSecurity pattern</name>
  <files>src/Agents/Ajax/AgentsAjaxHandlers.php</files>
  <action>
Create `src/Agents/Ajax/AgentsAjaxHandlers.php` as a standalone AJAX handler class.

**Namespace:** `WeCoza\Agents\Ajax`

**Imports:**
- `WeCoza\Core\Helpers\AjaxSecurity`
- `WeCoza\Agents\Repositories\AgentRepository`
- `WeCoza\Agents\Helpers\FormHelpers`

**Properties:**
- `private AgentRepository $repository;`

**Constructor:**
```php
public function __construct()
{
    $this->repository = new AgentRepository();
    $this->registerHandlers();
}
```

**registerHandlers():**
- `add_action('wp_ajax_wecoza_agents_paginate', [$this, 'handlePagination']);` (Bug #10: uses `wecoza_agents_` prefix)
- `add_action('wp_ajax_wecoza_agents_delete', [$this, 'handleDelete']);` (Bug #10: standardized from bare `wecoza_delete_agent`)
- **NO nopriv handlers** (Bug #12: entire WP requires login)

**handlePagination():**
Migrate from DisplayAgentShortcode::handle_ajax_pagination(). Key changes:
- Use `AjaxSecurity::requireNonce('agents_nonce_action');` (NOT manual check)
- Use `AjaxSecurity::post('page', 'int')` for input sanitization
- Also get: per_page, search, orderby, order from POST
- Validate sort order in ['ASC', 'DESC']
- Map sort column (last_name -> surname, phone -> tel_number, email -> email_address)
- Query agents via `$this->repository->getAgents($args)` with pagination
- Count total via `$this->repository->countAgents()`
- Map agent fields for frontend display
- Get statistics
- **Capture HTML partials:**
  - Table rows: `wecoza_view('agents/display/agent-display-table-rows', [...], true)`
  - Pagination: `wecoza_view('agents/display/agent-pagination', [...], true)`
  - Statistics HTML: inline generation (same as source)
- Response via `AjaxSecurity::sendSuccess([...])` with: agents, total_agents, current_page, per_page, total_pages, start_index, end_index, statistics, table_html, pagination_html, statistics_html

**handleDelete():**
Migrate from DisplayAgentShortcode::handle_ajax_delete(). Key changes:
- `AjaxSecurity::requireNonce('agents_nonce_action');` (same nonce for simplicity, or can use separate `wecoza_delete_agent` nonce)
- Actually, use the SAME `agents_nonce_action` nonce for ALL AJAX operations. The localization provides `nonce` for paginate and `deleteNonce` for delete. But to keep it simple and consistent, use `agents_nonce_action` for both. Update: The delete JS sends `wecozaAgents.nonce` (the main nonce). So verify with `agents_nonce_action`.
- `AjaxSecurity::requireCapability('edit_others_posts');` (editors and above)
- `$agent_id = AjaxSecurity::post('agent_id', 'int');` (Note: source uses `agent_id` not `id`)
- Validate agent_id > 0
- Call `$this->repository->deleteAgent($agent_id)` (soft delete)
- Success: `AjaxSecurity::sendSuccess(['message' => 'Agent deleted successfully.', 'agent_id' => $agent_id])`
- Error: `AjaxSecurity::sendError('Failed to delete agent.', 500)`
- Wrap in try/catch

**Helper methods:**
- `getAgentStatistics()` — same COUNT queries as controller (or call controller method). Actually, to keep DRY, add a private method here. OR: since the controller also needs it, consider having it in the repository instead. For now, duplicate the statistics method here since AJAX handler is standalone.
- `getStatisticsHtml($statistics)` — Generate HTML for statistics badges (from source DisplayAgentShortcode::get_statistics_html)
- `mapAgentFields($agent)` — Same mapping as controller
- `mapSortColumn($column)` — Same mapping as controller
- `getDisplayColumns($columns_setting)` — Same as controller

**Important: DRY consideration.** The mapAgentFields, mapSortColumn, getDisplayColumns methods are identical between controller and AJAX handler. To avoid duplication, these could be placed in a shared trait or service. However, for Phase 27 migration simplicity, duplicating is acceptable — Phase 28/29 can refactor. Keep it simple.

**CRITICAL Bug fixes:**
- All responses through AjaxSecurity::sendSuccess/sendError (Bug #4: ensures response.data.* access in JS)
- All actions have `wecoza_agents_` prefix (Bug #10)
- Zero nopriv handlers (Bug #12)
- Zero DatabaseService references — use wecoza_db() for statistics
  </action>
  <verify>
```bash
php -l src/Agents/Ajax/AgentsAjaxHandlers.php
grep "AjaxSecurity::requireNonce" src/Agents/Ajax/AgentsAjaxHandlers.php
grep -c "wp_ajax_wecoza_agents_" src/Agents/Ajax/AgentsAjaxHandlers.php  # expect 2
grep "nopriv" src/Agents/Ajax/AgentsAjaxHandlers.php                      # expect nothing
grep "DatabaseService" src/Agents/Ajax/AgentsAjaxHandlers.php             # expect nothing
grep "wp_send_json" src/Agents/Ajax/AgentsAjaxHandlers.php                # expect nothing (use AjaxSecurity)
```
  </verify>
  <done>AgentsAjaxHandlers registers 2 AJAX endpoints (wecoza_agents_paginate, wecoza_agents_delete), both use AjaxSecurity pattern for nonce/capability/response, zero nopriv handlers, zero legacy references.</done>
</task>

<task type="auto">
  <name>Task 3: Wire Agents module in wecoza-core.php</name>
  <files>wecoza-core.php</files>
  <action>
Add Agents module initialization to `wecoza-core.php` in the "Initialize Modules" section, AFTER the Clients module block (around line 243).

**Add this block:**
```php
// Initialize Agents Module
if (class_exists(\WeCoza\Agents\Controllers\AgentsController::class)) {
    new \WeCoza\Agents\Controllers\AgentsController();
}
if (class_exists(\WeCoza\Agents\Ajax\AgentsAjaxHandlers::class)) {
    new \WeCoza\Agents\Ajax\AgentsAjaxHandlers();
}
```

This follows the exact same pattern as the Clients module initialization (lines 234-242). No `initialize()` call needed because BaseController's constructor calls `registerHooks()` automatically.

**Verification:** The `WeCoza\Agents\` namespace is already registered in the PSR-4 autoloader (line 54, added in Phase 26-01).
  </action>
  <verify>
```bash
grep "AgentsController" wecoza-core.php
grep "AgentsAjaxHandlers" wecoza-core.php
php -l wecoza-core.php
```
  </verify>
  <done>wecoza-core.php initializes both AgentsController and AgentsAjaxHandlers in the module init section, following the Clients module pattern.</done>
</task>

</tasks>

<verification>
```bash
# All files exist and pass syntax check
php -l src/Agents/Controllers/AgentsController.php
php -l src/Agents/Ajax/AgentsAjaxHandlers.php
php -l wecoza-core.php

# Controller structure
grep "extends BaseController" src/Agents/Controllers/AgentsController.php
grep -c "add_shortcode" src/Agents/Controllers/AgentsController.php  # 3

# AJAX structure
grep -c "wp_ajax_wecoza_agents_" src/Agents/Ajax/AgentsAjaxHandlers.php  # 2

# No legacy references
grep -r "DatabaseService" src/Agents/Controllers/ src/Agents/Ajax/ --include="*.php" | wc -l  # 0
grep -r "WECOZA_AGENTS_" src/Agents/Controllers/ src/Agents/Ajax/ --include="*.php" | wc -l   # 0
grep -r "nopriv" src/Agents/ --include="*.php" | wc -l  # 0

# Unified localization
grep "wecozaAgents" src/Agents/Controllers/AgentsController.php  # exists

# Core wiring
grep "AgentsController" wecoza-core.php
grep "AgentsAjaxHandlers" wecoza-core.php
```
</verification>

<success_criteria>
- AgentsController.php extends BaseController with registerHooks()
- 3 shortcodes registered (wecoza_capture_agents, wecoza_display_agents, wecoza_single_agent)
- AgentsAjaxHandlers.php uses AjaxSecurity pattern throughout
- 2 AJAX endpoints with wecoza_agents_ prefix (paginate, delete)
- Zero nopriv AJAX registrations
- Single wecozaAgents localization object with camelCase keys
- Assets enqueued conditionally via shouldEnqueueAssets()
- wecoza-core.php initializes both controller and AJAX handlers
- Zero DatabaseService, WECOZA_AGENTS_, wecoza_agents_log references
- All PHP files pass syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/27-controllers-views-ajax/27-01-SUMMARY.md`
</output>
