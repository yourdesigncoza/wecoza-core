---
phase: 28-wiring-verification
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All 3 shortcodes render clean HTML with no PHP errors in debug.log"
    - "No JS console errors on any page with agent shortcodes"
    - "AJAX pagination loads next page without full page reload"
    - "AJAX delete soft-deletes agent and removes row from table"
    - "All DOM IDs in JS match view template IDs (no 'element not found' errors)"
    - "All nonce names consistent between PHP and JS (no 403 errors on AJAX)"
  artifacts: []
  key_links:
    - from: "Browser"
      to: "wecoza_capture_agents shortcode"
      via: "WordPress page rendering"
      pattern: "agents-form"
    - from: "Browser"
      to: "wecoza_display_agents shortcode"
      via: "WordPress page rendering"
      pattern: "agents-display-data"
    - from: "Browser"
      to: "wecoza_single_agent shortcode"
      via: "WordPress page rendering"
      pattern: "agent detail view"
---

<objective>
Run full verification suite: WP-CLI shortcode existence, clear debug log and verify clean rendering, browser smoke test for all 3 shortcodes and AJAX operations.

Purpose: Phase 28 exists to catch wiring bugs from Phase 27 migration. Plan 01 fixed known bugs statically. This plan verifies the fixes work at runtime and catches any remaining issues.

Output: Clean debug.log, all shortcodes rendering, all AJAX working. Phase 28 success criteria satisfied.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-wiring-verification/28-RESEARCH.md
@.planning/phases/28-wiring-verification/28-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: WP-CLI verification and debug log baseline</name>
  <files></files>
  <action>
**Step 1: Verify shortcode registration via WP-CLI**

Run from the WordPress root directory (`/opt/lampp/htdocs/wecoza`):
```bash
wp eval 'foreach(["wecoza_capture_agents","wecoza_display_agents","wecoza_single_agent"] as $s) echo shortcode_exists($s)?"OK: $s\n":"FAIL: $s\n";'
```
All 3 must return OK. If any FAIL, check `wecoza-core.php` initialization (lines 245-250) and `AgentsController::registerShortcodes()`.

**Step 2: Verify AJAX handler registration via WP-CLI**

```bash
wp eval 'global $wp_filter; foreach(["wp_ajax_wecoza_agents_paginate","wp_ajax_wecoza_agents_delete"] as $h) echo isset($wp_filter[$h])?"OK: $h\n":"FAIL: $h\n";'
```
Both must return OK.

**Step 3: Clear debug log and set baseline**

```bash
echo "" > /opt/lampp/htdocs/wecoza/wp-content/debug.log
```

Then trigger shortcode rendering by making HTTP requests:
```bash
# Get a page URL with each shortcode (or use wp eval to render)
wp eval 'echo do_shortcode("[wecoza_display_agents]");' > /dev/null 2>&1
wp eval 'echo do_shortcode("[wecoza_capture_agents]");' > /dev/null 2>&1
wp eval 'echo do_shortcode("[wecoza_single_agent agent_id=1]");' > /dev/null 2>&1
```

**Step 4: Check debug log for errors**

```bash
cat /opt/lampp/htdocs/wecoza/wp-content/debug.log
```

Expect: Empty or no errors related to agents module. If errors found:
- "Undefined variable" -> check view `$data` extraction in controller
- "Class not found" -> check autoloader in wecoza-core.php
- "Fatal error" -> check PHP syntax and class methods
- "Nonce verification failed" -> already fixed in Plan 01, re-verify

**Step 5: PHP syntax validation of ALL agents files**

```bash
find /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Agents/ -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
find /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/views/agents/ -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
```

Any output means a syntax error. Fix immediately.

If ANY errors are found in steps 1-5, diagnose and fix them before proceeding to the checkpoint task. Common fixes:
- Missing `use` statement -> add the import
- Wrong method signature -> check BaseController/BaseRepository
- Undefined variable in view -> check controller data array keys
  </action>
  <verify>
```bash
# All 3 shortcodes exist
wp eval 'foreach(["wecoza_capture_agents","wecoza_display_agents","wecoza_single_agent"] as $s) echo shortcode_exists($s)?"OK: $s\n":"FAIL: $s\n";' 2>/dev/null

# Both AJAX handlers registered
wp eval 'global $wp_filter; foreach(["wp_ajax_wecoza_agents_paginate","wp_ajax_wecoza_agents_delete"] as $h) echo isset($wp_filter[$h])?"OK: $h\n":"FAIL: $h\n";' 2>/dev/null

# Debug log clean (no fatal/warning/notice for agents)
grep -i "fatal\|warning\|notice" /opt/lampp/htdocs/wecoza/wp-content/debug.log | grep -i "agent" | wc -l
# Expected: 0

# PHP syntax clean
find /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Agents/ -name "*.php" -exec php -l {} \; 2>&1 | grep -c "Parse error"
# Expected: 0
```
  </verify>
  <done>
All 3 shortcodes registered (WP-CLI confirms). Both AJAX handlers registered. Debug.log clean after shortcode rendering. Zero PHP syntax errors in Agents module.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Plan 01 fixed three wiring bugs:
1. **Nonce unification (Bug #14):** Removed `deleteNonce` and `paginationNonce` from localization, unified to single `nonce` created from `'agents_nonce_action'`. Updated pagination JS to use `wecozaAgents.nonce`.
2. **Inline script cleanup:** Removed duplicate `exportClasses()` inline script from display table view. Renamed to `exportAgents()` in both onclick handler and agents-table-search.js.
3. **Missing DOM element:** Added `#wecoza-agents-loader-container` to display table view.

Task 1 confirmed: shortcodes registered, AJAX handlers registered, debug.log clean, PHP syntax valid.
  </what-built>
  <how-to-verify>
**Test 1: Display Agents (AJAX pagination)**
1. Navigate to the agents list page (the page with `[wecoza_display_agents]` shortcode)
2. Verify the table renders with agent data
3. Click page 2 (or next page) in pagination — table should update WITHOUT full page reload
4. Open browser DevTools Network tab, filter by XHR — confirm `admin-ajax.php` request with action `wecoza_agents_paginate` returns 200
5. Verify no 403 errors (this was the critical nonce bug)

**Test 2: Export function**
1. On the same agents list page, click the "Export" button
2. A CSV file should download with agent data
3. Open DevTools Console — no errors about `exportClasses is not defined`

**Test 3: Delete Agent**
1. Click the delete button on any agent row
2. Confirm the dialog appears
3. Confirm deletion — row should fade out
4. DevTools Network tab shows `wecoza_agents_delete` action with 200 response

**Test 4: Capture Form**
1. Navigate to the agent capture page (the page with `[wecoza_capture_agents]` shortcode)
2. Verify form renders with all fields
3. Open DevTools Console — no JS errors

**Test 5: Single Agent View**
1. Navigate to a single agent view (the page with `[wecoza_single_agent]` shortcode, with ?agent_id=X parameter)
2. Verify agent details render correctly
3. Open DevTools Console — no JS errors

**Test 6: Debug Log**
Check `/opt/lampp/htdocs/wecoza/wp-content/debug.log` for any new errors after all tests above.
  </how-to-verify>
  <resume-signal>Type "approved" if all 6 tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
Phase 28 success criteria checklist:
- [ ] All 3 shortcodes render clean HTML (no PHP errors)
- [ ] No PHP errors in debug.log
- [ ] No JS console errors on any page with shortcodes
- [ ] All DOM IDs in JS match view template IDs
- [ ] All AJAX action names in inline scripts have `wecoza_agents_` prefix
- [ ] All nonce names consistent between PHP and JS
- [ ] AJAX pagination works (200 response, table updates)
- [ ] AJAX delete works (200 response, row removed)
- [ ] Export CSV works (file downloads)
</verification>

<success_criteria>
1. WP-CLI confirms all 3 shortcodes exist and both AJAX handlers are registered
2. Debug.log is clean after shortcode rendering
3. User confirms all 6 browser tests pass (pagination, export, delete, capture form, single view, clean console)
4. Zero 403 nonce errors on AJAX calls
</success_criteria>

<output>
After completion, create `.planning/phases/28-wiring-verification/28-02-SUMMARY.md`
</output>
