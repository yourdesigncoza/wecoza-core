---
phase: 28-wiring-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Agents/Controllers/AgentsController.php
  - assets/js/agents/agents-ajax-pagination.js
  - views/agents/display/agent-display-table.view.php
autonomous: true

must_haves:
  truths:
    - "AJAX pagination sends correct nonce that matches server-side verification"
    - "AJAX delete sends correct nonce that matches server-side verification"
    - "All JS DOM selectors have matching elements in view templates"
    - "No duplicate function definitions between inline scripts and external JS files"
    - "All agent-specific function names use 'Agent' not 'Class' terminology"
  artifacts:
    - path: "src/Agents/Controllers/AgentsController.php"
      provides: "Unified single nonce in localization object"
      contains: "agents_nonce_action"
    - path: "assets/js/agents/agents-ajax-pagination.js"
      provides: "Pagination AJAX using unified nonce"
      contains: "wecozaAgents.nonce"
    - path: "views/agents/display/agent-display-table.view.php"
      provides: "Clean display table with no duplicate JS, correct function names"
      contains: "exportAgents"
  key_links:
    - from: "assets/js/agents/agents-ajax-pagination.js"
      to: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      via: "nonce: wecozaAgents.nonce -> AjaxSecurity::requireNonce('agents_nonce_action')"
      pattern: "nonce:\\s*wecozaAgents\\.nonce"
    - from: "assets/js/agents/agent-delete.js"
      to: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      via: "nonce: wecozaAgents.nonce -> AjaxSecurity::requireNonce('agents_nonce_action')"
      pattern: "nonce:\\s*wecozaAgents\\.nonce"
    - from: "views/agents/display/agent-display-table.view.php"
      to: "assets/js/agents/agents-table-search.js"
      via: "onclick='exportAgents()' -> window.exportAgents"
      pattern: "exportAgents"
---

<objective>
Fix wiring bugs in Agents module: nonce mismatch (Bug #14), missing DOM elements, duplicate/misnamed inline scripts.

Purpose: Pagination AJAX currently sends `wecozaAgents.paginationNonce` (created from `'wecoza_agents_pagination'`) but handler verifies `'agents_nonce_action'` — this causes 403 failures. Additionally, the export function is named `exportClasses()` instead of `exportAgents()`, and an inline script duplicates logic already in `agents-table-search.js`.

Output: All AJAX nonces unified, DOM selectors matched, inline script duplication removed, function names corrected.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-wiring-verification/28-RESEARCH.md
@src/Agents/Controllers/AgentsController.php
@src/Agents/Ajax/AgentsAjaxHandlers.php
@assets/js/agents/agents-ajax-pagination.js
@assets/js/agents/agent-delete.js
@views/agents/display/agent-display-table.view.php
@assets/js/agents/agents-table-search.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix nonce mismatch and unify localization object (Bug #14)</name>
  <files>
    src/Agents/Controllers/AgentsController.php
    assets/js/agents/agents-ajax-pagination.js
  </files>
  <action>
**In `src/Agents/Controllers/AgentsController.php` around lines 371-387:**

1. Remove `deleteNonce` and `paginationNonce` from the `wp_localize_script` array (lines 374-375). The localization object should have ONE nonce:
```php
'nonce' => wp_create_nonce('agents_nonce_action'),
```
Keep all other keys (`ajaxUrl`, `debug`, `loadingText`, `errorText`, `confirmDeleteText`, `deleteSuccessText`, `deleteErrorText`, `urls`).

**In `assets/js/agents/agents-ajax-pagination.js` line 158:**

2. Change `nonce: wecozaAgents.paginationNonce` to `nonce: wecozaAgents.nonce`

This is the critical fix. The handler at `AgentsAjaxHandlers.php` line 65 calls `AjaxSecurity::requireNonce('agents_nonce_action')`. The pagination JS was sending a nonce created from `'wecoza_agents_pagination'` which is a DIFFERENT nonce action — guaranteed 403 failure.

The delete JS (`agent-delete.js` line 46) already uses `wecozaAgents.nonce` correctly — no change needed there.

**Verification after fix:**
- `agents_nonce_action` appears exactly once in the localization array
- `paginationNonce` and `deleteNonce` do NOT appear in the localization array
- All JS files reference `wecozaAgents.nonce` (not `.paginationNonce` or `.deleteNonce`)
  </action>
  <verify>
Run these grep checks:
```bash
# No more paginationNonce or deleteNonce in PHP localization
grep -c "paginationNonce\|deleteNonce" src/Agents/Controllers/AgentsController.php
# Expected: 0

# No more paginationNonce or deleteNonce in JS files
grep -rc "paginationNonce\|deleteNonce" assets/js/agents/
# Expected: 0 for each file

# Unified nonce in JS pagination
grep "nonce: wecozaAgents.nonce" assets/js/agents/agents-ajax-pagination.js
# Expected: 1 match

# Unified nonce in JS delete
grep "nonce: wecozaAgents.nonce" assets/js/agents/agent-delete.js
# Expected: 1 match

# PHP handler still verifies agents_nonce_action
grep "requireNonce.*agents_nonce_action" src/Agents/Ajax/AgentsAjaxHandlers.php
# Expected: 2 matches (handlePagination + handleDelete)
```
  </verify>
  <done>
Single nonce `agents_nonce_action` used across PHP localization, pagination JS, and delete JS. No `paginationNonce` or `deleteNonce` references remain. Both AJAX handlers verify the same nonce action that the localization creates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix inline script duplication and function naming, add missing DOM element</name>
  <files>
    views/agents/display/agent-display-table.view.php
  </files>
  <action>
**Fix 1: Remove duplicate inline `exportClasses()` script (lines 231-330+)**

The `agent-display-table.view.php` has an inline `<script>` block (starting line 231) that defines `exportClasses()` and `escapeCSVField()`. This DUPLICATES functionality already in `assets/js/agents/agents-table-search.js` (line 291 `exportClasses()`, and `window.exportClasses = exportClasses` at line 411). Remove the entire inline `<script>` block from the view.

**Fix 2: Rename `exportClasses` to `exportAgents`**

In the same view file, line 62 has:
```html
<button ... onclick="exportClasses()">
```
Change to:
```html
<button ... onclick="exportAgents()">
```

In `assets/js/agents/agents-table-search.js`, update the function name:
- Line 291: `function exportClasses()` -> `function exportAgents()`
- Line 409 comment: update to reference `exportAgents`
- Line 411: `window.exportClasses = exportClasses;` -> `window.exportAgents = exportAgents;`
- Line 421: `export: exportClasses` -> `export: exportAgents`

Note: Do NOT touch `views/classes/components/classes-display.view.php` — that's the Classes module and correctly uses `exportClasses()`.

**Fix 3: Add missing loader container DOM element**

The `agents-ajax-pagination.js` SELECTORS object references `#wecoza-agents-loader-container` (line 37), and `agents-app.js` line 16 hides `$('#wecoza-agents-loader-container')`. This element does NOT exist in any view template.

Add this div just inside the `#agents-container` div (after line 33's opening `<div id="agents-container">`):
```html
<div id="wecoza-agents-loader-container" class="text-center py-3 d-none">
    <div class="spinner-border spinner-border-sm text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>
```

Use `d-none` (hidden by default). The JS shows/hides it during AJAX loading.
  </action>
  <verify>
Run these checks:
```bash
# No inline script block in display table view (other than the form date protection in capture form)
grep -c "<script>" views/agents/display/agent-display-table.view.php
# Expected: 0

# exportAgents in onclick handler
grep "exportAgents" views/agents/display/agent-display-table.view.php
# Expected: 1 match (onclick)

# exportAgents in JS file
grep "exportAgents" assets/js/agents/agents-table-search.js
# Expected: 3-4 matches (function def, window assignment, return object, comment)

# No exportClasses in agents JS (should only be in classes module)
grep "exportClasses" assets/js/agents/agents-table-search.js
# Expected: 0

# Loader container exists in view
grep 'id="wecoza-agents-loader-container"' views/agents/display/agent-display-table.view.php
# Expected: 1 match

# PHP syntax check on modified files
php -l views/agents/display/agent-display-table.view.php
php -l src/Agents/Controllers/AgentsController.php
```
  </verify>
  <done>
Inline duplicate `exportClasses()` script removed from display table view. Function renamed to `exportAgents()` in both onclick handler and agents-table-search.js. Loader container `#wecoza-agents-loader-container` DOM element added to match JS SELECTORS reference. All modified PHP files pass syntax check.
  </done>
</task>

</tasks>

<verification>
After both tasks, run full static analysis battery:

```bash
# 1. No hardcoded AJAX URLs in views
grep -r "admin-ajax.php" views/agents/ --include="*.php" | wc -l  # expect 0

# 2. No nopriv handlers
grep -r "wp_ajax_nopriv" src/Agents/ --include="*.php" | wc -l  # expect 0

# 3. Unified nonce - no paginationNonce/deleteNonce anywhere
grep -r "paginationNonce\|deleteNonce" src/Agents/ assets/js/agents/ views/agents/ --include="*.php" --include="*.js" | wc -l  # expect 0

# 4. Action names prefixed
grep "action.*wecoza_agents_" assets/js/agents/ -r --include="*.js"  # expect 2 matches

# 5. All JS uses wecozaAgents.nonce
grep "wecozaAgents.nonce" assets/js/agents/*.js  # expect 2 matches (pagination + delete)

# 6. DOM IDs match between JS and views
grep 'id="agents-container"' views/agents/ -r  # expect 1
grep 'id="agents-display-data"' views/agents/ -r  # expect 1
grep 'id="agents-form"' views/agents/ -r  # expect 1
grep 'id="wecoza-agents-loader-container"' views/agents/ -r  # expect 1
grep 'id="alert-container"' views/agents/ -r  # expect 1

# 7. PHP syntax check all Agents files
find src/Agents/ -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
find views/agents/ -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"

# 8. No inline scripts in display table
grep -c "<script>" views/agents/display/agent-display-table.view.php  # expect 0

# 9. exportAgents (not exportClasses) in agents module
grep "exportClasses" assets/js/agents/ views/agents/ -r | wc -l  # expect 0
grep "exportAgents" assets/js/agents/ views/agents/ -r | wc -l  # expect 4+
```
</verification>

<success_criteria>
1. `paginationNonce` and `deleteNonce` removed from localization — single `nonce` key remains
2. All JS AJAX calls use `wecozaAgents.nonce` consistently
3. Inline `exportClasses()` script removed from display table view
4. Function renamed to `exportAgents()` in agents-table-search.js and onclick handler
5. `#wecoza-agents-loader-container` DOM element exists in display table view
6. Zero PHP syntax errors across all Agents module files
7. All grep verification checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/28-wiring-verification/28-01-SUMMARY.md`
</output>
