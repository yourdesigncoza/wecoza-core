---
phase: 29-feature-verification
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Agent create form submits and persists new agent to database"
    - "Agent update form modifies only changed fields plus updated_at/updated_by"
    - "Agent soft-delete sets status to 'deleted' and agent disappears from list"
    - "Duplicate email/SA ID checks prevent duplicate agent creation"
    - "Duplicate email/SA ID checks on update exclude the current agent"
    - "File uploads accept PDF/DOC/DOCX and reject other types"
    - "Statistics badges show correct counts matching database reality"
    - "Working areas dropdowns populate with 14 areas"
    - "NULL working areas do not cause foreign key errors"
    - "No redundant information_schema queries on page load (Bug #16 verified)"
    - "Agent notes can be created and viewed on single agent page"
    - "Agent meta fields are persisted and retrievable via agent view"
  artifacts: []
  key_links:
    - from: "agent-capture-form.view.php"
      to: "AgentsController::renderCaptureForm()"
      via: "POST form submission"
      pattern: "REQUEST_METHOD.*POST"
    - from: "AgentsController::renderCaptureForm()"
      to: "AgentRepository::createAgent()"
      via: "form save logic"
      pattern: "createAgent|updateAgent"
    - from: "agents-ajax-pagination.js"
      to: "AgentsAjaxHandlers::handlePagination()"
      via: "AJAX wp_ajax_wecoza_agents_paginate"
      pattern: "wecoza_agents_paginate"
---

<objective>
Manual browser testing of all CRUD operations, file uploads, statistics, working areas, metadata operations, and performance. Fix any bugs discovered.

Purpose: Verify end-to-end feature parity that automated CLI tests cannot cover (browser interactions, file uploads via $_FILES, visual badge rendering, Query Monitor performance checks, metadata UI if present).
Output: All FEAT-01 through FEAT-05 requirements verified working, Bug #15 and #16 confirmed resolved.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-feature-verification/29-01-SUMMARY.md
@src/Agents/Controllers/AgentsController.php
@src/Agents/Repositories/AgentRepository.php
@src/Agents/Ajax/AgentsAjaxHandlers.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-check debug log baseline, duplicate validation audit, and metadata wiring audit</name>
  <files></files>
  <action>
Before manual testing, perform automated pre-checks:

**1. Clear debug log baseline:**
- Read current debug.log tail (last 20 lines) to note baseline
- The user will check for new errors after browser testing

**2. Audit duplicate validation on UPDATE:**
Read `AgentRepository::createAgent()` and `updateAgent()` to check if the email/SA ID duplicate check properly excludes the current agent during updates. Specifically:
- `createAgent()` checks `getAgentByEmail()` -- this is fine for new agents
- `updateAgent()` does NOT check for duplicate email -- verify whether the controller or validation layer handles this
- Read `AgentsController::validateFormData()` to see if it excludes current agent ID from duplicate checks

**Disposition:** If duplicate validation on update is missing entirely (no code path checks for duplicate email/SA ID when updating), implement it in the appropriate layer (controller or repository) with an atomic commit. If it exists but has a bug (e.g., doesn't exclude current agent ID), fix the bug with an atomic commit. If it works correctly, document the finding and move on.

**3. Audit statistics query correctness:**
- Verify `getAgentStatistics()` in AgentsController excludes soft-deleted agents in all 4 queries
- Verify the statistics are called from `renderAgentsList()` (the display shortcode)

**4. Audit file upload security:**
- Verify `uploadFile()` method validates file type (PDF/DOC/DOCX only)
- Verify it uses `wp_handle_upload()` (WordPress standard)
- Check if old files are deleted when replaced (research flagged this as a concern)

**5. Audit NULL handling for working areas:**
- Verify `sanitizeWorkingArea()` in AgentRepository returns null for empty values (not 0 or empty string)

**6. Audit metadata CRUD wiring (FEAT-02):**
- Verify `AgentRepository` has working methods: `addAgentMeta`, `getAgentMeta`, `updateAgentMeta`, `deleteAgentMeta`
- Verify `AgentRepository` has working methods: `addAgentNote`, `getAgentNotes`, `deleteAgentNotes`
- Verify `AgentRepository` has working methods: `addAgentAbsence`, `getAgentAbsences`, `deleteAgentAbsences`
- Check if any controller or view calls these methods (i.e., is there a UI for notes/meta/absences, or are they API-only at this point?)
- If notes/meta/absences have NO UI exposure yet, note this as acceptable -- FEAT-02 requires CRUD operations work, which Plan 29-01's CLI test already verified at the repository level. The browser checkpoint below will test whatever UI exists.

Report all findings. For any code bugs found, fix them immediately with atomic commits. Common issues to look for:
- Duplicate email check on update missing `excludeAgentId` parameter
- Statistics including soft-deleted agents
- File replacement not deleting old file
- Working area returning 0 instead of null
  </action>
  <verify>
Code audit complete. Any bugs found are fixed and committed. Debug log baseline noted. FEAT-02 metadata wiring status documented.
  </verify>
  <done>
All code paths audited for FEAT-01 through FEAT-05 correctness. Any bugs fixed with commits. Metadata CRUD wiring status documented. Ready for manual browser verification.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete agents module with CRUD operations, file uploads, statistics badges, working areas dropdowns, AJAX pagination/delete, and metadata CRUD. All automated parity tests passed in Plan 01 (including FEAT-02 metadata lifecycle tests). Code audit completed in Task 1.
  </what-built>
  <how-to-verify>
Test the following in your browser. Report any failures and Claude will fix them.

**FEAT-01: Agent CRUD Operations**

1. Navigate to the agent capture form page
2. Fill in: First Name, Surname, Email, SA ID Number (minimum required fields)
3. Submit form -- verify success message
4. Navigate to agents display page -- verify new agent appears in table
5. Click agent name to view single agent page -- verify all fields display correctly
6. Click edit/update -- change email address and one other field -- submit
7. Verify updated data displays correctly
8. Click delete on an agent -- confirm in modal
9. Verify agent disappears from list

**FEAT-01: Duplicate Validation**

10. Try creating agent with same email as existing agent -- should show error
11. Try creating agent with same SA ID as existing agent -- should show error

**FEAT-02: Agent Metadata (notes field on form)**

12. When creating or editing an agent, check if there is a "Notes" field on the form
13. If present: enter a note, submit, then view agent -- verify note is saved and displayed
14. If not present: this is acceptable -- FEAT-02 CRUD was verified programmatically in Plan 01. Note "no metadata UI yet" in your report.

**FEAT-03: File Uploads**

15. Edit an agent, upload a PDF as signed agreement -- submit
16. Verify file link appears on agent view page
17. Try uploading a .jpg file -- should be rejected or ignored

**FEAT-04: Statistics Badges**

18. On the agents display page, verify 4 statistics badges visible:
    - Total Agents (count should match visible agents)
    - Active Agents
    - SACE Registered
    - Quantum Qualified

**FEAT-05: Working Areas**

19. Open agent capture form
20. Verify "Preferred Working Area" dropdowns populate with locations
21. Select areas for Preferred 1 and leave 2/3 empty
22. Submit -- should succeed without foreign key errors

**Performance (Bug #15 / #16)**

23. After any update, verify the display page shows updated data immediately (no stale cache)
24. If Query Monitor is installed: check for information_schema queries (should be minimal)

**Browser Console**

25. Open DevTools Console on each agent page
26. Verify 0 JavaScript errors
27. Check Network tab: all AJAX requests return 200
  </how-to-verify>
  <resume-signal>Type "all pass" if everything works, or describe any failures for Claude to fix</resume-signal>
</task>

</tasks>

<verification>
- Code audit found and fixed any duplicate validation, statistics, file upload, or metadata wiring bugs
- All 27 manual test steps verified by user
- No PHP errors in debug.log after testing
- No JS errors in browser console
- FEAT-01 through FEAT-05 requirements satisfied (FEAT-02 at minimum verified programmatically via Plan 01)
</verification>

<success_criteria>
- Agent CRUD operations persist correctly to database
- Duplicate email/SA ID validation prevents duplicates (including on update)
- File uploads work for PDF/DOC/DOCX and reject other types
- Statistics badges show correct counts
- Working areas dropdowns populate and NULL values handled safely
- Agent metadata CRUD verified (programmatically in Plan 01, UI tested here if available)
- No performance regressions (Bug #15 cache, Bug #16 information_schema)
- Zero PHP/JS errors during testing
</success_criteria>

<output>
After completion, create `.planning/phases/29-feature-verification/29-02-SUMMARY.md`
</output>
