---
phase: 29-feature-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/agents-feature-parity.php
autonomous: true

must_haves:
  truths:
    - "CLI test script verifies all 3 shortcodes registered"
    - "CLI test script verifies both AJAX endpoints registered (no nopriv)"
    - "CLI test script verifies all 7 namespace classes loadable"
    - "CLI test script verifies all 4 database tables queryable"
    - "CLI test script verifies all 6 view templates exist on disk"
    - "CLI test script verifies statistics queries return correct counts"
    - "CLI test script verifies WorkingAreasService returns 14 areas with correct data"
    - "CLI test script verifies no standalone plugin references in src/Agents/"
    - "CLI test script verifies agent_meta CRUD (add, get, update, delete)"
    - "CLI test script verifies agent_notes CRUD (add, get, delete)"
    - "CLI test script verifies agent_absences CRUD (add, get, delete)"
    - "CLI test script exits 0 on all pass, exits 1 on any failure"
  artifacts:
    - path: "tests/integration/agents-feature-parity.php"
      provides: "Automated feature parity verification for agents module"
      min_lines: 250
  key_links:
    - from: "tests/integration/agents-feature-parity.php"
      to: "WeCoza\\Agents\\* classes"
      via: "class_exists() checks"
      pattern: "class_exists.*WeCoza.Agents"
    - from: "tests/integration/agents-feature-parity.php"
      to: "agents database tables"
      via: "wecoza_db()->query()"
      pattern: "wecoza_db.*SELECT.*FROM.*(agents|agent_meta|agent_notes|agent_absences)"
    - from: "tests/integration/agents-feature-parity.php"
      to: "AgentRepository metadata methods"
      via: "addAgentMeta/getAgentMeta/updateAgentMeta/deleteAgentMeta"
      pattern: "addAgent(Meta|Note|Absence)"
---

<objective>
Create and run CLI feature parity test script for the Agents module, following the established clients-feature-parity.php pattern.

Purpose: Automated verification that all agent integration artifacts (shortcodes, AJAX, classes, DB tables, views, statistics, working areas, metadata CRUD) are correctly wired after phases 26-28.
Output: `tests/integration/agents-feature-parity.php` -- passing test script.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@tests/integration/clients-feature-parity.php
@src/Agents/Controllers/AgentsController.php
@src/Agents/Repositories/AgentRepository.php
@src/Agents/Services/WorkingAreasService.php
@src/Agents/Ajax/AgentsAjaxHandlers.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agents-feature-parity.php test script</name>
  <files>tests/integration/agents-feature-parity.php</files>
  <action>
Create `tests/integration/agents-feature-parity.php` following the exact pattern from `tests/integration/clients-feature-parity.php`.

The script must use the same structure:
- CLI safety check (`php_sapi_name() !== 'cli' && !defined('WP_CLI')`)
- WordPress bootstrap (`dirname(__FILE__, 6) . '/wp-load.php'`) -- same depth as clients test
- `AgentsParityTest` class with `$passed/$failed` counters, `pass()/fail()/printResults()` methods
- `exit(1)` on any failure, `exit(0)` on all pass

Test methods to include:

**1. testShortcodeRegistration()** -- Verify 3 shortcodes:
- `wecoza_capture_agents`
- `wecoza_display_agents`
- `wecoza_single_agent`

**2. testAjaxEndpointRegistration()** -- Verify 2 AJAX hooks exist in `$wp_filter`:
- `wp_ajax_wecoza_agents_paginate`
- `wp_ajax_wecoza_agents_delete`
Also verify NO nopriv versions exist (Bug #12 fix).

**3. testNamespaceClasses()** -- Verify 7 classes exist via `class_exists()`:
- `\WeCoza\Agents\Controllers\AgentsController`
- `\WeCoza\Agents\Ajax\AgentsAjaxHandlers`
- `\WeCoza\Agents\Models\AgentModel`
- `\WeCoza\Agents\Repositories\AgentRepository`
- `\WeCoza\Agents\Services\WorkingAreasService`
- `\WeCoza\Agents\Helpers\FormHelpers`
- `\WeCoza\Agents\Helpers\ValidationHelper`

**4. testDatabaseConnectivity()** -- Verify 4 tables queryable via `wecoza_db()`:
- `agents`
- `agent_meta`
- `agent_notes`
- `agent_absences`
Use `SELECT COUNT(*) FROM {table}` and report count.

**5. testViewTemplateExistence()** -- Verify 6 templates exist on disk using `wecoza_plugin_path('views/agents/')`:
- `components/agent-capture-form.view.php`
- `components/agent-fields.view.php`
- `display/agent-display-table.view.php`
- `display/agent-display-table-rows.view.php`
- `display/agent-pagination.view.php`
- `display/agent-single-display.view.php`

**6. testJsAssetExistence()** -- Verify 5 JS files exist:
- `assets/js/agents/agents-app.js`
- `assets/js/agents/agent-form-validation.js`
- `assets/js/agents/agents-ajax-pagination.js`
- `assets/js/agents/agents-table-search.js`
- `assets/js/agents/agent-delete.js`

**7. testStatisticsCalculation()** -- Verify `getAgentStatistics` concept works:
- Query `SELECT COUNT(*) FROM agents WHERE status != 'deleted'` for total
- Query `SELECT COUNT(*) FROM agents WHERE status = 'active'` for active
- Query `SELECT COUNT(*) FROM agents WHERE sace_number IS NOT NULL AND sace_number != '' AND status != 'deleted'` for SACE
- Query `SELECT COUNT(*) FROM agents WHERE (quantum_maths_score > 0 OR quantum_science_score > 0) AND status != 'deleted'` for quantum
- Verify each returns an integer >= 0 (pass if no exception thrown)
- Report actual counts

**8. testWorkingAreasService()** -- Verify service works:
- `WorkingAreasService::get_working_areas()` returns exactly 14 areas
- `WorkingAreasService::get_working_area_by_id('1')` contains 'Sandton'
- `WorkingAreasService::get_working_area_by_id('14')` contains 'East London'
- `WorkingAreasService::get_working_area_by_id('999')` returns null

**9. testAgentMetadataCRUD()** -- Verify FEAT-02 metadata operations (agent_meta, agent_notes, agent_absences):

Pick a real agent ID for testing by querying `SELECT id FROM agents LIMIT 1`. If no agents exist, create a temporary test agent via `AgentRepository::createAgent()` with minimal data (first_name='__TEST__', surname='Parity', email='parity-test@test.invalid', status='active') and clean it up after. Use this agent ID for all metadata subtests below.

*Agent Meta (add/get/update/delete):*
- Call `AgentRepository::addAgentMeta($agentId, '_parity_test_key', 'test_value')` -- verify returns truthy (int or true)
- Call `AgentRepository::getAgentMeta($agentId, '_parity_test_key', true)` -- verify returns 'test_value'
- Call `AgentRepository::updateAgentMeta($agentId, '_parity_test_key', 'updated_value')` -- verify returns true
- Call `AgentRepository::getAgentMeta($agentId, '_parity_test_key', true)` -- verify returns 'updated_value'
- Call `AgentRepository::deleteAgentMeta($agentId, '_parity_test_key')` -- verify returns true
- Call `AgentRepository::getAgentMeta($agentId, '_parity_test_key', true)` -- verify returns null (deleted)

*Agent Notes (add/get/delete):*
- Call `AgentRepository::addAgentNote($agentId, 'Parity test note', 'general')` -- verify returns truthy
- Call `AgentRepository::getAgentNotes($agentId)` -- verify result is non-empty array, last entry contains 'Parity test note'
- Call `AgentRepository::deleteAgentNotes($agentId)` only if using a temporary test agent; otherwise clean up only the test note via direct SQL `DELETE FROM agent_notes WHERE agent_id = :id AND note = 'Parity test note'`

*Agent Absences (add/get/delete):*
- Call `AgentRepository::addAgentAbsence($agentId, '2099-01-01', 'Parity test absence')` -- verify returns truthy
- Call `AgentRepository::getAgentAbsences($agentId)` -- verify result is non-empty array, contains entry with absence_date '2099-01-01'
- Clean up test absence via direct SQL `DELETE FROM agent_absences WHERE agent_id = :id AND reason = 'Parity test absence'`

If a temporary test agent was created, delete it and its related meta/notes/absences at the end.

**10. testNoStandalonePluginDependency()** -- Verify no legacy references in `src/Agents/`:
- No `WeCozaAgents` namespace references (old standalone plugin)
- No `WECOZA_AGENTS_PLUGIN_` constant references
- No `DatabaseService` references
- No `wecoza_agents_log` references
Use recursive PHP file scan pattern from clients test.

Do NOT include emojis in the output -- use "PASS:" and "FAIL:" prefixes like the clients test (which uses checkmark/cross unicode characters from the existing pattern).
  </action>
  <verify>
Run: `cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core && php tests/integration/agents-feature-parity.php`
All tests should pass (exit code 0). If a test fails due to a bug in the underlying application code (e.g., a repository method throws an exception, returns wrong data), fix the code bug with an atomic commit. If a test fails due to incorrect test logic (e.g., wrong method signature, wrong expected value), fix the test script.
  </verify>
  <done>
agents-feature-parity.php exists, runs via CLI, reports pass/fail for all 10 test categories including FEAT-02 metadata CRUD, exits 0 with all tests passing.
  </done>
</task>

</tasks>

<verification>
- `php tests/integration/agents-feature-parity.php` exits with code 0
- All 10 test categories report PASS for every check
- Metadata CRUD tests verify full lifecycle (add/get/update/delete) for meta, notes, and absences
- Script follows same structure as clients-feature-parity.php
</verification>

<success_criteria>
- CLI test script created and passing
- All shortcodes, AJAX endpoints, classes, DB tables, views, JS assets verified
- Statistics queries confirmed working
- Working areas service confirmed functional
- Agent metadata CRUD (meta, notes, absences) confirmed functional via real method calls
- No standalone plugin references found
</success_criteria>

<output>
After completion, create `.planning/phases/29-feature-verification/29-01-SUMMARY.md`
</output>
