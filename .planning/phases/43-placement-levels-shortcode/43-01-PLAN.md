---
phase: 43-placement-levels-shortcode
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false
requirements: []

must_haves:
  truths:
    - "[wecoza_manage_placement_levels] shortcode renders a Phoenix-styled CRUD table on its WordPress page"
    - "Table displays existing placement levels from learner_placement_level (level + level_desc columns)"
    - "User can add a new placement level and it persists in the database"
    - "User can inline-edit an existing placement level and save changes"
    - "User can delete a placement level with confirmation"
    - "Learner capture form dropdown still populates from learner_placement_level"
  artifacts:
    - path: "src/LookupTables/Controllers/LookupTableController.php"
      provides: "placement_levels config in TABLES constant + shortcode registration"
      contains: "placement_levels"
    - path: "views/lookup-tables/manage.view.php"
      provides: "Shared CRUD table view template (reused from Phase 42)"
    - path: "assets/js/lookup-tables/lookup-table-manager.js"
      provides: "Shared JS CRUD manager (reused from Phase 42)"
  key_links:
    - from: "LookupTableController::SHORTCODE_MAP"
      to: "LookupTableController::TABLES['placement_levels']"
      via: "shortcode tag dispatch"
      pattern: "wecoza_manage_placement_levels.*placement_levels"
    - from: "LookupTableAjaxHandler"
      to: "LookupTableRepository"
      via: "config-driven CRUD"
      pattern: "new LookupTableRepository.*config"
---

<objective>
Fix the missing auto-increment sequence on `learner_placement_level.placement_level_id` and verify the `[wecoza_manage_placement_levels]` shortcode works end-to-end.

Purpose: Phase 42-01 already wired all PHP code (config, shortcode registration, autoloader). The only blocker is that `placement_level_id` lacks a DEFAULT sequence, so INSERT will fail with a NOT NULL violation. Once the DDL is applied, the shortcode is fully functional.

Output: Working placement levels admin UI via `[wecoza_manage_placement_levels]` shortcode.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/42-lookup-table-crud-infrastructure-qualifications-shortcode/42-01-SUMMARY.md
@src/LookupTables/Controllers/LookupTableController.php
@src/LookupTables/Repositories/LookupTableRepository.php
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Apply auto-increment sequence to placement_level_id</name>
  <action>
The `learner_placement_level.placement_level_id` column has NO auto-increment sequence (unlike `learner_qualifications.id` which uses `nextval('learner_qualifications_id_seq')`). The repository INSERT does `INSERT INTO (level, level_desc) VALUES (...) RETURNING placement_level_id` — without a DEFAULT, this fails with a NOT NULL violation.

Run the following SQL on the PostgreSQL database:

```sql
-- Create sequence starting after the current max ID
CREATE SEQUENCE learner_placement_level_placement_level_id_seq
    START WITH 27
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;

-- Set the column default to use the sequence
ALTER TABLE learner_placement_level
    ALTER COLUMN placement_level_id
    SET DEFAULT nextval('learner_placement_level_placement_level_id_seq'::regclass);

-- Assign the sequence ownership to the column (for pg_dump/drop cascade)
ALTER SEQUENCE learner_placement_level_placement_level_id_seq
    OWNED BY learner_placement_level.placement_level_id;
```

Note: START WITH 27 because current MAX(placement_level_id) is 26.
  </action>
  <how-to-verify>
After running the SQL, verify:
```sql
SELECT column_default FROM information_schema.columns
WHERE table_name = 'learner_placement_level' AND column_name = 'placement_level_id';
```
Should return: `nextval('learner_placement_level_placement_level_id_seq'::regclass)`
  </how-to-verify>
  <verify>Run: `SELECT column_default FROM information_schema.columns WHERE table_name = 'learner_placement_level' AND column_name = 'placement_level_id';` — should return nextval sequence</verify>
  <done>placement_level_id column has auto-increment DEFAULT via sequence, enabling INSERT without explicit PK</done>
  <resume-signal>Type "done" after executing the SQL successfully</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify placement levels shortcode end-to-end</name>
  <action>
All PHP code was already implemented in Phase 42-01:
- `LookupTableController::TABLES` has `placement_levels` config entry
- `LookupTableController::SHORTCODE_MAP` maps `wecoza_manage_placement_levels` to `placement_levels`
- `registerShortcodes()` registers the shortcode
- `enqueueAssets()` detects the shortcode and loads JS
- Shared view template (`manage.view.php`) renders multi-column tables via config
- Shared JS (`lookup-table-manager.js`) handles CRUD for any table key

With the auto-increment fix from Task 1, the shortcode should be fully functional. No new code changes needed — only human verification.
  </action>
  <what-built>
Complete placement levels CRUD UI via `[wecoza_manage_placement_levels]` shortcode, reusing Phase 42 infrastructure with only a database sequence fix.
  </what-built>
  <how-to-verify>
1. Create a WordPress page with shortcode `[wecoza_manage_placement_levels]` (or navigate to the existing page if one was already created)
2. Verify the page renders a Phoenix card titled "Manage Placement Levels"
3. Verify existing placement levels load in the table (NL1, NL2, NL3, etc.) with two columns: "Level Code" and "Description"
4. **Add test:** Enter a new level code (e.g. "TEST1") and description (e.g. "Test Level"), click Add — verify it appears in the table
5. **Edit test:** Click the edit (pencil) icon on the test row, change the description, click save (checkmark) — verify the change persists after page reload
6. **Delete test:** Click the delete (trash) icon on the test row, confirm — verify it disappears
7. **Cross-check:** Navigate to a learner capture form and verify the placement level dropdown still populates correctly from the same table
  </how-to-verify>
  <verify>Human verifies all 7 steps above pass</verify>
  <done>All CRUD operations work, placement levels display correctly, learner form dropdown unaffected</done>
  <resume-signal>Type "approved" if all CRUD operations work, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `[wecoza_manage_placement_levels]` renders a Phoenix table with Level Code and Description columns
- All CRUD operations (list, add, edit, delete) work without errors
- No PHP errors in debug.log related to learner_placement_level
- Learner capture form dropdown still works
</verification>

<success_criteria>
- Placement levels admin UI is live and functional via shortcode
- Users with `manage_options` capability can add, edit, and delete placement levels
- Existing learner form integrations are unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/43-placement-levels-shortcode/43-01-SUMMARY.md`
</output>
