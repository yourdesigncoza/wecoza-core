---
phase: 18-notification-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - schema/class_events.sql
  - src/Events/Repositories/ClassEventRepository.php
  - src/Events/DTOs/ClassEventDTO.php
  - src/Events/Enums/EventType.php
autonomous: true

must_haves:
  truths:
    - "class_events table exists in PostgreSQL with all required columns"
    - "ClassEventRepository can insert and query events"
    - "EventType enum defines all supported event types"
  artifacts:
    - path: "schema/class_events.sql"
      provides: "PostgreSQL DDL for class_events table"
      contains: "CREATE TABLE class_events"
    - path: "src/Events/Repositories/ClassEventRepository.php"
      provides: "Repository for event CRUD operations"
      exports: ["ClassEventRepository"]
    - path: "src/Events/DTOs/ClassEventDTO.php"
      provides: "Immutable DTO for event data"
      exports: ["ClassEventDTO"]
    - path: "src/Events/Enums/EventType.php"
      provides: "Enum for event types"
      exports: ["EventType"]
  key_links:
    - from: "src/Events/Repositories/ClassEventRepository.php"
      to: "class_events table"
      via: "PDO queries"
      pattern: "class_events"
---

<objective>
Create the `class_events` database table and repository infrastructure for application-level event storage.

Purpose: Foundation for notification system - events must be stored before they can be processed, enriched, and sent as notifications.

Output: Database schema, repository, DTO, and enum for event types.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Events/Repositories/ClassTaskRepository.php (reference for repository pattern)
@src/Events/DTOs/RecordDTO.php (reference for DTO pattern)
@src/Events/Enums/SummaryStatus.php (reference for enum pattern)
@core/Abstract/BaseRepository.php (base class for repositories)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create class_events table schema</name>
  <files>schema/class_events.sql</files>
  <action>
Create PostgreSQL DDL for class_events table with columns:
- `event_id` SERIAL PRIMARY KEY
- `event_type` VARCHAR(50) NOT NULL (INSERT, UPDATE, DELETE, LEARNER_ADD, LEARNER_REMOVE, STATUS_CHANGE)
- `entity_type` VARCHAR(50) NOT NULL (class, learner)
- `entity_id` INTEGER NOT NULL (class_id or learner_id)
- `user_id` INTEGER (WordPress user who triggered event)
- `event_data` JSONB NOT NULL (full payload: new_row, old_row, diff, metadata)
- `ai_summary` JSONB (AI enrichment result)
- `notification_status` VARCHAR(20) DEFAULT 'pending' (pending, enriching, sending, sent, failed)
- `created_at` TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
- `enriched_at` TIMESTAMP WITH TIME ZONE
- `sent_at` TIMESTAMP WITH TIME ZONE
- `viewed_at` TIMESTAMP WITH TIME ZONE
- `acknowledged_at` TIMESTAMP WITH TIME ZONE

Add indexes on:
- entity_type, entity_id (composite index for lookups)
- notification_status (for queue processing)
- created_at DESC (for timeline display)

Include COMMENT ON TABLE and COMMENT ON COLUMN for documentation.
  </action>
  <verify>
SQL file exists at schema/class_events.sql with valid PostgreSQL syntax.
Execute schema against test database if available, or validate syntax manually.
  </verify>
  <done>Schema file created with all columns, indexes, and comments.</done>
</task>

<task type="auto">
  <name>Task 2: Create EventType enum and ClassEventDTO</name>
  <files>src/Events/Enums/EventType.php, src/Events/DTOs/ClassEventDTO.php</files>
  <action>
Create EventType enum (src/Events/Enums/EventType.php):
- Use PHP 8.1 backed enum with string values
- Cases: CLASS_INSERT, CLASS_UPDATE, CLASS_DELETE, LEARNER_ADD, LEARNER_REMOVE, LEARNER_UPDATE, STATUS_CHANGE
- Add static method `forEntity(string $entityType, string $operation): self` to map operation to event type
- Add method `label(): string` for human-readable labels

Create ClassEventDTO (src/Events/DTOs/ClassEventDTO.php):
- Readonly class with constructor promotion
- Properties matching table columns (eventId, eventType, entityType, entityId, userId, eventData, aiSummary, notificationStatus, createdAt, enrichedAt, sentAt, viewedAt, acknowledgedAt)
- Static factory `fromRow(array $row): self` for database hydration
- Method `toArray(): array` for serialization
- Methods `withStatus(string $status): self`, `withAiSummary(array $summary): self`, `withSentAt(?string $sentAt): self` etc. for immutable updates

Follow existing patterns from RecordDTO and SummaryStatus enum.
  </action>
  <verify>
```bash
php -l src/Events/Enums/EventType.php
php -l src/Events/DTOs/ClassEventDTO.php
```
  </verify>
  <done>EventType enum and ClassEventDTO exist with all required methods.</done>
</task>

<task type="auto">
  <name>Task 3: Create ClassEventRepository</name>
  <files>src/Events/Repositories/ClassEventRepository.php</files>
  <action>
Create ClassEventRepository extending BaseRepository:
- Set $table = 'class_events', $primaryKey = 'event_id'
- Implement getAllowedOrderColumns(), getAllowedFilterColumns(), getAllowedInsertColumns(), getAllowedUpdateColumns()

Methods to implement:
1. `insert(ClassEventDTO $event): int` - Insert new event, return event_id
2. `findById(int $eventId): ?ClassEventDTO` - Get single event by ID
3. `findPendingForProcessing(int $limit = 50): array` - Get events with notification_status = 'pending', ordered by created_at ASC
4. `findByEntity(string $entityType, int $entityId, int $limit = 50): array` - Get events for an entity
5. `updateStatus(int $eventId, string $status): bool` - Update notification_status
6. `updateAiSummary(int $eventId, array $summary): bool` - Update ai_summary JSONB
7. `markSent(int $eventId): bool` - Set sent_at to current timestamp
8. `markViewed(int $eventId): bool` - Set viewed_at to current timestamp
9. `markAcknowledged(int $eventId): bool` - Set acknowledged_at to current timestamp
10. `getTimeline(int $limit = 50, ?int $afterId = null): array` - For dashboard display
11. `getUnreadCount(): int` - Count events where viewed_at IS NULL

Use parameterized queries with PDO. Return ClassEventDTO objects (or arrays of them).
  </action>
  <verify>
```bash
php -l src/Events/Repositories/ClassEventRepository.php
```
  </verify>
  <done>ClassEventRepository exists with all CRUD operations for events.</done>
</task>

</tasks>

<verification>
1. All 4 files exist and pass PHP syntax check
2. EventType enum has all required cases
3. ClassEventDTO has all table columns as properties
4. ClassEventRepository extends BaseRepository correctly
5. SQL schema is valid PostgreSQL syntax
</verification>

<success_criteria>
- Database schema ready for execution
- Repository can be instantiated without errors
- DTO correctly maps database rows to objects
- Enum provides type safety for event types
</success_criteria>

<output>
After completion, create `.planning/phases/18-notification-system/18-01-SUMMARY.md`
</output>
