---
phase: 18-notification-system
plan: 06
type: execute
wave: 3
depends_on: ["18-03", "18-04", "18-05"]
files_modified:
  - wecoza-core.php
  - src/Events/Services/NotificationSettings.php
autonomous: true

must_haves:
  truths:
    - "Notification hooks are enabled in wecoza-core.php"
    - "Action Scheduler handlers process events from class_events"
    - "Multiple recipients can be configured per event type"
    - "Cron job schedules event processing"
  artifacts:
    - path: "wecoza-core.php"
      provides: "Main plugin file with enabled hooks"
      contains: "wecoza_process_event"
    - path: "src/Events/Services/NotificationSettings.php"
      provides: "Settings service with multi-recipient support"
  key_links:
    - from: "wecoza-core.php"
      to: "src/Events/Services/NotificationProcessor.php"
      via: "add_action hook"
      pattern: "NotificationProcessor::boot"
---

<objective>
Enable notification system hooks in wecoza-core.php and update NotificationSettings for multi-recipient support.

Purpose: The notification pipeline needs to be wired up and activated for events to flow through.

Output: Working notification system with all hooks enabled.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@wecoza-core.php (main plugin file with disabled hooks)
@src/Events/Services/NotificationSettings.php (existing settings service)
@src/Events/Services/NotificationProcessor.php (updated in 18-03)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update NotificationSettings for multi-recipient</name>
  <files>src/Events/Services/NotificationSettings.php</files>
  <action>
First, read the current NotificationSettings to understand its structure.

Enhance for multi-recipient support:

1. Update getRecipientForOperation() to support multiple recipients:
   - Rename to getRecipientsForEventType(string $eventType): array
   - Return array of email addresses instead of single string
   - Keep backward compatibility by accepting old 'INSERT'/'UPDATE' values

2. Add method for event type mapping:
   - `mapOperationToEventType(string $operation): string`
   - Maps legacy 'INSERT' -> EventType::CLASS_INSERT->value
   - Maps legacy 'UPDATE' -> EventType::CLASS_UPDATE->value

3. Update option structure for multi-recipient:
   - Change from single email to array of emails
   - Option key: 'wecoza_notification_recipients'
   - Structure: ['CLASS_INSERT' => ['email1', 'email2'], 'CLASS_UPDATE' => [...], ...]

4. Add helper methods:
   - `getRecipientsByEventType(EventType $type): array`
   - `setRecipientsForEventType(EventType $type, array $emails): void`
   - `getAllRecipientSettings(): array`

5. Add validation:
   - `validateEmail(string $email): bool`
   - Filter out invalid emails before returning

6. Add default recipients:
   - If no recipients configured for type, return empty array
   - Log warning if notifications enabled but no recipients
  </action>
  <verify>
```bash
php -l src/Events/Services/NotificationSettings.php
```
  </verify>
  <done>NotificationSettings supports multiple recipients per event type.</done>
</task>

<task type="auto">
  <name>Task 2: Enable notification hooks in wecoza-core.php</name>
  <files>wecoza-core.php</files>
  <action>
Re-enable and update the notification hooks:

1. Find the DEPRECATED comment block for 'wecoza_email_notifications_process'
2. Replace with new handler for 'wecoza_process_notifications':
```php
add_action('wecoza_process_notifications', function () {
    if (!class_exists(\WeCoza\Events\Services\NotificationProcessor::class)) {
        return;
    }

    $processor = \WeCoza\Events\Services\NotificationProcessor::boot();
    $processor->process();
});
```

3. Find the DEPRECATED comment block for 'wecoza_enrich_notification'
4. Replace with new handler for 'wecoza_process_event':
```php
add_action('wecoza_process_event', function (int $eventId) {
    if (!class_exists(\WeCoza\Events\Services\NotificationEnricher::class)) {
        return;
    }

    $enricher = \WeCoza\Events\Services\NotificationEnricher::boot();
    $result = $enricher->enrich($eventId);

    if ($result['success'] && $result['should_email']) {
        // Schedule email for each recipient
        $recipients = $result['recipients'] ?? [];
        foreach ($recipients as $recipient) {
            as_enqueue_async_action(
                'wecoza_send_notification_email',
                [
                    'event_id' => $eventId,
                    'recipient' => $recipient,
                    'email_context' => $result['email_context'],
                ],
                'wecoza-notifications'
            );
        }
    }
}, 10, 1);
```

5. Update 'wecoza_send_notification_email' handler:
```php
add_action('wecoza_send_notification_email', function (int $eventId, string $recipient, array $emailContext = []) {
    if (!class_exists(\WeCoza\Events\Services\NotificationEmailer::class)) {
        return;
    }

    $emailer = \WeCoza\Events\Services\NotificationEmailer::boot();
    $emailer->send($eventId, $recipient, $emailContext);
}, 10, 3);
```

6. Update activation hook:
   - Re-enable cron schedule for 'wecoza_process_notifications'
   - Schedule hourly processing

7. Update deactivation hook:
   - Unschedule 'wecoza_process_notifications'

8. Re-enable AISummaryShortcode registration:
```php
if (class_exists(\WeCoza\Events\Shortcodes\AISummaryShortcode::class)) {
    \WeCoza\Events\Shortcodes\AISummaryShortcode::register();
}
```

9. Remove all DEPRECATED comments related to notification system
  </action>
  <verify>
```bash
php -l wecoza-core.php
grep -n "wecoza_process_event" wecoza-core.php
grep -n "DEPRECATED" wecoza-core.php | wc -l  # Should be reduced
```
  </verify>
  <done>All notification hooks enabled in wecoza-core.php.</done>
</task>

<task type="auto">
  <name>Task 3: Add AJAX handlers for dashboard interactions</name>
  <files>wecoza-core.php</files>
  <action>
Add AJAX handlers for dashboard mark-as-read functionality:

1. Add handler for marking notification viewed:
```php
add_action('wp_ajax_wecoza_mark_notification_viewed', function () {
    check_ajax_referer('wecoza_notifications_nonce', 'nonce');

    if (!current_user_can('read')) {
        wp_send_json_error(['message' => 'Unauthorized'], 403);
    }

    $eventId = absint($_POST['event_id'] ?? 0);
    if ($eventId <= 0) {
        wp_send_json_error(['message' => 'Invalid event ID'], 400);
    }

    $service = \WeCoza\Events\Services\NotificationDashboardService::boot();
    $success = $service->markAsViewed($eventId);

    if ($success) {
        wp_send_json_success(['message' => 'Marked as viewed']);
    } else {
        wp_send_json_error(['message' => 'Failed to update'], 500);
    }
});
```

2. Add handler for marking notification acknowledged:
```php
add_action('wp_ajax_wecoza_mark_notification_acknowledged', function () {
    check_ajax_referer('wecoza_notifications_nonce', 'nonce');

    if (!current_user_can('read')) {
        wp_send_json_error(['message' => 'Unauthorized'], 403);
    }

    $eventId = absint($_POST['event_id'] ?? 0);
    if ($eventId <= 0) {
        wp_send_json_error(['message' => 'Invalid event ID'], 400);
    }

    $service = \WeCoza\Events\Services\NotificationDashboardService::boot();
    $success = $service->markAsAcknowledged($eventId);

    if ($success) {
        wp_send_json_success(['message' => 'Acknowledged']);
    } else {
        wp_send_json_error(['message' => 'Failed to update'], 500);
    }
});
```

3. Add localized script data for notifications:
   - In wp_enqueue_scripts section, add nonce for notification AJAX
   - 'wecoza_notifications_nonce' => wp_create_nonce('wecoza_notifications_nonce')
  </action>
  <verify>
```bash
php -l wecoza-core.php
grep -n "wecoza_mark_notification" wecoza-core.php
```
  </verify>
  <done>Dashboard AJAX handlers registered for viewed/acknowledged tracking.</done>
</task>

</tasks>

<verification>
1. wecoza-core.php passes PHP lint
2. NotificationSettings supports array of recipients
3. 'wecoza_process_event' action is registered
4. 'wecoza_send_notification_email' action is registered
5. Cron job scheduled for 'wecoza_process_notifications'
6. AISummaryShortcode is re-enabled
7. Dashboard AJAX handlers are registered
</verification>

<success_criteria>
- Plugin activates without errors
- Cron job appears in scheduled events
- Action Scheduler can process notification jobs
- Dashboard shortcode renders
- AJAX endpoints respond correctly
</success_criteria>

<output>
After completion, create `.planning/phases/18-notification-system/18-06-SUMMARY.md`
</output>
