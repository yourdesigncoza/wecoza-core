---
phase: 18-notification-system
plan: 03
type: execute
wave: 2
depends_on: ["18-01", "18-02"]
files_modified:
  - src/Events/Services/NotificationProcessor.php
  - src/Events/Services/NotificationEnricher.php
  - src/Events/Services/NotificationEmailer.php
autonomous: true

must_haves:
  truths:
    - "NotificationProcessor reads from class_events table instead of class_change_logs"
    - "NotificationEnricher enriches events from class_events table"
    - "NotificationEmailer sends emails based on class_events data"
    - "All services use ClassEventRepository and ClassEventDTO"
  artifacts:
    - path: "src/Events/Services/NotificationProcessor.php"
      provides: "Batch processor for pending events"
      exports: ["NotificationProcessor"]
    - path: "src/Events/Services/NotificationEnricher.php"
      provides: "AI enrichment for individual events"
      exports: ["NotificationEnricher"]
    - path: "src/Events/Services/NotificationEmailer.php"
      provides: "Email sender for events"
      exports: ["NotificationEmailer"]
  key_links:
    - from: "src/Events/Services/NotificationProcessor.php"
      to: "src/Events/Repositories/ClassEventRepository.php"
      via: "findPendingForProcessing()"
      pattern: "findPendingForProcessing"
    - from: "src/Events/Services/NotificationEnricher.php"
      to: "class_events table"
      via: "ClassEventRepository"
      pattern: "ClassEventRepository"
---

<objective>
Update the existing notification services to work with the new class_events table instead of the dropped class_change_logs table.

Purpose: The 3-stage pipeline (Detect -> Enrich -> Send) must read from and write to the new event storage.

Output: Working notification services that process events from the new infrastructure.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/Events/Repositories/ClassEventRepository.php (from 18-01)
@src/Events/DTOs/ClassEventDTO.php (from 18-01)
@src/Events/Services/AISummaryService.php (AI enrichment service - unchanged)
@src/Events/Services/NotificationSettings.php (settings service - unchanged)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update NotificationProcessor for class_events</name>
  <files>src/Events/Services/NotificationProcessor.php</files>
  <action>
Refactor NotificationProcessor to use ClassEventRepository:

1. Update constructor:
   - Add `private ClassEventRepository $eventRepository`
   - Update boot() to instantiate repository

2. Update OPTION_LAST_ID constant:
   - Change to 'wecoza_last_notified_event_id' (new option name)

3. Replace fetchRows() method:
   - Remove SQL query for class_change_logs
   - Use `$this->eventRepository->findPendingForProcessing($limit)`
   - Returns array of ClassEventDTO objects

4. Update process() loop:
   - Work with ClassEventDTO instead of raw rows
   - Get event_id from $event->eventId
   - Get event_type from $event->eventType (replaces 'operation')
   - Extract event_data from $event->eventData

5. Update job scheduling:
   - Change 'wecoza_enrich_notification' args from ['log_id' => $logId] to ['event_id' => $eventId]
   - Change 'wecoza_send_notification_email' args similarly

6. Update recipient lookup:
   - Use $event->eventType instead of strtoupper($row['operation'])
   - NotificationSettings.getRecipientForOperation() should work with EventType values

7. Update status tracking:
   - After scheduling, call $this->eventRepository->updateStatus($eventId, 'enriching') or 'sending'
   - This prevents re-processing the same event

Remove all references to:
- 'log_id'
- 'class_change_logs' table
- 'operation' column (use eventType)
  </action>
  <verify>
```bash
php -l src/Events/Services/NotificationProcessor.php
```
  </verify>
  <done>NotificationProcessor reads from class_events via ClassEventRepository.</done>
</task>

<task type="auto">
  <name>Task 2: Update NotificationEnricher for class_events</name>
  <files>src/Events/Services/NotificationEnricher.php</files>
  <action>
Refactor NotificationEnricher to use ClassEventRepository:

1. Update constructor:
   - Add `private ClassEventRepository $eventRepository`
   - Update boot() to instantiate repository

2. Update enrich() method signature:
   - Change `enrich(int $logId)` to `enrich(int $eventId)`

3. Replace fetchRow() method:
   - Remove SQL query for class_change_logs
   - Use `$this->eventRepository->findById($eventId)`
   - Returns ClassEventDTO or null

4. Update data extraction:
   - Get operation from $event->eventType
   - Get event_data fields from $event->eventData (already an array)
   - eventData contains: new_row, old_row, diff, metadata

5. Update AI context building:
   - Pass eventData['new_row'], eventData['old_row'], eventData['diff'] to AISummaryService
   - Include $event->entityId as class_id
   - Include $event->createdAt as changed_at

6. Replace persistSummary() method:
   - Remove SQL UPDATE on class_change_logs
   - Use `$this->eventRepository->updateAiSummary($eventId, $summaryRecord)`
   - Also update status to 'enriched' on success

7. Update return structure:
   - Return event_id instead of log_id for chaining to email job

Remove all references to:
- 'log_id'
- 'class_change_logs' table
- Direct SQL queries
  </action>
  <verify>
```bash
php -l src/Events/Services/NotificationEnricher.php
```
  </verify>
  <done>NotificationEnricher uses ClassEventRepository for AI enrichment.</done>
</task>

<task type="auto">
  <name>Task 3: Update NotificationEmailer for class_events</name>
  <files>src/Events/Services/NotificationEmailer.php</files>
  <action>
Refactor NotificationEmailer to use ClassEventRepository:

1. Update constructor:
   - Add `private ClassEventRepository $eventRepository`
   - Update boot() to instantiate repository

2. Update send() method signature:
   - Change `send(int $logId, ...)` to `send(int $eventId, ...)`

3. Replace fetchRow() method:
   - Remove SQL query for class_change_logs
   - Use `$this->eventRepository->findById($eventId)`
   - Returns ClassEventDTO or null

4. Update data extraction for presenter:
   - Get operation from $event->eventType
   - Get new_row from $event->eventData['new_row']
   - Get old_row from $event->eventData['old_row']
   - Get diff from $event->eventData['diff']
   - Get ai_summary from $event->aiSummary (already decoded)

5. Update presenter call:
   - Pass $event->entityId as class_id in 'row' context
   - Pass $event->createdAt as changed_at

6. Add sent timestamp tracking:
   - On successful wp_mail(), call $this->eventRepository->markSent($eventId)
   - Also update status to 'sent'

7. Update logging:
   - Change log messages from "row X" to "event X"

Remove all references to:
- 'log_id'
- 'class_change_logs' table
- Direct SQL queries
  </action>
  <verify>
```bash
php -l src/Events/Services/NotificationEmailer.php
```
  </verify>
  <done>NotificationEmailer uses ClassEventRepository and tracks sent_at timestamp.</done>
</task>

</tasks>

<verification>
1. All 3 service files pass PHP lint
2. No references to 'class_change_logs' remain in these files
3. All services use ClassEventRepository for data access
4. Parameter names changed from log_id to event_id
5. Status updates are applied after each stage
</verification>

<success_criteria>
- NotificationProcessor can batch process pending events
- NotificationEnricher can enrich an event with AI summary
- NotificationEmailer can send email and mark event as sent
- Pipeline flows: pending -> enriching -> enriched -> sending -> sent
</success_criteria>

<output>
After completion, create `.planning/phases/18-notification-system/18-03-SUMMARY.md`
</output>
