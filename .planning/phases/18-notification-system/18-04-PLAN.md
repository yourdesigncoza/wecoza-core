---
phase: 18-notification-system
plan: 04
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/Events/Services/NotificationDashboardService.php
  - src/Events/Shortcodes/AISummaryShortcode.php
  - src/Events/Views/Presenters/AISummaryPresenter.php
autonomous: true

must_haves:
  truths:
    - "Dashboard shortcode displays notification timeline from class_events"
    - "Unread filter shows events where viewed_at IS NULL"
    - "Clicking notification marks it as viewed"
    - "Timeline shows AI summaries with event context"
  artifacts:
    - path: "src/Events/Services/NotificationDashboardService.php"
      provides: "Service for dashboard data retrieval"
      exports: ["NotificationDashboardService"]
    - path: "src/Events/Shortcodes/AISummaryShortcode.php"
      provides: "Shortcode for notification dashboard"
      exports: ["AISummaryShortcode"]
  key_links:
    - from: "src/Events/Shortcodes/AISummaryShortcode.php"
      to: "src/Events/Services/NotificationDashboardService.php"
      via: "dependency injection"
      pattern: "NotificationDashboardService"
---

<objective>
Update the AI Summary shortcode and create a dashboard service to display notifications from the new class_events table.

Purpose: Users need a dashboard to view notification timeline, filter unread, and acknowledge notifications.

Output: Working dashboard shortcode backed by new event data.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/Events/Repositories/ClassEventRepository.php (from 18-01)
@src/Events/DTOs/ClassEventDTO.php (from 18-01)
@src/Events/Shortcodes/AISummaryShortcode.php (existing, disabled)
@src/Events/Services/AISummaryDisplayService.php (existing, uses class_change_logs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationDashboardService</name>
  <files>src/Events/Services/NotificationDashboardService.php</files>
  <action>
Create NotificationDashboardService to replace AISummaryDisplayService:

```php
namespace WeCoza\Events\Services;

use WeCoza\Events\Repositories\ClassEventRepository;
use WeCoza\Events\DTOs\ClassEventDTO;
```

Constructor:
- `__construct(ClassEventRepository $repository)`
- Static factory `boot(): self`

Methods:

1. `getTimeline(int $limit = 50, ?int $afterEventId = null, bool $unreadOnly = false): array`
   - Uses repository->getTimeline() for pagination
   - If $unreadOnly, filters to viewed_at IS NULL
   - Returns array of ClassEventDTO objects

2. `getByEntity(string $entityType, int $entityId, int $limit = 50): array`
   - Gets events for specific class or learner
   - Uses repository->findByEntity()

3. `getUnreadCount(): int`
   - Returns count of events where viewed_at IS NULL
   - Uses repository->getUnreadCount()

4. `markAsViewed(int $eventId): bool`
   - Sets viewed_at timestamp
   - Uses repository->markViewed()

5. `markAsAcknowledged(int $eventId): bool`
   - Sets acknowledged_at timestamp
   - Uses repository->markAcknowledged()

6. `getStatistics(): array`
   - Returns counts by status, event_type
   - Useful for dashboard overview widgets

7. `transformForDisplay(ClassEventDTO $event): array`
   - Converts DTO to array suitable for presenter
   - Extracts: event_id, event_type, entity_type, entity_id
   - Extracts: class_code, class_subject from event_data['new_row']
   - Extracts: ai_summary if present
   - Formats: created_at, sent_at, viewed_at as human-readable
   - Adds: is_read boolean (viewed_at !== null)
  </action>
  <verify>
```bash
php -l src/Events/Services/NotificationDashboardService.php
```
  </verify>
  <done>NotificationDashboardService provides all data access for dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Update AISummaryShortcode for class_events</name>
  <files>src/Events/Shortcodes/AISummaryShortcode.php</files>
  <action>
Refactor AISummaryShortcode to use NotificationDashboardService:

1. Update dependencies:
   - Replace AISummaryDisplayService with NotificationDashboardService
   - Update constructor and factory

2. Add new shortcode attributes:
   - 'unread_only' => false (boolean filter)
   - 'show_filters' => true (show filter controls)
   - Keep existing: limit, layout, class_id, operation

3. Update render() method:
   - Call $this->service->getTimeline() instead of getSummaries()
   - Pass unread_only filter
   - Transform results via $this->service->transformForDisplay()

4. Add AJAX endpoint for marking viewed:
   - Register 'wecoza_mark_notification_viewed' AJAX action
   - Handler calls $this->service->markAsViewed($eventId)
   - Verify nonce and capability

5. Add AJAX endpoint for marking acknowledged:
   - Register 'wecoza_mark_notification_acknowledged' AJAX action
   - Handler calls $this->service->markAsAcknowledged($eventId)

6. Update template data:
   - Pass 'unreadCount' from $this->service->getUnreadCount()
   - Pass 'showFilters' based on attribute

7. Update JavaScript assets:
   - Add click handler for marking notifications viewed
   - Add acknowledge button handler
   - Add unread filter toggle
  </action>
  <verify>
```bash
php -l src/Events/Shortcodes/AISummaryShortcode.php
```
  </verify>
  <done>AISummaryShortcode uses NotificationDashboardService and supports unread filter.</done>
</task>

<task type="auto">
  <name>Task 3: Update AISummaryPresenter for new data structure</name>
  <files>src/Events/Views/Presenters/AISummaryPresenter.php</files>
  <action>
Update AISummaryPresenter to work with ClassEventDTO-derived data:

1. Update present() method signature:
   - Accept array of transformed event data (from NotificationDashboardService)

2. Update field mappings:
   - event_id instead of log_id
   - event_type instead of operation (map to human-readable labels)
   - Use event_data['new_row'] for class details
   - Use entity_type and entity_id for links

3. Add new fields to output:
   - 'is_read' for visual styling (read vs unread)
   - 'sent_at' formatted timestamp
   - 'viewed_at' formatted timestamp
   - 'acknowledged_at' formatted timestamp
   - 'acknowledge_button' HTML if not yet acknowledged

4. Update search index generation:
   - Include event_type label
   - Include class_code, class_subject
   - Include AI summary text

5. Add method for unread indicator:
   - `private formatUnreadBadge(bool $isRead): string`
   - Returns badge HTML or empty string

6. Update timeline item structure:
   - Add data-event-id attribute for AJAX
   - Add click handler hook for marking viewed
   - Add acknowledge button
  </action>
  <verify>
```bash
php -l src/Events/Views/Presenters/AISummaryPresenter.php
```
  </verify>
  <done>AISummaryPresenter formats new event data for display.</done>
</task>

</tasks>

<verification>
1. All 3 files pass PHP lint
2. NotificationDashboardService can retrieve timeline data
3. AISummaryShortcode renders with new service
4. AJAX endpoints are registered for mark viewed/acknowledged
5. Presenter outputs correct data structure
</verification>

<success_criteria>
- Dashboard shows notification timeline
- Unread filter works
- Clicking notification marks as viewed
- Acknowledge button works
- No references to class_change_logs remain
</success_criteria>

<output>
After completion, create `.planning/phases/18-notification-system/18-04-SUMMARY.md`
</output>
