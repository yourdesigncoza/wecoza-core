---
phase: 18-notification-system
plan: 05
type: execute
wave: 2
depends_on: ["18-02"]
files_modified:
  - src/Classes/Services/FormDataProcessor.php
  - src/Classes/Controllers/ClassAjaxController.php
  - src/Learners/Ajax/LearnerAjaxHandlers.php
autonomous: true

must_haves:
  truths:
    - "Class create triggers notification event"
    - "Class major updates trigger notification events"
    - "Learner add/remove triggers notification events"
    - "Events capture before/after state for diffing"
  artifacts:
    - path: "src/Classes/Services/FormDataProcessor.php"
      provides: "Form processor with event dispatching"
      min_lines: 100
    - path: "src/Classes/Controllers/ClassAjaxController.php"
      provides: "AJAX controller with event dispatching"
  key_links:
    - from: "src/Classes/Services/FormDataProcessor.php"
      to: "src/Events/Services/EventDispatcher.php"
      via: "method call"
      pattern: "EventDispatcher"
---

<objective>
Integrate EventDispatcher into class and learner controllers to capture application events.

Purpose: Events must be dispatched at the point of change for the notification pipeline to process them.

Output: Controllers dispatch events on class create/update and learner changes.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/Events/Services/EventDispatcher.php (from 18-02)
@src/Events/Enums/EventType.php (from 18-01)
@src/Classes/Services/FormDataProcessor.php (existing class form processor)
@src/Classes/Controllers/ClassAjaxController.php (existing AJAX controller)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add event dispatching to FormDataProcessor</name>
  <files>src/Classes/Services/FormDataProcessor.php</files>
  <action>
First, read the current FormDataProcessor to understand its structure.

Add event dispatching for class create/update:

1. Add import at top:
```php
use WeCoza\Events\Services\EventDispatcher;
use WeCoza\Events\Enums\EventType;
```

2. In the method that handles class INSERT (likely processInsert or similar):
   - After successful database insert
   - Call `EventDispatcher::classCreated($classId, $classData)`
   - $classData should be the full row data that was inserted

3. In the method that handles class UPDATE:
   - BEFORE update: Fetch current row state as $oldData
   - AFTER successful update: Get new row state as $newData
   - Call `EventDispatcher::classUpdated($classId, $newData, $oldData)`
   - EventDispatcher will compute diff and filter insignificant changes

4. Wrap dispatch calls in try/catch:
   - Log errors but don't fail the main operation
   - Notifications are secondary to data persistence

Example pattern:
```php
try {
    EventDispatcher::classCreated($classId, $classData);
} catch (\Throwable $e) {
    wecoza_log('Event dispatch failed: ' . $e->getMessage(), 'warning');
}
```

5. For status changes, add explicit dispatch:
   - If class_status field changes, call dispatchStatusChange() for visibility
  </action>
  <verify>
```bash
php -l src/Classes/Services/FormDataProcessor.php
grep -n "EventDispatcher" src/Classes/Services/FormDataProcessor.php
```
  </verify>
  <done>FormDataProcessor dispatches events on class create/update.</done>
</task>

<task type="auto">
  <name>Task 2: Add event dispatching to ClassAjaxController</name>
  <files>src/Classes/Controllers/ClassAjaxController.php</files>
  <action>
First, read the current ClassAjaxController to understand its AJAX handlers.

Add event dispatching for learner changes:

1. Add imports:
```php
use WeCoza\Events\Services\EventDispatcher;
use WeCoza\Events\Enums\EventType;
```

2. Find the handler for adding learners to a class:
   - After successful learner add
   - Call `EventDispatcher::learnerAdded($classId, $learnerId, $learnerData)`
   - $learnerData should include learner name/ID for the event payload

3. Find the handler for removing learners from a class:
   - After successful learner remove
   - Call `EventDispatcher::learnerRemoved($classId, $learnerId, $learnerData)`

4. Find the handler for updating learner data on a class:
   - After successful update
   - Dispatch LEARNER_UPDATE event if significant changes

5. If learner changes are handled in FormDataProcessor instead:
   - Add dispatch calls there following same pattern
   - Check event_dates field for learner_ids changes

6. Wrap all dispatch calls in try/catch for resilience
  </action>
  <verify>
```bash
php -l src/Classes/Controllers/ClassAjaxController.php
grep -n "EventDispatcher" src/Classes/Controllers/ClassAjaxController.php
```
  </verify>
  <done>ClassAjaxController dispatches events on learner add/remove.</done>
</task>

<task type="auto">
  <name>Task 3: Add event dispatching to LearnerAjaxHandlers</name>
  <files>src/Learners/Ajax/LearnerAjaxHandlers.php</files>
  <action>
First, read LearnerAjaxHandlers to understand learner CRUD operations.

Note: Learner notifications may be class-context specific. Only dispatch events when:
- Learner is added/removed from a class (classId context exists)
- NOT for standalone learner CRUD (create learner, update learner profile)

If this file handles class-learner associations:

1. Add imports:
```php
use WeCoza\Events\Services\EventDispatcher;
use WeCoza\Events\Enums\EventType;
```

2. In handlers that modify class-learner relationships:
   - Call appropriate EventDispatcher method
   - Include classId in the context

3. If no class-learner handlers exist here:
   - Skip modifications to this file
   - Document that learner-class events are handled elsewhere

The goal is to capture events where a class's learner roster changes, not standalone learner profile changes.
  </action>
  <verify>
```bash
php -l src/Learners/Ajax/LearnerAjaxHandlers.php
```
  </verify>
  <done>LearnerAjaxHandlers dispatches events for class-learner relationship changes (if applicable).</done>
</task>

</tasks>

<verification>
1. All modified files pass PHP lint
2. EventDispatcher calls exist in class create/update paths
3. EventDispatcher calls exist in learner add/remove paths
4. All dispatch calls are wrapped in try/catch
5. Event data includes sufficient context for notifications
</verification>

<success_criteria>
- Creating a class dispatches CLASS_INSERT event
- Updating a class dispatches CLASS_UPDATE event (for significant changes)
- Adding learner to class dispatches LEARNER_ADD event
- Removing learner from class dispatches LEARNER_REMOVE event
- Failed dispatches don't break the main operation
</success_criteria>

<output>
After completion, create `.planning/phases/18-notification-system/18-05-SUMMARY.md`
</output>
