---
phase: 18-notification-system
plan: 08
type: execute
wave: 4
depends_on: ["18-06", "18-07"]
files_modified:
  - views/events/ai-summary/main.php
  - views/events/ai-summary/item.php
autonomous: false

must_haves:
  truths:
    - "Dashboard displays notification timeline correctly"
    - "Unread notifications show visual distinction"
    - "Clicking notification marks as viewed"
    - "Acknowledge button works"
    - "Filters work (unread, event type, search)"
  artifacts:
    - path: "views/events/ai-summary/main.php"
      provides: "Main dashboard template"
    - path: "views/events/ai-summary/item.php"
      provides: "Individual notification item template"
---

<objective>
Update dashboard view templates to display notification timeline with unread filtering and acknowledgement.

Purpose: Final UI layer for the notification dashboard that users will interact with.

Output: Working notification dashboard UI with full functionality.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@views/events/ai-summary/main.php (existing template, if any)
@src/Events/Shortcodes/AISummaryShortcode.php (updated in 18-04)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update main dashboard template</name>
  <files>views/events/ai-summary/main.php</files>
  <action>
First, check if views/events/ai-summary/main.php exists. If not, create it.

Update/create the main dashboard template:

1. Header section with unread count badge:
```php
<div class="wecoza-notifications-dashboard" id="<?php echo esc_attr($instanceId); ?>">
    <div class="notifications-header d-flex justify-content-between align-items-center mb-3">
        <h4>
            Notifications
            <?php if ($unreadCount > 0): ?>
            <span class="badge bg-danger"><?php echo esc_html($unreadCount); ?> unread</span>
            <?php endif; ?>
        </h4>
        <div class="notifications-actions">
            <button type="button" class="btn btn-sm btn-outline-primary" id="<?php echo esc_attr($instanceId); ?>-toggle-unread">
                Show Unread Only
            </button>
        </div>
    </div>
```

2. Filter controls section:
```php
    <div class="notifications-filters mb-3" data-role="ai-filter-form">
        <div class="row g-2">
            <div class="col-md-6">
                <input type="text" class="form-control" data-role="ai-search"
                    id="<?php echo esc_attr($searchInputId); ?>"
                    placeholder="Search notifications...">
            </div>
            <div class="col-md-3">
                <select class="form-select" data-role="operation-filter"
                    id="<?php echo esc_attr($operationFilterId); ?>">
                    <option value="">All Types</option>
                    <option value="CLASS_INSERT">Class Created</option>
                    <option value="CLASS_UPDATE">Class Updated</option>
                    <option value="LEARNER_ADD">Learner Added</option>
                    <option value="LEARNER_REMOVE">Learner Removed</option>
                </select>
            </div>
        </div>
        <div class="filter-status mt-2" data-role="filter-status" hidden></div>
    </div>
```

3. Timeline list container:
```php
    <div class="notifications-list <?php echo esc_attr($layout); ?>-layout"
         data-nonce="<?php echo wp_create_nonce('wecoza_notifications_nonce'); ?>">
        <?php if (empty($summaries)): ?>
        <div class="alert alert-info">No notifications found.</div>
        <?php else: ?>
            <?php foreach ($summaries as $item): ?>
                <?php include __DIR__ . '/item.php'; ?>
            <?php endforeach; ?>
        <?php endif; ?>
        <div data-role="no-results" hidden class="alert alert-warning">No matching notifications.</div>
    </div>
</div>
```

4. Include assets at end (from shortcode getAssets())
```php
<?php echo $assets; ?>
```
  </action>
  <verify>
```bash
php -l views/events/ai-summary/main.php
ls -la views/events/ai-summary/
```
  </verify>
  <done>Main dashboard template created with header, filters, and list container.</done>
</task>

<task type="auto">
  <name>Task 2: Create/update notification item template</name>
  <files>views/events/ai-summary/item.php</files>
  <action>
Create the individual notification item template:

```php
<?php
/**
 * Notification Item Template
 *
 * @var array $item Notification data from presenter
 */

if (!defined('ABSPATH')) {
    exit;
}

$eventId = esc_attr($item['event_id'] ?? 0);
$eventType = esc_attr($item['event_type'] ?? '');
$isRead = !empty($item['is_read']);
$isAcknowledged = !empty($item['acknowledged_at']);
$searchIndex = esc_attr($item['search_index'] ?? '');
?>

<div class="notification-item card mb-2 <?php echo $isRead ? 'read' : 'unread'; ?>"
     data-role="summary-item"
     data-event-id="<?php echo $eventId; ?>"
     data-operation="<?php echo $eventType; ?>"
     data-search-index="<?php echo $searchIndex; ?>">

    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
            <div class="notification-content flex-grow-1">
                <!-- Unread indicator -->
                <?php if (!$isRead): ?>
                <span class="badge bg-primary me-2">NEW</span>
                <?php endif; ?>

                <!-- Event type badge -->
                <span class="badge bg-secondary me-2">
                    <?php echo esc_html($item['event_type_label'] ?? $eventType); ?>
                </span>

                <!-- Class info -->
                <strong>
                    <?php echo esc_html($item['class_code'] ?? 'Unknown'); ?>
                </strong>
                <span class="text-muted ms-2">
                    <?php echo esc_html($item['class_subject'] ?? ''); ?>
                </span>

                <!-- Timestamp -->
                <small class="text-muted d-block mt-1">
                    <?php echo esc_html($item['created_at_formatted'] ?? ''); ?>
                    <?php if (!empty($item['sent_at_formatted'])): ?>
                    &middot; Sent: <?php echo esc_html($item['sent_at_formatted']); ?>
                    <?php endif; ?>
                </small>

                <!-- AI Summary -->
                <?php if (!empty($item['ai_summary_text'])): ?>
                <div class="ai-summary mt-2 p-2 bg-light rounded">
                    <?php echo wp_kses_post($item['ai_summary_text']); ?>
                </div>
                <?php endif; ?>
            </div>

            <div class="notification-actions ms-3">
                <?php if (!$isRead): ?>
                <button type="button"
                    class="btn btn-sm btn-outline-secondary mark-read-btn"
                    data-action="mark-read">
                    Mark Read
                </button>
                <?php endif; ?>

                <?php if (!$isAcknowledged): ?>
                <button type="button"
                    class="btn btn-sm btn-outline-success acknowledge-btn"
                    data-action="acknowledge">
                    Acknowledge
                </button>
                <?php else: ?>
                <span class="badge bg-success">
                    <i class="fas fa-check"></i> Acknowledged
                </span>
                <?php endif; ?>
            </div>
        </div>
    </div>
</div>
```
  </action>
  <verify>
```bash
php -l views/events/ai-summary/item.php
```
  </verify>
  <done>Notification item template created with read/acknowledge buttons.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete notification system including:
- Database schema for class_events table
- Event dispatching from class/learner controllers
- Notification processing pipeline (processor, enricher, emailer)
- Dashboard shortcode with timeline display
- Admin settings for recipient configuration
- AJAX handlers for mark-read and acknowledge
  </what-built>
  <how-to-verify>
1. Execute the database schema:
   - Run schema/class_events.sql against PostgreSQL
   - Verify table created with correct columns and indexes

2. Test event dispatching:
   - Create a new class via the form
   - Check class_events table for new INSERT event
   - Update the class
   - Check for UPDATE event

3. Test notification processing:
   - Manually trigger: `do_action('wecoza_process_notifications')`
   - Or wait for cron
   - Check Action Scheduler for queued jobs
   - Verify email sent (check logs or recipient inbox)

4. Test dashboard:
   - Visit page with [wecoza_insert_update_ai_summary] shortcode
   - Verify timeline shows events
   - Click "Mark Read" - verify viewed_at updates
   - Click "Acknowledge" - verify acknowledged_at updates
   - Test unread filter toggle
   - Test search and event type filters

5. Test admin settings:
   - Go to WeCoza > Events Settings
   - Configure recipient emails for CLASS_INSERT
   - Click "Send Test" button
   - Verify test email received

6. Check error handling:
   - Temporarily set invalid OpenAI key
   - Trigger event
   - Verify notification sent without AI summary (graceful degradation)
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Templates pass PHP lint
2. Dashboard renders notification timeline
3. Mark read button works via AJAX
4. Acknowledge button works via AJAX
5. Unread filter shows only unread items
6. Event type filter works
7. Search filter works
</verification>

<success_criteria>
- User can view notification timeline
- User can filter to unread only
- User can mark notifications as read
- User can acknowledge notifications
- Admin can configure recipients
- Test notifications work
</success_criteria>

<output>
After completion, create `.planning/phases/18-notification-system/18-08-SUMMARY.md`
</output>
