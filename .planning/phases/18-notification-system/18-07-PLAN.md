---
phase: 18-notification-system
plan: 07
type: execute
wave: 3
depends_on: ["18-01", "18-06"]
files_modified:
  - src/Events/Admin/SettingsPage.php
  - views/events/admin/notification-settings.php
autonomous: true

must_haves:
  truths:
    - "Admin can configure recipient emails per event type"
    - "Settings are saved to WordPress options"
    - "Validation prevents invalid email addresses"
    - "UI shows current configuration clearly"
  artifacts:
    - path: "src/Events/Admin/SettingsPage.php"
      provides: "Admin settings page for notifications"
      exports: ["SettingsPage"]
    - path: "views/events/admin/notification-settings.php"
      provides: "Template for notification settings form"
  key_links:
    - from: "src/Events/Admin/SettingsPage.php"
      to: "src/Events/Services/NotificationSettings.php"
      via: "save handler"
      pattern: "NotificationSettings"
---

<objective>
Update the admin settings page to allow configuration of notification recipients per event type.

Purpose: Admins need a UI to configure who receives notifications for different event types.

Output: Working admin UI for notification recipient configuration.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/Events/Admin/SettingsPage.php (existing settings page)
@src/Events/Services/NotificationSettings.php (updated in 18-06)
@src/Events/Enums/EventType.php (from 18-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SettingsPage for notification recipients</name>
  <files>src/Events/Admin/SettingsPage.php</files>
  <action>
First, read the current SettingsPage to understand its structure.

Enhance with notification recipient settings:

1. Add new section for "Notification Recipients":
   - Use add_settings_section() for 'wecoza_notification_recipients_section'
   - Add to existing settings page or create new tab

2. Add settings fields for each event type:
```php
$eventTypes = [
    EventType::CLASS_INSERT->value => 'Class Created',
    EventType::CLASS_UPDATE->value => 'Class Updated',
    EventType::LEARNER_ADD->value => 'Learner Added',
    EventType::LEARNER_REMOVE->value => 'Learner Removed',
    EventType::STATUS_CHANGE->value => 'Status Changed',
];

foreach ($eventTypes as $type => $label) {
    add_settings_field(
        'wecoza_notification_recipients_' . $type,
        $label,
        [$this, 'renderRecipientsField'],
        'wecoza-events-settings',
        'wecoza_notification_recipients_section',
        ['event_type' => $type, 'label' => $label]
    );
}
```

3. Implement renderRecipientsField() method:
   - Display textarea for comma-separated emails
   - Show current recipients from NotificationSettings
   - Add placeholder text explaining format

4. Implement save handler:
   - Parse comma-separated emails into array
   - Trim whitespace from each email
   - Validate each email with filter_var()
   - Save valid emails to NotificationSettings
   - Show admin notice for invalid emails

5. Add "Test Notification" button:
   - Button per event type to send test email
   - AJAX handler sends test notification to configured recipients
  </action>
  <verify>
```bash
php -l src/Events/Admin/SettingsPage.php
```
  </verify>
  <done>SettingsPage includes notification recipient configuration.</done>
</task>

<task type="auto">
  <name>Task 2: Create notification settings template</name>
  <files>views/events/admin/notification-settings.php</files>
  <action>
Create a template for the notification settings section:

1. Create views/events/admin/ directory if needed

2. Create notification-settings.php template:
```php
<?php
/**
 * Notification Settings Template
 *
 * @var array $eventTypes Event types with labels
 * @var array $currentSettings Current recipient settings
 */

if (!defined('ABSPATH')) {
    exit;
}
?>

<div class="wecoza-notification-settings">
    <h2><?php esc_html_e('Notification Recipients', 'wecoza-core'); ?></h2>
    <p class="description">
        <?php esc_html_e('Configure email addresses to receive notifications for each event type. Enter multiple emails separated by commas.', 'wecoza-core'); ?>
    </p>

    <table class="form-table">
        <?php foreach ($eventTypes as $type => $label): ?>
        <tr>
            <th scope="row">
                <label for="recipients_<?php echo esc_attr($type); ?>">
                    <?php echo esc_html($label); ?>
                </label>
            </th>
            <td>
                <textarea
                    id="recipients_<?php echo esc_attr($type); ?>"
                    name="wecoza_notification_recipients[<?php echo esc_attr($type); ?>]"
                    rows="2"
                    cols="50"
                    class="large-text"
                    placeholder="email1@example.com, email2@example.com"
                ><?php echo esc_textarea(implode(', ', $currentSettings[$type] ?? [])); ?></textarea>
                <p class="description">
                    <?php printf(
                        esc_html__('Recipients for %s notifications', 'wecoza-core'),
                        esc_html($label)
                    ); ?>
                </p>
                <button type="button"
                    class="button button-secondary wecoza-test-notification"
                    data-event-type="<?php echo esc_attr($type); ?>">
                    <?php esc_html_e('Send Test', 'wecoza-core'); ?>
                </button>
            </td>
        </tr>
        <?php endforeach; ?>
    </table>
</div>

<script>
jQuery(function($) {
    $('.wecoza-test-notification').on('click', function() {
        var $btn = $(this);
        var eventType = $btn.data('event-type');
        $btn.prop('disabled', true).text('Sending...');

        $.post(ajaxurl, {
            action: 'wecoza_send_test_notification',
            event_type: eventType,
            nonce: '<?php echo wp_create_nonce('wecoza_test_notification'); ?>'
        }).done(function(response) {
            alert(response.success ? 'Test sent!' : 'Failed: ' + response.data.message);
        }).always(function() {
            $btn.prop('disabled', false).text('Send Test');
        });
    });
});
</script>
```

3. Template should be included by SettingsPage::render() method
  </action>
  <verify>
```bash
php -l views/events/admin/notification-settings.php
ls -la views/events/admin/
```
  </verify>
  <done>Notification settings template created with form fields and test buttons.</done>
</task>

<task type="auto">
  <name>Task 3: Add test notification AJAX handler</name>
  <files>src/Events/Admin/SettingsPage.php</files>
  <action>
Add AJAX handler for sending test notifications:

1. In SettingsPage::register() or constructor, add:
```php
add_action('wp_ajax_wecoza_send_test_notification', [$this, 'handleTestNotification']);
```

2. Implement handleTestNotification() method:
```php
public function handleTestNotification(): void
{
    check_ajax_referer('wecoza_test_notification', 'nonce');

    if (!current_user_can('manage_options')) {
        wp_send_json_error(['message' => 'Unauthorized'], 403);
    }

    $eventType = sanitize_text_field($_POST['event_type'] ?? '');
    if (empty($eventType)) {
        wp_send_json_error(['message' => 'Invalid event type'], 400);
    }

    $settings = new NotificationSettings();
    $recipients = $settings->getRecipientsForEventType($eventType);

    if (empty($recipients)) {
        wp_send_json_error(['message' => 'No recipients configured'], 400);
    }

    // Create test event data
    $testData = [
        'event_type' => $eventType,
        'entity_type' => 'class',
        'entity_id' => 0,
        'class_code' => 'TEST-001',
        'class_subject' => 'Test Notification',
        'changed_at' => current_time('mysql'),
    ];

    // Send test email to each recipient
    $sent = 0;
    $presenter = new NotificationEmailPresenter();
    $mailData = $presenter->present([
        'operation' => $eventType,
        'new_row' => $testData,
        'row' => ['class_id' => 0],
        'diff' => [],
        'summary' => ['summary' => 'This is a test notification.'],
        'email_context' => [],
    ]);

    foreach ($recipients as $recipient) {
        if (wp_mail($recipient, '[TEST] ' . $mailData['subject'], $mailData['body'], $mailData['headers'])) {
            $sent++;
        }
    }

    wp_send_json_success([
        'message' => sprintf('Sent to %d of %d recipients', $sent, count($recipients))
    ]);
}
```

3. Import required classes at top of file:
```php
use WeCoza\Events\Services\NotificationSettings;
use WeCoza\Events\Views\Presenters\NotificationEmailPresenter;
```
  </action>
  <verify>
```bash
php -l src/Events/Admin/SettingsPage.php
grep -n "handleTestNotification" src/Events/Admin/SettingsPage.php
```
  </verify>
  <done>Test notification AJAX handler implemented.</done>
</task>

</tasks>

<verification>
1. SettingsPage.php passes PHP lint
2. Template file exists at views/events/admin/notification-settings.php
3. Recipient fields are rendered for all event types
4. Save handler validates and stores emails
5. Test notification button sends email
</verification>

<success_criteria>
- Admin settings page shows notification configuration
- Can enter multiple recipients per event type
- Invalid emails are rejected with feedback
- Test notification sends email to configured recipients
</success_criteria>

<output>
After completion, create `.planning/phases/18-notification-system/18-07-SUMMARY.md`
</output>
