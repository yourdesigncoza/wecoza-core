---
phase: 40-return-type-hints-constants
plan: 03
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/Clients/Controllers/ClientsController.php
  - src/Clients/Controllers/LocationsController.php
  - src/Clients/Ajax/ClientAjaxHandlers.php
  - src/Agents/Repositories/AgentRepository.php
  - src/Events/Repositories/MaterialTrackingRepository.php
  - src/Events/Services/EventDispatcher.php
  - src/Events/Services/TaskManager.php
  - core/Abstract/BaseRepository.php
autonomous: true

must_haves:
  truths:
    - "Every public method in ClientsController has a return type hint"
    - "Every public method in LocationsController has a return type hint"
    - "Every public method in ClientAjaxHandlers has a return type hint"
    - "Every public method in AgentRepository has a return type hint"
    - "Every public method in EventDispatcher has a return type hint"
    - "Every public method in TaskManager has a return type hint"
    - "Every public method in MaterialTrackingRepository has a return type hint"
    - "BaseRepository::paginate has a return type hint"
    - "void used for render/output methods, nullable for optional lookups"
  artifacts:
    - path: "src/Clients/Controllers/ClientsController.php"
      provides: "Fully typed controller public API"
      contains: "public function registerShortcodes(): void"
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "Fully typed AJAX handler public API"
      contains: "public function saveClient(): void"
  key_links:
    - from: "src/Clients/Controllers/ClientsController.php"
      to: "src/Clients/Services/ClientService.php"
      via: "service calls from shortcode methods"
      pattern: "clientService"
---

<objective>
Add return type hints to all public methods in controllers, AJAX handlers, repositories, and services that are still untyped (TYPE-01, TYPE-03, TYPE-04).

Purpose: Complete type coverage on the controller, AJAX handler, repository, and service layers (32 untyped methods across 8 files).
Output: All remaining public methods across all layers have explicit return type hints.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Clients/Controllers/ClientsController.php
@src/Clients/Ajax/ClientAjaxHandlers.php
@src/Agents/Repositories/AgentRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add return type hints to Controllers and AJAX handlers (19 methods)</name>
  <files>
    src/Clients/Controllers/ClientsController.php
    src/Clients/Controllers/LocationsController.php
    src/Clients/Ajax/ClientAjaxHandlers.php
  </files>
  <action>
Add return type hints to all untyped public methods.

**ClientsController (5 methods):**
- `registerShortcodes()` → `: void` (registers shortcodes with WordPress, no return)
- `enqueueAssets()` → `: void` (enqueues scripts/styles, no return)
- `captureClientShortcode($atts)` → `: string` (shortcode returns HTML string)
- `displayClientsShortcode($atts)` → `: string` (shortcode returns HTML string)
- `updateClientShortcode($atts)` → `: string` (shortcode returns HTML string)

**LocationsController (5 methods):**
- `registerShortcodes()` → `: void`
- `enqueueAssets()` → `: void`
- `captureLocationShortcode($atts)` → `: string` (returns HTML)
- `editLocationShortcode($atts)` → `: string` (returns HTML)
- `listLocationsShortcode($atts)` → `: string` (returns HTML)

**ClientAjaxHandlers (9 methods):**
- `saveClient()` → `: void` (outputs JSON via wp_send_json, no return value)
- `getClient()` → `: void` (outputs JSON)
- `getClientDetails()` → `: void` (outputs JSON)
- `deleteClient()` → `: void` (outputs JSON)
- `searchClients()` → `: void` (outputs JSON)
- `getBranchClients()` → `: void` (outputs JSON)
- `exportClients()` → `: void` (outputs JSON/CSV)
- `getLocations()` → `: void` (outputs JSON)
- `checkLocationDuplicates()` → `: void` (outputs JSON)

Read each file to verify the actual return behavior. WordPress shortcodes MUST return string. AJAX handlers use wp_send_json_success/wp_send_json_error which call wp_die(), so they return void.

For shortcode methods, verify they use output buffering and return the captured output, or use wecoza_view with return=true. All shortcode callbacks must return `: string`.
  </action>
  <verify>
Run `php -l` on all 3 modified files. Run `grep 'public function' src/Clients/Controllers/*.php src/Clients/Ajax/ClientAjaxHandlers.php | grep -v '): ' | grep -v '__construct'` — should return zero lines.
  </verify>
  <done>All 19 controller and AJAX handler public methods have return type hints. void for AJAX handlers, string for shortcodes, void for lifecycle hooks.</done>
</task>

<task type="auto">
  <name>Task 2: Add return type hints to Repositories and Services (13 methods)</name>
  <files>
    src/Agents/Repositories/AgentRepository.php
    src/Events/Repositories/MaterialTrackingRepository.php
    src/Events/Services/EventDispatcher.php
    src/Events/Services/TaskManager.php
    core/Abstract/BaseRepository.php
  </files>
  <action>
Add return type hints to all untyped public methods.

**AgentRepository (5 methods):**
- `createAgent(array $data)` → `: int|false` (returns new agent ID or false on failure — read method body to confirm)
- `addAgentMeta(int $agentId, string $metaKey, $metaValue)` → `: bool` (returns success/fail)
- `getAgentMeta(int $agentId, string $metaKey = '', bool $single = false)` → `: mixed` (returns single value or array depending on $single param)
- `addAgentNote(int $agentId, string $note, string $noteType = 'general')` → `: bool` (returns success)
- `addAgentAbsence(int $agentId, string $absenceDate, string $reason = '')` → `: bool` (returns success)

Also add parameter type hint for `$metaValue` in `addAgentMeta()` → `: mixed` (accepts string, array, or other).

**MaterialTrackingRepository (1 method):**
- `getTrackingDashboardData(...)` → `: array` (returns dashboard data array)

**EventDispatcher (3 methods):**
- `dispatchClassEvent(...)` → `: void` (dispatches event, no return — read to confirm)
- `dispatchLearnerEvent(...)` → `: void`
- `dispatchStatusChange(...)` → `: void`

Read each method body to verify. If any of these return a value (e.g., event ID), use the appropriate type instead of void.

**TaskManager (2 methods):**
- `markTaskCompleted(...)` → `: bool` (returns success/fail — read to confirm)
- `updateEventStatus(...)` → `: bool` (returns success — read to confirm)

Read each method body to verify actual return type. Adjust if the method returns something different.

**BaseRepository (1 method):**
- `paginate(...)` already has `: array` in the implementation but the grep may catch the multi-line signature. Verify it has the return type. If not, add `: array`.

Note: BaseRepository::paginate is a multi-line signature. Read lines 556-562 to check if `: array` is present. It likely is on the closing `)` line.
  </action>
  <verify>
Run `php -l` on all 5 modified files. Run `grep -rn 'public function' src/Agents/Repositories/AgentRepository.php src/Events/Repositories/MaterialTrackingRepository.php src/Events/Services/EventDispatcher.php src/Events/Services/TaskManager.php core/Abstract/BaseRepository.php | grep -v '): ' | grep -v '__construct'` — should return zero lines.
  </verify>
  <done>All 12 repository and service public methods have return type hints. mixed used for polymorphic getAgentMeta, void for event dispatchers, bool for mutation operations.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'public function' src/ core/ --include="*.php" | grep -v '): ' | grep -v '__construct' | wc -l` returns zero
2. `php -l` passes on all 8 modified files
3. void used for AJAX handlers and event dispatchers
4. string used for shortcode callback methods
5. Union types (int|false, array|null) used where methods have multiple return paths
</verification>

<success_criteria>
- All 32 untyped controller, AJAX, repository, and service public methods now have return type hints (TYPE-01, TYPE-03, TYPE-04)
- void used consistently for output/dispatch methods (TYPE-05)
- No PHP syntax errors in any modified file
- Combined with Plan 02, achieves zero untyped public methods across entire codebase
</success_criteria>

<output>
After completion, create `.planning/phases/40-return-type-hints-constants/40-03-SUMMARY.md`
</output>
