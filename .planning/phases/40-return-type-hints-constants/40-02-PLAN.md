---
phase: 40-return-type-hints-constants
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/Agents/Models/AgentModel.php
  - src/Clients/Models/SitesModel.php
  - src/Clients/Models/ClientsModel.php
  - src/Clients/Models/LocationsModel.php
  - src/Clients/Models/ClientCommunicationsModel.php
  - src/Classes/Models/QAVisitModel.php
  - core/Abstract/BaseModel.php
autonomous: true

must_haves:
  truths:
    - "Every public method in AgentModel has a return type hint"
    - "Every public method in SitesModel has a return type hint"
    - "Every public method in ClientsModel has a return type hint"
    - "Every public method in LocationsModel has a return type hint"
    - "Every public method in ClientCommunicationsModel has a return type hint"
    - "BaseModel::__get has return type mixed"
    - "Union types used correctly: nullable for optional returns, bool for success/fail"
  artifacts:
    - path: "src/Agents/Models/AgentModel.php"
      provides: "Fully typed AgentModel public API"
      contains: "public function load"
    - path: "src/Clients/Models/SitesModel.php"
      provides: "Fully typed SitesModel public API"
      contains: "public function getHeadSite"
  key_links:
    - from: "src/Agents/Models/AgentModel.php"
      to: "core/Abstract/BaseModel.php"
      via: "extends BaseModel"
      pattern: "class AgentModel extends BaseModel"
---

<objective>
Add return type hints to all public methods in model classes (TYPE-02) including BaseModel.__get.

Purpose: Complete type coverage on the model layer (72 untyped public methods across 7 files), ensuring IDE autocompletion and static analysis work correctly.
Output: All model public methods have explicit return type hints.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/Abstract/BaseModel.php
@src/Agents/Models/AgentModel.php
@src/Clients/Models/SitesModel.php
@src/Clients/Models/ClientsModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add return type hints to AgentModel (23 untyped methods)</name>
  <files>src/Agents/Models/AgentModel.php</files>
  <action>
Add return type hints to all 23 untyped public methods in AgentModel. Analyze each method's return value and assign the correct type:

- `load($id)` → `: static` (returns $this for fluent, loads data into self)
- `set_data($data)` → `: void` (setter, no return)
- `get_data()` → `: array` (returns internal data array)
- `__get($key)` → `: mixed` (magic getter, returns any type)
- `__set($key, $value)` → `: void` (magic setter)
- `__isset($key)` → `: bool` (existence check)
- `get($key, $default = null)` → `: mixed` (generic getter with default)
- `set($key, $value)` → `: static` (fluent setter, returns $this)
- `is_modified($key = null)` → `: bool` (check if modified)
- `get_modified_fields()` → `: array` (returns modified field names)
- `validate(?array $context = null)` → `: bool` (returns validation result)
- `get_form_field($form_field_name, $default = null)` → `: mixed` (generic getter)
- `set_form_field($form_field_name, $value)` → `: void` (setter)
- `set_form_data($form_data)` → `: void` (setter)
- `get_form_data()` → `: array` (returns form data array)
- `get_errors()` → `: array` (returns error messages)
- `get_display_name()` → `: string` (returns formatted name string)
- `get_initials()` → `: string` (returns initials string)
- `get_preferred_areas()` → `: array` (returns areas array)
- `set_preferred_areas($areas)` → `: void` (setter)
- `has_quantum_qualification($type = null)` → `: bool` (boolean check)
- `get_status_label()` → `: string` (returns status label)
- `to_json()` → `: string` (returns JSON string)

Also add parameter type hints where missing (e.g., `$id` in `load()` should be `int`, `$data` in `set_data()` should be `array`).

Verify each method body to confirm the return type matches actual behavior. If a method can return null in some paths, use nullable (`?type` or `type|null`).
  </action>
  <verify>Run `php -l src/Agents/Models/AgentModel.php`. Run `grep 'public function' src/Agents/Models/AgentModel.php | grep -v '): ' | grep -v '__construct'` — should return zero lines.</verify>
  <done>All 23 public methods in AgentModel have return type hints. Zero untyped public methods remain.</done>
</task>

<task type="auto">
  <name>Task 2: Add return type hints to Client models + BaseModel.__get + QAVisitModel</name>
  <files>
    src/Clients/Models/SitesModel.php
    src/Clients/Models/ClientsModel.php
    src/Clients/Models/LocationsModel.php
    src/Clients/Models/ClientCommunicationsModel.php
    src/Classes/Models/QAVisitModel.php
    core/Abstract/BaseModel.php
  </files>
  <action>
Add return type hints to all untyped public methods across these files.

**BaseModel (1 method):**
- `__get(string $name)` → `: mixed` (magic getter returns any type or null)

**SitesModel (21 methods) — analyze each return value:**
- `refreshLocationCache()` → `: void`
- `clearLocationCache()` → `: void`
- `rebuildLocationCache()` → `: array` (returns rebuilt cache data)
- `refreshHeadSiteCache($clientIds = null)` → `: void`
- `clearHeadSiteCache($clientIds = null)` → `: void`
- `getHeadSitesForClients(array $clientIds)` → `: array`
- `getHeadSite($clientId)` → `: array|null` (single site or null)
- `getSitesByClient($clientId)` → `: array`
- `saveHeadSite($clientId, array $data)` → `: array` (returns result array with success/id)
- `validateHeadSite(array $data)` → `: array` (returns validation errors array)
- `getSiteById($siteId)` → `: array|null`
- `ensureSiteBelongsToClient($siteId, $clientId)` → `: bool`
- `hydrateClients(array &$clients)` → `: void` (modifies array by reference)
- `getLocationHierarchy($useCache = true)` → `: array`
- `getLocationById($locationId)` → `: array|null`
- `saveSubSite($clientId, $parentSiteId, array $data, array $options = array())` → `: array` (returns result)
- `validateSubSite(...)` → `: array` (returns errors array)
- `getHeadSitesForClient($clientId)` → `: array`
- `getSubSites($parentSiteId)` → `: array`
- `getAllSitesWithHierarchy($clientId)` → `: array`
- `deleteSubSite($siteId, $clientId)` → `: bool`

**ClientsModel (17 methods):**
- `getAllClients($params = [])` → `: array`
- `getByRegistrationNumber($regNr)` → `: array|null`
- `create(array $data)` → `: int|false` (returns new ID or false on failure)
- `updateById($id, array $data)` → `: bool`
- `deleteById($id)` → `: bool`
- `count($params = [])` → `: int`
- `getStatistics()` → `: array`
- `getForDropdown()` → `: array`
- `validate($data, $id = null)` → `: array` (returns errors array)
- `getLocationHierarchy($useCache = true)` → `: array`
- `getLocationById($locationId)` → `: array|null`
- `getSitesModel()` → `: SitesModel`
- `getCommunicationsModel()` → `: ClientCommunicationsModel`
- `getMainClients()` → `: array`
- `getSubClients($mainClientId)` → `: array`
- `getAllWithHierarchy()` → `: array`
- `updateClientHierarchy($clientId, $mainClientId = null)` → `: bool`

**LocationsModel (5 methods):**
- `validate(array $data, $id = null)` → `: array` (returns errors)
- `create(array $data)` → `: int|false` (new ID or false)
- `checkDuplicates($streetAddress, $suburb, $town)` → `: array`
- `count(array $params = array())` → `: int`
- `updateById($id, array $data)` → `: bool`

**ClientCommunicationsModel (5 methods):**
- `logCommunication(...)` → `: bool`
- `getLatestCommunication($clientId)` → `: array|null`
- `getLatestCommunications(array $clientIds)` → `: array`
- `getLatestCommunicationType($clientId)` → `: string|null`
- `getLatestCommunicationTypes(array $clientIds)` → `: array`

**QAVisitModel (1 method):**
- `getLatestDocument()` → `: ?string` (returns document path or null)

Read each file first to confirm return values match the suggested types. Adjust if the actual method body returns something different.

Add missing parameter type hints where obvious (e.g., `$clientId` → `int`, `$siteId` → `int`).
  </action>
  <verify>
Run `php -l` on all 6 modified files. Run `grep 'public function' src/Clients/Models/*.php src/Classes/Models/QAVisitModel.php core/Abstract/BaseModel.php | grep -v '): ' | grep -v '__construct'` — should return zero lines.
  </verify>
  <done>All 50 public methods across Client models, QAVisitModel, and BaseModel have return type hints. Zero untyped public methods remain in model layer.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'public function' src/*/Models/*.php core/Abstract/BaseModel.php | grep -v '): ' | grep -v '__construct'` returns zero lines
2. `php -l` passes on all 7 modified files
3. Union types used correctly: `array|null` for optional lookups, `int|false` for create operations, `mixed` for magic getters
</verification>

<success_criteria>
- All 73 untyped model public methods now have return type hints (TYPE-02)
- Union types used appropriately — nullable for optional returns, mixed for magic getters (TYPE-05)
- No PHP syntax errors in any modified file
</success_criteria>

<output>
After completion, create `.planning/phases/40-return-type-hints-constants/40-02-SUMMARY.md`
</output>
