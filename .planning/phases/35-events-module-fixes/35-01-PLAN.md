---
phase: 35-events-module-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - views/events/ai-summary/card.php
  - views/events/ai-summary/timeline.php
  - views/events/ai-summary/item.php
  - views/events/material-tracking/list-item.php
  - src/Events/Repositories/MaterialTrackingRepository.php
  - views/events/admin/notification-settings.php
autonomous: true

must_haves:
  truths:
    - "All presenter-generated HTML (summary_html, notification_badge_html, status_badge_html) is wrapped in wp_kses_post() at the output point in templates"
    - "When materials are marked delivered, class_material_tracking table is updated with materials_delivered_at and delivery_status = delivered"
    - "No duplicate test notification JavaScript handler exists -- single handler in SettingsPage.php only"
    - "WordPress late escaping best practices followed for all _html variables in events views"
  artifacts:
    - path: "views/events/ai-summary/card.php"
      provides: "Card layout with wp_kses_post() on summary_html output"
      contains: "wp_kses_post($summary['summary_html'])"
    - path: "views/events/ai-summary/timeline.php"
      provides: "Timeline layout with wp_kses_post() on summary_html output"
      contains: "wp_kses_post($summary['summary_html'])"
    - path: "views/events/ai-summary/item.php"
      provides: "Item template with wp_kses_post() on summary_html output"
      contains: "wp_kses_post($item['summary_html'])"
    - path: "views/events/material-tracking/list-item.php"
      provides: "List item with wp_kses_post() on badge HTML outputs"
      contains: "wp_kses_post($record['notification_badge_html'])"
    - path: "src/Events/Repositories/MaterialTrackingRepository.php"
      provides: "markDelivered() syncs both JSONB and tracking table"
      contains: "UPDATE class_material_tracking"
  key_links:
    - from: "src/Events/Repositories/MaterialTrackingRepository.php"
      to: "class_material_tracking table"
      via: "markDelivered() now updates both classes.event_dates JSONB and class_material_tracking"
      pattern: "materials_delivered_at.*NOW.*delivery_status.*delivered"
    - from: "views/events/ai-summary/card.php"
      to: "src/Events/Services/AISummaryPresenter"
      via: "Presenter generates summary_html, template escapes at output"
      pattern: "wp_kses_post"
    - from: "views/events/material-tracking/list-item.php"
      to: "src/Events/Services/MaterialTrackingPresenter"
      via: "Presenter generates badge HTML, template escapes at output"
      pattern: "wp_kses_post"
---

<objective>
Fix all 4 EVT requirements in the Events module: add late escaping for presenter-generated HTML in 4 view templates, sync the material tracking table when materials are marked delivered, and remove unused duplicate JavaScript.

Purpose: Enforce WordPress late escaping best practices for all presenter-generated HTML output, fix data consistency between JSONB and tracking table (materials_delivered_at and delivery_status columns are never set), and eliminate dead code.

Output: 4 modified files + 1 deleted file with all events module wiring issues resolved.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-events-module-fixes/35-RESEARCH.md
@docs/formfieldanalysis/events-module-audit.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wp_kses_post() late escaping to all presenter-generated HTML outputs (EVT-01, EVT-02)</name>
  <files>
    views/events/ai-summary/card.php
    views/events/ai-summary/timeline.php
    views/events/ai-summary/item.php
    views/events/material-tracking/list-item.php
  </files>
  <action>
**EVT-01: Escape summary_html in 3 AI summary view files:**

1. **card.php line 54:** Change:
   ```php
   <?php echo $summary['summary_html']; ?>
   ```
   to:
   ```php
   <?php echo wp_kses_post($summary['summary_html']); ?>
   ```

2. **timeline.php line 120:** Change:
   ```php
   <?php echo $summary['summary_html']; ?>
   ```
   to:
   ```php
   <?php echo wp_kses_post($summary['summary_html']); ?>
   ```

3. **item.php line 79:** Change:
   ```php
   <?php echo $item['summary_html']; ?>
   ```
   to:
   ```php
   <?php echo wp_kses_post($item['summary_html']); ?>
   ```

**EVT-02: Escape badge HTML in material tracking list-item.php:**

4. **list-item.php line 55:** Change:
   ```php
   <?php echo $record['notification_badge_html']; ?>
   ```
   to:
   ```php
   <?php echo wp_kses_post($record['notification_badge_html']); ?>
   ```

5. **list-item.php line 60:** Change:
   ```php
   <?php echo $record['status_badge_html']; ?>
   ```
   to:
   ```php
   <?php echo wp_kses_post($record['status_badge_html']); ?>
   ```

**Why wp_kses_post() (not esc_html()):** These variables contain intentional HTML markup (spans, badges, formatted paragraphs) generated by presenter classes. `wp_kses_post()` allows standard WordPress post HTML tags while stripping dangerous tags/attributes. `esc_html()` would strip ALL HTML including the intended markup.

**DO NOT modify** the presenter classes themselves -- they already escape individual values with `esc_html()` before wrapping in HTML. The late escaping at output is an additional defense-in-depth layer per WordPress VIP standards.
  </action>
  <verify>
1. `grep -n "wp_kses_post" views/events/ai-summary/card.php` returns 1 match at the summary_html output line
2. `grep -n "wp_kses_post" views/events/ai-summary/timeline.php` returns 1 match at the summary_html output line
3. `grep -n "wp_kses_post" views/events/ai-summary/item.php` returns 1 match at the summary_html output line
4. `grep -n "wp_kses_post" views/events/material-tracking/list-item.php` returns 2 matches (notification_badge_html + status_badge_html)
5. `grep -rn "echo \$summary\['summary_html'\]" views/events/` returns 0 matches WITHOUT wp_kses_post wrapping
6. `grep -rn "echo \$record\['notification_badge_html'\]\|echo \$record\['status_badge_html'\]" views/events/` returns 0 matches WITHOUT wp_kses_post wrapping
7. `grep -rn "echo \$item\['summary_html'\]" views/events/` returns 0 matches WITHOUT wp_kses_post wrapping
8. `php -l views/events/ai-summary/card.php` -- no syntax errors
9. `php -l views/events/ai-summary/timeline.php` -- no syntax errors
10. `php -l views/events/ai-summary/item.php` -- no syntax errors
11. `php -l views/events/material-tracking/list-item.php` -- no syntax errors
  </verify>
  <done>
- All 3 AI summary views wrap summary_html in wp_kses_post() at the output point
- Material tracking list-item wraps both notification_badge_html and status_badge_html in wp_kses_post()
- Zero unescaped *_html variable outputs remain in events views
- No PHP syntax errors in any modified file
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync tracking table in markDelivered() and remove duplicate JS file (EVT-03, EVT-04)</name>
  <files>
    src/Events/Repositories/MaterialTrackingRepository.php
    views/events/admin/notification-settings.php
  </files>
  <action>
**EVT-03: Update markDelivered() to sync class_material_tracking table:**

In `MaterialTrackingRepository::markDelivered()` (line 86), after the existing JSONB update executes successfully (after line 134 `}`), add a second UPDATE statement to sync the tracking table:

```php
// Sync class_material_tracking table with JSONB state
// Updates both notification types (orange and red) for this class
$syncSql = 'UPDATE class_material_tracking
            SET materials_delivered_at = NOW(),
                delivery_status = \'delivered\',
                updated_at = NOW()
            WHERE class_id = :class_id
              AND delivery_status != \'delivered\'';

$syncStmt = $this->db->getPdo()->prepare($syncSql);
if ($syncStmt) {
    $syncStmt->execute([':class_id' => $classId]);
}
```

Place this AFTER the existing `if (!$success)` error check block (after line 134), but BEFORE the closing `}` of the method. The sync UPDATE uses `delivery_status != 'delivered'` guard to be idempotent -- re-marking delivered is a no-op on the tracking table.

Note: This UPDATE may affect 0 rows if no tracking records exist yet for this class (tracking records are only created by `markNotificationSent()`). This is expected and not an error -- the tracking table is a secondary concern; JSONB remains source of truth.

**DO NOT** wrap the sync in a transaction with the JSONB update. The JSONB update is the authoritative operation. If the sync fails, the delivery is still marked in JSONB (source of truth) and the tracking table inconsistency is low-impact (dashboard JOIN will still show correct status from JSONB).

**EVT-04: Delete unused notification-settings.php view template:**

Delete the file `views/events/admin/notification-settings.php` entirely. This file:
- Contains a duplicate test notification JS click handler (lines 80-112) identical to `SettingsPage.php:320-346`
- Is NEVER loaded by any PHP code -- `SettingsPage.php` renders recipient fields directly via `renderRecipientsField()` method
- Confirmed by grep: zero references to "notification-settings" or "notification_settings" across all PHP files in `src/`

After deletion, verify the active handler in `SettingsPage.php` still exists and is unchanged.
  </action>
  <verify>
1. `grep -n "class_material_tracking" src/Events/Repositories/MaterialTrackingRepository.php` includes a new match for the sync UPDATE
2. `grep -n "materials_delivered_at" src/Events/Repositories/MaterialTrackingRepository.php` shows the column is now written to in markDelivered()
3. `grep -n "delivery_status.*delivered" src/Events/Repositories/MaterialTrackingRepository.php` shows 'delivered' status is now reachable via markDelivered()
4. `php -l src/Events/Repositories/MaterialTrackingRepository.php` -- no syntax errors
5. `test ! -f views/events/admin/notification-settings.php && echo "DELETED"` returns "DELETED"
6. `grep -n "wecoza-test-notification" src/Events/Admin/SettingsPage.php` still shows the active handler (confirming it was NOT accidentally modified)
7. `grep -rn "notification-settings" src/Events/` returns 0 matches (no dangling references to deleted file)
  </verify>
  <done>
- markDelivered() now updates class_material_tracking.materials_delivered_at = NOW() and delivery_status = 'delivered' after updating JSONB
- The 'delivered' status is now reachable in the tracking table (was previously unreachable)
- Unused notification-settings.php view deleted (duplicate JS handler eliminated)
- Single test notification handler remains in SettingsPage.php (active, unchanged)
- No PHP syntax errors
  </done>
</task>

</tasks>

<verification>
Run all verification checks across requirements:

1. **EVT-01 verified:** `grep -rn "echo.*summary_html" views/events/ai-summary/` -- all 3 occurrences wrapped in wp_kses_post()
2. **EVT-02 verified:** `grep -rn "echo.*badge_html" views/events/material-tracking/` -- both occurrences wrapped in wp_kses_post()
3. **EVT-03 verified:** `grep -A5 "Sync class_material_tracking" src/Events/Repositories/MaterialTrackingRepository.php` shows UPDATE with materials_delivered_at and delivery_status
4. **EVT-04 verified:** `test ! -f views/events/admin/notification-settings.php` confirms deletion AND `grep -c "wecoza-test-notification" src/Events/Admin/SettingsPage.php` returns 2 (button class + click handler, confirming single source)
5. **No regression:** `php -l` passes on all 5 modified PHP files
6. **No dangling refs:** `grep -rn "notification-settings" src/ views/` returns 0 matches (no orphaned references to deleted file)
</verification>

<success_criteria>
1. All presenter-generated HTML outputs in events views are wrapped in wp_kses_post() (5 total: 3 summary_html + 2 badge_html)
2. MaterialTrackingRepository::markDelivered() updates BOTH classes.event_dates JSONB AND class_material_tracking table
3. class_material_tracking.materials_delivered_at is set to NOW() when materials marked delivered
4. class_material_tracking.delivery_status is set to 'delivered' when materials marked delivered
5. views/events/admin/notification-settings.php is deleted (duplicate JS eliminated)
6. Test notification handler exists in exactly one location: SettingsPage.php
7. Zero PHP syntax errors across all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/35-events-module-fixes/35-01-SUMMARY.md`
</output>
