---
phase: 10-architecture-type-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/DTOs/RecordDTO.php
  - src/Events/DTOs/EmailContextDTO.php
  - src/Events/DTOs/SummaryResultDTO.php
  - src/Events/DTOs/ObfuscatedDataDTO.php
autonomous: true

must_haves:
  truths:
    - "RecordDTO has readonly properties matching all $record array keys"
    - "EmailContextDTO has readonly properties for alias_map, field_labels, obfuscated"
    - "SummaryResultDTO wraps record, email_context, and status"
    - "All DTOs have fromArray() and toArray() methods"
  artifacts:
    - path: "src/Events/DTOs/RecordDTO.php"
      provides: "AI summary tracking record data structure"
      contains: "final class RecordDTO"
    - path: "src/Events/DTOs/EmailContextDTO.php"
      provides: "Email context data structure"
      contains: "final class EmailContextDTO"
    - path: "src/Events/DTOs/SummaryResultDTO.php"
      provides: "generateSummary return type"
      contains: "final class SummaryResultDTO"
    - path: "src/Events/DTOs/ObfuscatedDataDTO.php"
      provides: "Obfuscation result data structure"
      contains: "final class ObfuscatedDataDTO"
  key_links:
    - from: "src/Events/DTOs/RecordDTO.php"
      to: "AISummaryService::normaliseRecord"
      via: "property mapping matches array keys"
      pattern: "summary|status|error_code|attempts"
---

<objective>
Create typed DTO classes to replace array-based data structures in AISummaryService.

Purpose: Replace magic array keys with type-safe readonly properties that provide IDE autocomplete, compile-time validation, and self-documenting code. This satisfies QUAL-02.

Output: Four DTO classes in src/Events/DTOs/ directory following PHP 8.1 readonly property patterns.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-architecture-type-safety/10-RESEARCH.md

# Source file to understand array structure
@src/Events/Services/AISummaryService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RecordDTO and EmailContextDTO</name>
  <files>
    src/Events/DTOs/RecordDTO.php
    src/Events/DTOs/EmailContextDTO.php
  </files>
  <action>
Create the DTOs directory if not exists: `src/Events/DTOs/`

**RecordDTO** - based on normaliseRecord() method (lines 290-323 of AISummaryService.php):
```php
namespace WeCoza\Events\DTOs;

final class RecordDTO
{
    public function __construct(
        public readonly ?string $summary,
        public readonly string $status,
        public readonly ?string $errorCode,
        public readonly ?string $errorMessage,
        public readonly int $attempts,
        public readonly bool $viewed,
        public readonly ?string $viewedAt,
        public readonly ?string $generatedAt,
        public readonly ?string $model,
        public readonly int $tokensUsed,
        public readonly int $processingTimeMs,
    ) {}

    public static function fromArray(?array $data): self { ... }
    public function toArray(): array { ... }
    public function withStatus(string $status): self { ... }
    public function withSummary(string $summary): self { ... }
    public function withError(?string $code, ?string $message): self { ... }
    public function incrementAttempts(): self { ... }
}
```

Use `with*` methods (not setters) to create modified copies since properties are readonly.
Include `ABSPATH` check and proper namespace.

**EmailContextDTO** - based on email_context structure (lines 142-152):
```php
final class EmailContextDTO
{
    public function __construct(
        public readonly array $aliasMap,
        public readonly array $fieldLabels,
        public readonly array $obfuscated,
    ) {}

    public static function fromArray(array $data): self { ... }
    public static function empty(): self { ... }  // Returns empty arrays
    public function toArray(): array { ... }
}
```
  </action>
  <verify>
```bash
# Verify files exist and have correct structure
php -l src/Events/DTOs/RecordDTO.php
php -l src/Events/DTOs/EmailContextDTO.php
grep -q "final class RecordDTO" src/Events/DTOs/RecordDTO.php
grep -q "public readonly" src/Events/DTOs/RecordDTO.php
```
  </verify>
  <done>RecordDTO and EmailContextDTO exist with readonly properties, fromArray(), toArray() methods, and pass PHP syntax check</done>
</task>

<task type="auto">
  <name>Task 2: Create SummaryResultDTO and ObfuscatedDataDTO</name>
  <files>
    src/Events/DTOs/SummaryResultDTO.php
    src/Events/DTOs/ObfuscatedDataDTO.php
  </files>
  <action>
**SummaryResultDTO** - wraps the return value of generateSummary():
```php
final class SummaryResultDTO
{
    public function __construct(
        public readonly RecordDTO $record,
        public readonly EmailContextDTO $emailContext,
        public readonly string $status,
    ) {}

    public static function success(RecordDTO $record, EmailContextDTO $emailContext): self
    {
        return new self($record, $emailContext, 'success');
    }

    public static function failed(RecordDTO $record, EmailContextDTO $emailContext): self
    {
        return new self($record, $emailContext, 'failed');
    }

    public static function pending(RecordDTO $record, EmailContextDTO $emailContext): self
    {
        return new self($record, $emailContext, 'pending');
    }

    public function toArray(): array
    {
        return [
            'record' => $this->record->toArray(),
            'email_context' => $this->emailContext->toArray(),
            'status' => $this->status,
        ];
    }
}
```

**ObfuscatedDataDTO** - wraps obfuscation results (from lines 89-101):
```php
final class ObfuscatedDataDTO
{
    public function __construct(
        public readonly array $newRow,
        public readonly array $diff,
        public readonly array $oldRow,
        public readonly array $aliases,
        public readonly array $fieldLabels,
    ) {}

    public static function fromResults(
        array $newRowResult,
        array $diffResult,
        array $oldRowResult
    ): self {
        return new self(
            newRow: $newRowResult['payload'],
            diff: $diffResult['payload'],
            oldRow: $oldRowResult['payload'],
            aliases: $oldRowResult['state']['aliases'],
            fieldLabels: array_merge(
                $newRowResult['field_labels'],
                $diffResult['field_labels'],
                $oldRowResult['field_labels']
            )
        );
    }
}
```

**IMPORTANT:** Do NOT integrate these into AISummaryService yet. That's Plan 03's job. This plan only creates the DTO classes.
  </action>
  <verify>
```bash
php -l src/Events/DTOs/SummaryResultDTO.php
php -l src/Events/DTOs/ObfuscatedDataDTO.php
grep -q "final class SummaryResultDTO" src/Events/DTOs/SummaryResultDTO.php
grep -q "final class ObfuscatedDataDTO" src/Events/DTOs/ObfuscatedDataDTO.php
```
  </verify>
  <done>SummaryResultDTO and ObfuscatedDataDTO exist with factory methods and pass PHP syntax check</done>
</task>

<task type="auto">
  <name>Task 3: Update autoloader and verify all DTOs</name>
  <files>
    composer.json (verify PSR-4 mapping)
  </files>
  <action>
1. Verify PSR-4 autoloading is configured for `WeCoza\Events\` namespace pointing to `src/Events/`.
   - Check `composer.json` has mapping: `"WeCoza\\Events\\": "src/Events/"`
   - If not present, add it and run `composer dump-autoload`

2. Create a simple test script to verify all DTOs load correctly:
```php
// test-dtos.php (temporary, delete after verification)
require_once __DIR__ . '/vendor/autoload.php';

use WeCoza\Events\DTOs\RecordDTO;
use WeCoza\Events\DTOs\EmailContextDTO;
use WeCoza\Events\DTOs\SummaryResultDTO;
use WeCoza\Events\DTOs\ObfuscatedDataDTO;

// Test RecordDTO
$record = RecordDTO::fromArray(null);
assert($record->status === 'pending');
assert($record->attempts === 0);

// Test EmailContextDTO
$email = EmailContextDTO::empty();
assert($email->aliasMap === []);

// Test with values
$record2 = RecordDTO::fromArray([
    'summary' => 'Test summary',
    'status' => 'success',
    'attempts' => 1,
]);
assert($record2->summary === 'Test summary');

echo "All DTOs loaded and basic tests passed!\n";
```

3. Run the test script and delete it after verification.
  </action>
  <verify>
```bash
# Run the verification
php test-dtos.php
rm test-dtos.php

# Verify namespace declarations
grep -q "namespace WeCoza\\\\Events\\\\DTOs" src/Events/DTOs/RecordDTO.php
```
  </verify>
  <done>All four DTOs autoload correctly, can be instantiated, and fromArray/toArray methods work as expected</done>
</task>

</tasks>

<verification>
All phase 10 plan 01 checks:
- [ ] Four DTO files exist in src/Events/DTOs/
- [ ] All DTOs use `final class` and `public readonly` properties
- [ ] RecordDTO has all 11 properties from normaliseRecord()
- [ ] EmailContextDTO has aliasMap, fieldLabels, obfuscated properties
- [ ] SummaryResultDTO composes RecordDTO and EmailContextDTO
- [ ] ObfuscatedDataDTO has fromResults() factory method
- [ ] All DTOs have fromArray() and toArray() methods
- [ ] All files pass PHP syntax check (php -l)
- [ ] PSR-4 autoloading works
</verification>

<success_criteria>
- Four DTO classes created in src/Events/DTOs/
- All use PHP 8.1 readonly properties with constructor promotion
- Each DTO has fromArray() and toArray() for array interop
- RecordDTO has with*() methods for immutable updates
- All files pass PHP syntax validation
- PSR-4 autoloading configured and working
</success_criteria>

<output>
After completion, create `.planning/phases/10-architecture-type-safety/10-01-SUMMARY.md`
</output>
