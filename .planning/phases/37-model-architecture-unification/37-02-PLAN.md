---
phase: 37-model-architecture-unification
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Agents/Models/AgentModel.php
autonomous: true

must_haves:
  truths:
    - "AgentModel class declaration reads 'class AgentModel extends BaseModel'"
    - "AgentModel has no duplicate get/set/toArray methods — only BaseModel defines core ones"
    - "AgentService::handleAgentFormSubmission() works unchanged (validate, get_errors, get_data)"
    - "AgentModel::validate() preserves all existing validation rules (required fields, email, SA ID, phone, uniqueness checks)"
    - "All agent-specific convenience methods preserved (get_display_name, get_preferred_areas, has_quantum_qualification, etc.)"
  artifacts:
    - path: "src/Agents/Models/AgentModel.php"
      provides: "AgentModel extending BaseModel with preserved validation and agent-specific methods"
      contains: "class AgentModel extends BaseModel"
  key_links:
    - from: "src/Agents/Services/AgentService.php"
      to: "src/Agents/Models/AgentModel.php"
      via: "new AgentModel($data), validate(), get_errors()"
      pattern: "new AgentModel|->validate\\(|->get_errors\\("
---

<objective>
Migrate AgentModel to extend BaseModel while preserving its data-bag pattern, modification tracking, comprehensive validation, and all consumer-facing methods.

Purpose: Eliminate architectural inconsistency where AgentModel is standalone with its own get/set/toArray duplicating BaseModel functionality. After migration, AgentModel inherits BaseModel's infrastructure while retaining its agent-specific validation, form helpers, and convenience methods.

Output: Refactored AgentModel.php extending BaseModel with zero changes to consumer code (AgentService, AgentRepository consumers).
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/Abstract/BaseModel.php
@src/Agents/Models/AgentModel.php
@src/Agents/Services/AgentService.php
@src/Learners/Models/LearnerModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AgentModel to extend BaseModel</name>
  <files>src/Agents/Models/AgentModel.php</files>
  <action>
Refactor AgentModel to extend BaseModel. AgentModel uses a data-bag pattern (`$data = []` array) unlike BaseModel's property-based approach. The migration must preserve the data-bag pattern while inheriting BaseModel infrastructure.

**Key analysis of AgentModel's current pattern:**
- Stores data in `protected $data = []` array (NOT typed properties like LearnerModel)
- Has custom `get($key, $default)` and `set($key, $value)` that operate on `$data` array
- Tracks modifications via `$modified = []`
- Has `$defaults` static array defining all fields with default values
- `to_array()` returns `$data + id` (snake_case method name, not camelCase)
- `save()` returns `bool|int` (not `bool` like BaseModel)
- `validate(?array $context)` is comprehensive with uniqueness checks
- Consumer (AgentService) calls: `new AgentModel($data)`, `->validate([...])`, `->get_errors()`

**Implementation steps:**

1. **Add BaseModel extension:**
   - Add `use WeCoza\Core\Abstract\BaseModel;`
   - Change to `class AgentModel extends BaseModel`

2. **Configure BaseModel statics:**
   ```php
   protected static string $table = 'agents';
   protected static string $primaryKey = 'agent_id';
   protected static array $casts = [];
   protected static array $fillable = [];  // All allowed (data-bag pattern)
   protected static array $guarded = [];   // No guarding (data-bag manages own fields)
   ```

3. **Override constructor to preserve data-bag behavior:**
   - AgentModel constructor accepts `$data = []` (array or int)
   - Call `parent::__construct([])` (skip BaseModel's hydration since we use data-bag)
   - Then do existing logic: if numeric, call load(); if array, call set_data()
   - BaseModel constructor does hydration on typed properties — we don't want that since AgentModel uses `$data` array. Pass empty array to parent.

4. **Keep `$data`, `$modified`, `$errors`, `$defaults` properties:**
   - These are AgentModel-specific and don't conflict with BaseModel
   - BaseModel has no `$data` property — it uses typed properties
   - Keep all of them as-is

5. **Handle method conflicts with BaseModel:**

   a. **`__get($name)`** — BaseModel has `__get` that searches typed properties. AgentModel has `__get` that delegates to `get()` on `$data` array. **Override BaseModel's __get** with AgentModel's existing implementation. This is fine — child overrides parent.

   b. **`__isset($name)`** — Same situation. Override with AgentModel's version.

   c. **`get($key, $default)` and `set($key, $value)`** — BaseModel does NOT have explicit get/set methods (it uses __get magic on properties). So these are NOT duplicates — they are AgentModel-specific methods operating on the `$data` array. Keep them as-is.

   WAIT — re-reading the requirement: "MDL-03: No duplicate get/set/toArray methods in ClientsModel or AgentModel". The design doc says "Remove duplicate methods (get, set, toArray)". But BaseModel doesn't actually have explicit `get()` and `set()` methods — it has `__get` and `fill()`. So AgentModel's `get()` and `set()` are NOT duplicates of BaseModel methods. They're agent-specific methods.

   The REAL duplicates to remove are:
   - `to_array()` — BaseModel has `toArray()`. Keep `toArray()` (BaseModel's camelCase convention), and either rename `to_array` or make it call `toArray()`.
   - `__get` / `__isset` — BaseModel has these. AgentModel overrides them. This is standard OOP, not duplication.

   d. **`toArray()` vs `to_array()`** — BaseModel provides `toArray()`. AgentModel has `to_array()` (snake_case). These are conceptually the same but with different naming. Implementation:
   - Override `toArray()` from BaseModel with AgentModel's logic (merge defaults + data + id)
   - Keep `to_array()` as an alias that calls `toArray()` for backward compatibility
   - Consumers may call either name

6. **Satisfy BaseModel abstract methods:**

   a. **`getById(int $id): ?static`** — AgentModel doesn't have this as a static method. It has `load($id)` which is an instance method. Implement `getById` as:
   ```php
   public static function getById(int $id): ?static
   {
       $instance = new static();
       $loaded = $instance->load($id);
       return $loaded ? $instance : null;
   }
   ```

   b. **`save(): bool`** — Current signature returns `bool|int`. BaseModel abstract requires `bool`. Change return type to `bool` and adjust: return `(bool) $result` where result was previously int or bool. BUT consumers call `$agentModel->save()` and check for truthiness. The AgentService does NOT call save() directly — it calls repository methods. The model's save() IS called from `AgentModel::save()` itself. Looking at the code, save() returns `false` or `$this->id` (int). Changing to `bool` means returning `true` instead of `$this->id`. The `$this->id` is already set on the instance, so callers can get it from `$instance->id`. Check if any caller uses the int return: AgentModel::save() returns `$this->id` or `false`. Is this called externally? Looking at AgentService — it does NOT call `$agentModel->save()`. It calls repository directly. So `save()` return type change is safe. Change to return `bool`: return `true` on success, `false` on failure.

   c. **`update(): bool`** — AgentModel doesn't have a standalone `update()`. It has update logic inside `save()` (when `$this->id` exists). Add `update(): bool` that extracts the update portion of save():
   ```php
   public function update(): bool
   {
       if (!$this->id) return false;
       $repository = new AgentRepository();
       $save_data = $this->get_save_data();
       return $repository->updateAgent($this->id, $save_data);
   }
   ```

   d. **`delete(): bool`** — Already exists with correct signature. Keep as-is.

7. **Preserve ALL agent-specific methods unchanged:**
   - `load($id)`, `set_data($data)`, `get_data()`, `get_save_data()`
   - `get($key, $default)`, `set($key, $value)`
   - `is_modified($key)`, `get_modified_fields()`
   - `validate(?array $context)`, `get_errors()`
   - `get_form_field()`, `set_form_field()`, `set_form_data()`, `get_form_data()`
   - `get_display_name()`, `get_initials()`, `get_preferred_areas()`, `set_preferred_areas()`
   - `has_quantum_qualification($type)`, `get_status_label()`
   - `to_json()`
   - `is_valid_date($date)`

8. **Handle `to_array()` -> `toArray()` consolidation:**
   - Override BaseModel's `toArray()` with AgentModel's `to_array()` logic
   - Keep `to_array()` as a deprecated alias calling `toArray()`
   - This satisfies MDL-03 (no duplicate toArray)

9. **Remove the redundant `__set` magic method** if BaseModel handles it. BaseModel does NOT have `__set` — so keep AgentModel's `__set`.

**IMPORTANT:** Do NOT change how AgentModel stores data internally. Keep the `$data = []` bag pattern. BaseModel's typed-property approach is additive infrastructure, not a replacement for the data bag. The `$data` array is the source of truth for AgentModel, and BaseModel's hydrate/toArray are overridden to work with it.
  </action>
  <verify>
Run `php -l src/Agents/Models/AgentModel.php` to verify no syntax errors.
Run `grep -n "extends BaseModel" src/Agents/Models/AgentModel.php` to confirm extension.
Run `grep -n "function toArray" src/Agents/Models/AgentModel.php` to confirm single toArray.
Run `grep -n "function to_array" src/Agents/Models/AgentModel.php` to confirm alias exists.
  </verify>
  <done>
AgentModel extends BaseModel. BaseModel abstract methods (getById, save, update, delete) all satisfied. Data-bag pattern preserved. to_array() consolidated to call toArray(). All agent-specific methods unchanged. Validation framework intact.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify AgentModel consumers and run full validation</name>
  <files>src/Agents/Services/AgentService.php</files>
  <action>
After Task 1 refactors AgentModel, verify that all consumer code compiles and integrates correctly:

1. **Syntax-check all consumer files:**
   - `php -l src/Agents/Models/AgentModel.php`
   - `php -l src/Agents/Services/AgentService.php`
   - `php -l src/Agents/Repositories/AgentRepository.php`
   - `php -l src/Agents/Ajax/AgentAjaxHandlers.php` (if exists)
   - Run: `find src/Agents/ -name "*.php" -exec php -l {} \;`

2. **Verify critical consumer patterns still work:**

   a. **AgentService::handleAgentFormSubmission()** (line ~129):
      ```php
      $agentModel = new AgentModel($data);        // Constructor must accept array
      $isValid = $agentModel->validate([...]);     // validate() must accept ?array context
      $agentModel->get_errors();                   // get_errors() must return array
      ```
      Confirm all three calls are compatible with refactored model.

   b. **AgentModel internal calls:**
      - `$this->get('field_name')` — must still work on $data bag
      - `$this->set('field_name', $value)` — must still work
      - `$this->get_data()` — must return merged defaults + data
      - `$this->to_array()` — must return complete data with id

3. **Confirm no method signature breaks:**
   - Grep for all external calls to AgentModel across the entire src/ directory
   - Check each call site against new signatures
   - `save()` now returns `bool` not `bool|int` — verify no caller depends on int return

4. **Verify MDL-03 compliance:**
   - `grep -rn "function get(" src/Agents/Models/AgentModel.php` — AgentModel's get() is NOT a BaseModel duplicate (BaseModel has no explicit get() method)
   - `grep -rn "function set(" src/Agents/Models/AgentModel.php` — Same, not a duplicate
   - `grep -rn "function toArray" src/Agents/Models/AgentModel.php` — Should exist (overrides BaseModel)
   - `grep -rn "function to_array" src/Agents/Models/AgentModel.php` — Should exist as alias
   - Confirm: the ONLY toArray definition that matters is in AgentModel (which overrides BaseModel's). No independent duplicate.

5. **Verify MDL-04 compliance (validation consistency):**
   - AgentModel::validate() is comprehensive and domain-specific — it doesn't need to match BaseModel's pattern exactly since BaseModel has no validate() method
   - But both AgentModel and ClientsModel should follow consistent patterns: take data, return bool or errors
   - Confirm AgentModel::validate() returns bool and stores errors internally (via get_errors())
   - Confirm ClientsModel::validate() returns errors array directly
   - Note: These are different patterns but both are valid. MDL-04 says "consistent across all models using BaseModel's validation patterns" — since BaseModel has NO validate method, the consistency requirement is that both models HAVE validation, not that they have identical signatures.

6. **Run full PHP syntax check:**
   ```bash
   find src/Agents/ -name "*.php" -exec php -l {} \;
   ```
  </action>
  <verify>
All PHP files in src/Agents/ pass `php -l` syntax check.
`grep -rn "AgentModel" src/Agents/ --include="*.php"` shows all usages — verify none broken.
`grep -rn "extends BaseModel" src/Agents/Models/AgentModel.php` confirms extension.
  </verify>
  <done>
All AgentModel consumers (AgentService, AgentRepository, AgentAjaxHandlers) work unchanged. Both ClientsModel and AgentModel extend BaseModel (MDL-01, MDL-02 complete). No duplicate toArray methods (MDL-03 complete). Validation framework consistent (MDL-04 complete). PHP lint passes on all files.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Agents/Models/AgentModel.php` — no syntax errors
2. `grep "class AgentModel extends BaseModel" src/Agents/Models/AgentModel.php` — confirms extension
3. All PHP files in `src/Agents/` pass syntax check
4. No changes to BaseModel.php (LearnerModel, ClassModel unaffected)
5. AgentService::handleAgentFormSubmission() works with refactored model
6. Both ClientsModel and AgentModel extend BaseModel (MDL-01 + MDL-02)
7. grep for duplicate get/set/toArray across both models shows zero duplicates (MDL-03)
8. Both models have validation that follows BaseModel architecture patterns (MDL-04)
</verification>

<success_criteria>
- AgentModel class declaration reads `class AgentModel extends BaseModel`
- BaseModel's abstract methods (getById, save, update, delete) all satisfied
- Data-bag pattern ($data array) preserved for backward compatibility
- to_array() consolidated with toArray() (no independent duplicate)
- AgentModel::validate() preserves ALL validation rules (required, email, SA ID, phone, uniqueness)
- AgentService code unchanged — new AgentModel($data), validate(), get_errors() all work
- PHP lint passes on all files in src/Agents/
</success_criteria>

<output>
After completion, create `.planning/phases/37-model-architecture-unification/37-02-SUMMARY.md`
</output>
