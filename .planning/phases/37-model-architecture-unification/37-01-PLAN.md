---
phase: 37-model-architecture-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Clients/Models/ClientsModel.php
autonomous: true

must_haves:
  truths:
    - "ClientService can retrieve, create, validate, update, and delete clients using ClientsModel"
    - "Array-access patterns like $client['field_name'] continue to work on getById results"
    - "ClientsModel::validate() correctly validates client data and returns errors array"
    - "LocationsController can call getModel()->validate() and getModel()->getById() without changes"
  artifacts:
    - path: "src/Clients/Models/ClientsModel.php"
      provides: "ClientsModel extending BaseModel with preserved column-resolution and business logic"
      contains: "class ClientsModel extends BaseModel"
  key_links:
    - from: "src/Clients/Services/ClientService.php"
      to: "src/Clients/Models/ClientsModel.php"
      via: "new ClientsModel() constructor and method calls"
      pattern: "->getAll\\(|->getById\\(|->validate\\(|->create\\(|->update\\(|->delete\\("
    - from: "src/Clients/Controllers/LocationsController.php"
      to: "src/Clients/Models/ClientsModel.php"
      via: "getModel()->validate() and getModel()->getById()"
      pattern: "->validate\\(|->getById\\("
---

<objective>
Migrate ClientsModel to extend BaseModel while preserving its unique column-resolution mechanism, relationship loading, and all public method signatures.

Purpose: Eliminate architectural inconsistency where ClientsModel is a standalone class duplicating BaseModel patterns. After migration, ClientsModel inherits BaseModel's hydration, type casting, and property access infrastructure while retaining its specialized column-resolution and relationship loading.

Output: Refactored ClientsModel.php extending BaseModel with zero changes to consumer code.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/Abstract/BaseModel.php
@src/Clients/Models/ClientsModel.php
@src/Clients/Services/ClientService.php
@src/Learners/Models/LearnerModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate ClientsModel to extend BaseModel</name>
  <files>src/Clients/Models/ClientsModel.php</files>
  <action>
Refactor ClientsModel to extend BaseModel. ClientsModel is an array-oriented model+repository hybrid with a unique column-resolution mechanism. The migration preserves this architecture while adding BaseModel inheritance.

**NOTE on "duplicate methods":** Code analysis confirms ClientsModel has NO get(), set(), or toArray() methods at all. It uses getColumn(), normalizeRow(), prepareDataForSave() instead. There are zero duplicates to remove. The design doc's "remove duplicate methods" does not apply to ClientsModel.

**Implementation steps:**

1. **Add BaseModel extension:**
   - Add `use WeCoza\Core\Abstract\BaseModel;`
   - Change class to `class ClientsModel extends BaseModel implements \ArrayAccess`

2. **Convert instance properties to static (BaseModel convention):**
   - `protected static string $table = 'clients'`
   - `protected static string $primaryKey = 'id'`
   - `protected static array $fillable = [...]` (existing list)
   - Add `protected static array $guarded = ['id', 'created_at', 'updated_at'];`
   - Add `protected static array $casts = [];`

3. **Override constructor to preserve column-resolution:**
   - Call `parent::__construct([])` first (skip BaseModel hydration)
   - Keep ALL existing constructor logic: column resolution, fillable/json/date filtering, related model instantiation

4. **Implement ArrayAccess for backward-compatible array syntax:**
   - Add `protected array $attributes = [];` to store query result data
   - Implement 4 ArrayAccess methods (offsetExists, offsetGet, offsetSet, offsetUnset) delegating to `$attributes`
   - This ensures consumers can still do `$client['field_name']` on getById results

5. **Satisfy BaseModel abstract methods:**
   - `getById(int $id): ?static` — change return type from `array|null` to `?static`. Internally: run existing SQL query, store normalized+hydrated result in `$instance->attributes`, return `$instance`. Consumers use ArrayAccess (`$client['field']`) so this is transparent.
   - `save(): bool` — already exists, already returns bool. Keep as-is.
   - `update($id = null, array $data = []): bool` — already exists with compatible signature. Keep as-is.
   - `delete($id = null): bool` — already exists with compatible signature. Keep as-is.

6. **Override toArray():**
   - Return `$this->attributes` (overrides BaseModel's property-based toArray)

7. **Preserve ALL other public methods exactly as-is:**
   - getAll(), getByRegistrationNumber(), create(), updateById(), deleteById(), count(), getStatistics(), getForDropdown(), validate(), getMainClients(), getSubClients(), getAllWithHierarchy(), updateClientHierarchy(), getLocationHierarchy(), getLocationById(), getSitesModel(), getCommunicationsModel()

**Key gotcha:** getById's `hydrateRows($normalized)` mutates the array by reference (adds sites, communications). The hydrated result must be stored in `$attributes` AFTER hydration completes.
  </action>
  <verify>
Run `php -l src/Clients/Models/ClientsModel.php` to verify no syntax errors.
Run `grep -n "extends BaseModel" src/Clients/Models/ClientsModel.php` to confirm extension.
Run `grep -n "implements.*ArrayAccess" src/Clients/Models/ClientsModel.php` to confirm ArrayAccess.
Run `grep -c "abstract" core/Abstract/BaseModel.php` to confirm BaseModel unchanged.
  </verify>
  <done>
ClientsModel extends BaseModel, implements ArrayAccess for backward-compatible array syntax. getById returns ?static (satisfying abstract contract). All public methods preserved. No changes to consumer code (ClientService, LocationsController, ClientAjaxHandlers).
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify ClientsModel consumers work unchanged</name>
  <files>src/Clients/Services/ClientService.php</files>
  <action>
After Task 1 refactors ClientsModel, verify that all consumer code compiles and integrates correctly:

1. **Syntax-check all consumer files:**
   - `php -l src/Clients/Services/ClientService.php`
   - `php -l src/Clients/Controllers/LocationsController.php`
   - `php -l src/Clients/Ajax/ClientAjaxHandlers.php` (if exists)
   - `php -l src/Clients/Repositories/ClientRepository.php`

2. **Verify no method signature mismatches:**
   - Grep for all calls to ClientsModel methods across the Clients module
   - Confirm each call site is compatible with the new signatures
   - Specifically check: getById returns are used with array syntax `['key']` — ArrayAccess handles this
   - Check: validate() still accepts `($data, $id)` — should be unchanged
   - Check: getAll() still returns array of arrays — unchanged
   - Check: create() still returns int|false — unchanged

3. **If any incompatibilities found, make MINIMAL adjustments:**
   - Only change consumer code if absolutely necessary
   - Prefer adapter methods in ClientsModel over changing consumers
   - Document any changes made

4. **Run full PHP syntax check on all modified/related files:**
   ```bash
   find src/Clients/ -name "*.php" -exec php -l {} \;
   ```
  </action>
  <verify>
All PHP files in src/Clients/ pass `php -l` syntax check.
`grep -rn "ClientsModel" src/Clients/ --include="*.php"` shows all usages — verify none are broken.
  </verify>
  <done>
All ClientsModel consumers (ClientService, LocationsController, ClientAjaxHandlers, ClientRepository) work unchanged with the refactored model. PHP lint passes on all files.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Clients/Models/ClientsModel.php` — no syntax errors
2. `grep "class ClientsModel extends BaseModel" src/Clients/Models/ClientsModel.php` — confirms extension
3. `grep "implements.*ArrayAccess" src/Clients/Models/ClientsModel.php` — confirms backward compatibility
4. All PHP files in `src/Clients/` pass syntax check
5. No changes to BaseModel.php (other models unaffected)
6. ClientService methods (handleClientSubmission, getClient, getClients, exportClientData) all work unchanged
</verification>

<success_criteria>
- ClientsModel class declaration reads `class ClientsModel extends BaseModel implements \ArrayAccess`
- BaseModel's abstract methods (getById, save, update, delete) all satisfied
- All array-access patterns ($client['field']) still work via ArrayAccess interface
- Zero changes needed in ClientService, LocationsController, or any AJAX handlers
- PHP lint passes on all files in src/Clients/
</success_criteria>

<output>
After completion, create `.planning/phases/37-model-architecture-unification/37-01-SUMMARY.md`
</output>
