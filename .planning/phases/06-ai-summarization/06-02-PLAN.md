---
phase: 06-ai-summarization
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - tests/Events/AISummarizationTest.php
autonomous: true

must_haves:
  truths:
    - "Class change events trigger AI summary generation via NotificationProcessor"
    - "AISummaryService handles API errors gracefully without crashes"
    - "Summary generation uses exponential backoff retry logic (3 attempts)"
    - "Error states are properly recorded (config_missing, quota_exceeded, timeout)"
    - "PII is obfuscated before sending to OpenAI API"
  artifacts:
    - path: "src/Events/Services/NotificationProcessor.php"
      provides: "Orchestrates summary generation on class changes"
      contains: "generateSummary"
    - path: "src/Events/Services/AISummaryService.php"
      provides: "Error handling and retry logic"
      contains: "backoffDelaySeconds"
    - path: "src/Events/Services/Traits/DataObfuscator.php"
      provides: "PII protection before API calls"
      contains: "obfuscatePayloadWithLabels"
  key_links:
    - from: "NotificationProcessor"
      to: "AISummaryService"
      via: "constructor injection"
      pattern: "AISummaryService"
    - from: "NotificationProcessor::process()"
      to: "generateSummary()"
      via: "method call"
      pattern: "generateSummary"
    - from: "AISummaryService"
      to: "DataObfuscator"
      via: "trait use"
      pattern: "use DataObfuscator"
---

<objective>
Verify AI summary generation triggers on class changes and handles errors gracefully.

Purpose: Confirm that AI-02 requirement is satisfied - class change events properly trigger AI summary generation through NotificationProcessor. Also verify error handling (AI-04 continuation) to ensure the system doesn't crash on API failures.

Output: Extended test suite verifying event-triggered summary generation and error handling.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-summarization/06-RESEARCH.md
@.planning/phases/06-ai-summarization/06-01-SUMMARY.md

Key components to verify:
- src/Events/Services/NotificationProcessor.php — Orchestrates summary generation
- src/Events/Services/AISummaryService.php — API client with error handling
- src/Events/Services/Traits/DataObfuscator.php — PII protection
- src/Events/Repositories/ClassChangeLogRepository.php — Persists summaries

Reference:
@tests/Events/AISummarizationTest.php (created in Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify Event-Triggered Summary Generation</name>
  <files>tests/Events/AISummarizationTest.php</files>
  <action>
Extend the test file to verify AI-02 requirement (class change events trigger AI summary generation):

**Add new test section after existing tests:**

1. **AI-02: NotificationProcessor Summary Integration**
   - Test NotificationProcessor::boot() creates valid instance
   - Test NotificationProcessor has AISummaryService dependency injected
   - Test NotificationProcessor has OpenAIConfig dependency injected
   - Test `process()` method exists and is callable
   - Test `shouldGenerateSummary()` logic:
     - Returns false if status is 'success' (already generated)
     - Returns false if status is 'failed' (max attempts reached)
     - Returns true if status is 'pending' and attempts < maxAttempts
   - Test NotificationProcessor queries class_change_logs table

2. **AI-02: Summary Generation Context**
   - Test AISummaryService::generateSummary() accepts context array with:
     - log_id, operation, changed_at, class_id, new_row, old_row, diff
   - Test generateSummary() returns structured array with:
     - record (summary data)
     - email_context (alias_map, obfuscated)
     - status (success, pending, failed)
   - Test summary record structure includes:
     - summary, status, error_code, error_message, attempts
     - viewed, viewed_at, generated_at, model, tokens_used, processing_time_ms

3. **AI-02: Database Persistence**
   - Test ai_summary column exists in class_change_logs table
   - Test summary can be persisted as JSONB (structure verification)
   - Test getLogsWithAISummary() retrieves stored summaries

**Print section summary for AI-02 tests.**
  </action>
  <verify>
Run: `wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All event-triggered summary tests pass
  </verify>
  <done>
- NotificationProcessor integrates with AISummaryService
- Summary generation receives correct context
- Database persistence works correctly
- AI-02 requirements verified
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Error Handling and Retry Logic</name>
  <files>tests/Events/AISummarizationTest.php</files>
  <action>
Add error handling and retry logic verification:

1. **Error State Handling**
   - Test AISummaryService::mapErrorCode() exists
   - Test error code mapping:
     - HTTP 401 -> 'validation_failed' (not retryable)
     - HTTP 429 -> 'quota_exceeded' (retryable)
     - HTTP 500+ -> 'unknown_error' (retryable)
     - Timeout -> 'openai_timeout' (retryable)
   - Test error message sanitization (API keys redacted)
   - Test `sanitizeErrorMessage()` replaces sk-* patterns

2. **Retry Logic with Exponential Backoff**
   - Test `backoffDelaySeconds()` returns:
     - 0 seconds for attempt 0
     - 1 second for attempt 1
     - 2 seconds for attempt 2
     - 4 seconds for attempt 3+
   - Test maxAttempts default is 3
   - Test status becomes 'failed' after maxAttempts reached
   - Test status stays 'pending' while attempts < maxAttempts

3. **Graceful Failure Handling**
   - Test missing API key returns error without exception:
     - error_code: 'config_missing'
     - error_message: 'OpenAI API key is not configured.'
   - Test disabled feature returns appropriate error:
     - error_code: 'feature_disabled'
   - Test normaliseRecord() sets safe defaults for missing fields
   - Test normaliseSummaryText() handles empty response

4. **Metrics Tracking**
   - Test AISummaryService::getMetrics() returns array with:
     - attempts, success, failed, total_tokens, processing_time_ms
   - Test metrics are updated after generateSummary() calls

**Print section summary for error handling tests.**
  </action>
  <verify>
Run: `wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All error handling tests pass
  </verify>
  <done>
- Error codes are mapped correctly
- Retry logic uses exponential backoff
- Graceful failure without crashes
- Metrics tracking works
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify PII Protection and Final Summary</name>
  <files>tests/Events/AISummarizationTest.php</files>
  <action>
Add PII protection verification and produce final summary:

1. **PII Obfuscation (DataObfuscator trait)**
   - Test DataObfuscator trait file exists at correct path
   - Test AISummaryService uses DataObfuscator trait
   - Test `obfuscatePayloadWithLabels()` method exists
   - Test obfuscation returns structure:
     - payload (obfuscated data)
     - mappings (alias -> original)
     - field_labels (human-readable field names)
     - state (persistent obfuscation state)
   - Test sensitive fields are detected and replaced with aliases

2. **Message Building for OpenAI**
   - Test `buildMessages()` creates correct structure:
     - System message with assistant role
     - User message with prompt and JSON payload
   - Test prompt references operation type
   - Test class context is included (class_code, class_subject)

3. **HTTP Client Configuration**
   - Test timeout is configured (60 seconds for LLM)
   - Test API URL is correct: 'https://api.openai.com/v1/chat/completions'
   - Test model constant is 'gpt-5-mini'
   - Test Authorization header format is 'Bearer {key}'

4. **WordPress Hook Integration**
   - Test 'wecoza_ai_summary_generated' action is fired via do_action
   - Test emitSummaryMetrics() calls do_action with correct data

**Final Summary Output:**
```php
echo "\n";
echo "============================================\n";
echo "AI SUMMARIZATION VERIFICATION COMPLETE\n";
echo "============================================\n";
echo "Total: {$results['total']}\n";
echo "Passed: {$results['passed']}\n";
echo "Failed: {$results['failed']}\n";
echo "Pass Rate: " . round(($results['passed'] / max(1, $results['total'])) * 100, 1) . "%\n";
echo "\n";
echo "Requirements Verified:\n";
echo "- AI-01: OpenAI GPT integration for class change summarization\n";
echo "- AI-02: AI summary generation on class change events\n";
echo "- AI-03: AI summary shortcode displays summaries\n";
echo "- AI-04: API key configuration + error handling\n";
echo "\n";
if ($results['failed'] === 0) {
    echo "STATUS: ALL REQUIREMENTS SATISFIED\n";
} else {
    echo "STATUS: VERIFICATION INCOMPLETE - SEE FAILURES ABOVE\n";
}
```
  </action>
  <verify>
Run: `wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: 100% pass rate, all AI-01 through AI-04 requirements verified
  </verify>
  <done>
- DataObfuscator protects PII before API calls
- Message building includes correct context
- HTTP client properly configured
- WordPress hooks integrated
- Final summary shows all requirements satisfied
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Test execution:**
   ```bash
   wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza 2>&1
   ```
   Expected: 100% pass rate

2. **Requirements coverage:**
   ```bash
   grep -E "AI-0[1-4]" tests/Events/AISummarizationTest.php | wc -l
   ```
   Expected: All 4 requirements referenced in tests

3. **Error handling coverage:**
   ```bash
   grep -E "error_code|retry|backoff|graceful" tests/Events/AISummarizationTest.php | wc -l
   ```
   Expected: Multiple error handling assertions
</verification>

<success_criteria>
- [ ] AI-02 tests added (event-triggered summary generation)
- [ ] NotificationProcessor integration verified
- [ ] Error handling tests pass
- [ ] Retry logic verified (exponential backoff)
- [ ] PII obfuscation verified
- [ ] All 4 requirements (AI-01 through AI-04) verified
- [ ] Final summary shows 100% pass rate
- [ ] No PHP errors during test execution
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-summarization/06-02-SUMMARY.md`
</output>
