---
phase: 06-ai-summarization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/Events/AISummarizationTest.php
autonomous: true

must_haves:
  truths:
    - "Admin can configure OpenAI API key via WordPress options"
    - "OpenAI API key is validated with regex pattern /^sk-[A-Za-z0-9_-]{20,}$/"
    - "AISummaryService can generate summaries via OpenAI API"
    - "AISummaryShortcode [wecoza_insert_update_ai_summary] is registered"
    - "Shortcode renders without PHP errors"
    - "SettingsPage is registered in WordPress admin"
  artifacts:
    - path: "src/Events/Support/OpenAIConfig.php"
      provides: "API key validation and storage"
      contains: "wecoza_openai_api_key"
    - path: "src/Events/Admin/SettingsPage.php"
      provides: "WordPress admin settings UI"
      contains: "wecoza_events_ai_summaries_section"
    - path: "src/Events/Services/AISummaryService.php"
      provides: "OpenAI API client with retry logic"
      contains: "gpt-5-mini"
    - path: "src/Events/Shortcodes/AISummaryShortcode.php"
      provides: "AI summary display shortcode"
      contains: "wecoza_insert_update_ai_summary"
    - path: "src/Events/Services/AISummaryDisplayService.php"
      provides: "Query summaries from database"
      exports: ["getSummaries"]
  key_links:
    - from: "wecoza-core.php"
      to: "AISummaryShortcode::register()"
      via: "plugins_loaded hook"
      pattern: "AISummaryShortcode::register"
    - from: "wecoza-core.php"
      to: "SettingsPage::register()"
      via: "plugins_loaded hook"
      pattern: "SettingsPage::register"
    - from: "AISummaryService"
      to: "OpenAIConfig"
      via: "constructor injection"
      pattern: "new OpenAIConfig"
    - from: "AISummaryShortcode"
      to: "AISummaryDisplayService"
      via: "constructor injection"
      pattern: "AISummaryDisplayService"
---

<objective>
Verify AI summarization configuration and shortcode functionality within wecoza-core.

Purpose: Confirm that the migrated AI summarization infrastructure (API key configuration, shortcode registration, display service) operates correctly. This validates requirements AI-01, AI-03, and AI-04.

Output: Verification test results confirming API key configuration, shortcode registration, and display functionality work correctly.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ai-summarization/06-RESEARCH.md

Key components to verify (already migrated):
- src/Events/Support/OpenAIConfig.php — API key validation/storage
- src/Events/Admin/SettingsPage.php — WordPress admin settings UI
- src/Events/Services/AISummaryService.php — OpenAI API client
- src/Events/Services/AISummaryDisplayService.php — Query summaries
- src/Events/Shortcodes/AISummaryShortcode.php — Shortcode registration
- src/Events/Views/Presenters/AISummaryPresenter.php — Data formatting
- views/events/ai-summary/main.php — View template

Reference test implementation:
@tests/Events/TaskManagementTest.php
@tests/Events/MaterialTrackingTest.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify API Key Configuration Infrastructure</name>
  <files>tests/Events/AISummarizationTest.php</files>
  <action>
Create a PHP test file that verifies AI-01 and AI-04 requirements:

**File structure:**
```php
<?php
/**
 * AI Summarization Verification Tests
 *
 * Verifies all migrated AI summarization functionality works correctly
 * Run with: wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza
 */

declare(strict_types=1);

// Bootstrap WordPress if not running via WP-CLI
if (!function_exists('shortcode_exists')) {
    require_once '/opt/lampp/htdocs/wecoza/wp-load.php';
}
```

**Test categories to implement:**

1. **AI-04: OpenAI API Key Configuration**
   - Test OpenAIConfig class exists and is instantiable
   - Test `getApiKey()` returns null when no key configured
   - Test `isValidApiKey()` validates correct patterns:
     - Valid: `sk-abc123xyz456def789ghi012jkl345mn` (sk- prefix + 20+ alphanumeric)
     - Invalid: `abc123` (no prefix), `sk-short` (too short), empty string
   - Test `sanitizeApiKey()` strips invalid keys
   - Test `maskApiKey()` masks middle characters (shows first 4 and last 4)
   - Test `hasValidApiKey()` returns boolean correctly
   - Test `isEnabled()` returns boolean
   - Test `assessEligibility()` returns correct structure

2. **AI-04: WordPress Settings Page Registration**
   - Test SettingsPage class exists
   - Test `register()` method exists
   - Test settings are registered with correct option names:
     - `wecoza_openai_api_key`
   - Test sanitize callbacks are registered
   - Test admin_init hook has SettingsPage::registerSettings callback

3. **AI-01: AISummaryService Infrastructure**
   - Test AISummaryService class exists and is instantiable
   - Test `generateSummary()` method exists
   - Test `getMetrics()` returns expected structure
   - Test `getMaxAttempts()` returns 3 (default)
   - Test service uses gpt-5-mini model constant

**Use the test_result() helper function pattern for consistent output.**

Print a section summary showing passed/failed counts for API configuration tests.
  </action>
  <verify>
Run: `wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All API configuration checks pass
  </verify>
  <done>
- OpenAIConfig validates API keys correctly with regex pattern
- SettingsPage registers WordPress settings
- AISummaryService is instantiable with correct defaults
- All AI-01, AI-04 infrastructure tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify Shortcode and Display Infrastructure</name>
  <files>tests/Events/AISummarizationTest.php</files>
  <action>
Extend the test file to verify AI-03 requirements:

1. **AI-03: AISummaryShortcode Registration**
   - Test shortcode [wecoza_insert_update_ai_summary] exists: `shortcode_exists('wecoza_insert_update_ai_summary')`
   - Test shortcode renders without PHP errors: `do_shortcode('[wecoza_insert_update_ai_summary]')`
   - Test output contains expected wrapper class (wecoza-ai-summary-wrapper)
   - Test shortcode accepts attributes: limit, layout, class_id, operation
   - Test default limit is 20
   - Test default layout is 'card'
   - Test invalid layout falls back to 'card'

2. **AI-03: AISummaryDisplayService**
   - Test AISummaryDisplayService class exists and is instantiable
   - Test `getSummaries()` method exists
   - Test `getSummaries(10, null, null)` returns array without errors
   - Test filtering by class_id works (no errors)
   - Test filtering by operation works (INSERT/UPDATE only)

3. **AI-03: AISummaryPresenter**
   - Test AISummaryPresenter class exists and is instantiable
   - Test `present()` method exists and accepts array
   - Test presenter returns formatted array

4. **View Template Verification**
   - Test views/events/ai-summary/main.php exists
   - Test views/events/ai-summary/card.php exists
   - Test views/events/ai-summary/timeline.php exists

**Print section summary showing passed/failed counts for shortcode tests.**
  </action>
  <verify>
Run: `wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All shortcode and display checks pass
  </verify>
  <done>
- Shortcode [wecoza_insert_update_ai_summary] is registered
- Shortcode renders without PHP errors
- AISummaryDisplayService queries database correctly
- AISummaryPresenter formats data correctly
- All AI-03 tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Repository and Data Layer</name>
  <files>tests/Events/AISummarizationTest.php</files>
  <action>
Add final verification checks for data layer:

1. **ClassChangeLogRepository AI Summary Support**
   - Test ClassChangeLogRepository extends BaseRepository
   - Test `getLogsWithAISummary()` method exists
   - Test `getLogsWithAISummary(5, null, null)` returns array
   - Test filtering by class_id parameter
   - Test filtering by operation parameter (INSERT/UPDATE)
   - Test ai_summary column is included in results

2. **DataObfuscator Trait**
   - Test DataObfuscator trait exists in correct location
   - Test AISummaryService uses DataObfuscator trait
   - Test obfuscation methods exist: `obfuscatePayloadWithLabels()`

3. **NotificationProcessor Integration**
   - Test NotificationProcessor class exists
   - Test `boot()` static factory method exists
   - Test `process()` method exists
   - Test class uses AISummaryService for summary generation

4. **CLI Command Registration**
   - Test AISummaryStatusCommand class exists
   - Test WP-CLI command registration (if WP_CLI defined)

**Output final summary:**
```php
echo "\n";
echo "====================================\n";
echo "TEST SUMMARY\n";
echo "====================================\n";
echo "Total: {$results['total']}\n";
echo "Passed: {$results['passed']}\n";
echo "Failed: {$results['failed']}\n";
echo "Pass Rate: " . round(($results['passed'] / max(1, $results['total'])) * 100, 1) . "%\n";
echo "\n";
echo "Requirements Verified:\n";
echo "- AI-01: OpenAI GPT integration (AISummaryService) \n";
echo "- AI-03: AI summary shortcode display\n";
echo "- AI-04: API key configuration via WordPress options\n";
```
  </action>
  <verify>
Run: `wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All tests pass (100% pass rate), requirements AI-01, AI-03, AI-04 verified
  </verify>
  <done>
- ClassChangeLogRepository has AI summary support
- DataObfuscator trait protects PII
- NotificationProcessor integrates with AISummaryService
- CLI command is registered
- Final summary shows 100% pass rate
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Test file exists:**
   ```bash
   ls -la tests/Events/AISummarizationTest.php
   ```

2. **Test execution:**
   ```bash
   wp eval-file tests/Events/AISummarizationTest.php --path=/opt/lampp/htdocs/wecoza 2>&1
   ```
   Expected: 100% pass rate

3. **Coverage check:**
   ```bash
   grep -E "AI-0[134]|OpenAI|shortcode|API key|configuration" tests/Events/AISummarizationTest.php | head -20
   ```
   Expected: All requirements mentioned in test comments
</verification>

<success_criteria>
- [ ] tests/Events/AISummarizationTest.php exists
- [ ] Test file bootstraps WordPress correctly
- [ ] Tests cover AI-01 (AISummaryService with OpenAI integration)
- [ ] Tests cover AI-03 (shortcode registration and display)
- [ ] Tests cover AI-04 (API key configuration via WordPress options)
- [ ] OpenAIConfig validation tests pass
- [ ] SettingsPage registration tests pass
- [ ] AISummaryShortcode registration tests pass
- [ ] AISummaryDisplayService query tests pass
- [ ] ClassChangeLogRepository data layer tests pass
- [ ] All tests pass (100% pass rate)
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-summarization/06-01-SUMMARY.md`
</output>
