---
phase: 08-bug-fixes-core-security
plan: 04
type: execute
wave: 2
depends_on: ["08-03"]
files_modified:
  - src/Learners/Repositories/LearnerRepository.php
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "LearnerRepository exception logs contain sanitized messages without exposing schema details"
    - "All 12 exception-based error_log calls in LearnerRepository use wecoza_sanitize_exception()"
  artifacts:
    - path: "src/Learners/Repositories/LearnerRepository.php"
      provides: "Sanitized exception logging"
      contains: "wecoza_sanitize_exception"
  key_links:
    - from: "src/Learners/Repositories/LearnerRepository.php"
      to: "wecoza_sanitize_exception()"
      via: "error_log calls in catch blocks"
      pattern: "error_log\\(wecoza_sanitize_exception"
---

<objective>
Update LearnerRepository to use sanitized exception logging.

Purpose: Close gap in Truth 5 (SEC-05) - BaseRepository was updated in 08-03 but LearnerRepository still exposes raw exception messages in logs.
Output: All 12 exception-based error_log calls in LearnerRepository use wecoza_sanitize_exception() following the established pattern.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-bug-fixes-core-security/08-03-SUMMARY.md
@src/Learners/Repositories/LearnerRepository.php
@core/Helpers/functions.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all LearnerRepository exception error_log calls to use wecoza_sanitize_exception()</name>
  <files>src/Learners/Repositories/LearnerRepository.php</files>
  <action>
  Update all 12 exception-based error_log calls in LearnerRepository.php to use the wecoza_sanitize_exception() helper established in 08-03.

  NOTE: Line 238 is a static validation rejection message (not an exception log) and is OUT OF SCOPE for this sanitization task.

  Pattern to follow (from BaseRepository):
  ```php
  // Before:
  error_log("WeCoza Core: LearnerRepository {method} error: " . $e->getMessage());

  // After:
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::{method}'));
  ```

  Lines to update (12 total - all in catch blocks with $e->getMessage()):

  **Line 156** - findByIdWithMappings:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::findByIdWithMappings'));
  ```

  **Line 189** - findAllWithMappings:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::findAllWithMappings'));
  ```

  **Line 281** - insert (catch block):
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::insert'));
  ```

  **Line 366** - getLocations:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::getLocations'));
  ```

  **Line 391** - getQualifications:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::getQualifications'));
  ```

  **Line 416** - getPlacementLevels:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::getPlacementLevels'));
  ```

  **Line 441** - getEmployers:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::getEmployers'));
  ```

  **Line 553** - getLearnersWithProgressionContext:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::getLearnersWithProgressionContext'));
  ```

  **Line 597** - getActiveLPForLearner:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::getActiveLPForLearner'));
  ```

  **Line 624** - getPortfolios:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::getPortfolios'));
  ```

  **Line 722** - savePortfolios:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::savePortfolios'));
  ```

  **Line 786** - deletePortfolio:
  ```php
  error_log(wecoza_sanitize_exception($e->getMessage(), 'LearnerRepository::deletePortfolio'));
  ```

  IMPORTANT: This is a mechanical replacement. Do NOT change any other code in the file.
  </action>
  <verify>
  ```bash
  # Count wecoza_sanitize_exception calls - should be 12
  grep -c "wecoza_sanitize_exception" src/Learners/Repositories/LearnerRepository.php

  # Verify no raw error_log with getMessage remaining
  grep -E 'error_log.*\$e->getMessage\(\)' src/Learners/Repositories/LearnerRepository.php | wc -l
  # Should return 0

  # Verify line 238 static message is unchanged (out of scope)
  grep -n "no valid columns in data" src/Learners/Repositories/LearnerRepository.php
  # Should show the static validation message still exists
  ```
  </verify>
  <done>All 12 exception-based error_log calls in LearnerRepository use wecoza_sanitize_exception() with appropriate context strings</done>
</task>

</tasks>

<verification>
1. `grep -c "wecoza_sanitize_exception" src/Learners/Repositories/LearnerRepository.php` returns 12
2. `grep -E 'error_log.*\$e->getMessage\(\)' src/Learners/Repositories/LearnerRepository.php` returns no matches
3. Line 238 static validation message remains unchanged (out of scope for exception sanitization)
4. PHP syntax check: `php -l src/Learners/Repositories/LearnerRepository.php` returns no errors
</verification>

<success_criteria>
- All 12 exception-based error_log calls in LearnerRepository.php use wecoza_sanitize_exception()
- Each call includes appropriate context string (LearnerRepository::{methodName})
- No raw exception messages remain in error_log calls
- Static validation messages (line 238) are unchanged
- PHP syntax remains valid
- Phase 8 Truth 5 is now fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-bug-fixes-core-security/08-04-SUMMARY.md`
</output>
