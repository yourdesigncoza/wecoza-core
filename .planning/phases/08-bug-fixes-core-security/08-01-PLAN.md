---
phase: 08-bug-fixes-core-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Repositories/LearnerRepository.php
autonomous: true

must_haves:
  truths:
    - "Learner queries return sa_id_no values correctly"
    - "Database catch blocks do not throw secondary errors when $pdo is uninitialized"
    - "getLearnersWithProgressionContext() returns learner ID number data"
  artifacts:
    - path: "src/Learners/Repositories/LearnerRepository.php"
      provides: "Fixed column name and safe exception handling"
      contains: "sa_id_no"
  key_links:
    - from: "src/Learners/Repositories/LearnerRepository.php"
      to: "learners table"
      via: "SQL query with correct column name"
      pattern: "l\\.sa_id_no"
---

<objective>
Fix learner query bugs: column name mismatch and unsafe PDO access in catch blocks.

Purpose: BUG-01 and BUG-04 cause learner data to be incomplete and catch blocks to throw secondary errors.
Output: LearnerRepository with correct column names and safe exception handling.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/Learners/Repositories/LearnerRepository.php
@schema/wecoza_db_schema_bu_jan_29.sql (line 3713: sa_id_no column definition)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix column name mismatch in getLearnersWithProgressionContext</name>
  <files>src/Learners/Repositories/LearnerRepository.php</files>
  <action>
  In `getLearnersWithProgressionContext()` method (around line 504), change:
  - `l.sa_id_number,` to `l.sa_id_no,`

  The database schema uses `sa_id_no` (confirmed in schema/wecoza_db_schema_bu_jan_29.sql line 3713).
  The current code incorrectly references `sa_id_number` which doesn't exist.
  </action>
  <verify>
  Search the file for "sa_id_number" - should return 0 matches.
  Search for "l.sa_id_no" in getLearnersWithProgressionContext - should find the corrected line.
  </verify>
  <done>getLearnersWithProgressionContext() uses correct column name `sa_id_no`</done>
</task>

<task type="auto">
  <name>Task 2: Fix unsafe $pdo access in savePortfolios catch block</name>
  <files>src/Learners/Repositories/LearnerRepository.php</files>
  <action>
  In `savePortfolios()` method (around line 690), the catch block does:
  ```php
  } catch (Exception $e) {
      if ($pdo->inTransaction()) {  // BUG: $pdo may be uninitialized if getPdo() throws
  ```

  Fix by initializing $pdo to null before the try block and adding null check:
  ```php
  public function savePortfolios(int $learnerId, array $files): array
  {
      $pdo = null;  // Initialize to prevent catch block crash
      try {
          $pdo = $this->db->getPdo();
          // ... rest of method
      } catch (Exception $e) {
          if ($pdo !== null && $pdo->inTransaction()) {
              $pdo->rollBack();
          }
          // ... rest of catch
      }
  }
  ```

  Apply same pattern to `deletePortfolio()` method (around line 753) which has the same issue.
  </action>
  <verify>
  Search for `$pdo = null;` in both methods.
  Search for `$pdo !== null &&` before inTransaction() calls.
  </verify>
  <done>Both savePortfolios() and deletePortfolio() handle connection failures gracefully</done>
</task>

</tasks>

<verification>
1. Run grep for "sa_id_number" in LearnerRepository - should return empty
2. Run grep for "$pdo = null" in LearnerRepository - should find 2 matches
3. Run grep for "$pdo !== null && \$pdo->inTransaction" - should find 2 matches
</verification>

<success_criteria>
- Column name `sa_id_no` used consistently in all learner queries
- All catch blocks with $pdo access have null-safety checks
- No PHP errors when database connection fails during portfolio operations
</success_criteria>

<output>
After completion, create `.planning/phases/08-bug-fixes-core-security/08-01-SUMMARY.md`
</output>
