---
phase: 08-bug-fixes-core-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Repositories/LearnerRepository.php
  - assets/js/learners/learners-app.js
autonomous: true

must_haves:
  truths:
    - "Portfolio saves append to existing portfolios, not overwrite"
    - "PDF uploads validated by MIME type before processing"
    - "Invalid file types show generic error message"
    - "Client-side validation provides immediate feedback on file type"
  artifacts:
    - path: "src/Learners/Repositories/LearnerRepository.php"
      provides: "Fixed portfolio save logic with MIME validation"
      contains: "finfo_file"
    - path: "assets/js/learners/learners-app.js"
      provides: "Client-side PDF validation"
      contains: "application/pdf"
  key_links:
    - from: "src/Learners/Repositories/LearnerRepository.php"
      to: "learner_portfolios table"
      via: "INSERT into portfolios after appending to existing"
      pattern: "array_merge"
---

<objective>
Fix portfolio overwrite bug and add MIME type validation for PDF uploads.

Purpose: BUG-02 causes data loss when uploading new portfolios. SEC-04 allows malicious files disguised as PDFs.
Output: Portfolio uploads append correctly and validate actual file content.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-bug-fixes-core-security/08-CONTEXT.md

@src/Learners/Repositories/LearnerRepository.php
@src/Learners/Services/PortfolioUploadService.php (reference implementation with MIME validation)
@core/Helpers/AjaxSecurity.php (validateUploadedFile helper)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix savePortfolios() to append instead of overwrite</name>
  <files>src/Learners/Repositories/LearnerRepository.php</files>
  <action>
  In `savePortfolios()` method, the current code (around line 676-679) does:
  ```php
  if (!empty($portfolioPaths)) {
      $portfolioList = implode(', ', $portfolioPaths);
      $stmt = $pdo->prepare("UPDATE learners SET scanned_portfolio = :paths WHERE id = :id");
  ```

  This OVERWRITES existing portfolios. Fix to APPEND:

  1. After `$pdo->beginTransaction();` (line 644), fetch existing portfolios:
  ```php
  // Fetch existing portfolios to append, not overwrite
  $existingStmt = $pdo->prepare("SELECT scanned_portfolio FROM learners WHERE id = :id");
  $existingStmt->execute(['id' => $learnerId]);
  $existingPortfolios = $existingStmt->fetchColumn();
  $currentPaths = $existingPortfolios ? array_map('trim', explode(',', $existingPortfolios)) : [];
  ```

  2. Change the update logic (around line 676) to merge paths:
  ```php
  if (!empty($portfolioPaths)) {
      // Merge existing and new paths, remove duplicates
      $allPaths = array_merge($currentPaths, $portfolioPaths);
      $uniquePaths = array_unique(array_filter($allPaths));
      $portfolioList = implode(', ', $uniquePaths);
      $stmt = $pdo->prepare("UPDATE learners SET scanned_portfolio = :paths WHERE id = :id");
      $stmt->execute(['paths' => $portfolioList, 'id' => $learnerId]);
  }
  ```
  </action>
  <verify>
  Search for "array_merge(\$currentPaths" in savePortfolios method.
  Search for "SELECT scanned_portfolio FROM learners" before the upload loop.
  </verify>
  <done>savePortfolios() appends new files to existing portfolios</done>
</task>

<task type="auto">
  <name>Task 2: Add MIME type validation to savePortfolios()</name>
  <files>src/Learners/Repositories/LearnerRepository.php</files>
  <action>
  In `savePortfolios()`, the current validation only checks file extension (line 655):
  ```php
  if ($fileExt === 'pdf') {
  ```

  Replace with MIME type validation. Inside the for loop, after getting the extension:

  ```php
  if ($fileExt === 'pdf') {
      // Validate actual MIME type (SEC-04: prevent malicious files)
      $finfo = finfo_open(FILEINFO_MIME_TYPE);
      $mimeType = finfo_file($finfo, $files['tmp_name'][$i]);
      finfo_close($finfo);

      if ($mimeType !== 'application/pdf') {
          // Generic error per CONTEXT.md decision - do NOT reveal detected MIME
          continue; // Skip invalid file, process others
      }

      $newFilename = uniqid('portfolio_', true) . '.pdf';
      // ... rest of upload logic
  }
  ```

  Also update the return value to include validation failures:
  - Track skipped files count
  - Return warning if some files were skipped

  ```php
  // After the loop, before commit
  $skippedCount = count($files['name']) - count($portfolioPaths);

  // In return statement
  return [
      'success' => true,
      'message' => $skippedCount > 0
          ? 'Some files were skipped due to invalid type. Please upload PDF documents only.'
          : 'Files uploaded successfully',
      'paths' => $portfolioPaths,
      'skipped' => $skippedCount,
  ];
  ```
  </action>
  <verify>
  Search for "finfo_open(FILEINFO_MIME_TYPE)" in savePortfolios.
  Search for "application/pdf" MIME check.
  Search for "'skipped'" in return array.
  </verify>
  <done>PDF uploads validated by actual file content, not just extension</done>
</task>

<task type="auto">
  <name>Task 3: Add client-side PDF validation for immediate UX feedback</name>
  <files>assets/js/learners/learners-app.js</files>
  <action>
  Add client-side validation when user selects files for portfolio upload.
  Per CONTEXT.md: "Inline retry: Error shows next to file input, user can immediately select another file"

  Find the portfolio upload form handling (search for "portfolio" or file input handling).
  Add validation on file input change:

  ```javascript
  // Add to portfolio file input change handler
  function validatePdfFiles(fileInput) {
      const files = fileInput.files;
      const errorContainer = fileInput.parentElement.querySelector('.portfolio-upload-error')
          || createErrorContainer(fileInput);

      errorContainer.textContent = '';
      errorContainer.classList.add('d-none');

      for (let i = 0; i < files.length; i++) {
          const file = files[i];
          // Check both extension and MIME type
          const ext = file.name.split('.').pop().toLowerCase();
          const validMime = file.type === 'application/pdf';
          const validExt = ext === 'pdf';

          if (!validExt || !validMime) {
              errorContainer.textContent = 'Invalid file type. Please upload a PDF document.';
              errorContainer.classList.remove('d-none');
              fileInput.value = ''; // Clear the invalid selection
              return false;
          }
      }
      return true;
  }

  function createErrorContainer(fileInput) {
      const container = document.createElement('div');
      container.className = 'portfolio-upload-error text-danger small mt-1 d-none';
      fileInput.parentElement.appendChild(container);
      return container;
  }
  ```

  Attach to any portfolio file inputs using event delegation or direct binding.
  Look for existing file input handlers and add the validation call.
  </action>
  <verify>
  Search for "validatePdfFiles" function in learners-app.js.
  Search for "Invalid file type. Please upload a PDF document" error message.
  </verify>
  <done>Client-side validation provides immediate feedback with inline error display</done>
</task>

</tasks>

<verification>
1. grep for "array_merge" in savePortfolios - confirms append logic
2. grep for "finfo_open" in LearnerRepository - confirms MIME validation
3. grep for "validatePdfFiles" in learners-app.js - confirms client-side validation
4. grep for "skipped" in savePortfolios return - confirms feedback on invalid files
</verification>

<success_criteria>
- Uploading new portfolios appends to existing ones (no data loss)
- Malicious files with .pdf extension but wrong MIME type are rejected
- Users see "Invalid file type. Please upload a PDF document." on invalid files
- Error message appears inline below the file input (red text)
- Server-side validation is the security backstop; client-side is UX enhancement
</success_criteria>

<output>
After completion, create `.planning/phases/08-bug-fixes-core-security/08-02-SUMMARY.md`
</output>
