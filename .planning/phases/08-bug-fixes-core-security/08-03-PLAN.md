---
phase: 08-bug-fixes-core-security
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - core/Abstract/BaseRepository.php
  - core/Helpers/functions.php
autonomous: true

must_haves:
  truths:
    - "BaseRepository provides quoteIdentifier() for safe identifier quoting"
    - "Exception logs do not expose database schema details"
    - "Error messages are sanitized before logging"
  artifacts:
    - path: "core/Abstract/BaseRepository.php"
      provides: "quoteIdentifier() helper method"
      contains: "quoteIdentifier"
    - path: "core/Helpers/functions.php"
      provides: "wecoza_sanitize_exception() helper"
      contains: "sanitize_exception"
  key_links:
    - from: "core/Abstract/BaseRepository.php"
      to: "PostgreSQL queries"
      via: "quoteIdentifier for reserved word safety"
      pattern: 'quoteIdentifier.*preg_replace'
---

<objective>
Add security helpers: identifier quoting for PostgreSQL reserved words and exception message sanitization.

Purpose: SEC-01 prevents SQL errors with reserved words. SEC-05 prevents schema leakage in logs.
Output: BaseRepository with quoteIdentifier() and new sanitize_exception() helper function.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@core/Abstract/BaseRepository.php
@core/Helpers/functions.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add quoteIdentifier() helper to BaseRepository</name>
  <files>core/Abstract/BaseRepository.php</files>
  <action>
  Add a protected method to safely quote PostgreSQL identifiers. This prevents issues with reserved words like "user", "order", "group", etc.

  Add after the `filterAllowedColumns()` method (around line 130):

  ```php
  /**
   * Quote a PostgreSQL identifier to handle reserved words
   *
   * Sanitizes the identifier by removing non-alphanumeric characters (except underscore),
   * then wraps in double quotes for PostgreSQL compatibility.
   *
   * @param string $identifier Column or table name
   * @return string Safely quoted identifier
   */
  protected function quoteIdentifier(string $identifier): string
  {
      // Remove any characters that aren't alphanumeric or underscore
      $clean = preg_replace('/[^a-zA-Z0-9_]/', '', $identifier);
      return '"' . $clean . '"';
  }
  ```

  Note: This method is added as a utility for child repositories. It will be used when building dynamic queries with column names that might be PostgreSQL reserved words. The insert() and update() methods already use column whitelisting which provides the primary protection.
  </action>
  <verify>
  Search for "function quoteIdentifier" in BaseRepository.
  Search for 'preg_replace.*a-zA-Z0-9_' pattern.
  </verify>
  <done>quoteIdentifier() helper available for PostgreSQL reserved word safety</done>
</task>

<task type="auto">
  <name>Task 2: Add exception sanitization helper function</name>
  <files>core/Helpers/functions.php</files>
  <action>
  Add a helper function to sanitize exception messages before logging.
  This prevents database schema details from leaking into logs (SEC-05).

  Add to functions.php (find appropriate section for utility functions):

  ```php
  /**
   * Sanitize exception message for logging
   *
   * Removes sensitive information from exception messages before logging:
   * - Database schema/table names patterns
   * - Column names in error messages
   * - Connection strings
   * - SQL query fragments
   *
   * @param string $message Original exception message
   * @param string $context Optional context prefix (e.g., "LearnerRepository")
   * @return string Sanitized message safe for logging
   */
  function wecoza_sanitize_exception(string $message, string $context = ''): string
  {
      // Patterns that might expose schema details
      $patterns = [
          // Remove table.column references
          '/\b[a-z_]+\.[a-z_]+/i' => '[table.column]',
          // Remove "column X" patterns
          '/column\s+["\']?[a-z_]+["\']?/i' => 'column [redacted]',
          // Remove "table X" patterns
          '/table\s+["\']?[a-z_]+["\']?/i' => 'table [redacted]',
          // Remove SQL fragments
          '/\b(SELECT|INSERT|UPDATE|DELETE|FROM|WHERE|JOIN)\b.*$/i' => '[SQL redacted]',
          // Remove constraint names
          '/constraint\s+["\']?[a-z_]+["\']?/i' => 'constraint [redacted]',
          // Remove index names
          '/index\s+["\']?[a-z_]+["\']?/i' => 'index [redacted]',
      ];

      $sanitized = $message;
      foreach ($patterns as $pattern => $replacement) {
          $sanitized = preg_replace($pattern, $replacement, $sanitized);
      }

      // Truncate if too long (prevent log flooding)
      if (strlen($sanitized) > 200) {
          $sanitized = substr($sanitized, 0, 200) . '...';
      }

      // Add context prefix if provided
      $prefix = $context ? "WeCoza Core [{$context}]: " : "WeCoza Core: ";

      return $prefix . $sanitized;
  }
  ```

  Also add a companion function for admin-visible errors (for debugging):

  ```php
  /**
   * Get admin-safe exception details
   *
   * For administrators only - provides more detail than logs but still sanitized.
   * Use current_user_can('manage_options') before showing this to users.
   *
   * @param Exception $e The exception
   * @param string $context Context identifier
   * @return array Admin-safe error details
   */
  function wecoza_admin_exception_details(\Exception $e, string $context = ''): array
  {
      return [
          'context' => $context,
          'type' => get_class($e),
          'code' => $e->getCode(),
          'file' => basename($e->getFile()) . ':' . $e->getLine(),
          'message' => wecoza_sanitize_exception($e->getMessage()),
      ];
  }
  ```
  </action>
  <verify>
  Search for "function wecoza_sanitize_exception" in functions.php.
  Search for "function wecoza_admin_exception_details" in functions.php.
  Search for "[SQL redacted]" replacement pattern.
  </verify>
  <done>Exception sanitization helpers available for secure logging</done>
</task>

<task type="auto">
  <name>Task 3: Update BaseRepository to use sanitized logging</name>
  <files>core/Abstract/BaseRepository.php</files>
  <action>
  Update error_log calls in BaseRepository to use the new sanitization helper.
  This demonstrates the pattern for other repositories to follow.

  Find all error_log calls in BaseRepository and update them:

  ```php
  // Before (example from findById around line 167):
  error_log("WeCoza Core: Repository findById error: " . $e->getMessage());

  // After:
  error_log(wecoza_sanitize_exception($e->getMessage(), 'Repository::findById'));
  ```

  Update ALL error_log calls in BaseRepository:
  - findById (line ~167)
  - findAll (line ~204)
  - findBy (line ~276)
  - count (line ~332)
  - insert (line ~401)
  - update (line ~446)
  - delete (line ~470)
  - deleteBy (line ~517)

  Pattern: Replace `error_log("WeCoza Core: Repository {method} error: " . $e->getMessage());`
  With: `error_log(wecoza_sanitize_exception($e->getMessage(), 'Repository::{method}'));`
  </action>
  <verify>
  Search for "wecoza_sanitize_exception" calls in BaseRepository - should find 8+ matches.
  Search for old pattern "error_log.*getMessage" - should find 0 matches in BaseRepository.
  </verify>
  <done>BaseRepository uses sanitized logging throughout</done>
</task>

</tasks>

<verification>
1. grep for "quoteIdentifier" in BaseRepository - confirms helper added
2. grep for "wecoza_sanitize_exception" in functions.php - confirms helper exists
3. grep for "wecoza_sanitize_exception" in BaseRepository - confirms usage
4. grep for "error_log.*\$e->getMessage" in BaseRepository - should be 0 (all replaced)
</verification>

<success_criteria>
- quoteIdentifier() available for PostgreSQL reserved word handling
- wecoza_sanitize_exception() removes schema details from log messages
- wecoza_admin_exception_details() provides safe debugging info for admins
- BaseRepository demonstrates the sanitized logging pattern
- Exception messages in logs no longer expose table/column names
</success_criteria>

<output>
After completion, create `.planning/phases/08-bug-fixes-core-security/08-03-SUMMARY.md`
</output>
