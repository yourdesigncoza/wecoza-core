---
phase: 31-learners-module-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 10 LRNR requirements verified against actual code — each classified as already-fixed or needs-fix"
    - "No false positives — implementer does not waste time fixing things already resolved"
    - "Any ambiguous findings documented with exact file paths and line numbers"
  artifacts:
    - path: ".planning/phases/31-learners-module-fixes/31-01-SUMMARY.md"
      provides: "Verification results for all 10 LRNR requirements"
      contains: "LRNR-01.*LRNR-10"
  key_links: []
---

<objective>
Verify current code state against all 10 LRNR audit claims before making any changes.

Purpose: Research found that many audit issues (LRNR-01, LRNR-02, LRNR-05, LRNR-06, LRNR-07, LRNR-08) appear already fixed. This safety-first verification prevents breaking working code and scopes Plan 02 to only genuine remaining issues.

Output: Verification report classifying each LRNR requirement as "already-fixed" or "needs-fix" with evidence.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-learners-module-fixes/31-RESEARCH.md

Key files to verify:
@src/Learners/Shortcodes/learners-capture-shortcode.php
@src/Learners/Shortcodes/learners-update-shortcode.php
@src/Learners/Ajax/LearnerAjaxHandlers.php
@assets/js/learners/learners-app.js
@src/Learners/Repositories/LearnerRepository.php
@src/Learners/Controllers/LearnerController.php
@docs/FORM-FIELDS-REFERENCE.md
@.integrate/wecoza-learners-plugin/views/learner-form.view.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify all 10 LRNR requirements against current code</name>
  <files>
    src/Learners/Shortcodes/learners-capture-shortcode.php
    src/Learners/Shortcodes/learners-update-shortcode.php
    src/Learners/Ajax/LearnerAjaxHandlers.php
    assets/js/learners/learners-app.js
    src/Learners/Repositories/LearnerRepository.php
    src/Learners/Controllers/LearnerController.php
    docs/FORM-FIELDS-REFERENCE.md
    .integrate/wecoza-learners-plugin/views/learner-form.view.php
  </files>
  <action>
    This is a READ-ONLY verification task. Do NOT modify any files.

    For each LRNR requirement, check the current code and classify as "already-fixed" or "needs-fix":

    **LRNR-01 (numeracy_level in update shortcode):**
    - Read `learners-update-shortcode.php` and search for `numeracy_level` in the POST data array
    - Expected: `intval($_POST['numeracy_level'])` present around line 99
    - If present → already-fixed

    **LRNR-02 (sponsors orphaned field):**
    - Check if `learner_sponsors` table schema exists in `schema/learner_sponsors.sql`
    - Check if `LearnerRepository` has `getSponsors()` and `saveSponsors()` methods
    - Check if both shortcodes have POST processing for `$_POST['sponsors']`
    - If all three exist → already-fixed (feature is fully implemented)

    **LRNR-03 (phantom fields in baseline doc):**
    - Search `docs/FORM-FIELDS-REFERENCE.md` for `date_of_birth` and `suburb` entries
    - Search `LearnerRepository::getAllowedInsertColumns()` for `suburb`
    - If `suburb` is NOT in insert whitelist but IS in baseline doc → needs-fix (doc cleanup only)
    - If `suburb` IS in insert whitelist → needs-fix (whitelist + doc cleanup)

    **LRNR-04 (duplicate placement_assessment_date):**
    - Count occurrences of `name="placement_assessment_date"` in `learners-capture-shortcode.php`
    - If only 1 occurrence → already-fixed
    - If 2 occurrences → needs-fix (remove duplicate)

    **LRNR-05 (nopriv AJAX registrations):**
    - Grep `LearnerAjaxHandlers.php` for `wp_ajax_nopriv`
    - If 0 matches → already-fixed
    - If matches found → needs-fix

    **LRNR-06 (employment_status visibility bug):**
    - Read `learners-update-shortcode.php` around line 522 for employer_field div
    - Check if comparison uses `!== 'Employed'` (correct) or `!$learner->employment_status` (buggy)
    - If correct comparison → already-fixed

    **LRNR-07 (highest_qualification intval):**
    - Check BOTH shortcodes for `highest_qualification` sanitization
    - Create shortcode: should use `intval()` not `sanitize_text_field()`
    - Update shortcode: should use `intval()`
    - If both use `intval()` → already-fixed

    **LRNR-08 (date format validation):**
    - Check BOTH shortcodes for `placement_assessment_date` handling
    - Should use `DateTime::createFromFormat('Y-m-d', ...)` pattern
    - If both have proper validation → already-fixed

    **LRNR-09 (template literal XSS):**
    - Read entire `learners-app.js`
    - Search for `.html()` calls that inject template literals containing `${...}` with dynamic/server data
    - Focus on the `showAlert()` function — does it use `.html()` with `${message}` where message could contain `response.data.message`?
    - Check line 534: does `showAlert('error', response.data.message || ...)` pass server data to `.html()`?
    - If `.html()` is used with server-provided data → needs-fix
    - If all dynamic content uses `.text()` → already-fixed

    **LRNR-10 (dead code):**
    - Search `learners-app.js` for `populateEditForm` function and `#editLearnerForm` handler
    - Search `LearnerController.php` for unused AJAX hook registrations (beyond shortcode registration)
    - Check if `.integrate/wecoza-learners-plugin/views/learner-form.view.php` exists
    - Grep all PHP files for references to `learner-form.view.php`
    - Classify each dead code target as "present (needs-fix)" or "absent (already-fixed)"

    Create the SUMMARY with a table:
    | Requirement | Status | Evidence | Action Needed |
  </action>
  <verify>
    - SUMMARY file created at `.planning/phases/31-learners-module-fixes/31-01-SUMMARY.md`
    - All 10 LRNR requirements have a classification
    - Each classification has specific file:line evidence
    - "needs-fix" items have clear description of what change is required
  </verify>
  <done>
    All 10 LRNR requirements verified against actual codebase with evidence-backed classifications. Plan 02 can scope its work precisely to only confirmed issues.
  </done>
</task>

</tasks>

<verification>
- [ ] All 10 LRNR requirements have a verified status (already-fixed or needs-fix)
- [ ] No files were modified during verification
- [ ] Evidence includes exact file paths and line numbers
- [ ] SUMMARY clearly documents what Plan 02 should implement
</verification>

<success_criteria>
- Verification report exists with all 10 requirements classified
- Each classification backed by specific code evidence
- Clear list of remaining work items for Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/31-learners-module-fixes/31-01-SUMMARY.md`
</output>
