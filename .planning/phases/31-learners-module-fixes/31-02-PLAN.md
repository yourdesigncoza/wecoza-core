---
phase: 31-learners-module-fixes
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/Learners/Shortcodes/learners-capture-shortcode.php
  - src/Learners/Shortcodes/learners-update-shortcode.php
  - src/Learners/Ajax/LearnerAjaxHandlers.php
  - assets/js/learners/learners-app.js
  - src/Learners/Repositories/LearnerRepository.php
  - src/Learners/Controllers/LearnerController.php
  - docs/FORM-FIELDS-REFERENCE.md
  - .integrate/wecoza-learners-plugin/views/learner-form.view.php
autonomous: false

must_haves:
  truths:
    - "LRNR-01: numeracy_level is captured in BOTH create and update shortcode POST arrays"
    - "LRNR-02: sponsors feature is either fully wired or removed per user decision"
    - "LRNR-03: no phantom fields (date_of_birth, suburb) in Learners section of baseline doc"
    - "LRNR-04: exactly one placement_assessment_date input field in create form"
    - "LRNR-05: zero wp_ajax_nopriv registrations in Learners module"
    - "LRNR-06: employer field visibility uses correct string comparison !== 'Employed'"
    - "LRNR-07: highest_qualification uses intval() in BOTH shortcodes"
    - "LRNR-08: placement_assessment_date uses DateTime::createFromFormat in BOTH shortcodes"
    - "LRNR-09: no .html() with server-provided data interpolation in learners-app.js"
    - "LRNR-10: no dead code (populateEditForm, editLearnerForm, legacy view file, unused controller AJAX hooks)"
    - "All existing learner CRUD functionality still works — no regressions"
  artifacts:
    - path: "src/Learners/Shortcodes/learners-capture-shortcode.php"
      provides: "Create learner form with correct sanitization"
      contains: "intval.*highest_qualification"
    - path: "src/Learners/Shortcodes/learners-update-shortcode.php"
      provides: "Update learner form with all fields wired"
      contains: "numeracy_level.*intval"
    - path: "assets/js/learners/learners-app.js"
      provides: "XSS-safe alert rendering, no dead code"
      contains: "text.*message|textContent"
    - path: "src/Learners/Ajax/LearnerAjaxHandlers.php"
      provides: "AJAX handlers with no nopriv registrations"
    - path: "docs/FORM-FIELDS-REFERENCE.md"
      provides: "Accurate field reference without phantom entries"
  key_links:
    - from: "assets/js/learners/learners-app.js"
      to: "AJAX responses"
      via: "showAlert function"
      pattern: "showAlert.*text"
    - from: "src/Learners/Shortcodes/learners-capture-shortcode.php"
      to: "LearnerController::createLearner"
      via: "POST data array"
      pattern: "intval.*highest_qualification"
    - from: "src/Learners/Shortcodes/learners-update-shortcode.php"
      to: "LearnerController::updateLearner"
      via: "POST data array"
      pattern: "numeracy_level.*intval"
---

<objective>
Implement ALL fixes for LRNR-01 through LRNR-10 based on Plan 01 verification results. Each requirement is checked against 31-01-SUMMARY.md first — only items classified as "needs-fix" get patched; "already-fixed" items are confirmed and skipped.

Purpose: Close every form field wiring issue from the Learners audit. Covers PHP shortcode fixes, security hardening, documentation cleanup, dead code removal, and a user decision on sponsors.

Output: All 10 LRNR requirements resolved, verified via automated grep checks.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-learners-module-fixes/31-01-SUMMARY.md
@.planning/phases/31-learners-module-fixes/31-RESEARCH.md

Key files:
@src/Learners/Shortcodes/learners-capture-shortcode.php
@src/Learners/Shortcodes/learners-update-shortcode.php
@src/Learners/Ajax/LearnerAjaxHandlers.php
@assets/js/learners/learners-app.js
@src/Learners/Repositories/LearnerRepository.php
@src/Learners/Controllers/LearnerController.php
@docs/FORM-FIELDS-REFERENCE.md
@.integrate/wecoza-learners-plugin/views/learner-form.view.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: PHP shortcode fixes (LRNR-01, LRNR-02, LRNR-04, LRNR-06, LRNR-07, LRNR-08)</name>
  <files>
    src/Learners/Shortcodes/learners-capture-shortcode.php
    src/Learners/Shortcodes/learners-update-shortcode.php
    src/Learners/Repositories/LearnerRepository.php
  </files>
  <action>
    **CRITICAL:** Read `31-01-SUMMARY.md` first. For each LRNR item below, check its classification in the SUMMARY. Only apply the fix if classified as "needs-fix". If "already-fixed", confirm with a grep and move on.

    **LRNR-01: numeracy_level in update shortcode**
    - If needs-fix: Add `'numeracy_level' => intval($_POST['numeracy_level']),` to the update shortcode POST data array (after `placement_assessment_date` around line 98)
    - If already-fixed: Grep `learners-update-shortcode.php` for `numeracy_level` to confirm it exists in the POST data array. Log line number.

    **LRNR-02: sponsors feature — USER DECISION REQUIRED**
    - If needs-fix (feature not fully wired):
      **ASK THE USER before proceeding.** Present two options:
      Option A: Implement full sponsor storage (new table + POST processing + repository methods)
      Option B: Remove the sponsors UI from both forms
      **DO NOT proceed without user answer.** If user is unavailable, skip LRNR-02 and document it as "deferred — awaiting user decision" in the SUMMARY.
    - If already-fixed (sponsors fully implemented per research): Confirm by grepping both shortcodes for `sponsors` POST processing. No changes needed.
    - If user decides to remove: Delete sponsors UI HTML (~lines 449-467 in create, ~537-554 in update) and POST processing (~lines 109-113 create, ~112-116 update)

    **LRNR-04: duplicate placement_assessment_date**
    - If needs-fix: In `learners-capture-shortcode.php`, count `name="placement_assessment_date"` occurrences. If 2 found, delete the SECOND instance (the duplicate around lines 411-416, preserving the first at lines 406-410).
    - If already-fixed: Confirm exactly 1 occurrence via grep count.

    **LRNR-06: employment_status visibility**
    - If needs-fix: In `learners-update-shortcode.php`, find the `employer_field` div (around line 522). Change the PHP comparison to `$learner->employment_status !== 'Employed'` for the `style="display:none;"` condition.
    - If already-fixed: Confirm the comparison uses `!== 'Employed'` (correct string comparison, not truthy check).

    **LRNR-07: highest_qualification intval**
    - If needs-fix (create shortcode uses sanitize_text_field): In `learners-capture-shortcode.php`, change `sanitize_text_field($_POST['highest_qualification'])` to `intval($_POST['highest_qualification'])` (around line 62).
    - If already-fixed in update shortcode: Confirm update shortcode uses `intval()` via grep.
    - Both shortcodes must use `intval()` for this FK ID field.

    **LRNR-08: date format validation**
    - If needs-fix: Add DateTime validation to placement_assessment_date in the affected shortcode(s):
      ```php
      'placement_assessment_date' => (($d = \DateTime::createFromFormat('Y-m-d', $_POST['placement_assessment_date'] ?? '')) && $d->format('Y-m-d') === $_POST['placement_assessment_date']) ? $d->format('Y-m-d') : null,
      ```
    - If already-fixed: Confirm both shortcodes have `DateTime::createFromFormat` for `placement_assessment_date`. Log line numbers.

    **LRNR-03 partial (repository whitelist):**
    - Check `LearnerRepository::getAllowedInsertColumns()` for `suburb`. If present, remove it from the array. If absent, confirm clean.
  </action>
  <verify>
    Run these greps to verify all 6 requirements:
    ```bash
    # LRNR-01: numeracy_level in update shortcode
    grep -n "numeracy_level" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-02: sponsors processing in both (or removed from both)
    grep -n "sponsors" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "sponsors" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-04: exactly 1 placement_assessment_date input
    grep -c 'name="placement_assessment_date"' src/Learners/Shortcodes/learners-capture-shortcode.php

    # LRNR-06: correct comparison
    grep -n "employment_status.*Employed" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-07: intval in BOTH shortcodes
    grep -n "highest_qualification" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "highest_qualification" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-08: DateTime validation in BOTH shortcodes
    grep -n "createFromFormat" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "createFromFormat" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-03 partial: suburb NOT in insert whitelist
    grep -n "suburb" src/Learners/Repositories/LearnerRepository.php
    ```
  </verify>
  <done>
    LRNR-01: numeracy_level present in update shortcode POST array.
    LRNR-02: sponsors either confirmed working or resolved per user decision.
    LRNR-04: exactly 1 placement_assessment_date input in create form.
    LRNR-06: employer field uses correct `!== 'Employed'` comparison.
    LRNR-07: both shortcodes use intval() for highest_qualification.
    LRNR-08: both shortcodes use DateTime::createFromFormat for placement_assessment_date.
    LRNR-03 partial: suburb absent from repository insert whitelist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Security fixes (LRNR-05 nopriv, LRNR-09 XSS)</name>
  <files>
    src/Learners/Ajax/LearnerAjaxHandlers.php
    assets/js/learners/learners-app.js
  </files>
  <action>
    **Read 31-01-SUMMARY.md first.** Apply fixes only for items classified as "needs-fix".

    **LRNR-05: Remove nopriv AJAX registrations**
    - If needs-fix: In `LearnerAjaxHandlers.php`, find and remove all `wp_ajax_nopriv_*` `add_action()` calls. Expected locations around lines 292-293. Remove only the nopriv lines — keep the authenticated `wp_ajax_*` registrations.
    - If already-fixed: Grep for `nopriv` in the file — confirm 0 matches.
    - Context: Entire WP site requires authentication. Agents and Clients modules already removed their nopriv hooks.

    **LRNR-09: Fix XSS risk in showAlert and audit all .html() calls**
    - If needs-fix: The `showAlert()` function (around line 547) constructs HTML via template literal with `${message}` parameter, then injects via `.html()`. The `message` parameter receives `response.data.message` from AJAX error handlers (line 534), which is server-provided data — XSS risk.

      Replace the current `showAlert` function body with a safe version using DOM construction:

      ```javascript
      function showAlert(type, message) {
          const alertClass = type === 'success' ? 'alert-subtle-success' : 'alert-subtle-danger';
          const $alert = $('<div class="alert alert-dismissible fade show mb-3" role="alert"></div>')
              .addClass(alertClass)
              .text(message);
          $alert.append('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');

          if ($('#alert-container').length) {
              $('#alert-container').html('').append($alert);
          } else if ($('.wecoza-single-learner-display > .d-flex').length) {
              $('.wecoza-single-learner-display > .d-flex').after($alert);
          } else {
              $('body').prepend($('<div class="container mt-3"></div>').append($alert));
          }

          if (type !== 'success') {
              setTimeout(() => { $alert.fadeOut(); }, 5000);
          }
      }
      ```

      Key change: Use `.text(message)` instead of `${message}` inside `.html()`.

      Also audit ALL other `.html()` calls in the file:
      - Static content (hardcoded strings, no `${...}` with server data) = SAFE, leave as-is
      - Any `.html()` with `${response...}` or `${data...}` = FIX to use `.text()`

    - If already-fixed: Grep for `.html(` and verify none inject server-provided data via `${...}`.
  </action>
  <verify>
    ```bash
    # LRNR-05: no nopriv in Learners module
    grep -r "nopriv" src/Learners/ --include="*.php"

    # LRNR-09: audit .html() calls
    grep -n "\.html(" assets/js/learners/learners-app.js
    # Verify showAlert uses .text(message)
    grep -n "\.text(message)" assets/js/learners/learners-app.js
    ```
    - LRNR-05: 0 nopriv matches in src/Learners/
    - LRNR-09: showAlert uses `.text(message)`, no `.html()` with `${...}` server data
  </verify>
  <done>
    LRNR-05: zero wp_ajax_nopriv registrations in Learners module.
    LRNR-09: showAlert uses .text() for dynamic content. No .html() call injects server-provided data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Documentation cleanup and dead code removal (LRNR-03, LRNR-10)</name>
  <files>
    docs/FORM-FIELDS-REFERENCE.md
    .integrate/wecoza-learners-plugin/views/learner-form.view.php
    assets/js/learners/learners-app.js
    src/Learners/Controllers/LearnerController.php
  </files>
  <action>
    **Read 31-01-SUMMARY.md first.** Apply fixes only for items classified as "needs-fix".

    **LRNR-03: Clean phantom fields from baseline doc**
    - If needs-fix: Read `docs/FORM-FIELDS-REFERENCE.md` and find the Learners section.
      - Remove `date_of_birth` table row if present in Learners section
      - Remove `suburb` table row if present in Learners section
      - IMPORTANT: Do NOT remove `suburb` from Clients or Locations sections — those are legitimate
    - If already-fixed: Grep the file for `date_of_birth` and `suburb` in the Learners context — confirm absent.

    **LRNR-10: Dead code removal — 4 targets**

    Target A: Legacy view file
    - Grep ALL PHP files for references to `learner-form.view.php`:
      ```bash
      grep -r "learner-form.view.php" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/ --include="*.php"
      ```
    - If NO references found: Delete `.integrate/wecoza-learners-plugin/views/learner-form.view.php`
    - If references ARE found: Do NOT delete. Document in SUMMARY and flag for user decision.

    Target B: Dead JS functions
    - Grep `learners-app.js` for `populateEditForm` function. If found, remove the entire function block.
    - Grep `learners-app.js` for `#editLearnerForm` handler. If found, remove the entire handler block.
    - If both already absent: Confirm and log.

    Target C: Unused controller AJAX hooks
    - Read `LearnerController.php` and check for a `registerHooks()` method.
    - If it registers AJAX actions like `wecoza_get_learner`, `wecoza_update_learner` etc. that have NO JS callers (the actual AJAX flow uses `LearnerAjaxHandlers`), remove those unused registrations.
    - If no such method exists or no unused hooks: Confirm and log.

    Target D: Dead code grep sweep
    - Grep for `edit-learner-id`, `edit-first-name`, `edit-surname` in all JS files — these are legacy modal field IDs
    - If found in active code (not comments), remove the dead references
    - If not found: Confirm clean.
  </action>
  <verify>
    ```bash
    # LRNR-03: phantom fields absent from Learners section
    grep -n "date_of_birth" docs/FORM-FIELDS-REFERENCE.md
    grep -n "suburb" docs/FORM-FIELDS-REFERENCE.md

    # LRNR-10 Target A: legacy view file gone
    ls .integrate/wecoza-learners-plugin/views/learner-form.view.php 2>/dev/null

    # LRNR-10 Target B: dead JS functions gone
    grep -r "populateEditForm" assets/js/ --include="*.js"
    grep -r "editLearnerForm" assets/js/ --include="*.js"

    # LRNR-10 Target C: no unused controller AJAX hooks
    grep -n "wp_ajax_wecoza_get_learner\|wp_ajax_wecoza_update_learner\|wp_ajax_wecoza_delete_learner" src/Learners/Controllers/LearnerController.php

    # LRNR-10 Target D: no legacy modal field IDs
    grep -r "edit-learner-id\|edit-first-name\|edit-surname" assets/js/ --include="*.js"
    ```
    - LRNR-03: `date_of_birth` absent from Learners section, `suburb` absent from Learners section (may appear in Clients/Locations — that is OK)
    - LRNR-10: legacy view file deleted, no dead JS functions, no unused controller hooks, no legacy modal IDs
  </verify>
  <done>
    LRNR-03: Phantom fields removed from Learners section of baseline doc. Repository whitelist clean (handled in Task 1).
    LRNR-10: All 4 dead code targets resolved — legacy view deleted, dead JS removed, unused controller hooks cleaned, legacy modal IDs absent.
  </done>
</task>

<task type="auto">
  <name>Task 4: Final verification — grep-based regression check across all 10 LRNR requirements</name>
  <files></files>
  <action>
    Run a comprehensive grep-based verification across ALL 10 LRNR requirements to confirm everything is in order. This is the gate check — every item must pass.

    ```bash
    # LRNR-01: numeracy_level in update shortcode
    grep -n "numeracy_level" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-02: sponsors processing exists in both (or removed from both per user decision)
    grep -n "sponsors" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "sponsors" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-03: suburb NOT in insert whitelist, phantom fields gone from doc
    grep -n "suburb" src/Learners/Repositories/LearnerRepository.php
    grep -n "date_of_birth" docs/FORM-FIELDS-REFERENCE.md

    # LRNR-04: only 1 placement_assessment_date field in create form
    grep -c 'name="placement_assessment_date"' src/Learners/Shortcodes/learners-capture-shortcode.php

    # LRNR-05: no nopriv in Learners module
    grep -r "nopriv" src/Learners/ --include="*.php"

    # LRNR-06: correct employment_status comparison
    grep -n "employment_status.*Employed" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-07: intval for highest_qualification in BOTH shortcodes
    grep -n "highest_qualification" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "highest_qualification" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-08: DateTime validation for placement_assessment_date
    grep -n "createFromFormat" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "createFromFormat" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-09: no unsafe .html() with template literal + server data
    grep -n "\.html(" assets/js/learners/learners-app.js

    # LRNR-10: no dead code
    grep -r "populateEditForm" assets/js/ --include="*.js"
    grep -r "editLearnerForm" assets/js/ --include="*.js"
    ls .integrate/wecoza-learners-plugin/views/learner-form.view.php 2>/dev/null
    grep -r "learner-form.view.php" src/ --include="*.php"
    ```

    **Expected results for each check:**
    - LRNR-01: numeracy_level present in POST data array with intval()
    - LRNR-02: sponsors either present in both shortcodes (kept) OR absent from both (removed per user)
    - LRNR-03: suburb only in SELECT JOINs, not insert whitelist; date_of_birth absent from Learners doc section
    - LRNR-04: count = 1 (exactly one placement_assessment_date input)
    - LRNR-05: 0 nopriv matches
    - LRNR-06: comparison uses `!== 'Employed'` (string comparison)
    - LRNR-07: both show intval() for highest_qualification
    - LRNR-08: both show createFromFormat for placement_assessment_date
    - LRNR-09: no .html() with ${...} server data interpolation
    - LRNR-10: all 0 matches for dead code, legacy file absent

    If ANY check fails, investigate and fix BEFORE marking task complete.

    **ASK USER if any unexpected issues are found** — do not silently fix things outside the LRNR-01 through LRNR-10 scope.

    Document all results in the SUMMARY.
  </action>
  <verify>
    All 10 grep checks pass per expected results above. No unexpected failures.
  </verify>
  <done>
    All 10 LRNR requirements verified as resolved. No regressions detected. Phase 31 success criteria met.
  </done>
</task>

</tasks>

<verification>
- [ ] LRNR-01: numeracy_level captured in update shortcode POST array
- [ ] LRNR-02: sponsors feature resolved (kept working or removed per user decision)
- [ ] LRNR-03: phantom fields removed from baseline doc, suburb absent from insert whitelist
- [ ] LRNR-04: exactly 1 placement_assessment_date input in create form
- [ ] LRNR-05: zero nopriv AJAX registrations in Learners module
- [ ] LRNR-06: employer field visibility uses correct string comparison
- [ ] LRNR-07: highest_qualification uses intval() in BOTH shortcodes
- [ ] LRNR-08: placement_assessment_date uses DateTime validation in BOTH shortcodes
- [ ] LRNR-09: no XSS risk from .html() with server data in learners-app.js
- [ ] LRNR-10: all dead code targets resolved (legacy view, JS functions, controller hooks)
- [ ] All existing learner CRUD functionality still works — no regressions
</verification>

<success_criteria>
1. All 10 LRNR requirements verified as resolved via automated grep checks
2. LRNR-02 resolved with explicit user decision (or documented as deferred)
3. No files outside the defined scope modified
4. No regressions — learner create, update, delete, display all functional
</success_criteria>

<output>
After completion, create `.planning/phases/31-learners-module-fixes/31-02-SUMMARY.md`
</output>
