---
phase: 31-learners-module-fixes
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - assets/js/learners/learners-app.js
  - docs/FORM-FIELDS-REFERENCE.md
  - .integrate/wecoza-learners-plugin/views/learner-form.view.php
autonomous: true

must_haves:
  truths:
    - "No XSS risk from server response data injected via .html() in learners-app.js"
    - "Baseline doc (FORM-FIELDS-REFERENCE.md) contains no phantom field entries for learners"
    - "Legacy learner view file removed from .integrate directory"
    - "All existing learner CRUD functionality still works — no regressions"
  artifacts:
    - path: "assets/js/learners/learners-app.js"
      provides: "XSS-safe alert rendering"
      contains: "text.*message|textContent"
    - path: "docs/FORM-FIELDS-REFERENCE.md"
      provides: "Accurate field reference without phantom entries"
  key_links:
    - from: "assets/js/learners/learners-app.js"
      to: "AJAX responses"
      via: "showAlert function"
      pattern: "showAlert.*text"
---

<objective>
Implement confirmed remaining fixes from Plan 01 verification: XSS patch (LRNR-09), baseline doc cleanup (LRNR-03), and legacy file removal (LRNR-10).

Purpose: Close all genuine issues identified during verification. Based on research, the primary remaining work is: (1) fix `.html()` XSS risk in showAlert function, (2) clean phantom fields from baseline doc, (3) delete legacy view file.

Output: Patched JS file, cleaned baseline doc, removed legacy file.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-learners-module-fixes/31-01-SUMMARY.md

Key files:
@assets/js/learners/learners-app.js
@docs/FORM-FIELDS-REFERENCE.md
@.integrate/wecoza-learners-plugin/views/learner-form.view.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix XSS risk in showAlert and audit all .html() calls (LRNR-09)</name>
  <files>assets/js/learners/learners-app.js</files>
  <action>
    **IMPORTANT:** Read 31-01-SUMMARY.md first. If LRNR-09 was classified as "already-fixed", skip this task.

    The `showAlert()` function (around line 547) constructs HTML via template literal with `${message}` parameter, then injects via `.html()`. The `message` parameter receives `response.data.message` from AJAX error handlers (line 534), which is server-provided data — XSS risk.

    **Fix the showAlert function:**

    Replace the current `showAlert` function body with a safe version that uses DOM construction instead of `.html()` with interpolated strings:

    ```javascript
    function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-subtle-success' : 'alert-subtle-danger';
        const $alert = $('<div class="alert alert-dismissible fade show mb-3" role="alert"></div>')
            .addClass(alertClass)
            .text(message);
        $alert.append('<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>');

        // Try different alert container locations
        if ($('#alert-container').length) {
            $('#alert-container').html('').append($alert);
        } else if ($('.wecoza-single-learner-display > .d-flex').length) {
            $('.wecoza-single-learner-display > .d-flex').after($alert);
        } else {
            $('body').prepend($('<div class="container mt-3"></div>').append($alert));
        }

        // Auto-dismiss after 5 seconds for error messages
        if (type !== 'success') {
            setTimeout(() => {
                $alert.fadeOut();
            }, 5000);
        }
    }
    ```

    Key changes:
    - Use `$('<div>').text(message)` instead of template literal `${message}` inside `.html()`
    - Use `.append()` for the close button (static HTML, safe)
    - Use `$('#alert-container').html('').append($alert)` to clear then append safely
    - Use jQuery DOM construction for the body fallback container

    **Also audit other .html() calls in the file:**
    - Line 374: `$('#alert-container').html(alert)` in portfolio delete success — `alert` is a static template literal with NO dynamic data (hardcoded "Portfolio file deleted successfully") — SAFE, leave as-is
    - Line 391: `$('#alert-container').html(alert)` in portfolio delete error — `alert` is static ("An error occurred while deleting the file") — SAFE, leave as-is
    - Line 507: `$button.html(...)` — hardcoded "Deleting..." — SAFE, leave as-is
    - Line 535, 540: `$button.html(originalButtonText)` — restoring original button content — SAFE, leave as-is

    Note: Line 381 (`$('#alert-container').html($alert)`) in the portfolio error handler already uses `.text()` for dynamic content — this is the correct pattern.
  </action>
  <verify>
    - Grep `learners-app.js` for the showAlert function — confirm it uses `.text(message)` not `${message}` in HTML string
    - Grep for `\.html\(` calls — verify none inject `${...}` with server-provided data
    - No syntax errors — open file and verify JS structure is valid (matching braces, no orphaned code)
  </verify>
  <done>
    showAlert function uses `.text()` for message content. No `.html()` call in the file injects server-provided dynamic data via template literal interpolation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean phantom fields from baseline doc and remove legacy view file (LRNR-03, LRNR-10)</name>
  <files>
    docs/FORM-FIELDS-REFERENCE.md
    .integrate/wecoza-learners-plugin/views/learner-form.view.php
  </files>
  <action>
    **IMPORTANT:** Read 31-01-SUMMARY.md first. Only apply fixes for items classified as "needs-fix".

    **LRNR-03: Clean phantom fields from baseline doc**

    Read `docs/FORM-FIELDS-REFERENCE.md` and find entries for:
    - `date_of_birth` — if present in the Learners section, remove the table row
    - `suburb` — if present in the Learners section (NOT the Clients/Locations section), remove the table row

    Note: `suburb` entries in the Clients and Locations sections are legitimate and must NOT be removed. Only remove learner-specific phantom entries.

    Also verify: `LearnerRepository::getAllowedInsertColumns()` does NOT contain `suburb`. If it does, remove it. (Research suggests it's already clean.)

    **LRNR-10: Remove legacy view file**

    First, grep ALL PHP files in the plugin for references to `learner-form.view.php`:
    ```bash
    grep -r "learner-form.view.php" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/ --include="*.php"
    ```

    If NO references found (expected): Delete the file:
    ```bash
    rm .integrate/wecoza-learners-plugin/views/learner-form.view.php
    ```

    If references ARE found: Do NOT delete. Document the references in the SUMMARY and flag for user decision.

    **Verify LRNR-10 dead code in JS (already removed per research):**
    - Grep `learners-app.js` for `populateEditForm` — confirm absent
    - Grep `learners-app.js` for `editLearnerForm` — confirm absent
    - If either is found, remove the dead code blocks

    **Verify LRNR-10 dead code in Controller:**
    - Read `LearnerController::registerHooks()` — confirm it only registers shortcodes (no unused AJAX actions)
    - If it registers AJAX actions like `wecoza_get_learner`, `wecoza_update_learner`, etc. that have no JS callers, remove those registrations
  </action>
  <verify>
    - Grep `FORM-FIELDS-REFERENCE.md` for `date_of_birth` in Learners context → 0 matches (or confirm not present)
    - Legacy view file `.integrate/wecoza-learners-plugin/views/learner-form.view.php` no longer exists
    - Grep for `populateEditForm` in all JS files → 0 matches
    - Grep for `editLearnerForm` in all JS files → 0 matches
    - Grep for `learner-form.view.php` in all PHP files → 0 matches
  </verify>
  <done>
    Phantom field entries removed from baseline doc. Legacy view file deleted. All dead code targets confirmed absent or removed. Repository insert whitelist clean (no `suburb`).
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification — grep-based regression check across all 10 LRNR requirements</name>
  <files></files>
  <action>
    Run a comprehensive grep-based verification across all 10 LRNR requirements to confirm everything is in order:

    ```bash
    # LRNR-01: numeracy_level in update shortcode
    grep -n "numeracy_level" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-02: sponsors POST processing exists
    grep -n "sponsors" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "sponsors" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-03: suburb NOT in insert whitelist
    grep -n "suburb" src/Learners/Repositories/LearnerRepository.php

    # LRNR-04: only 1 placement_assessment_date field in create form
    grep -c 'name="placement_assessment_date"' src/Learners/Shortcodes/learners-capture-shortcode.php

    # LRNR-05: no nopriv in Learners module
    grep -r "nopriv" src/Learners/ --include="*.php"

    # LRNR-06: correct employment_status comparison
    grep -n "employment_status.*Employed" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-07: intval for highest_qualification in BOTH shortcodes
    grep -n "highest_qualification" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "highest_qualification" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-08: DateTime validation for placement_assessment_date
    grep -n "createFromFormat" src/Learners/Shortcodes/learners-capture-shortcode.php
    grep -n "createFromFormat" src/Learners/Shortcodes/learners-update-shortcode.php

    # LRNR-09: no unsafe .html() with template literal + server data
    grep -n "\.html(" assets/js/learners/learners-app.js

    # LRNR-10: no dead code
    grep -r "populateEditForm" assets/js/ --include="*.js"
    grep -r "editLearnerForm" assets/js/ --include="*.js"
    ls .integrate/wecoza-learners-plugin/views/learner-form.view.php 2>/dev/null
    ```

    Document each result in the SUMMARY. All checks must pass. If any check fails, investigate and fix before marking task complete.

    **ASK USER if any unexpected issues are found** — do not silently fix things outside the LRNR-01 through LRNR-10 scope.
  </action>
  <verify>
    All 10 grep checks pass:
    - LRNR-01: numeracy_level present in update shortcode POST array
    - LRNR-02: sponsors processing present in both shortcodes
    - LRNR-03: suburb only appears in SELECT JOIN, not in insert whitelist
    - LRNR-04: exactly 1 placement_assessment_date input field in create form
    - LRNR-05: 0 nopriv matches in src/Learners/
    - LRNR-06: comparison uses !== 'Employed' (correct string comparison)
    - LRNR-07: both shortcodes use intval() for highest_qualification
    - LRNR-08: both shortcodes use DateTime::createFromFormat
    - LRNR-09: no .html() with ${...} server data interpolation
    - LRNR-10: no dead code references, no legacy view file
  </verify>
  <done>
    All 10 LRNR requirements verified as resolved. No regressions detected. Phase 31 success criteria met.
  </done>
</task>

</tasks>

<verification>
- [ ] LRNR-09 XSS risk patched — showAlert uses .text() for dynamic content
- [ ] LRNR-03 phantom fields removed from baseline doc
- [ ] LRNR-10 legacy view file deleted
- [ ] All 10 requirements pass grep-based verification
- [ ] No regressions — existing learner CRUD paths unaffected
</verification>

<success_criteria>
1. No XSS risk from .html() with server data in learners-app.js
2. FORM-FIELDS-REFERENCE.md has no phantom learner fields
3. Legacy learner-form.view.php deleted
4. All 10 LRNR requirements verified as resolved via automated checks
5. No files outside the scope modified
</success_criteria>

<output>
After completion, create `.planning/phases/31-learners-module-fixes/31-02-SUMMARY.md`
</output>
