---
phase: 46-learner-progression-report
plan: 03
type: execute
wave: 2
depends_on: [46-01, 46-02]
files_modified:
  - assets/js/learners/progression-report.js
autonomous: true
requirements: [RPT-01, RPT-02, RPT-03, RPT-04, RPT-05]

must_haves:
  truths:
    - "Admin types in search box, clicks search, and report filters to matching learners"
    - "Admin selects employer from dropdown, clicks search, and report shows only that employer's learners"
    - "Summary cards update with real data from the server on every search/filter"
    - "Each company group shows as expandable accordion with learner count badge"
    - "Expanding a learner row reveals a chronological timeline of LP entries with status, dates, hours, class"
    - "Status pills filter the visible results without a new server request"
  artifacts:
    - path: "assets/js/learners/progression-report.js"
      provides: "Full report interactivity module"
      min_lines: 150
  key_links:
    - from: "assets/js/learners/progression-report.js"
      to: "/wp-admin/admin-ajax.php?action=get_progression_report"
      via: "jQuery.ajax GET"
      pattern: "action.*get_progression_report"
    - from: "assets/js/learners/progression-report.js"
      to: "views/learners/progression-report.php"
      via: "DOM IDs: stat-total-learners, report-results, report-search, report-employer-filter"
      pattern: "#stat-total-learners|#report-results|#report-search"
---

<objective>
Wire the progression report view with JavaScript for search, filter, summary card population, and timeline rendering.

Purpose: Make the report interactive -- admin searches by name/ID, filters by employer, sees live summary cards, and expands company groups to view individual learner LP timelines.
Output: `progression-report.js` fully wiring the view from Plan 02 to the AJAX endpoint from Plan 01.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/46-learner-progression-report/46-01-SUMMARY.md
@.planning/phases/46-learner-progression-report/46-02-SUMMARY.md
@assets/js/learners/progression-admin.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progression-report.js core module</name>
  <files>assets/js/learners/progression-report.js</files>
  <action>
Create `assets/js/learners/progression-report.js` as a jQuery IIFE module (matches progression-admin.js pattern). Structure:

**Module variables:**
- `currentData = null` -- cached last server response for client-side status filtering
- `currentStatusFilter = ''` -- active status pill value

**init()** -- called on document.ready:
1. Bind event handlers:
   - `#btn-report-search` click -> fetchReport()
   - `#report-search` keypress Enter -> fetchReport()
   - `#report-status-pills button` click -> set currentStatusFilter, toggle active class, call renderResults() from cache (no server round-trip)
2. Populate employer dropdown from initial fetch (call fetchReport() with no filters on load to populate dropdown + show all data)

**fetchReport()** -- AJAX GET to `get_progression_report`:
1. Collect filters: search from `#report-search`.val().trim(), employer_id from `#report-employer-filter`.val(), status from currentStatusFilter.
2. Show loading spinner (`#report-loading`), hide content (`#report-content`).
3. jQuery.ajax GET to progressionReportAjax.ajaxurl with action=get_progression_report, nonce, and filter params.
4. On success:
   - Cache response.data in currentData
   - Call updateSummaryCards(response.data.summary)
   - Call populateEmployerDropdown(response.data.groups) -- only on first call (guard with flag)
   - Call renderResults()
   - Hide loading, show content
5. On error: showToast('Failed to load report data', 'danger')

**updateSummaryCards(summary):**
- `#stat-total-learners`.text(summary.total_learners)
- `#stat-completion-rate`.text(Math.round(summary.completion_rate))
- `#stat-avg-progress`.text(Math.round(summary.avg_progress))
- `#stat-active-lps`.text(summary.in_progress_count)

**populateEmployerDropdown(groups):**
- Extract unique client_name/client_id pairs from groups array
- Sort alphabetically by client_name
- Append `<option value="{client_id}">{client_name}</option>` to `#report-employer-filter`
- Skip if already populated (check `#report-employer-filter option` length > 1)

**renderResults():**
- Read currentData.groups
- If currentStatusFilter is set, deep-filter: for each group, for each learner, keep only progressions matching status. Remove learners with no remaining progressions. Remove groups with no remaining learners.
- If no results after filtering, show `#report-empty`, hide `#report-results`, return.
- Hide `#report-empty`, build accordion HTML:

For each group (company):
```html
<div class="card shadow-none border mb-2">
  <div class="card-header p-2 cursor-pointer" data-bs-toggle="collapse" data-bs-target="#company-{clientId}">
    <div class="d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="bi bi-building me-2"></i>{clientName}</h6>
      <span class="badge badge-phoenix badge-phoenix-secondary">{learnerCount} learner(s)</span>
    </div>
  </div>
  <div id="company-{clientId}" class="collapse show">
    <div class="card-body p-0">
      {for each learner: renderLearnerRow(learner)}
    </div>
  </div>
</div>
```

**renderLearnerRow(learner):**
```html
<div class="border-bottom">
  <div class="p-2 px-3 d-flex justify-content-between align-items-center cursor-pointer"
       data-bs-toggle="collapse" data-bs-target="#learner-timeline-{learnerId}">
    <span class="fw-semibold">{learnerName}</span>
    <span class="text-muted fs-9">ID: {learnerId} &middot; {progressionCount} LP(s)</span>
  </div>
  <div id="learner-timeline-{learnerId}" class="collapse">
    <div class="px-3 pb-3">
      {renderTimeline(learner.progressions)}
    </div>
  </div>
</div>
```

**renderTimeline(progressions):**
Build a Phoenix-style timeline (timeline-basic pattern from Phoenix theme):
```html
<div class="timeline-basic">
  {for each progression, sorted by start_date DESC:}
  <div class="timeline-item">
    <div class="row g-2">
      <div class="col-auto">
        <div class="timeline-item-bar position-relative">
          <div class="icon-item icon-item-sm rounded-7 border border-translucent">
            <span class="bi {statusIcon(status)} {statusColor(status)} fs-9"></span>
          </div>
          <span class="timeline-bar border-end border-dashed"></span>
        </div>
      </div>
      <div class="col">
        <div class="d-flex justify-content-between mb-1">
          <h6 class="fs-9 mb-0">{product_name}</h6>
          <span class="badge badge-phoenix badge-phoenix-{statusBadgeClass(status)} fs-10">{statusLabel(status)}</span>
        </div>
        <div class="fs-10 text-muted">
          <span>Class: {class_code || 'N/A'}</span>
          <span class="mx-1">&middot;</span>
          <span>{start_date}{completion_date ? ' - ' + completion_date : ' - present'}</span>
          <span class="mx-1">&middot;</span>
          <span>Hours: {hours_present}/{product_duration || '?'}</span>
        </div>
        {if progress bar applicable (not completed):}
        <div class="progress mt-1" style="height: 4px;">
          <div class="progress-bar bg-primary" style="width: {progressPct}%"></div>
        </div>
      </div>
    </div>
  </div>
</div>
```

**Helper functions** (reuse statusBadgeClass/statusLabel pattern from progression-admin.js):
- `statusBadgeClass(status)`: in_progress->primary, completed->success, on_hold->warning
- `statusLabel(status)`: in_progress->'In Progress', completed->'Completed', on_hold->'On Hold'
- `statusIcon(status)`: in_progress->'bi-play-circle', completed->'bi-check-circle', on_hold->'bi-pause-circle'
- `statusColor(status)`: in_progress->'text-primary', completed->'text-success', on_hold->'text-warning'

**showToast(message, type):** Same auto-dismiss pattern as progression-admin.js -- append alert to `#report-alert`, auto-remove after 4 seconds.
  </action>
  <verify>
1. File exists at assets/js/learners/progression-report.js
2. grep "get_progression_report" assets/js/learners/progression-report.js confirms AJAX action reference
3. grep "stat-total-learners\|report-results\|report-search" assets/js/learners/progression-report.js confirms DOM wiring
  </verify>
  <done>
progression-report.js exists with: fetchReport() calling get_progression_report AJAX endpoint, updateSummaryCards() populating the four stat spans, populateEmployerDropdown() filling the filter, renderResults() building company-grouped accordion with expandable learner rows, renderTimeline() showing Phoenix timeline items with status icons/badges/progress bars, and client-side status pill filtering from cached data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add timeline CSS to ydcoza-styles.css if needed</name>
  <files>/opt/lampp/htdocs/wecoza/wp-content/themes/wecoza_3_child_theme/includes/css/ydcoza-styles.css</files>
  <action>
Check if Phoenix timeline CSS classes are already available in the theme. Search for `.timeline-basic`, `.timeline-item`, `.timeline-item-bar`, `.timeline-bar` in existing CSS files.

If NOT present, append minimal timeline styles to ydcoza-styles.css:

```css
/* Learner Progression Report - Timeline */
.timeline-basic .timeline-item { position: relative; }
.timeline-basic .timeline-item-bar { display: flex; flex-direction: column; align-items: center; }
.timeline-basic .timeline-bar { flex: 1; min-height: 20px; }
.timeline-basic .timeline-item:last-child .timeline-bar { display: none; }
.cursor-pointer { cursor: pointer; }
```

If `.timeline-basic` classes are already present in Phoenix CSS, skip this task entirely -- no custom CSS needed.

Also check if `.cursor-pointer` is already defined. Only add if missing.
  </action>
  <verify>
The timeline renders correctly with vertical connecting lines between entries. Check Phoenix CSS files first before adding anything.
  </verify>
  <done>
Timeline CSS classes are available (either from Phoenix theme or minimal addition to ydcoza-styles.css). cursor-pointer utility exists.
  </done>
</task>

</tasks>

<verification>
1. progression-report.js loads without JS errors
2. On page load, initial fetch populates summary cards and employer dropdown
3. Typing a name in search and clicking Search filters results
4. Selecting an employer from dropdown filters results
5. Clicking status pills filters results client-side from cached data
6. Company groups show as expandable accordion sections
7. Expanding a learner row shows chronological timeline with status icons, badges, dates, hours
</verification>

<success_criteria>
- Admin can search by learner name/ID and see filtered results instantly
- Admin can filter by employer and see only that company's learners
- Summary cards show real totals, completion rate, avg progress, active LPs
- Company groups are expandable with learner count badges
- Individual learner timelines show LP progression with status, dates, hours, progress bar
- Status pills filter results client-side without a new server request
</success_criteria>

<output>
After completion, create `.planning/phases/46-learner-progression-report/46-03-SUMMARY.md`
</output>
