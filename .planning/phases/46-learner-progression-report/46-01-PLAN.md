---
phase: 46-learner-progression-report
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Ajax/ProgressionAjaxHandlers.php
  - src/Learners/Repositories/LearnerProgressionRepository.php
autonomous: true
requirements: [RPT-01, RPT-02, RPT-03, RPT-04, RPT-05]

must_haves:
  truths:
    - "AJAX endpoint returns learner progressions filtered by search term (name or ID)"
    - "AJAX endpoint returns learner progressions filtered by employer"
    - "Response includes per-learner timeline data (LP name, class code, dates, hours, status)"
    - "Response includes summary statistics (total learners, completion rate, avg progress, active LPs)"
    - "Multi-learner results are grouped by employer name"
  artifacts:
    - path: "src/Learners/Repositories/LearnerProgressionRepository.php"
      provides: "Report query methods"
      contains: "findForReport"
    - path: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      provides: "Report AJAX handler"
      contains: "handle_get_progression_report"
  key_links:
    - from: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      to: "src/Learners/Repositories/LearnerProgressionRepository.php"
      via: "findForReport() and getReportSummaryStats()"
      pattern: "repository->findForReport|repository->getReportSummaryStats"
---

<objective>
Add backend AJAX endpoint and repository methods for the learner progression report page.

Purpose: Provide data layer for WEC-165 report -- search by learner name/ID, filter by employer, return grouped timeline data with summary statistics.
Output: Two new repository methods + one AJAX handler registered on `get_progression_report` action.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/Learners/Repositories/LearnerProgressionRepository.php
@src/Learners/Ajax/ProgressionAjaxHandlers.php
@src/Learners/Services/ProgressionService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add report query methods to LearnerProgressionRepository</name>
  <files>src/Learners/Repositories/LearnerProgressionRepository.php</files>
  <action>
Add two new methods to LearnerProgressionRepository:

1. `findForReport(array $filters = []): array` -- Fetches progression data for the report page. SQL is a 5-table JOIN: learner_lp_tracking + products + learners + classes + employers (via learners.employer_id = employers.employer_id). Returns all progressions matching filters, ordered by employer_name, learner surname, start_date DESC.

Filters supported:
- `search` (string): Match against CONCAT(l.first_name, ' ', l.surname) ILIKE or l.id = intval(search) if numeric
- `employer_id` (int): Match l.employer_id
- `status` (string): Match lpt.status

SELECT columns: lpt.*, p.product_name, p.product_duration, CONCAT(l.first_name, ' ', l.surname) AS learner_name, l.id AS learner_id, c.class_code, emp.employer_name, emp.employer_id

The JOIN for employers is: LEFT JOIN employers emp ON l.employer_id = emp.employer_id (through learners table, NOT through classes).

Use parameterized queries with PDO::PARAM_INT/PARAM_STR binding. No LIMIT/OFFSET -- report loads all matching rows (the search/filter narrows the dataset).

2. `getReportSummaryStats(array $filters = []): array` -- Same filter logic as findForReport but returns aggregate stats:
- `total_learners`: COUNT(DISTINCT lpt.learner_id)
- `total_progressions`: COUNT(*)
- `completed_count`: COUNT(*) WHERE status = 'completed'
- `in_progress_count`: COUNT(*) WHERE status = 'in_progress'
- `on_hold_count`: COUNT(*) WHERE status = 'on_hold'
- `avg_progress`: AVG of (hours_present / product_duration * 100) for non-completed, capped at 100
- `completion_rate`: completed_count / total_progressions * 100

Use conditional aggregation (COUNT(*) FILTER (WHERE ...)) for PostgreSQL efficiency. Apply same JOIN and WHERE as findForReport.

Both methods follow existing error handling pattern: try/catch with error_log and return empty array / zeroed stats on failure.
  </action>
  <verify>
grep -n "findForReport\|getReportSummaryStats" src/Learners/Repositories/LearnerProgressionRepository.php should show both new methods.
  </verify>
  <done>
Two new repository methods exist: findForReport returns filtered progression rows with learner/product/class/employer JOINs, getReportSummaryStats returns aggregate counts and rates using the same filter criteria.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add progression report AJAX handler and register it</name>
  <files>src/Learners/Ajax/ProgressionAjaxHandlers.php</files>
  <action>
Add `handle_get_progression_report()` function to ProgressionAjaxHandlers.php:

1. Call `verify_learner_access('learners_nonce')` then check `manage_options` capability (matches admin handler pattern from Phase 45).

2. Build filters from $_GET:
   - `search`: sanitize_text_field($_GET['search']) if non-empty
   - `employer_id`: intval($_GET['employer_id']) if non-empty
   - `status`: sanitize_key, validated against ['in_progress', 'completed', 'on_hold']

3. Instantiate LearnerProgressionRepository directly (no service needed -- this is a pure data query, follows the pattern of handle_get_progression_hours_log which also calls repository directly).

4. Call `$repository->findForReport($filters)` and `$repository->getReportSummaryStats($filters)`.

5. Group the flat results by `employer_id` into a structure:
   ```php
   $grouped = [];
   foreach ($data as $row) {
       $employerId = $row['employer_id'] ?? 0;
       $employerName = $row['employer_name'] ?? 'Unassigned';
       if (!isset($grouped[$employerId])) {
           $grouped[$employerId] = [
               'employer_id' => $employerId,
               'employer_name' => $employerName,
               'learners' => [],
           ];
       }
       $learnerId = $row['learner_id'];
       if (!isset($grouped[$employerId]['learners'][$learnerId])) {
           $grouped[$employerId]['learners'][$learnerId] = [
               'learner_id' => $learnerId,
               'learner_name' => $row['learner_name'],
               'progressions' => [],
           ];
       }
       $grouped[$employerId]['learners'][$learnerId]['progressions'][] = $row;
   }
   // Re-index learners arrays
   foreach ($grouped as &$group) {
       $group['learners'] = array_values($group['learners']);
   }
   $grouped = array_values($grouped);
   ```

6. Return with wp_send_json_success:
   ```php
   [
       'groups' => $grouped,
       'summary' => $stats,
   ]
   ```

7. Register in `register_progression_ajax_handlers()`:
   `add_action('wp_ajax_get_progression_report', __NAMESPACE__ . '\handle_get_progression_report');`

Add `use` statement for LearnerProgressionRepository at top if not already present (it IS already imported -- verify before adding duplicate).
  </action>
  <verify>
grep -n "get_progression_report" src/Learners/Ajax/ProgressionAjaxHandlers.php should show both the handler function and the add_action registration.
  </verify>
  <done>
AJAX handler `handle_get_progression_report` exists, accepts search/employer_id/status filters via GET, returns grouped learner data by employer plus summary stats, and is registered on the `get_progression_report` action.
  </done>
</task>

</tasks>

<verification>
1. Both repository methods use parameterized queries (no SQL injection)
2. AJAX handler validates nonce and checks manage_options
3. Response structure groups learners by employer
4. Summary stats include total_learners, completion_rate, avg_progress, in_progress_count
5. Registration line appears in register_progression_ajax_handlers()
</verification>

<success_criteria>
- `get_progression_report` AJAX action is registered and callable
- Passing `search=John` filters to learners named John
- Passing `employer_id=5` filters to learners at that employer
- Response includes `groups` (employer-grouped) and `summary` (aggregate stats)
</success_criteria>

<output>
After completion, create `.planning/phases/46-learner-progression-report/46-01-SUMMARY.md`
</output>
