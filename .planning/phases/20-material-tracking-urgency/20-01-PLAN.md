---
phase: 20-material-tracking-urgency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Views/Presenters/MaterialTrackingPresenter.php
  - views/events/material-tracking/list-item.php
  - views/events/material-tracking/dashboard.php
  - /opt/lampp/htdocs/wecoza/wp-content/themes/wecoza_3_child_theme/includes/css/ydcoza-styles.css
autonomous: true

must_haves:
  truths:
    - "Pending rows with delivery date today or past show a red left border"
    - "Pending rows with delivery date 1-3 days away show an orange left border"
    - "Pending rows with delivery date 4+ days away show no left border"
    - "Completed/delivered rows never show an urgency border"
    - "Marking a row as delivered via checkbox removes the urgency border immediately"
    - "Borders use Phoenix theme color variables, not hardcoded hex"
  artifacts:
    - path: "src/Events/Views/Presenters/MaterialTrackingPresenter.php"
      provides: "Urgency tier calculation and urgency_class field in presented records"
      contains: "calculateUrgency"
    - path: "views/events/material-tracking/list-item.php"
      provides: "Urgency CSS class applied to table row"
      contains: "urgency_class"
    - path: "views/events/material-tracking/dashboard.php"
      provides: "JS removes urgency classes on mark-as-delivered success"
      contains: "urgency-overdue"
    - path: "/opt/lampp/htdocs/wecoza/wp-content/themes/wecoza_3_child_theme/includes/css/ydcoza-styles.css"
      provides: "CSS rules for urgency-overdue and urgency-approaching borders"
      contains: "urgency-overdue"
  key_links:
    - from: "src/Events/Views/Presenters/MaterialTrackingPresenter.php"
      to: "views/events/material-tracking/list-item.php"
      via: "urgency_class field in presented record array"
      pattern: "urgency_class"
    - from: "views/events/material-tracking/list-item.php"
      to: "ydcoza-styles.css"
      via: "CSS class on tr element"
      pattern: "urgency-overdue|urgency-approaching"
    - from: "views/events/material-tracking/dashboard.php"
      to: "list-item.php tr classes"
      via: "JS removeClass on AJAX success"
      pattern: "removeClass.*urgency"
---

<objective>
Add visual urgency indicators (color-coded left borders) to material tracking table rows based on delivery date proximity.

Purpose: Let users instantly see which pending deliveries are overdue (red) or approaching (orange) without reading dates.
Output: Two-tier urgency borders on pending delivery rows using Phoenix theme colors.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/20-material-tracking-urgency/20-CONTEXT.md
@.planning/phases/20-material-tracking-urgency/20-RESEARCH.md
@src/Events/Views/Presenters/MaterialTrackingPresenter.php
@views/events/material-tracking/list-item.php
@views/events/material-tracking/dashboard.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add urgency calculation to presenter, apply class in view, and handle JS cleanup</name>
  <files>
    src/Events/Views/Presenters/MaterialTrackingPresenter.php
    views/events/material-tracking/list-item.php
    views/events/material-tracking/dashboard.php
  </files>
  <action>
**MaterialTrackingPresenter.php** — Two changes:

1. Add private method `calculateUrgency(string $eventDate, string $eventStatus): string` that:
   - Returns `''` (empty string) if `$eventStatus` is not `'pending'` (non-pending rows never get urgency)
   - Returns `''` if `$eventDate` is empty or `strtotime($eventDate)` is `false` (invalid date guard)
   - Computes days until delivery: `$daysUntil = (int) ((strtotime($eventDate) - strtotime(gmdate('Y-m-d'))) / 86400)`
   - Uses `match(true)` expression:
     - `$daysUntil <= 0` => `'urgency-overdue'` (today or past = red)
     - `$daysUntil <= 3` => `'urgency-approaching'` (1-3 days = orange)
     - `default` => `''` (4+ days = no border)
   - Add PHPDoc: `@param string $eventDate Raw date string from event_dates` / `@param string $eventStatus Lowercased event status` / `@return string CSS class name or empty string`

2. In `presentRecords()`, refactor to DRY: extract `$eventStatus = strtolower((string) ($record['event_status'] ?? 'pending'));` as a local variable BEFORE the array construction. Use `$eventStatus` for: `'event_status'`, `'status_badge_html'`, `'delivery_status'`, and the new `'urgency_class'`. Add `'urgency_class' => $this->calculateUrgency((string) ($record['event_date'] ?? ''), $eventStatus),` after the `'delivery_status'` line. Pass raw date (before formatting).

**list-item.php** — One change:

On the opening `<tr>` tag (currently line 21), add the urgency class. Change from:
```php
<tr data-status="<?php echo esc_attr($record['delivery_status']); ?>"
```
to:
```php
<tr class="<?php echo esc_attr($record['urgency_class'] ?? ''); ?>" data-status="<?php echo esc_attr($record['delivery_status']); ?>"
```

Empty string produces `class=""` which has no visual effect — safe default.

**dashboard.php** — One small JS change:

In the mark-as-delivered AJAX success callback (inside `if (response.success)`), AFTER the line `row.data('status', 'delivered');` (around line 383), add:
```javascript
row.removeClass('urgency-overdue urgency-approaching');
```

This ensures that when a user marks a delivery as completed via the checkbox, the urgency border is removed immediately without waiting for a page reload.
  </action>
  <verify>
    1. Open MaterialTrackingPresenter.php — confirm `calculateUrgency()` method exists with `match(true)` returning correct CSS class strings
    2. Confirm `urgency_class` key exists in `presentRecords()` output array
    3. Confirm DRY refactor: `$eventStatus` local variable used in 4 places (no repeated `strtolower(...)` calls)
    4. Open list-item.php — confirm `<tr>` has dynamic `class` attribute using `$record['urgency_class']`
    5. Open dashboard.php — confirm `removeClass('urgency-overdue urgency-approaching')` exists in AJAX success handler
    6. Load the material tracking page — no PHP errors in debug.log, no JS console errors
  </verify>
  <done>
    Presenter computes urgency tier for each record. View template applies CSS class to table rows. JS removes urgency class on mark-as-delivered. No PHP/JS errors. Page loads normally.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add urgency border CSS rules using Phoenix color variables</name>
  <files>
    /opt/lampp/htdocs/wecoza/wp-content/themes/wecoza_3_child_theme/includes/css/ydcoza-styles.css
  </files>
  <action>
Append the following CSS rules to the END of `ydcoza-styles.css`. Use high-specificity selectors scoped to the material tracking table to avoid conflicts with other urgency styles already in the file.

```css
/* -------------------------------------------------------------------------- */
/* Material Tracking Urgency Indicators (Phase 20)                            */
/* -------------------------------------------------------------------------- */
/* Two-tier system: red = overdue/today, orange = 1-3 days away               */
/* Only applied to pending rows via PHP presenter                             */

#material-tracking-table tbody tr.urgency-overdue {
  border-left: 3px solid var(--phoenix-danger);
}

#material-tracking-table tbody tr.urgency-approaching {
  border-left: 3px solid var(--phoenix-warning);
}
```

Key constraints (per user decisions):
- 3px solid left border (user specified 3px)
- No background tint — border only
- Uses `var(--phoenix-danger)` (#fa3b1d) and `var(--phoenix-warning)` (#e5780b) — already defined in `:root` at top of this file
- No green tier — two-tier system only (red + orange)
- Scoped to `#material-tracking-table` to prevent bleed to other tables
  </action>
  <verify>
    1. Confirm the two CSS rules are appended to ydcoza-styles.css
    2. Confirm selectors use `#material-tracking-table tbody tr.urgency-*` pattern
    3. Confirm border uses `var(--phoenix-danger)` and `var(--phoenix-warning)` — not hardcoded hex
    4. Load material tracking page — pending rows with past/today dates show red left border, rows 1-3 days out show orange border, rows 4+ days out have no border, completed rows have no border
  </verify>
  <done>
    Red and orange left borders visible on appropriate pending rows. No borders on comfortable or completed rows. Colors match Phoenix theme variables.
  </done>
</task>

</tasks>

<verification>
1. Navigate to the Material Delivery Tracking page
2. Identify a pending row with a delivery date in the past or today — should have a red (3px) left border
3. Identify a pending row with a delivery date 1-3 days away — should have an orange (3px) left border
4. Identify a pending row with a delivery date 4+ days away — should have NO left border
5. Identify a completed/delivered row — should have NO left border regardless of date
6. Mark a pending overdue row as delivered via checkbox — red border should disappear immediately
7. Check that the PENDING badge text/style is unchanged
8. Check that delivery date text color is unchanged
9. Verify no PHP errors in debug.log
10. Verify borders use theme colors (inspect element should show `var(--phoenix-danger)` / `var(--phoenix-warning)`)
</verification>

<success_criteria>
- Overdue pending rows (today or past) display red left border
- Approaching pending rows (1-3 days) display orange left border
- Comfortable pending rows (4+ days) display no border
- Non-pending rows (completed/delivered) display no border regardless of date
- Marking as delivered removes urgency border immediately via JS
- Borders are 3px solid using Phoenix CSS variables
- No delivery date text color changes
- No OVERDUE badge — border is the sole urgency indicator
- No PHP errors, page loads normally
</success_criteria>

<output>
After completion, create `.planning/phases/20-material-tracking-urgency/20-01-SUMMARY.md`
</output>
