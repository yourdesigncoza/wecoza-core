---
phase: 19-material-tracking-dashboard-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Repositories/MaterialTrackingRepository.php
  - src/Events/Services/MaterialTrackingDashboardService.php
autonomous: true

must_haves:
  truths:
    - "Repository fetches Deliveries events from classes.event_dates JSONB as primary data source"
    - "Repository LEFT JOINs class_material_tracking for supplementary cron notification data"
    - "Statistics count delivery events from event_dates (total, pending, completed)"
    - "Existing cron methods (markNotificationSent, wasNotificationSent) remain unchanged"
    - "Service filters by event status (pending/completed) instead of cron delivery_status"
  artifacts:
    - path: "src/Events/Repositories/MaterialTrackingRepository.php"
      provides: "JSONB query for Deliveries events with cron data join"
      contains: "jsonb_array_elements"
    - path: "src/Events/Services/MaterialTrackingDashboardService.php"
      provides: "Updated filter logic for event-based data"
      contains: "getDashboardData"
  key_links:
    - from: "MaterialTrackingRepository::getTrackingDashboardData"
      to: "classes.event_dates JSONB"
      via: "CROSS JOIN LATERAL jsonb_array_elements"
      pattern: "jsonb_array_elements.*COALESCE.*event_dates"
    - from: "MaterialTrackingRepository::getTrackingStatistics"
      to: "classes.event_dates JSONB"
      via: "CROSS JOIN LATERAL with status aggregation"
      pattern: "elem.*status.*Deliveries"
    - from: "MaterialTrackingDashboardService::getDashboardData"
      to: "MaterialTrackingRepository::getTrackingDashboardData"
      via: "method call with filters"
      pattern: "repository->getTrackingDashboardData"
---

<objective>
Rewrite the Material Tracking data layer to query `classes.event_dates` JSONB for Deliveries-type events as the primary data source, with `class_material_tracking` cron records as supplementary info via LEFT JOIN.

Purpose: The dashboard currently shows 0 records because it only queries cron-created records. This plan switches the primary data source to user-entered Deliveries events stored in event_dates JSONB.

Output: Updated repository with JSONB queries and updated service with new filter logic. Existing cron methods preserved untouched.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-material-tracking-dashboard-fix/19-RESEARCH.md

# Key reference files:
@src/Events/Repositories/MaterialTrackingRepository.php
@src/Events/Services/MaterialTrackingDashboardService.php
@src/Events/Repositories/ClassTaskRepository.php â€” JSONB query pattern reference
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite MaterialTrackingRepository JSONB queries</name>
  <files>src/Events/Repositories/MaterialTrackingRepository.php</files>
  <action>
Rewrite `getTrackingDashboardData()` and `getTrackingStatistics()` methods to query `classes.event_dates` JSONB. Keep ALL existing cron methods unchanged (`markNotificationSent`, `wasNotificationSent`, `getDeliveryStatus`, `getTrackingRecords`, `markDelivered`).

**`getTrackingDashboardData()` rewrite:**

Change method signature to:
```php
public function getTrackingDashboardData(
    int $limit = 50,
    ?string $status = null,
    ?string $search = null
): array
```

Remove `$notificationType` and `$daysRange` params (no longer needed -- events don't have a time window, they exist permanently).

New SQL query pattern (adapted from ClassTaskRepository JSONB pattern):
```sql
SELECT
    c.class_id,
    c.class_code,
    c.class_subject,
    c.original_start_date,
    cl.client_name,
    s.site_name,
    elem->>'type' as event_type,
    elem->>'description' as event_description,
    elem->>'date' as event_date,
    elem->>'status' as event_status,
    elem->>'notes' as event_notes,
    elem->>'completed_by' as event_completed_by,
    elem->>'completed_at' as event_completed_at,
    (elem_index - 1) as event_index,
    cmt.notification_type,
    cmt.notification_sent_at
FROM classes c
LEFT JOIN clients cl ON c.client_id = cl.client_id
LEFT JOIN sites s ON c.site_id = s.site_id
CROSS JOIN LATERAL jsonb_array_elements(COALESCE(c.event_dates, '[]'::jsonb))
    WITH ORDINALITY AS events(elem, elem_index)
LEFT JOIN class_material_tracking cmt ON cmt.class_id = c.class_id
WHERE elem->>'type' = 'Deliveries'
```

Add dynamic WHERE conditions:
- If `$status` is not null: Add `AND LOWER(elem->>'status') = :status` (use lowercase comparison: 'pending' or 'completed')
- If `$search` is not null: Add `AND (c.class_code ILIKE :search OR c.class_subject ILIKE :search OR cl.client_name ILIKE :search)` (wrap search value with `%` on both sides)

ORDER BY: `CASE LOWER(elem->>'status') WHEN 'pending' THEN 1 WHEN 'completed' THEN 2 ELSE 3 END, c.original_start_date DESC NULLS LAST, c.class_code`

Add `LIMIT :limit` at end.

Use PDO prepared statements with `bindValue()` for all params.

**Important JSONB null safety:** Use `COALESCE(c.event_dates, '[]'::jsonb)` to handle classes where event_dates is NULL.

**Important case sensitivity:** Event type is stored as "Deliveries" with capital D. Status is stored as "Pending"/"Completed" with capital first letter.

**`getTrackingStatistics()` rewrite:**

Change method signature to remove `$daysRange` param:
```php
public function getTrackingStatistics(): array
```

New SQL:
```sql
SELECT
    COUNT(*) as total,
    COALESCE(SUM(CASE WHEN LOWER(elem->>'status') = 'pending' THEN 1 ELSE 0 END), 0) as pending,
    COALESCE(SUM(CASE WHEN LOWER(elem->>'status') = 'completed' THEN 1 ELSE 0 END), 0) as completed
FROM classes c
CROSS JOIN LATERAL jsonb_array_elements(COALESCE(c.event_dates, '[]'::jsonb)) AS events(elem)
WHERE elem->>'type' = 'Deliveries'
```

Return array with keys: `total`, `pending`, `completed` (no more `notified` key).

Return default `['total' => 0, 'pending' => 0, 'completed' => 0]` on failure.
  </action>
  <verify>
Read the updated file and verify:
1. `getTrackingDashboardData` uses `jsonb_array_elements(COALESCE(c.event_dates, '[]'::jsonb))`
2. `getTrackingStatistics` counts from event_dates, not class_material_tracking
3. Existing cron methods (`markNotificationSent`, `wasNotificationSent`, `getDeliveryStatus`, `getTrackingRecords`, `markDelivered`) are unchanged
4. LEFT JOIN to class_material_tracking preserves supplementary cron data
5. Status filter uses LOWER() for case-insensitive comparison
6. Search filter uses ILIKE for case-insensitive search
  </verify>
  <done>
Repository queries event_dates JSONB for Deliveries events as primary data source, LEFT JOINs cron table for supplementary notification info, and all existing cron methods remain untouched.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MaterialTrackingDashboardService filter logic</name>
  <files>src/Events/Services/MaterialTrackingDashboardService.php</files>
  <action>
Update `getDashboardData()` to match the new repository signature:

1. Change filter validation:
   - `status`: Allow values `pending`, `completed` (not `notified` -- that was cron-specific). Map `'delivered'` to `'completed'` for backward compatibility.
   - Add `search`: New string filter for class code/subject/client name search. Sanitize with `sanitize_text_field()`.
   - Remove `notification_type` filter (no longer a primary filter -- cron data is supplementary).
   - Remove `days_range` filter (events don't have time window).

2. Update method body:
```php
public function getDashboardData(array $filters = []): array
{
    $limit = isset($filters['limit']) ? (int) $filters['limit'] : 50;
    $limit = max(1, min(200, $limit));

    $status = $filters['status'] ?? null;
    if ($status !== null) {
        // Map old 'delivered' to new 'completed' for backward compat
        if ($status === 'delivered') {
            $status = 'completed';
        }
        if (!in_array($status, ['pending', 'completed'], true)) {
            $status = null;
        }
    }

    $search = isset($filters['search']) ? trim((string) $filters['search']) : null;
    if ($search === '') {
        $search = null;
    }

    return $this->repository->getTrackingDashboardData($limit, $status, $search);
}
```

3. Update `getStatistics()` to remove `$daysRange` param:
```php
public function getStatistics(): array
{
    return $this->repository->getTrackingStatistics();
}
```

Keep `canViewDashboard()`, `canManageMaterialTracking()`, and `markAsDelivered()` methods unchanged.
  </action>
  <verify>
Read the updated file and verify:
1. `getDashboardData` accepts `status` and `search` filters
2. `status` filter validates against `['pending', 'completed']`
3. `'delivered'` maps to `'completed'` for backward compatibility
4. `getStatistics` has no `$daysRange` parameter
5. Permission methods are unchanged
  </verify>
  <done>
Service layer passes updated filters to repository, validates event-based status values, and supports text search.
  </done>
</task>

</tasks>

<verification>
1. Repository method `getTrackingDashboardData` uses JSONB query with `elem->>'type' = 'Deliveries'`
2. Repository method `getTrackingStatistics` counts events from JSONB, not cron table
3. All 5 existing cron methods in repository are byte-for-byte unchanged
4. Service validates status filter as `pending`/`completed` (event-based, not cron-based)
5. No PHP syntax errors: `php -l src/Events/Repositories/MaterialTrackingRepository.php && php -l src/Events/Services/MaterialTrackingDashboardService.php`
</verification>

<success_criteria>
- Repository queries event_dates JSONB for Deliveries events
- Statistics count delivery events (total/pending/completed)
- Cron notification data joined via LEFT JOIN (supplementary)
- Existing cron methods preserved
- Service filters map to event statuses
- Search capability added
</success_criteria>

<output>
After completion, create `.planning/phases/19-material-tracking-dashboard-fix/19-01-SUMMARY.md`
</output>
