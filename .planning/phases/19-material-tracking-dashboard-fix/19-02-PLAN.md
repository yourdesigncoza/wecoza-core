---
phase: 19-material-tracking-dashboard-fix
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/Events/Views/Presenters/MaterialTrackingPresenter.php
  - src/Events/Shortcodes/MaterialTrackingShortcode.php
  - views/events/material-tracking/dashboard.php
  - views/events/material-tracking/list-item.php
  - views/events/material-tracking/statistics.php
autonomous: true

must_haves:
  truths:
    - "Dashboard displays rows from event_dates JSONB with delivery event date column"
    - "Statistics bar shows Total, Pending, Completed counts (not Notified)"
    - "Each row shows class code, subject, client/site, start date, delivery event date, notification badge (if cron record exists), status badge, and action checkbox"
    - "Search box filters by class code, subject, or client name"
    - "Status filter dropdown offers Pending/Completed (not Notified)"
    - "Cron notification badge (orange/red) shown as supplementary info where applicable"
  artifacts:
    - path: "src/Events/Views/Presenters/MaterialTrackingPresenter.php"
      provides: "Presenter mapping event_dates fields to display format"
      contains: "event_date"
    - path: "views/events/material-tracking/dashboard.php"
      provides: "Dashboard layout with delivery event date column"
      contains: "Delivery Date"
    - path: "views/events/material-tracking/list-item.php"
      provides: "Row template with event date and notification badge"
      contains: "event_date"
    - path: "views/events/material-tracking/statistics.php"
      provides: "Statistics strip with total/pending/completed"
      contains: "stat-completed"
    - path: "src/Events/Shortcodes/MaterialTrackingShortcode.php"
      provides: "Shortcode passing search param and updated filter shape"
      contains: "search"
  key_links:
    - from: "MaterialTrackingPresenter::presentRecords"
      to: "list-item.php"
      via: "record array keys"
      pattern: "event_date|event_index|event_status"
    - from: "MaterialTrackingPresenter::presentStatistics"
      to: "statistics.php"
      via: "stat array keys"
      pattern: "total.*pending.*completed"
    - from: "MaterialTrackingShortcode::render"
      to: "MaterialTrackingDashboardService::getDashboardData"
      via: "filters array with search key"
      pattern: "filters.*search"
---

<objective>
Update the presentation layer (presenter, views, shortcode) to display event_dates-sourced delivery records with the new data shape: delivery event date column, event-based status badges, and supplementary cron notification badges.

Purpose: The backend now returns event_dates data (Plan 01). This plan updates the UI to display it correctly: new columns, updated filters, updated statistics.

Output: Updated presenter, views, and shortcode that render the event-based delivery records.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-material-tracking-dashboard-fix/19-RESEARCH.md
@.planning/phases/19-material-tracking-dashboard-fix/19-01-SUMMARY.md

# Files to modify:
@src/Events/Views/Presenters/MaterialTrackingPresenter.php
@src/Events/Shortcodes/MaterialTrackingShortcode.php
@views/events/material-tracking/dashboard.php
@views/events/material-tracking/list-item.php
@views/events/material-tracking/statistics.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MaterialTrackingPresenter for event_dates data shape</name>
  <files>src/Events/Views/Presenters/MaterialTrackingPresenter.php</files>
  <action>
Rewrite `presentRecords()` to map event_dates fields from the new repository output.

**New record fields to map:**
```php
$presented[] = [
    'class_id' => (int) $record['class_id'],
    'class_code' => esc_html((string) ($record['class_code'] ?? 'N/A')),
    'class_subject' => esc_html((string) ($record['class_subject'] ?? 'N/A')),
    'client_name' => esc_html((string) ($record['client_name'] ?? 'N/A')),
    'site_name' => esc_html((string) ($record['site_name'] ?? 'N/A')),
    'original_start_date' => $this->formatDate($record['original_start_date'] ?? null),
    'event_date' => $this->formatDate($record['event_date'] ?? null),
    'event_description' => esc_html((string) ($record['event_description'] ?? '')),
    'event_index' => (int) ($record['event_index'] ?? 0),
    'event_status' => strtolower((string) ($record['event_status'] ?? 'pending')),
    'notification_type' => (string) ($record['notification_type'] ?? ''),
    'notification_sent_at' => $this->formatDateTime($record['notification_sent_at'] ?? null),
    'notification_badge_html' => $this->getNotificationBadge($record['notification_type'] ?? null),
    'status_badge_html' => $this->getEventStatusBadge(strtolower((string) ($record['event_status'] ?? 'pending'))),
    'delivery_status' => $this->mapEventStatus(strtolower((string) ($record['event_status'] ?? 'pending'))),
];
```

Remove `'id'` field (no longer a cron record ID -- use class_id + event_index for identification).
Remove `'materials_delivered_at'` field.
Remove `'action_button_html'` field (action is now a checkbox in the view, driven by event_status).

**Add new `mapEventStatus()` method:**
```php
private function mapEventStatus(string $eventStatus): string
{
    return match ($eventStatus) {
        'completed' => 'delivered',
        'pending' => 'pending',
        default => 'pending',
    };
}
```

**Add new `getEventStatusBadge()` method:**
```php
private function getEventStatusBadge(string $status): string
{
    return match ($status) {
        'pending' => '<span class="badge badge-phoenix badge-phoenix-secondary fs-10">Pending</span>',
        'completed' => '<span class="badge badge-phoenix badge-phoenix-success fs-10">Completed</span>',
        default => '<span class="badge badge-phoenix badge-phoenix-secondary fs-10">' . esc_html($status) . '</span>',
    };
}
```

**Update `getNotificationBadge()`:**
Change parameter type to `?string` (nullable). Keep existing logic but handle null:
```php
private function getNotificationBadge(?string $type): string
{
    if ($type === 'orange') {
        return '<span class="badge badge-phoenix badge-phoenix-warning fs-10">7d</span>';
    }
    if ($type === 'red') {
        return '<span class="badge badge-phoenix badge-phoenix-danger fs-10">5d</span>';
    }
    return '';
}
```
Remove emoji from notification badges (just use "7d" and "5d" text).

**Update `presentStatistics()`:**
Change stat keys from `total/pending/notified/delivered` to `total/pending/completed`:
```php
public function presentStatistics(array $stats): array
{
    return [
        'total' => [
            'count' => $stats['total'],
            'label' => 'Total Deliveries',
            'sublabel' => 'events',
            'icon' => '',
            'color' => 'secondary',
        ],
        'pending' => [
            'count' => $stats['pending'],
            'label' => 'Pending',
            'sublabel' => 'awaiting delivery',
            'icon' => '',
            'color' => 'warning',
        ],
        'completed' => [
            'count' => $stats['completed'],
            'label' => 'Completed',
            'sublabel' => 'delivered',
            'icon' => '',
            'color' => 'success',
        ],
    ];
}
```

Keep `formatDate()`, `formatDateTime()` unchanged. Remove old `getStatusBadge()` and `getActionButton()` methods (replaced by new methods above).
  </action>
  <verify>
Read the updated file and verify:
1. `presentRecords` maps `event_date`, `event_index`, `event_status` fields
2. `presentStatistics` returns `total`, `pending`, `completed` keys (no `notified`)
3. `getEventStatusBadge` uses Phoenix badge classes
4. `getNotificationBadge` accepts nullable string
5. Old methods `getStatusBadge` and `getActionButton` are removed
  </verify>
  <done>
Presenter maps event_dates data to display format with event date, event-based status badges, and supplementary notification badges.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update views and shortcode for new data shape</name>
  <files>
    views/events/material-tracking/dashboard.php
    views/events/material-tracking/list-item.php
    views/events/material-tracking/statistics.php
    src/Events/Shortcodes/MaterialTrackingShortcode.php
  </files>
  <action>
**Update `dashboard.php`:**

1. Replace the status filter dropdown options:
   - Remove "Notified" option
   - Change "Delivered" to "Completed"
   - Values: `all`, `pending`, `completed`

2. Remove the notification type filter dropdown entirely (cron notification type is supplementary info, not a primary filter).

3. Update table header columns -- add "Delivery Date" column between "Class Start Date" and "Notification" columns:
   ```html
   <th scope="col" class="border-0" data-sortable="true" data-sort-key="event_date" data-sort-type="date" style="cursor: pointer;">
       Delivery Date
       <span class="sort-indicator ms-1 d-none"><i class="bi bi-chevron-up"></i></span>
   </th>
   ```
   Keep "Notification Type" column header renamed to just "Notification" (shorter).
   Update colspan on empty state from 6 to 7 (new column added).

4. Update JavaScript `filterRecords()`:
   - Remove `typeFilter` logic (no notification type filter)
   - Keep search and status filter
   - Update sort key handling: add `event_date` key mapping to `$(a).data('event-date')`

5. Update JavaScript sort function to handle the new `event_date` sort key in the date sorting section.

6. Update JavaScript mark-delivered handler: Pass `event_index` in AJAX data alongside `class_id`. Read from `checkbox.data('event-index')`.

7. Update the statistics counter update in mark-delivered success handler:
   - Change `$('#stat-notified')` to `$('#stat-pending')`
   - Change `$('#stat-delivered')` to `$('#stat-completed')`

**Update `list-item.php`:**

1. Add `data-event-date` data attribute to `<tr>`:
   ```php
   data-event-date="<?php echo esc_attr($record['event_date']); ?>"
   ```

2. Update `data-status` to use `$record['delivery_status']` (maps event_status to pending/delivered).

3. Remove `data-notification-type` (no longer a filter key, but keep notification badge in display).

4. Add new "Delivery Date" column cell after "Class Start Date":
   ```php
   <td class="py-2 align-middle">
       <?php echo esc_html($record['event_date']); ?>
       <?php if (!empty($record['event_description'])): ?>
           <br><small class="text-body-tertiary"><?php echo esc_html($record['event_description']); ?></small>
       <?php endif; ?>
   </td>
   ```

5. Update the Actions column checkbox:
   - Add `data-event-index="<?php echo esc_attr((string) $record['event_index']); ?>"` to checkbox
   - Use `$record['delivery_status']` to determine checked/disabled state:
     - If `delivery_status === 'delivered'`: checked + disabled
     - Otherwise: enabled (checkable)

**Update `statistics.php`:**

1. Change `$statKeys` from `['total', 'pending', 'notified', 'delivered']` to `['total', 'pending', 'completed']`.
   That's the only change needed -- the presenter already provides the right shape.

**Update `MaterialTrackingShortcode.php`:**

1. Update `parseAttributes()`:
   - Remove `notification_type` attribute
   - Remove `days_range` attribute
   - Keep `limit` and `status`

2. Update `shortcode_atts` default values:
   ```php
   $atts = shortcode_atts([
       'limit' => self::DEFAULT_LIMIT,
       'status' => 'all',
   ], $atts, 'wecoza_material_tracking');
   ```

3. Remove `DEFAULT_DAYS_RANGE` constant.

4. Update `render()` method:
   - Remove `$filters['days_range']` from `getStatistics()` call (no param needed)
   - Pass filters to getDashboardData as before

5. Update `parseAttributes()` return:
   ```php
   return [
       'limit' => $limit,
       'status' => $status,
   ];
   ```
  </action>
  <verify>
Read all updated files and verify:
1. dashboard.php has 7 columns (added Delivery Date), status filter has pending/completed, no notification type filter
2. list-item.php has `data-event-date` attribute and Delivery Date cell
3. statistics.php uses `['total', 'pending', 'completed']` stat keys
4. MaterialTrackingShortcode.php has no `days_range` or `notification_type` attributes
5. No PHP syntax errors: `php -l` on all modified files
6. JavaScript sort handles `event_date` sort key
  </verify>
  <done>
Dashboard displays event_dates delivery records with delivery date column, event-based status badges, supplementary cron notification badges, updated statistics (total/pending/completed), and updated filters (search + status).
  </done>
</task>

</tasks>

<verification>
1. Dashboard renders with 7 columns: Class Code/Subject, Client/Site, Class Start Date, Delivery Date, Notification, Status, Actions
2. Statistics bar shows Total Deliveries, Pending, Completed (no Notified)
3. Status filter dropdown has All, Pending, Completed options
4. Search input filters by class code, subject, or client name
5. Each row shows delivery event date from event_dates JSONB
6. Notification badge (orange 7d / red 5d) shown where cron record exists, blank otherwise
7. Checkbox action passes event_index for per-event tracking
8. No PHP syntax errors on any modified file
</verification>

<success_criteria>
- Dashboard shows delivery event date column with data from event_dates JSONB
- Statistics reflect event counts (total/pending/completed)
- Status filter works with event-based statuses
- Search works across class code, subject, and client name
- Notification badges shown as supplementary info
- Shortcode simplified (no days_range, no notification_type)
</success_criteria>

<output>
After completion, create `.planning/phases/19-material-tracking-dashboard-fix/19-02-SUMMARY.md`
</output>
