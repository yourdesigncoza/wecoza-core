---
phase: 52-class-activation-logic
plan: 02
type: execute
wave: 2
depends_on: [52-01]
files_modified:
  - src/Events/Services/TaskManager.php
  - src/Events/Repositories/ClassTaskRepository.php
  - src/Events/Views/Presenters/ClassTaskPresenter.php
  - views/events/event-tasks/main.php
autonomous: true
requirements: [WEC-179]

must_haves:
  truths:
    - "Completing an agent-order task with a non-empty order_nr auto-sets class_status to 'active' if currently 'draft'"
    - "Event tasks listing shows a Draft/Active/Stopped badge for each class"
    - "All event tasks remain completable regardless of class status (Q1:C)"
    - "normaliseOrderNumber() is public static and callable from outside TaskManager"
  artifacts:
    - path: "src/Events/Services/TaskManager.php"
      provides: "Auto-activate on order_nr entry, public static normaliseOrderNumber"
      contains: "class_status"
    - path: "src/Events/Repositories/ClassTaskRepository.php"
      provides: "class_status in fetchClasses SELECT"
      contains: "c.class_status"
    - path: "src/Events/Views/Presenters/ClassTaskPresenter.php"
      provides: "formatClassStatusBadge method"
      contains: "formatClassStatusBadge"
    - path: "views/events/event-tasks/main.php"
      provides: "Class status badge rendered in UI"
      contains: "class_status_badge"
  key_links:
    - from: "src/Events/Services/TaskManager.php"
      to: "classes table"
      via: "updateClassOrderNumber SQL includes class_status conditional"
      pattern: "class_status.*CASE"
    - from: "src/Events/Views/Presenters/ClassTaskPresenter.php"
      to: "core/Helpers/functions.php"
      via: "wecoza_resolve_class_status() in badge formatting"
      pattern: "wecoza_resolve_class_status"
---

<objective>
Auto-activate classes when order_nr is entered via event tasks, and add class status badges to the event tasks listing view.

Purpose: Implements the automatic draft-to-active transition (Q4:A) and visual status awareness in event tasks (Q1:C). Also changes normaliseOrderNumber() to public static so ClassStatusAjaxHandler can reuse it.
Output: Updated TaskManager, ClassTaskRepository, ClassTaskPresenter, and event tasks view.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52-class-activation-logic/52-RESEARCH.md
@/home/laudes/.claude/plans/snoopy-wobbling-fountain.md

Key references:
- TaskManager: src/Events/Services/TaskManager.php — updateClassOrderNumber() at ~line 231, normaliseOrderNumber() at ~line 254 (currently private), fetchClassById() at ~line 197/199
- ClassTaskRepository: src/Events/Repositories/ClassTaskRepository.php — fetchClasses() SELECT at ~lines 63-88
- ClassTaskPresenter: src/Events/Views/Presenters/ClassTaskPresenter.php — formatClassRow() at ~line 117
- Event tasks view: views/events/event-tasks/main.php — badge at ~line 148
- Research confirmed: normaliseOrderNumber() is private, must change to public static
</context>

<tasks>

<task type="auto">
  <name>Task 1: TaskManager — auto-activate on order_nr + make normaliseOrderNumber public static</name>
  <files>src/Events/Services/TaskManager.php</files>
  <action>
**A. Change `normaliseOrderNumber()` from `private` to `public static`** (~line 254):
- Change method signature from `private function normaliseOrderNumber(string $orderNumber): string` to `public static function normaliseOrderNumber(string $orderNumber): string`
- Update all internal calls to use `self::normaliseOrderNumber()` instead of `$this->normaliseOrderNumber()`
- This enables ClassStatusAjaxHandler (Plan 05) to call `TaskManager::normaliseOrderNumber()` per DRY principle

**B. Update `updateClassOrderNumber()`** (~line 231):
- Modify the SQL to conditionally set `class_status = 'active'` when writing a non-empty order_nr to a draft class:
  ```sql
  UPDATE classes SET order_nr = :order_nr, order_nr_metadata = :metadata,
    class_status = CASE WHEN class_status = 'draft' AND :order_nr_check != '' THEN 'active' ELSE class_status END,
    updated_at = now() WHERE class_id = :class_id
  ```
  Note: use a separate named parameter for the CASE check (`:order_nr_check`) bound to the same value as `:order_nr`, since PDO cannot bind the same parameter name twice.
- Do NOT revert status when clearing order_nr (reopening a task) — class stays at its current status.

**C. Update `fetchClassById()`** (~line 197/199):
- Add `class_status` to the SELECT list alongside existing `class_id, order_nr, order_nr_metadata, event_dates`.
  </action>
  <verify>
    <automated>grep -q "public static function normaliseOrderNumber" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Events/Services/TaskManager.php && grep -q "class_status" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Events/Services/TaskManager.php && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>normaliseOrderNumber() is public static. updateClassOrderNumber() auto-sets class_status to 'active' for draft classes receiving order_nr. fetchClassById() returns class_status.</done>
</task>

<task type="auto">
  <name>Task 2: Event tasks — add class status badge to listing</name>
  <files>src/Events/Repositories/ClassTaskRepository.php, src/Events/Views/Presenters/ClassTaskPresenter.php, views/events/event-tasks/main.php</files>
  <action>
**A. ClassTaskRepository** — Add `c.class_status` to the SELECT list in `fetchClasses()` (~lines 63-88), alongside existing columns like `c.order_nr`.

**B. ClassTaskPresenter** — Add `formatClassStatusBadge()` method:
```php
private function formatClassStatusBadge(array $classData): array
{
    $status = wecoza_resolve_class_status($classData);
    return match ($status) {
        'active'  => ['class' => 'badge-phoenix-success', 'label' => 'Active',  'icon' => 'bi-check-circle'],
        'stopped' => ['class' => 'badge-phoenix-danger',  'label' => 'Stopped', 'icon' => 'bi-stop-circle'],
        default   => ['class' => 'badge-phoenix-warning', 'label' => 'Draft',   'icon' => 'bi-file-earmark-text'],
    };
}
```
- Call from `formatClassRow()` (or `present()` depending on structure) and add to the output array as `'class_status_badge'`
- The return shape matches the existing `'status'` key pattern used for task status badges

**C. views/events/event-tasks/main.php** — Add class status badge after the existing task status badge (~line 148):
```php
<?php if (!empty($class['class_status_badge'])): ?>
<span class="badge badge-phoenix fs-10 <?= esc_attr($class['class_status_badge']['class']); ?>">
    <span class="badge-label"><?= esc_html($class['class_status_badge']['label']); ?></span>
    <span class="ms-1 <?= esc_attr($class['class_status_badge']['icon']); ?>"></span>
</span>
<?php endif; ?>
```
- Do NOT change the `manageable` flag or any task completion logic — all tasks remain completable per Q1:C decision
  </action>
  <verify>
    <automated>grep -q "class_status_badge" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Events/Views/Presenters/ClassTaskPresenter.php && grep -q "class_status_badge" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/views/events/event-tasks/main.php && grep -q "c.class_status" /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/src/Events/Repositories/ClassTaskRepository.php && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Event tasks listing shows Draft/Active/Stopped badge per class. All tasks remain completable. Badge uses Phoenix badge system with correct colors and icons.</done>
</task>

</tasks>

<verification>
1. Internal `normaliseOrderNumber()` calls work with `self::` static syntax
2. `fetchClassById()` returns `class_status` in result
3. `ClassTaskPresenter` badge output has `['class', 'label', 'icon']` shape
4. Event tasks view renders badge without breaking existing layout
5. No changes to task completion/manageable logic
</verification>

<success_criteria>
- Order number entry via agent task auto-activates draft classes
- Event tasks show three-way class status badge
- normaliseOrderNumber() accessible as public static for reuse
- All event tasks still completable regardless of class status
</success_criteria>

<output>
After completion, create `.planning/phases/52-class-activation-logic/52-02-SUMMARY.md`
</output>
