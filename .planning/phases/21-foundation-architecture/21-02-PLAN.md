---
phase: 21-foundation-architecture
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - wecoza-core.php
  - src/Clients/Controllers/ClientsController.php
  - src/Clients/Controllers/LocationsController.php
  - src/Clients/Ajax/ClientAjaxHandlers.php
  - views/clients/components/client-capture-form.view.php
  - views/clients/components/client-update-form.view.php
  - views/clients/components/location-capture-form.view.php
  - views/clients/display/clients-display.view.php
  - views/clients/display/clients-table.view.php
  - views/clients/display/locations-list.view.php
  - assets/js/clients/client-capture.js
  - assets/js/clients/clients-display.js
  - assets/js/clients/client-search.js
  - assets/js/clients/clients-table.js
  - assets/js/clients/location-capture.js
  - assets/js/clients/locations-list.js
autonomous: true

must_haves:
  truths:
    - "Shortcodes [wecoza_capture_clients], [wecoza_display_clients], [wecoza_locations_capture], [wecoza_locations_edit], [wecoza_locations_list] register through wecoza-core.php and render HTML"
    - "View templates render via wecoza_view('clients/...') from views/clients/"
    - "JavaScript assets load from assets/js/clients/ via wp_enqueue_script with conditional shortcode detection"
    - "AJAX handlers use AjaxSecurity nonce/capability patterns, registered in wecoza-core.php"
    - "Controllers use wecoza_db(), wecoza_view(), wecoza_config('clients') - zero old helper references"
  artifacts:
    - path: "src/Clients/Controllers/ClientsController.php"
      provides: "Client shortcodes and asset enqueuing"
      contains: "wecoza_view"
    - path: "src/Clients/Controllers/LocationsController.php"
      provides: "Location shortcodes and asset enqueuing"
      contains: "wecoza_view"
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "AJAX endpoints for client/location CRUD"
      contains: "AjaxSecurity"
    - path: "views/clients/components/client-capture-form.view.php"
      provides: "Client creation form template"
      contains: "wecoza_config"
    - path: "views/clients/display/clients-table.view.php"
      provides: "Clients table display template"
      contains: "client_name"
    - path: "assets/js/clients/client-capture.js"
      provides: "Client form JavaScript"
      contains: "wecozaClients"
  key_links:
    - from: "wecoza-core.php"
      to: "src/Clients/Controllers/ClientsController.php"
      via: "module initialization in plugins_loaded"
      pattern: "new.*ClientsController"
    - from: "src/Clients/Controllers/ClientsController.php"
      to: "views/clients/"
      via: "wecoza_view() helper"
      pattern: "wecoza_view\\('clients/"
    - from: "src/Clients/Controllers/ClientsController.php"
      to: "assets/js/clients/"
      via: "wp_enqueue_script with wecoza_js_url"
      pattern: "wecoza_js_url\\('clients/"
    - from: "src/Clients/Ajax/ClientAjaxHandlers.php"
      to: "src/Clients/Repositories/ClientRepository.php"
      via: "constructor injection: $this->clientRepository = new ClientRepository()"
      pattern: "\\$this->clientRepository"
    - from: "src/Clients/Ajax/ClientAjaxHandlers.php"
      to: "src/Clients/Repositories/LocationRepository.php"
      via: "constructor injection: $this->locationRepository = new LocationRepository()"
      pattern: "\\$this->locationRepository"
    - from: "assets/js/clients/client-capture.js"
      to: "src/Clients/Ajax/ClientAjaxHandlers.php"
      via: "AJAX POST with nonce"
      pattern: "wecozaClients\\.nonce"
---

<objective>
Migrate Controllers, AJAX handlers, Views, and JavaScript assets into wecoza-core architecture. Wire everything into wecoza-core.php entry point.

**Scope clarification:** This is ARCHITECTURE MIGRATION (ARCH-01 through ARCH-08), not feature delivery. LocationsController, location views, and location JS are migrated here so they exist in wecoza-core's namespace/directory structure. Phase 23 will refine/extend location features (Google Maps autocomplete, duplicate detection, geocoding). This plan migrates existing code as-is into the new architecture.

Purpose: Completes the Clients module integration - shortcodes render, AJAX works, views display, JS loads.
Output: 2 Controllers, 1 AJAX handler class, 6 view templates, 6 JS files, wecoza-core.php updated.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-foundation-architecture/21-RESEARCH.md
@.planning/phases/21-foundation-architecture/21-01-SUMMARY.md

# Source files to migrate from:
@.integrate/wecoza-clients-plugin/app/Controllers/ClientsController.php
@.integrate/wecoza-clients-plugin/app/Controllers/LocationsController.php
@.integrate/wecoza-clients-plugin/app/Views/components/client-capture-form.view.php
@.integrate/wecoza-clients-plugin/app/Views/components/client-update-form.view.php
@.integrate/wecoza-clients-plugin/app/Views/components/location-capture-form.view.php
@.integrate/wecoza-clients-plugin/app/Views/display/clients-display.view.php
@.integrate/wecoza-clients-plugin/app/Views/display/clients-table.view.php
@.integrate/wecoza-clients-plugin/app/Views/display/locations-list.view.php
@.integrate/wecoza-clients-plugin/assets/js/client-capture.js
@.integrate/wecoza-clients-plugin/assets/js/clients-display.js
@.integrate/wecoza-clients-plugin/assets/js/client-search.js
@.integrate/wecoza-clients-plugin/assets/js/clients-table.js
@.integrate/wecoza-clients-plugin/assets/js/location-capture.js
@.integrate/wecoza-clients-plugin/assets/js/locations-list.js

# Existing module patterns:
@wecoza-core.php (module init at line 184-229, asset enqueue at line 109-144)
@core/Helpers/AjaxSecurity.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Controllers with shortcodes and asset enqueuing</name>
  <files>
    src/Clients/Controllers/ClientsController.php
    src/Clients/Controllers/LocationsController.php
  </files>
  <action>
Migrate both Controllers from `.integrate/wecoza-clients-plugin/app/Controllers/`.

**For ClientsController.php (~1251 lines):**

Apply these transformations:
1. `namespace WeCozaClients\Controllers;` -> `namespace WeCoza\Clients\Controllers;`
2. Add: `use WeCoza\Core\Abstract\BaseController;` and `use WeCoza\Clients\Models\ClientsModel;` and `use WeCoza\Clients\Repositories\ClientRepository;` and `use WeCoza\Clients\Helpers\ViewHelpers;`
3. Remove: `use WeCozaClients\Models\ClientsModel;` and `use WeCozaClients\Services\Database\DatabaseService;`
4. Class: `class ClientsController extends BaseController`
5. Add `registerHooks()` method (required by BaseController):
   ```php
   protected function registerHooks(): void
   {
       add_action('init', [$this, 'registerShortcodes']);
       add_action('wp_enqueue_scripts', [$this, 'enqueueAssets']);
   }
   ```

**Shortcode registration** - extract from source controller's constructor and place in `registerShortcodes()`:
- `wecoza_capture_clients` -> `captureClientShortcode`
- `wecoza_display_clients` -> `displayClientsShortcode`
- `wecoza_update_clients` -> `updateClientShortcode` (if exists in source)

**Asset enqueuing** - create `enqueueAssets()` method:
- Check `global $post` and `has_shortcode()` before enqueuing
- Use `wecoza_js_url('clients/...')` for script paths
- Use `wp_localize_script()` to pass `wecozaClients` object with `ajax_url` and `nonce`
- Nonce action: `'clients_nonce_action'` (standardized)
- Enqueue correct JS per shortcode:
  - `wecoza_capture_clients` -> `client-capture.js`
  - `wecoza_display_clients` -> `clients-table.js`, `clients-display.js`, `client-search.js`
  - `wecoza_update_clients` -> `client-capture.js` (same form JS)
  - `wecoza_locations_capture` -> `location-capture.js`
  - `wecoza_locations_list` -> `locations-list.js`

**View rendering replacement:**
- ALL `\WeCozaClients\view('components/...')` -> `wecoza_view('clients/components/...', $data, true)`
- ALL `\WeCozaClients\view('display/...')` -> `wecoza_view('clients/display/...', $data, true)`

**Database replacement:**
- ALL `DatabaseService::` -> `wecoza_db()->`
- ALL `\WeCozaClients\config('app')` -> `wecoza_config('clients')`
- ALL `\WeCozaClients\plugin_log(...)` -> `wecoza_log(...)`

**CRITICAL: Extract AJAX handlers OUT of Controller.**
The source ClientsController has 10+ AJAX handler methods embedded. These should be REMOVED from the Controller and placed in the separate AJAX handler class (Task 2a). Remove methods like:
- `ajaxSaveClient`, `ajaxGetClient`, `ajaxDeleteClient`, `ajaxSearchClients`
- `ajaxGetBranchClients`, `ajaxExportClients`, `ajaxGetLocations`
- Any `add_action('wp_ajax_...')` registrations

The Controller keeps ONLY: shortcode methods, enqueueAssets, registerShortcodes, sanitizeFormData, and any display/rendering logic.

**For LocationsController.php (~418 lines):**

Same transformations as above:
1. Namespace: `WeCoza\Clients\Controllers`
2. Extends: `BaseController`
3. `registerHooks()` with shortcodes: `wecoza_locations_capture`, `wecoza_locations_edit`, `wecoza_locations_list`
4. Replace all view/config/db/log calls
5. Extract AJAX handlers to ClientAjaxHandlers (Task 2a)

**Google Maps API key:** Continue using `get_option('wecoza_agents_google_maps_api_key')` per research recommendation. Pass to localized script for location-capture.js.
  </action>
  <verify>
1. `php -l src/Clients/Controllers/ClientsController.php` - No syntax errors
2. `php -l src/Clients/Controllers/LocationsController.php` - No syntax errors
3. `grep -c "WeCozaClients" src/Clients/Controllers/ClientsController.php` returns 0
4. `grep -c "DatabaseService" src/Clients/Controllers/ClientsController.php` returns 0
5. `grep -c "wecoza_view" src/Clients/Controllers/ClientsController.php` returns >=3
6. `grep -c "wecoza_js_url" src/Clients/Controllers/ClientsController.php` returns >=2
7. `grep -c "registerShortcodes" src/Clients/Controllers/ClientsController.php` returns >=1
8. `grep -c "wp_ajax_" src/Clients/Controllers/ClientsController.php` returns 0 (AJAX moved out)
  </verify>
  <done>
Both Controllers extend BaseController, register shortcodes via registerHooks(), enqueue assets conditionally per shortcode, and render views via wecoza_view(). AJAX handlers removed from Controllers.
  </done>
</task>

<task type="auto">
  <name>Task 2a: Create AJAX handlers and wire module into wecoza-core.php</name>
  <files>
    src/Clients/Ajax/ClientAjaxHandlers.php
    wecoza-core.php
  </files>
  <action>
**1. Create `src/Clients/Ajax/ClientAjaxHandlers.php`:**

Follow Learners pattern at `src/Learners/Ajax/LearnerAjaxHandlers.php`.

```php
namespace WeCoza\Clients\Ajax;

use WeCoza\Core\Helpers\AjaxSecurity;
use WeCoza\Clients\Repositories\ClientRepository;
use WeCoza\Clients\Repositories\LocationRepository;
```

**Constructor with explicit repository wiring:**
```php
private ClientRepository $clientRepository;
private LocationRepository $locationRepository;

public function __construct()
{
    $this->clientRepository = new ClientRepository();
    $this->locationRepository = new LocationRepository();
    $this->registerHandlers();
}
```

`registerHandlers()` registers ALL AJAX actions extracted from source ClientsController + LocationsController:
- `wp_ajax_wecoza_save_client` -> `saveClient()`
- `wp_ajax_wecoza_get_client` -> `getClient()`
- `wp_ajax_wecoza_delete_client` -> `deleteClient()`
- `wp_ajax_wecoza_search_clients` -> `searchClients()`
- `wp_ajax_wecoza_get_branch_clients` -> `getBranchClients()`
- `wp_ajax_wecoza_export_clients` -> `exportClients()`
- `wp_ajax_wecoza_get_locations` -> `getLocations()`
- `wp_ajax_wecoza_save_location` -> `saveLocation()`
- `wp_ajax_wecoza_check_location_duplicates` -> `checkLocationDuplicates()`

Each handler method:
1. `AjaxSecurity::requireNonce('clients_nonce_action');`
2. Appropriate capability check (e.g., `AjaxSecurity::requireCapability('manage_clients');` or check with `current_user_can()`)
3. Sanitize input with `AjaxSecurity::sanitizeArray()` or `wecoza_sanitize_value()`
4. Call repository methods via `$this->clientRepository->...` or `$this->locationRepository->...`
5. Return via `AjaxSecurity::sendSuccess()` or `AjaxSecurity::sendError()`

Migrate the actual handler logic from the source Controllers. Keep ALL business logic intact (validation, JSONB handling, CSV export, etc.).

**2. Wire into wecoza-core.php:**

In the `plugins_loaded` callback (after Events module initialization around line ~229), add:

```php
// Initialize Clients Module
if (class_exists(\WeCoza\Clients\Controllers\ClientsController::class)) {
    new \WeCoza\Clients\Controllers\ClientsController();
}

if (class_exists(\WeCoza\Clients\Controllers\LocationsController::class)) {
    new \WeCoza\Clients\Controllers\LocationsController();
}

if (class_exists(\WeCoza\Clients\Ajax\ClientAjaxHandlers::class)) {
    new \WeCoza\Clients\Ajax\ClientAjaxHandlers();
}
```

Also add `manage_clients` capability registration in the activation hook (line ~459-466):
```php
$admin->add_cap('manage_clients');
$admin->add_cap('view_clients');
```

And removal in deactivation hook (line ~497-502):
```php
$admin->remove_cap('manage_clients');
$admin->remove_cap('view_clients');
```
  </action>
  <verify>
1. `php -l src/Clients/Ajax/ClientAjaxHandlers.php` - No syntax errors
2. `grep -c "ClientsController" wecoza-core.php` returns >=1 (module initialized)
3. `grep -c "ClientAjaxHandlers" wecoza-core.php` returns >=1 (AJAX initialized)
4. `grep -c "manage_clients" wecoza-core.php` returns >=2 (add_cap + remove_cap)
5. `grep -r "WeCozaClients" src/Clients/Ajax/` returns 0 matches
6. `grep -c "AjaxSecurity" src/Clients/Ajax/ClientAjaxHandlers.php` returns >=3
7. `grep -c "clientRepository" src/Clients/Ajax/ClientAjaxHandlers.php` returns >=2 (property + constructor)
8. `grep -c "locationRepository" src/Clients/Ajax/ClientAjaxHandlers.php` returns >=2 (property + constructor)
  </verify>
  <done>
AJAX handler class wires to repositories via constructor. All AJAX endpoints registered in wecoza-core.php. Capabilities registered on activation/deactivation.
  </done>
</task>

<task type="auto">
  <name>Task 2b: Migrate 6 view templates to views/clients/</name>
  <files>
    views/clients/components/client-capture-form.view.php
    views/clients/components/client-update-form.view.php
    views/clients/components/location-capture-form.view.php
    views/clients/display/clients-display.view.php
    views/clients/display/clients-table.view.php
    views/clients/display/locations-list.view.php
  </files>
  <action>
Copy all 6 view files from source, with these transformations:
- `views/clients/components/` <- `.integrate/.../app/Views/components/`
- `views/clients/display/` <- `.integrate/.../app/Views/display/`

In EACH view file:
- Replace `\WeCozaClients\Helpers\ViewHelpers::` -> `\WeCoza\Clients\Helpers\ViewHelpers::` (or add `use` at top)
- Replace `\WeCozaClients\config('app')` -> `wecoza_config('clients')`
- Replace any inline `<script src="...">` tags that load JS - remove them (JS is now enqueued via Controller)
- Replace any `WECOZA_CLIENTS_*` constants with core equivalents
- Keep ALL HTML structure, form fields, Bootstrap/Phoenix classes intact
- Keep `wp_nonce_field()` calls but ensure action matches `'clients_nonce_action'`
  </action>
  <verify>
1. `find views/clients/ -name "*.php" -exec php -l {} \;` - All view files pass syntax check
2. `find views/clients/ -name "*.php" | wc -l` returns 6
3. `grep -r "WeCozaClients" views/clients/` returns 0 matches
4. `grep -r "wecoza_config" views/clients/components/client-capture-form.view.php` returns >=1
  </verify>
  <done>
All 6 view templates migrated with correct namespace references, config helpers, and no old plugin references. HTML structure and Phoenix classes preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2c: Migrate 6 JavaScript assets to assets/js/clients/</name>
  <files>
    assets/js/clients/client-capture.js
    assets/js/clients/clients-display.js
    assets/js/clients/client-search.js
    assets/js/clients/clients-table.js
    assets/js/clients/location-capture.js
    assets/js/clients/locations-list.js
  </files>
  <action>
Copy all 6 JS files from `.integrate/wecoza-clients-plugin/assets/js/` to `assets/js/clients/`.

In EACH JS file:
- Update nonce references to use `wecozaClients.nonce` (from wp_localize_script)
- Update AJAX URL to use `wecozaClients.ajax_url`
- If any JS file references `wecoza_clients_ajax` object, rename to `wecozaClients`
- Keep ALL functionality intact (form handling, table management, search, export, Google Maps integration)
  </action>
  <verify>
1. `find assets/js/clients/ -name "*.js" | wc -l` returns 6
2. `grep -r "wecoza_clients_ajax" assets/js/clients/` returns 0 matches (old object name purged)
3. `grep -c "wecozaClients" assets/js/clients/client-capture.js` returns >=1
  </verify>
  <done>
All 6 JS files migrated with updated localized object references. All functionality preserved.
  </done>
</task>

</tasks>

<verification>
After all 4 tasks complete, verify the full Phase 21 success criteria:

1. **ARCH-01:** `ls src/Clients/` shows Controllers/, Models/, Repositories/, Ajax/, Helpers/ directories
2. **ARCH-02:** `grep "WeCoza\\\\Clients\\\\" wecoza-core.php` confirms PSR-4 autoloading
3. **ARCH-03:** `grep -r "DatabaseService" src/Clients/` returns 0 (all use wecoza_db())
4. **ARCH-04:** `ls views/clients/` shows components/ and display/ with 6 view files
5. **ARCH-05:** `ls assets/js/clients/` shows 6 JS files
6. **ARCH-06:** `ls config/clients.php` exists with SETA/validation/province data
7. **ARCH-07:** `grep "wecoza_capture_clients\|wecoza_display_clients\|wecoza_locations" wecoza-core.php` OR shortcodes registered in Controllers
8. **ARCH-08:** `grep "AjaxSecurity" src/Clients/Ajax/ClientAjaxHandlers.php` confirms pattern usage

**Zero old namespace check:** `grep -r "WeCozaClients" src/Clients/ views/clients/ assets/js/clients/ config/clients.php` returns 0 matches

**All PHP files valid:** `find src/Clients/ views/clients/ config/ -name "*.php" -exec php -l {} \;` shows no syntax errors
</verification>

<success_criteria>
- All 5 shortcodes register through wecoza-core.php and Controllers
- View templates render from views/clients/ via wecoza_view()
- JavaScript loads from assets/js/clients/ with conditional shortcode detection
- AJAX handlers use AjaxSecurity nonce/capability patterns with explicit repository wiring
- Controllers use wecoza_db(), wecoza_view(), wecoza_config('clients')
- Module initialized in wecoza-core.php plugins_loaded callback
- manage_clients capability registered on activation
</success_criteria>

<output>
After completion, create `.planning/phases/21-foundation-architecture/21-02-SUMMARY.md`
</output>
