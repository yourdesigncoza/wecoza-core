---
phase: 21-foundation-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wecoza-core.php
  - config/clients.php
  - src/Clients/Helpers/ViewHelpers.php
  - src/Clients/Models/ClientsModel.php
  - src/Clients/Models/LocationsModel.php
  - src/Clients/Models/SitesModel.php
  - src/Clients/Models/ClientCommunicationsModel.php
  - src/Clients/Repositories/ClientRepository.php
  - src/Clients/Repositories/LocationRepository.php
autonomous: true

must_haves:
  truths:
    - "Classes under WeCoza\\Clients\\ namespace autoload from src/Clients/ without manual requires"
    - "wecoza_config('clients') returns SETA options, validation rules, province options, and status options"
    - "ClientsModel and LocationsModel use wecoza_db() for all database queries (zero DatabaseService references)"
    - "Client and Location database queries are protected against SQL injection via column whitelisting"
  artifacts:
    - path: "config/clients.php"
      provides: "SETA options, validation rules, province options, status options"
      contains: "seta_options"
    - path: "src/Clients/Models/ClientsModel.php"
      provides: "Client data model with JSONB handling"
      contains: "wecoza_db()"
    - path: "src/Clients/Models/LocationsModel.php"
      provides: "Location data model"
      contains: "wecoza_db()"
    - path: "src/Clients/Models/SitesModel.php"
      provides: "Sites data model"
      contains: "wecoza_db()"
    - path: "src/Clients/Models/ClientCommunicationsModel.php"
      provides: "Client communications model"
      contains: "wecoza_db()"
    - path: "src/Clients/Repositories/ClientRepository.php"
      provides: "Client data access with column whitelisting"
      contains: "BaseRepository"
    - path: "src/Clients/Repositories/LocationRepository.php"
      provides: "Location data access with column whitelisting"
      contains: "BaseRepository"
    - path: "src/Clients/Helpers/ViewHelpers.php"
      provides: "Form field rendering utilities for client views"
      contains: "renderField"
  key_links:
    - from: "wecoza-core.php"
      to: "src/Clients/"
      via: "PSR-4 autoloader namespace registration"
      pattern: "WeCoza\\\\Clients\\\\"
    - from: "src/Clients/Models/ClientsModel.php"
      to: "core/Database/PostgresConnection"
      via: "wecoza_db() helper"
      pattern: "wecoza_db\\(\\)"
    - from: "src/Clients/Repositories/ClientRepository.php"
      to: "core/Abstract/BaseRepository"
      via: "class inheritance"
      pattern: "extends BaseRepository"
---

<objective>
Create the Clients module foundation: directory structure, PSR-4 autoloader registration, configuration file, ViewHelpers, all 4 Models migrated from DatabaseService to wecoza_db(), and 2 Repositories.

Purpose: Establishes the data layer that Controllers, AJAX handlers, and Views (Plan 02) depend on.
Output: 9 new files + 1 modified file (wecoza-core.php autoloader).
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-foundation-architecture/21-RESEARCH.md

# Source files to migrate from:
@.integrate/wecoza-clients-plugin/app/Models/ClientsModel.php
@.integrate/wecoza-clients-plugin/app/Models/LocationsModel.php
@.integrate/wecoza-clients-plugin/app/Models/SitesModel.php
@.integrate/wecoza-clients-plugin/app/Models/ClientCommunicationsModel.php
@.integrate/wecoza-clients-plugin/app/Helpers/ViewHelpers.php
@.integrate/wecoza-clients-plugin/config/app.php

# Reference patterns from existing modules:
@wecoza-core.php (autoloader at line 46-74, module init at line 184-229)
@core/Abstract/BaseModel.php
@core/Abstract/BaseRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register namespace, create config, and migrate ViewHelpers</name>
  <files>
    wecoza-core.php
    config/clients.php
    src/Clients/Helpers/ViewHelpers.php
  </files>
  <action>
**1. Register WeCoza\Clients\ namespace in wecoza-core.php autoloader (line ~48-53):**

Add this entry to the `$namespaces` array:
```php
'WeCoza\\Clients\\' => WECOZA_CORE_PATH . 'src/Clients/',
```

Place it after the `WeCoza\\Events\\` entry.

**2. Create `config/clients.php`:**

Extract from source `.integrate/wecoza-clients-plugin/config/app.php` these sections ONLY:
- `validation_rules` (lines 184-234)
- `seta_options` (lines 239-261) - convert to associative: `'AgriSETA' => 'AgriSETA'` format
- `province_options` (lines 263-273) - convert to associative: `'Eastern Cape' => 'Eastern Cape'` format
- `client_status_options` (lines 278-283)
- `settings` subsection: `items_per_page => 10`

DO NOT include: plugin info, database config, controllers list, shortcodes config, ajax_endpoints, assets config, capabilities. Those are bootstrap concerns handled by wecoza-core.php.

Return format:
```php
<?php
if (!defined('ABSPATH')) exit;

return [
    'validation_rules' => [...],
    'seta_options' => [...],
    'province_options' => [...],
    'client_status_options' => [...],
    'items_per_page' => 10,
];
```

**3. Migrate `src/Clients/Helpers/ViewHelpers.php`:**

Copy from `.integrate/wecoza-clients-plugin/app/Helpers/ViewHelpers.php`.
- Change namespace: `WeCozaClients\Helpers` -> `WeCoza\Clients\Helpers`
- Remove any `use WeCozaClients\...` imports
- Replace any `\WeCozaClients\config('app')` calls with `wecoza_config('clients')`
- Replace any `\WeCozaClients\view()` calls with `wecoza_view()`
- Keep all renderField methods intact (text, select, textarea, checkbox, date, etc.)

Do NOT create `view-helpers-loader.php` - not needed with PSR-4 autoloading.
  </action>
  <verify>
Run these checks:
1. `grep -c "WeCoza\\\\Clients\\\\" wecoza-core.php` returns 1 (namespace registered)
2. `php -l config/clients.php` returns "No syntax errors"
3. `php -l src/Clients/Helpers/ViewHelpers.php` returns "No syntax errors"
4. `grep -c "WeCozaClients" src/Clients/Helpers/ViewHelpers.php` returns 0 (old namespace purged)
5. `grep -c "DatabaseService" src/Clients/Helpers/ViewHelpers.php` returns 0
  </verify>
  <done>
Autoloader recognizes WeCoza\Clients\ namespace. Config returns SETA/validation/province/status data. ViewHelpers has correct namespace with no old references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all 4 Models from DatabaseService to wecoza_db()</name>
  <files>
    src/Clients/Models/ClientsModel.php
    src/Clients/Models/LocationsModel.php
    src/Clients/Models/SitesModel.php
    src/Clients/Models/ClientCommunicationsModel.php
  </files>
  <action>
For EACH of the 4 source Model files in `.integrate/wecoza-clients-plugin/app/Models/`:

**Namespace transformation:**
- `namespace WeCozaClients\Models;` -> `namespace WeCoza\Clients\Models;`
- Remove: `use WeCozaClients\Services\Database\DatabaseService;`
- Add: `use WeCoza\Core\Abstract\BaseModel;`
- Class declaration: add `extends BaseModel` (e.g., `class ClientsModel extends BaseModel`)

**Database access replacement (CRITICAL - 20+ occurrences across all files):**

Replace ALL static `DatabaseService::` calls with `wecoza_db()->` instance calls:
- `DatabaseService::getAll($sql, $params)` -> `wecoza_db()->getAll($sql, $params)`
- `DatabaseService::getRow($sql, $params)` -> `wecoza_db()->getRow($sql, $params)`
- `DatabaseService::getValue($sql, $params)` -> `wecoza_db()->getValue($sql, $params)`
- `DatabaseService::insert($table, $data)` -> `wecoza_db()->insert($table, $data)`
- `DatabaseService::update($table, $data, $where, $params)` -> `wecoza_db()->update($table, $data, $where, $params)`
- `DatabaseService::delete($table, $where, $params)` -> `wecoza_db()->delete($table, $where, $params)`
- `DatabaseService::query($sql, $params)` -> `wecoza_db()->query($sql, $params)`
- `DatabaseService::beginTransaction()` -> `wecoza_db()->beginTransaction()`
- `DatabaseService::commit()` -> `wecoza_db()->commit()`
- `DatabaseService::rollback()` -> `wecoza_db()->rollback()`

**Config access replacement:**
- `\WeCozaClients\config('app')` -> `wecoza_config('clients')`

**Helper function replacement:**
- `\WeCozaClients\plugin_log(...)` -> `wecoza_log(...)`

**Model-specific notes:**

- **ClientsModel.php** (~719 lines): Has `$fillable`, `$jsonFields`, validation methods, JSONB encode/decode. Add `protected string $table = 'clients';` and `protected string $primaryKey = 'client_id';`. Keep all existing methods (getAll, getById, insert, update, delete, validate, sanitize, encodeJsonFields, decodeJsonFields).

- **LocationsModel.php** (~272 lines): Location CRUD with lat/lng. Add `protected string $table = 'locations';` and `protected string $primaryKey = 'location_id';`.

- **SitesModel.php** (~867 lines): Complex hierarchical queries (head sites, sub-sites, location hydration). Add `protected string $table = 'sites';` and `protected string $primaryKey = 'site_id';`.

- **ClientCommunicationsModel.php** (~139 lines): Communication history CRUD. Add `protected string $table = 'client_communications';` and `protected string $primaryKey = 'communication_id';`.

Preserve ALL business logic, validation, SQL queries, JSONB handling. Only change namespace, DB access pattern, and config access.
  </action>
  <verify>
Run these checks for ALL 4 model files:
1. `php -l src/Clients/Models/ClientsModel.php` - No syntax errors
2. `php -l src/Clients/Models/LocationsModel.php` - No syntax errors
3. `php -l src/Clients/Models/SitesModel.php` - No syntax errors
4. `php -l src/Clients/Models/ClientCommunicationsModel.php` - No syntax errors
5. `grep -r "DatabaseService" src/Clients/Models/` returns 0 matches (ALL replaced)
6. `grep -r "WeCozaClients" src/Clients/Models/` returns 0 matches (old namespace purged)
7. `grep -c "wecoza_db()" src/Clients/Models/ClientsModel.php` returns >5 (confirms replacement)
8. `grep -c "extends BaseModel" src/Clients/Models/ClientsModel.php` returns 1
  </verify>
  <done>
All 4 Models use WeCoza\Clients\Models namespace, extend BaseModel, and use wecoza_db() exclusively. Zero DatabaseService references remain.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ClientRepository and LocationRepository</name>
  <files>
    src/Clients/Repositories/ClientRepository.php
    src/Clients/Repositories/LocationRepository.php
  </files>
  <action>
Create 2 Repository classes following the patterns in `core/Abstract/BaseRepository.php` and existing modules (Learners, Events).

**1. `src/Clients/Repositories/ClientRepository.php`:**

```php
namespace WeCoza\Clients\Repositories;

use WeCoza\Core\Abstract\BaseRepository;
use WeCoza\Clients\Models\ClientsModel;
```

Required methods:
- `getModel(): string` - return `ClientsModel::class`
- `getAllowedOrderColumns(): array` - return `['client_name', 'company_registration_nr', 'client_status', 'seta', 'created_at', 'updated_at']`
- `getAllowedFilterColumns(): array` - return `['client_status', 'seta', 'main_client_id', 'deleted_at']`
- `getAllowedInsertColumns(): array` - return all columns from ClientsModel::$fillable
- `getAllowedUpdateColumns(): array` - same as insert columns
- `getMainClients(): array` - custom query: `SELECT * FROM clients WHERE main_client_id IS NULL AND deleted_at IS NULL ORDER BY client_name`
- `getBranchClients(int $mainClientId): array` - custom query for sub-clients
- `searchClients(string $term): array` - ILIKE search on client_name, company_registration_nr, contact_person

All custom queries use `wecoza_db()->getAll()` / `wecoza_db()->getRow()`.

**2. `src/Clients/Repositories/LocationRepository.php`:**

```php
namespace WeCoza\Clients\Repositories;

use WeCoza\Core\Abstract\BaseRepository;
use WeCoza\Clients\Models\LocationsModel;
```

Required methods:
- `getModel(): string` - return `LocationsModel::class`
- `getAllowedOrderColumns(): array` - return `['suburb', 'town', 'province', 'postal_code', 'created_at']`
- `getAllowedFilterColumns(): array` - return `['province', 'town', 'deleted_at']`
- `getAllowedInsertColumns(): array` - from LocationsModel fields
- `getAllowedUpdateColumns(): array` - same as insert
- `findByCoordinates(float $lat, float $lng, float $radiusKm = 1.0): array` - proximity search (if source has this pattern)
- `checkDuplicates(string $suburb, string $town): array` - duplicate detection by suburb+town

All custom queries use `wecoza_db()`.

Review source Models to extract the exact column names for allowed lists. Ensure column whitelisting matches actual database columns from the source plugin schema.
  </action>
  <verify>
Run these checks:
1. `php -l src/Clients/Repositories/ClientRepository.php` - No syntax errors
2. `php -l src/Clients/Repositories/LocationRepository.php` - No syntax errors
3. `grep -c "extends BaseRepository" src/Clients/Repositories/ClientRepository.php` returns 1
4. `grep -c "extends BaseRepository" src/Clients/Repositories/LocationRepository.php` returns 1
5. `grep -c "wecoza_db()" src/Clients/Repositories/ClientRepository.php` returns >=2
6. `grep -c "getAllowedOrderColumns" src/Clients/Repositories/ClientRepository.php` returns 1
7. `grep -r "DatabaseService" src/Clients/Repositories/` returns 0 matches
  </verify>
  <done>
Both Repositories extend BaseRepository with column whitelisting for SQL injection prevention. Custom query methods use wecoza_db() exclusively.
  </done>
</task>

</tasks>

<verification>
After all 3 tasks complete:

1. **Namespace autoloading:** `grep "WeCoza\\\\Clients\\\\" wecoza-core.php` shows the namespace is registered
2. **Zero old references:** `grep -r "WeCozaClients" src/Clients/` returns 0 matches
3. **Zero DatabaseService:** `grep -r "DatabaseService" src/Clients/` returns 0 matches
4. **All PHP valid:** `find src/Clients/ -name "*.php" -exec php -l {} \;` shows no syntax errors
5. **Config loads:** `php -r "require 'config/clients.php';"` does not error (basic syntax check)
6. **File count:** `find src/Clients/ -name "*.php" | wc -l` returns 7 (4 Models + 2 Repos + 1 Helper)
7. **Directory structure matches:**
   ```
   src/Clients/
   ├── Helpers/ViewHelpers.php
   ├── Models/ClientsModel.php
   ├── Models/LocationsModel.php
   ├── Models/SitesModel.php
   ├── Models/ClientCommunicationsModel.php
   ├── Repositories/ClientRepository.php
   └── Repositories/LocationRepository.php
   ```
</verification>

<success_criteria>
- WeCoza\Clients\ namespace registered in PSR-4 autoloader
- config/clients.php returns SETA options, validation rules, province/status options
- All 4 Models extend BaseModel, use wecoza_db() exclusively, zero DatabaseService references
- Both Repositories extend BaseRepository with column whitelisting
- ViewHelpers migrated with correct namespace
- All PHP files pass syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/21-foundation-architecture/21-01-SUMMARY.md`
</output>
