---
phase: 47-regulatory-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Repositories/LearnerProgressionRepository.php
  - src/Learners/Ajax/ProgressionAjaxHandlers.php
autonomous: true
requirements: [REG-01, REG-02, REG-03, REG-04]

must_haves:
  truths:
    - "AJAX endpoint returns flat progression rows filtered by date range (start_date/end_date)"
    - "Each row contains all Umalusi/DHET fields: learner name, SA ID/passport, LP/product name, class code, client name, employer, start date, completion date, hours_trained, hours_present, hours_absent, status, portfolio indicator"
    - "CSV export endpoint streams a file download with proper Content-Type and Content-Disposition headers"
    - "CSV output includes header row and all compliance columns without manual post-processing"
  artifacts:
    - path: "src/Learners/Repositories/LearnerProgressionRepository.php"
      provides: "findForRegulatoryExport() method with date-range filter and full compliance columns"
      contains: "function findForRegulatoryExport"
    - path: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      provides: "handle_get_regulatory_report and handle_export_regulatory_csv handlers"
      contains: "function handle_get_regulatory_report"
  key_links:
    - from: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      to: "src/Learners/Repositories/LearnerProgressionRepository.php"
      via: "findForRegulatoryExport() call"
      pattern: "findForRegulatoryExport"
---

<objective>
Add the backend data layer for the Phase 47 regulatory export feature: a repository query method returning all compliance-required columns with date-range filtering, a JSON AJAX endpoint for populating the report table, and a CSV streaming AJAX endpoint for file download.

Purpose: Enables admin to query progressions by date range and export to CSV with all fields required for Umalusi/DHET regulatory submissions.
Output: Two new repository methods, two new AJAX handlers registered in the existing handler block.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Learners/Repositories/LearnerProgressionRepository.php
@src/Learners/Ajax/ProgressionAjaxHandlers.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add findForRegulatoryExport() repository method</name>
  <files>src/Learners/Repositories/LearnerProgressionRepository.php</files>
  <action>
Add a new public method `findForRegulatoryExport(array $filters = []): array` to `LearnerProgressionRepository`.

The method follows the same pattern as the existing `findForReport()` but:

1. **Query** — 6-table JOIN (lpt + class_type_subjects + learners + classes + clients + employers) returning all compliance-required columns:
   - `l.first_name`, `l.surname` (separate columns for regulatory forms)
   - `l.sa_id_no`, `l.passport_number` (national ID for DHET)
   - `cts.subject_name` AS `lp_name`, `cts.subject_code` AS `lp_code`
   - `cts.subject_duration` AS `lp_duration_hours`
   - `c.class_code`
   - `cl.client_name`
   - `emp.employer_name`
   - `lpt.start_date`, `lpt.completion_date`
   - `lpt.hours_trained`, `lpt.hours_present`, `lpt.hours_absent`
   - `lpt.status`
   - `CASE WHEN lpt.portfolio_file_path IS NOT NULL THEN 'Yes' ELSE 'No' END AS portfolio_submitted`
   - `lpt.created_at`, `lpt.updated_at`

2. **Filters** — Uses the same explicit PDO::PARAM_INT/PARAM_STR binding pattern as `findForReport()`:
   - `date_from` (string, YYYY-MM-DD): `lpt.start_date >= :date_from` (PARAM_STR)
   - `date_to` (string, YYYY-MM-DD): `lpt.start_date <= :date_to` (PARAM_STR)
   - `status` (string): `lpt.status = :status` (PARAM_STR)
   - `client_id` (int): `cl.client_id = :client_id` (PARAM_INT)

3. **ORDER BY** — `cl.client_name, emp.employer_name, l.surname, l.first_name, lpt.start_date`

4. **Error handling** — Same try/catch pattern returning empty array on failure, with error_log.

Also add a companion method `getRegulatoryExportCount(array $filters = []): int` that uses the same JOIN/filter logic but returns `COUNT(*)` — this will be used by the frontend to show record count before export.
  </action>
  <verify>
    <automated>cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core && grep -c "function findForRegulatoryExport\|function getRegulatoryExportCount" src/Learners/Repositories/LearnerProgressionRepository.php</automated>
    <manual>Both methods exist and follow the established pattern</manual>
  </verify>
  <done>findForRegulatoryExport() returns flat rows with all compliance columns filtered by date range; getRegulatoryExportCount() returns total matching count</done>
</task>

<task type="auto">
  <name>Task 2: Add regulatory report and CSV export AJAX handlers</name>
  <files>src/Learners/Ajax/ProgressionAjaxHandlers.php</files>
  <action>
Add two new handler functions to ProgressionAjaxHandlers.php and register them in `register_progression_ajax_handlers()`.

**Handler 1: `handle_get_regulatory_report()`**
- Uses `verify_learner_access('learners_nonce')` then `current_user_can('manage_options')` check (same as existing report handler)
- Reads filters from `$_GET`: `date_from`, `date_to`, `status`, `client_id`
- Validates date format with regex `^\d{4}-\d{2}-\d{2}$` before passing to filter array
- Validates status against `$allowedStatuses = ['in_progress', 'completed', 'on_hold']`
- Validates client_id with `intval()`
- Calls `$repository->findForRegulatoryExport($filters)` for data rows
- Calls `$repository->getRegulatoryExportCount($filters)` for total count
- Returns via `wp_send_json_success(['rows' => $data, 'total' => $count])`

**Handler 2: `handle_export_regulatory_csv()`**
- Uses `verify_learner_access('learners_nonce')` then `current_user_can('manage_options')` check
- Reads same filters from `$_GET` with same validation
- Calls `$repository->findForRegulatoryExport($filters)`
- Sets headers: `Content-Type: text/csv; charset=utf-8`, `Content-Disposition: attachment; filename="progression-export-{Y-m-d}.csv"`, `Pragma: no-cache`, `Expires: 0`
- Opens `php://output` stream
- Writes BOM (`\xEF\xBB\xBF`) for Excel UTF-8 compatibility
- Writes CSV header row: First Name, Surname, SA ID Number, Passport Number, Programme Code, Programme Name, Programme Duration (Hours), Class Code, Client, Employer, Start Date, Completion Date, Hours Trained, Hours Present, Hours Absent, Status, Portfolio Submitted
- Iterates rows, writing each via `fputcsv()` with columns mapped from query result keys
- Calls `exit` after stream complete (no wp_send_json — raw file output)

**Registration** — Add to `register_progression_ajax_handlers()`:
```php
add_action('wp_ajax_get_regulatory_report', __NAMESPACE__ . '\handle_get_regulatory_report');
add_action('wp_ajax_export_regulatory_csv', __NAMESPACE__ . '\handle_export_regulatory_csv');
```
  </action>
  <verify>
    <automated>cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core && grep -c "handle_get_regulatory_report\|handle_export_regulatory_csv\|get_regulatory_report\|export_regulatory_csv" src/Learners/Ajax/ProgressionAjaxHandlers.php</automated>
    <manual>Both handlers registered and follow established security pattern</manual>
  </verify>
  <done>get_regulatory_report returns JSON with rows+total; export_regulatory_csv streams a CSV file download with all Umalusi/DHET compliance columns</done>
</task>

</tasks>

<verification>
1. `grep "findForRegulatoryExport\|getRegulatoryExportCount" src/Learners/Repositories/LearnerProgressionRepository.php` shows 2+ matches
2. `grep "handle_get_regulatory_report\|handle_export_regulatory_csv" src/Learners/Ajax/ProgressionAjaxHandlers.php` shows 4+ matches (function definitions + registrations)
3. No PHP syntax errors: `php -l src/Learners/Repositories/LearnerProgressionRepository.php && php -l src/Learners/Ajax/ProgressionAjaxHandlers.php`
</verification>

<success_criteria>
- Repository method returns flat rows with all 17 compliance columns filtered by date range
- JSON endpoint returns rows + total count for frontend table rendering
- CSV endpoint streams a downloadable file with BOM, header row, and all compliance data
- Both handlers enforce admin capability check
- Date parameters validated before use in query
</success_criteria>

<output>
After completion, create `.planning/phases/47-regulatory-export/47-01-SUMMARY.md`
</output>
