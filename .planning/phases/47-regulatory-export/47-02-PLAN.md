---
phase: 47-regulatory-export
plan: 02
type: execute
wave: 2
depends_on: [47-01]
files_modified:
  - src/Learners/Shortcodes/regulatory-export-shortcode.php
  - views/learners/regulatory-export.php
  - assets/js/learners/regulatory-export.js
  - wecoza-core.php
autonomous: false
requirements: [REG-01, REG-02, REG-03, REG-04]

must_haves:
  truths:
    - "Admin sees a date-range picker (from/to) and can filter the regulatory report by month or custom range"
    - "Report table displays all compliance columns: name, ID, programme, class, client, employer, dates, hours, status, portfolio"
    - "Admin clicks Export CSV and a .csv file downloads containing the currently filtered data"
    - "Report is accessible via [wecoza_regulatory_export] shortcode"
    - "No manual post-processing needed — exported CSV matches Umalusi/DHET field expectations"
  artifacts:
    - path: "src/Learners/Shortcodes/regulatory-export-shortcode.php"
      provides: "Shortcode registration with script enqueue and AJAX localization"
      contains: "wecoza_regulatory_export"
    - path: "views/learners/regulatory-export.php"
      provides: "View template with date-range filter, client dropdown, status filter, report table, export button"
      contains: "regulatory-export-container"
    - path: "assets/js/learners/regulatory-export.js"
      provides: "jQuery IIFE module wiring filters, table rendering, and CSV download"
      contains: "regulatory-export"
    - path: "wecoza-core.php"
      provides: "require_once for the new shortcode file"
      contains: "regulatory-export-shortcode.php"
  key_links:
    - from: "assets/js/learners/regulatory-export.js"
      to: "wp_ajax_get_regulatory_report"
      via: "jQuery AJAX GET request"
      pattern: "get_regulatory_report"
    - from: "assets/js/learners/regulatory-export.js"
      to: "wp_ajax_export_regulatory_csv"
      via: "window.location redirect for file download"
      pattern: "export_regulatory_csv"
    - from: "src/Learners/Shortcodes/regulatory-export-shortcode.php"
      to: "views/learners/regulatory-export.php"
      via: "wecoza_view() call"
      pattern: "wecoza_view.*regulatory-export"
---

<objective>
Build the complete frontend for the regulatory export feature: a WordPress shortcode, a Phoenix-styled view template with date-range filter and data table, and a JavaScript module that wires AJAX data loading and CSV download.

Purpose: Gives admin a dedicated page to generate, preview, and export compliance-ready progression reports for Umalusi/DHET submissions.
Output: New shortcode [wecoza_regulatory_export], view template, JS module, and shortcode registration in wecoza-core.php.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/47-regulatory-export/47-01-SUMMARY.md
@src/Learners/Shortcodes/progression-report-shortcode.php
@views/learners/progression-report.php
@assets/js/learners/progression-report.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shortcode, view template, and register in wecoza-core.php</name>
  <files>
    src/Learners/Shortcodes/regulatory-export-shortcode.php
    views/learners/regulatory-export.php
    wecoza-core.php
  </files>
  <action>
**Shortcode file** (`src/Learners/Shortcodes/regulatory-export-shortcode.php`):
Follow exact pattern of `progression-report-shortcode.php`:
- Namespace `WeCoza\Learners\Shortcodes`
- Function `wecoza_regulatory_export_shortcode(): string`
- Enqueue `regulatory-export-script` from `assets/js/learners/regulatory-export.js` with `['jquery']` dependency
- Localize as `regulatoryExportAjax` with `ajaxurl` and `nonce` (wp_create_nonce('learners_nonce'))
- Return `wecoza_view('learners/regulatory-export', [])`
- Register shortcode `wecoza_regulatory_export`

**View template** (`views/learners/regulatory-export.php`):
Follow Phoenix pattern established in `progression-report.php`:

1. Container `#regulatory-export-container`
2. Alert container `#reg-alert`
3. Loading spinner `#reg-loading` (same pattern as report)
4. Main content `#reg-content` (hidden until JS loads):

   a. **Header row** — "Regulatory Progressions Export" with `bi-file-earmark-spreadsheet` icon

   b. **Filter card** (card shadow-none border mb-3) containing a row with:
      - Date From: `<input type="date" id="reg-date-from">` with label (col-md-3)
      - Date To: `<input type="date" id="reg-date-to">` with label (col-md-3)
      - Client filter: `<select id="reg-client-filter">` with "All Clients" default (col-md-3)
      - Status filter: `<select id="reg-status-filter">` with All/In Progress/Completed/On Hold options (col-md-2)
      - Generate button: `<button id="btn-reg-generate">` btn-phoenix-primary (col-md-1)

   c. **Action bar** (d-flex justify-content-between align-items-center mb-3):
      - Left: record count `<span id="reg-record-count">0 records</span>`
      - Right: Export CSV button `<button id="btn-reg-export-csv">` btn-phoenix-secondary with `bi-download` icon, disabled by default

   d. **Results table** — responsive Bootstrap table in a card:
      ```html
      <div class="table-responsive">
        <table class="table table-sm table-hover mb-0" id="reg-table">
          <thead class="table-light">
            <tr>
              <th>First Name</th>
              <th>Surname</th>
              <th>SA ID</th>
              <th>Programme</th>
              <th>Class Code</th>
              <th>Client</th>
              <th>Employer</th>
              <th>Start Date</th>
              <th>Completion Date</th>
              <th>Hours Trained</th>
              <th>Hours Present</th>
              <th>Hours Absent</th>
              <th>Status</th>
              <th>Portfolio</th>
            </tr>
          </thead>
          <tbody id="reg-table-body">
            <!-- JS populates -->
          </tbody>
        </table>
      </div>
      ```

   e. **Empty state** `#reg-empty` (d-none) — "No progressions found for the selected date range."

**wecoza-core.php** — Add `require_once` for the new shortcode file directly after the progression-report-shortcode.php require_once line (around line 629):
```php
// Regulatory export shortcode [wecoza_regulatory_export]
require_once WECOZA_CORE_PATH .
    "src/Learners/Shortcodes/regulatory-export-shortcode.php";
```
  </action>
  <verify>
    <automated>cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core && php -l src/Learners/Shortcodes/regulatory-export-shortcode.php && php -l views/learners/regulatory-export.php && grep -c "regulatory-export-shortcode" wecoza-core.php</automated>
    <manual>Shortcode file, view template, and registration all present</manual>
  </verify>
  <done>Shortcode [wecoza_regulatory_export] registered, view template renders filter card + table shell + export button, shortcode loaded in wecoza-core.php</done>
</task>

<task type="auto">
  <name>Task 2: Create regulatory export JavaScript module</name>
  <files>assets/js/learners/regulatory-export.js</files>
  <action>
Create `assets/js/learners/regulatory-export.js` as a jQuery IIFE module following the exact pattern of `progression-report.js` and `progression-admin.js`.

**Structure:**
```javascript
(function($) {
    'use strict';

    const cfg = window.regulatoryExportAjax || {};
    let currentData = [];

    // --- Init ---
    $(initRegulatoryExport);

    function initRegulatoryExport() { ... }
    function bindEvents() { ... }
    function fetchReport() { ... }
    function renderTable(rows) { ... }
    function populateClientDropdown(rows) { ... }
    function handleExportCsv() { ... }
    function statusBadge(status) { ... }
    function showLoading() { ... }
    function hideLoading() { ... }
    function showAlert(msg, type) { ... }
})(jQuery);
```

**initRegulatoryExport():**
- Set default date range: `reg-date-from` = first day of previous month, `reg-date-to` = last day of previous month (YYYY-MM-DD format)
- Call `bindEvents()`
- Call `fetchReport()` to auto-load with defaults
- After first fetch, reveal `#reg-content` and hide `#reg-loading`

**bindEvents():**
- `#btn-reg-generate` click -> `fetchReport()`
- `#btn-reg-export-csv` click -> `handleExportCsv()`
- Enter key on date inputs -> `fetchReport()`

**fetchReport():**
- Read values from `#reg-date-from`, `#reg-date-to`, `#reg-client-filter`, `#reg-status-filter`
- Validate that both dates are set (show alert if missing)
- jQuery AJAX GET to `cfg.ajaxurl` with action `get_regulatory_report`, nonce, and filter params
- On success: store `response.data.rows` in `currentData`, update `#reg-record-count` with `response.data.total`, call `renderTable(currentData)`, enable/disable export button based on total > 0
- On first successful load: call `populateClientDropdown(currentData)` once (guard flag)
- On error: `showAlert()` with error message

**renderTable(rows):**
- Clear `#reg-table-body`
- If no rows: show `#reg-empty`, hide table card, return
- Hide `#reg-empty`, show table card
- For each row, append `<tr>` with cells mapped:
  - `first_name`, `surname`
  - `sa_id_no` (show passport_number if sa_id_no empty)
  - `lp_name` (with `lp_code` in parentheses if present)
  - `class_code`
  - `client_name`
  - `employer_name` (or "—" if null)
  - `start_date` (formatted, or "—")
  - `completion_date` (formatted, or "—")
  - `hours_trained` (or "0")
  - `hours_present` (or "0")
  - `hours_absent` (or "0")
  - Status badge via `statusBadge(status)`
  - `portfolio_submitted` ("Yes"/"No")

**populateClientDropdown(rows):**
- Extract unique client_name values from rows
- Sort alphabetically
- Append `<option>` elements to `#reg-client-filter`
- Guard flag `clientDropdownPopulated` to prevent re-population

**handleExportCsv():**
- Build URL: `cfg.ajaxurl?action=export_regulatory_csv&nonce={nonce}&date_from=...&date_to=...&status=...&client_id=...`
- Use `window.location.href = url` to trigger file download (browser handles Content-Disposition)

**statusBadge(status):**
- Reuse the same badge mapping pattern from progression-admin.js:
  - `in_progress` -> `badge badge-phoenix badge-phoenix-info` "In Progress"
  - `completed` -> `badge badge-phoenix badge-phoenix-success` "Completed"
  - `on_hold` -> `badge badge-phoenix badge-phoenix-warning` "On Hold"
  - default -> `badge badge-phoenix badge-phoenix-secondary` with raw status

**showLoading/hideLoading:** Toggle `#reg-loading` visibility and `#reg-content` d-none class.

**showAlert(msg, type):** Insert Bootstrap alert into `#reg-alert`, auto-dismiss after 5 seconds.
  </action>
  <verify>
    <automated>cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core && test -f assets/js/learners/regulatory-export.js && grep -c "fetchReport\|handleExportCsv\|renderTable\|populateClientDropdown" assets/js/learners/regulatory-export.js</automated>
    <manual>JS module follows established IIFE pattern with all required functions</manual>
  </verify>
  <done>JavaScript module wires date-range filter form to AJAX endpoint, renders compliance data table, and triggers CSV download via URL redirect</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify regulatory export end-to-end</name>
  <files>views/learners/regulatory-export.php</files>
  <action>
Human verification of the complete regulatory export feature.

What was built: Complete regulatory export feature — shortcode page with date-range filter, compliance data table, and CSV export.

How to verify:
1. Navigate to the WordPress page with [wecoza_regulatory_export] shortcode
2. Verify the page loads with default date range (previous month) and auto-fetches data
3. Change date range and click Generate — table should update with filtered results
4. Verify all compliance columns are visible: names, ID, programme, class, client, employer, dates, hours, status, portfolio
5. Click "Export CSV" and verify a .csv file downloads
6. Open the CSV file and confirm: header row matches table columns, data is correctly formatted, UTF-8 encoding works in Excel
7. Verify the exported data includes all fields needed for Umalusi/DHET submission without manual editing

Resume signal: Type "approved" or describe any issues.
  </action>
  <verify>User confirms all verification steps pass</verify>
  <done>Admin has verified the regulatory export page loads, filters work, table displays compliance data, and CSV downloads correctly</done>
</task>

</tasks>

<verification>
1. Shortcode registered: `grep "wecoza_regulatory_export" wecoza-core.php` returns match
2. All files exist: shortcode, view, JS
3. No PHP syntax errors: `php -l` on all PHP files
4. JS module has all required functions
5. CSV download works with correct headers and content
</verification>

<success_criteria>
- Admin can visit [wecoza_regulatory_export] page and see a date-range filtered report
- Report table shows all Umalusi/DHET required fields
- "Export CSV" downloads a properly formatted CSV file
- CSV includes BOM for Excel compatibility and correct column headers
- No manual post-processing needed for regulatory submission
</success_criteria>

<output>
After completion, create `.planning/phases/47-regulatory-export/47-02-SUMMARY.md`
</output>
