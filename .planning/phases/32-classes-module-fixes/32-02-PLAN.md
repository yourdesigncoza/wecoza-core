---
phase: 32-classes-module-fixes
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - src/Classes/Repositories/ClassRepository.php
autonomous: true

must_haves:
  truths:
    - "Agents dropdown shows current active agents from the agents DB table, not hardcoded names"
    - "Supervisors dropdown shows current active agents marked as supervisors from DB, not hardcoded names"
    - "Agent/supervisor lists are cached via WordPress transients to avoid repeated DB queries"
    - "Existing class views still display correct agent and supervisor names"
  artifacts:
    - path: "src/Classes/Repositories/ClassRepository.php"
      provides: "DB-backed getAgents() and getSupervisors() with transient caching"
      contains: "wecoza_db"
  key_links:
    - from: "ClassRepository::getAgents()"
      to: "agents table"
      via: "PDO query with transient cache"
      pattern: "SELECT.*FROM agents"
    - from: "ClassRepository::getSupervisors()"
      to: "agents table"
      via: "PDO query with transient cache"
      pattern: "SELECT.*FROM agents"
    - from: "ClassRepository::getSingleClass()"
      to: "ClassRepository::getAgents()"
      via: "Agent name lookup"
      pattern: "getAgents"
---

<objective>
Migrate ClassRepository::getAgents() and getSupervisors() from hardcoded static arrays to live database queries against the agents table, with WordPress transient caching for performance.

Purpose: Ensure class forms reflect the actual agents in the system rather than a stale hardcoded list of 15 agents and 5 supervisors that drift from reality as agents are added/renamed/deactivated.
Output: ClassRepository.php with DB-backed agent and supervisor lookups.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-classes-module-fixes/32-RESEARCH.md
@.planning/phases/32-classes-module-fixes/32-01-SUMMARY.md
@src/Classes/Repositories/ClassRepository.php
@src/Agents/Models/AgentModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace static getAgents() and getSupervisors() with DB queries (CLS-08)</name>
  <files>src/Classes/Repositories/ClassRepository.php</files>
  <action>
Replace both static array methods with DB queries using the pattern from `ClassRepository::getLearners()` (which already uses transient caching).

**Replace getAgents() (lines 419-438):**
```php
public static function getAgents(): array
{
    $cache_key = 'wecoza_class_agents';
    $cached = get_transient($cache_key);
    if ($cached !== false) {
        return $cached;
    }

    try {
        $db = wecoza_db();
        $sql = "SELECT agent_id, first_name, surname
                FROM agents
                WHERE status = 'active'
                ORDER BY surname, first_name";
        $stmt = $db->query($sql);

        $agents = [];
        while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
            $agents[] = [
                'id' => (int)$row['agent_id'],
                'name' => sanitize_text_field($row['first_name'] . ' ' . $row['surname'])
            ];
        }

        set_transient($cache_key, $agents, 12 * HOUR_IN_SECONDS);
        return $agents;
    } catch (\Exception $e) {
        error_log('WeCoza Core: Error fetching agents for class form: ' . $e->getMessage());
        return [];
    }
}
```

**Replace getSupervisors() (lines 443-452):**
Supervisors are also agents. The agents table has a `role` or similar field. Query agents who can supervise. If the agents table does not have a supervisor flag/role column, query ALL active agents as potential supervisors (since currently it's just a subset of agents). Check the agents table schema first.

If agents table has NO supervisor-specific column, use the same query as getAgents() but with a different cache key:
```php
public static function getSupervisors(): array
{
    $cache_key = 'wecoza_class_supervisors';
    $cached = get_transient($cache_key);
    if ($cached !== false) {
        return $cached;
    }

    try {
        $db = wecoza_db();
        // Supervisors are drawn from the same agents pool
        // If a dedicated supervisor role/flag exists in the agents table, add WHERE clause
        $sql = "SELECT agent_id, first_name, surname
                FROM agents
                WHERE status = 'active'
                ORDER BY surname, first_name";
        $stmt = $db->query($sql);

        $supervisors = [];
        while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) {
            $supervisors[] = [
                'id' => (int)$row['agent_id'],
                'name' => sanitize_text_field($row['first_name'] . ' ' . $row['surname'])
            ];
        }

        set_transient($cache_key, $supervisors, 12 * HOUR_IN_SECONDS);
        return $supervisors;
    } catch (\Exception $e) {
        error_log('WeCoza Core: Error fetching supervisors for class form: ' . $e->getMessage());
        return [];
    }
}
```

**Before implementing:** Check the agents table schema to determine if there is a `role`, `is_supervisor`, or similar column. Run:
```bash
grep -n 'supervisor\|role' src/Agents/Models/AgentModel.php
grep -n 'supervisor\|role' src/Agents/Repositories/AgentRepository.php
```

If a supervisor distinction exists in the schema, add `WHERE role = 'supervisor'` or similar to the getSupervisors() query. If not, both methods query all active agents (which is better than hardcoded data regardless).

**Important:** The return format MUST match the current format `['id' => int, 'name' => string]` because `getSingleClass()` (line 639-663) iterates these arrays for name lookups. Do NOT change the return structure.

**Also:** Add `use \PDO;` at the top of the file if not already imported (check existing imports).
  </action>
  <verify>
1. `php -l src/Classes/Repositories/ClassRepository.php` — no syntax errors
2. `grep -n 'wecoza_db' src/Classes/Repositories/ClassRepository.php` — should show DB calls in getAgents() and getSupervisors()
3. `grep -n 'get_transient' src/Classes/Repositories/ClassRepository.php` — should show cache lookups in both methods
4. `grep -c "Michael M. van der Berg\|Dr. Sarah Johnson" src/Classes/Repositories/ClassRepository.php` — should return 0 (no hardcoded names)
5. `grep -n "\\['id'.*=>.*\\(int\\).*'name'" src/Classes/Repositories/ClassRepository.php` — should show array structure matches original format
  </verify>
  <done>
getAgents() and getSupervisors() query the agents table directly instead of returning hardcoded arrays. Results cached via WordPress transients (12-hour TTL). Return format unchanged (array of ['id' => int, 'name' => string]). No hardcoded agent or supervisor names remain. getSingleClass() agent/supervisor name lookups continue to work because return format is identical.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Classes/Repositories/ClassRepository.php` passes
2. Zero hardcoded agent/supervisor names in ClassRepository.php
3. Both methods use `wecoza_db()` for database queries
4. Both methods use `get_transient()`/`set_transient()` for caching
5. Return format is `[['id' => int, 'name' => string], ...]` matching original structure
6. `getSingleClass()` still works (uses getAgents()/getSupervisors() for name lookup — same interface)
</verification>

<success_criteria>
- CLS-08: getAgents() queries agents table with transient cache, returns active agents
- CLS-08: getSupervisors() queries agents table with transient cache, returns active agents/supervisors
- No hardcoded agent or supervisor names in ClassRepository.php
- Cache keys: wecoza_class_agents, wecoza_class_supervisors with 12-hour TTL
- Return format backward-compatible with getSingleClass() and all view templates
- PHP lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/32-classes-module-fixes/32-02-SUMMARY.md`
</output>
