---
phase: 32-classes-module-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Classes/Services/FormDataProcessor.php
  - src/Classes/Repositories/ClassRepository.php
  - src/Classes/Controllers/QAController.php
  - views/classes/components/class-capture-partials/update-class.php
autonomous: true

must_haves:
  truths:
    - "order_nr survives round-trip from DB to form to DB on class update"
    - "New classes have class_agent set from initial_class_agent when class_agent is empty"
    - "QA write endpoints reject unauthenticated requests (no nopriv)"
    - "stop_dates/restart_dates are sanitized and validated as YYYY-MM-DD before storage"
    - "site_id is cast to integer via intval() like client_id"
    - "learner_ids and exam_learners contain only positive integers after JSON decode"
    - "backup_agent_dates are validated as YYYY-MM-DD format"
    - "initial_class_agent dropdown pre-selects from initial_class_agent value, not class_agent"
  artifacts:
    - path: "src/Classes/Services/FormDataProcessor.php"
      provides: "Input sanitization for all form fields"
      contains: "intval.*site_id"
    - path: "src/Classes/Repositories/ClassRepository.php"
      provides: "order_nr in getSingleClass result array"
      contains: "order_nr.*getOrderNr"
    - path: "src/Classes/Controllers/QAController.php"
      provides: "Authenticated-only QA write endpoints"
    - path: "views/classes/components/class-capture-partials/update-class.php"
      provides: "Correct initial_class_agent pre-selection"
      contains: "initial_class_agent.*selected"
  key_links:
    - from: "ClassRepository::getSingleClass()"
      to: "update-class.php form"
      via: "order_nr field in result array"
      pattern: "order_nr.*getOrderNr"
    - from: "FormDataProcessor::processFormData()"
      to: "ClassModel::save()"
      via: "class_agent initialization from initial_class_agent"
      pattern: "class_agent.*initial_class_agent"
---

<objective>
Fix 8 surgical bugs in Classes module: reverse path data loss (order_nr), initialization bug (class_agent), security gaps (nopriv QA endpoints), input sanitization gaps (dates, IDs, site_id), and view pre-selection error (initial_class_agent dropdown).

Purpose: Prevent silent data loss on class updates, harden QA endpoints against unauthenticated access, ensure all user input is validated before DB storage.
Output: Four modified files with all CLS-01 through CLS-07 and CLS-09 requirements resolved.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-classes-module-fixes/32-RESEARCH.md
@docs/formfieldanalysis/classes-audit.md
@src/Classes/Services/FormDataProcessor.php
@src/Classes/Repositories/ClassRepository.php
@src/Classes/Controllers/QAController.php
@views/classes/components/class-capture-partials/update-class.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: FormDataProcessor input sanitization fixes (CLS-02, CLS-04, CLS-05, CLS-06, CLS-09)</name>
  <files>src/Classes/Services/FormDataProcessor.php</files>
  <action>
Five targeted fixes in FormDataProcessor::processFormData():

**CLS-05 — site_id intval() (line 34):**
Change `$processed['site_id'] = isset($data['site_id']) && !is_array($data['site_id']) ? $data['site_id'] : null;`
To: `$processed['site_id'] = isset($data['site_id']) && !empty($data['site_id']) ? intval($data['site_id']) : null;`
This matches the `client_id` pattern on line 33. The `sites` table uses integer `site_id`.

**CLS-02 — class_agent initialization (after line 67):**
After the existing lines that set `$processed['class_agent']` (line 66) and `$processed['initial_class_agent']` (line 67), add:
```php
// CLS-02: Initialize class_agent from initial_class_agent on create
if (empty($processed['class_agent']) && !empty($processed['initial_class_agent'])) {
    $processed['class_agent'] = $processed['initial_class_agent'];
}
```
This ensures new classes don't start with null class_agent.

**CLS-06 — learner_ids sanitization (line 82):**
Change `$learnerIds = $learnerData;`
To: `$learnerIds = array_filter(array_map('intval', $learnerData), fn($id) => $id > 0);`
Also apply same pattern for exam_learners (line 91-92):
Change `$examLearners = $examLearnerData;`
To: `$examLearners = array_filter(array_map('intval', $examLearnerData), fn($id) => $id > 0);`

**CLS-04 — stop_dates/restart_dates sanitization (lines 140-146):**
Replace the loop body (lines 141-146) with:
```php
if (!empty($stopDates[$i]) && isset($restartDates[$i]) && !empty($restartDates[$i])) {
    $stopDate = self::sanitizeText($stopDates[$i]);
    $restartDate = self::sanitizeText($restartDates[$i]);
    if (self::isValidDate($stopDate) && self::isValidDate($restartDate)) {
        $stopRestartDates[] = [
            'stop_date' => $stopDate,
            'restart_date' => $restartDate
        ];
    }
}
```
This applies the same pattern used in `validateExceptionDates()` (line 519-533).

**CLS-09 — backup_agent_dates validation (line 107):**
Change `'date' => isset($agentDates[$i]) ? $agentDates[$i] : ''`
To: `'date' => isset($agentDates[$i]) && self::isValidDate(self::sanitizeText($agentDates[$i])) ? self::sanitizeText($agentDates[$i]) : ''`
This validates backup agent dates use YYYY-MM-DD format.
  </action>
  <verify>
Run `php -l src/Classes/Services/FormDataProcessor.php` to confirm no syntax errors.
Then grep to confirm changes:
- `grep -n 'intval.*site_id' src/Classes/Services/FormDataProcessor.php` — should show intval cast
- `grep -n 'initial_class_agent' src/Classes/Services/FormDataProcessor.php` — should show initialization logic
- `grep -n "array_map.*intval.*learnerData" src/Classes/Services/FormDataProcessor.php` — should show ID sanitization
- `grep -n 'isValidDate.*stopDate' src/Classes/Services/FormDataProcessor.php` — should show date validation
- `grep -n 'isValidDate.*agentDates' src/Classes/Services/FormDataProcessor.php` — should show backup date validation
  </verify>
  <done>
All five sanitization fixes applied: site_id uses intval(), class_agent initialized from initial_class_agent on create, learner_ids/exam_learners filtered to positive integers, stop/restart dates validated with isValidDate(), backup_agent_dates validated with isValidDate(). PHP lint passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Repository reverse path, QA security, and view pre-selection fixes (CLS-01, CLS-03, CLS-07)</name>
  <files>
    src/Classes/Repositories/ClassRepository.php
    src/Classes/Controllers/QAController.php
    views/classes/components/class-capture-partials/update-class.php
  </files>
  <action>
Three fixes in three separate files:

**CLS-01 — order_nr reverse path (ClassRepository.php, getSingleClass method around line 624):**
Add `'order_nr' => $classModel->getOrderNr(),` to the `$result` array in `getSingleClass()`. Insert it after the `'updated_at'` line (line 624) and before the closing `];`. The field is already in the SQL query (line 566) and the allowed columns list (line 73), and the ClassModel has `getOrderNr()`. It's only missing from the result array assembly.

**CLS-03 — Remove nopriv from QA write endpoints (QAController.php, lines 42, 44, 48, 52):**
Remove these four lines from the `initialize()` method:
- Line 42: `add_action('wp_ajax_nopriv_create_qa_visit', [$this, 'createQAVisit']);`
- Line 44: `add_action('wp_ajax_nopriv_export_qa_reports', [$this, 'exportQAReports']);`
- Line 48: `add_action('wp_ajax_nopriv_delete_qa_report', [$this, 'deleteQAReport']);`
- Line 52: `add_action('wp_ajax_nopriv_submit_qa_question', [$this, 'submitQAQuestion']);`

Keep the nopriv lines for READ-ONLY endpoints (get_qa_analytics, get_qa_summary, get_qa_visits, get_class_qa_data) as those are acceptable for public data.

**CLS-07 — initial_class_agent pre-selection (update-class.php, line 1509):**
Change: `$data['class_data']['class_agent']` (appears twice on line 1509)
To: `$data['class_data']['initial_class_agent']`

The line should read:
```php
<option value="<?php echo $agent['id']; ?>" <?php echo (isset($data['class_data']['initial_class_agent']) && $data['class_data']['initial_class_agent'] == $agent['id']) ? 'selected' : ''; ?>><?php echo $agent['name']; ?></option>
```

The field is named `initial_class_agent` but was pre-selecting based on `class_agent` value — semantically wrong.
  </action>
  <verify>
Run syntax checks on all three files:
- `php -l src/Classes/Repositories/ClassRepository.php`
- `php -l src/Classes/Controllers/QAController.php`
- `php -l views/classes/components/class-capture-partials/update-class.php`

Then confirm:
- `grep -n 'order_nr.*getOrderNr' src/Classes/Repositories/ClassRepository.php` — should show new line in getSingleClass
- `grep -c 'wp_ajax_nopriv_create_qa_visit\|wp_ajax_nopriv_export_qa_reports\|wp_ajax_nopriv_delete_qa_report\|wp_ajax_nopriv_submit_qa_question' src/Classes/Controllers/QAController.php` — should return 0
- `grep -n 'initial_class_agent.*selected' views/classes/components/class-capture-partials/update-class.php` — should show corrected pre-selection
  </verify>
  <done>
order_nr included in getSingleClass() result array (no more silent data loss on update). Four QA write endpoint nopriv registrations removed (create, delete, export, submit). initial_class_agent dropdown pre-selects from initial_class_agent value instead of class_agent. All PHP files pass lint.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Classes/Services/FormDataProcessor.php` passes
2. `php -l src/Classes/Repositories/ClassRepository.php` passes
3. `php -l src/Classes/Controllers/QAController.php` passes
4. `php -l views/classes/components/class-capture-partials/update-class.php` passes
5. `grep -c 'wp_ajax_nopriv_create_qa_visit' src/Classes/Controllers/QAController.php` returns 0
6. `grep 'order_nr.*getOrderNr' src/Classes/Repositories/ClassRepository.php` shows the new line
7. `grep 'intval.*site_id' src/Classes/Services/FormDataProcessor.php` shows intval cast
8. `grep 'isValidDate.*stopDate' src/Classes/Services/FormDataProcessor.php` shows date validation
</verification>

<success_criteria>
- CLS-01: order_nr in getSingleClass() result — no data loss on update
- CLS-02: class_agent initialized from initial_class_agent on create
- CLS-03: 4 nopriv QA write registrations removed
- CLS-04: stop_dates/restart_dates sanitized and date-validated
- CLS-05: site_id cast with intval()
- CLS-06: learner_ids/exam_learners filtered to positive integers
- CLS-07: initial_class_agent dropdown uses correct field for pre-selection
- CLS-09: backup_agent_dates validated as YYYY-MM-DD
- All 4 files pass PHP lint
</success_criteria>

<output>
After completion, create `.planning/phases/32-classes-module-fixes/32-01-SUMMARY.md`
</output>
