---
phase: 36-service-layer-extraction
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Agents/Services/AgentService.php
  - src/Agents/Controllers/AgentsController.php
  - src/Agents/Ajax/AgentsAjaxHandlers.php
autonomous: true

must_haves:
  truths:
    - "AgentService contains all agent creation workflow, form data collection, file upload handling, and validation orchestration"
    - "AgentsController shortcode methods are thin — load data via service, pass to view"
    - "AgentsController has no form submission handling inline — service does it"
    - "AgentsAjaxHandlers delegates pagination and delete logic to AgentService"
    - "All existing AJAX endpoints return identical responses (backward compatible)"
  artifacts:
    - path: "src/Agents/Services/AgentService.php"
      provides: "Agent CRUD workflow, form data collection/sanitization, file uploads, validation orchestration"
      contains: "class AgentService"
    - path: "src/Agents/Controllers/AgentsController.php"
      provides: "Thin controller with shortcode rendering delegating to AgentService"
      contains: "AgentService"
    - path: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      provides: "AJAX handlers delegating to AgentService"
      contains: "AgentService"
  key_links:
    - from: "src/Agents/Controllers/AgentsController.php"
      to: "src/Agents/Services/AgentService.php"
      via: "lazy property"
      pattern: "agentService"
    - from: "src/Agents/Ajax/AgentsAjaxHandlers.php"
      to: "src/Agents/Services/AgentService.php"
      via: "property injection"
      pattern: "agentService"
---

<objective>
Extract agent business logic from AgentsController and AgentsAjaxHandlers into a dedicated AgentService class.

Purpose: The AgentsController currently contains heavy inline form submission handling (~95 lines in renderCaptureForm), data collection/sanitization (~70 lines in collectFormData), file upload logic, and field processing helpers. AgentsAjaxHandlers duplicates pagination query building and statistics fetching. AgentService will own all this business logic. SVC-02.

Output: AgentService.php with all agent business logic; AgentsController.php reduced to thin shortcode rendering and asset enqueuing; AgentsAjaxHandlers.php reduced to security + delegation.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Agents/Controllers/AgentsController.php
@src/Agents/Ajax/AgentsAjaxHandlers.php
@src/Agents/Repositories/AgentRepository.php
@src/Agents/Models/AgentModel.php
@src/Agents/Services/WorkingAreasService.php
@src/Agents/Services/AgentDisplayService.php
@src/Agents/Helpers/FormHelpers.php
@core/Abstract/BaseController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgentService with extracted business logic</name>
  <files>src/Agents/Services/AgentService.php</files>
  <action>
Create `src/Agents/Services/AgentService.php` in namespace `WeCoza\Agents\Services`.

The service must encapsulate ALL business logic currently in AgentsController and AgentsAjaxHandlers:

1. **Agent CRUD** — methods that wrap repository:
   - `getAgent(int $agentId): ?array` — delegates to `AgentRepository::getAgent()`
   - `getAgents(array $args): array` — delegates to `AgentRepository::getAgents()`, maps via `AgentDisplayService::mapAgentFields()`
   - `countAgents(array $args): int` — delegates to `AgentRepository::countAgents()`
   - `deleteAgent(int $agentId): bool` — delegates to `AgentRepository::deleteAgent()`

2. **Form submission workflow** — extract the entire POST handling block from `renderCaptureForm()`:
   - `handleAgentFormSubmission(array $postData, array $filesData, ?int $agentId = null, ?array $currentAgent = null): array`
   - Returns `['success' => bool, 'agent_id' => int|null, 'errors' => array, 'agent' => array|null]`
   - Internally: calls `collectFormData()`, validates via `AgentModel`, saves via repository, handles file uploads
   - This is the big extraction (~50 lines of inline logic from renderCaptureForm)

3. **Form data collection** — move from controller:
   - `collectFormData(array $postData): array` — the ~70-line method that sanitizes all agent form fields
   - `processTextField(string $value): ?string`
   - `processDateField(string $dateValue): ?string`
   - `processNumericField(string $value): ?int`

4. **File upload handling** — move from controller:
   - `handleFileUploads(int $agentId, array $filesData, ?array $currentAgent): array`
   - `uploadFile(string $fieldName, int $agentId, array $filesData): ?string`

5. **Pagination response assembly** — extract from AgentsAjaxHandlers::handlePagination():
   - `getPaginatedAgents(int $page, int $perPage, string $search, string $orderby, string $order): array`
   - Returns `['agents' => array, 'total_agents' => int, 'total_pages' => int, 'start_index' => int, 'end_index' => int, 'statistics' => array]`
   - Internally uses AgentDisplayService for field mapping, sort column mapping, statistics

Constructor: instantiate AgentRepository.

```php
class AgentService
{
    private AgentRepository $repository;

    public function __construct()
    {
        $this->repository = new AgentRepository();
    }
}
```

Use `declare(strict_types=1)` and proper PHPDoc. Follow ProgressionService patterns.

NOTE: `AgentDisplayService` and `WorkingAreasService` remain separate — AgentService uses them as collaborators, not absorbing them.
  </action>
  <verify>
Run `php -l src/Agents/Services/AgentService.php` — syntax OK.
Grep for `class AgentService` — exists.
Verify public methods: getAgent, getAgents, countAgents, deleteAgent, handleAgentFormSubmission, collectFormData, getPaginatedAgents, handleFileUploads.
  </verify>
  <done>
AgentService.php exists with all agent business logic: CRUD, form submission workflow, data collection/sanitization, file uploads, and pagination assembly. PHP syntax valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor AgentsController and AgentsAjaxHandlers to use AgentService</name>
  <files>
src/Agents/Controllers/AgentsController.php
src/Agents/Ajax/AgentsAjaxHandlers.php
  </files>
  <action>
**AgentsController refactor:**

1. Add `private ?AgentService $agentService = null;` property with lazy getter `getAgentService(): AgentService`.
2. Remove `private ?AgentRepository $repository = null;` and `getRepository()` method — service owns repository.
3. Add `use WeCoza\Agents\Services\AgentService;` import.

4. **Refactor `renderCaptureForm()`** — currently ~95 lines. After refactor:
   ```php
   public function renderCaptureForm(array|string $atts = []): string
   {
       if (!current_user_can('edit_others_posts')) {
           return '<div class="alert alert-subtle-danger">...</div>';
       }
       $atts = shortcode_atts([...], $atts);
       $agent_id = $this->detectAgentIdFromUrl($atts);
       $mode = $this->determineFormMode($agent_id, $atts);
       $agent = null;
       $errors = [];
       $current_agent = null;

       if ($mode === 'edit' && $agent_id > 0) {
           $current_agent = $this->getAgentService()->getAgent($agent_id);
           if (!$current_agent) {
               return '<div class="alert alert-subtle-danger">...</div>';
           }
           $agent = $current_agent;
       }

       // Handle form submission via service
       if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['wecoza_agents_form_nonce']) && !wp_doing_ajax()) {
           if (!wp_verify_nonce($_POST['wecoza_agents_form_nonce'], 'submit_agent_form')) {
               $errors['general'] = __('Security check failed.', 'wecoza-core');
           } else {
               $result = $this->getAgentService()->handleAgentFormSubmission(
                   $_POST, $_FILES, $agent_id > 0 ? $agent_id : null, $current_agent
               );
               if ($result['success']) {
                   if (!empty($atts['redirect_after_save'])) {
                       wp_safe_redirect($atts['redirect_after_save']);
                       exit;
                   }
                   $agent = $result['agent'];
                   $current_agent = $agent;
               } else {
                   $errors = $result['errors'];
                   $agent = $result['submitted_data'] ?? $agent;
               }
           }
       }

       $working_areas = WorkingAreasService::get_working_areas();
       return $this->render('agents/components/agent-capture-form', [...], true);
   }
   ```
   Target: under 50 lines. All validation, save, file upload logic delegated to service.

5. **Refactor `renderAgentsList()`** — delegate query building and stats to service:
   ```php
   $paginationData = $this->getAgentService()->getPaginatedAgents(
       $current_page, $per_page, $search_query, $sort_column, $sort_order
   );
   ```
   Then pass $paginationData fields to view. Controller only parses shortcode atts and $_GET params.

6. **Refactor `renderSingleAgent()`** — use `$this->getAgentService()->getAgent($agent_id)` instead of `$this->getRepository()->getAgent($agent_id)`.

7. **Remove methods moved to service:**
   - `collectFormData()`, `processTextField()`, `processDateField()`, `processNumericField()`
   - `handleFileUploads()`, `uploadFile()`
8. **Keep in controller** (presentation/routing helpers):
   - `detectAgentIdFromUrl()`, `determineFormMode()`, `getEditUrl()`, `getViewUrl()`, `getBackUrl()`
   - `enqueueAssets()`, `shouldEnqueueAssets()`, `registerShortcodes()`

**AgentsAjaxHandlers refactor:**

1. Add `private AgentService $agentService;` property, initialized in constructor.
2. Remove `private AgentRepository $repository;` — service owns repository.
3. Add `use WeCoza\Agents\Services\AgentService;` import.

4. **Refactor `handlePagination()`** — delegate to service:
   ```php
   public function handlePagination(): void
   {
       AjaxSecurity::requireNonce('agents_nonce_action');
       try {
           $page = AjaxSecurity::post('page', 'int', 1);
           $per_page = AjaxSecurity::post('per_page', 'int', 10);
           $search = AjaxSecurity::post('search', 'string', '');
           $orderby = AjaxSecurity::post('orderby', 'string', 'surname');
           $order = strtoupper(AjaxSecurity::post('order', 'string', 'ASC'));
           if (!in_array($order, ['ASC', 'DESC'])) { $order = 'ASC'; }

           $data = $this->agentService->getPaginatedAgents($page, $per_page, $search, $orderby, $order);

           // Render HTML (presentation stays in handler)
           ob_start();
           wecoza_view('agents/display/agent-display-table-rows', [...], false);
           $table_html = ob_get_clean();
           // ... pagination_html, statistics_html same pattern

           AjaxSecurity::sendSuccess([...]);
       } catch (\Throwable $e) {
           wecoza_log('Error loading agents: ' . $e->getMessage(), 'error');
           AjaxSecurity::sendError(__('An error occurred while loading agents.', 'wecoza-core'), 500);
       }
   }
   ```

5. **Refactor `handleDelete()`** — use `$this->agentService->deleteAgent($agent_id)`.

6. Keep `getStatisticsHtml()` in handlers (it's presentation/HTML rendering).

**CRITICAL: Backward compatibility** — AJAX action names (`wecoza_agents_paginate`, `wecoza_agents_delete`) must remain unchanged. Response structures must be identical.

**Target: No method exceeds 100 lines.** `renderCaptureForm` target: ~45 lines. `handlePagination` target: ~50 lines.
  </action>
  <verify>
Run `php -l src/Agents/Controllers/AgentsController.php` and `php -l src/Agents/Ajax/AgentsAjaxHandlers.php` — both pass.
Grep AgentsController for `AgentService` — found.
Grep AgentsController for `AgentRepository` — NOT found (removed).
Grep AgentsController for `collectFormData\|processTextField\|processDateField\|processNumericField\|handleFileUploads\|uploadFile` — NOT found (moved to service).
Grep AgentsAjaxHandlers for `AgentService` — found.
Count lines of renderCaptureForm — under 60 lines.
  </verify>
  <done>
AgentsController and AgentsAjaxHandlers delegate all business logic to AgentService. Controller has no form data collection, no file upload handling, no validation orchestration. AJAX handlers delegate CRUD and pagination to service. No method exceeds 100 lines. All AJAX endpoints unchanged.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Agents/Services/AgentService.php` — syntax OK
2. `php -l src/Agents/Controllers/AgentsController.php` — syntax OK
3. `php -l src/Agents/Ajax/AgentsAjaxHandlers.php` — syntax OK
4. Grep for `class AgentService` — exists
5. AgentsController no longer has: collectFormData, processTextField, processDateField, processNumericField, handleFileUploads, uploadFile
6. AgentsController no longer references AgentRepository directly
7. AgentsAjaxHandlers no longer references AgentRepository directly
8. AJAX action names `wecoza_agents_paginate` and `wecoza_agents_delete` unchanged
</verification>

<success_criteria>
- AgentService.php exists with 8+ public methods covering all agent business logic
- AgentsController `renderCaptureForm()` under 60 lines (was ~95)
- All form data collection/sanitization, file upload, and validation logic in AgentService
- AgentsAjaxHandlers delegates pagination data assembly and delete to AgentService
- AJAX endpoints return identical response formats
- No method exceeds 100 lines
</success_criteria>

<output>
After completion, create `.planning/phases/36-service-layer-extraction/36-02-SUMMARY.md`
</output>
