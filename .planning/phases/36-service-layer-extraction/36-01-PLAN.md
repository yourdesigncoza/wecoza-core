---
phase: 36-service-layer-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Services/LearnerService.php
  - src/Learners/Controllers/LearnerController.php
  - src/Learners/Ajax/LearnerAjaxHandlers.php
autonomous: true

must_haves:
  truths:
    - "LearnerService contains all learner CRUD orchestration and dropdown data logic"
    - "LearnerController methods are thin — validate, delegate to service, respond"
    - "LearnerAjaxHandlers delegate to LearnerService instead of LearnerController for business logic"
    - "All existing AJAX endpoints return identical responses (backward compatible)"
  artifacts:
    - path: "src/Learners/Services/LearnerService.php"
      provides: "Learner CRUD orchestration, dropdown data assembly, sponsor/portfolio management"
      contains: "class LearnerService"
    - path: "src/Learners/Controllers/LearnerController.php"
      provides: "Thin controller with shortcode rendering and AJAX handlers"
      contains: "LearnerService"
    - path: "src/Learners/Ajax/LearnerAjaxHandlers.php"
      provides: "AJAX handlers delegating to LearnerService"
      contains: "LearnerService"
  key_links:
    - from: "src/Learners/Controllers/LearnerController.php"
      to: "src/Learners/Services/LearnerService.php"
      via: "constructor injection or lazy property"
      pattern: "learnerService"
    - from: "src/Learners/Ajax/LearnerAjaxHandlers.php"
      to: "src/Learners/Services/LearnerService.php"
      via: "instantiation in handler functions"
      pattern: "LearnerService"
---

<objective>
Extract learner business logic from LearnerController and LearnerAjaxHandlers into a dedicated LearnerService class.

Purpose: Establish the service layer pattern for the Learners module. Controllers become thin routing — all CRUD orchestration, dropdown assembly, and data transformation logic moves to LearnerService. This is the simplest extraction (SVC-01) and establishes the pattern for Agent and Client services.

Output: LearnerService.php with all business logic; LearnerController.php and LearnerAjaxHandlers.php reduced to validate-delegate-respond pattern.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Learners/Controllers/LearnerController.php
@src/Learners/Ajax/LearnerAjaxHandlers.php
@src/Learners/Services/ProgressionService.php
@src/Learners/Repositories/LearnerRepository.php
@src/Learners/Models/LearnerModel.php
@core/Abstract/BaseController.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LearnerService with extracted business logic</name>
  <files>src/Learners/Services/LearnerService.php</files>
  <action>
Create `src/Learners/Services/LearnerService.php` in namespace `WeCoza\Learners\Services`.

The service must encapsulate ALL business logic currently spread across LearnerController and LearnerAjaxHandlers:

1. **CRUD orchestration** — move these methods from LearnerController:
   - `getLearner(int $id): ?LearnerModel` — delegates to `LearnerModel::getById()`
   - `getLearners(int $limit, int $offset): array` — delegates to `LearnerModel::getAll()`
   - `getLearnersWithMappings(): array` — delegates to `LearnerModel::getAllWithMappings()`
   - `getLearnerCount(): int` — delegates to `LearnerModel::count()`
   - `createLearner(array $data): ?LearnerModel` — instantiate model, save, return
   - `updateLearner(int $id, array $data): bool` — find, hydrate, update
   - `deleteLearner(int $id): bool` — find, delete

2. **Dropdown data assembly** — move `getDropdownData()` from LearnerController including the placement level splitting logic (N* for numeracy, C* for communication).

3. **Portfolio/Sponsor management** — proxy methods:
   - `savePortfolios(int $learnerId, array $files): array`
   - `deletePortfolio(int $portfolioId): bool`
   - `getSponsors(int $learnerId): array`
   - `saveSponsors(int $learnerId, array $employerIds): bool`

4. **Table row generation** — move `generate_learner_table_rows()` function from LearnerAjaxHandlers.php into a method `generateTableRowsHtml(array $learners): string`. This is presentation-adjacent but is business logic (field mapping, URL generation).

Constructor takes LearnerRepository (lazy-loaded internally, same pattern as ProgressionService).

Follow the existing ProgressionService pattern:
```php
class LearnerService
{
    private LearnerRepository $repository;

    public function __construct()
    {
        $this->repository = new LearnerRepository();
    }
    // ... methods
}
```

Use `declare(strict_types=1)` and proper PHPDoc on all public methods.
  </action>
  <verify>
Run `php -l src/Learners/Services/LearnerService.php` to verify syntax.
Grep for `class LearnerService` to confirm existence.
Verify public methods exist: getLearner, getLearners, getLearnersWithMappings, getLearnerCount, createLearner, updateLearner, deleteLearner, getDropdownData, savePortfolios, deletePortfolio, getSponsors, saveSponsors, generateTableRowsHtml.
  </verify>
  <done>
LearnerService.php exists with all business logic methods extracted from LearnerController and LearnerAjaxHandlers. PHP syntax valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor LearnerController and LearnerAjaxHandlers to use LearnerService</name>
  <files>
src/Learners/Controllers/LearnerController.php
src/Learners/Ajax/LearnerAjaxHandlers.php
  </files>
  <action>
**LearnerController refactor:**

1. Add `private ?LearnerService $learnerService = null;` property and lazy getter `getLearnerService(): LearnerService`.
2. Remove the `$repository` property and `getRepository()` method — service handles repository access.
3. Remove ALL business logic methods that were moved to LearnerService:
   - `getLearner()`, `getLearners()`, `getLearnersWithMappings()`, `getLearnerCount()`
   - `createLearner()`, `updateLearner()`, `deleteLearner()`
   - `getDropdownData()`, `savePortfolios()`, `deletePortfolio()`, `getSponsors()`, `saveSponsors()`
4. Refactor AJAX handlers to follow thin pattern:
   ```php
   public function ajaxGetLearner(): void
   {
       if (!current_user_can('manage_learners')) {
           $this->sendError('Insufficient permissions.', 403);
           return;
       }
       $this->requireNonce('learners_nonce');
       $id = $this->input('id', 'int') ?? $this->query('id', 'int');
       if (!$id) {
           $this->sendError('Invalid learner ID');
           return;
       }
       $learner = $this->getLearnerService()->getLearner($id);
       if ($learner) {
           $this->sendSuccess($learner->toArray());
       } else {
           $this->sendError('Learner not found');
       }
   }
   ```
5. Refactor `ajaxGetLearners()` and `ajaxUpdateLearner()` and `ajaxDeleteLearner()` similarly — delegate to service.
6. Shortcode renderers (`renderCaptureForm`, `renderLearnerList`, `renderUpdateForm`) call service instead of internal methods.
7. Add `use WeCoza\Learners\Services\LearnerService;` import.

**LearnerAjaxHandlers refactor:**

1. Replace `get_learner_controller()` with a `get_learner_service(): LearnerService` function.
2. In `handle_update_learner()`: call `get_learner_service()->updateLearner($learner_id, $data)` instead of `get_learner_controller()->updateLearner(...)`.
3. In `handle_delete_learner()`: call `get_learner_service()->deleteLearner($learner_id)`.
4. In `handle_fetch_learners_data()`: call `get_learner_service()->getLearnersWithMappings()` and `get_learner_service()->generateTableRowsHtml(...)`.
5. In `handle_fetch_dropdown_data()`: call `get_learner_service()->getDropdownData()`.
6. In `handle_portfolio_deletion()`: call `get_learner_service()->deletePortfolio(...)`.
7. Remove the `generate_learner_table_rows()` function (moved to service).
8. Add `use WeCoza\Learners\Services\LearnerService;` import.

**CRITICAL: Backward compatibility** — All AJAX action names (`update_learner`, `delete_learner`, `fetch_learners_data`, `fetch_learners_dropdown_data`, `delete_learner_portfolio`) must remain unchanged. Response format must be identical.

**Target: No controller/handler method exceeds 100 lines.** Each follows: validate input -> call service -> format response.
  </action>
  <verify>
Run `php -l src/Learners/Controllers/LearnerController.php` and `php -l src/Learners/Ajax/LearnerAjaxHandlers.php` — both must pass.
Grep LearnerController.php for `LearnerService` — must find import and usage.
Grep LearnerAjaxHandlers.php for `LearnerService` — must find import and usage.
Grep LearnerController.php for `LearnerRepository` — should NOT find direct usage (removed).
Count lines of each AJAX handler method — none should exceed 100 lines.
  </verify>
  <done>
LearnerController and LearnerAjaxHandlers delegate all business logic to LearnerService. No method exceeds 100 lines. AJAX endpoints unchanged. PHP syntax valid for both files.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Learners/Services/LearnerService.php` — syntax OK
2. `php -l src/Learners/Controllers/LearnerController.php` — syntax OK
3. `php -l src/Learners/Ajax/LearnerAjaxHandlers.php` — syntax OK
4. Grep for `class LearnerService` in Services directory — exists
5. Grep LearnerController for direct `LearnerModel::` static calls — should be minimal (only in service now)
6. Grep LearnerController for `LearnerRepository` — should not appear (service owns repository)
7. No AJAX action names changed (backward compatible)
</verification>

<success_criteria>
- LearnerService.php exists with 12+ public methods covering all learner business logic
- LearnerController has zero business logic — only validates, delegates, responds
- LearnerAjaxHandlers delegates to LearnerService, not LearnerController for business ops
- All 5 AJAX endpoints (`update_learner`, `delete_learner`, `fetch_learners_data`, `fetch_learners_dropdown_data`, `delete_learner_portfolio`) return identical response formats
- No method in controller or handlers exceeds 100 lines
</success_criteria>

<output>
After completion, create `.planning/phases/36-service-layer-extraction/36-01-SUMMARY.md`
</output>
