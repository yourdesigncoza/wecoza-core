---
phase: 07-email-notifications
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - tests/Events/EmailNotificationTest.php
autonomous: true

must_haves:
  truths:
    - "Test verifies cron hook is registered for email notifications"
    - "Test verifies NotificationProcessor::boot() returns valid instance"
    - "Test verifies NotificationSettings returns configured recipients"
    - "Test verifies NotificationEmailPresenter renders HTML (not JSON)"
    - "Test verifies admin settings page registers email fields"
  artifacts:
    - path: "tests/Events/EmailNotificationTest.php"
      provides: "Comprehensive verification test suite for EMAIL-01 through EMAIL-04"
      min_lines: 150
  key_links:
    - from: "tests/Events/EmailNotificationTest.php"
      to: "NotificationProcessor"
      via: "class_exists and boot() call"
      pattern: "NotificationProcessor::boot"
    - from: "tests/Events/EmailNotificationTest.php"
      to: "wp_filter"
      via: "cron hook verification"
      pattern: "wecoza_email_notifications_process"
---

<objective>
Create verification test suite for email notification functionality.

Purpose: Verify all EMAIL-01 through EMAIL-04 requirements are satisfied. The NotificationProcessor, NotificationSettings, and SettingsPage already exist from Phase 1 migration. Plan 07-01 added cron integration. This test suite proves the complete system works end-to-end.

Output: Comprehensive test file at tests/Events/EmailNotificationTest.php following MaterialTrackingTest pattern
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-notifications/07-RESEARCH.md
@.planning/phases/07-email-notifications/07-01-SUMMARY.md

# Test pattern reference
@tests/Events/MaterialTrackingTest.php

# Classes to verify
@src/Events/Services/NotificationProcessor.php
@src/Events/Services/NotificationSettings.php
@src/Events/Views/Presenters/NotificationEmailPresenter.php
@src/Events/Admin/SettingsPage.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email notification verification test suite</name>
  <files>tests/Events/EmailNotificationTest.php</files>
  <action>
Create a comprehensive test file following the MaterialTrackingTest.php pattern. The test must verify all EMAIL requirements:

**EMAIL-01**: Automated email notifications on class INSERT events
**EMAIL-02**: Automated email notifications on class UPDATE events
**EMAIL-03**: WordPress cron integration for scheduled notifications
**EMAIL-04**: Configurable notification recipients

Test sections to include:

1. **Cron Registration Tests (EMAIL-03)**
   - Test cron hook wecoza_email_notifications_process is registered
   - Test cron event is scheduled
   - Test cron handler calls NotificationProcessor

2. **Service Tests (EMAIL-01, EMAIL-02)**
   - Test NotificationProcessor::boot() returns valid instance
   - Test NotificationProcessor can process without errors
   - Test NotificationSettings::getRecipientForOperation() for INSERT
   - Test NotificationSettings::getRecipientForOperation() for UPDATE
   - Test NotificationEmailPresenter::present() returns valid structure

3. **Settings Integration Tests (EMAIL-04)**
   - Test SettingsPage registers email fields
   - Test wecoza_notification_class_created option is settable
   - Test wecoza_notification_class_updated option is settable
   - Test sanitization of email addresses

4. **Template Tests**
   - Test email-summary.php template file exists
   - Test NotificationEmailPresenter uses correct path
   - Test presenter output is HTML (not JSON fallback)

Include the same test_result() function pattern, WordPress bootstrap, and result summary as MaterialTrackingTest.php.

Run command: wp eval-file tests/Events/EmailNotificationTest.php --path=/opt/lampp/htdocs/wecoza
  </action>
  <verify>
1. File exists: tests/Events/EmailNotificationTest.php
2. php -l tests/Events/EmailNotificationTest.php returns no syntax errors
3. grep -c "test_result" tests/Events/EmailNotificationTest.php shows multiple test assertions
4. File contains tests for EMAIL-01, EMAIL-02, EMAIL-03, EMAIL-04
  </verify>
  <done>
- Test file created at tests/Events/EmailNotificationTest.php
- Tests cover all EMAIL requirements
- Test follows MaterialTrackingTest pattern
- Test can be run via WP-CLI
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute test suite and verify all tests pass</name>
  <files>tests/Events/EmailNotificationTest.php</files>
  <action>
Run the email notification test suite and ensure all tests pass.

Execute:
```bash
wp eval-file tests/Events/EmailNotificationTest.php --path=/opt/lampp/htdocs/wecoza
```

If any tests fail:
1. Diagnose the failure from the error message
2. If it's a test bug, fix the test
3. If it's an infrastructure bug, document for gap closure

Expected result: All tests pass (0 failures)

Note: Tests may need to temporarily set WordPress options for recipient testing. Clean up any test options after tests complete.
  </action>
  <verify>
Test output shows:
- Total tests > 15
- 0 failures
- All EMAIL requirements have passing tests
  </verify>
  <done>
- All tests pass
- EMAIL-01 through EMAIL-04 requirements verified
- No regressions in existing functionality
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Run full test suite:
```bash
wp eval-file tests/Events/EmailNotificationTest.php --path=/opt/lampp/htdocs/wecoza
```

2. Verify test count and pass rate:
- Expected: 15+ tests
- Expected: 100% pass rate

3. Cross-reference with requirements:
- EMAIL-01: INSERT notification test passes
- EMAIL-02: UPDATE notification test passes
- EMAIL-03: Cron integration tests pass
- EMAIL-04: Settings configuration tests pass
</verification>

<success_criteria>
1. Test file exists and has no syntax errors
2. All tests pass (0 failures)
3. Tests explicitly verify EMAIL-01, EMAIL-02, EMAIL-03, EMAIL-04
4. Test output format matches MaterialTrackingTest pattern
5. Cron hook verified as registered
6. NotificationProcessor verified as functional
7. Settings verified as configurable
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-notifications/07-02-SUMMARY.md`
</output>
