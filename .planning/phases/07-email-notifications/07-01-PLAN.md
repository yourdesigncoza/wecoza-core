---
phase: 07-email-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wecoza-core.php
  - src/Events/Views/Presenters/NotificationEmailPresenter.php
autonomous: true

must_haves:
  truths:
    - "Email notification cron fires on schedule"
    - "NotificationProcessor::process() is called by cron handler"
    - "Email templates render HTML (not JSON fallback)"
  artifacts:
    - path: "wecoza-core.php"
      provides: "Cron hook registration and scheduling for email notifications"
      contains: "wecoza_email_notifications_process"
    - path: "src/Events/Views/Presenters/NotificationEmailPresenter.php"
      provides: "Fixed template path using wecoza_plugin_path()"
      contains: "wecoza_plugin_path"
  key_links:
    - from: "wecoza-core.php"
      to: "NotificationProcessor::process()"
      via: "add_action cron hook"
      pattern: "add_action.*wecoza_email_notifications_process"
    - from: "NotificationEmailPresenter.php"
      to: "views/events/event-tasks/email-summary.php"
      via: "wecoza_plugin_path()"
      pattern: "wecoza_plugin_path.*email-summary"
---

<objective>
Register WP-Cron hook for email notifications and fix template path bug.

Purpose: Enable automated email notifications when classes are created or updated. The NotificationProcessor service is already fully implemented but not wired to cron. The template presenter references an undefined constant causing JSON fallback instead of HTML emails.

Output: Working cron registration in wecoza-core.php and fixed template path in NotificationEmailPresenter.php
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-email-notifications/07-RESEARCH.md

# Key existing files
@wecoza-core.php
@src/Events/Services/NotificationProcessor.php
@src/Events/Views/Presenters/NotificationEmailPresenter.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register cron hook and scheduling for email notifications</name>
  <files>wecoza-core.php</files>
  <action>
Add email notification cron integration to wecoza-core.php following the exact pattern used for material notifications:

1. In the plugins_loaded hook (after line ~234, after material notification cron handler), add:
```php
// Email Notification Cron Handler
add_action('wecoza_email_notifications_process', function () {
    if (!class_exists(\WeCoza\Events\Services\NotificationProcessor::class)) {
        return;
    }

    $processor = \WeCoza\Events\Services\NotificationProcessor::boot();
    $processor->process();
});
```

2. In the activation hook (after line ~331, after material notification scheduling), add:
```php
// Schedule email notification cron if not already scheduled
if (!wp_next_scheduled('wecoza_email_notifications_process')) {
    wp_schedule_event(time(), 'hourly', 'wecoza_email_notifications_process');
}
```

3. In the deactivation hook (after line ~356, after material notification unscheduling), add:
```php
// Unschedule email notification cron
$emailTimestamp = wp_next_scheduled('wecoza_email_notifications_process');
if ($emailTimestamp) {
    wp_unschedule_event($emailTimestamp, 'wecoza_email_notifications_process');
}
```

Use hourly schedule (not daily) for timely notifications - material notifications use daily because they're advance warnings, but email notifications should be more timely.
  </action>
  <verify>
1. grep -n "wecoza_email_notifications_process" wecoza-core.php shows 3 occurrences (handler, schedule, unschedule)
2. php -l wecoza-core.php returns no syntax errors
  </verify>
  <done>
- Cron action hook registered for wecoza_email_notifications_process
- Hourly cron event scheduled during plugin activation
- Cron event properly unscheduled during plugin deactivation
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix template path in NotificationEmailPresenter</name>
  <files>src/Events/Views/Presenters/NotificationEmailPresenter.php</files>
  <action>
Fix the template path bug identified in the research. The presenter references undefined constant WECOZA_EVENTS_PLUGIN_DIR.

In NotificationEmailPresenter.php, line 55, change:
```php
$template = WECOZA_EVENTS_PLUGIN_DIR . 'includes/Views/event-tasks/email-summary.php';
```

To:
```php
$template = wecoza_plugin_path('views/events/event-tasks/email-summary.php');
```

This uses the established wecoza_plugin_path() helper function which correctly resolves to WECOZA_CORE_PATH.

Also add the function import at the top of the file (after the existing use statements around line ~17):
```php
use function wecoza_plugin_path;
```

Note: The function wecoza_plugin_path() is defined in core/Helpers/functions.php and is available in the global namespace, so the use statement is optional but good practice for clarity.
  </action>
  <verify>
1. grep "wecoza_plugin_path" src/Events/Views/Presenters/NotificationEmailPresenter.php shows the new path
2. grep -v "WECOZA_EVENTS_PLUGIN_DIR" src/Events/Views/Presenters/NotificationEmailPresenter.php confirms old constant removed
3. php -l src/Events/Views/Presenters/NotificationEmailPresenter.php returns no syntax errors
4. File views/events/event-tasks/email-summary.php exists (verify template will be found)
  </verify>
  <done>
- Template path uses wecoza_plugin_path() instead of undefined constant
- Email templates will render HTML instead of falling back to JSON
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Verify cron hook is registered:
```bash
wp eval "global \$wp_filter; echo isset(\$wp_filter['wecoza_email_notifications_process']) ? 'CRON HOOK: OK' : 'CRON HOOK: MISSING';" --path=/opt/lampp/htdocs/wecoza
```

2. Manually trigger cron to verify no errors:
```bash
wp cron event run wecoza_email_notifications_process --path=/opt/lampp/htdocs/wecoza 2>&1 | head -5
```

3. Verify template path resolves correctly:
```bash
wp eval "echo file_exists(wecoza_plugin_path('views/events/event-tasks/email-summary.php')) ? 'TEMPLATE: OK' : 'TEMPLATE: MISSING';" --path=/opt/lampp/htdocs/wecoza
```
</verification>

<success_criteria>
1. Cron hook wecoza_email_notifications_process is registered
2. Cron event is scheduled hourly during plugin activation
3. NotificationEmailPresenter uses correct template path
4. Template file is found (not JSON fallback)
5. No PHP syntax errors in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/07-email-notifications/07-01-SUMMARY.md`
</output>
