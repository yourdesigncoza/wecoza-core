---
phase: 22-client-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wecoza-core.php
  - src/Clients/Controllers/ClientsController.php
  - src/Clients/Controllers/LocationsController.php
  - src/Clients/Models/ClientsModel.php
  - src/Clients/Models/SitesModel.php
  - src/Clients/Models/LocationsModel.php
  - src/Clients/Models/ClientCommunicationsModel.php
  - src/Clients/Ajax/ClientAjaxHandlers.php
  - core/Database/PostgresConnection.php
  - views/clients/components/client-capture-form.view.php
  - views/clients/display/clients-table.view.php
autonomous: true

must_haves:
  truths:
    - "WordPress loads without PHP fatal errors from Clients module"
    - "[wecoza_capture_clients] renders client creation form with all fields"
    - "[wecoza_display_clients] renders clients table with existing data"
    - "[wecoza_update_clients] renders pre-populated edit form for existing client"
  artifacts:
    - path: "src/Clients/Controllers/ClientsController.php"
      provides: "3 shortcodes rendering without errors"
    - path: "src/Clients/Controllers/LocationsController.php"
      provides: "3 location shortcodes rendering without errors"
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "15 AJAX endpoints registered and responding"
  key_links:
    - from: "wecoza-core.php"
      to: "ClientsController, LocationsController, ClientAjaxHandlers"
      via: "class_exists + new instantiation"
      pattern: "new \\\\WeCoza\\\\Clients"
    - from: "ClientsController"
      to: "views/clients/"
      via: "wecoza_view()"
      pattern: "wecoza_view\\('clients/"
    - from: "ClientsModel"
      to: "PostgresConnection"
      via: "wecoza_db()->"
      pattern: "wecoza_db\\(\\)->"
---

<objective>
Verify and fix the complete Clients module wiring so all 6 shortcodes render without PHP errors. Phase 21 migrated all structural code; this plan systematically tests rendering and fixes integration bugs.

Purpose: Ensure the migrated Clients module renders correctly within wecoza-core architecture before testing AJAX/CRUD functionality.
Output: All 6 shortcodes render clean HTML without PHP fatal errors, warnings, or "Something went wrong" messages.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-foundation-architecture/21-01-SUMMARY.md
@.planning/phases/21-foundation-architecture/21-02-SUMMARY.md
@.planning/phases/22-client-management/22-RESEARCH.md

Key source files to reference:
@wecoza-core.php (lines 232-241 - Clients module initialization)
@src/Clients/Controllers/ClientsController.php
@src/Clients/Controllers/LocationsController.php
@src/Clients/Ajax/ClientAjaxHandlers.php
@src/Clients/Models/ClientsModel.php
@src/Clients/Models/SitesModel.php
@core/Database/PostgresConnection.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify module wiring and fix shortcode rendering errors</name>
  <files>
    wecoza-core.php
    src/Clients/Controllers/ClientsController.php
    src/Clients/Controllers/LocationsController.php
    src/Clients/Models/ClientsModel.php
    src/Clients/Models/SitesModel.php
    src/Clients/Models/LocationsModel.php
    src/Clients/Models/ClientCommunicationsModel.php
    src/Clients/Ajax/ClientAjaxHandlers.php
    core/Database/PostgresConnection.php
    views/clients/components/client-capture-form.view.php
    views/clients/components/client-update-form.view.php
    views/clients/components/location-capture-form.view.php
    views/clients/display/clients-display.view.php
    views/clients/display/clients-table.view.php
    views/clients/display/locations-list.view.php
  </files>
  <action>
    Systematically verify and fix the Clients module integration. Work through each layer:

    **Step 1: Clear debug log and verify baseline**
    - Truncate `/opt/lampp/htdocs/wecoza/wp-content/debug.log`
    - Verify wecoza-core.php initializes Clients module (lines 232-241): ClientsController, LocationsController, ClientAjaxHandlers
    - Load any WP page via WP-CLI: `wp eval "echo 'OK';"` -- confirm no fatal errors

    **Step 2: Verify class autoloading**
    - Run: `wp eval "echo class_exists('WeCoza\Clients\Controllers\ClientsController') ? 'YES' : 'NO';"` for all key classes:
      - ClientsController, LocationsController, ClientAjaxHandlers
      - ClientsModel, SitesModel, LocationsModel, ClientCommunicationsModel
      - ClientRepository, LocationRepository, ViewHelpers
    - If any class not found: check PSR-4 namespace registration in wecoza-core.php autoloader, verify file path matches namespace

    **Step 3: Verify shortcode registration**
    - Run: `wp eval "global \$shortcode_tags; echo isset(\$shortcode_tags['wecoza_capture_clients']) ? 'registered' : 'missing';"` for all 6 shortcodes:
      - wecoza_capture_clients, wecoza_display_clients, wecoza_update_clients
      - wecoza_locations_capture, wecoza_locations_list, wecoza_locations_edit
    - If missing: check registerShortcodes() called in registerHooks(), check add_action('init', ...) fires

    **Step 4: Test shortcode rendering via WP-CLI**
    - For each shortcode, render via do_shortcode and check for errors:
      ```
      wp eval "
        wp_set_current_user(1); // Admin user
        ob_start();
        echo do_shortcode('[wecoza_capture_clients]');
        \$output = ob_get_clean();
        echo strlen(\$output) > 0 ? 'Rendered (' . strlen(\$output) . ' chars)' : 'EMPTY';
      "
      ```
    - After each render, check debug.log for errors:
      - PHP Fatal errors (class not found, method not found, undefined function)
      - PHP Warnings (undefined index, array to string conversion)
      - SQL errors from PostgresConnection

    **Step 5: Fix discovered issues**
    Common issues from Phase 21 UAT (apply fixes as needed):

    a) **Column mapping failures**: ClientsModel uses `resolveColumn()` and `tableHasColumn()`. If column resolution fails, check:
       - PostgresConnection::tableHasColumn() queries information_schema correctly
       - ClientsModel::$columnCandidates has correct candidate names matching actual DB columns
       - The static $columnMapCache is properly namespaced per model (key = table name)

    b) **BaseModel conflicts**: Models do NOT extend BaseModel (intentional per Phase 21 decision). They have their own $table/$primaryKey as instance properties (not static). Verify no code assumes BaseModel inheritance.

    c) **Missing methods on PostgresConnection**: getAll(), getRow(), getValue(), insert(), update(), delete(), tableHasColumn() were added in Phase 21. Verify they exist and work:
       - `wp eval "echo method_exists(wecoza_db(), 'getAll') ? 'YES' : 'NO';"`

    d) **View template errors**: Views use `\WeCoza\Clients\Helpers\ViewHelpers::` for form rendering. If ViewHelpers methods fail:
       - Check ViewHelpers uses wecoza_config('clients') for dropdown options
       - Check config/clients.php returns expected keys (seta_options, province_options, client_status_options, validation_rules)

    e) **SitesModel location cache**: getLocationHierarchy() may fail if locations table empty or has unexpected schema. Check SQL queries in debug.log.

    f) **Capability check**: All shortcodes check `current_user_can('manage_wecoza_clients')`. Verify this capability exists for admin users. If missing, add it in wecoza-core.php activation hook or grant directly:
       - `wp eval "echo current_user_can('manage_wecoza_clients') ? 'HAS' : 'MISSING';"` (as admin)
       - If missing: `wp eval "\$admin = get_role('administrator'); \$admin->add_cap('manage_wecoza_clients');"`

    **Step 6: Verify all 6 shortcodes render cleanly**
    After fixes, re-run all 6 shortcode renders. Each must produce HTML output > 0 chars with no new debug.log errors.

    **IMPORTANT per user decisions:**
    - Preserve existing standalone plugin behavior exactly -- no redesign
    - Preserve existing manage_wecoza_clients capability checks as defense-in-depth
    - Fix integration wiring only, do not change business logic
  </action>
  <verify>
    1. `wp eval "echo 'OK';"` returns OK (no fatal errors)
    2. All 10 key classes load: `wp eval "echo class_exists('WeCoza\\Clients\\Controllers\\ClientsController') ? 'Y' : 'N';"` etc.
    3. All 6 shortcodes registered: check $shortcode_tags
    4. Each shortcode produces HTML output via do_shortcode() without fatal errors
    5. debug.log has no PHP Fatal/Warning from WeCoza\Clients namespace after rendering all shortcodes
    6. `wp eval "echo current_user_can('manage_wecoza_clients') ? 'Y' : 'N';"` returns Y for admin
  </verify>
  <done>
    All 6 shortcodes (wecoza_capture_clients, wecoza_display_clients, wecoza_update_clients, wecoza_locations_capture, wecoza_locations_list, wecoza_locations_edit) render HTML output via WP-CLI do_shortcode without PHP fatal errors or warnings. Debug log clean of Clients module errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User verifies shortcode rendering in browser</name>
  <what-built>
    All 6 Clients module shortcodes wired and rendering via wecoza-core architecture. Any integration bugs from Phase 21 migration fixed. Forms and tables should display correctly.
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    - Ensure standalone wecoza-clients-plugin is DEACTIVATED (Plugins page)
    - Ensure wecoza-core is ACTIVE

    **Test each shortcode in browser:**
    1. Visit page with `[wecoza_capture_clients]` -- Client creation form renders with company name, SETA dropdown, contact fields, province/town selects
    2. Visit page with `[wecoza_display_clients]` -- Clients table shows existing data, search box present, filters visible, pagination works
    3. Visit page with `[wecoza_update_clients]?mode=update&client_id=1` (use a real client ID) -- Form pre-populates with client data
    4. Visit page with `[wecoza_locations_capture]` -- Location form with province, town, suburb, postal code fields
    5. Visit page with `[wecoza_locations_list]` -- Locations table with search
    6. Visit page with `[wecoza_locations_edit]?location_id=1` (use a real location ID) -- Location form pre-populates

    **Also check:**
    - Browser DevTools Console: no JavaScript errors about missing wecozaClients object
    - Browser DevTools Network: JS files load from `/wp-content/plugins/wecoza-core/assets/js/clients/`
  </how-to-verify>
  <resume-signal>Type "approved" if all shortcodes render, or describe specific issues seen</resume-signal>
</task>

</tasks>

<verification>
1. `wp eval "echo do_shortcode('[wecoza_capture_clients]');" | head -1` produces HTML
2. `wp eval "echo do_shortcode('[wecoza_display_clients]');" | head -1` produces HTML
3. No PHP Fatal/Warning errors in debug.log related to Clients module
4. All 10 Clients classes load via class_exists checks
5. User confirms browser rendering (Task 2 checkpoint)
</verification>

<success_criteria>
- All 6 shortcodes render HTML output without PHP errors
- No "Something went wrong" or blank output from any shortcode
- JavaScript assets load on shortcode pages without console errors
- Debug log clean of Clients module errors
</success_criteria>

<output>
After completion, create `.planning/phases/22-client-management/22-01-SUMMARY.md`
</output>
