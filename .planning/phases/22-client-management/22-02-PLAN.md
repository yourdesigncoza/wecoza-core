---
phase: 22-client-management
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/Clients/Ajax/ClientAjaxHandlers.php
  - src/Clients/Models/ClientsModel.php
  - src/Clients/Models/SitesModel.php
  - src/Clients/Repositories/ClientRepository.php
autonomous: false

must_haves:
  truths:
    - "User can create a new client via [wecoza_capture_clients] form and it saves to database"
    - "User can edit an existing client via [wecoza_update_clients] and changes persist"
    - "User can soft-delete a client and it sets deleted_at (not hard-delete)"
    - "User can designate a client as sub-client of a main client"
    - "User can export clients list to CSV"
    - "User can view client statistics (counts by status, SETA breakdown)"
  artifacts:
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "Working AJAX endpoints for client CRUD, export, hierarchy"
    - path: "src/Clients/Models/ClientsModel.php"
      provides: "Client data operations with column mapping and validation"
    - path: "src/Clients/Repositories/ClientRepository.php"
      provides: "Client query layer with search, filter, pagination"
  key_links:
    - from: "assets/js/clients/client-capture.js"
      to: "ClientAjaxHandlers::saveClient()"
      via: "jQuery AJAX POST to wecoza_save_client"
      pattern: "action.*wecoza_save_client"
    - from: "assets/js/clients/clients-table.js"
      to: "ClientAjaxHandlers::deleteClient()"
      via: "jQuery AJAX POST to wecoza_delete_client"
      pattern: "action.*wecoza_delete_client"
    - from: "ClientAjaxHandlers::saveClient()"
      to: "ClientsModel + SitesModel"
      via: "model->save(), sitesModel->saveHeadSite()"
      pattern: "\\$model->save|\\$sitesModel->save"
    - from: "ClientAjaxHandlers::exportClients()"
      to: "ClientRepository"
      via: "repository->getAll() for CSV data"
      pattern: "exportClients|fputcsv"
---

<objective>
Verify and fix all 15 AJAX endpoints for complete client CRUD functionality: create, read, update, soft-delete, search, filter, hierarchy management, CSV export, and statistics.

Purpose: Achieve functional parity with standalone wecoza-clients-plugin within wecoza-core architecture.
Output: All client management operations work end-to-end: form submission saves data, table displays it, delete soft-removes, export generates CSV, statistics show correct counts.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-client-management/22-01-SUMMARY.md
@.planning/phases/22-client-management/22-RESEARCH.md

Key source files:
@src/Clients/Ajax/ClientAjaxHandlers.php
@src/Clients/Models/ClientsModel.php
@src/Clients/Models/SitesModel.php
@src/Clients/Repositories/ClientRepository.php
@src/Clients/Repositories/LocationRepository.php
@views/clients/display/clients-table.view.php
@assets/js/clients/client-capture.js
@assets/js/clients/clients-table.js
</context>

<tasks>

<task type="auto">
  <name>Task 1A: Test and fix core CRUD AJAX endpoints (create/read/update/delete/search/filter)</name>
  <files>
    src/Clients/Ajax/ClientAjaxHandlers.php
    src/Clients/Models/ClientsModel.php
    src/Clients/Repositories/ClientRepository.php
  </files>
  <action>
    Test the 6 core client CRUD AJAX endpoints via WP-CLI and fix any issues.

    **Step 0: Clear debug log**
    Truncate `/opt/lampp/htdocs/wecoza/wp-content/debug.log`

    **Step 1: Test client creation (wecoza_save_client)**
    Simulate AJAX call via WP-CLI:
    ```
    wp eval "
      wp_set_current_user(1);
      \$_POST = [
        'action' => 'wecoza_save_client',
        'nonce' => wp_create_nonce('clients_nonce_action'),
        'client_name' => 'Phase 22 Test Client',
        'company_registration_nr' => '2026/222222/07',
        'seta' => 'BANKSETA',
        'client_status' => 'Active Client',
        'contact_person' => 'Test Person',
        'contact_person_email' => 'test@example.com',
        'contact_person_cellphone' => '0821234567',
        'client_town_id' => 1,
        'financial_year_end' => '2026-02-28',
      ];
      // Call handler directly (not via AJAX to avoid wp_die)
      \$handler = new \WeCoza\Clients\Ajax\ClientAjaxHandlers();
    "
    ```
    - Check debug.log for errors
    - Verify client appears in database: query clients table for 'Phase 22 Test Client'
    - If save fails: check ClientsModel::save() method, column mapping, PostgresConnection::insert()

    **Step 2: Test client retrieval (wecoza_get_client)**
    - Verify ClientAjaxHandlers::getClient() returns client data for a known ID
    - Test ClientsModel::getById() returns correct fields
    - Test ClientRepository::find() if used

    **Step 3: Test client update (wecoza_save_client with existing ID)**
    - Send save request with `id` set to an existing client
    - Verify data updates in database
    - Check ClientsModel::update() method, column mapping for UPDATE queries

    **Step 4: Test soft-delete (wecoza_delete_client)**
    - Send delete request for test client
    - Verify database: client still exists with `deleted_at` timestamp set (NOT hard-deleted)
    - If hard-deleted: fix ClientAjaxHandlers::deleteClient() or ClientsModel::delete() to set deleted_at via UPDATE instead of DELETE
    - Key check: `ClientsModel::delete($id)` should do:
      ```php
      $data = ['deleted_at' => date('Y-m-d H:i:s')];
      return wecoza_db()->update($this->table, $data, "id = :id", [':id' => $id]);
      ```
      NOT `wecoza_db()->delete($this->table, ...)`

    **Step 5: Test search and filter (wecoza_search_clients)**
    - Test search with a known client name substring
    - Verify results returned as array with expected fields
    - Test that soft-deleted clients are excluded (WHERE deleted_at IS NULL)

    **Step 6: Verify JS -> AJAX connectivity for core CRUD**
    - Grep `assets/js/clients/client-capture.js` for the AJAX action name: confirm it references `wecoza_save_client` (or the value from `wecozaClients.action` matching the PHP handler)
    - Grep `assets/js/clients/clients-table.js` for `wecoza_delete_client` and `wecoza_search_clients` action names
    - Check the nonce field name matches: `wecozaClients.nonce` in JS -> `clients_nonce_action` in PHP
    - Check field names in form views match $_POST keys expected by ClientAjaxHandlers::sanitizeClientFormData()
    - If any action name mismatch found between JS and PHP, fix the JS file to use the correct action name

    **IMPORTANT per user decisions:**
    - Preserve existing behavior exactly -- fix bugs, don't redesign
    - Preserve manage_wecoza_clients capability checks
  </action>
  <verify>
    1. Client creation: `wp eval` creates client, appears in DB query
    2. Client retrieval: getById() returns correct data for known ID
    3. Client update: update persists changed fields in DB
    4. Soft-delete: deleted_at set, record still in DB, excluded from search results
    5. Search: returns matching clients, excludes soft-deleted
    6. JS action names match PHP handler names (grep confirms)
    7. No PHP errors in debug.log after all tests
  </verify>
  <done>
    Core client CRUD (create, read, update, soft-delete, search, filter) works end-to-end via WP-CLI. JS files reference correct AJAX action names and nonce field. Debug log clean.
  </done>
</task>

<task type="auto">
  <name>Task 1B: Test and fix secondary AJAX endpoints (hierarchy/export/statistics/sites/locations)</name>
  <files>
    src/Clients/Ajax/ClientAjaxHandlers.php
    src/Clients/Models/ClientsModel.php
    src/Clients/Models/SitesModel.php
    src/Clients/Models/ClientCommunicationsModel.php
    src/Clients/Repositories/ClientRepository.php
    src/Clients/Repositories/LocationRepository.php
  </files>
  <action>
    Test the remaining 9 AJAX endpoints (hierarchy, export, statistics, sites, locations) via WP-CLI and fix any issues.

    **Step 1: Test client hierarchy (wecoza_get_main_clients, wecoza_get_branch_clients)**
    - Test getMainClients: should return clients where main_client_id IS NULL
    - Test getBranchClients: given a main client ID, return sub-clients linked to it
    - Verify ClientRepository::getMainClients() and getBranchClients() queries filter correctly

    **Step 2: Test CSV export (wecoza_export_clients)**
    - Invoke exportClients() logic directly via WP-CLI to verify it produces CSV data:
      ```
      wp eval "
        wp_set_current_user(1);
        \$model = new \WeCoza\Clients\Models\ClientsModel();
        \$clients = \$model->getAll();
        // Simulate CSV generation
        \$fp = fopen('php://temp', 'w+');
        if (!empty(\$clients)) {
          fputcsv(\$fp, array_keys((array)\$clients[0]));
          foreach (\$clients as \$row) { fputcsv(\$fp, (array)\$row); }
        }
        rewind(\$fp);
        \$csv = stream_get_contents(\$fp);
        fclose(\$fp);
        echo 'CSV length: ' . strlen(\$csv) . ' bytes, rows: ' . count(\$clients);
      "
      ```
    - Verify CSV output has > 0 bytes and contains expected column headers (client_name, seta, client_status, etc.)
    - Check that the exportClients() handler in ClientAjaxHandlers.php sets Content-Type: text/csv and Content-Disposition: attachment headers

    **Step 3: Test statistics (getStatistics)**
    - Invoke getStatistics() directly via WP-CLI and verify returned structure:
      ```
      wp eval "
        wp_set_current_user(1);
        \$model = new \WeCoza\Clients\Models\ClientsModel();
        \$stats = \$model->getStatistics();
        echo 'Keys: ' . implode(', ', array_keys(\$stats)) . PHP_EOL;
        foreach (\$stats as \$key => \$val) {
          echo \$key . ': ' . (is_array(\$val) ? json_encode(\$val) : \$val) . PHP_EOL;
        }
      "
      ```
    - Verify returned array contains expected keys (e.g., total_count, status_counts, seta_counts or similar)
    - Confirm soft-deleted clients excluded from counts (WHERE deleted_at IS NULL in query)
    - Check the statistics section renders in clients-table.view.php

    **Step 4: Test site management endpoints**
    - wecoza_save_sub_site: creates sub-site under a head site
    - wecoza_get_head_sites: returns sites where parent_site_id IS NULL
    - wecoza_get_sub_sites: returns child sites for a given parent
    - wecoza_delete_sub_site: removes sub-site
    - wecoza_get_sites_hierarchy: returns full tree
    - Verify SitesModel methods work with wecoza_db()

    **Step 5: Test location endpoints**
    - wecoza_get_locations: returns location hierarchy
    - wecoza_save_location: creates new location
    - wecoza_check_location_duplicates: checks for existing similar locations

    **Step 6: Verify JS -> AJAX connectivity for secondary endpoints**
    - Grep all files in `assets/js/clients/` for AJAX action names and confirm each matches the corresponding PHP wp_ajax_ hook:
      ```
      grep -rn "action.*wecoza_" assets/js/clients/ | sort
      ```
    - Cross-reference each JS action name against the add_action('wp_ajax_...') calls in ClientAjaxHandlers.php
    - Check clients-table.js references correct action names for export (wecoza_export_clients), hierarchy, and sites operations
    - If any action name mismatch found, fix JS or PHP to align

    **IMPORTANT per user decisions:**
    - Preserve existing behavior exactly -- fix bugs, don't redesign
    - CSV export format and contents preserved as-is
  </action>
  <verify>
    1. Main/sub clients: hierarchy queries return correct parent-child relationships
    2. CSV export: WP-CLI invocation produces CSV data with correct columns and > 0 rows
    3. Statistics: getStatistics() returns array with expected keys, excludes deleted clients
    4. Sites: head/sub site CRUD works, hierarchy returns tree structure
    5. Locations: get/save/duplicate-check endpoints respond correctly
    6. JS action names match PHP handler names across all `assets/js/clients/*.js` files (grep confirms)
    7. No PHP errors in debug.log after all tests
  </verify>
  <done>
    All secondary AJAX endpoints (hierarchy, export, statistics, sites, locations) respond correctly. CSV export generates valid CSV data. Statistics return correct counts excluding deleted clients. JS files reference correct AJAX action names for all endpoints. Debug log clean.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User verifies complete client management workflow in browser (depends on Task 1A + 1B)</name>
  <what-built>
    Complete Client Management system working within wecoza-core: CRUD operations, search, filter, pagination, hierarchy, CSV export, and statistics. All AJAX endpoints verified server-side.
  </what-built>
  <how-to-verify>
    **Prerequisites:**
    - Standalone wecoza-clients-plugin DEACTIVATED
    - wecoza-core ACTIVE

    **Test sequence (in browser):**

    1. **Create client:** Visit [wecoza_capture_clients] page
       - Fill in: Company name, SETA, status, contact person details
       - Submit form
       - Expected: Success message, form clears (or redirects)

    2. **View clients:** Visit [wecoza_display_clients] page
       - Expected: Table shows the new client and existing clients
       - Test: Search by client name (type partial name, verify filtering)
       - Test: Filter by status dropdown
       - Test: Pagination if >10 clients

    3. **Edit client:** Click edit on a client (or visit [wecoza_update_clients]?mode=update&client_id=X)
       - Expected: Form pre-populated with client data
       - Change a field, submit
       - Expected: Success, changes visible in display table

    4. **Delete client:** Click delete on a test client
       - Expected: Confirmation dialog
       - Confirm delete
       - Expected: Client disappears from table (soft-deleted, not destroyed)

    5. **Client hierarchy:** If applicable, test creating a sub-client
       - Select a main client when creating new client
       - Verify sub-client appears under main client in the display

    6. **CSV export:** Click export button on display page
       - Expected: CSV file downloads with client data

    7. **Statistics:** On display page, verify statistics card shows:
       - Total client count
       - Breakdown by status
       - SETA breakdown (if shown)
  </how-to-verify>
  <resume-signal>Type "approved" if all operations work, or describe specific failures with steps to reproduce</resume-signal>
</task>

</tasks>

<verification>
1. Create client via form saves to database and appears in clients table (Task 1A)
2. Edit client persists changes (Task 1A)
3. Delete client sets deleted_at (soft-delete) (Task 1A)
4. Search filters clients correctly (Task 1A)
5. Main/sub-client hierarchy displays correctly (Task 1B)
6. CSV export: WP-CLI produces valid CSV with correct columns (Task 1B)
7. Statistics: getStatistics() returns counts excluding deleted (Task 1B)
8. JS action names match PHP handler names across all assets/js/clients/*.js (Task 1A + 1B)
9. User confirms full workflow in browser (Task 2)
</verification>

<success_criteria>
Phase 22 Success Criteria (from ROADMAP):
1. User can create client with company details, contact person, status, and SETA via [wecoza_capture_clients] -- VERIFIED by create test
2. User can view sortable/paginated clients list with search and filter via [wecoza_display_clients] -- VERIFIED by display/search/filter test
3. User can edit existing client and soft-delete client (sets deleted_at) -- VERIFIED by edit and delete tests
4. User can set client as main or sub-client and view sub-clients under main client -- VERIFIED by hierarchy test
5. User can export filtered clients to CSV and view client statistics -- VERIFIED by export and statistics tests
</success_criteria>

<output>
After completion, create `.planning/phases/22-client-management/22-02-SUMMARY.md`
</output>
