---
phase: 44-ajax-wiring-class-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Ajax/ProgressionAjaxHandlers.php
  - wecoza-core.php
autonomous: true
requirements: [AJAX-01, AJAX-02, AJAX-03, AJAX-04]

must_haves:
  truths:
    - "Admin can mark an LP as complete via AJAX with portfolio file upload"
    - "Admin can upload additional portfolio files to an existing in-progress LP"
    - "Frontend can fetch learner progression data (current LP, history, overall) without page reload"
    - "All AJAX handlers are registered and respond to wp_ajax_ actions"
    - "Collision acknowledgement can be logged via AJAX"
  artifacts:
    - path: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      provides: "Four AJAX handler functions + registration"
      exports: ["handle_mark_progression_complete", "handle_upload_progression_portfolio", "handle_get_learner_progressions", "handle_log_collision_acknowledgement", "register_progression_ajax_handlers"]
    - path: "wecoza-core.php"
      provides: "Loads ProgressionAjaxHandlers.php"
      contains: "ProgressionAjaxHandlers.php"
  key_links:
    - from: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      to: "src/Learners/Services/ProgressionService.php"
      via: "PSR-4 use statement"
      pattern: "use WeCoza\\\\Learners\\\\Services\\\\ProgressionService"
    - from: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      to: "src/Learners/Services/PortfolioUploadService.php"
      via: "PSR-4 use statement"
      pattern: "use WeCoza\\\\Learners\\\\Services\\\\PortfolioUploadService"
    - from: "wecoza-core.php"
      to: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      via: "require_once"
      pattern: "ProgressionAjaxHandlers\\.php"
---

<objective>
Register the progression AJAX handlers (mark-complete, portfolio-upload, fetch-data, collision-log) so the existing frontend JS can communicate with the existing backend services.

Purpose: The AJAX handlers exist as template code in docs/ but are not registered or using correct namespaces. This plan creates proper namespaced handlers following the established LearnerAjaxHandlers.php pattern, wires them to the existing ProgressionService/PortfolioUploadService, and registers them in wecoza-core.php.

Output: Working AJAX endpoints that respond to mark_progression_complete, upload_progression_portfolio, get_learner_progressions, and log_lp_collision_acknowledgement actions.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@docs/learner-progression/progression-ajax-handlers.php
@src/Learners/Ajax/LearnerAjaxHandlers.php
@src/Learners/Services/ProgressionService.php
@src/Learners/Services/PortfolioUploadService.php
@wecoza-core.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProgressionAjaxHandlers.php with four handler functions</name>
  <files>src/Learners/Ajax/ProgressionAjaxHandlers.php</files>
  <action>
Create `src/Learners/Ajax/ProgressionAjaxHandlers.php` following the exact pattern of `src/Learners/Ajax/LearnerAjaxHandlers.php`:

- Namespace: `WeCoza\Learners\Ajax`
- Use PSR-4 autoloaded classes (NOT require_once):
  - `use WeCoza\Learners\Services\ProgressionService;`
  - `use WeCoza\Learners\Services\PortfolioUploadService;`
- Reuse the existing `verify_learner_access()` function from same namespace (already defined in LearnerAjaxHandlers.php)

Four handler functions:

**1. handle_mark_progression_complete():**
- Call `verify_learner_access('learners_nonce')` for nonce check
- Check `manage_options` capability via `current_user_can()` — return error if not admin
- Get `tracking_id` from POST (intval, required)
- Portfolio file is REQUIRED per user decision — if `$_FILES['portfolio_file']` is missing or empty, return error "Portfolio file is required to complete an LP"
- Validate file via shared `validate_portfolio_file()` helper
- Call `(new ProgressionService())->markLPComplete($trackingId, get_current_user_id(), $portfolioFile)`
- On success: wp_send_json_success with message, tracking_id, completion_date (from result), status='completed'
- On error: wp_send_json_error with error message

**2. handle_upload_progression_portfolio():**
- Call `verify_learner_access('learners_nonce')` for nonce check
- Check `manage_options` capability
- Get `tracking_id` from POST (intval, required)
- Require file upload present — return error if missing
- Validate file via shared `validate_portfolio_file()` helper
- Call `(new PortfolioUploadService())->uploadProgressionPortfolio($trackingId, $validatedFile, get_current_user_id())`
- Return file_id, file_path, file_url, file_name on success

**3. handle_get_learner_progressions():**
- Call `verify_learner_access('learners_nonce')` for nonce check
- Get `learner_id` from GET (intval, required) — this is a read operation
- Instantiate ProgressionService and call:
  - `getCurrentLPDetails($learnerId)`
  - `getProgressionHistory($learnerId)`
  - `getLearnerOverallProgress($learnerId)`
- Return current_lp, history, overall in success response

**4. handle_log_collision_acknowledgement():**
- Call `verify_learner_access('wecoza_class_nonce')` — uses class form nonce
- Check `manage_options` capability
- Get `learner_ids` from POST (array of ints), `class_id` from POST (int)
- Log via `wecoza_log()`:
  ```
  LP Collision Acknowledged: Admin user {user_id} added learners [{ids}] to class {class_id} despite active LPs
  ```
- Return wp_send_json_success(['logged' => true])

**5. register_progression_ajax_handlers():**
- Register all four with add_action('wp_ajax_...'):
  - mark_progression_complete
  - upload_progression_portfolio
  - get_learner_progressions
  - log_lp_collision_acknowledgement
- None need nopriv (site requires login per CLAUDE.md)
- Register via `add_action('init', __NAMESPACE__ . '\register_progression_ajax_handlers')` like LearnerAjaxHandlers.php

**DRY helper — validate_portfolio_file(array $file): array:**
Extract shared file validation:
- Sanitize filename via sanitize_file_name()
- Check file size (10MB max)
- Verify MIME type and extension via wp_check_filetype_and_ext() with allowed mimes (pdf, doc, docx)
- Return `['valid' => true, 'file' => $sanitizedFile]` or `['valid' => false, 'error' => $message]`
- Used by both handle_mark_progression_complete and handle_upload_progression_portfolio
  </action>
  <verify>
Run: `php -l src/Learners/Ajax/ProgressionAjaxHandlers.php` — no syntax errors.
Grep for namespace: should be `WeCoza\Learners\Ajax`.
Grep for all four action registrations: mark_progression_complete, upload_progression_portfolio, get_learner_progressions, log_lp_collision_acknowledgement.
Grep for validate_portfolio_file — shared helper exists.
  </verify>
  <done>
Four AJAX handler functions exist with correct namespace, shared file validation, service calls, and action registration. No reference to `WeCoza\Services\*` (the old wrong namespace).
  </done>
</task>

<task type="auto">
  <name>Task 2: Register ProgressionAjaxHandlers in wecoza-core.php</name>
  <files>wecoza-core.php</files>
  <action>
In `wecoza-core.php`, immediately after the existing `require_once` for `LearnerAjaxHandlers.php` (around line 616), add:

```php
/*
|--------------------------------------------------------------------------
| Load Learner Progression AJAX Handlers
|--------------------------------------------------------------------------
|
| AJAX handlers for LP progression operations: mark complete,
| portfolio upload, fetch progression data, and collision logging.
|
*/

        require_once WECOZA_CORE_PATH .
            "src/Learners/Ajax/ProgressionAjaxHandlers.php";
```

This follows the same pattern as the existing LearnerAjaxHandlers loading. The file's internal `add_action('init', ...)` call will auto-register the AJAX actions.
  </action>
  <verify>
Grep wecoza-core.php for "ProgressionAjaxHandlers" — should appear exactly once.
Run `php -l wecoza-core.php` — no syntax errors.
  </verify>
  <done>
ProgressionAjaxHandlers.php is loaded by wecoza-core.php. All four AJAX actions are registered on init.
  </done>
</task>

</tasks>

<verification>
1. `php -l src/Learners/Ajax/ProgressionAjaxHandlers.php` passes
2. `php -l wecoza-core.php` passes
3. The file contains proper `WeCoza\Learners\Ajax` namespace (not `WeCoza\Services`)
4. All four wp_ajax_ actions are registered
5. File validation is DRY (shared function)
6. Portfolio file is required for mark-complete per user decision
7. Collision acknowledgement handler logs via wecoza_log()
</verification>

<success_criteria>
- All four AJAX handlers registered and callable via admin-ajax.php
- mark_progression_complete requires portfolio file (user decision: "Portfolio upload is required to complete an LP")
- Handlers use correct PSR-4 namespaces (WeCoza\Learners\Services\*)
- File validation shared between mark-complete and portfolio-upload handlers
- No references to the old wrong namespace WeCoza\Services\*
- Collision acknowledgement logged with admin user ID and learner IDs
</success_criteria>

<output>
After completion, create `.planning/phases/44-ajax-wiring-class-integration/44-01-SUMMARY.md`
</output>
