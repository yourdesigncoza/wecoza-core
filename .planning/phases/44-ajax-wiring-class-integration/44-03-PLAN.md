---
phase: 44-ajax-wiring-class-integration
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - views/classes/components/class-capture-partials/create-class.php
  - views/classes/components/class-capture-partials/update-class.php
  - assets/js/classes/learner-selection-table.js
  - views/classes/components/single-class/modal-learners.php
autonomous: true
requirements: [CLASS-01, CLASS-02, CLASS-03]

must_haves:
  truths:
    - "Available Learners table shows 'Last Completed Course' column with LP name + completion date"
    - "Learners with no completed LPs show dash in Last Completed Course column"
    - "Learners with active LPs have a small badge/icon next to their name"
    - "Last Completed Course column is sortable by completion date"
    - "Collision warning appears as modal with full details when adding learner with active LP"
    - "Collision modal shows LP name, progress %, hours logged, start date, class it belongs to"
    - "Admin clicks 'Add Anyway' to proceed past collision warning"
    - "Collision acknowledgement is logged (audit trail)"
    - "Class learner modal shows read-only progression info (current LP, progress bar, status badge)"
  artifacts:
    - path: "views/classes/components/class-capture-partials/create-class.php"
      provides: "Learner selection table with enhanced Last Completed Course column"
    - path: "views/classes/components/class-capture-partials/update-class.php"
      provides: "Same enhancements as create-class.php"
    - path: "assets/js/classes/learner-selection-table.js"
      provides: "Enhanced collision modal with full details and audit logging"
    - path: "views/classes/components/single-class/modal-learners.php"
      provides: "Read-only progression info in learner modal"
  key_links:
    - from: "assets/js/classes/learner-selection-table.js"
      to: "wp_ajax_mark_progression_complete"
      via: "Collision data from learner-data attribute"
      pattern: "has_active_lp"
    - from: "views/classes/components/class-capture-partials/create-class.php"
      to: "src/Learners/Repositories/LearnerRepository.php"
      via: "ClassController passes learner data to view"
      pattern: "last_course_name|last_completion_date"
---

<objective>
Enhance the class forms' learner selection table and learner modal to show progression context: formatted "Last Completed Course" column, enhanced collision warning modal with full details and audit logging, and read-only progression info in the single class learner modal.

Purpose: Most of the class integration infrastructure already exists (the repository query fetches progression data, the JS has collision warning logic, the modal shows LP info). This plan enhances the existing UI to match user specifications: formatted course column with dates, richer collision modal, and audit trail logging.

Output: Class capture forms with polished progression context UI.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@views/classes/components/class-capture-partials/create-class.php
@views/classes/components/class-capture-partials/update-class.php
@assets/js/classes/learner-selection-table.js
@views/classes/components/single-class/modal-learners.php
@src/Learners/Repositories/LearnerRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance Last Completed Course column format and active LP badge in class capture views</name>
  <files>
    views/classes/components/class-capture-partials/create-class.php
    views/classes/components/class-capture-partials/update-class.php
  </files>
  <action>
Both create-class.php and update-class.php have the learner selection table. Apply identical changes to both files:

**1. Rename column header from "Last Course" to "Last Completed Course":**
Change the `<th>` with `data-field="last_course_name"`:
```html
<th scope="col" class="border-0 sortable-column" data-field="last_completion_date" style="cursor: pointer;">
    Last Completed Course
    <i class="bi bi-arrow-down-up ms-1"></i>
</th>
```
Note: Change data-field to `last_completion_date` so sorting is by completion date (user decision: "Column is sortable by completion date").

**2. Update Last Completed Course cell to show LP name + completion date:**
Replace the existing cell (which just shows `last_course_name` as a badge) with:
```php
<td class="py-2 align-middle">
    <?php if (!empty($learner["last_course_name"])): ?>
    <div>
        <span class="badge fs-10 badge-phoenix badge-phoenix-success">
            <?php echo esc_html($learner["last_course_name"]); ?>
        </span>
        <?php if (!empty($learner["last_completion_date"])): ?>
        <br><small class="text-muted">
            completed <?php echo wp_date('Y-m-d', strtotime($learner["last_completion_date"])); ?>
        </small>
        <?php endif; ?>
    </div>
    <?php else: ?>
    <span class="text-muted">&mdash;</span>
    <?php endif; ?>
</td>
```
User decision: Show "LP name + completion date" format. Dash for no completed LPs.

**3. Add active LP badge next to learner name:**
User decision: "Learners with active LPs get a small badge/icon next to their name"

In the first_name cell, after the learner name, add:
```php
<td class="py-2 align-middle">
    <?php echo esc_html($learner["first_name"]); ?>
    <?php if (!empty($learner["has_active_lp"])): ?>
    <span class="badge fs-10 badge-phoenix badge-phoenix-warning ms-1" title="Active LP: <?php echo esc_attr($learner["active_course_name"] ?? ''); ?>">
        <i class="bi bi-book"></i>
    </span>
    <?php endif; ?>
</td>
```

This pre-warns the admin before they even try to add the learner, complementing the collision modal.

**4. Keep the existing Active LP warning column as-is** (the last column with the exclamation triangle) — it provides tooltip details and data attributes that the JS collision modal reads.

Apply ALL changes identically to both create-class.php and update-class.php.
  </action>
  <verify>
`php -l views/classes/components/class-capture-partials/create-class.php` — no syntax errors.
`php -l views/classes/components/class-capture-partials/update-class.php` — no syntax errors.
Grep both files for "Last Completed Course" — present in both.
Grep both files for "last_completion_date" in data-field — present in both.
Grep both files for "bi-book" badge — present in both.
  </verify>
  <done>
Both class capture views show "Last Completed Course" with LP name + completion date, dash for no history, active LP badge next to learner name, and sortable by completion date.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance collision modal with full details and audit logging, plus update sorting</name>
  <files>assets/js/classes/learner-selection-table.js</files>
  <action>
Update `learner-selection-table.js` to enhance the collision warning modal and add audit logging:

**1. Enhance showCollisionWarningModal() with full details:**
User decision: "Modal shows full details: LP name, current progress %, hours logged, start date, class it belongs to"

Update the learner list HTML in the modal to show all fields:
```javascript
learnerListHtml += `
    <li class="mb-3 p-3 bg-light rounded">
        <strong>${esc(name)}</strong>
        <div class="mt-2">
            <div class="d-flex justify-content-between mb-1">
                <small>Active LP:</small>
                <span class="badge badge-phoenix badge-phoenix-warning">${esc(courseName)}</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
                <small>Progress:</small>
                <span>${progress}%</span>
            </div>
            <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar bg-warning" role="progressbar" style="width: ${progress}%"></div>
            </div>
            <div class="d-flex justify-content-between mb-1">
                <small>Hours Present:</small>
                <span>${esc(String(learner.active_hours_present || 0))} / ${esc(String(learner.active_product_duration || 0))} hrs</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
                <small>Start Date:</small>
                <span>${esc(learner.active_start_date || 'N/A')}</span>
            </div>
            <div class="d-flex justify-content-between">
                <small>Current Class:</small>
                <span>${esc(classCode)}</span>
            </div>
        </div>
    </li>
`;
```

**2. Log collision acknowledgement (user decision: "Log the collision acknowledgement"):**
When "Add Anyway" is clicked, before proceeding, send an AJAX request to log the collision:

Add a new method `logCollisionAcknowledgement(learnersWithActiveLPs)`:
```javascript
logCollisionAcknowledgement(learnersWithActiveLPs) {
    // Fire and forget - don't block the UI
    const data = {
        action: 'log_lp_collision_acknowledgement',
        nonce: document.querySelector('#nonce')?.value || '',
        learner_ids: learnersWithActiveLPs.map(l => l.id),
        class_id: document.querySelector('#class_id')?.value || '',
        acknowledged_by: 'admin', // Server will resolve actual user
        timestamp: new Date().toISOString()
    };

    // Use navigator.sendBeacon for reliability (won't block)
    const formData = new FormData();
    Object.entries(data).forEach(([key, value]) => {
        if (Array.isArray(value)) {
            value.forEach(v => formData.append(key + '[]', v));
        } else {
            formData.append(key, value);
        }
    });
    navigator.sendBeacon(
        (typeof ajaxurl !== 'undefined' ? ajaxurl : '/wp-admin/admin-ajax.php'),
        formData
    );
}
```

Call this in the confirmBtn click handler, BEFORE `this.proceedWithAddingLearners()`.

Note: The `log_lp_collision_acknowledgement` AJAX handler doesn't exist yet. For now, the sendBeacon call is fire-and-forget. We'll add the handler in the ProgressionAjaxHandlers.php (plan 01 can include it, OR it can be a simple wecoza_log entry). Add a comment in the code: `// TODO Phase 45: Add server-side handler for collision audit logging`.

Actually, since Plan 01 creates ProgressionAjaxHandlers.php, add a 4th handler there:
```php
function handle_log_collision_acknowledgement(): void {
    verify_learner_access('wecoza_class_nonce');

    $learnerIds = isset($_POST['learner_ids']) ? array_map('intval', (array) $_POST['learner_ids']) : [];
    $classId = isset($_POST['class_id']) ? intval($_POST['class_id']) : 0;

    wecoza_log(sprintf(
        'LP Collision Acknowledged: Admin user %d added learners [%s] to class %d despite active LPs',
        get_current_user_id(),
        implode(', ', $learnerIds),
        $classId
    ), 'info');

    wp_send_json_success(['logged' => true]);
}
```
Register as `wp_ajax_log_lp_collision_acknowledgement`.

Wait -- that belongs in Plan 01. Add it there. In THIS plan, just add the JS-side sendBeacon call and note that Plan 01 includes the server handler.

**3. Update sorting for last_completion_date field:**
The `filterAndSort()` method sorts by comparing values with `localeCompare`. For `last_completion_date`, dates sort correctly as strings in YYYY-MM-DD format, so no special handling needed. Just ensure the sortField reference is correct.

The `loadLearnerData()` method reads from `data-learner-data` JSON which already includes `last_completion_date` from the PHP backend. No change needed to data loading.
  </action>
  <verify>
No JS syntax errors: verify bracket matching.
Grep for "active_hours_present" in modal HTML — present (full details).
Grep for "logCollisionAcknowledgement" — method exists.
Grep for "sendBeacon" — audit logging present.
  </verify>
  <done>
Collision modal shows full LP details (name, progress bar, hours, start date, class code). Collision acknowledgement is logged via sendBeacon. Sorting by completion date works via data-field change in views.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify and enhance class learner modal progression display</name>
  <files>views/classes/components/single-class/modal-learners.php</files>
  <action>
The modal-learners.php already shows Current LP name badge and progress bar. Verify it meets CLASS-03 requirements and enhance if needed:

**CLASS-03 spec: "Read-only progression info in class learner modal — current LP, progress bar, status badge"**

Current state: Shows "Current LP" column with product name badge and "Progress" column with progress bar + percentage. This is mostly complete.

**Enhancements needed:**

1. Add a status badge column showing the LP status (in_progress, completed, on_hold):
After the Progress column, the status is implied by having an LP but not explicitly shown. Add explicit status display by modifying the Current LP cell:

```php
<td class="align-middle">
    <?php if ($lpDetails): ?>
    <div>
        <span class="badge fs-10 badge-phoenix badge-phoenix-info" title="Started: <?php echo esc_attr($lpDetails['start_date'] ?? ''); ?>">
            <?php echo esc_html($lpDetails['product_name'] ?? 'Unknown'); ?>
        </span>
        <br>
        <small class="text-muted">
            <?php echo esc_html(number_format($lpDetails['hours_present'] ?? 0, 1)); ?> / <?php echo esc_html(number_format($lpDetails['product_duration'] ?? 0, 1)); ?> hrs
        </small>
    </div>
    <?php else: ?>
    <span class="text-muted">None</span>
    <?php endif; ?>
</td>
```

2. Ensure progress bar uses same color logic as learner-progressions.php (red < 50%, yellow 50-79%, green >= 80%) — already done, verify it matches.

3. The modal already uses `ProgressionService::getCurrentLPDetails()` — no additional backend changes needed.

This is a light-touch enhancement. The modal is already 90% done; just adding hours detail to the LP cell for richer context.
  </action>
  <verify>
`php -l views/classes/components/single-class/modal-learners.php` — no syntax errors.
Grep for "hours_present" in the modal file — present.
Grep for "product_duration" — present.
  </verify>
  <done>
Class learner modal shows read-only progression info: current LP name with hours detail, color-coded progress bar, and percentage. Fully satisfies CLASS-03.
  </done>
</task>

</tasks>

<verification>
1. All PHP files pass `php -l` syntax check
2. create-class.php and update-class.php both show "Last Completed Course" with date format
3. Active LP badge appears next to learner names in selection table
4. Collision modal shows full details (LP, progress, hours, start date, class)
5. Collision acknowledgement logged via sendBeacon
6. modal-learners.php shows current LP with hours and progress bar
7. Sorting by completion date works (data-field set to last_completion_date)
</verification>

<success_criteria>
- CLASS-01: Available Learners table shows "Last Completed Course" column with "LP Name — completed YYYY-MM-DD" format, dash for no history, sortable by completion date
- CLASS-02: Collision warning modal shows full LP details + "Add Anyway" button, acknowledgement is logged
- CLASS-03: Class learner modal shows current LP name, hours, and progress bar (read-only)
- Active LP learners have a small book icon badge next to their first name in selection table
</success_criteria>

<output>
After completion, create `.planning/phases/44-ajax-wiring-class-integration/44-03-SUMMARY.md`
</output>
