---
phase: 44-ajax-wiring-class-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/js/learners/learner-progressions.js
  - views/learners/components/learner-progressions.php
autonomous: true
requirements: [AJAX-01, AJAX-02, AJAX-03]

must_haves:
  truths:
    - "Mark Complete shows confirmation modal before proceeding"
    - "Portfolio file is required — confirm button stays disabled without file"
    - "On success: toast notification AND card updates in-place (badge to Completed, progress bar fills)"
    - "On error: inline danger alert below the Mark Complete button"
    - "After Mark Complete success, progression history auto-refreshes"
    - "Skeleton cards appear while progression data loads"
    - "Portfolio upload shows progress bar with percentage"
  artifacts:
    - path: "assets/js/learners/learner-progressions.js"
      provides: "Full mark-complete flow with confirmation, AJAX fetch, skeleton loading, upload progress"
      min_lines: 200
    - path: "views/learners/components/learner-progressions.php"
      provides: "Progressions tab with skeleton placeholders and data attributes for JS"
  key_links:
    - from: "assets/js/learners/learner-progressions.js"
      to: "wp_ajax_mark_progression_complete"
      via: "jQuery.ajax with FormData"
      pattern: "action.*mark_progression_complete"
    - from: "assets/js/learners/learner-progressions.js"
      to: "wp_ajax_get_learner_progressions"
      via: "jQuery.ajax GET request"
      pattern: "action.*get_learner_progressions"
    - from: "assets/js/learners/learner-progressions.js"
      to: "wp_ajax_upload_progression_portfolio"
      via: "jQuery.ajax with FormData and xhr progress"
      pattern: "action.*upload_progression_portfolio"
---

<objective>
Enhance the frontend learner-progressions JS and PHP view to implement the full user-specified UX: confirmation modal before mark-complete, required portfolio upload, in-place card updates on success, inline error display, skeleton loading, upload progress bar, and auto-refresh of history after completion.

Purpose: The existing JS and view are functional but minimal (page reload on success, no confirmation, no skeleton loading, no upload progress). User decisions specify a polished UX with confirmation dialogs, in-place updates, and visual feedback.

Output: Enhanced learner-progressions.js with full interaction flow and updated view template with skeleton/data-attribute support.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@assets/js/learners/learner-progressions.js
@views/learners/components/learner-progressions.php
@src/Learners/Shortcodes/learner-single-display-shortcode.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance learner-progressions.js with confirmation modal, in-place updates, skeleton loading, and upload progress</name>
  <files>assets/js/learners/learner-progressions.js</files>
  <action>
Rewrite the learner-progressions.js module to implement user decisions. Keep the IIFE + jQuery pattern. Key changes:

**1. Confirmation Modal (user decision: "Always show confirmation dialog before marking complete"):**
- When "Mark Complete" is clicked, show a Bootstrap modal: "Mark [LP name] as complete?"
- Modal body shows LP name, current progress %, hours logged
- Read LP name from `data-product-name` attribute on the mark-complete button (add to view)
- Modal has "Cancel" and "Proceed to Upload" buttons
- "Proceed to Upload" reveals the upload section (existing behavior)

**2. Portfolio Upload Required (user decision: "Portfolio upload is required to complete an LP"):**
- Confirm button stays disabled until file is selected (existing behavior, keep it)
- No change needed here, existing validation already enforces this

**3. Upload Progress Bar (user decision: "Portfolio upload shows a progress bar with percentage"):**
- Add `xhr` callback to $.ajax to track upload progress
- Show a Bootstrap progress bar below the file input during upload
- Update progress bar percentage in real-time
- HTML for progress bar: `<div class="progress mt-2" id="upload-progress" style="display:none"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width:0%">0%</div></div>`

**4. In-Place Card Update (user decision: "On success: toast notification AND the card updates in-place"):**
- On success response, do NOT reload page
- Update the current LP card:
  - Change badge from "In Progress" to "Completed" (badge-phoenix-success)
  - Fill progress bar to 100%
  - Hide the admin-actions section (mark complete button area)
- Show toast notification using existing showAlert('success', ...) method
- After 1 second, call `refreshProgressionData()` to fetch updated data

**5. Error Display (user decision: "On error: inline danger alert below the Mark Complete button"):**
- Keep existing showAlert('danger', ...) pattern
- Alert appears inside `.admin-actions` div (already does this)

**6. Auto-Refresh After Completion (user decision: "progression history auto-refreshes"):**
- Add `refreshProgressionData()` method that calls `get_learner_progressions` AJAX
- On success, update history timeline HTML with returned data
- Use `learnerSingleAjax.learnerId` (already localized) for the learner ID
- Build history HTML with same structure as the PHP template (timeline items with badges)

**7. Skeleton Loading (user decision: "Skeleton cards while progression data loads"):**
- Add `showSkeletonCards()` and `hideSkeletonCards()` methods
- Skeleton = gray animated placeholder divs mimicking the card layout
- Show skeleton when `refreshProgressionData()` fires, hide when data arrives
- Only show skeleton on explicit refresh (not initial page load, which is server-rendered)

**8. Additional Portfolio Upload:**
- Add handler for standalone portfolio upload (without marking complete)
- New button in admin-actions: "Upload Portfolio" (visible when LP is in_progress)
- Triggers file picker, uploads via upload_progression_portfolio action
- Shows upload progress bar same as mark-complete flow
- On success, toast notification

Use `window.WeCozaUtils.escapeHtml` for XSS-safe HTML construction (already available globally). For any HTML built in JS, use the safe escaping pattern from `learner-selection-table.js`.
  </action>
  <verify>
No JS syntax errors: check via a quick review of bracket/brace matching.
Grep for all three AJAX action references: mark_progression_complete, upload_progression_portfolio, get_learner_progressions.
Confirm no `window.location.reload()` calls remain (replaced by in-place updates).
  </verify>
  <done>
learner-progressions.js handles full mark-complete flow with confirmation modal, required portfolio, upload progress bar, in-place card updates, inline error alerts, skeleton loading on refresh, and auto-refresh of history timeline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update learner-progressions.php view with data attributes, skeleton placeholders, and upload-portfolio button</name>
  <files>views/learners/components/learner-progressions.php</files>
  <action>
Update the learner-progressions.php view template to support the enhanced JS:

**1. Add data attributes to Mark Complete button:**
```php
data-tracking-id="..."
data-product-name="<?php echo esc_attr($currentLP['product_name']); ?>"
data-progress-pct="<?php echo esc_attr($progressPercentage); ?>"
data-hours-present="<?php echo esc_attr($currentLP['hours_present']); ?>"
data-product-duration="<?php echo esc_attr($currentLP['product_duration']); ?>"
```

**2. Add "Upload Portfolio" button (for standalone upload, AJAX-02):**
Below the Mark Complete button in admin-actions, add:
```php
<button type="button" class="btn btn-outline-primary ms-2 upload-portfolio-btn"
        data-tracking-id="<?php echo esc_attr($currentLP['tracking_id']); ?>">
    <i class="bi bi-file-earmark-arrow-up me-1"></i> Upload Portfolio
</button>
```
And a corresponding hidden upload section (similar to existing upload-section but with different ID: `portfolio-only-upload-section`).

**3. Add upload progress bar placeholder:**
Inside both upload sections, after the file input div:
```html
<div class="progress mt-2 d-none" id="upload-progress">
    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
</div>
```

**4. Add skeleton container (hidden by default):**
Before the current LP card, add:
```html
<div id="progression-skeleton" class="d-none">
    <div class="card mb-4">
        <div class="card-header">
            <div class="placeholder-glow">
                <span class="placeholder col-4"></span>
            </div>
        </div>
        <div class="card-body">
            <div class="placeholder-glow mb-3">
                <span class="placeholder col-6"></span>
                <div class="progress mt-2" style="height: 24px;">
                    <div class="progress-bar placeholder col-12"></div>
                </div>
            </div>
            <div class="row g-3">
                <div class="col-4"><div class="card bg-body-subtle text-center p-3"><span class="placeholder col-8"></span></div></div>
                <div class="col-4"><div class="card bg-body-subtle text-center p-3"><span class="placeholder col-8"></span></div></div>
                <div class="col-4"><div class="card bg-body-subtle text-center p-3"><span class="placeholder col-8"></span></div></div>
            </div>
        </div>
    </div>
</div>
```

**5. Wrap existing content in a container for JS targeting:**
Wrap the current LP card in `<div id="progression-current-lp">` and the history section in `<div id="progression-history">`.

**6. Add confirmation modal markup:**
At the bottom of the template, add a Bootstrap modal for mark-complete confirmation:
```html
<div class="modal fade" id="markCompleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-check-circle text-success me-2"></i>Mark LP as Complete?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>You are about to mark <strong id="confirm-lp-name"></strong> as complete.</p>
                <ul class="list-unstyled text-muted">
                    <li><i class="bi bi-graph-up me-2"></i>Progress: <span id="confirm-lp-progress"></span></li>
                    <li><i class="bi bi-clock me-2"></i>Hours: <span id="confirm-lp-hours"></span></li>
                </ul>
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle me-2"></i>A portfolio file upload is required to complete this LP.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="proceed-to-upload-btn">
                    <i class="bi bi-file-earmark-arrow-up me-1"></i> Proceed to Upload
                </button>
            </div>
        </div>
    </div>
</div>
```
  </action>
  <verify>
`php -l views/learners/components/learner-progressions.php` — no syntax errors.
Grep for data-product-name, progression-skeleton, markCompleteConfirmModal, upload-portfolio-btn, progression-history, progression-current-lp — all present.
  </verify>
  <done>
View template has data attributes for JS, skeleton placeholder, confirmation modal, upload progress bar container, standalone upload portfolio button, and wrapper divs for JS targeting.
  </done>
</task>

</tasks>

<verification>
1. `php -l views/learners/components/learner-progressions.php` passes
2. JS file references all three AJAX actions
3. No `window.location.reload()` in JS (in-place updates only)
4. Confirmation modal present in view
5. Skeleton placeholder present in view
6. Upload progress bar placeholder in both upload sections
7. All XSS-sensitive HTML uses proper escaping
</verification>

<success_criteria>
- Mark Complete shows confirmation modal with LP details before upload section
- Portfolio file is required (cannot mark complete without it)
- Upload shows progress bar with real-time percentage
- On success: toast + in-place card update (badge changes, progress bar fills, admin actions hide)
- On error: inline danger alert below button
- History auto-refreshes after completion
- Skeleton cards shown during data refresh
- Standalone portfolio upload button works independently
</success_criteria>

<output>
After completion, create `.planning/phases/44-ajax-wiring-class-integration/44-02-SUMMARY.md`
</output>
