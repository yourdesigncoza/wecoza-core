---
phase: 24-sites-hierarchy
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - src/Clients/Models/SitesModel.php
  - src/Clients/Models/ClientsModel.php
  - views/clients/display/clients-table.view.php
  - assets/js/clients/clients-table.js
autonomous: false

must_haves:
  truths:
    - "Client listing table shows location data (town) hydrated from head site via SitesModel::hydrateClients()"
    - "Client details modal displays site_name, province, town, suburb, street address, postal code from head site"
    - "Head site cache refreshes after site save (no stale data in listing)"
    - "Parent-child site relationships visible: sub-clients show their main client in Branch column"
  artifacts:
    - path: "src/Clients/Models/SitesModel.php"
      provides: "hydrateClients(), getHeadSitesForClients(), refreshHeadSiteCache()"
    - path: "src/Clients/Models/ClientsModel.php"
      provides: "hydrateRows() calls sitesModel->hydrateClients()"
    - path: "views/clients/display/clients-table.view.php"
      provides: "Client listing with Branch column and details modal"
    - path: "assets/js/clients/clients-table.js"
      provides: "viewClientDetails() populates modal with site/location data"
  key_links:
    - from: "src/Clients/Models/ClientsModel.php::hydrateRows"
      to: "src/Clients/Models/SitesModel.php::hydrateClients"
      via: "method call in hydrateRows"
      pattern: "sitesModel->hydrateClients"
    - from: "src/Clients/Models/SitesModel.php::hydrateClients"
      to: "views/clients/display/clients-table.view.php"
      via: "hydrated fields rendered in template"
      pattern: "client\\['client_town'\\]|client\\['site_name'\\]"
    - from: "assets/js/clients/clients-table.js"
      to: "src/Clients/Ajax/ClientAjaxHandlers.php::getClientDetails"
      via: "AJAX call for modal population"
      pattern: "wecoza_get_client_details"
---

<objective>
Verify client listing hydration, modal display of site/location data, and cache invalidation. Then perform end-to-end human verification of the complete sites hierarchy flow.

Purpose: Ensure site data displays correctly in client listing and details, and that the full create/view/update cycle works.
Output: Client listing correctly shows location-hydrated data, modal displays site details, E2E verified by user.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-sites-hierarchy/24-RESEARCH.md
@.planning/phases/24-sites-hierarchy/24-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and fix client listing hydration and modal display</name>
  <files>
    src/Clients/Models/SitesModel.php
    src/Clients/Models/ClientsModel.php
    src/Clients/Ajax/ClientAjaxHandlers.php
    views/clients/display/clients-table.view.php
    assets/js/clients/clients-table.js
  </files>
  <action>
Trace the complete data flow from database to client listing display and modal:

**1. Client Listing Hydration Path**
- ClientsModel::getAll() or equivalent listing method fetches clients
- hydrateRows() is called on the result set
- hydrateRows() calls `$this->sitesModel->hydrateClients($rows)`
- SitesModel::hydrateClients() calls getHeadSitesForClients() with batch IDs
- For each client, hydration adds: head_site, site_id, site_name, client_town_id, client_street_address, client_suburb, client_postal_code, client_province, client_town, client_location

Verify:
- The listing method (find it in ClientsModel -- likely getAll() or getPaginated()) calls hydrateRows()
- hydrateClients() actually adds `client_town` key (used by modal JS at `client.client_town`)
- Batch fetch is used (getHeadSitesForClients), not per-row getHeadSite()

**2. Client Details Modal Data Flow**
- `viewClientDetails(clientId)` in clients-table.js sends AJAX to `wecoza_get_client_details`
- Handler calls `ClientsModel::getById()` which calls hydrateRows() -> hydrateClients()
- Handler also separately calls `$sitesModel->getHeadSite($clientId)` and merges site_name
- Response sent via `AjaxSecurity::sendSuccess($data)`
- JS reads: `client.site_name`, `client.client_province`, `client.client_town`, `client.client_suburb`, `client.client_street_address`, `client.client_postal_code`

Verify:
- The response structure matches what JS expects
- Note: `AjaxSecurity::sendSuccess($data)` wraps in `{success: true, data: $data}`. JS in clients-table.js must access `response.data.field`, NOT `response.field`. Check this -- the viewClientDetails handler uses `AjaxSecurity::sendSuccess($data)` not `wp_send_json_success(['client' => $client])`, so the response structure is `{success: true, data: {client_name: '...', site_name: '...', ...}}`
- In clients-table.js, check how the AJAX response is parsed. The `.done()` callback receives the response. If it reads `response.data.client_name`, that's correct. If it reads `response.client_name`, that's wrong (needs `.data`).

**3. Cache Invalidation**
- After `saveHeadSite()`, verify `refreshHeadSiteCache([$clientId])` is called
- After `saveSubSite()`, verify cache is refreshed for affected client
- Read the `refreshHeadSiteCache()` method and confirm it deletes the transient `wecoza_clients_head_sites_cache` or invalidates for specific client IDs

**4. Branch Column Display**
- The clients table shows a Branch column with main_client_name badge for sub-clients
- Verify `$client['main_client_name']` is populated by hydrateRelatedData() or another hydration step
- If main_client_name is not populated, the table shows "Unknown" -- check if this is acceptable or needs fixing

Fix any data flow mismatches found. Specifically:
- If JS reads response without `.data` wrapper, add the wrapper or fix JS
- If hydration doesn't add expected keys, fix hydrateClients()
- If cache not invalidated after save, add the call
  </action>
  <verify>
- Read SitesModel::hydrateClients() and confirm it sets client_town, client_province, client_suburb, site_name on each client row
- Read clients-table.js viewClientDetails handler and confirm response data access pattern matches AjaxSecurity::sendSuccess wrapper
- Read SitesModel::saveHeadSite() and confirm refreshHeadSiteCache is called after save
- Grep for `main_client_name` in ClientsModel to confirm it's hydrated
  </verify>
  <done>
Client listing hydration verified: hydrateClients adds all location fields. Modal JS correctly accesses response.data fields. Cache invalidation present after site saves. Branch column populated with main_client_name. Any mismatches fixed.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end sites hierarchy verification</name>
  <what-built>
Complete sites hierarchy integration: head site creation with client, sub-site creation via sub-client, site data display in client listing modal, location hydration, and all fixes applied in Plans 24-01 and 24-02 Task 1.
  </what-built>
  <how-to-verify>
Test in browser at the WeCoza application:

**Test 1: Create main client with head site**
1. Go to client capture form page
2. Fill in client name, company registration, SETA, status
3. Select Province from dropdown -- Town dropdown should appear
4. Select Town -- Suburb dropdown should appear
5. Select Suburb -- postal code and street address should auto-fill
6. Enter site name (or leave blank -- should fallback to client name)
7. Submit the form
8. Expected: Client created successfully, form clears, no errors

**Test 2: View client details modal**
1. Go to client listing page
2. Click the eye icon on the client you just created
3. Expected: Modal shows client name, site name, province, town, suburb, street address, postal code

**Test 3: Create sub-client with sub-site**
1. Go to client capture form page
2. Check "Is SubClient" checkbox
3. Expected: Main Client dropdown appears
4. Select a main client from the dropdown
5. Fill in sub-client details and location
6. Submit the form
7. Expected: Sub-client created, Branch column in listing shows main client badge

**Test 4: Edit existing client with site data**
1. Go to client listing page
2. Click edit icon on a client with location data
3. Expected: Update form loads with existing province, town, suburb, site name pre-selected
4. Change the suburb selection
5. Save
6. Expected: Updated data visible in client listing modal

**Test 5: Verify location cascade loads**
1. Go to client capture form on a fresh page load
2. Expected: Province dropdown populated (may lazy-load via AJAX)
3. If Province dropdown is empty on first load, wait 1-2 seconds for AJAX load
4. Expected: Province > Town > Suburb cascade works smoothly
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Client listing hydration adds site_name, client_town, client_province to each client row
2. Client details modal displays site and location data correctly
3. Head site cache invalidated after site save operations
4. Sub-client Branch column shows main client name
5. All 5 E2E tests pass in browser
</verification>

<success_criteria>
- Client listing correctly displays location-hydrated data from head sites
- Client details modal shows all site/location fields
- Head site creation works when saving new main client
- Sub-site creation works when saving new sub-client
- Location cascade (Province > Town > Suburb) works in forms
- Cache invalidation prevents stale site data
- User approves all E2E tests
</success_criteria>

<output>
After completion, create `.planning/phases/24-sites-hierarchy/24-02-SUMMARY.md`
</output>
