---
phase: 24-sites-hierarchy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Clients/Ajax/ClientAjaxHandlers.php
  - src/Clients/Models/SitesModel.php
  - views/clients/components/client-capture-form.view.php
  - views/clients/components/client-update-form.view.php
  - assets/js/clients/client-capture.js
autonomous: true

must_haves:
  truths:
    - "Head site auto-created when main client saved via capture form (site_name + place_id propagated)"
    - "Sub-site created when 'Is SubClient' checkbox checked and main client selected"
    - "Site data (site_name, place_id, parent_site_id) flows correctly from form fields through sanitizeClientFormData to SitesModel save methods"
    - "Location hierarchy cascade (Province > Town > Suburb) loads and populates site location"
  artifacts:
    - path: "src/Clients/Ajax/ClientAjaxHandlers.php"
      provides: "saveClient handler processes site data, 5 standalone site endpoints work"
      contains: "sanitizeClientFormData"
    - path: "src/Clients/Models/SitesModel.php"
      provides: "saveHeadSite, saveSubSite, validateHeadSite, validateSubSite"
    - path: "views/clients/components/client-capture-form.view.php"
      provides: "Form fields: head_site_id, site_name, client_town_id, is_sub_client, main_client_id"
    - path: "assets/js/clients/client-capture.js"
      provides: "Form submission, location cascade, head_site response handling"
  key_links:
    - from: "views/clients/components/client-capture-form.view.php"
      to: "src/Clients/Ajax/ClientAjaxHandlers.php::sanitizeClientFormData"
      via: "form field names match POST keys"
      pattern: "name=\"site_name\".*\\$data\\['site_name'\\]"
    - from: "assets/js/clients/client-capture.js"
      to: "src/Clients/Ajax/ClientAjaxHandlers.php::saveClient"
      via: "config.actions.save AJAX call"
      pattern: "action.*wecoza_save_client"
    - from: "src/Clients/Ajax/ClientAjaxHandlers.php::sanitizeClientFormData"
      to: "src/Clients/Models/SitesModel.php::saveHeadSite"
      via: "saveClient handler passes site data"
      pattern: "saveHeadSite\\(\\$clientId.*\\$siteData\\)"
---

<objective>
Verify and fix the sites creation pipeline: form fields -> sanitizeClientFormData -> SitesModel save methods. Audit AJAX action names, localization keys, form field names, and sub-client flow for the same wiring bugs found in Phases 22-23.

Purpose: Ensure head site and sub-site creation works end-to-end when saving a client via the capture/update forms.
Output: All site creation paths verified and any wiring bugs fixed.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-sites-hierarchy/24-RESEARCH.md
@.planning/phases/22-client-management/22-02-SUMMARY.md
@.planning/phases/23-location-management/23-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit and fix site creation AJAX wiring</name>
  <files>
    src/Clients/Ajax/ClientAjaxHandlers.php
    src/Clients/Controllers/ClientsController.php
    assets/js/clients/client-capture.js
    views/clients/components/client-capture-form.view.php
    views/clients/components/client-update-form.view.php
    views/clients/display/clients-table.view.php
  </files>
  <action>
Apply the Phase 22-23 verification pattern to site-related wiring. Check and fix each category:

**1. AJAX Action Name Consistency**
- Grep JS files for all `action:` values and compare to `add_action('wp_ajax_` registrations in ClientAjaxHandlers.php
- The 5 site endpoints (wecoza_save_sub_site, wecoza_get_head_sites, wecoza_get_sub_sites, wecoza_delete_sub_site, wecoza_get_sites_hierarchy) must match exactly
- The client save endpoint (`wecoza_save_client`) is the primary site creation path -- verify `config.actions.save` in JS equals `wecoza_save_client`
- KNOWN BUG: Inline scripts in `clients-table.view.php` use wrong action names (`export_clients` should be `wecoza_export_clients`, `delete_client` should be `wecoza_delete_client`) and wrong nonce name (`wecoza_clients_ajax` should be `clients_nonce_action`). Fix these inline scripts too since they affect the same page where sites display.

**2. Localization Key Consistency**
- Verify `wp_localize_script()` in ClientsController.php uses camelCase keys (ajaxUrl, nonce, actions.save, actions.locations)
- Verify JS reads these same keys (config.ajaxUrl, config.nonce, config.actions.save, etc.)
- Phase 22 standardized camelCase -- confirm no regression

**3. Form Field Name -> POST Key -> sanitizeClientFormData Mapping**
- `site_name` form field -> `$data['site_name']` in sanitizeClientFormData -> `$site['site_name']`
- `head_site_id` hidden field -> `$data['head_site_id']` -> `$site['site_id']`
- `client_town_id` select (suburb) -> `$data['client_town_id']` -> `$site['place_id']`
- `is_sub_client` checkbox -> `$data['is_sub_client']` -> triggers `main_client_id` -> sub-site flow
- `main_client_id` select -> `$data['main_client_id']` -> fetches parent head site -> `$site['parent_site_id']`
- Verify both capture and update forms use identical field names

**4. Sub-Client JavaScript Flow**
- Verify `is_sub_client` checkbox toggle shows/hides `main_client_dropdown_container`
- Verify inline script in form view handles this toggle (check form view lines ~408+)
- Verify the main_client_id dropdown is populated (via `wecoza_get_main_clients` or server-side)

**5. Response Handling**
- After saveClient succeeds, JS reads `data.client.head_site.site_id` and `data.client.head_site.site_name` (lines 538-541 of client-capture.js)
- Verify that `ClientsModel::getById()` -> `hydrateRows()` -> `hydrateClients()` actually adds `head_site` key with `site_id` and `site_name` to the single-client response
- If head_site is nested differently, fix the JS or PHP to match

Fix any mismatches found. For each fix, document what was wrong and what was changed.
  </action>
  <verify>
- Grep for all `action:` values in JS and inline scripts, confirm each matches a registered `wp_ajax_` handler
- Grep for localization key usage in JS, confirm all match the PHP `wp_localize_script()` payload
- Verify no `wp_ajax_nopriv_` handlers exist for site endpoints (auth required per CLAUDE.md)
- Read sanitizeClientFormData and confirm each form field maps to the correct site data key
  </verify>
  <done>
All site-related AJAX action names match between JS and PHP. Localization keys are consistent (camelCase). Form fields map correctly through sanitizeClientFormData to SitesModel methods. Inline table scripts use correct action names and nonce. Sub-client toggle works in both capture and update forms.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify standalone site AJAX endpoints</name>
  <files>
    src/Clients/Ajax/ClientAjaxHandlers.php
    src/Clients/Models/SitesModel.php
  </files>
  <action>
Verify the 5 standalone site AJAX endpoints work correctly by tracing their code paths:

**1. wecoza_save_sub_site (POST)**
- Handler: `saveSubSite()` lines 450-485
- Reads: client_id, parent_site_id, site_data (JSON)
- Calls: `validateSubSite()` then `saveSubSite()`
- Verify: SitesModel::saveSubSite() method exists with correct signature (clientId, parentSiteId, data, options)
- Verify: SitesModel::validateSubSite() method exists with correct signature

**2. wecoza_get_head_sites (GET)**
- Handler: `getHeadSites()` lines 490-506
- Reads: client_id from $_GET
- Calls: `getHeadSitesForClient()`
- Verify: Method exists in SitesModel, returns array of head sites

**3. wecoza_get_sub_sites (GET)**
- Handler: `getSubSites()` lines 511-527
- Reads: parent_site_id from $_GET
- Calls: `getSubSites()`
- Verify: Method exists, returns array of sub-sites for parent

**4. wecoza_delete_sub_site (POST)**
- Handler: `deleteSubSite()` lines 532-554
- Reads: site_id, client_id
- Calls: `deleteSubSite()`
- Verify: Method exists, checks site belongs to client before deleting

**5. wecoza_get_sites_hierarchy (GET)**
- Handler: `getSitesHierarchy()` lines 559-575
- Reads: client_id from $_GET
- Calls: `getAllSitesWithHierarchy()`
- Verify: Method exists and was fixed in Phase 22 (22-02 fixed undefined method call)

For each endpoint, trace the code path from handler through model to database query. Verify:
- Nonce check present (clients_nonce_action)
- Capability check present (view/edit/delete)
- Input sanitization (intval on IDs)
- Error responses use AjaxSecurity::sendError()
- Success responses use AjaxSecurity::sendSuccess()
- No `wp_ajax_nopriv_` handlers registered for any site endpoint

If any method calls don't match SitesModel's actual method signatures (parameter count/types), fix the handler.
  </action>
  <verify>
- Read each of the 5 handler methods and confirm method calls match SitesModel signatures
- Grep for `wp_ajax_nopriv_wecoza_(save_sub_site|get_head_sites|get_sub_sites|delete_sub_site|get_sites_hierarchy)` -- should return 0 results
- Confirm each handler has nonce check, capability check, and input sanitization
  </verify>
  <done>
All 5 standalone site AJAX endpoints verified: method signatures match, security checks present, no nopriv handlers, error handling consistent. Any mismatches fixed.
  </done>
</task>

</tasks>

<verification>
1. All AJAX action names match between JS/inline scripts and PHP handler registrations
2. Localization keys consistent (camelCase) between PHP and JS
3. Form field names map correctly through sanitizeClientFormData to site data
4. All 5 standalone site endpoints have correct method calls, security, and error handling
5. No wp_ajax_nopriv handlers for site endpoints
6. Sub-client checkbox flow correctly triggers parent site lookup
</verification>

<success_criteria>
- Head site creation path (form -> saveClient -> saveHeadSite) fully traced and verified
- Sub-site creation path (is_sub_client -> main_client_id -> parent_site_id -> saveSubSite) fully traced and verified
- Zero AJAX action name mismatches
- Zero localization key inconsistencies
- All wiring bugs found and fixed
</success_criteria>

<output>
After completion, create `.planning/phases/24-sites-hierarchy/24-01-SUMMARY.md`
</output>
