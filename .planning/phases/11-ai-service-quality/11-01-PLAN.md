---
phase: 11-ai-service-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Support/OpenAIConfig.php
  - src/Events/Services/AISummaryService.php
  - tests/Events/AISummarizationTest.php
autonomous: true

must_haves:
  truths:
    - "AI summaries use valid model name gpt-4o-mini"
    - "OpenAI API URL can be changed via WordPress options"
    - "Default behavior unchanged (OpenAI endpoint, gpt-4o-mini model)"
    - "Tests pass with new configuration approach"
  artifacts:
    - path: "src/Events/Support/OpenAIConfig.php"
      provides: "getApiUrl() and getModel() methods"
      contains: "getApiUrl"
    - path: "src/Events/Services/AISummaryService.php"
      provides: "Config-driven API calls"
      contains: "$this->config->getModel()"
    - path: "tests/Events/AISummarizationTest.php"
      provides: "Config method verification tests"
      contains: "gpt-4o-mini"
  key_links:
    - from: "src/Events/Services/AISummaryService.php"
      to: "OpenAIConfig::getApiUrl()"
      via: "method call in callOpenAI()"
      pattern: "\\$this->config->getApiUrl\\(\\)"
    - from: "src/Events/Services/AISummaryService.php"
      to: "OpenAIConfig::getModel()"
      via: "method call in callOpenAI()"
      pattern: "\\$this->config->getModel\\(\\)"
---

<objective>
Add configurable model name and API URL to the AI summarization service, fixing the invalid model name and enabling Azure/proxy deployments.

Purpose: Fix QUAL-01 (invalid gpt-5-mini model) and QUAL-04 (hardcoded API URL prevents Azure/proxy use)
Output: OpenAIConfig extended with getApiUrl()/getModel() methods, AISummaryService using config instead of constants
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-ai-service-quality/11-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend OpenAIConfig with URL and Model Configuration</name>
  <files>src/Events/Support/OpenAIConfig.php</files>
  <action>
Add configurable API URL and model name to OpenAIConfig class:

1. Add option name constants after existing OPTION_API_KEY (line 20):
   ```php
   public const OPTION_API_URL = 'wecoza_openai_api_url';
   public const OPTION_MODEL = 'wecoza_openai_model';
   ```

2. Add default value constants (private, below OPTION_ENABLED):
   ```php
   private const DEFAULT_API_URL = 'https://api.openai.com/v1/chat/completions';
   private const DEFAULT_MODEL = 'gpt-4o-mini';
   ```

3. Add getApiUrl() method after hasValidApiKey() (around line 43):
   ```php
   public function getApiUrl(): string
   {
       $stored = get_option(self::OPTION_API_URL, '');
       if (!is_string($stored)) {
           return self::DEFAULT_API_URL;
       }

       $stored = trim($stored);
       if ($stored === '') {
           return self::DEFAULT_API_URL;
       }

       return $this->isValidUrl($stored) ? $stored : self::DEFAULT_API_URL;
   }
   ```

4. Add getModel() method after getApiUrl():
   ```php
   public function getModel(): string
   {
       $stored = get_option(self::OPTION_MODEL, '');
       if (!is_string($stored)) {
           return self::DEFAULT_MODEL;
       }

       $stored = trim($stored);
       return $stored !== '' ? $stored : self::DEFAULT_MODEL;
   }
   ```

5. Add private isValidUrl() helper method at end of class (before closing brace):
   ```php
   private function isValidUrl(string $url): bool
   {
       return filter_var($url, FILTER_VALIDATE_URL) !== false
           && (str_starts_with($url, 'https://') || str_starts_with($url, 'http://'));
   }
   ```
  </action>
  <verify>
Run: `php -l src/Events/Support/OpenAIConfig.php` - no syntax errors
Manually verify: new methods exist and follow existing code style
  </verify>
  <done>
OpenAIConfig provides getApiUrl() returning valid URL (default: https://api.openai.com/v1/chat/completions)
OpenAIConfig provides getModel() returning valid model name (default: gpt-4o-mini)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AISummaryService and Tests to Use Config</name>
  <files>
    src/Events/Services/AISummaryService.php
    tests/Events/AISummarizationTest.php
  </files>
  <action>
**Part A: Update AISummaryService.php**

1. Remove MODEL constant (line 40):
   Delete: `private const MODEL = 'gpt-5-mini';`

2. Remove API_URL constant (line 41):
   Delete: `private const API_URL = 'https://api.openai.com/v1/chat/completions';`

3. Update callOpenAI() method signature (line 147):
   Change from: `private function callOpenAI(array $messages, string $model): array`
   Change to: `private function callOpenAI(array $messages): array`

4. Inside callOpenAI(), get URL and model from config (after apiKey check, around line 161):
   Add after apiKey null check return block:
   ```php
   $apiUrl = $this->config->getApiUrl();
   $model = $this->config->getModel();
   ```

5. Update URL usage in callOpenAI() (around line 170):
   Change from: `'url' => self::API_URL,`
   Change to: `'url' => $apiUrl,`

6. Update generateSummary() call to callOpenAI (line 104):
   Change from: `$response = $this->callOpenAI($messages, self::MODEL);`
   Change to: `$response = $this->callOpenAI($messages);`

**Part B: Update AISummarizationTest.php**

1. Update Section 3 test (lines 253-256):
   Replace:
   ```php
   // Test 3.5: Service uses gpt-5-mini model constant
   $constants = $reflection->getConstants();
   $hasModelConstant = isset($constants['MODEL']) && $constants['MODEL'] === 'gpt-5-mini';
   $runner->test('AISummaryService uses gpt-5-mini model constant', $hasModelConstant);
   ```
   With:
   ```php
   // Test 3.5: OpenAIConfig provides correct default model
   $testConfig = new OpenAIConfig();
   $defaultModel = $testConfig->getModel();
   $runner->test('OpenAIConfig::getModel() returns gpt-4o-mini by default', $defaultModel === 'gpt-4o-mini');
   ```

2. Update Section 21 tests (lines 1111-1126):
   Replace the API_URL constant test (lines 1111-1117):
   ```php
   // Test 21.2: API URL is correct
   $hasApiUrl = isset($constants['API_URL']);
   $runner->test('AISummaryService has API_URL constant', $hasApiUrl);

   if ($hasApiUrl) {
       $urlIsCorrect = $constants['API_URL'] === 'https://api.openai.com/v1/chat/completions';
       $runner->test('API URL is https://api.openai.com/v1/chat/completions', $urlIsCorrect);
   }
   ```
   With:
   ```php
   // Test 21.2: Default API URL is correct
   $testConfigUrl = new OpenAIConfig();
   $defaultUrl = $testConfigUrl->getApiUrl();
   $urlIsCorrect = $defaultUrl === 'https://api.openai.com/v1/chat/completions';
   $runner->test('OpenAIConfig::getApiUrl() returns OpenAI endpoint by default', $urlIsCorrect);
   ```

3. Replace the MODEL constant test (lines 1119-1126):
   Replace:
   ```php
   // Test 21.3: Model constant is 'gpt-5-mini'
   $hasModel = isset($constants['MODEL']);
   $runner->test('AISummaryService has MODEL constant (verified)', $hasModel);

   if ($hasModel) {
       $modelIsGpt5Mini = $constants['MODEL'] === 'gpt-5-mini';
       $runner->test('Model constant is gpt-5-mini (verified)', $modelIsGpt5Mini);
   }
   ```
   With:
   ```php
   // Test 21.3: Default model is gpt-4o-mini
   $testConfigModel = new OpenAIConfig();
   $defaultModelValue = $testConfigModel->getModel();
   $modelIsGpt4oMini = $defaultModelValue === 'gpt-4o-mini';
   $runner->test('OpenAIConfig::getModel() returns gpt-4o-mini (QUAL-01 verified)', $modelIsGpt4oMini);

   // Test 21.3b: Custom model can be set via WordPress option
   update_option(OpenAIConfig::OPTION_MODEL, 'gpt-4o');
   $customConfig = new OpenAIConfig();
   $customModel = $customConfig->getModel();
   $runner->test('OpenAIConfig::getModel() returns custom model from options', $customModel === 'gpt-4o');
   delete_option(OpenAIConfig::OPTION_MODEL);

   // Test 21.3c: Custom API URL can be set via WordPress option
   update_option(OpenAIConfig::OPTION_API_URL, 'https://custom.openai.azure.com/v1/chat');
   $customUrlConfig = new OpenAIConfig();
   $customUrl = $customUrlConfig->getApiUrl();
   $runner->test('OpenAIConfig::getApiUrl() returns custom URL from options (QUAL-04 verified)', $customUrl === 'https://custom.openai.azure.com/v1/chat');
   delete_option(OpenAIConfig::OPTION_API_URL);
   ```
  </action>
  <verify>
Run: `php -l src/Events/Services/AISummaryService.php` - no syntax errors
Run: `php -l tests/Events/AISummarizationTest.php` - no syntax errors
Run test file: `php /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core/tests/Events/AISummarizationTest.php`
Verify: All tests pass, including new config verification tests
  </verify>
  <done>
AISummaryService uses $this->config->getApiUrl() and $this->config->getModel() instead of constants
Tests verify config methods return correct defaults (gpt-4o-mini, OpenAI endpoint)
Tests verify custom options can override defaults (QUAL-01 and QUAL-04 satisfied)
  </done>
</task>

</tasks>

<verification>
1. PHP syntax check passes on all 3 modified files
2. Test file runs successfully
3. All existing tests continue to pass
4. New tests verify:
   - Default model is `gpt-4o-mini` (not `gpt-5-mini`)
   - Default API URL is OpenAI endpoint
   - Custom model can be set via WordPress option
   - Custom API URL can be set via WordPress option
5. Grep for `gpt-5-mini` returns no matches in codebase
</verification>

<success_criteria>
1. `gpt-5-mini` string no longer appears in codebase
2. `gpt-4o-mini` is the default model
3. API URL defaults to OpenAI but can be changed via `wecoza_openai_api_url` option
4. Model can be changed via `wecoza_openai_model` option
5. All tests pass (100% pass rate)
</success_criteria>

<output>
After completion, create `.planning/phases/11-ai-service-quality/11-01-SUMMARY.md`
</output>
