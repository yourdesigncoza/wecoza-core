---
phase: 01-code-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/Events/Controllers/TaskController.php
  - src/Events/Controllers/MaterialTrackingController.php
  - src/Events/Controllers/JsonResponder.php
  - src/Events/Controllers/ClassChangeController.php
  - src/Events/Shortcodes/EventTasksShortcode.php
  - src/Events/Shortcodes/AISummaryShortcode.php
  - src/Events/Shortcodes/MaterialTrackingShortcode.php
  - src/Events/Views/Presenters/ClassTaskPresenter.php
  - src/Events/Views/Presenters/NotificationEmailPresenter.php
  - src/Events/Views/Presenters/AISummaryPresenter.php
  - src/Events/Views/Presenters/MaterialTrackingPresenter.php
  - src/Events/Views/TemplateRenderer.php
  - src/Events/Views/ConsoleView.php
  - src/Events/Admin/SettingsPage.php
  - src/Events/CLI/AISummaryStatusCommand.php
  - views/events/event-tasks/main.php
  - views/events/event-tasks/email-summary.php
  - views/events/ai-summary/main.php
  - views/events/ai-summary/timeline.php
  - views/events/ai-summary/card.php
  - views/events/material-tracking/dashboard.php
  - views/events/material-tracking/list-item.php
  - views/events/material-tracking/statistics.php
  - views/events/material-tracking/empty-state.php
autonomous: true

must_haves:
  truths:
    - "Shortcodes can be registered without errors"
    - "Controllers respond to AJAX requests"
    - "View templates render without namespace errors"
    - "CLI command can be registered with WP-CLI"
    - "Admin settings page can be registered"
  artifacts:
    - path: "src/Events/Shortcodes/EventTasksShortcode.php"
      provides: "Event tasks dashboard shortcode"
      contains: "namespace WeCoza\\Events\\Shortcodes"
    - path: "src/Events/Controllers/TaskController.php"
      provides: "Task AJAX handler"
      contains: "namespace WeCoza\\Events\\Controllers"
    - path: "views/events/event-tasks/main.php"
      provides: "Event tasks main view template"
      min_lines: 10
  key_links:
    - from: "src/Events/Shortcodes/EventTasksShortcode.php"
      to: "src/Events/Services/ClassTaskService.php"
      via: "service injection"
      pattern: "ClassTaskService"
    - from: "src/Events/Controllers/TaskController.php"
      to: "src/Events/Services/TaskManager.php"
      via: "service injection"
      pattern: "TaskManager"
    - from: "src/Events/Shortcodes/EventTasksShortcode.php"
      to: "views/events/event-tasks/main.php"
      via: "template rendering"
      pattern: "wecoza_view|TemplateRenderer"
---

<objective>
Migrate all interface layer classes (Controllers, Shortcodes, Presenters, Views, CLI, Admin) to complete the Events module code migration.

Purpose: This is the final plan for Phase 1. It migrates all user-facing components: shortcodes that WordPress calls, controllers that handle AJAX, presenters that format data, view templates that render HTML, CLI commands, and admin settings. After this plan, all Events module PHP code exists in wecoza-core with correct namespaces.

Output:
- 4 Controllers under `src/Events/Controllers/`
- 3 Shortcodes under `src/Events/Shortcodes/`
- 6 Presenter/View classes under `src/Events/Views/`
- 1 Admin class under `src/Events/Admin/`
- 1 CLI command under `src/Events/CLI/`
- 9 View templates under `views/events/`
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-code-foundation/01-CONTEXT.md
@.planning/phases/01-code-foundation/01-RESEARCH.md

# Prior plan summaries
@.planning/phases/01-code-foundation/01-01-SUMMARY.md
@.planning/phases/01-code-foundation/01-02-SUMMARY.md

# Source files to migrate
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Controllers/TaskController.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Controllers/MaterialTrackingController.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Controllers/JsonResponder.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Controllers/ClassChangeController.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Shortcodes/EventTasksShortcode.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Shortcodes/AISummaryShortcode.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Shortcodes/MaterialTrackingShortcode.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/Presenters/ClassTaskPresenter.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/Presenters/NotificationEmailPresenter.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/Presenters/AISummaryPresenter.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/Presenters/MaterialTrackingPresenter.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/TemplateRenderer.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/ConsoleView.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Admin/SettingsPage.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/CLI/AISummaryStatusCommand.php

# View templates to migrate
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/event-tasks/main.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/event-tasks/email-summary.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/ai-summary/main.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/ai-summary/timeline.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/ai-summary/card.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/material-tracking/dashboard.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/material-tracking/list-item.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/material-tracking/statistics.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Views/material-tracking/empty-state.php

# Existing wecoza-core patterns
@src/Learners/Shortcodes/learners-display-shortcode.php
@core/Helpers/functions.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Controllers and Shortcodes</name>
  <files>
    src/Events/Controllers/TaskController.php
    src/Events/Controllers/MaterialTrackingController.php
    src/Events/Controllers/JsonResponder.php
    src/Events/Controllers/ClassChangeController.php
    src/Events/Shortcodes/EventTasksShortcode.php
    src/Events/Shortcodes/AISummaryShortcode.php
    src/Events/Shortcodes/MaterialTrackingShortcode.php
  </files>
  <action>
    Migrate Controllers and Shortcodes from wecoza-events-plugin:

    **Controllers - apply standard transformations:**

    1. **File location:**
       - `includes/Controllers/*.php` -> `src/Events/Controllers/*.php`

    2. **Namespace:**
       ```php
       namespace WeCoza\Events\Controllers;
       ```

    3. **Use statements update:**
       - `use WeCozaEvents\Services\*` -> `use WeCoza\Events\Services\*`
       - `use WeCozaEvents\Support\*` -> `use WeCoza\Events\Support\*`
       - `use WeCozaEvents\Views\Presenters\*` -> `use WeCoza\Events\Views\Presenters\*`
       - `use WeCozaEvents\Database\Connection` -> REMOVE or replace with `use WeCoza\Core\Database\PostgresConnection`

    4. **Database connection replacement (INFRA-03):**
       If any Controller has direct database access:
       - `Connection::getPdo()` -> `PostgresConnection::getInstance()->getPdo()`
       - Remove all schema qualification from SQL queries

    5. **WordPress exit check** at top of each file.

    **Shortcodes - apply same transformations plus:**

    1. **File location:**
       - `includes/Shortcodes/*.php` -> `src/Events/Shortcodes/*.php`

    2. **Namespace:**
       ```php
       namespace WeCoza\Events\Shortcodes;
       ```

    3. **Template rendering update:**
       If shortcode uses custom TemplateRenderer:
       - Update namespace: `use WeCoza\Events\Views\TemplateRenderer;`

       Consider updating to use wecoza-core's `wecoza_view()` helper for consistency:
       ```php
       // Option A: Keep TemplateRenderer (less work)
       $renderer = new TemplateRenderer();
       return $renderer->render('event-tasks/main', $data);

       // Option B: Use wecoza_view (more consistent with core)
       return wecoza_view('events/event-tasks/main', $data, true);
       ```
       **Decision:** Keep TemplateRenderer for now (less refactoring risk). Can convert to wecoza_view() in a later optimization phase.

    **Files to migrate:**
    - Controllers: `TaskController.php`, `MaterialTrackingController.php`, `JsonResponder.php`, `ClassChangeController.php`
    - Shortcodes: `EventTasksShortcode.php`, `AISummaryShortcode.php`, `MaterialTrackingShortcode.php`
  </action>
  <verify>
    - `grep "namespace WeCoza\\Events\\Controllers" src/Events/Controllers/*.php | wc -l` returns 4
    - `grep "namespace WeCoza\\Events\\Shortcodes" src/Events/Shortcodes/*.php | wc -l` returns 3
    - `grep "WeCozaEvents" src/Events/Controllers/*.php src/Events/Shortcodes/*.php` returns no matches
    - `grep "Connection::getPdo" src/Events/Controllers/*.php` returns no matches (INFRA-03 verified)
    - `php -l src/Events/Controllers/TaskController.php` returns no syntax errors
    - `php -l src/Events/Shortcodes/EventTasksShortcode.php` returns no syntax errors
  </verify>
  <done>
    4 Controller classes and 3 Shortcode classes migrated with correct namespaces. All use statements updated to reference WeCoza\Events\* namespace. No references to old Connection::getPdo() in Controllers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Presenters, TemplateRenderer, and helper View classes</name>
  <files>
    src/Events/Views/Presenters/ClassTaskPresenter.php
    src/Events/Views/Presenters/NotificationEmailPresenter.php
    src/Events/Views/Presenters/AISummaryPresenter.php
    src/Events/Views/Presenters/MaterialTrackingPresenter.php
    src/Events/Views/TemplateRenderer.php
    src/Events/Views/ConsoleView.php
  </files>
  <action>
    Migrate View helper classes (Presenters, TemplateRenderer, ConsoleView):

    **Create directory structure:**
    - `src/Events/Views/`
    - `src/Events/Views/Presenters/`

    **Presenter classes migration:**

    1. **File location:**
       - `includes/Views/Presenters/*.php` -> `src/Events/Views/Presenters/*.php`

    2. **Namespace:**
       ```php
       namespace WeCoza\Events\Views\Presenters;
       ```

    3. **Use statements update:**
       - `use WeCozaEvents\Models\*` -> `use WeCoza\Events\Models\*`

    4. **WordPress exit check.**

    **TemplateRenderer migration:**

    1. **File location:**
       - `includes/Views/TemplateRenderer.php` -> `src/Events/Views/TemplateRenderer.php`

    2. **Namespace:**
       ```php
       namespace WeCoza\Events\Views;
       ```

    3. **Template path update:**
       The TemplateRenderer likely has a base path for finding templates. Update it to point to wecoza-core's views directory:

       BEFORE (if hardcoded):
       ```php
       private string $basePath = __DIR__ . '/';
       // or
       private string $basePath = WECOZA_EVENTS_PLUGIN_DIR . 'includes/Views/';
       ```

       AFTER:
       ```php
       private string $basePath;

       public function __construct(?string $basePath = null)
       {
           $this->basePath = $basePath ?? wecoza_plugin_path('views/events/');
       }
       ```

       This allows templates to be loaded from `views/events/` in wecoza-core.

    **ConsoleView migration:**
    Standard namespace update. ConsoleView is likely a CLI helper for output formatting.

    **Files to migrate:**
    - Presenters: `ClassTaskPresenter.php`, `NotificationEmailPresenter.php`, `AISummaryPresenter.php`, `MaterialTrackingPresenter.php`
    - View helpers: `TemplateRenderer.php`, `ConsoleView.php`
  </action>
  <verify>
    - `grep "namespace WeCoza\\Events\\Views\\Presenters" src/Events/Views/Presenters/*.php | wc -l` returns 4
    - `grep "namespace WeCoza\\Events\\Views" src/Events/Views/TemplateRenderer.php` returns match
    - `grep "WeCozaEvents" src/Events/Views/*.php src/Events/Views/Presenters/*.php` returns no matches
    - `grep "wecoza_plugin_path\|views/events" src/Events/Views/TemplateRenderer.php` confirms path updated
    - `php -l src/Events/Views/TemplateRenderer.php` returns no syntax errors
  </verify>
  <done>
    4 Presenter classes, TemplateRenderer, and ConsoleView migrated. TemplateRenderer base path updated to use wecoza-core's views/events/ directory.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate Admin and CLI classes</name>
  <files>
    src/Events/Admin/SettingsPage.php
    src/Events/CLI/AISummaryStatusCommand.php
  </files>
  <action>
    Migrate Admin settings and CLI command:

    **SettingsPage migration:**

    1. **File location:**
       - `includes/Admin/SettingsPage.php` -> `src/Events/Admin/SettingsPage.php`

    2. **Namespace:**
       ```php
       namespace WeCoza\Events\Admin;
       ```

    3. **Use statements update** for any Events namespace references.

    4. **WordPress exit check.**

    **AISummaryStatusCommand migration:**

    1. **File location:**
       - `includes/CLI/AISummaryStatusCommand.php` -> `src/Events/CLI/AISummaryStatusCommand.php`

    2. **Namespace:**
       ```php
       namespace WeCoza\Events\CLI;
       ```

    3. **Use statements update:**
       - `use WeCozaEvents\Services\AISummaryService` -> `use WeCoza\Events\Services\AISummaryService`
       - `use WeCozaEvents\Support\OpenAIConfig` -> `use WeCoza\Events\Support\OpenAIConfig`

    4. **WordPress exit check.**
  </action>
  <verify>
    - `grep "namespace WeCoza\\Events\\Admin" src/Events/Admin/SettingsPage.php` returns match
    - `grep "namespace WeCoza\\Events\\CLI" src/Events/CLI/AISummaryStatusCommand.php` returns match
    - `grep "WeCozaEvents" src/Events/Admin/SettingsPage.php src/Events/CLI/AISummaryStatusCommand.php` returns no matches
    - `php -l src/Events/Admin/SettingsPage.php` returns no syntax errors
    - `php -l src/Events/CLI/AISummaryStatusCommand.php` returns no syntax errors
  </verify>
  <done>
    Admin SettingsPage and CLI AISummaryStatusCommand migrated with correct namespaces. All WeCozaEvents references replaced with WeCoza\Events.
  </done>
</task>

<task type="auto">
  <name>Task 4: Migrate view templates</name>
  <files>
    views/events/event-tasks/main.php
    views/events/event-tasks/email-summary.php
    views/events/ai-summary/main.php
    views/events/ai-summary/timeline.php
    views/events/ai-summary/card.php
    views/events/material-tracking/dashboard.php
    views/events/material-tracking/list-item.php
    views/events/material-tracking/statistics.php
    views/events/material-tracking/empty-state.php
  </files>
  <action>
    Migrate view templates from wecoza-events-plugin:

    **Create directory structure:**
    ```
    views/events/
    ├── event-tasks/
    │   ├── main.php
    │   └── email-summary.php
    ├── ai-summary/
    │   ├── main.php
    │   ├── timeline.php
    │   └── card.php
    └── material-tracking/
        ├── dashboard.php
        ├── list-item.php
        ├── statistics.php
        └── empty-state.php
    ```

    **Template file location:**
    - `includes/Views/event-tasks/*.php` -> `views/events/event-tasks/*.php`
    - `includes/Views/ai-summary/*.php` -> `views/events/ai-summary/*.php`
    - `includes/Views/material-tracking/*.php` -> `views/events/material-tracking/*.php`

    **Namespace updates in templates:**
    Templates may have `use` statements or fully-qualified class names. Update all:
    - `WeCozaEvents\Models\*` -> `WeCoza\Events\Models\*`
    - `WeCozaEvents\Views\Presenters\*` -> `WeCoza\Events\Views\Presenters\*`

    **Do NOT add `if (!defined('ABSPATH')) exit;`** to template files - they are included, not autoloaded.

    **Note:** Skip `email-summary-bu.php` (backup file - don't migrate).
  </action>
  <verify>
    Verify templates exist and have updated namespaces using explicit paths (no globs to avoid backup files):
    - `ls views/events/event-tasks/main.php views/events/event-tasks/email-summary.php` confirms event-tasks templates exist
    - `ls views/events/ai-summary/main.php views/events/ai-summary/timeline.php views/events/ai-summary/card.php` confirms ai-summary templates exist
    - `ls views/events/material-tracking/dashboard.php views/events/material-tracking/list-item.php views/events/material-tracking/statistics.php views/events/material-tracking/empty-state.php` confirms material-tracking templates exist
    - `grep "WeCozaEvents" views/events/event-tasks/main.php views/events/ai-summary/main.php views/events/ai-summary/timeline.php views/events/ai-summary/card.php views/events/material-tracking/dashboard.php views/events/material-tracking/list-item.php views/events/material-tracking/statistics.php views/events/material-tracking/empty-state.php` returns no matches
    - `php -l views/events/event-tasks/main.php` returns no syntax errors
    - `php -l views/events/material-tracking/dashboard.php` returns no syntax errors
  </verify>
  <done>
    9 view templates migrated to views/events/ directory structure. All namespace references updated from WeCozaEvents to WeCoza\Events.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the complete Phase 1 migration:

1. **All PHP classes use correct namespace:**
   ```bash
   grep -r "namespace WeCoza\\Events" src/Events/ | wc -l
   ```
   (Should be 25+ files)

2. **No old namespace references anywhere:**
   ```bash
   grep -r "WeCozaEvents" src/Events/ && echo "FAIL" || echo "PASS"
   ```

3. **No old namespace in view templates (explicit paths):**
   ```bash
   grep "WeCozaEvents" views/events/event-tasks/main.php views/events/event-tasks/email-summary.php views/events/ai-summary/main.php views/events/ai-summary/timeline.php views/events/ai-summary/card.php views/events/material-tracking/dashboard.php views/events/material-tracking/list-item.php views/events/material-tracking/statistics.php views/events/material-tracking/empty-state.php && echo "FAIL" || echo "PASS"
   ```

4. **Directory structure complete:**
   ```bash
   ls -la src/Events/
   ls -la views/events/
   ```

5. **PHP syntax valid for all files:**
   ```bash
   find src/Events -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
   php -l views/events/event-tasks/main.php 2>&1 | grep -v "No syntax errors"
   php -l views/events/material-tracking/dashboard.php 2>&1 | grep -v "No syntax errors"
   ```

6. **Autoloader resolves all classes:**
   ```bash
   cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core
   php -r "
   require 'vendor/autoload.php';
   \$classes = [
       'WeCoza\\Events\\Controllers\\TaskController',
       'WeCoza\\Events\\Shortcodes\\EventTasksShortcode',
       'WeCoza\\Events\\Views\\Presenters\\ClassTaskPresenter',
       'WeCoza\\Events\\Admin\\SettingsPage',
       'WeCoza\\Events\\CLI\\AISummaryStatusCommand'
   ];
   foreach (\$classes as \$c) {
       echo class_exists(\$c) ? \"OK: \$c\" : \"FAIL: \$c\";
       echo PHP_EOL;
   }
   "
   ```
</verification>

<success_criteria>
- [ ] 4 Controller classes migrated under src/Events/Controllers/
- [ ] 3 Shortcode classes migrated under src/Events/Shortcodes/
- [ ] 4 Presenter classes migrated under src/Events/Views/Presenters/
- [ ] TemplateRenderer and ConsoleView migrated under src/Events/Views/
- [ ] SettingsPage migrated under src/Events/Admin/
- [ ] AISummaryStatusCommand migrated under src/Events/CLI/
- [ ] 9 view templates migrated under views/events/
- [ ] All files use WeCoza\Events\* namespace
- [ ] Zero references to WeCozaEvents namespace in src/Events/ and views/events/
- [ ] Zero references to Connection::getPdo() in Controllers (INFRA-03)
- [ ] TemplateRenderer base path updated for wecoza-core views directory
- [ ] PHP syntax check passes for all migrated files
- [ ] Composer autoloader can resolve all interface layer classes
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-foundation/01-03-SUMMARY.md` using the summary template.

This completes Phase 1: Code Foundation. All Events module PHP code now exists in wecoza-core with correct namespaces and PSR-4 autoloading. Phase 2 (Database Migration) can begin.
</output>
