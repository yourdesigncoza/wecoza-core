---
phase: 01-code-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - src/Events/Models/Task.php
  - src/Events/Models/TaskCollection.php
  - src/Events/Models/ClassChangeSchema.php
  - src/Events/Repositories/ClassTaskRepository.php
  - src/Events/Repositories/ClassChangeLogRepository.php
  - src/Events/Repositories/MaterialTrackingRepository.php
  - src/Events/Support/OpenAIConfig.php
  - src/Events/Support/FieldMapper.php
  - src/Events/Support/WordPressRequest.php
autonomous: true

must_haves:
  truths:
    - "WeCoza\\Events\\* namespace resolves via Composer autoloader"
    - "Repository classes can be instantiated without require_once"
    - "Repositories use PostgresConnection instead of events Connection class"
    - "Model classes (Task, TaskCollection, ClassChangeSchema) are autoloadable"
  artifacts:
    - path: "composer.json"
      provides: "PSR-4 mapping for WeCoza\\Events\\ namespace"
      contains: "WeCoza\\\\Events\\\\"
    - path: "src/Events/Models/Task.php"
      provides: "Task domain model"
      contains: "namespace WeCoza\\Events\\Models"
    - path: "src/Events/Repositories/ClassTaskRepository.php"
      provides: "Task database access"
      contains: "extends BaseRepository"
  key_links:
    - from: "src/Events/Repositories/ClassTaskRepository.php"
      to: "core/Abstract/BaseRepository.php"
      via: "extends BaseRepository"
      pattern: "extends BaseRepository"
    - from: "src/Events/Repositories/ClassTaskRepository.php"
      to: "core/Database/PostgresConnection.php"
      via: "inherited $this->db property"
      pattern: "\\$this->db"
---

<objective>
Establish Events module foundation in wecoza-core with PSR-4 autoloading and migrate core data layer classes (excluding Container.php which depends on Services).

Purpose: Creates the directory structure and migrates the foundational classes (Models, Repositories, Support utilities) that all other Events components depend on. This enables subsequent plans to build on a working autoloader and data access layer.

Output:
- `src/Events/` directory structure with Models/, Repositories/, Support/ subdirectories
- Composer PSR-4 mapping for `WeCoza\Events\*` namespace
- 9 migrated PHP classes with updated namespaces and database connection
- Note: Container.php is deferred to Plan 02 (depends on Services being available)
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-code-foundation/01-CONTEXT.md
@.planning/phases/01-code-foundation/01-RESEARCH.md

# Source files to migrate
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Models/Task.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Models/TaskCollection.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Models/ClassChangeSchema.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Models/ClassTaskRepository.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Models/ClassChangeLogRepository.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Models/MaterialTrackingRepository.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Support/OpenAIConfig.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Support/FieldMapper.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Support/WordPressRequest.php

# Target patterns to follow
@core/Abstract/BaseRepository.php
@core/Database/PostgresConnection.php
@src/Learners/Repositories/LearnerRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory structure and update Composer PSR-4</name>
  <files>
    composer.json
    src/Events/Models/.gitkeep
    src/Events/Repositories/.gitkeep
    src/Events/Services/.gitkeep
    src/Events/Controllers/.gitkeep
    src/Events/Shortcodes/.gitkeep
    src/Events/Support/.gitkeep
    src/Events/CLI/.gitkeep
    src/Events/Admin/.gitkeep
  </files>
  <action>
    1. Create the Events module directory structure under `src/Events/`:
       - Models/
       - Repositories/
       - Services/
       - Controllers/
       - Shortcodes/
       - Support/
       - CLI/
       - Admin/

    2. Update `composer.json` to add PSR-4 mapping for Events namespace:
       ```json
       "autoload": {
           "psr-4": {
               "WeCoza\\Core\\": "core/",
               "WeCoza\\Learners\\": "src/Learners/",
               "WeCoza\\Classes\\": "src/Classes/",
               "WeCoza\\Events\\": "src/Events/"
           }
       }
       ```

    3. Run `composer dump-autoload` to regenerate the classmap.

    Note: Do NOT create .gitkeep files - they are just placeholders in this plan. The directories will be populated by actual PHP files.
  </action>
  <verify>
    - `ls -la src/Events/` shows all subdirectories
    - `grep "Events" composer.json` shows the PSR-4 mapping
    - `composer dump-autoload` completes without errors
  </verify>
  <done>
    Directory structure exists at src/Events/ with Models/, Repositories/, Services/, Controllers/, Shortcodes/, Support/, CLI/, Admin/ subdirectories. Composer.json includes WeCoza\Events\ PSR-4 mapping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Models and Support classes with namespace conversion</name>
  <files>
    src/Events/Models/Task.php
    src/Events/Models/TaskCollection.php
    src/Events/Models/ClassChangeSchema.php
    src/Events/Support/OpenAIConfig.php
    src/Events/Support/FieldMapper.php
    src/Events/Support/WordPressRequest.php
  </files>
  <action>
    Migrate Model and Support classes from wecoza-events-plugin to wecoza-core:

    **IMPORTANT: Container.php is NOT migrated in this task.** It has factory methods that return Service instances which don't exist until Plan 02. Container.php will be migrated in Plan 02 after Services are available.

    **For each file, apply these transformations:**

    1. **Namespace conversion:**
       - `namespace WeCozaEvents\Models;` -> `namespace WeCoza\Events\Models;`
       - `namespace WeCozaEvents\Support;` -> `namespace WeCoza\Events\Support;`

    2. **Use statement updates:**
       - `use WeCozaEvents\*` -> `use WeCoza\Events\*`
       - `use WeCozaEvents\Database\Connection` -> REMOVE (not needed in Models/Support)

    3. **Add WordPress exit check** at top of each file (after opening PHP tag and namespace):
       ```php
       if (!defined('ABSPATH')) {
           exit;
       }
       ```

    **Files to migrate:**

    - `includes/Models/Task.php` -> `src/Events/Models/Task.php`
    - `includes/Models/TaskCollection.php` -> `src/Events/Models/TaskCollection.php`
    - `includes/Models/ClassChangeSchema.php` -> `src/Events/Models/ClassChangeSchema.php`
    - `includes/Support/OpenAIConfig.php` -> `src/Events/Support/OpenAIConfig.php`
    - `includes/Support/FieldMapper.php` -> `src/Events/Support/FieldMapper.php`
    - `includes/Support/WordPressRequest.php` -> `src/Events/Support/WordPressRequest.php`

    **NOT migrated here (deferred to Plan 02):**
    - `includes/Support/Container.php` - Has factory methods for Services not yet migrated
  </action>
  <verify>
    For each migrated file:
    - `grep "namespace WeCoza\\Events" src/Events/Models/*.php` shows correct namespace
    - `grep "namespace WeCoza\\Events" src/Events/Support/*.php` shows correct namespace
    - `grep "WeCozaEvents" src/Events/Models/ src/Events/Support/` returns no matches (all old namespaces replaced)
    - `ls src/Events/Support/Container.php 2>/dev/null || echo "Container.php correctly NOT migrated yet"` confirms Container not migrated
  </verify>
  <done>
    6 PHP files migrated with WeCoza\Events\* namespace. No references to WeCozaEvents namespace remain in migrated files. Container.php deferred to Plan 02.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate Repositories with BaseRepository extension and database connection replacement</name>
  <files>
    src/Events/Repositories/ClassTaskRepository.php
    src/Events/Repositories/ClassChangeLogRepository.php
    src/Events/Repositories/MaterialTrackingRepository.php
  </files>
  <action>
    Migrate Repository classes with significant refactoring to use wecoza-core's BaseRepository pattern:

    **For each repository, apply these transformations:**

    1. **Move file:**
       - `includes/Models/ClassTaskRepository.php` -> `src/Events/Repositories/ClassTaskRepository.php`
       - `includes/Models/ClassChangeLogRepository.php` -> `src/Events/Repositories/ClassChangeLogRepository.php`
       - `includes/Models/MaterialTrackingRepository.php` -> `src/Events/Repositories/MaterialTrackingRepository.php`

    2. **Namespace and imports:**
       ```php
       namespace WeCoza\Events\Repositories;

       use WeCoza\Core\Abstract\BaseRepository;
       use WeCoza\Core\Database\PostgresConnection;
       use PDO;
       use Exception;

       if (!defined('ABSPATH')) {
           exit;
       }
       ```

    3. **Extend BaseRepository:**
       ```php
       class ClassTaskRepository extends BaseRepository
       {
           protected static string $table = 'class_change_logs';
           protected static string $primaryKey = 'log_id';
       ```

    4. **Remove old constructor** (BaseRepository provides `$this->db`):
       - DELETE: `private PDO $pdo;` and `private string $schema;`
       - DELETE: Constructor with `?PDO $pdo = null, ?string $schema = null`
       - DELETE: `$this->pdo = $pdo ?? Connection::getPdo();`
       - DELETE: `$this->schema = $schema ?? Connection::getSchema();`

    5. **Replace database calls:**
       - `$this->pdo->prepare($sql)` -> `$this->db->getPdo()->prepare($sql)` OR `$this->db->query($sql, $params)`
       - Remove schema qualification: `{$this->schema}.classes` -> `classes`
       - Remove `qualifiedTableName()` and `quoteIdentifier()` helper methods

    6. **Add column whitelisting methods** (security, required by BaseRepository pattern):
       ```php
       protected function getAllowedOrderColumns(): array
       {
           return ['log_id', 'class_id', 'changed_at', 'operation'];
       }

       protected function getAllowedFilterColumns(): array
       {
           return ['log_id', 'class_id', 'operation'];
       }
       ```

    7. **Update query methods** to use unqualified table names and $this->db pattern.

    **CRITICAL:** The events plugin uses schema-qualified table names (`{$schema}.classes`).
    Remove ALL schema qualification - wecoza-core assumes 'public' schema.

    **Example transformation (ClassTaskRepository):**

    BEFORE:
    ```php
    $classesTable = $this->qualifiedTableName('classes');
    $sql = "SELECT * FROM {$classesTable} WHERE ...";
    $stmt = $this->pdo->prepare($sql);
    ```

    AFTER:
    ```php
    $sql = "SELECT * FROM classes WHERE ...";
    $stmt = $this->db->getPdo()->prepare($sql);
    // OR use: $stmt = $this->db->query($sql, $params);
    ```
  </action>
  <verify>
    - `grep "extends BaseRepository" src/Events/Repositories/*.php` shows all 3 repositories extend BaseRepository
    - `grep "Connection::getPdo" src/Events/Repositories/*.php` returns nothing (old connection class not used)
    - `grep "schema" src/Events/Repositories/*.php` returns nothing (schema qualification removed)
    - `grep "qualifiedTableName" src/Events/Repositories/*.php` returns nothing (helper removed)
    - PHP syntax check: `php -l src/Events/Repositories/*.php` returns no errors
  </verify>
  <done>
    3 Repository classes migrated to extend BaseRepository, using PostgresConnection singleton via inherited $this->db. Schema qualification removed from all SQL queries. Column whitelisting methods implemented for security.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Autoloader works:**
   ```bash
   cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core
   php -r "require 'vendor/autoload.php'; echo class_exists('WeCoza\\Events\\Models\\Task') ? 'Task OK' : 'Task FAIL'; echo PHP_EOL;"
   php -r "require 'vendor/autoload.php'; echo class_exists('WeCoza\\Events\\Repositories\\ClassTaskRepository') ? 'Repo OK' : 'Repo FAIL'; echo PHP_EOL;"
   ```

2. **No old namespace references:**
   ```bash
   grep -r "WeCozaEvents" src/Events/ && echo "FAIL: Old namespace found" || echo "PASS: No old namespace"
   ```

3. **PHP syntax valid:**
   ```bash
   find src/Events -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
   ```
   (Should produce no output if all files are valid)

4. **BaseRepository extension:**
   ```bash
   grep -l "extends BaseRepository" src/Events/Repositories/*.php | wc -l
   ```
   (Should output: 3)

5. **Container.php NOT yet migrated (deferred to Plan 02):**
   ```bash
   ls src/Events/Support/Container.php 2>/dev/null && echo "FAIL: Container migrated too early" || echo "PASS: Container deferred"
   ```
</verification>

<success_criteria>
- [ ] src/Events/ directory exists with 8 subdirectories (Models, Repositories, Services, Controllers, Shortcodes, Support, CLI, Admin)
- [ ] composer.json contains WeCoza\Events\ PSR-4 mapping
- [ ] 9 PHP files migrated (3 Models, 3 Repositories, 3 Support - excluding Container.php)
- [ ] All files use WeCoza\Events\* namespace
- [ ] Zero references to WeCozaEvents namespace in src/Events/
- [ ] All 3 Repositories extend BaseRepository
- [ ] Zero references to Connection::getPdo() (old database class)
- [ ] Zero schema-qualified table names in SQL queries
- [ ] PHP syntax check passes for all migrated files
- [ ] Composer autoloader can resolve WeCoza\Events\* classes
- [ ] Container.php NOT migrated (deferred to Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-foundation/01-01-SUMMARY.md` using the summary template.
</output>
