---
phase: 01-code-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/Events/Services/TaskManager.php
  - src/Events/Services/TaskTemplateRegistry.php
  - src/Events/Services/ClassTaskService.php
  - src/Events/Services/ClassChangeListener.php
  - src/Events/Services/PayloadFormatter.php
  - src/Events/Services/NotificationSettings.php
  - src/Events/Services/NotificationProcessor.php
  - src/Events/Services/MaterialNotificationService.php
  - src/Events/Services/MaterialTrackingDashboardService.php
  - src/Events/Services/AISummaryService.php
  - src/Events/Services/AISummaryDisplayService.php
  - src/Events/Services/Traits/DataObfuscator.php
  - src/Events/Support/Container.php
autonomous: true

must_haves:
  truths:
    - "TaskManager can be instantiated without errors"
    - "AISummaryService imports OpenAIConfig correctly"
    - "Services can use Repositories migrated in Plan 01"
    - "Container factory methods return valid service instances"
    - "Services use PostgresConnection for database access"
  artifacts:
    - path: "src/Events/Services/TaskManager.php"
      provides: "Task lifecycle management"
      contains: "namespace WeCoza\\Events\\Services"
    - path: "src/Events/Services/AISummaryService.php"
      provides: "OpenAI integration for summaries"
      contains: "namespace WeCoza\\Events\\Services"
    - path: "src/Events/Services/MaterialTrackingDashboardService.php"
      provides: "Material tracking business logic"
      contains: "namespace WeCoza\\Events\\Services"
    - path: "src/Events/Support/Container.php"
      provides: "Service factory and DI container"
      contains: "namespace WeCoza\\Events\\Support"
  key_links:
    - from: "src/Events/Services/TaskManager.php"
      to: "src/Events/Repositories/ClassTaskRepository.php"
      via: "constructor injection or method calls"
      pattern: "ClassTaskRepository"
    - from: "src/Events/Services/AISummaryService.php"
      to: "src/Events/Support/OpenAIConfig.php"
      via: "OpenAIConfig usage"
      pattern: "OpenAIConfig"
    - from: "src/Events/Services/MaterialTrackingDashboardService.php"
      to: "src/Events/Repositories/MaterialTrackingRepository.php"
      via: "repository injection"
      pattern: "MaterialTrackingRepository"
    - from: "src/Events/Support/Container.php"
      to: "src/Events/Services/*.php"
      via: "factory methods returning service instances"
      pattern: "new TaskManager|new AISummaryService"
---

<objective>
Migrate all Events service classes and Container.php with namespace conversion and database connection replacement.

Purpose: Services contain the business logic for task management, notifications, AI summaries, and material tracking. They depend on the Repositories and Support classes migrated in Plan 01. Container.php is migrated here (not in Plan 01) because its factory methods return Service instances. This completes the data/business logic layer, enabling the interface layer (Controllers, Shortcodes) to be migrated in Plan 03.

Output:
- 11 Service classes migrated under `src/Events/Services/`
- 1 Trait migrated under `src/Events/Services/Traits/`
- 1 Container class migrated under `src/Events/Support/` (deferred from Plan 01)
- All services use WeCoza\Events\* namespace and wecoza-core database connection
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-code-foundation/01-CONTEXT.md
@.planning/phases/01-code-foundation/01-RESEARCH.md

# Prior plan summary (for repository/support class locations)
@.planning/phases/01-code-foundation/01-01-SUMMARY.md

# Source files to migrate
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/TaskManager.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/TaskTemplateRegistry.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/ClassTaskService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/ClassChangeListener.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/PayloadFormatter.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/NotificationSettings.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/NotificationProcessor.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/MaterialNotificationService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/MaterialTrackingDashboardService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/AISummaryService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/AISummaryDisplayService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/AISummaryService/Traits/DataObfuscator.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Support/Container.php

# Target patterns
@core/Database/PostgresConnection.php
@src/Events/Repositories/ClassTaskRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate core task management services</name>
  <files>
    src/Events/Services/TaskManager.php
    src/Events/Services/TaskTemplateRegistry.php
    src/Events/Services/ClassTaskService.php
    src/Events/Services/ClassChangeListener.php
    src/Events/Services/PayloadFormatter.php
  </files>
  <action>
    Migrate the 5 task management service classes from wecoza-events-plugin:

    **For each file, apply these transformations:**

    1. **File location:**
       - `includes/Services/*.php` -> `src/Events/Services/*.php`

    2. **Namespace conversion:**
       ```php
       namespace WeCoza\Events\Services;
       ```

    3. **Use statement updates:**
       - `use WeCozaEvents\Models\*` -> `use WeCoza\Events\Models\*`
       - `use WeCozaEvents\Database\Connection` -> `use WeCoza\Core\Database\PostgresConnection`
       - `use WeCozaEvents\Support\*` -> `use WeCoza\Events\Support\*`
       - Add `use WeCoza\Events\Repositories\ClassTaskRepository;` where repositories are used

    4. **Database connection replacement:**
       If service has direct database access (some do, some use repositories):
       - `Connection::getPdo()` -> `PostgresConnection::getInstance()->getPdo()`
       - `Connection::getSchema()` -> REMOVE (not needed, use unqualified table names)
       - Remove schema-qualified table names

    5. **Add WordPress exit check:**
       ```php
       if (!defined('ABSPATH')) {
           exit;
       }
       ```

    **Files to migrate:**
    - `TaskManager.php` - Task lifecycle (create, complete, reopen)
    - `TaskTemplateRegistry.php` - Task type templates
    - `ClassTaskService.php` - Coordinates task operations
    - `ClassChangeListener.php` - Listens for class changes
    - `PayloadFormatter.php` - Formats change payloads

    **Special attention:** ClassChangeListener may have complex database queries. Replace ALL schema qualifications and Connection references.
  </action>
  <verify>
    - `grep "namespace WeCoza\\Events\\Services" src/Events/Services/TaskManager.php` returns match
    - `grep "WeCozaEvents" src/Events/Services/TaskManager.php src/Events/Services/TaskTemplateRegistry.php src/Events/Services/ClassTaskService.php src/Events/Services/ClassChangeListener.php src/Events/Services/PayloadFormatter.php` returns no matches
    - `php -l src/Events/Services/TaskManager.php` returns no syntax errors
  </verify>
  <done>
    5 task management services migrated with correct WeCoza\Events\Services namespace. Zero references to old WeCozaEvents namespace or Connection class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate notification and material tracking services</name>
  <files>
    src/Events/Services/NotificationSettings.php
    src/Events/Services/NotificationProcessor.php
    src/Events/Services/MaterialNotificationService.php
    src/Events/Services/MaterialTrackingDashboardService.php
  </files>
  <action>
    Migrate the 4 notification and material tracking service classes:

    **Apply standard transformations (same as Task 1):**
    1. File location: `includes/Services/*.php` -> `src/Events/Services/*.php`
    2. Namespace: `namespace WeCoza\Events\Services;`
    3. Use statement updates (WeCozaEvents -> WeCoza\Events)
    4. Database connection replacement
    5. WordPress exit check

    **MaterialNotificationService and MaterialTrackingDashboardService special handling:**

    These services have constructors accepting `PDO $pdo` and `string $schema` parameters.
    Convert to use PostgresConnection singleton pattern:

    BEFORE:
    ```php
    public function __construct(PDO $pdo, string $schema, MaterialTrackingRepository $trackingRepo)
    {
        $this->pdo = $pdo;
        $this->schema = $schema;
        $this->trackingRepo = $trackingRepo;
    }
    ```

    AFTER:
    ```php
    private PostgresConnection $db;
    private MaterialTrackingRepository $trackingRepo;

    public function __construct(?MaterialTrackingRepository $trackingRepo = null)
    {
        $this->db = PostgresConnection::getInstance();
        $this->trackingRepo = $trackingRepo ?? new MaterialTrackingRepository();
    }
    ```

    Then update method bodies:
    - `$this->pdo->prepare($sql)` -> `$this->db->getPdo()->prepare($sql)`
    - Remove all schema qualification from SQL queries

    **Files to migrate:**
    - `NotificationSettings.php` - Email notification configuration
    - `NotificationProcessor.php` - Processes pending notifications
    - `MaterialNotificationService.php` - 7-day/5-day material alerts
    - `MaterialTrackingDashboardService.php` - Dashboard data retrieval
  </action>
  <verify>
    - `grep "namespace WeCoza\\Events\\Services" src/Events/Services/NotificationSettings.php` returns match
    - `grep "\\$this->schema" src/Events/Services/MaterialNotificationService.php src/Events/Services/MaterialTrackingDashboardService.php` returns no matches (schema removed)
    - `grep "Connection::getPdo" src/Events/Services/*.php` returns no matches
    - `php -l src/Events/Services/MaterialNotificationService.php` returns no syntax errors
  </verify>
  <done>
    4 notification/material services migrated. Constructor signatures updated to use PostgresConnection singleton. Schema qualification removed from all SQL queries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate AI summary services, traits, and Container.php</name>
  <files>
    src/Events/Services/AISummaryService.php
    src/Events/Services/AISummaryDisplayService.php
    src/Events/Services/Traits/DataObfuscator.php
    src/Events/Support/Container.php
  </files>
  <action>
    Migrate the AI summary services, the DataObfuscator trait, and Container.php:

    **Create Traits subdirectory:**
    - Create `src/Events/Services/Traits/` directory

    **DataObfuscator trait migration:**
    ```php
    namespace WeCoza\Events\Services\Traits;

    if (!defined('ABSPATH')) {
        exit;
    }

    trait DataObfuscator
    {
        // ... existing trait methods
    }
    ```

    **AISummaryService migration:**

    1. Namespace: `namespace WeCoza\Events\Services;`

    2. Use statements:
       ```php
       use WeCoza\Events\Services\Traits\DataObfuscator;
       use WeCoza\Events\Support\OpenAIConfig;
       use WeCoza\Events\Repositories\ClassChangeLogRepository;
       use WeCoza\Core\Database\PostgresConnection;
       ```

    3. Database connection:
       If AISummaryService has direct PDO access, convert to PostgresConnection singleton pattern (same as Task 2).

    4. The `use DataObfuscator;` trait statement stays the same (just namespace changes).

    **AISummaryDisplayService migration:**

    Standard namespace and use statement updates. This service primarily reads and displays summaries, less likely to have direct database access.

    **Container.php migration (deferred from Plan 01):**

    Container.php has factory methods that return repository/service instances. Now that services are migrated, Container can be safely migrated.

    1. **File location:**
       - `includes/Support/Container.php` -> `src/Events/Support/Container.php`

    2. **Namespace:**
       ```php
       namespace WeCoza\Events\Support;
       ```

    3. **Use statement updates:**
       ```php
       use WeCoza\Events\Services\TaskManager;
       use WeCoza\Events\Services\AISummaryService;
       use WeCoza\Events\Services\ClassTaskService;
       // ... all other service imports
       use WeCoza\Events\Repositories\ClassTaskRepository;
       use WeCoza\Events\Repositories\ClassChangeLogRepository;
       use WeCoza\Events\Repositories\MaterialTrackingRepository;
       ```

    4. **Update all factory method return types and instantiations** to use new namespaces.

    5. **WordPress exit check.**

    **Files to migrate:**
    - `includes/Services/AISummaryService/Traits/DataObfuscator.php` -> `src/Events/Services/Traits/DataObfuscator.php`
    - `includes/Services/AISummaryService.php` -> `src/Events/Services/AISummaryService.php`
    - `includes/Services/AISummaryDisplayService.php` -> `src/Events/Services/AISummaryDisplayService.php`
    - `includes/Support/Container.php` -> `src/Events/Support/Container.php`
  </action>
  <verify>
    - `ls src/Events/Services/Traits/DataObfuscator.php` confirms trait file exists
    - `grep "use WeCoza\\Events\\Services\\Traits\\DataObfuscator" src/Events/Services/AISummaryService.php` returns match
    - `grep "use WeCoza\\Events\\Support\\OpenAIConfig" src/Events/Services/AISummaryService.php` returns match
    - `grep "WeCozaEvents" src/Events/Services/AISummaryService.php src/Events/Services/AISummaryDisplayService.php src/Events/Services/Traits/DataObfuscator.php src/Events/Support/Container.php` returns no matches
    - `php -l src/Events/Services/AISummaryService.php` returns no syntax errors
    - `php -l src/Events/Support/Container.php` returns no syntax errors
    - `grep "new TaskManager\|new AISummaryService" src/Events/Support/Container.php` confirms factory methods use new namespaces
    - Container runtime test: `php -r "require 'vendor/autoload.php'; \$c = new WeCoza\Events\Support\Container(); echo 'Container instantiation OK';"` confirms Container can be instantiated
  </verify>
  <done>
    AI summary services, DataObfuscator trait, and Container.php migrated. Trait correctly referenced from Services/Traits/ subdirectory. OpenAIConfig properly imported from Support namespace. Container factory methods updated to instantiate services with new WeCoza\Events\* namespaces. Container instantiation verified at runtime.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **All services use correct namespace:**
   ```bash
   grep -l "namespace WeCoza\\Events\\Services" src/Events/Services/*.php | wc -l
   ```
   (Should output: 11)

2. **Container.php uses correct namespace:**
   ```bash
   grep "namespace WeCoza\\Events\\Support" src/Events/Support/Container.php
   ```

3. **No old namespace references:**
   ```bash
   grep -r "WeCozaEvents" src/Events/Services/ src/Events/Support/Container.php && echo "FAIL" || echo "PASS"
   ```

4. **No old Connection class references:**
   ```bash
   grep -r "Connection::getPdo\|Connection::getSchema" src/Events/Services/ src/Events/Support/Container.php && echo "FAIL" || echo "PASS"
   ```

5. **PHP syntax valid for all services:**
   ```bash
   find src/Events/Services -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
   php -l src/Events/Support/Container.php 2>&1 | grep -v "No syntax errors"
   ```
   (Should produce no output)

6. **Autoloader resolves services:**
   ```bash
   php -r "require 'vendor/autoload.php'; echo class_exists('WeCoza\\Events\\Services\\TaskManager') ? 'OK' : 'FAIL';"
   php -r "require 'vendor/autoload.php'; echo class_exists('WeCoza\\Events\\Support\\Container') ? 'OK' : 'FAIL';"
   ```

7. **Container can instantiate and factory methods work (runtime verification):**
   ```bash
   php -r "
   require 'vendor/autoload.php';
   \$container = new WeCoza\Events\Support\Container();
   echo 'Container instantiated OK' . PHP_EOL;
   // Test one factory method if Container has a public factory (e.g., getTaskManager)
   // If Container uses static methods or different pattern, adapt accordingly
   "
   ```
</verification>

<success_criteria>
- [ ] 11 service classes migrated under src/Events/Services/
- [ ] 1 trait migrated under src/Events/Services/Traits/
- [ ] Container.php migrated under src/Events/Support/
- [ ] All files use WeCoza\Events\Services or WeCoza\Events\Support namespace
- [ ] Zero references to WeCozaEvents namespace
- [ ] Zero references to old Connection class
- [ ] Zero schema-qualified table names in SQL queries
- [ ] Services properly import Repositories from WeCoza\Events\Repositories
- [ ] AISummaryService properly imports OpenAIConfig from WeCoza\Events\Support
- [ ] Container factory methods instantiate services with correct namespaces
- [ ] PHP syntax check passes for all migrated files
- [ ] Composer autoloader can resolve all service classes and Container
- [ ] Container can be instantiated at runtime without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-foundation/01-02-SUMMARY.md` using the summary template.
</output>
