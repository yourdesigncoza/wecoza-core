---
phase: 01-code-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/Events/Services/TaskManager.php
  - src/Events/Services/TaskTemplateRegistry.php
  - src/Events/Services/ClassTaskService.php
  - src/Events/Services/ClassChangeListener.php
  - src/Events/Services/PayloadFormatter.php
  - src/Events/Services/NotificationSettings.php
  - src/Events/Services/NotificationProcessor.php
  - src/Events/Services/MaterialNotificationService.php
  - src/Events/Services/MaterialTrackingDashboardService.php
  - src/Events/Services/AISummaryService.php
  - src/Events/Services/AISummaryDisplayService.php
  - src/Events/Services/Traits/DataObfuscator.php
autonomous: true

must_haves:
  truths:
    - "Service classes can be instantiated via Composer autoloader"
    - "Services use migrated Repositories from Plan 01"
    - "Services use PostgresConnection for any direct database access"
    - "AISummaryService uses OpenAIConfig from Support namespace"
  artifacts:
    - path: "src/Events/Services/TaskManager.php"
      provides: "Task lifecycle management"
      contains: "namespace WeCoza\\Events\\Services"
    - path: "src/Events/Services/AISummaryService.php"
      provides: "OpenAI integration for summaries"
      contains: "namespace WeCoza\\Events\\Services"
    - path: "src/Events/Services/MaterialTrackingDashboardService.php"
      provides: "Material tracking business logic"
      contains: "namespace WeCoza\\Events\\Services"
  key_links:
    - from: "src/Events/Services/TaskManager.php"
      to: "src/Events/Repositories/ClassTaskRepository.php"
      via: "constructor injection or method calls"
      pattern: "ClassTaskRepository"
    - from: "src/Events/Services/AISummaryService.php"
      to: "src/Events/Support/OpenAIConfig.php"
      via: "OpenAIConfig usage"
      pattern: "OpenAIConfig"
    - from: "src/Events/Services/MaterialTrackingDashboardService.php"
      to: "src/Events/Repositories/MaterialTrackingRepository.php"
      via: "repository injection"
      pattern: "MaterialTrackingRepository"
---

<objective>
Migrate all Events service classes with namespace conversion and database connection replacement.

Purpose: Services contain the business logic for task management, notifications, AI summaries, and material tracking. They depend on the Repositories and Support classes migrated in Plan 01. This completes the data/business logic layer, enabling the interface layer (Controllers, Shortcodes) to be migrated in Plan 03.

Output:
- 11 Service classes migrated under `src/Events/Services/`
- 1 Trait migrated under `src/Events/Services/Traits/`
- All services use WeCoza\Events\* namespace and wecoza-core database connection
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-code-foundation/01-CONTEXT.md
@.planning/phases/01-code-foundation/01-RESEARCH.md

# Prior plan summary (for repository/support class locations)
@.planning/phases/01-code-foundation/01-01-SUMMARY.md

# Source files to migrate
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/TaskManager.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/TaskTemplateRegistry.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/ClassTaskService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/ClassChangeListener.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/PayloadFormatter.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/NotificationSettings.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/NotificationProcessor.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/MaterialNotificationService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/MaterialTrackingDashboardService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/AISummaryService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/AISummaryDisplayService.php
@/opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-events-plugin/includes/Services/AISummaryService/Traits/DataObfuscator.php

# Target patterns
@core/Database/PostgresConnection.php
@src/Events/Repositories/ClassTaskRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate core task management services</name>
  <files>
    src/Events/Services/TaskManager.php
    src/Events/Services/TaskTemplateRegistry.php
    src/Events/Services/ClassTaskService.php
    src/Events/Services/ClassChangeListener.php
    src/Events/Services/PayloadFormatter.php
  </files>
  <action>
    Migrate the 5 task management service classes from wecoza-events-plugin:

    **For each file, apply these transformations:**

    1. **File location:**
       - `includes/Services/*.php` -> `src/Events/Services/*.php`

    2. **Namespace conversion:**
       ```php
       namespace WeCoza\Events\Services;
       ```

    3. **Use statement updates:**
       - `use WeCozaEvents\Models\*` -> `use WeCoza\Events\Models\*`
       - `use WeCozaEvents\Database\Connection` -> `use WeCoza\Core\Database\PostgresConnection`
       - `use WeCozaEvents\Support\*` -> `use WeCoza\Events\Support\*`
       - Add `use WeCoza\Events\Repositories\ClassTaskRepository;` where repositories are used

    4. **Database connection replacement:**
       If service has direct database access (some do, some use repositories):
       - `Connection::getPdo()` -> `PostgresConnection::getInstance()->getPdo()`
       - `Connection::getSchema()` -> REMOVE (not needed, use unqualified table names)
       - Remove schema-qualified table names

    5. **Add WordPress exit check:**
       ```php
       if (!defined('ABSPATH')) {
           exit;
       }
       ```

    **Files to migrate:**
    - `TaskManager.php` - Task lifecycle (create, complete, reopen)
    - `TaskTemplateRegistry.php` - Task type templates
    - `ClassTaskService.php` - Coordinates task operations
    - `ClassChangeListener.php` - Listens for class changes
    - `PayloadFormatter.php` - Formats change payloads

    **Special attention:** ClassChangeListener may have complex database queries. Replace ALL schema qualifications and Connection references.
  </action>
  <verify>
    - `grep "namespace WeCoza\\Events\\Services" src/Events/Services/TaskManager.php` returns match
    - `grep "WeCozaEvents" src/Events/Services/TaskManager.php src/Events/Services/TaskTemplateRegistry.php src/Events/Services/ClassTaskService.php src/Events/Services/ClassChangeListener.php src/Events/Services/PayloadFormatter.php` returns no matches
    - `php -l src/Events/Services/TaskManager.php` returns no syntax errors
  </verify>
  <done>
    5 task management services migrated with correct WeCoza\Events\Services namespace. Zero references to old WeCozaEvents namespace or Connection class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate notification and material tracking services</name>
  <files>
    src/Events/Services/NotificationSettings.php
    src/Events/Services/NotificationProcessor.php
    src/Events/Services/MaterialNotificationService.php
    src/Events/Services/MaterialTrackingDashboardService.php
  </files>
  <action>
    Migrate the 4 notification and material tracking service classes:

    **Apply standard transformations (same as Task 1):**
    1. File location: `includes/Services/*.php` -> `src/Events/Services/*.php`
    2. Namespace: `namespace WeCoza\Events\Services;`
    3. Use statement updates (WeCozaEvents -> WeCoza\Events)
    4. Database connection replacement
    5. WordPress exit check

    **MaterialNotificationService and MaterialTrackingDashboardService special handling:**

    These services have constructors accepting `PDO $pdo` and `string $schema` parameters.
    Convert to use PostgresConnection singleton pattern:

    BEFORE:
    ```php
    public function __construct(PDO $pdo, string $schema, MaterialTrackingRepository $trackingRepo)
    {
        $this->pdo = $pdo;
        $this->schema = $schema;
        $this->trackingRepo = $trackingRepo;
    }
    ```

    AFTER:
    ```php
    private PostgresConnection $db;
    private MaterialTrackingRepository $trackingRepo;

    public function __construct(?MaterialTrackingRepository $trackingRepo = null)
    {
        $this->db = PostgresConnection::getInstance();
        $this->trackingRepo = $trackingRepo ?? new MaterialTrackingRepository();
    }
    ```

    Then update method bodies:
    - `$this->pdo->prepare($sql)` -> `$this->db->getPdo()->prepare($sql)`
    - Remove all schema qualification from SQL queries

    **Files to migrate:**
    - `NotificationSettings.php` - Email notification configuration
    - `NotificationProcessor.php` - Processes pending notifications
    - `MaterialNotificationService.php` - 7-day/5-day material alerts
    - `MaterialTrackingDashboardService.php` - Dashboard data retrieval
  </action>
  <verify>
    - `grep "namespace WeCoza\\Events\\Services" src/Events/Services/NotificationSettings.php` returns match
    - `grep "\\$this->schema" src/Events/Services/MaterialNotificationService.php src/Events/Services/MaterialTrackingDashboardService.php` returns no matches (schema removed)
    - `grep "Connection::getPdo" src/Events/Services/*.php` returns no matches
    - `php -l src/Events/Services/MaterialNotificationService.php` returns no syntax errors
  </verify>
  <done>
    4 notification/material services migrated. Constructor signatures updated to use PostgresConnection singleton. Schema qualification removed from all SQL queries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Migrate AI summary services and traits</name>
  <files>
    src/Events/Services/AISummaryService.php
    src/Events/Services/AISummaryDisplayService.php
    src/Events/Services/Traits/DataObfuscator.php
  </files>
  <action>
    Migrate the AI summary services and the DataObfuscator trait:

    **Create Traits subdirectory:**
    - Create `src/Events/Services/Traits/` directory

    **DataObfuscator trait migration:**
    ```php
    namespace WeCoza\Events\Services\Traits;

    if (!defined('ABSPATH')) {
        exit;
    }

    trait DataObfuscator
    {
        // ... existing trait methods
    }
    ```

    **AISummaryService migration:**

    1. Namespace: `namespace WeCoza\Events\Services;`

    2. Use statements:
       ```php
       use WeCoza\Events\Services\Traits\DataObfuscator;
       use WeCoza\Events\Support\OpenAIConfig;
       use WeCoza\Events\Repositories\ClassChangeLogRepository;
       use WeCoza\Core\Database\PostgresConnection;
       ```

    3. Database connection:
       If AISummaryService has direct PDO access, convert to PostgresConnection singleton pattern (same as Task 2).

    4. The `use DataObfuscator;` trait statement stays the same (just namespace changes).

    **AISummaryDisplayService migration:**

    Standard namespace and use statement updates. This service primarily reads and displays summaries, less likely to have direct database access.

    **Files to migrate:**
    - `includes/Services/AISummaryService/Traits/DataObfuscator.php` -> `src/Events/Services/Traits/DataObfuscator.php`
    - `includes/Services/AISummaryService.php` -> `src/Events/Services/AISummaryService.php`
    - `includes/Services/AISummaryDisplayService.php` -> `src/Events/Services/AISummaryDisplayService.php`
  </action>
  <verify>
    - `ls src/Events/Services/Traits/DataObfuscator.php` confirms trait file exists
    - `grep "use WeCoza\\Events\\Services\\Traits\\DataObfuscator" src/Events/Services/AISummaryService.php` returns match
    - `grep "use WeCoza\\Events\\Support\\OpenAIConfig" src/Events/Services/AISummaryService.php` returns match
    - `grep "WeCozaEvents" src/Events/Services/AISummaryService.php src/Events/Services/AISummaryDisplayService.php src/Events/Services/Traits/DataObfuscator.php` returns no matches
    - `php -l src/Events/Services/AISummaryService.php` returns no syntax errors
  </verify>
  <done>
    AI summary services and DataObfuscator trait migrated. Trait correctly referenced from Services/Traits/ subdirectory. OpenAIConfig properly imported from Support namespace.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **All services use correct namespace:**
   ```bash
   grep -l "namespace WeCoza\\Events\\Services" src/Events/Services/*.php | wc -l
   ```
   (Should output: 11)

2. **No old namespace references:**
   ```bash
   grep -r "WeCozaEvents" src/Events/Services/ && echo "FAIL" || echo "PASS"
   ```

3. **No old Connection class references:**
   ```bash
   grep -r "Connection::getPdo\|Connection::getSchema" src/Events/Services/ && echo "FAIL" || echo "PASS"
   ```

4. **PHP syntax valid for all services:**
   ```bash
   find src/Events/Services -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
   ```
   (Should produce no output)

5. **Autoloader resolves services:**
   ```bash
   php -r "require 'vendor/autoload.php'; echo class_exists('WeCoza\\Events\\Services\\TaskManager') ? 'OK' : 'FAIL';"
   ```
</verification>

<success_criteria>
- [ ] 11 service classes migrated under src/Events/Services/
- [ ] 1 trait migrated under src/Events/Services/Traits/
- [ ] All files use WeCoza\Events\Services namespace
- [ ] Zero references to WeCozaEvents namespace
- [ ] Zero references to old Connection class
- [ ] Zero schema-qualified table names in SQL queries
- [ ] Services properly import Repositories from WeCoza\Events\Repositories
- [ ] AISummaryService properly imports OpenAIConfig from WeCoza\Events\Support
- [ ] PHP syntax check passes for all migrated files
- [ ] Composer autoloader can resolve all service classes
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-foundation/01-02-SUMMARY.md` using the summary template.
</output>
