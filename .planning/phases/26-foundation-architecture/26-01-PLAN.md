---
phase: 26-foundation-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wecoza-core.php
  - core/Database/PostgresConnection.php
  - src/Agents/Helpers/ValidationHelper.php
  - src/Agents/Helpers/FormHelpers.php
  - src/Agents/Services/WorkingAreasService.php
autonomous: true

must_haves:
  truths:
    - "WeCoza\\Agents\\ namespace resolves to src/Agents/ via PSR-4 autoloader"
    - "wecoza_db()->insert('agents', $data) returns the agent_id via RETURNING clause"
    - "ValidationHelper, FormHelpers, WorkingAreasService are loadable under WeCoza\\Agents\\ namespace"
  artifacts:
    - path: "wecoza-core.php"
      provides: "Agents namespace registration in PSR-4 autoloader"
      contains: "WeCoza\\\\Agents\\\\"
    - path: "core/Database/PostgresConnection.php"
      provides: "agent_id in RETURNING column detection list"
      contains: "agent_id"
    - path: "src/Agents/Helpers/ValidationHelper.php"
      provides: "SA ID, passport, phone, bank validation"
      contains: "namespace WeCoza\\Agents\\Helpers"
    - path: "src/Agents/Helpers/FormHelpers.php"
      provides: "Form-to-database field mapping"
      contains: "namespace WeCoza\\Agents\\Helpers"
    - path: "src/Agents/Services/WorkingAreasService.php"
      provides: "Working areas lookup data"
      contains: "namespace WeCoza\\Agents\\Services"
  key_links:
    - from: "wecoza-core.php"
      to: "src/Agents/"
      via: "PSR-4 namespace mapping"
      pattern: "WeCoza\\\\Agents\\\\.+src/Agents/"
    - from: "core/Database/PostgresConnection.php"
      to: "agents table"
      via: "RETURNING clause detection"
      pattern: "agent_id"
---

<objective>
Register the WeCoza\Agents\ namespace, fix PostgresConnection insert() RETURNING detection for agent_id, and migrate 3 helper/service files with namespace-only changes.

Purpose: Establish the autoloading foundation and database compatibility so Plan 02 (repository + model) can use wecoza_db() correctly.
Output: 5 files (1 modified, 1 patched, 3 created) — all passing php -l syntax check.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-foundation-architecture/26-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register namespace and fix PostgresConnection RETURNING detection</name>
  <files>
    wecoza-core.php
    core/Database/PostgresConnection.php
  </files>
  <action>
**wecoza-core.php** — Add `'WeCoza\\Agents\\'` namespace to the PSR-4 autoloader `$namespaces` array, mapping to `WECOZA_CORE_PATH . 'src/Agents/'`. Add it after the existing `WeCoza\\Clients\\` entry. Example:

```php
'WeCoza\\Agents\\' => WECOZA_CORE_PATH . 'src/Agents/',
```

**core/Database/PostgresConnection.php** — In the `insert()` method (around line 332), the RETURNING column detection array currently contains `['id', 'client_id', 'location_id', 'site_id', 'communication_id']`. Add `'agent_id'` to this array. The order should be: `['id', 'agent_id', 'client_id', 'location_id', 'site_id', 'communication_id']` (after 'id' since it's a common convention).

**CRITICAL:** Without adding `agent_id` to this list, `wecoza_db()->insert('agents', $data)` will NOT return the new agent's ID, breaking all create operations in Plan 02.
  </action>
  <verify>
1. `grep -n "WeCoza.*Agents" wecoza-core.php` shows namespace registration
2. `grep -n "agent_id" core/Database/PostgresConnection.php` shows agent_id in RETURNING candidates
3. `php -l wecoza-core.php` and `php -l core/Database/PostgresConnection.php` pass syntax check
  </verify>
  <done>
WeCoza\Agents\ namespace registered in autoloader. PostgresConnection::insert() detects agent_id for RETURNING clause.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate ValidationHelper, FormHelpers, and WorkingAreasService</name>
  <files>
    src/Agents/Helpers/ValidationHelper.php
    src/Agents/Helpers/FormHelpers.php
    src/Agents/Services/WorkingAreasService.php
  </files>
  <action>
Create `src/Agents/Helpers/`, `src/Agents/Services/` directories if they don't exist.

**ValidationHelper.php** — Copy from `.integrate/wecoza-agents-plugin/src/Helpers/ValidationHelper.php`. Only change needed:
- Namespace is already `WeCoza\Agents\Helpers` — **no change needed**
- Text domain references `'wecoza-agents-plugin'` — change ALL occurrences to `'wecoza-core'` for consistency with the core plugin
- Check for `wecoza_agents_validate_sa_id` and `wecoza_agents_validate_passport` function references — these are fallback checks using `function_exists()`. They may not exist in wecoza-core. Keep the `function_exists()` guard — it's safe. The fallback validation logic handles the case.
- **Do NOT add any DatabaseService or plugin-constant references.**

**FormHelpers.php** — Copy from `.integrate/wecoza-agents-plugin/src/Helpers/FormHelpers.php`. Only change needed:
- Namespace is already `WeCoza\Agents\Helpers` — **no change needed**
- No text domain references, no DB calls, no constants — this is a pure data mapping class
- File should be identical to source except for any `ABSPATH` guard at the top (add if missing):
  ```php
  if (!defined('ABSPATH')) { exit; }
  ```

**WorkingAreasService.php** — Copy from `.integrate/wecoza-agents-plugin/src/Services/WorkingAreasService.php`. Only change needed:
- Namespace is already `WeCoza\Agents\Services` — **no change needed**
- No DB calls, no constants, no text domain — this is a pure static data lookup class
- Add `ABSPATH` guard if missing

All three files: the namespace is already correct in the source (`WeCoza\Agents\Helpers` / `WeCoza\Agents\Services`). The PSR-4 autoloader registered in Task 1 maps `WeCoza\Agents\` to `src/Agents/`, so `WeCoza\Agents\Helpers\ValidationHelper` resolves to `src/Agents/Helpers/ValidationHelper.php`. This is the correct path.
  </action>
  <verify>
1. `php -l src/Agents/Helpers/ValidationHelper.php` passes
2. `php -l src/Agents/Helpers/FormHelpers.php` passes
3. `php -l src/Agents/Services/WorkingAreasService.php` passes
4. `grep -r "DatabaseService" src/Agents/ --include="*.php" | wc -l` returns 0
5. `grep -r "WECOZA_AGENTS_" src/Agents/ --include="*.php" | wc -l` returns 0
6. `grep -r "wecoza_agents_log" src/Agents/ --include="*.php" | wc -l` returns 0
7. `grep -c "namespace WeCoza\\\\Agents\\\\Helpers" src/Agents/Helpers/ValidationHelper.php` returns 1
8. `grep -c "namespace WeCoza\\\\Agents\\\\Helpers" src/Agents/Helpers/FormHelpers.php` returns 1
9. `grep -c "namespace WeCoza\\\\Agents\\\\Services" src/Agents/Services/WorkingAreasService.php` returns 1
  </verify>
  <done>
Three helper/service files created under src/Agents/ with correct namespaces. Zero DatabaseService, WECOZA_AGENTS_*, or wecoza_agents_log references.
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Namespace registered
grep "WeCoza.*Agents" wecoza-core.php

# 2. PostgresConnection RETURNING fix
grep "agent_id" core/Database/PostgresConnection.php | grep -v "^--"

# 3. All PHP syntax valid
find src/Agents/ -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
php -l wecoza-core.php 2>&1 | grep -v "No syntax errors"
php -l core/Database/PostgresConnection.php 2>&1 | grep -v "No syntax errors"

# 4. Zero forbidden references
grep -r "DatabaseService" src/Agents/ --include="*.php" | wc -l   # expect 0
grep -r "WECOZA_AGENTS_" src/Agents/ --include="*.php" | wc -l   # expect 0
grep -r "wecoza_agents_log" src/Agents/ --include="*.php" | wc -l # expect 0

# 5. Correct namespaces
grep -r "^namespace WeCoza\\\\Agents" src/Agents/ --include="*.php"
```
</verification>

<success_criteria>
- WeCoza\Agents\ namespace registered in wecoza-core.php autoloader
- agent_id added to PostgresConnection::insert() RETURNING candidates
- ValidationHelper.php exists at src/Agents/Helpers/ with correct namespace
- FormHelpers.php exists at src/Agents/Helpers/ with correct namespace
- WorkingAreasService.php exists at src/Agents/Services/ with correct namespace
- All 5 affected PHP files pass syntax check
- Zero DatabaseService, WECOZA_AGENTS_*, wecoza_agents_log references in src/Agents/
</success_criteria>

<output>
After completion, create `.planning/phases/26-foundation-architecture/26-01-SUMMARY.md`
</output>
