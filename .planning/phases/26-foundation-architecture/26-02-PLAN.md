---
phase: 26-foundation-architecture
plan: 02
type: execute
wave: 2
depends_on: ["26-01"]
files_modified:
  - src/Agents/Repositories/AgentRepository.php
  - src/Agents/Models/AgentModel.php
autonomous: true

must_haves:
  truths:
    - "AgentRepository extends BaseRepository and provides CRUD for agents table"
    - "AgentModel is standalone (NOT extending BaseModel) with get/set/validate cycle"
    - "AgentModel delegates all DB operations to AgentRepository"
    - "All update/delete calls use string WHERE + colon-prefixed params"
    - "Zero DatabaseService references in any migrated file"
  artifacts:
    - path: "src/Agents/Repositories/AgentRepository.php"
      provides: "Agent CRUD, meta, notes, absences operations"
      contains: "extends BaseRepository"
    - path: "src/Agents/Models/AgentModel.php"
      provides: "Standalone Agent model with validation"
      contains: "class AgentModel"
  key_links:
    - from: "src/Agents/Models/AgentModel.php"
      to: "src/Agents/Repositories/AgentRepository.php"
      via: "new AgentRepository() in save/load/delete"
      pattern: "new.*AgentRepository"
    - from: "src/Agents/Repositories/AgentRepository.php"
      to: "wecoza_db()"
      via: "All CRUD methods use wecoza_db()"
      pattern: "wecoza_db\\(\\)"
    - from: "src/Agents/Models/AgentModel.php"
      to: "src/Agents/Helpers/ValidationHelper.php"
      via: "validate() calls ValidationHelper::validate_sa_id()"
      pattern: "ValidationHelper::validate_sa_id"
---

<objective>
Create AgentRepository (extending BaseRepository with column whitelisting and all CRUD methods) and AgentModel (standalone, NOT BaseModel) that delegates DB operations to the repository.

Purpose: Complete the data layer for the Agents module. These two classes are the backbone all controllers/AJAX handlers will use in Phase 27.
Output: 2 files — AgentRepository.php and AgentModel.php — both passing php -l and containing zero DatabaseService references.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-foundation-architecture/26-RESEARCH.md
@.planning/phases/26-foundation-architecture/26-01-SUMMARY.md

Source files to migrate from:
@.integrate/wecoza-agents-plugin/src/Database/AgentQueries.php
@.integrate/wecoza-agents-plugin/src/Models/Agent.php

Reference patterns:
@core/Abstract/BaseRepository.php
@core/Database/PostgresConnection.php (lines 312-428 for insert/update/delete signatures)
@src/Clients/Repositories/ClientRepository.php (proven pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1a: Create AgentRepository — class scaffold and core CRUD methods</name>
  <files>src/Agents/Repositories/AgentRepository.php</files>
  <action>
Create `src/Agents/Repositories/` directory if it doesn't exist.

Migrate core CRUD from `.integrate/wecoza-agents-plugin/src/Database/AgentQueries.php` to `src/Agents/Repositories/AgentRepository.php`.

**Namespace:** `WeCoza\Agents\Repositories`

**Class structure:**
```php
namespace WeCoza\Agents\Repositories;

use WeCoza\Core\Abstract\BaseRepository;

class AgentRepository extends BaseRepository
{
    protected static string $table = 'agents';
    protected static string $primaryKey = 'agent_id';
    // ... methods
}
```

**Column whitelisting (CRITICAL for security):**

`getAllowedOrderColumns()` — return: `['agent_id', 'first_name', 'surname', 'email_address', 'created_at', 'updated_at', 'status']`

`getAllowedFilterColumns()` — return: `['agent_id', 'email_address', 'sa_id_no', 'tel_number', 'status', 'first_name', 'surname', 'created_at']`

`getAllowedInsertColumns()` — return ALL agent fields from the source `sanitize_agent_data()` method (lines 608-684 of AgentQueries.php), PLUS `created_at`, `updated_at`, `created_by`, `updated_by`. Full list:
```
title, first_name, second_name, surname, initials, gender, race,
id_type, sa_id_no, passport_number,
tel_number, email_address,
residential_address_line, address_line_2, city, province, residential_postal_code,
preferred_working_area_1, preferred_working_area_2, preferred_working_area_3,
sace_number, sace_registration_date, sace_expiry_date, phase_registered, subjects_registered,
highest_qualification,
quantum_maths_score, quantum_science_score, quantum_assessment,
criminal_record_date, criminal_record_file,
signed_agreement_date, signed_agreement_file,
bank_name, account_holder, bank_account_number, bank_branch_code, account_type,
agent_training_date, agent_notes, status,
residential_suburb, residential_town_id,
created_at, updated_at, created_by, updated_by
```

`getAllowedUpdateColumns()` — same as insert MINUS `created_at` and `created_by`. Use `array_diff()`.

**Core CRUD methods (6 methods) — migrate these in this task:**

| Source Method | Target Method | DB Adaptation |
|---------------|---------------|---------------|
| `create_agent($data)` | `createAgent(array $data): int\|false` | `wecoza_db()->insert('agents', $cleanData)` |
| `get_agent($agent_id)` | `getAgent(int $agentId): ?array` | `wecoza_db()->getRow($sql, $params) ?: null` |
| `get_agent_by_email($email)` | `getAgentByEmail(string $email): ?array` | `wecoza_db()->getRow($sql, $params) ?: null` |
| `get_agent_by_id_number($id_number)` | `getAgentByIdNumber(string $idNumber): ?array` | `wecoza_db()->getRow($sql, $params) ?: null` |
| `update_agent($agent_id, $data)` | `updateAgent(int $agentId, array $data): bool` | `wecoza_db()->update('agents', $cleanData, 'agent_id = :agent_id', [':agent_id' => $agentId])` |
| `delete_agent($agent_id)` | `deleteAgent(int $agentId): bool` | Calls `updateAgent($agentId, ['status' => 'deleted'])` (soft delete) |

**Also migrate these query/utility methods (6 methods):**

| Source Method | Target Method | DB Adaptation |
|---------------|---------------|---------------|
| `get_agents($args)` | `getAgents(array $args = []): array` | `wecoza_db()->getAll($sql, $params)` |
| `delete_agent_permanently($agent_id)` | `deleteAgentPermanently(int $agentId): bool` | `wecoza_db()->delete('agents', 'agent_id = :agent_id', [':agent_id' => $agentId])` |
| `count_agents($args)` | `countAgents(array $args = []): int` | `wecoza_db()->getRow($sql, $params)` then extract `total` |
| `search_agents($search, $args)` | `searchAgents(string $search, array $args = []): array` | Delegates to `getAgents()` |
| `get_agents_by_status($status, $args)` | `getAgentsByStatus(string $status, array $args = []): array` | Delegates to `getAgents()` |
| `bulk_update_status($agent_ids, $status)` | `bulkUpdateStatus(array $agentIds, string $status): int` | Loops `updateAgent()` |

**CRITICAL WHERE clause adaptation rules:**

For `update()` calls:
```php
// Source: $this->db->update('table', $data, ['agent_id' => $id])
// Target: wecoza_db()->update('table', $data, 'agent_id = :agent_id', [':agent_id' => $id])
```

For `delete()` calls:
```php
// Source: $this->db->delete('table', ['agent_id' => $id])
// Target: wecoza_db()->delete('table', 'agent_id = :agent_id', [':agent_id' => $id])
```

**CRITICAL param key rule:** WHERE params MUST use colon prefix: `[':agent_id' => $id]` NOT `['agent_id' => $id]`.

**CRITICAL: WHERE params use bare colon prefix (`:agent_id`), NOT `:set_agent_id`. The `:set_` prefix is reserved for SET clause params internally by PostgresConnection::update(). If you accidentally name a WHERE param `:set_agent_id`, it will collide with the auto-generated SET params and produce wrong SQL. Always use `:agent_id`, `:meta_key`, `:meta_value` etc. for WHERE clause parameters.**

**Sanitize method:** Migrate `sanitize_agent_data()` as a `protected` method. Keep all the same sanitization callbacks. Change `sanitize_working_area` to a private method. Remove `$this->db` property entirely — use `wecoza_db()` directly in all methods. Remove `init_tables()` and `get_table()` — use literal table names ('agents', 'agent_meta', 'agent_notes', 'agent_absences').

**SQL in getAgents():** The source uses LIKE for PostgreSQL search. Keep it (PostgreSQL supports LIKE). The source already validates orderby against an allowed list — keep this validation. Use `wecoza_db()->getAll()` instead of `query()->fetchAll()`.

**Remove:** All `$this->db` references, `DatabaseService` import, `init_tables()`, `get_table()`, table array property.
  </action>
  <verify>
1. `php -l src/Agents/Repositories/AgentRepository.php` passes
2. `grep -c "extends BaseRepository" src/Agents/Repositories/AgentRepository.php` returns 1
3. `grep -c "DatabaseService" src/Agents/Repositories/AgentRepository.php` returns 0
4. `grep -c "wecoza_db()" src/Agents/Repositories/AgentRepository.php` returns 8+ (one per DB call for core CRUD)
5. `grep "':agent_id'" src/Agents/Repositories/AgentRepository.php | wc -l` returns multiple (colon-prefixed params)
6. `grep "getAllowedInsertColumns\|getAllowedUpdateColumns\|getAllowedOrderColumns\|getAllowedFilterColumns" src/Agents/Repositories/AgentRepository.php | wc -l` returns 4
  </verify>
  <done>
AgentRepository class scaffold with BaseRepository extension, column whitelisting, sanitize method, and 12 core CRUD/query methods migrated. Zero DatabaseService references.
  </done>
</task>

<task type="auto">
  <name>Task 1b: Add meta, notes, and absences methods to AgentRepository</name>
  <files>src/Agents/Repositories/AgentRepository.php</files>
  <action>
Add the remaining 11 methods to the AgentRepository class created in Task 1a. These handle the agent_meta, agent_notes, and agent_absences tables.

**CRITICAL: WHERE params use bare colon prefix (`:agent_id`), NOT `:set_agent_id`. The `:set_` prefix is reserved for SET clause params internally by PostgresConnection::update(). If you accidentally name a WHERE param `:set_agent_id`, it will collide with the auto-generated SET params and produce wrong SQL. Always use `:agent_id`, `:meta_key`, `:meta_value` etc. for WHERE clause parameters.**

**Meta methods (4 methods):**

| Source Method | Target Method | DB Adaptation |
|---------------|---------------|---------------|
| `add_agent_meta(...)` | `addAgentMeta(int $agentId, string $metaKey, mixed $metaValue): int\|false` | `wecoza_db()->insert('agent_meta', $data)` |
| `get_agent_meta(...)` | `getAgentMeta(int $agentId, string $metaKey = '', bool $single = false): mixed` | `wecoza_db()->getAll($sql, $params)` |
| `update_agent_meta(...)` | `updateAgentMeta(int $agentId, string $metaKey, mixed $metaValue): bool` | See compound WHERE below |
| `delete_agent_meta(...)` | `deleteAgentMeta(int $agentId, string $metaKey = ''): bool` | See conditional WHERE below |

**Notes methods (3 methods):**

| Source Method | Target Method | DB Adaptation |
|---------------|---------------|---------------|
| `add_agent_note(...)` | `addAgentNote(int $agentId, string $note, string $noteType = 'general'): int\|false` | `wecoza_db()->insert('agent_notes', $data)` |
| `get_agent_notes(...)` | `getAgentNotes(int $agentId, array $args = []): array` | `wecoza_db()->getAll($sql, $params)` |
| `delete_agent_notes(...)` | `deleteAgentNotes(int $agentId): bool` | `wecoza_db()->delete('agent_notes', 'agent_id = :agent_id', [':agent_id' => $agentId])` |

**Absences methods (4 methods):**

| Source Method | Target Method | DB Adaptation |
|---------------|---------------|---------------|
| `add_agent_absence(...)` | `addAgentAbsence(int $agentId, string $absenceDate, string $reason = ''): int\|false` | `wecoza_db()->insert('agent_absences', $data)` |
| `get_agent_absences(...)` | `getAgentAbsences(int $agentId, array $args = []): array` | `wecoza_db()->getAll($sql, $params)` |
| `delete_agent_absences(...)` | `deleteAgentAbsences(int $agentId): bool` | `wecoza_db()->delete('agent_absences', 'agent_id = :agent_id', [':agent_id' => $agentId])` |

**For `deleteAgentMeta` with optional meta_key:** Build the WHERE string conditionally:
```php
$where = 'agent_id = :agent_id';
$params = [':agent_id' => $agentId];
if (!empty($metaKey)) {
    $where .= ' AND meta_key = :meta_key';
    $params[':meta_key'] = $metaKey;
}
wecoza_db()->delete('agent_meta', $where, $params);
```

**For `updateAgentMeta` with compound WHERE:** Use multi-condition WHERE:
```php
wecoza_db()->update('agent_meta',
    ['meta_value' => maybe_serialize($metaValue)],
    'agent_id = :agent_id AND meta_key = :meta_key',
    [':agent_id' => $agentId, ':meta_key' => $metaKey]
);
```
  </action>
  <verify>
1. `php -l src/Agents/Repositories/AgentRepository.php` passes
2. `grep -c "wecoza_db()" src/Agents/Repositories/AgentRepository.php` returns 15+ (all methods combined)
3. `grep -c "agent_meta" src/Agents/Repositories/AgentRepository.php` returns 5+ (meta table references)
4. `grep -c "agent_notes" src/Agents/Repositories/AgentRepository.php` returns 3+ (notes table references)
5. `grep -c "agent_absences" src/Agents/Repositories/AgentRepository.php` returns 3+ (absences table references)
6. `grep "':meta_key'" src/Agents/Repositories/AgentRepository.php | wc -l` returns 2+ (colon-prefixed meta params)
  </verify>
  <done>
AgentRepository has all 23 methods: 12 core CRUD + 4 meta + 3 notes + 4 absences. All use wecoza_db() with correct WHERE string + colon-prefixed params. Zero DatabaseService references.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Agent model as standalone AgentModel</name>
  <files>src/Agents/Models/AgentModel.php</files>
  <action>
Create `src/Agents/Models/` directory if it doesn't exist.

Migrate from `.integrate/wecoza-agents-plugin/src/Models/Agent.php` to `src/Agents/Models/AgentModel.php`.

**Namespace:** `WeCoza\Agents\Models`
**Class name:** `AgentModel` (renamed from `Agent`)

**CRITICAL: Do NOT extend BaseModel.** This model is intentionally standalone with its own get/set/validate cycle. Adding BaseModel would break hydration, FormHelpers integration, and preferred_areas logic.

**Changes required:**

1. **Namespace:** Already `WeCoza\Agents\Models` — no change
2. **Class name:** `Agent` → `AgentModel`
3. **AgentQueries references → AgentRepository:**
   - `new \WeCoza\Agents\Database\AgentQueries()` → `new \WeCoza\Agents\Repositories\AgentRepository()`
   - Method calls stay the same pattern but use camelCase:
     - `$agent_queries->get_agent($id)` → `$repository->getAgent($id)`
     - `$agent_queries->update_agent($this->id, $save_data)` → `$repository->updateAgent($this->id, $save_data)`
     - `$agent_queries->create_agent($save_data)` → `$repository->createAgent($save_data)`
     - `$agent_queries->delete_agent($this->id)` → `$repository->deleteAgent($this->id)`
4. **Text domain:** `'wecoza-agents-plugin'` → `'wecoza-core'` for all `__()` calls
5. **ValidationHelper reference:** Already uses `\WeCoza\Agents\Helpers\ValidationHelper` — no change needed
6. **FormHelpers reference:** Already uses `\WeCoza\Agents\Helpers\FormHelpers` — no change needed
7. **Add ABSPATH guard** if missing

**Preserve completely unchanged:**
- `$defaults` array (all 40+ fields)
- `$required_fields` array
- `$validation_rules` array
- `get()`, `set()`, `__get()`, `__set()`, `__isset()` methods
- `validate()` method logic (including SA ID checksum, phone, email, date validation)
- `get_form_field()`, `set_form_field()`, `set_form_data()`, `get_form_data()` methods
- `get_display_name()`, `get_initials()`, `get_preferred_areas()`, `set_preferred_areas()`
- `has_quantum_qualification()`, `get_status_label()`
- `to_array()`, `to_json()`, `get_data()`, `get_save_data()`
- `is_modified()`, `get_modified_fields()`
- `is_valid_date()` protected method
- `apply_filters('wecoza_agents_validate_agent', ...)` hook

**Variable naming in affected methods:**
- In `load()`, `save()`, `delete()`: rename `$agent_queries` to `$repository`
  </action>
  <verify>
1. `php -l src/Agents/Models/AgentModel.php` passes
2. `grep -c "class AgentModel" src/Agents/Models/AgentModel.php` returns 1
3. `grep -c "extends BaseModel" src/Agents/Models/AgentModel.php` returns 0 (must NOT extend BaseModel)
4. `grep -c "AgentRepository" src/Agents/Models/AgentModel.php` returns 3+ (load, save, delete)
5. `grep -c "AgentQueries" src/Agents/Models/AgentModel.php` returns 0
6. `grep -c "DatabaseService" src/Agents/Models/AgentModel.php` returns 0
7. `grep -c "wecoza-agents-plugin" src/Agents/Models/AgentModel.php` returns 0
  </verify>
  <done>
AgentModel is standalone (not extending BaseModel) with all validation, FormHelpers integration, and preferred_areas logic preserved. Delegates to AgentRepository for all DB operations. Zero AgentQueries or DatabaseService references.
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Repository structure
grep "extends BaseRepository" src/Agents/Repositories/AgentRepository.php
grep "protected static string \$table" src/Agents/Repositories/AgentRepository.php
grep "protected static string \$primaryKey" src/Agents/Repositories/AgentRepository.php

# 2. Model structure
grep "class AgentModel" src/Agents/Models/AgentModel.php
grep "extends BaseModel" src/Agents/Models/AgentModel.php  # expect 0 matches

# 3. Model → Repository wiring
grep "AgentRepository" src/Agents/Models/AgentModel.php

# 4. All syntax valid
find src/Agents/ -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"

# 5. Zero forbidden references across ALL Agents files
grep -r "DatabaseService" src/Agents/ --include="*.php" | wc -l      # expect 0
grep -r "WECOZA_AGENTS_" src/Agents/ --include="*.php" | wc -l      # expect 0
grep -r "wecoza_agents_log" src/Agents/ --include="*.php" | wc -l   # expect 0
grep -r "AgentQueries" src/Agents/ --include="*.php" | wc -l        # expect 0

# 6. WHERE params use colon prefix
grep "':agent_id'" src/Agents/Repositories/AgentRepository.php | head -5
```
</verification>

<success_criteria>
- AgentRepository extends BaseRepository with all 4 column whitelisting methods
- AgentRepository has 20+ methods migrated from AgentQueries
- All update/delete use string WHERE + colon-prefixed params
- AgentModel is standalone (NOT BaseModel)
- AgentModel delegates to AgentRepository (not AgentQueries)
- Zero DatabaseService, AgentQueries, WECOZA_AGENTS_*, wecoza_agents_log references
- All PHP files pass syntax check
</success_criteria>

<output>
After completion, create `.planning/phases/26-foundation-architecture/26-02-SUMMARY.md`
</output>
