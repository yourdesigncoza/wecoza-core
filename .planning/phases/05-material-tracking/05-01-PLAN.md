---
phase: 05-material-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - wecoza-core.php
autonomous: true

must_haves:
  truths:
    - "Administrator role has view_material_tracking capability after activation"
    - "Administrator role has manage_material_tracking capability after activation"
    - "WP Cron event wecoza_material_notifications_check is scheduled daily"
    - "Cron handler calls MaterialNotificationService for orange (7-day) alerts"
    - "Cron handler calls MaterialNotificationService for red (5-day) alerts"
  artifacts:
    - path: "wecoza-core.php"
      provides: "Capability registration and cron scheduling"
      contains: "view_material_tracking"
  key_links:
    - from: "wecoza-core.php activation hook"
      to: "administrator role"
      via: "add_cap()"
      pattern: "add_cap.*view_material_tracking"
    - from: "wecoza-core.php activation hook"
      to: "wp_schedule_event"
      via: "cron registration"
      pattern: "wp_schedule_event.*wecoza_material_notifications_check"
    - from: "wecoza-core.php cron handler"
      to: "MaterialNotificationService"
      via: "add_action callback"
      pattern: "findOrangeStatusClasses|findRedStatusClasses"
---

<objective>
Register material tracking capabilities and implement WP Cron scheduling for automated notifications.

Purpose: Without capability registration, only admins via manage_options fallback can access material tracking. Without cron scheduling, 7-day and 5-day alerts never fire automatically. This plan wires the existing MaterialNotificationService into WordPress's scheduling system.

Output: Updated wecoza-core.php with capability registration (MATL-06) and cron scheduling (MATL-02, MATL-03).
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-material-tracking/05-RESEARCH.md

# Relevant source files
@wecoza-core.php
@src/Events/Services/MaterialNotificationService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register Material Tracking Capabilities</name>
  <files>wecoza-core.php</files>
  <action>
In the activation hook (register_activation_hook), add capability registration for material tracking.

Find the existing capability registration block (around line 292-297):
```php
$admin = get_role('administrator');
if ($admin) {
    $admin->add_cap('manage_learners');
}
```

Add two new capabilities after `manage_learners`:
- `view_material_tracking` - allows viewing the material tracking dashboard
- `manage_material_tracking` - allows marking materials as delivered

Also update the deactivation hook (register_deactivation_hook) to remove these capabilities:
```php
$admin->remove_cap('view_material_tracking');
$admin->remove_cap('manage_material_tracking');
```

This mirrors the existing pattern for `manage_learners`.
  </action>
  <verify>
Grep wecoza-core.php for 'view_material_tracking' and 'manage_material_tracking' to confirm both capabilities are registered in activation and removed in deactivation hooks.
  </verify>
  <done>
Both `view_material_tracking` and `manage_material_tracking` capabilities are added in register_activation_hook and removed in register_deactivation_hook.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement WP Cron Scheduling for Material Notifications</name>
  <files>wecoza-core.php</files>
  <action>
Add WP Cron scheduling for material delivery notifications.

**Step 1: Schedule cron event during activation**

In the activation hook, after the capability registration, add cron scheduling:
```php
// Schedule material notification cron if not already scheduled
if (!wp_next_scheduled('wecoza_material_notifications_check')) {
    wp_schedule_event(time(), 'daily', 'wecoza_material_notifications_check');
}
```

**Step 2: Unschedule cron event during deactivation**

In the deactivation hook, add:
```php
// Unschedule material notification cron
$timestamp = wp_next_scheduled('wecoza_material_notifications_check');
if ($timestamp) {
    wp_unschedule_event($timestamp, 'wecoza_material_notifications_check');
}
```

**Step 3: Add cron handler in plugins_loaded hook**

Inside the `add_action('plugins_loaded', function () { ... }, 5);` callback, after the Events Module initialization (around line 207), add:
```php
// Material Notification Cron Handler
add_action('wecoza_material_notifications_check', function () {
    if (!class_exists(\WeCoza\Events\Services\MaterialNotificationService::class)) {
        return;
    }

    $service = new \WeCoza\Events\Services\MaterialNotificationService();

    // Check and send 7-day (orange) notifications
    $orangeClasses = $service->findOrangeStatusClasses();
    if (!empty($orangeClasses)) {
        $sentOrange = $service->sendMaterialNotifications($orangeClasses, 'orange');
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log("WeCoza Material Cron: Sent {$sentOrange} orange (7-day) notifications");
        }
    }

    // Check and send 5-day (red) notifications
    $redClasses = $service->findRedStatusClasses();
    if (!empty($redClasses)) {
        $sentRed = $service->sendMaterialNotifications($redClasses, 'red');
        if (defined('WP_DEBUG') && WP_DEBUG) {
            error_log("WeCoza Material Cron: Sent {$sentRed} red (5-day) notifications");
        }
    }
});
```

**Important:**
- Place the cron handler AFTER Events module initialization to ensure classes are available
- Use class_exists check for safety
- Log activity only when WP_DEBUG is enabled
  </action>
  <verify>
1. Grep wecoza-core.php for 'wecoza_material_notifications_check' - should appear in:
   - wp_schedule_event call
   - wp_unschedule_event call
   - add_action call

2. Grep for 'findOrangeStatusClasses' and 'findRedStatusClasses' in wecoza-core.php to confirm cron handler calls both notification methods.
  </verify>
  <done>
WP Cron event `wecoza_material_notifications_check` is scheduled on activation, unscheduled on deactivation, and handler calls MaterialNotificationService for both orange (7-day) and red (5-day) alerts.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Capability registration verification:**
   ```bash
   grep -n "view_material_tracking\|manage_material_tracking" wecoza-core.php
   ```
   Expected: 4 lines (2 add_cap in activation, 2 remove_cap in deactivation)

2. **Cron scheduling verification:**
   ```bash
   grep -n "wecoza_material_notifications_check" wecoza-core.php
   ```
   Expected: 3+ lines (schedule, unschedule, action hook)

3. **Cron handler verification:**
   ```bash
   grep -n "findOrangeStatusClasses\|findRedStatusClasses" wecoza-core.php
   ```
   Expected: 2 lines (one for each notification type)

4. **Syntax check:**
   ```bash
   php -l wecoza-core.php
   ```
   Expected: No syntax errors
</verification>

<success_criteria>
- [ ] `view_material_tracking` capability added to activation hook
- [ ] `manage_material_tracking` capability added to activation hook
- [ ] Both capabilities removed in deactivation hook
- [ ] `wecoza_material_notifications_check` cron event scheduled on activation
- [ ] Cron event unscheduled on deactivation
- [ ] Cron handler registered via add_action
- [ ] Handler calls findOrangeStatusClasses() and sendMaterialNotifications() for orange alerts
- [ ] Handler calls findRedStatusClasses() and sendMaterialNotifications() for red alerts
- [ ] PHP syntax validation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-material-tracking/05-01-SUMMARY.md`
</output>
