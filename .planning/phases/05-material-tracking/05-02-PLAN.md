---
phase: 05-material-tracking
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - tests/Events/MaterialTrackingTest.php
autonomous: true

must_haves:
  truths:
    - "Shortcode [wecoza_material_tracking] is registered"
    - "Shortcode renders dashboard without PHP errors"
    - "AJAX action wecoza_mark_material_delivered is registered"
    - "MaterialNotificationService can find classes for orange notifications"
    - "MaterialNotificationService can find classes for red notifications"
    - "Capabilities view_material_tracking and manage_material_tracking are registered"
    - "Cron event wecoza_material_notifications_check is scheduled"
  artifacts:
    - path: "tests/Events/MaterialTrackingTest.php"
      provides: "Verification test suite for MATL-01 through MATL-06"
      min_lines: 200
  key_links:
    - from: "tests/Events/MaterialTrackingTest.php"
      to: "shortcode_exists"
      via: "assertion"
      pattern: "shortcode_exists.*wecoza_material_tracking"
    - from: "tests/Events/MaterialTrackingTest.php"
      to: "has_action"
      via: "assertion"
      pattern: "has_action.*wecoza_mark_material_delivered"
    - from: "tests/Events/MaterialTrackingTest.php"
      to: "wp_next_scheduled"
      via: "assertion"
      pattern: "wp_next_scheduled.*wecoza_material_notifications_check"
---

<objective>
Create a comprehensive verification test suite for material tracking functionality.

Purpose: Verify all MATL-01 through MATL-06 requirements are satisfied after the infrastructure work in Plan 01. This follows the established pattern from Phase 4's TaskManagementTest.php.

Output: tests/Events/MaterialTrackingTest.php that verifies all material tracking requirements can be executed via `wp eval-file`.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-material-tracking/05-RESEARCH.md

# Reference implementation
@tests/Events/TaskManagementTest.php

# Source files to verify
@src/Events/Shortcodes/MaterialTrackingShortcode.php
@src/Events/Controllers/MaterialTrackingController.php
@src/Events/Services/MaterialTrackingDashboardService.php
@src/Events/Services/MaterialNotificationService.php
@src/Events/Repositories/MaterialTrackingRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Material Tracking Verification Test Suite</name>
  <files>tests/Events/MaterialTrackingTest.php</files>
  <action>
Create a comprehensive test file following the pattern established in TaskManagementTest.php.

**File structure:**
```php
<?php
/**
 * Material Tracking Verification Tests
 *
 * Verifies all migrated material tracking functionality works correctly
 * Run with: wp eval-file tests/Events/MaterialTrackingTest.php --path=/opt/lampp/htdocs/wecoza
 */

declare(strict_types=1);

// Bootstrap WordPress if not running via WP-CLI
if (!function_exists('shortcode_exists')) {
    require_once '/opt/lampp/htdocs/wecoza/wp-load.php';
}
```

**Test categories to implement:**

1. **MATL-04: Shortcode Registration and Rendering**
   - Test shortcode [wecoza_material_tracking] exists
   - Test shortcode renders without PHP errors
   - Test output contains expected wrapper class (wecoza-material-tracking)
   - Test output contains data-nonce for AJAX security

2. **MATL-05: AJAX Handler Registration**
   - Test AJAX action wecoza_mark_material_delivered is registered
   - Test nopriv handler is registered (for unauthorized response)
   - Test controller class exists and is instantiable

3. **MATL-01: Service Layer Verification**
   - Test MaterialTrackingDashboardService exists and is instantiable
   - Test getDashboardData() returns array
   - Test getStatistics() returns expected keys (total, pending, notified, delivered)
   - Test canViewDashboard() and canManageMaterialTracking() methods exist

4. **MATL-02, MATL-03: Notification Service Verification**
   - Test MaterialNotificationService exists and is instantiable
   - Test findOrangeStatusClasses() returns array (7-day alerts)
   - Test findRedStatusClasses() returns array (5-day alerts)
   - Test sendMaterialNotifications() method exists
   - Test notification email recipient option exists or has fallback

5. **MATL-06: Capability Registration**
   - Test view_material_tracking capability exists on administrator role
   - Test manage_material_tracking capability exists on administrator role
   - Test administrator user has these capabilities via current_user_can()

6. **Cron Scheduling Verification**
   - Test wecoza_material_notifications_check cron event is scheduled
   - Test cron action handler is registered
   - Verify next scheduled timestamp exists

7. **Repository Layer Verification**
   - Test MaterialTrackingRepository extends BaseRepository
   - Test repository can execute getTrackingDashboardData() without errors
   - Test repository can execute getTrackingStatistics() without errors

8. **View Template Verification**
   - Test views/events/material-tracking/dashboard.php exists
   - Test views/events/material-tracking/statistics.php exists
   - Test views/events/material-tracking/list-item.php exists
   - Test views/events/material-tracking/empty-state.php exists

**Use the test_result() helper function pattern from TaskManagementTest.php for consistent output.**

**Print summary at end:**
```php
echo "\n";
echo "====================================\n";
echo "TEST SUMMARY\n";
echo "====================================\n";
echo "Total: {$results['total']}\n";
echo "Passed: {$results['passed']}\n";
echo "Failed: {$results['failed']}\n";
echo "Pass Rate: " . round(($results['passed'] / max(1, $results['total'])) * 100, 1) . "%\n";
```
  </action>
  <verify>
1. Run the test file:
   ```bash
   php tests/Events/MaterialTrackingTest.php
   ```
   OR
   ```bash
   wp eval-file tests/Events/MaterialTrackingTest.php --path=/opt/lampp/htdocs/wecoza
   ```

2. Verify all tests pass (100% pass rate)

3. Check test file has expected sections:
   ```bash
   grep -c "test_result" tests/Events/MaterialTrackingTest.php
   ```
   Expected: 20+ test assertions
  </verify>
  <done>
MaterialTrackingTest.php exists with comprehensive tests covering:
- MATL-01 (dashboard service)
- MATL-02 (7-day alerts via notification service)
- MATL-03 (5-day alerts via notification service)
- MATL-04 (shortcode registration)
- MATL-05 (AJAX handler)
- MATL-06 (capability registration)
All tests pass with 100% pass rate.
  </done>
</task>

<task type="auto">
  <name>Task 2: Execute Verification and Document Results</name>
  <files>tests/Events/MaterialTrackingTest.php</files>
  <action>
Run the verification test suite and ensure all tests pass.

1. Execute the test file using WordPress bootstrap:
   ```bash
   wp eval-file tests/Events/MaterialTrackingTest.php --path=/opt/lampp/htdocs/wecoza
   ```

2. If any tests fail:
   - Analyze the failure reason
   - Check if it's a test bug or actual functionality issue
   - Fix the test if it's a test bug
   - Report actual functionality issues (should not occur since code exists)

3. Capture the test output showing:
   - Total tests
   - Passed tests
   - Failed tests
   - Pass rate (target: 100%)

4. If pass rate is not 100%, investigate and fix issues before completing.
  </action>
  <verify>
Final test run output shows:
- Pass Rate: 100%
- All MATL requirements verified
  </verify>
  <done>
All tests pass. Material tracking verification complete. MATL-01 through MATL-06 all verified working.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:

1. **Test file exists:**
   ```bash
   ls -la tests/Events/MaterialTrackingTest.php
   ```

2. **Test execution:**
   ```bash
   wp eval-file tests/Events/MaterialTrackingTest.php --path=/opt/lampp/htdocs/wecoza 2>&1
   ```
   Expected: 100% pass rate

3. **Coverage check:**
   ```bash
   grep -E "MATL-0[1-6]|shortcode|AJAX|capability|cron|notification" tests/Events/MaterialTrackingTest.php | head -20
   ```
   Expected: All 6 MATL requirements mentioned in test comments
</verification>

<success_criteria>
- [ ] tests/Events/MaterialTrackingTest.php exists
- [ ] Test file bootstraps WordPress correctly
- [ ] Tests cover MATL-01 (material tracking dashboard data)
- [ ] Tests cover MATL-02 (7-day notification service)
- [ ] Tests cover MATL-03 (5-day notification service)
- [ ] Tests cover MATL-04 (shortcode registration and rendering)
- [ ] Tests cover MATL-05 (AJAX handler registration)
- [ ] Tests cover MATL-06 (capability registration)
- [ ] Tests verify cron event scheduling
- [ ] All tests pass (100% pass rate)
- [ ] Test output is clear and follows TaskManagementTest.php pattern
</success_criteria>

<output>
After completion, create `.planning/phases/05-material-tracking/05-02-SUMMARY.md`
</output>
