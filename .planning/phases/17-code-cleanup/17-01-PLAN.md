---
phase: 17-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Models/ClassChangeSchema.php
  - src/Events/Services/ClassChangeListener.php
  - src/Events/Services/TaskTemplateRegistry.php
  - src/Events/Repositories/ClassChangeLogRepository.php
  - src/Events/Services/AISummaryDisplayService.php
  - src/Events/Controllers/ClassChangeController.php
  - src/Events/Services/TaskManager.php
  - src/Events/Support/Container.php
  - tests/Events/AISummarizationTest.php
autonomous: true

must_haves:
  truths:
    - "No PHP fatal errors on page load"
    - "Task dashboard loads without errors"
    - "Class create/edit forms work correctly"
    - "No references to removed classes in codebase"
  artifacts:
    - path: "src/Events/Models/ClassChangeSchema.php"
      provides: "DELETED"
    - path: "src/Events/Services/ClassChangeListener.php"
      provides: "DELETED"
    - path: "src/Events/Services/TaskTemplateRegistry.php"
      provides: "DELETED"
    - path: "src/Events/Repositories/ClassChangeLogRepository.php"
      provides: "DELETED"
    - path: "src/Events/Services/AISummaryDisplayService.php"
      provides: "DELETED"
    - path: "src/Events/Controllers/ClassChangeController.php"
      provides: "DELETED"
    - path: "src/Events/Services/TaskManager.php"
      provides: "Clean TaskManager without TaskTemplateRegistry"
    - path: "src/Events/Support/Container.php"
      provides: "Clean Container without TaskTemplateRegistry"
  key_links:
    - from: "src/Events/Services/TaskManager.php"
      to: "buildTasksFromEvents()"
      via: "direct method call"
      pattern: "buildTasksFromEvents"
---

<objective>
Remove deprecated trigger-based task system files and clean up all references.

Purpose: Complete v1.2 refactor by removing dead code that relied on dropped class_change_logs table and PostgreSQL triggers.

Output: Clean codebase with only event-based task system remaining.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete deprecated files</name>
  <files>
    src/Events/Models/ClassChangeSchema.php
    src/Events/Services/ClassChangeListener.php
    src/Events/Services/TaskTemplateRegistry.php
    src/Events/Repositories/ClassChangeLogRepository.php
    src/Events/Services/AISummaryDisplayService.php
    src/Events/Controllers/ClassChangeController.php
  </files>
  <action>
Delete 6 deprecated files that relied on the dropped class_change_logs table and PostgreSQL triggers:

1. `rm src/Events/Models/ClassChangeSchema.php` - PostgreSQL trigger definitions
2. `rm src/Events/Services/ClassChangeListener.php` - LISTEN/NOTIFY handler for triggers
3. `rm src/Events/Services/TaskTemplateRegistry.php` - Template-based task generation (replaced by buildTasksFromEvents)
4. `rm src/Events/Repositories/ClassChangeLogRepository.php` - Queries dropped class_change_logs table
5. `rm src/Events/Services/AISummaryDisplayService.php` - Depends on ClassChangeLogRepository (only 28 lines, entire purpose was querying dropped table)
6. `rm src/Events/Controllers/ClassChangeController.php` - CLI controller for trigger management (uses ClassChangeSchema, ClassChangeLogRepository, ClassChangeListener)

Note: ClassChangeLogDTO.php and ChangeOperation.php were already removed (files don't exist).
  </action>
  <verify>
```bash
# Verify files are deleted
ls src/Events/Models/ClassChangeSchema.php 2>/dev/null && echo "FAIL: ClassChangeSchema still exists" || echo "OK"
ls src/Events/Services/ClassChangeListener.php 2>/dev/null && echo "FAIL: ClassChangeListener still exists" || echo "OK"
ls src/Events/Services/TaskTemplateRegistry.php 2>/dev/null && echo "FAIL: TaskTemplateRegistry still exists" || echo "OK"
ls src/Events/Repositories/ClassChangeLogRepository.php 2>/dev/null && echo "FAIL: ClassChangeLogRepository still exists" || echo "OK"
ls src/Events/Services/AISummaryDisplayService.php 2>/dev/null && echo "FAIL: AISummaryDisplayService still exists" || echo "OK"
ls src/Events/Controllers/ClassChangeController.php 2>/dev/null && echo "FAIL: ClassChangeController still exists" || echo "OK"
```
  </verify>
  <done>6 deprecated files removed from filesystem</done>
</task>

<task type="auto">
  <name>Task 2: Clean up references in remaining files</name>
  <files>
    src/Events/Services/TaskManager.php
    src/Events/Support/Container.php
    tests/Events/AISummarizationTest.php
  </files>
  <action>
Remove all imports and usages of deleted classes:

**1. src/Events/Services/TaskManager.php:**
- Remove line 32: `private TaskTemplateRegistry $registry;`
- Remove lines 34-38: Constructor parameter and assignment
- Update constructor to: `public function __construct() { $this->db = PostgresConnection::getInstance(); }`
- Remove any methods that use `$this->registry` (getTasksWithTemplate, etc. - these are legacy methods)
- Keep: buildTasksFromEvents(), completeTask(), reopenTask(), and other event-based methods

**2. src/Events/Support/Container.php:**
- Remove line 15: `use WeCoza\Events\Services\TaskTemplateRegistry;`
- Remove line 22: `private static ?TaskTemplateRegistry $taskTemplateRegistry = null;`
- Remove lines 33-40: `public static function taskTemplateRegistry()` method
- Update line 54: `self::$taskManager = new TaskManager(self::taskTemplateRegistry());` â†’ `self::$taskManager = new TaskManager();`
- Update lines 63-67: `self::$classTaskService = new ClassTaskService(...)` - remove taskTemplateRegistry parameter

**3. tests/Events/AISummarizationTest.php:**
- Remove line 22: `use WeCoza\Events\Repositories\ClassChangeLogRepository;`
- Remove or comment out Section 8 tests (lines ~440-480) that test ClassChangeLogRepository
- Remove line 735 reference to ClassChangeLogRepository
- Alternative: Delete entire test file if it only tests deprecated code (check if other sections are still valid)
  </action>
  <verify>
```bash
# Verify no references to deleted classes remain in src/
grep -r "TaskTemplateRegistry\|ClassChangeLogRepository\|ClassChangeSchema\|ClassChangeListener\|AISummaryDisplayService\|ClassChangeController" src/Events/ 2>/dev/null && echo "FAIL: References remain" || echo "OK: No references"

# Verify PHP syntax is valid
php -l src/Events/Services/TaskManager.php
php -l src/Events/Support/Container.php

# Quick smoke test - load the plugin
cd /opt/lampp/htdocs/wecoza && wp plugin list | grep wecoza-core
```
  </verify>
  <done>
- TaskManager constructor takes no parameters
- Container has no TaskTemplateRegistry references
- Test file updated or deprecated sections removed
- No PHP syntax errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **PHP syntax check:**
   ```bash
   find src/Events -name "*.php" -exec php -l {} \; 2>&1 | grep -v "No syntax errors"
   ```

2. **Reference check:**
   ```bash
   grep -r "ClassChangeSchema\|ClassChangeListener\|TaskTemplateRegistry\|ClassChangeLogRepository\|ClassChangeLogDTO\|ChangeOperation" src/ --include="*.php" | grep -v "^Binary"
   ```

3. **Functional smoke test:**
   - Load task dashboard shortcode page
   - Load class edit form
   - Complete and reopen a task
</verification>

<success_criteria>
- [ ] 6 deprecated files deleted (4 that exist + confirm 2 already gone)
- [ ] TaskManager.php has no TaskTemplateRegistry dependency
- [ ] Container.php has no TaskTemplateRegistry references
- [ ] Test file updated appropriately
- [ ] No PHP fatal errors on site load
- [ ] Task dashboard still functions
- [ ] Class forms still work
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-cleanup/17-01-SUMMARY.md`
</output>
