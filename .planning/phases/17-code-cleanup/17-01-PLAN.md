---
phase: 17-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Controllers/ClassChangeController.php (DELETE)
  - src/Events/Models/ClassChangeSchema.php (DELETE)
  - src/Events/Services/ClassChangeListener.php (DELETE)
  - src/Events/Services/TaskTemplateRegistry.php (DELETE)
  - src/Events/Repositories/ClassChangeLogRepository.php (DELETE)
  - src/Events/Services/AISummaryDisplayService.php (DELETE)
  - src/Events/Services/TaskManager.php
  - src/Events/Support/Container.php
  - tests/Events/AISummarizationTest.php
autonomous: true

must_haves:
  truths:
    - "No PHP fatal errors on page load"
    - "Task dashboard loads without errors"
    - "Class create/edit forms work correctly"
    - "No references to removed classes in active codebase"
    - "Test file runs without 'class not found' errors"
  artifacts:
    - path: "src/Events/Controllers/ClassChangeController.php"
      provides: "DELETED - CLI controller for dropped trigger infrastructure"
    - path: "src/Events/Models/ClassChangeSchema.php"
      provides: "DELETED - PostgreSQL trigger definitions"
    - path: "src/Events/Services/ClassChangeListener.php"
      provides: "DELETED - LISTEN/NOTIFY handler"
    - path: "src/Events/Services/TaskTemplateRegistry.php"
      provides: "DELETED - Template-based task generation"
    - path: "src/Events/Repositories/ClassChangeLogRepository.php"
      provides: "DELETED - Repository for dropped class_change_logs table"
    - path: "src/Events/Services/AISummaryDisplayService.php"
      provides: "DELETED - Depends on ClassChangeLogRepository"
    - path: "src/Events/Services/TaskManager.php"
      provides: "Clean TaskManager - no TaskTemplateRegistry dependency, dead methods removed"
    - path: "src/Events/Support/Container.php"
      provides: "Clean Container - no TaskTemplateRegistry references"
  key_links:
    - from: "src/Events/Services/TaskManager.php"
      to: "buildTasksFromEvents()"
      via: "direct method call"
      pattern: "buildTasksFromEvents"
    - from: "src/Events/Support/Container.php"
      to: "TaskManager"
      via: "parameterless constructor"
      pattern: "new TaskManager\\(\\)"
---

<objective>
Remove deprecated trigger-based task system files and clean up all references.

Purpose: Complete v1.2 refactor by removing dead code that relied on dropped class_change_logs table and PostgreSQL triggers.

Output: Clean codebase with only event-based task system remaining.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-code-cleanup/17-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete deprecated files</name>
  <files>
    src/Events/Controllers/ClassChangeController.php
    src/Events/Models/ClassChangeSchema.php
    src/Events/Services/ClassChangeListener.php
    src/Events/Services/TaskTemplateRegistry.php
    src/Events/Repositories/ClassChangeLogRepository.php
    src/Events/Services/AISummaryDisplayService.php
  </files>
  <action>
Delete 6 deprecated files that relied on the dropped class_change_logs table and PostgreSQL triggers:

**IMPORTANT: Delete ClassChangeController.php FIRST** - it references all other files to be deleted.

1. `rm src/Events/Controllers/ClassChangeController.php` - CLI controller for trigger management (imports ClassChangeSchema, ClassChangeLogRepository, ClassChangeListener)
2. `rm src/Events/Models/ClassChangeSchema.php` - PostgreSQL trigger definitions (creates dropped table)
3. `rm src/Events/Services/ClassChangeListener.php` - LISTEN/NOTIFY handler for triggers (listens to dropped trigger)
4. `rm src/Events/Services/TaskTemplateRegistry.php` - Template-based task generation (replaced by buildTasksFromEvents)
5. `rm src/Events/Repositories/ClassChangeLogRepository.php` - Queries dropped class_change_logs table
6. `rm src/Events/Services/AISummaryDisplayService.php` - Depends on ClassChangeLogRepository (only 28 lines, queries dropped table)

**Files already deleted (no action needed):**
- ClassChangeLogDTO.php - ALREADY REMOVED (CLEAN-05 complete)
- ChangeOperation.php - ALREADY REMOVED (CLEAN-06 complete)

**Why these files are safe to delete:**
- All query the class_change_logs table which was DROPPED in Phase 13
- ClassChangeController has no registration in wecoza-core.php (orphaned)
- AISummaryDisplayService registration is DISABLED (commented out in wecoza-core.php lines 211-220)
- TaskTemplateRegistry is referenced by TaskManager/Container but those code paths query the dropped table
  </action>
  <verify>
```bash
cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core

# Verify files are deleted
for f in src/Events/Controllers/ClassChangeController.php \
         src/Events/Models/ClassChangeSchema.php \
         src/Events/Services/ClassChangeListener.php \
         src/Events/Services/TaskTemplateRegistry.php \
         src/Events/Repositories/ClassChangeLogRepository.php \
         src/Events/Services/AISummaryDisplayService.php; do
  ls "$f" 2>/dev/null && echo "FAIL: $f still exists" || echo "OK: $f deleted"
done
```
  </verify>
  <done>6 deprecated files removed from filesystem</done>
</task>

<task type="auto">
  <name>Task 2: Clean TaskManager - remove dead code</name>
  <files>
    src/Events/Services/TaskManager.php
  </files>
  <action>
Remove TaskTemplateRegistry dependency AND all methods that query the dropped class_change_logs table.

**Changes to make:**

1. **Remove import (line 32):**
   Delete: `private TaskTemplateRegistry $registry;`

2. **Simplify constructor (lines 34-38):**
   ```php
   // FROM:
   public function __construct(?TaskTemplateRegistry $registry = null)
   {
       $this->db = PostgresConnection::getInstance();
       $this->registry = $registry ?? new TaskTemplateRegistry();
   }

   // TO:
   public function __construct()
   {
       $this->db = PostgresConnection::getInstance();
   }
   ```

3. **Remove dead methods that query dropped class_change_logs table:**
   - `getTasksWithTemplate()` (lines 40-73) - queries class_change_logs
   - `fetchOperation()` (lines 204-224) - queries class_change_logs.operation
   - `getTasksForLog()` (lines 226-251) - queries class_change_logs.tasks
   - `saveTasksForLog()` (lines 253-268) - updates class_change_logs.tasks
   - `getPreviousTasksSnapshot()` (lines 288-325) - queries class_change_logs
   - `fetchClassIdForLog()` (lines 332-352) - queries class_change_logs.class_id

4. **Keep all methods that work with the new event-based system:**
   - `markTaskCompleted()`
   - `completeAgentOrderTask()`
   - `reopenTask()`
   - `reopenAgentOrderTask()`
   - `fetchClassById()`
   - `updateClassOrderNumber()`
   - `normaliseOrderNumber()`
   - `parseEventIndex()`
   - `updateEventStatus()`
   - `parseEventDates()`
   - `buildTasksFromEvents()`
   - `buildAgentOrderTask()`
   - `buildEventTask()`
   - `decodeJson()`
   - `encodeJson()`
   - `requiresNote()`

**Why remove these methods:**
- They ALL query class_change_logs table which was DROPPED in Phase 13
- New system uses `buildTasksFromEvents()` which reads from `classes.event_dates` JSONB
- Keeping dead code creates confusion and maintenance burden
  </action>
  <verify>
```bash
cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core

# PHP syntax check
php -l src/Events/Services/TaskManager.php

# Verify no TaskTemplateRegistry reference
grep -n "TaskTemplateRegistry" src/Events/Services/TaskManager.php && echo "FAIL: TaskTemplateRegistry reference found" || echo "OK: No TaskTemplateRegistry"

# Verify no class_change_logs reference
grep -n "class_change_logs" src/Events/Services/TaskManager.php && echo "FAIL: class_change_logs reference found" || echo "OK: No class_change_logs"

# Verify buildTasksFromEvents still exists
grep -n "buildTasksFromEvents" src/Events/Services/TaskManager.php && echo "OK: buildTasksFromEvents present" || echo "FAIL: buildTasksFromEvents missing"
```
  </verify>
  <done>
- TaskManager constructor takes no parameters
- All dead methods querying class_change_logs removed
- Event-based methods (buildTasksFromEvents, etc.) preserved
- No PHP syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Clean Container and ClassTaskService</name>
  <files>
    src/Events/Support/Container.php
  </files>
  <action>
Remove TaskTemplateRegistry from Container and update TaskManager/ClassTaskService instantiation.

**Changes to Container.php:**

1. **Remove import (line 15):**
   Delete: `use WeCoza\Events\Services\TaskTemplateRegistry;`

2. **Remove property (line 22):**
   Delete: `private static ?TaskTemplateRegistry $taskTemplateRegistry = null;`

3. **Remove method (lines 33-40):**
   Delete entire `taskTemplateRegistry()` method:
   ```php
   // DELETE THIS:
   public static function taskTemplateRegistry(): TaskTemplateRegistry
   {
       if (self::$taskTemplateRegistry === null) {
           self::$taskTemplateRegistry = new TaskTemplateRegistry();
       }
       return self::$taskTemplateRegistry;
   }
   ```

4. **Update taskManager() method (line 54):**
   ```php
   // FROM:
   self::$taskManager = new TaskManager(self::taskTemplateRegistry());

   // TO:
   self::$taskManager = new TaskManager();
   ```

5. **Update classTaskService() method (lines 63-67):**
   ```php
   // FROM:
   self::$classTaskService = new ClassTaskService(
       self::classTaskRepository(),
       self::taskManager(),
       self::taskTemplateRegistry()
   );

   // TO:
   self::$classTaskService = new ClassTaskService(
       self::classTaskRepository(),
       self::taskManager()
   );
   ```

**Note:** ClassTaskService.php was already cleaned in Phase 14-02 - its constructor already accepts only repository and taskManager (verified in codebase). The Container was never updated to match.
  </action>
  <verify>
```bash
cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core

# PHP syntax check
php -l src/Events/Support/Container.php

# Verify no TaskTemplateRegistry reference
grep -n "TaskTemplateRegistry" src/Events/Support/Container.php && echo "FAIL: TaskTemplateRegistry reference found" || echo "OK: No TaskTemplateRegistry"

# Verify taskManager uses parameterless constructor
grep -n "new TaskManager()" src/Events/Support/Container.php && echo "OK: Parameterless constructor" || echo "FAIL: Check constructor"
```
  </verify>
  <done>
- Container.php has no TaskTemplateRegistry references
- TaskManager created with no parameters
- ClassTaskService created with 2 parameters (repository, taskManager)
- No PHP syntax errors
  </done>
</task>

<task type="auto">
  <name>Task 4: Update test file to remove deprecated references</name>
  <files>
    tests/Events/AISummarizationTest.php
  </files>
  <action>
Update AISummarizationTest.php to remove references to deleted classes and the dropped table.

**Changes to make:**

1. **Remove import (line 22):**
   Delete: `use WeCoza\Events\Repositories\ClassChangeLogRepository;`

2. **Remove Section 5 tests (lines 320-364):**
   These test AISummaryDisplayService which is being deleted.
   Replace Section 5 with a skip notice:
   ```php
   echo "SECTION 5: AISummaryDisplayService - SKIPPED (deprecated, removed in Phase 17)\n";
   echo "------------------------------------------------------------------------------\n\n";
   ```

3. **Remove Section 8 tests (lines 433-481):**
   These test ClassChangeLogRepository which is being deleted.
   Replace Section 8 with a skip notice:
   ```php
   echo "SECTION 8: Repository and Data Layer - SKIPPED (deprecated, removed in Phase 17)\n";
   echo "--------------------------------------------------------------------------------\n\n";
   ```

4. **Update Section 14 database tests (lines 673-736):**
   Remove tests that check for class_change_logs table (lines 679-699) and ai_summary column.
   Replace with skip notice:
   ```php
   echo "SECTION 14: AI-02 Database Persistence - SKIPPED (table dropped in Phase 13)\n";
   echo "-----------------------------------------------------------------------------\n\n";
   ```

5. **Fix Section 14 reference (line 735):**
   Delete line: `$runner->test('ClassChangeLogRepository::getLogsWithAISummary() verified in Section 8', true);`

**Why update instead of delete:**
- Test file tests other functionality (OpenAIConfig, AISummaryService, NotificationProcessor)
- Only remove sections that test deprecated code
- Preserves AI summarization test coverage for active code
  </action>
  <verify>
```bash
cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core

# PHP syntax check
php -l tests/Events/AISummarizationTest.php

# Verify no ClassChangeLogRepository reference
grep -n "ClassChangeLogRepository" tests/Events/AISummarizationTest.php && echo "FAIL: ClassChangeLogRepository reference found" || echo "OK: No ClassChangeLogRepository"

# Verify no AISummaryDisplayService reference
grep -n "AISummaryDisplayService" tests/Events/AISummarizationTest.php && echo "FAIL: AISummaryDisplayService reference found" || echo "OK: No AISummaryDisplayService"

# Verify file runs without fatal errors (quick syntax validation)
php -r "require 'tests/Events/AISummarizationTest.php';" 2>&1 | head -5 || true
```
  </verify>
  <done>
- ClassChangeLogRepository import removed
- AISummaryDisplayService import removed
- Section 5, 8, and 14 deprecated tests replaced with skip notices
- Test file has valid PHP syntax
- No "class not found" errors when running
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **PHP syntax check all modified files:**
   ```bash
   cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core
   php -l src/Events/Services/TaskManager.php
   php -l src/Events/Support/Container.php
   php -l tests/Events/AISummarizationTest.php
   ```

2. **Verify no references to deleted classes in src/:**
   ```bash
   grep -r "ClassChangeSchema\|ClassChangeListener\|TaskTemplateRegistry\|ClassChangeLogRepository\|ClassChangeController\|AISummaryDisplayService" src/ --include="*.php" | grep -v "^Binary"
   ```

3. **Verify no references to dropped table:**
   ```bash
   grep -r "class_change_logs" src/Events/ --include="*.php" | grep -v "^Binary"
   ```

4. **Functional smoke test:**
   - Load WordPress admin (no PHP fatal errors)
   - Load task dashboard shortcode page
   - Load class edit form
   - Complete and reopen a task
</verification>

<success_criteria>
- [ ] 6 deprecated files deleted (ClassChangeController, ClassChangeSchema, ClassChangeListener, TaskTemplateRegistry, ClassChangeLogRepository, AISummaryDisplayService)
- [ ] CLEAN-05 (ClassChangeLogDTO) confirmed already deleted
- [ ] CLEAN-06 (ChangeOperation) confirmed already deleted
- [ ] TaskManager.php has no TaskTemplateRegistry dependency
- [ ] TaskManager.php has no methods querying class_change_logs
- [ ] Container.php has no TaskTemplateRegistry references
- [ ] Test file updated - no references to deleted classes
- [ ] No PHP fatal errors on site load
- [ ] Task dashboard still functions
- [ ] Class forms still work
</success_criteria>

<output>
After completion, create `.planning/phases/17-code-cleanup/17-01-SUMMARY.md`
</output>
