---
phase: 04-task-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/Events/TaskManagementTest.php
  - .planning/phases/04-task-management/04-01-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "PostgreSQL triggers fire on class INSERT/UPDATE and create class_change_logs records"
    - "Task dashboard shortcode [wecoza_event_tasks] renders without PHP errors"
    - "Tasks are generated from templates based on operation type (INSERT/UPDATE)"
    - "AJAX handler responds to task complete/reopen requests"
    - "Task filtering by class_id via URL parameter works"
  artifacts:
    - path: "src/Events/Shortcodes/EventTasksShortcode.php"
      provides: "Shortcode registration and rendering"
      contains: "add_shortcode('wecoza_event_tasks'"
    - path: "src/Events/Controllers/TaskController.php"
      provides: "AJAX handlers for task operations"
      contains: "wp_ajax_wecoza_events_task_update"
    - path: "src/Events/Services/TaskManager.php"
      provides: "Task CRUD operations"
      exports: ["markTaskCompleted", "reopenTask", "getTasksWithTemplate"]
    - path: "src/Events/Services/TaskTemplateRegistry.php"
      provides: "Task templates per operation type"
      contains: "wecoza_events_task_templates"
    - path: "src/Events/Repositories/ClassTaskRepository.php"
      provides: "Database queries for class tasks"
      exports: ["fetchClasses"]
    - path: "views/events/event-tasks/main.php"
      provides: "Task dashboard view template"
  key_links:
    - from: "wecoza-core.php"
      to: "EventTasksShortcode::register()"
      via: "plugins_loaded hook"
      pattern: "EventTasksShortcode::register"
    - from: "wecoza-core.php"
      to: "TaskController::register()"
      via: "plugins_loaded hook"
      pattern: "TaskController::register"
    - from: "ClassTaskService"
      to: "ClassTaskRepository"
      via: "dependency injection"
      pattern: "ClassTaskRepository"
    - from: "TaskManager"
      to: "class_change_logs table"
      via: "SQL queries"
      pattern: "class_change_logs"
---

<objective>
Verify the migrated task management functionality works correctly within wecoza-core.

Purpose: Confirm that the Events module task management infrastructure (shortcode, AJAX handler, services, repository) operates correctly after migration from the standalone events plugin. This validates requirements TASK-01 through TASK-05.

Output: Verification test results confirming all task management features work, plus phase summary documenting the verification.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-task-management/04-CONTEXT.md

Key components to verify (already migrated):
- src/Events/Shortcodes/EventTasksShortcode.php — shortcode registration
- src/Events/Controllers/TaskController.php — AJAX handlers
- src/Events/Services/TaskManager.php — task CRUD operations
- src/Events/Services/ClassTaskService.php — dashboard data fetching
- src/Events/Services/TaskTemplateRegistry.php — task templates per operation
- src/Events/Repositories/ClassTaskRepository.php — database queries
- src/Events/Views/Presenters/ClassTaskPresenter.php — data formatting
- views/events/event-tasks/main.php — view template
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify shortcode registration and rendering</name>
  <files>tests/Events/TaskManagementTest.php</files>
  <action>
Create a PHP test file that verifies:

1. EventTasksShortcode is registered: Check `shortcode_exists('wecoza_event_tasks')` returns true after wecoza-core loads.

2. Shortcode renders without errors: Call `do_shortcode('[wecoza_event_tasks]')` and verify:
   - No PHP errors/warnings
   - Output contains expected HTML structure (`.wecoza-event-tasks` wrapper)
   - Contains data attributes for AJAX (data-nonce, data-ajax-url)

3. AJAX handler is registered: Verify `wp_ajax_wecoza_events_task_update` action exists.

4. TaskController is instantiated: Verify TaskController::register() has been called.

Use WP-CLI to run the test:
```bash
wp eval-file tests/Events/TaskManagementTest.php
```

Test file should output PASS/FAIL for each check with clear descriptions.
  </action>
  <verify>
Run: `wp eval-file tests/Events/TaskManagementTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All checks pass (shortcode registered, renders without errors, AJAX handler registered)
  </verify>
  <done>
- `shortcode_exists('wecoza_event_tasks')` returns true
- Shortcode output contains `.wecoza-event-tasks` wrapper
- `wp_ajax_wecoza_events_task_update` action is registered
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify database integration and task generation</name>
  <files>tests/Events/TaskManagementTest.php</files>
  <action>
Extend the test file to verify database integration:

1. Verify class_change_logs table exists: Query `information_schema.tables` for `class_change_logs`.

2. Verify PostgreSQL triggers exist: Query `information_schema.triggers` for `log_class_change_insert` and `log_class_change_update` triggers on `classes` table.

3. Verify TaskTemplateRegistry returns correct templates:
   - INSERT operation returns: agent-order, load-learners, training-schedule, material-delivery, agent-paperwork
   - UPDATE operation returns: review-update, notify-agents, adjust-materials
   - DELETE operation returns: inform-stakeholders, archive-records

4. Verify ClassTaskRepository can fetch classes: Call `fetchClasses(5, 'desc', null)` and verify it returns an array without errors.

5. Verify TaskManager can work with task collections: Test `getTasksForLog()` method returns a TaskCollection instance.

Add these checks to the existing test file and run via WP-CLI.
  </action>
  <verify>
Run: `wp eval-file tests/Events/TaskManagementTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All database checks pass (table exists, triggers exist, templates correct, repository works)
  </verify>
  <done>
- class_change_logs table exists in PostgreSQL
- PostgreSQL triggers are registered on classes table
- TaskTemplateRegistry returns correct task templates per operation
- ClassTaskRepository.fetchClasses() executes without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify filtering and presenter functionality</name>
  <files>tests/Events/TaskManagementTest.php</files>
  <action>
Add final verification checks:

1. Verify ClassTaskPresenter formats data correctly:
   - Instantiate ClassTaskPresenter
   - Verify `present()` method accepts array and returns formatted data
   - Verify `presentTasks()` method returns open/completed task arrays

2. Verify filtering works:
   - Test ClassTaskService.getClassTasks() with class_id filter
   - Test sorting direction (asc/desc) parameter works

3. Verify TemplateRenderer works:
   - Instantiate TemplateRenderer with base path `wecoza_plugin_path('views/events/')`
   - Verify `render('event-tasks/main', [...])` returns HTML string

4. Output final summary:
   - Count of all tests run
   - Count of passed tests
   - List any failures with details

Print a clear PASS/FAIL summary at the end of the test run.
  </action>
  <verify>
Run: `wp eval-file tests/Events/TaskManagementTest.php --path=/opt/lampp/htdocs/wecoza`
Expected: All tests pass, summary shows 100% pass rate
  </verify>
  <done>
- ClassTaskPresenter formats data without errors
- ClassTaskService filtering by class_id works
- Sorting by date works (asc/desc)
- TemplateRenderer renders view template
- Final summary shows all tests passing
  </done>
</task>

</tasks>

<verification>
Run the complete test suite:
```bash
wp eval-file tests/Events/TaskManagementTest.php --path=/opt/lampp/htdocs/wecoza
```

All requirements verified:
- TASK-01: Class change monitoring via PostgreSQL triggers on `public.classes` — triggers exist
- TASK-02: Task generation from class INSERT/UPDATE events — TaskTemplateRegistry provides templates
- TASK-03: Task completion/reopening via AJAX handler — TaskController registered
- TASK-04: Task list shortcode `[wecoza_event_tasks]` renders task dashboard — shortcode works
- TASK-05: Task filtering by status, date, class — ClassTaskService filtering works
</verification>

<success_criteria>
1. Test file executes without PHP errors
2. All shortcode registration checks pass
3. All database integration checks pass
4. All presenter and filtering checks pass
5. Final summary shows 100% pass rate
6. Requirements TASK-01 through TASK-05 are verified
</success_criteria>

<output>
After completion, create `.planning/phases/04-task-management/04-01-SUMMARY.md` with:
- Verification results
- Requirements coverage confirmation
- Any issues found (expected: none)
- Phase completion status
</output>
