---
phase: 12-performance-async-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - composer.json
  - wecoza-core.php
  - src/Events/Services/NotificationProcessor.php
autonomous: true

must_haves:
  truths:
    - "Action Scheduler library is installed and loadable"
    - "NotificationProcessor uses BATCH_LIMIT of 50+"
    - "NotificationProcessor uses LOCK_TTL of 120s"
    - "Action Scheduler performance filters are configured"
  artifacts:
    - path: "composer.json"
      provides: "Action Scheduler dependency"
      contains: "woocommerce/action-scheduler"
    - path: "wecoza-core.php"
      provides: "Action Scheduler bootstrap and performance filters"
      contains: "action-scheduler.php"
    - path: "src/Events/Services/NotificationProcessor.php"
      provides: "Updated batch and lock constants"
      contains: "BATCH_LIMIT = 50"
  key_links:
    - from: "wecoza-core.php"
      to: "vendor/woocommerce/action-scheduler/action-scheduler.php"
      via: "require_once before plugins_loaded"
      pattern: "require.*action-scheduler\\.php"
---

<objective>
Install Action Scheduler and update NotificationProcessor constants for high-volume processing.

Purpose: Lay the foundation for async processing by installing Action Scheduler and updating batch/lock settings to handle 50+ notifications per batch without race conditions.

Output: Working Action Scheduler integration, BATCH_LIMIT = 50, LOCK_TTL = 120s.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-performance-async-processing/12-RESEARCH.md
@composer.json
@wecoza-core.php
@src/Events/Services/NotificationProcessor.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Action Scheduler via Composer</name>
  <files>composer.json</files>
  <action>
Add Action Scheduler dependency to composer.json:

1. Add to the "require" section:
   ```json
   "woocommerce/action-scheduler": "^3.9"
   ```

2. Run `composer install` to fetch the dependency

Important: Action Scheduler 3.9+ is required for the async job queue functionality. This is the WordPress ecosystem standard used by WooCommerce with 6.4M+ installs.
  </action>
  <verify>
1. `cat composer.json | grep action-scheduler` shows the dependency
2. `ls vendor/woocommerce/action-scheduler/action-scheduler.php` confirms file exists
3. `composer show woocommerce/action-scheduler` shows version 3.9+
  </verify>
  <done>Action Scheduler installed in vendor directory via Composer</done>
</task>

<task type="auto">
  <name>Task 2: Bootstrap Action Scheduler and add performance filters</name>
  <files>wecoza-core.php</files>
  <action>
Modify wecoza-core.php to load Action Scheduler BEFORE plugins_loaded:

1. After the "Load Helper Functions" section (around line 86), add a new section:

```php
/*
|--------------------------------------------------------------------------
| Load Action Scheduler
|--------------------------------------------------------------------------
|
| Action Scheduler must be loaded before plugins_loaded hook for proper
| initialization. Used for async email/AI processing in notifications.
|
*/

$action_scheduler_path = WECOZA_CORE_PATH . 'vendor/woocommerce/action-scheduler/action-scheduler.php';
if (file_exists($action_scheduler_path)) {
    require_once $action_scheduler_path;
}
```

2. Inside the `plugins_loaded` callback (after the Events Module initialization, around line 205), add performance tuning filters:

```php
// Action Scheduler Performance Tuning
add_filter('action_scheduler_queue_runner_time_limit', function () {
    return 60;  // 60 seconds (default is 30)
});

add_filter('action_scheduler_queue_runner_batch_size', function () {
    return 50;  // Match NotificationProcessor BATCH_LIMIT
});
```

Why: Action Scheduler requires loading before plugins_loaded to initialize its data stores. Performance filters tune AS to match our batch processing needs.
  </action>
  <verify>
1. `grep -n "action-scheduler.php" wecoza-core.php` shows require_once line
2. `grep -n "action_scheduler_queue_runner" wecoza-core.php` shows both filter registrations
3. PHP syntax check: `php -l wecoza-core.php` returns no errors
  </verify>
  <done>Action Scheduler loads before plugins_loaded, performance filters configured</done>
</task>

<task type="auto">
  <name>Task 3: Update NotificationProcessor constants</name>
  <files>src/Events/Services/NotificationProcessor.php</files>
  <action>
Update the NotificationProcessor constants for high-volume processing:

1. Change LOCK_TTL from 30 to 120:
   ```php
   private const LOCK_TTL = 120;  // 2 minutes for 50+ item batches
   ```

2. Change BATCH_LIMIT from 1 to 50:
   ```php
   private const BATCH_LIMIT = 50;
   ```

3. Update MAX_RUNTIME_SECONDS from 20 to 90 (must be less than LOCK_TTL):
   ```php
   private const MAX_RUNTIME_SECONDS = 90;  // Room for 50 items
   ```

4. Keep MIN_REMAINING_SECONDS at 5 (unchanged, reasonable safety margin)

5. Add a refreshLock() method after the acquireLock() method for future use (optional but recommended):
   ```php
   private function refreshLock(): void
   {
       // Extend lock during long processing
       set_transient(self::LOCK_KEY, '1', self::LOCK_TTL);
   }
   ```

Why:
- LOCK_TTL = 120 > MAX_RUNTIME (90) + safety (30) prevents race conditions
- BATCH_LIMIT = 50 matches Action Scheduler batch size filter
- MAX_RUNTIME = 90 gives ~1.8s per notification average (plenty of headroom)
  </action>
  <verify>
1. `grep "LOCK_TTL = 120" src/Events/Services/NotificationProcessor.php` shows updated value
2. `grep "BATCH_LIMIT = 50" src/Events/Services/NotificationProcessor.php` shows updated value
3. `grep "MAX_RUNTIME_SECONDS = 90" src/Events/Services/NotificationProcessor.php` shows updated value
4. PHP syntax check: `php -l src/Events/Services/NotificationProcessor.php` returns no errors
  </verify>
  <done>NotificationProcessor processes 50+ items with 120s lock TTL</done>
</task>

</tasks>

<verification>
Phase verification after all tasks complete:

1. **Composer dependency installed:**
   ```bash
   composer show woocommerce/action-scheduler --no-ansi 2>/dev/null | head -5
   ```
   Expected: Shows action-scheduler version 3.9+

2. **Action Scheduler loads correctly:**
   ```bash
   wp eval "echo class_exists('ActionScheduler') ? 'AS loaded' : 'AS not loaded';"
   ```
   Expected: "AS loaded"

3. **Constants updated:**
   ```bash
   grep -E "(BATCH_LIMIT|LOCK_TTL|MAX_RUNTIME)" src/Events/Services/NotificationProcessor.php
   ```
   Expected: BATCH_LIMIT = 50, LOCK_TTL = 120, MAX_RUNTIME_SECONDS = 90

4. **Performance filters registered:**
   ```bash
   wp eval "echo has_filter('action_scheduler_queue_runner_time_limit') ? 'time filter ok' : 'time filter missing';"
   wp eval "echo has_filter('action_scheduler_queue_runner_batch_size') ? 'batch filter ok' : 'batch filter missing';"
   ```
   Expected: Both return "ok"
</verification>

<success_criteria>
- PERF-01 satisfied: BATCH_LIMIT increased to 50+
- PERF-04 satisfied: LOCK_TTL increased to 120s
- Action Scheduler installed and bootstrapped (foundation for PERF-02, PERF-03)
- No PHP syntax errors
- Plugin loads successfully with `wp eval` tests
</success_criteria>

<output>
After completion, create `.planning/phases/12-performance-async-processing/12-01-SUMMARY.md`
</output>
