---
phase: 49-backend-logic
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Classes/Repositories/AttendanceRepository.php
autonomous: true
requirements: [BACK-04, SESS-03]

must_haves:
  truths:
    - "AttendanceRepository extends BaseRepository with column whitelisting for all four whitelist methods"
    - "findByClass returns all sessions for a given class_id ordered by session_date"
    - "findByClassAndDate returns a single session row or null for a (class_id, session_date) pair"
    - "createSession inserts a row and returns the new session_id via RETURNING"
    - "updateSession updates allowed columns for a given session_id"
    - "deleteSession removes a session row by session_id"
    - "The DB UNIQUE constraint on (class_id, session_date) prevents duplicate sessions (enforced at schema level)"
  artifacts:
    - path: "src/Classes/Repositories/AttendanceRepository.php"
      provides: "CRUD for class_attendance_sessions table"
      contains: "class AttendanceRepository extends BaseRepository"
  key_links:
    - from: "src/Classes/Repositories/AttendanceRepository.php"
      to: "class_attendance_sessions"
      via: "protected static string $table"
      pattern: "class_attendance_sessions"
---

<objective>
Create the AttendanceRepository providing CRUD operations for the class_attendance_sessions table with full column whitelisting security.

Purpose: Data access layer for attendance sessions — all service-layer operations delegate DB work here.
Output: `src/Classes/Repositories/AttendanceRepository.php` with six public methods.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@schema/class_attendance_sessions.sql
@core/Abstract/BaseRepository.php
@src/Learners/Repositories/LearnerProgressionRepository.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AttendanceRepository with CRUD and column whitelisting</name>
  <files>src/Classes/Repositories/AttendanceRepository.php</files>
  <action>
Create `src/Classes/Repositories/AttendanceRepository.php` in namespace `WeCoza\Classes\Repositories`.

Extend `WeCoza\Core\Abstract\BaseRepository`. Set:
- `protected static string $table = 'class_attendance_sessions';`
- `protected static string $primaryKey = 'session_id';`

Override the four column whitelist methods:

**getAllowedOrderColumns():** `['session_id', 'class_id', 'session_date', 'status', 'captured_at', 'created_at', 'updated_at']`

**getAllowedFilterColumns():** `['session_id', 'class_id', 'session_date', 'status', 'captured_by']`

**getAllowedInsertColumns():** `['class_id', 'session_date', 'status', 'scheduled_hours', 'notes', 'captured_by', 'captured_at', 'created_at', 'updated_at']`

**getAllowedUpdateColumns():** `['status', 'scheduled_hours', 'notes', 'captured_by', 'captured_at', 'updated_at']`

Add six public methods:

1. **findByClass(int $classId): array** — `SELECT * FROM class_attendance_sessions WHERE class_id = :class_id ORDER BY session_date ASC`. Uses parameterized query. Returns array of rows.

2. **findByClassAndDate(int $classId, string $sessionDate): ?array** — `SELECT * FROM class_attendance_sessions WHERE class_id = :class_id AND session_date = :session_date LIMIT 1`. Returns row or null.

3. **createSession(array $data): ?int** — Delegates to `parent::insert($data)`. The parent filters via `getAllowedInsertColumns()` and uses `RETURNING session_id`. Returns the new session_id or null.

4. **updateSession(int $sessionId, array $data): bool** — Delegates to `parent::update($sessionId, $data)`. The parent filters via `getAllowedUpdateColumns()`.

5. **deleteSession(int $sessionId): bool** — Delegates to `parent::delete($sessionId)`.

6. **getSessionsWithLearnerHours(int $sessionId): array** — Joins `class_attendance_sessions cas` with `learner_hours_log lhl ON lhl.session_id = cas.session_id` and `learners l ON lhl.learner_id = l.id` to get per-learner hours for a captured session. SQL:
```sql
SELECT lhl.learner_id, CONCAT(l.first_name, ' ', l.surname) AS learner_name,
       lhl.hours_trained, lhl.hours_present, (lhl.hours_trained - lhl.hours_present) AS hours_absent
FROM learner_hours_log lhl
LEFT JOIN learners l ON lhl.learner_id = l.id
WHERE lhl.session_id = :session_id
ORDER BY l.surname, l.first_name
```
Returns array of rows. Wrap in try/catch, log error via `error_log(wecoza_sanitize_exception(...))`, return empty array on failure.

Follow the established pattern: `declare(strict_types=1)`, ABSPATH guard, `use PDO; use Exception;` imports, error logging via `wecoza_sanitize_exception()`.

All SQL column names are hardcoded literals (add comment: `// quoteIdentifier: all column names in this repository are hardcoded literals (safe)`).
  </action>
  <verify>
    <automated>cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core && php -l src/Classes/Repositories/AttendanceRepository.php</automated>
    <manual>Verify: class extends BaseRepository, 4 whitelist methods present, 6 public methods present, namespace is WeCoza\Classes\Repositories</manual>
  </verify>
  <done>AttendanceRepository.php exists with all six methods, four whitelist overrides, correct table/primaryKey, no syntax errors. BACK-04 and SESS-03 requirements addressed.</done>
</task>

</tasks>

<verification>
- `php -l src/Classes/Repositories/AttendanceRepository.php` — no syntax errors
- grep confirms: `extends BaseRepository`, `$table = 'class_attendance_sessions'`, `$primaryKey = 'session_id'`
- grep confirms: `getAllowedInsertColumns`, `getAllowedUpdateColumns`, `getAllowedFilterColumns`, `getAllowedOrderColumns`
- grep confirms: `findByClass`, `findByClassAndDate`, `createSession`, `updateSession`, `deleteSession`, `getSessionsWithLearnerHours`
</verification>

<success_criteria>
AttendanceRepository provides type-safe CRUD with column whitelisting. All six methods compile and follow BaseRepository patterns. The UNIQUE constraint on (class_id, session_date) is enforced at DB level (schema from Phase 48), not application level — the repository trusts the constraint and lets the DB throw on duplicates.
</success_criteria>

<output>
After completion, create `.planning/phases/49-backend-logic/49-01-SUMMARY.md`
</output>
