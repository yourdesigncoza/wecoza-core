---
phase: 51-frontend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - views/classes/components/single-class/attendance.php
  - views/classes/components/single-class-display.view.php
  - src/Classes/Controllers/ClassController.php
autonomous: true
requirements: [UI-01, UI-02, UI-03, UI-04, UI-05]

must_haves:
  truths:
    - "Single class display page shows an Attendance section below the Schedule Statistics card"
    - "Attendance section contains three summary cards: Total Sessions, Captured, Pending"
    - "Month filter tabs appear above the session table"
    - "Session table has columns: Date, Day, Time, Hours, Status, Action"
    - "A capture modal shell exists with enrolled learner rows, hours inputs, and submit button"
    - "A view-detail modal shell exists for read-only learner hours breakdown"
    - "attendance-capture.js script is enqueued with correct dependencies on single class display page"
  artifacts:
    - path: "views/classes/components/single-class/attendance.php"
      provides: "Attendance section HTML: summary cards, month tabs, session table, capture modal, view-detail modal"
      min_lines: 100
    - path: "views/classes/components/single-class-display.view.php"
      provides: "Include of attendance component in single class layout"
      contains: "attendance"
    - path: "src/Classes/Controllers/ClassController.php"
      provides: "Script enqueue and localize for attendance-capture.js, plus learnerIds passed to WeCozaSingleClass"
      contains: "attendance-capture"
  key_links:
    - from: "views/classes/components/single-class-display.view.php"
      to: "views/classes/components/single-class/attendance.php"
      via: "wecoza_view include"
      pattern: "wecoza_view.*single-class/attendance"
    - from: "src/Classes/Controllers/ClassController.php"
      to: "assets/js/classes/attendance-capture.js"
      via: "wp_enqueue_script and wp_localize_script"
      pattern: "attendance-capture"
---

<objective>
Create the Attendance section PHP view component and wire it into the single class display page. Enqueue the attendance JS file with correct dependencies and localized data.

Purpose: Provides the HTML shell (summary cards, month tabs, session table, capture modal, view-detail modal) that the JS module in Plan 02 will populate and animate.
Output: attendance.php component, updated single-class-display.view.php, updated ClassController enqueue
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/50-ajax-endpoints/50-01-SUMMARY.md
@views/classes/components/single-class-display.view.php
@views/classes/components/single-class/modal-learners.php
@src/Classes/Controllers/ClassController.php
@src/Classes/Ajax/AttendanceAjaxHandlers.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create attendance.php view component with summary cards, month tabs, session table, and modals</name>
  <files>views/classes/components/single-class/attendance.php</files>
  <action>
Create `views/classes/components/single-class/attendance.php` — the Attendance section component rendered on the single class display page. This is a PHP view template receiving `$component_data` (same as other single-class components).

**Section structure (top to bottom):**

1. **Card wrapper** — `<div class="card mb-4">` with card-header containing `<h4><i class="bi bi-clipboard-check me-2"></i>Attendance</h4>`

2. **Summary cards row** — Inside card-body, a `<div class="row g-3 mb-4" id="attendance-summary-cards">` with three `col-md-4` cards:
   - **Total Sessions**: icon `bi-calendar-range`, value span id=`att-total-sessions`, subtitle "Scheduled" — use Phoenix card pattern: `<div class="d-flex align-items-center">` with `fs-3` icon, `h4` value, `fs-9 text-body-tertiary` subtitle
   - **Captured**: icon `bi-check-circle`, value span id=`att-captured-count`, subtitle "Completed" — same layout
   - **Pending**: icon `bi-clock`, value span id=`att-pending-count`, subtitle "Remaining" — same layout
   All three value spans start with "..." placeholder text (JS will populate)

3. **Month filter tabs** — `<ul class="nav nav-underline mb-3" id="attendance-month-tabs" role="tablist">` — starts empty; JS will populate with month tab `<li>` items. Include a single "All" tab as default: `<li class="nav-item"><button class="nav-link active" data-month="all">All</button></li>`

4. **Alert container** — `<div id="attendance-alert"></div>` for showing error/success messages

5. **Session table** — `<div class="table-responsive"><table class="table table-sm fs-9 mb-0" id="attendance-sessions-table">`:
   - `<thead>` with row: Date, Day, Time, Hours, Status, Action — use `bg-body-highlight` class on `<tr>`, `border-top border-translucent` on each `<th>` (matching modal-learners.php pattern)
   - `<tbody id="attendance-sessions-tbody">` — empty, JS populates rows
   - `<tfoot>` with a single `<tr><td colspan="6" class="text-center text-muted">Loading sessions...</td></tr>` (placeholder)

6. **Capture Modal** — Bootstrap 5 modal outside the card but inside the component:
   ```html
   <div class="modal fade" id="attendanceCaptureModal" tabindex="-1" aria-labelledby="attendanceCaptureModalLabel" aria-hidden="true">
     <div class="modal-dialog modal-lg">
       <div class="modal-content">
         <div class="modal-header border-0 pb-0">
           <h5 class="modal-title" id="attendanceCaptureModalLabel">
             <i class="bi bi-pencil-square me-2"></i>Capture Attendance
           </h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body pt-2">
           <div class="d-flex justify-content-between align-items-center mb-3">
             <span id="capture-session-info" class="text-muted"></span>
             <span id="capture-hours-info" class="badge badge-phoenix badge-phoenix-info"></span>
           </div>
           <div id="capture-alert"></div>
           <div class="table-responsive">
             <table class="table table-sm fs-9 mb-0">
               <thead>
                 <tr class="bg-body-highlight">
                   <th class="border-top border-translucent ps-3">Learner</th>
                   <th class="border-top border-translucent text-center">Hours Trained</th>
                   <th class="border-top border-translucent text-center">Hours Present</th>
                   <th class="border-top border-translucent text-center">Hours Absent</th>
                 </tr>
               </thead>
               <tbody id="capture-learners-tbody"></tbody>
             </table>
           </div>
         </div>
         <div class="modal-footer border-0 pt-0">
           <button type="button" class="btn btn-subtle-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type="button" class="btn btn-phoenix-primary" id="btn-submit-capture">
             <i class="bi bi-check-lg me-1"></i>Submit Attendance
           </button>
         </div>
       </div>
     </div>
   </div>
   ```

7. **View Detail Modal** — Similar modal for viewing captured session detail:
   ```html
   <div class="modal fade" id="attendanceDetailModal" tabindex="-1" aria-labelledby="attendanceDetailModalLabel" aria-hidden="true">
     <div class="modal-dialog modal-lg">
       <div class="modal-content">
         <div class="modal-header border-0 pb-0">
           <h5 class="modal-title" id="attendanceDetailModalLabel">
             <i class="bi bi-eye me-2"></i>Session Detail
           </h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body pt-2">
           <div class="d-flex justify-content-between align-items-center mb-3">
             <span id="detail-session-info" class="text-muted"></span>
             <span id="detail-status-badge"></span>
           </div>
           <div class="table-responsive">
             <table class="table table-sm fs-9 mb-0">
               <thead>
                 <tr class="bg-body-highlight">
                   <th class="border-top border-translucent ps-3">Learner</th>
                   <th class="border-top border-translucent text-center">Hours Trained</th>
                   <th class="border-top border-translucent text-center">Hours Present</th>
                   <th class="border-top border-translucent text-center">Hours Absent</th>
                 </tr>
               </thead>
               <tbody id="detail-learners-tbody"></tbody>
             </table>
           </div>
         </div>
         <div class="modal-footer border-0 pt-0">
           <button type="button" class="btn btn-subtle-secondary" data-bs-dismiss="modal">Close</button>
           <!-- Admin delete button: only rendered if current user has manage_options -->
           <?php if (current_user_can('manage_options')): ?>
           <button type="button" class="btn btn-subtle-danger" id="btn-admin-delete-session">
             <i class="bi bi-trash me-1"></i>Delete &amp; Reverse Hours
           </button>
           <?php endif; ?>
         </div>
       </div>
     </div>
   </div>
   ```

8. **Exception Modal** — Small modal for marking client cancelled / agent absent:
   ```html
   <div class="modal fade" id="attendanceExceptionModal" tabindex="-1" aria-hidden="true">
     <div class="modal-dialog">
       <div class="modal-content">
         <div class="modal-header border-0 pb-0">
           <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Mark Exception</h5>
           <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
         </div>
         <div class="modal-body pt-2">
           <p id="exception-session-info" class="text-muted mb-3"></p>
           <div class="mb-3">
             <label class="form-label">Exception Type</label>
             <select class="form-select" id="exception-type-select">
               <option value="">Select...</option>
               <option value="client_cancelled">Client Cancelled</option>
               <option value="agent_absent">Agent Absent</option>
             </select>
           </div>
           <div class="mb-3">
             <label class="form-label">Notes (optional)</label>
             <textarea class="form-control" id="exception-notes" rows="2"></textarea>
           </div>
         </div>
         <div class="modal-footer border-0 pt-0">
           <button type="button" class="btn btn-subtle-secondary" data-bs-dismiss="modal">Cancel</button>
           <button type="button" class="btn btn-phoenix-warning" id="btn-submit-exception">
             <i class="bi bi-check-lg me-1"></i>Mark Exception
           </button>
         </div>
       </div>
     </div>
   </div>
   ```

**Important conventions:**
- File header with PHPDoc matching existing components (see modal-learners.php pattern)
- `defined('ABSPATH') || exit;` guard at top
- Extract `$class` from `$class ?? []` at the top
- Only render if `!empty($class)` — return early otherwise
- Use `esc_html()` / `esc_attr()` for any PHP output
- Use Phoenix badge classes (`badge-phoenix badge-phoenix-{success|warning|danger|info|secondary}`)
- Table uses `table table-sm fs-9 mb-0` pattern from modal-learners.php
  </action>
  <verify>
    <automated>grep -c "attendance-sessions-tbody\|attendanceCaptureModal\|attendanceDetailModal\|attendanceExceptionModal" views/classes/components/single-class/attendance.php</automated>
    <manual>Verify file has card wrapper, 3 summary cards, month tabs, session table, 3 modals</manual>
  </verify>
  <done>attendance.php exists with summary cards (3), month filter tabs, session table with empty tbody, capture modal with learner table + submit button, view-detail modal with learner table + admin delete button, exception modal with type dropdown</done>
</task>

<task type="auto">
  <name>Task 2: Insert attendance component into single-class-display.view.php and wire JS enqueue in ClassController</name>
  <files>
    views/classes/components/single-class-display.view.php
    src/Classes/Controllers/ClassController.php
  </files>
  <action>
**A. Update single-class-display.view.php:**

Insert the attendance component AFTER the "Class Notes Section" comment (line ~153) and BEFORE the "Monthly Schedule Summary Section" comment. Add:

```php
      <!-- Attendance Section -->
      <?php echo wecoza_view('classes/components/single-class/attendance', $component_data); ?>
```

This places attendance below notes but above schedule stats, giving it visibility.

**B. Update ClassController::enqueueAssets():**

Add the attendance-capture.js script registration AFTER the existing `wecoza-single-class-display-js` registration (around line 222). Register it as:

```php
wp_register_script(
    'wecoza-attendance-capture-js',
    WECOZA_CORE_URL . 'assets/js/classes/attendance-capture.js',
    ['jquery', 'wecoza-single-class-display-js'],
    WECOZA_CORE_VERSION,
    true
);
```

Dependencies: `jquery` and `wecoza-single-class-display-js` (which provides `WeCozaSingleClass` config).

**C. Update ClassController::enqueueAndLocalizeSingleClassScript():**

1. After `wp_enqueue_script('wecoza-single-class-display-js');` add:
```php
wp_enqueue_script('wecoza-attendance-capture-js');
```

2. In the `wp_localize_script` array for `WeCozaSingleClass`, add `learnerIds` — pass the decoded learner array so JS can build the capture modal table. Extract from `$class['learner_ids']`:

```php
$learnerIds = $class['learner_ids'] ?? [];
if (is_string($learnerIds)) {
    $learnerIds = json_decode($learnerIds, true) ?: [];
}
```

Add to the localize array:
```php
'learnerIds' => $learnerIds,
```

This gives the JS module everything needed: `ajaxUrl`, `attendanceNonce`, `classId`, `learnerIds`, and `isAdmin`.
  </action>
  <verify>
    <automated>grep -c "attendance" views/classes/components/single-class-display.view.php && grep -c "attendance-capture" src/Classes/Controllers/ClassController.php && grep -c "learnerIds" src/Classes/Controllers/ClassController.php</automated>
    <manual>Verify attendance component included in single-class-display, script registered and enqueued, learnerIds in localize array</manual>
  </verify>
  <done>single-class-display.view.php includes attendance component via wecoza_view, attendance-capture.js registered and enqueued on single class pages, WeCozaSingleClass includes learnerIds array for capture modal population</done>
</task>

</tasks>

<verification>
1. `grep -q "attendance-sessions-tbody" views/classes/components/single-class/attendance.php` — attendance component exists with session table
2. `grep -q "wecoza_view.*single-class/attendance" views/classes/components/single-class-display.view.php` — included in parent view
3. `grep -q "attendance-capture" src/Classes/Controllers/ClassController.php` — JS enqueued
4. `grep -q "learnerIds" src/Classes/Controllers/ClassController.php` — learner data localized
</verification>

<success_criteria>
- attendance.php renders 3 summary cards, month tabs, session table, capture modal, view-detail modal, exception modal
- Component is included in single-class-display.view.php between notes and schedule stats
- attendance-capture.js is registered with jquery + single-class-display-js dependencies
- WeCozaSingleClass includes classId, attendanceNonce, ajaxUrl, learnerIds, isAdmin
</success_criteria>

<output>
After completion, create `.planning/phases/51-frontend/51-01-SUMMARY.md`
</output>
