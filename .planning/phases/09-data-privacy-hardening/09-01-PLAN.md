---
phase: 09-data-privacy-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Services/Traits/DataObfuscator.php
  - src/Events/Services/AISummaryService.php
autonomous: true

must_haves:
  truths:
    - "obfuscatePayload() return value contains no 'mappings' key"
    - "obfuscatePayloadWithLabels() return value contains no 'mappings' key"
    - "Email addresses display as ****@domain.com (entire local part hidden)"
    - "AISummaryService continues to build email context with alias_map"
  artifacts:
    - path: "src/Events/Services/Traits/DataObfuscator.php"
      provides: "Secure obfuscation without mapping exposure"
      contains: "****@"
    - path: "src/Events/Services/AISummaryService.php"
      provides: "Updated generateSummary using internal state"
      contains: "email_context"
  key_links:
    - from: "src/Events/Services/AISummaryService.php"
      to: "DataObfuscator trait"
      via: "obfuscatePayloadWithLabels() state parameter"
      pattern: "\\$state\\['aliases'\\]"
---

<objective>
Remove PII mapping exposure from DataObfuscator return values (SEC-02) and strengthen email masking to hide entire local part (SEC-03).

Purpose: Prevent reverse-engineering of obfuscated PII by removing mapping dictionaries from public API. Strengthen email privacy by hiding the entire local part rather than showing first/last characters.

Output: DataObfuscator trait with secure return values, strengthened email masking, and AISummaryService updated to access alias mappings via state parameter.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-data-privacy-hardening/09-RESEARCH.md
@src/Events/Services/Traits/DataObfuscator.php
@src/Events/Services/AISummaryService.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove mappings from DataObfuscator return values and strengthen email masking</name>
  <files>src/Events/Services/Traits/DataObfuscator.php</files>
  <action>
Modify the DataObfuscator trait to:

1. **Remove 'mappings' from obfuscatePayload() return** (SEC-02):
   - Current return (line 47-51):
     ```php
     return [
         'payload' => $obfuscated,
         'mappings' => $state['aliases'],  // REMOVE THIS
         'state' => $state,
     ];
     ```
   - New return:
     ```php
     return [
         'payload' => $obfuscated,
         'state' => $state,  // Consumers access aliases via $state['aliases'] if needed
     ];
     ```
   - Update the docblock return type to remove 'mappings' from the array shape

2. **Remove 'mappings' from obfuscatePayloadWithLabels() return** (SEC-02):
   - Current return (line 65-70) includes 'mappings' from result
   - Remove 'mappings' key from the return array
   - Update docblock return type accordingly

3. **Strengthen maskEmail() to hide entire local part** (SEC-03):
   - Current implementation (line 283-296) shows first and last characters:
     ```php
     $localMasked = substr($local, 0, 1) . str_repeat('*', ...) . substr($local, -1);
     ```
   - Replace with domain-visible pattern:
     ```php
     private function maskEmail(string $value): string
     {
         $parts = explode('@', $value, 2);
         if (count($parts) !== 2) {
             return '****@example.com';
         }
         return '****@' . $parts[1];
     }
     ```
   - Result: `john.doe@company.com` becomes `****@company.com`

The state parameter still contains aliases for internal use, but they are not exposed in the return value.
  </action>
  <verify>
Run grep to verify changes:
```bash
# Verify no 'mappings' in return statements
grep -n "'mappings'" src/Events/Services/Traits/DataObfuscator.php
# Should return NO matches

# Verify email masking pattern
grep -n '"\*\*\*\*@"' src/Events/Services/Traits/DataObfuscator.php
# Should show the new pattern in maskEmail()
```
  </verify>
  <done>
- obfuscatePayload() returns only 'payload' and 'state' keys
- obfuscatePayloadWithLabels() returns only 'payload', 'field_labels', and 'state' keys
- maskEmail() returns '****@domain.com' format (entire local part hidden)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AISummaryService to access aliases via state parameter</name>
  <files>src/Events/Services/AISummaryService.php</files>
  <action>
Update AISummaryService.generateSummary() to access alias mappings via the state parameter instead of the removed 'mappings' return key:

1. **Update alias map extraction** (around line 96):
   - Current code:
     ```php
     $aliasMap = $oldRowResult['mappings'];
     ```
   - Change to access via state:
     ```php
     $aliasMap = $oldRowResult['state']['aliases'];
     ```

This is the ONLY change needed because:
- The state parameter is passed by reference through the obfuscation chain
- After processing all rows, the final state contains all accumulated aliases
- The email_context building (lines 144-145, 169) continues to work unchanged

No other changes are required - the email_context structure remains the same, only the source of alias_map changes from direct return to state access.
  </action>
  <verify>
Run grep to verify the change:
```bash
# Verify alias access via state
grep -n "state\['aliases'\]" src/Events/Services/AISummaryService.php
# Should show at least one match

# Verify no direct 'mappings' access
grep -n "\['mappings'\]" src/Events/Services/AISummaryService.php
# Should return NO matches
```
  </verify>
  <done>
- AISummaryService accesses alias mappings via $state['aliases'] instead of $result['mappings']
- email_context continues to include alias_map for email rendering
- No PII mappings exposed in intermediate obfuscation return values
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify existing tests still pass</name>
  <files>tests/Events/AISummarizationTest.php</files>
  <action>
Run the existing test suite to verify the changes don't break functionality:

```bash
cd /opt/lampp/htdocs/wecoza/wp-content/plugins/wecoza-core
php tests/Events/AISummarizationTest.php 2>&1 | head -100
```

The test file tests:
- AISummaryService uses DataObfuscator trait
- obfuscatePayloadWithLabels() method exists

The tests should still pass because:
1. The trait is still used
2. The method still exists with the same signature (state passed by reference)
3. The payload and field_labels are still returned

If any tests fail due to checking for 'mappings' key, note them in the summary for potential test updates in a separate plan.
  </action>
  <verify>
Run test and check output:
```bash
php tests/Events/AISummarizationTest.php 2>&1 | grep -E "(PASS|FAIL|Error)"
```
Tests should pass. Document any failures related to 'mappings' key expectations.
  </verify>
  <done>
- Existing tests pass OR failures documented with specific test names
- DataObfuscator trait functionality verified
- AISummaryService integration verified
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **SEC-02 Verification - No mappings exposure:**
   ```bash
   grep -c "'mappings'" src/Events/Services/Traits/DataObfuscator.php
   # Expected: 0

   grep -c "\['mappings'\]" src/Events/Services/AISummaryService.php
   # Expected: 0
   ```

2. **SEC-03 Verification - Email masking strength:**
   ```bash
   grep -A5 "function maskEmail" src/Events/Services/Traits/DataObfuscator.php
   # Should show '****@' pattern without substr of local part
   ```

3. **Integration test:**
   ```bash
   php tests/Events/AISummarizationTest.php 2>&1 | tail -20
   ```
</verification>

<success_criteria>
- [ ] DataObfuscator.obfuscatePayload() return has no 'mappings' key
- [ ] DataObfuscator.obfuscatePayloadWithLabels() return has no 'mappings' key
- [ ] maskEmail() returns '****@domain.com' format
- [ ] AISummaryService accesses aliases via $state['aliases']
- [ ] Existing tests pass (or failures documented)
</success_criteria>

<output>
After completion, create `.planning/phases/09-data-privacy-hardening/09-01-SUMMARY.md`
</output>
