---
phase: 15-bidirectional-sync
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Events/Services/TaskManager.php
  - src/Events/Models/Task.php
  - src/Classes/Services/FormDataProcessor.php
autonomous: true

must_haves:
  truths:
    - "Task::reopen() preserves existing notes when clearing completion metadata"
    - "TaskManager has updateEventStatus() method for JSONB updates"
    - "FormDataProcessor preserves completed_by/completed_at fields on form save"
  artifacts:
    - path: "src/Events/Services/TaskManager.php"
      provides: "updateEventStatus() and parseEventIndex() methods"
      contains: "function updateEventStatus"
    - path: "src/Events/Models/Task.php"
      provides: "Modified reopen() that preserves notes"
      contains: "reopen"
    - path: "src/Classes/Services/FormDataProcessor.php"
      provides: "Completion metadata passthrough in event_dates processing"
      contains: "completed_by"
  key_links:
    - from: "src/Events/Services/TaskManager.php"
      to: "PostgreSQL jsonb_set()"
      via: "updateEventStatus() SQL"
      pattern: "jsonb_set"
    - from: "src/Classes/Services/FormDataProcessor.php"
      to: "event_dates array building"
      via: "completed_by/completed_at extraction"
      pattern: "completed_by.*completed_at"
---

<objective>
Add foundation methods for bidirectional sync: TaskManager JSONB update capability, Task::reopen() notes preservation, and FormDataProcessor completion metadata passthrough.

Purpose: Enable dashboard task completion/reopen to persist to database, and prevent form saves from stripping completion data.
Output: TaskManager with updateEventStatus(), Task with notes-preserving reopen(), FormDataProcessor with completion metadata support.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-bidirectional-sync/15-RESEARCH.md
@.planning/phases/14-task-system-refactor/14-01-SUMMARY.md
@src/Events/Services/TaskManager.php
@src/Events/Models/Task.php
@src/Classes/Services/FormDataProcessor.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JSONB update methods to TaskManager</name>
  <files>src/Events/Services/TaskManager.php</files>
  <action>
Add two new methods to TaskManager:

1. **parseEventIndex(string $taskId): ?int**
   - Extract integer index from task IDs like "event-3"
   - Return null for non-event tasks (e.g., "agent-order")
   - Use regex: `/^event-(\d+)$/`

2. **updateEventStatus(int $classId, int $eventIndex, string $status, ?int $completedBy, ?string $completedAt, ?string $notes): void**
   - Use PostgreSQL `jsonb_set()` to atomically update specific event in array
   - Build updates array: always include 'status'
   - If status='Completed': include completed_by, completed_at
   - If status='Pending': set completed_by/completed_at to null (clear metadata)
   - If notes provided, include in updates
   - SQL pattern:
   ```sql
   UPDATE classes
   SET event_dates = jsonb_set(
       event_dates,
       :path,
       (event_dates->:index) || :updates::jsonb,
       true
   ),
       updated_at = NOW()
   WHERE class_id = :class_id
   ```
   - Use PDO prepared statements with named parameters

Add required imports at top: `use const JSON_THROW_ON_ERROR;` (already exists)
  </action>
  <verify>
Run syntax check: `php -l src/Events/Services/TaskManager.php`
Run tests: `./vendor/bin/phpunit tests/Events/TaskManagementTest.php`
  </verify>
  <done>
TaskManager has parseEventIndex() returning ?int and updateEventStatus() performing JSONB atomic update
  </done>
</task>

<task type="auto">
  <name>Task 2: Modify Task::reopen() to preserve notes</name>
  <files>src/Events/Models/Task.php</files>
  <action>
Modify the reopen() method to preserve notes instead of clearing them.

Current code:
```php
public function reopen(): self
{
    $clone = clone $this;
    $clone->status = self::STATUS_OPEN;
    $clone->completedBy = null;
    $clone->completedAt = null;
    $clone->note = null;  // <-- REMOVE THIS LINE
    return $clone;
}
```

Change to:
```php
public function reopen(): self
{
    $clone = clone $this;
    $clone->status = self::STATUS_OPEN;
    $clone->completedBy = null;
    $clone->completedAt = null;
    // Note: deliberately preserve $clone->note (SYNC-04 requirement)
    return $clone;
}
```

This ensures user notes survive task reopen operations.
  </action>
  <verify>
Run syntax check: `php -l src/Events/Models/Task.php`
Run tests: `./vendor/bin/phpunit tests/Events/TaskManagementTest.php`
  </verify>
  <done>
Task::reopen() returns cloned task with status=open, completedBy=null, completedAt=null, but note preserved
  </done>
</task>

<task type="auto">
  <name>Task 3: Add completion metadata passthrough to FormDataProcessor</name>
  <files>src/Classes/Services/FormDataProcessor.php</files>
  <action>
Modify the event_dates processing loop in processFormData() to preserve completion metadata.

Locate the event_dates processing section (around line 151-176). After the existing field extraction, add handling for completion metadata:

```php
// Process event dates
$eventDates = [];
$allowedStatuses = ['Pending', 'Completed', 'Cancelled'];
if (isset($data['event_types']) && is_array($data['event_types'])) {
    $types = $data['event_types'];
    $descriptions = isset($data['event_descriptions']) ? $data['event_descriptions'] : [];
    $dates = isset($data['event_dates_input']) ? $data['event_dates_input'] : [];
    $statuses = isset($data['event_statuses']) ? $data['event_statuses'] : [];
    $notes = isset($data['event_notes']) ? $data['event_notes'] : [];
    // ADD: Extract completion metadata arrays
    $completedByArr = isset($data['event_completed_by']) ? $data['event_completed_by'] : [];
    $completedAtArr = isset($data['event_completed_at']) ? $data['event_completed_at'] : [];

    for ($i = 0; $i < count($types); $i++) {
        $currentType = $types[$i] ?? '';
        $currentDate = $dates[$i] ?? '';
        if (!empty($currentType) && !empty($currentDate)) {
            $status = self::sanitizeText($statuses[$i] ?? 'Pending');
            $event = [
                'type' => self::sanitizeText($currentType),
                'description' => self::sanitizeText($descriptions[$i] ?? ''),
                'date' => self::sanitizeText($currentDate),
                'status' => in_array($status, $allowedStatuses) ? $status : 'Pending',
                'notes' => self::sanitizeText($notes[$i] ?? '')
            ];

            // ADD: Preserve completion metadata if present
            if (isset($completedByArr[$i]) && $completedByArr[$i] !== '') {
                $event['completed_by'] = intval($completedByArr[$i]);
            }
            if (isset($completedAtArr[$i]) && $completedAtArr[$i] !== '') {
                $event['completed_at'] = self::sanitizeText($completedAtArr[$i]);
            }

            $eventDates[] = $event;
        }
    }
}
$processed['event_dates'] = $eventDates;
```

This ensures form saves don't strip completion data that was added via dashboard task completion.
  </action>
  <verify>
Run syntax check: `php -l src/Classes/Services/FormDataProcessor.php`
  </verify>
  <done>
FormDataProcessor preserves completed_by (as int) and completed_at (as sanitized string) when processing event_dates from form submission
  </done>
</task>

</tasks>

<verification>
1. PHP syntax check passes for all 3 modified files
2. Existing tests pass (no regressions)
3. TaskManager has new methods: grep for "updateEventStatus" and "parseEventIndex"
4. Task::reopen() no longer sets note to null: grep for "note = null" should NOT appear in reopen()
5. FormDataProcessor handles completion metadata: grep for "completed_by" in the file
</verification>

<success_criteria>
1. TaskManager::parseEventIndex('event-3') returns 3
2. TaskManager::parseEventIndex('agent-order') returns null
3. TaskManager::updateEventStatus() executes JSONB update SQL
4. Task::reopen() preserves notes (no $clone->note = null line)
5. FormDataProcessor extracts event_completed_by/event_completed_at arrays
6. All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-bidirectional-sync/15-01-SUMMARY.md`
</output>
