---
phase: 45-admin-management
plan: 03
type: execute
wave: 2
depends_on: [45-01, 45-02]
files_modified:
  - assets/js/learners/progression-admin.js
autonomous: true
requirements: [ADMIN-01, ADMIN-02, ADMIN-03, ADMIN-04, ADMIN-05, ADMIN-06]

must_haves:
  truths:
    - "On page load, table auto-fetches and renders all progressions with pagination"
    - "Submitting filters reloads table with matching results"
    - "Selecting checkboxes shows bulk action bar with count; clicking Bulk Complete opens confirm modal and processes"
    - "Clicking audit icon on any row opens Hours Log modal with full log entries"
    - "Clicking Start New LP opens modal; submitting creates new progression and refreshes table"
    - "Clicking Hold/Resume in row actions toggles status and updates badge in place"
    - "Filter dropdowns for client, class, product are populated from existing data"
  artifacts:
    - path: "assets/js/learners/progression-admin.js"
      provides: "Full admin management JS module"
      min_lines: 300
  key_links:
    - from: "assets/js/learners/progression-admin.js"
      to: "wp_ajax_get_admin_progressions"
      via: "jQuery.ajax GET"
      pattern: "get_admin_progressions"
    - from: "assets/js/learners/progression-admin.js"
      to: "wp_ajax_bulk_complete_progressions"
      via: "jQuery.ajax POST"
      pattern: "bulk_complete_progressions"
    - from: "assets/js/learners/progression-admin.js"
      to: "wp_ajax_get_progression_hours_log"
      via: "jQuery.ajax GET"
      pattern: "get_progression_hours_log"
    - from: "assets/js/learners/progression-admin.js"
      to: "wp_ajax_start_learner_progression"
      via: "jQuery.ajax POST"
      pattern: "start_learner_progression"
    - from: "assets/js/learners/progression-admin.js"
      to: "wp_ajax_toggle_progression_hold"
      via: "jQuery.ajax POST"
      pattern: "toggle_progression_hold"
---

<objective>
Create the progression-admin.js module that wires all admin management actions: table loading with filters, pagination, bulk complete, hours log modal, start new LP, and hold/resume toggle.

Purpose: Makes the admin management page fully interactive — the final wiring layer.
Output: Single JS file with all admin management functionality.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-admin-management/45-01-SUMMARY.md
@.planning/phases/45-admin-management/45-02-SUMMARY.md
@assets/js/learners/learner-progressions.js (pattern reference)
@views/learners/progression-admin.php (HTML targets)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create progression-admin.js with table loading, filters, and pagination</name>
  <files>assets/js/learners/progression-admin.js</files>
  <action>
Create `assets/js/learners/progression-admin.js` as a jQuery IIFE module (same pattern as `learner-progressions.js`).

**Module structure:**
```javascript
(function($) {
    'use strict';

    const config = window.progressionAdminAjax || {};
    let currentPage = 1;
    let currentFilters = {};

    // ---- DOM Ready ----
    $(document).ready(function() {
        loadProgressions();
        populateFilterDropdowns();
        bindEvents();
    });
```

**Section 1: Table Loading (`loadProgressions`)**

- Build query params from `currentFilters` + `currentPage`.
- `$.ajax` GET to `config.ajaxurl` with action `get_admin_progressions`, nonce, filters.
- On success: call `renderTable(response.data.data)`, `renderPagination(response.data)`.
- On load start: show `#progression-admin-loading`, hide `#progression-admin-content`.
- On complete: hide loading, show content.

**`renderTable(rows)`:**
- Clear `#progression-admin-tbody`.
- For each row, build a `<tr>` using jQuery DOM construction (NOT innerHTML — XSS-safe). Columns:
  1. Checkbox: `<input type="checkbox" class="form-check-input row-checkbox" value="${row.tracking_id}">`
     - Skip checkbox for completed rows (cannot bulk-complete again).
  2. Learner: `row.learner_name`
  3. LP: `row.product_name`
  4. Class: `row.class_code || '—'`
  5. Status: Badge using `statusBadgeClass(row.status)` helper. Map: in_progress -> `badge-phoenix-primary`, completed -> `badge-phoenix-success`, on_hold -> `badge-phoenix-warning`.
  6. Progress: Mini progress bar. Width = `Math.min(100, (row.hours_present / row.product_duration) * 100)`. Show percentage text.
  7. Start date: `row.start_date`
  8. Actions: Dropdown button group with three items:
     - `<a class="dropdown-item btn-hours-log" data-tracking-id="${row.tracking_id}"><i class="bi bi-clock-history"></i> Hours Log</a>`
     - Hold/Resume toggle: If in_progress: `<a class="dropdown-item btn-toggle-hold" data-tracking-id="${row.tracking_id}" data-action="hold"><i class="bi bi-pause-circle"></i> Put on Hold</a>`. If on_hold: `data-action="resume"` with play icon and "Resume" text. If completed: omit this item.
     - Mark Complete (only if not completed): `<a class="dropdown-item btn-mark-single-complete" data-tracking-id="${row.tracking_id}"><i class="bi bi-check-circle"></i> Mark Complete</a>`

**`renderPagination(meta)`:**
- Show `#pagination-info` text: "Showing X-Y of Z" calculated from offset/limit/total.
- Build pagination `<li>` items in `#pagination-controls`: Prev, page numbers (max 5 visible), Next.
- Clicking a page button sets `currentPage` and calls `loadProgressions()`.

**Section 2: Filter Handling**

- `populateFilterDropdowns()`: Make three lightweight AJAX calls to populate client, class, product dropdowns.
  - For clients: `$.ajax` GET `config.ajaxurl` with action `wecoza_get_all_clients` (if exists) or build from a direct query. Simpler approach: use the `get_admin_progressions` data itself — on first load, extract unique clients/classes/products from the response and populate. This avoids needing new endpoints. Store extracted options.
  - **Better approach**: After `loadProgressions` first call, extract distinct values from the full dataset. BUT this only works for current page. Instead, add three simple AJAX calls to populate from DB:
    - Action `get_filter_options_progressions` — a new lightweight handler. BUT we don't want to add more to Plan 01.
    - **Simplest approach**: Hard-code the status options (already in HTML). For client/class/product, populate from the rows returned by get_admin_progressions on first load with `status=''` (all). Extract unique values, sort, populate dropdowns. This works because the admin page loads all data. Add a note that if dataset grows large, a dedicated filter endpoint should be added.
  - On filter form submit: `e.preventDefault()`, read values from selects, update `currentFilters`, set `currentPage = 1`, call `loadProgressions()`.

**Section 3: Checkbox + Bulk Bar**

- `#select-all-progressions` change: Toggle all `.row-checkbox` checkboxes. Update bulk bar.
- `.row-checkbox` change (delegated on tbody): Update `#select-all-progressions` checked state. Call `updateBulkBar()`.
- `updateBulkBar()`: Count checked `.row-checkbox`. If > 0: show `#bulk-action-bar`, update `#selected-count`. Else: hide it.

**Events binding in `bindEvents()`:**
```javascript
$('#progression-filter-form').on('submit', handleFilterSubmit);
$('#select-all-progressions').on('change', handleSelectAll);
$('#progression-admin-tbody').on('change', '.row-checkbox', updateBulkBar);
$('#btn-bulk-complete').on('click', handleBulkCompleteClick);
$('#btn-confirm-bulk-complete').on('click', handleBulkCompleteConfirm);
$('#progression-admin-tbody').on('click', '.btn-hours-log', handleHoursLogClick);
$('#progression-admin-tbody').on('click', '.btn-toggle-hold', handleToggleHold);
$('#progression-admin-tbody').on('click', '.btn-mark-single-complete', handleMarkSingleComplete);
$('#btn-start-new-lp').on('click', handleStartNewLPClick);
$('#btn-submit-start-lp').on('click', handleStartNewLPSubmit);
```
  </action>
  <verify>`wc -l assets/js/learners/progression-admin.js` returns at least 200 lines. `grep -c 'function' assets/js/learners/progression-admin.js` shows multiple functions.</verify>
  <done>Table loads progressions on page load, filters work, pagination navigates, checkboxes toggle bulk bar.</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk complete, hours log, start LP, and hold/resume JS handlers</name>
  <files>assets/js/learners/progression-admin.js</files>
  <action>
Continue in the same file, adding the remaining handler functions.

**Section 4: Bulk Complete**

`handleBulkCompleteClick()`:
- Gather checked `.row-checkbox` values into array.
- Set `#bulk-complete-count` text.
- Show `#bulkCompleteModal` via `new bootstrap.Modal(...)`.

`handleBulkCompleteConfirm()`:
- Gather tracking IDs from checked boxes.
- Disable button, show spinner text.
- `$.ajax` POST to `config.ajaxurl`, action: `bulk_complete_progressions`, tracking_ids: array, nonce.
- On success: Close modal. Show toast/alert: "X progression(s) completed. Y failed." Re-enable button. Call `loadProgressions()` to refresh. Uncheck all checkboxes, hide bulk bar.
- On error: Show alert in modal, re-enable button.

**Section 5: Hours Log**

`handleHoursLogClick(e)`:
- Read `data-tracking-id` from clicked element.
- Show `#hoursLogModal` with loading spinner in body.
- `$.ajax` GET to `config.ajaxurl`, action: `get_progression_hours_log`, tracking_id, nonce.
- On success:
  - Fill `#hours-log-summary` with: learner name bold, LP name badge, status badge, "Hours: X/Y present" text.
  - Fill `#hours-log-tbody` with rows from `response.data.hours_log`. Each row: log_date, hours_trained, hours_present, source badge, notes (truncated to 50 chars with title tooltip).
  - If log empty: show `#hours-log-empty`, hide table. Else: show table, hide empty.
- On error: show alert in modal body.

**Section 6: Start New LP**

`handleStartNewLPClick()`:
- Populate `#start-lp-learner` select from a quick AJAX call — reuse existing `wecoza_get_all_learners_basic` or similar. If no such endpoint exists, use the learner names from the current table data as a fallback. Better: make a quick DB fetch. Simplest: if `wecoza_get_all_learners` action exists, use it. Otherwise, add a note that for production a lightweight learner-list endpoint is recommended.
  - Fallback: populate from existing page data. For now, populate with a placeholder approach: on modal open, make GET to `config.ajaxurl` with action `wecoza_get_all_learners` and nonce. If that fails, show a text input instead of dropdown.
- Populate `#start-lp-product` select similarly — if `wecoza_get_products` or similar action exists, use it. Fallback: use products extracted from the current table.
- Show `#startNewLPModal`.

`handleStartNewLPSubmit()`:
- Read form values. Validate learner_id and product_id are non-empty.
- Disable button.
- `$.ajax` POST to `config.ajaxurl`, action: `start_learner_progression`, data: learner_id, product_id, class_id (optional), notes, nonce.
- On success: Close modal. Show success alert. Reset form. Call `loadProgressions()`.
- On error: Show error in `#start-lp-alert`.

**Section 7: Hold/Resume Toggle**

`handleToggleHold(e)`:
- Read `data-tracking-id` and `data-action` (hold or resume) from clicked element.
- `$.ajax` POST to `config.ajaxurl`, action: `toggle_progression_hold`, tracking_id, action (hold/resume), nonce.
- On success: Update the row's status badge in place (find the `<tr>` by tracking_id, update badge class and text). Also update the actions dropdown (swap Hold<->Resume). Show brief toast.
- On error: Show alert.

`handleMarkSingleComplete(e)`:
- Read `data-tracking-id`.
- Simple confirm via native `confirm()` dialog: "Mark this progression as complete? (No portfolio required for admin bulk/single complete)".
- If confirmed: `$.ajax` POST to `config.ajaxurl`, action: `bulk_complete_progressions`, tracking_ids: [single id], nonce.
- On success: Refresh table via `loadProgressions()`, show toast.

**Utility functions:**

`showAlert(container, message, type)`: Create Bootstrap alert in container using jQuery DOM construction.

`showToast(message, type)`: Create a fixed-position toast at top-right. Auto-dismiss after 3s. Use Phoenix badge colors.

`statusBadgeClass(status)`: Returns badge class string. in_progress -> 'badge badge-phoenix badge-phoenix-primary', completed -> 'badge badge-phoenix badge-phoenix-success', on_hold -> 'badge badge-phoenix badge-phoenix-warning'.

`statusLabel(status)`: Returns human label. in_progress -> 'In Progress', completed -> 'Completed', on_hold -> 'On Hold'.
  </action>
  <verify>
1. `grep -c 'ajax' assets/js/learners/progression-admin.js` returns at least 5 (one per AJAX call).
2. `grep 'bulk_complete_progressions' assets/js/learners/progression-admin.js` finds the action.
3. `grep 'get_progression_hours_log' assets/js/learners/progression-admin.js` finds the action.
4. `grep 'start_learner_progression' assets/js/learners/progression-admin.js` finds the action.
5. `grep 'toggle_progression_hold' assets/js/learners/progression-admin.js` finds the action.
  </verify>
  <done>All admin management JS handlers are wired: bulk complete with confirmation, hours log modal, start new LP modal, hold/resume toggle with in-place update.</done>
</task>

</tasks>

<verification>
1. `wc -l assets/js/learners/progression-admin.js` returns 300+ lines
2. All five AJAX actions referenced in JS
3. File uses jQuery IIFE pattern with 'use strict'
4. All DOM IDs from the view (Plan 02) are targeted
5. No innerHTML usage — only jQuery DOM construction
</verification>

<success_criteria>
- Page loads and table renders progressions automatically
- Filter form submission re-fetches with params and updates table
- Pagination controls navigate between pages
- Select-all checkbox toggles all row checkboxes; bulk bar shows count
- Bulk Complete opens confirm modal, processes selected IDs, refreshes table
- Hours Log icon opens modal with progression summary and log table
- Start New LP button opens modal with form, submits and refreshes
- Hold/Resume toggle updates row status badge in place
- Single mark-complete via actions dropdown works
</success_criteria>

<output>
After completion, create `.planning/phases/45-admin-management/45-03-SUMMARY.md`
</output>
