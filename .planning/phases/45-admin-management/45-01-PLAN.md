---
phase: 45-admin-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Learners/Ajax/ProgressionAjaxHandlers.php
autonomous: true
requirements: [ADMIN-02, ADMIN-03, ADMIN-05, ADMIN-06]

must_haves:
  truths:
    - "AJAX endpoint bulk_complete_progressions accepts array of tracking IDs, marks all as completed, returns updated rows"
    - "AJAX endpoint get_progression_hours_log returns full hours log for a given tracking_id"
    - "AJAX endpoint start_learner_progression creates new LP for a learner given learner_id and product_id"
    - "AJAX endpoint toggle_progression_hold puts in-progress LP on hold or resumes on-hold LP, returns new status"
    - "AJAX endpoint get_admin_progressions returns paginated, filtered progressions for admin table"
  artifacts:
    - path: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      provides: "Five new AJAX handler functions + registration"
      contains: "handle_bulk_complete_progressions"
  key_links:
    - from: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      to: "ProgressionService"
      via: "service method calls"
      pattern: "ProgressionService"
    - from: "src/Learners/Ajax/ProgressionAjaxHandlers.php"
      to: "LearnerProgressionRepository"
      via: "getHoursLog for audit trail"
      pattern: "getHoursLog|getProgressionsForAdmin"
---

<objective>
Add five AJAX endpoints to ProgressionAjaxHandlers.php for admin management operations: bulk-complete, hours-log retrieval, start-new-LP, toggle-hold/resume, and filtered admin data fetch.

Purpose: Backend handlers needed before frontend JS can wire admin management actions.
Output: Extended ProgressionAjaxHandlers.php with five new handlers registered.
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/Learners/Ajax/ProgressionAjaxHandlers.php
@src/Learners/Services/ProgressionService.php
@src/Learners/Repositories/LearnerProgressionRepository.php
@src/Learners/Models/LearnerProgressionModel.php
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add five admin AJAX handler functions</name>
  <files>src/Learners/Ajax/ProgressionAjaxHandlers.php</files>
  <action>
Add five new functions to the existing ProgressionAjaxHandlers.php file (same namespace `WeCoza\Learners\Ajax`). Place them after the existing `handle_log_collision_acknowledgement()` and before `register_progression_ajax_handlers()`.

1. **handle_get_admin_progressions()** — GET handler.
   - Reads optional filter params from `$_GET`: `client_id` (int), `class_id` (int), `product_id` (int), `status` (string, whitelist: in_progress|completed|on_hold), `page` (int, default 1).
   - Calls `verify_learner_access('learners_nonce')` then `current_user_can('manage_options')`.
   - Page size = 25. Calculates offset from page.
   - Calls `$service->getProgressionsForAdmin($filters, $limit, $offset)`.
   - Returns JSON success with `data`, `total`, `pages`, `current_page`.

2. **handle_bulk_complete_progressions()** — POST handler.
   - Reads `$_POST['tracking_ids']` (must be array of ints, max 50).
   - Calls `verify_learner_access('learners_nonce')` then `current_user_can('manage_options')`.
   - Loops tracking IDs. For each, calls `$service->markLPComplete($id, get_current_user_id())` — note: bulk complete does NOT require portfolio file (unlike individual mark-complete which does). Wrap each in try/catch; collect successes and failures.
   - Returns JSON success with `completed` (array of IDs), `failed` (array of `{id, error}`), `count`.

3. **handle_get_progression_hours_log()** — GET handler.
   - Reads `$_GET['tracking_id']` (required int).
   - Calls `verify_learner_access('learners_nonce')`.
   - Creates a `LearnerProgressionRepository` instance and calls `getHoursLog($trackingId)`.
   - Also fetches the progression itself via `LearnerProgressionModel::getById($trackingId)` and returns basic progression info alongside the hours log.
   - Returns JSON success with `progression` (tracking_id, learner_name, product_name, status, hours_present, hours_trained, product_duration), `hours_log` (array of log entries).

4. **handle_start_learner_progression()** — POST handler.
   - Reads `$_POST['learner_id']` (required int), `$_POST['product_id']` (required int), `$_POST['class_id']` (optional int), `$_POST['notes']` (optional string, sanitize_textarea_field).
   - Calls `verify_learner_access('learners_nonce')` then `current_user_can('manage_options')`.
   - Calls `$service->startLearnerProgression($learnerId, $productId, $classId, $notes)`.
   - Returns JSON success with `tracking_id`, `message`.

5. **handle_toggle_progression_hold()** — POST handler.
   - Reads `$_POST['tracking_id']` (required int), `$_POST['action']` (required, whitelist: 'hold'|'resume').
   - Calls `verify_learner_access('learners_nonce')` then `current_user_can('manage_options')`.
   - Gets model via `LearnerProgressionModel::getById($trackingId)`.
   - If action='hold' and status='in_progress', calls `$model->putOnHold('Put on hold by admin')`.
   - If action='resume' and status='on_hold', calls `$model->resume()`.
   - Otherwise throws Exception with descriptive message.
   - Returns JSON success with `tracking_id`, `new_status`, `message`.

IMPORTANT for bulk complete: The existing `markLPComplete()` in ProgressionService requires a portfolio file. For bulk complete, we need to bypass this. Instead of calling `markLPComplete`, call `LearnerProgressionModel::getById($id)` then `$model->markComplete(get_current_user_id())` directly — this avoids the portfolio requirement. Add a note explaining why.
  </action>
  <verify>Run `grep -c 'function handle_' src/Learners/Ajax/ProgressionAjaxHandlers.php` and confirm it returns 9 (4 existing + 5 new).</verify>
  <done>Five handler functions exist with proper nonce verification, capability checks, input validation, and service/model calls.</done>
</task>

<task type="auto">
  <name>Task 2: Register the five new AJAX actions</name>
  <files>src/Learners/Ajax/ProgressionAjaxHandlers.php</files>
  <action>
In the existing `register_progression_ajax_handlers()` function, add five new `add_action` lines after the existing four:

```php
add_action('wp_ajax_get_admin_progressions',      __NAMESPACE__ . '\handle_get_admin_progressions');
add_action('wp_ajax_bulk_complete_progressions',   __NAMESPACE__ . '\handle_bulk_complete_progressions');
add_action('wp_ajax_get_progression_hours_log',    __NAMESPACE__ . '\handle_get_progression_hours_log');
add_action('wp_ajax_start_learner_progression',    __NAMESPACE__ . '\handle_start_learner_progression');
add_action('wp_ajax_toggle_progression_hold',      __NAMESPACE__ . '\handle_toggle_progression_hold');
```

Also add the necessary `use` statement at the top of the file for `LearnerProgressionModel` and `LearnerProgressionRepository` since handlers 3, 4, 5 reference them directly:

```php
use WeCoza\Learners\Models\LearnerProgressionModel;
use WeCoza\Learners\Repositories\LearnerProgressionRepository;
```
  </action>
  <verify>Run `grep -c 'wp_ajax_' src/Learners/Ajax/ProgressionAjaxHandlers.php` and confirm it returns 9 (4 old + 5 new).</verify>
  <done>All nine AJAX actions are registered and will respond to admin-ajax.php requests.</done>
</task>

</tasks>

<verification>
1. `grep -c 'function handle_' src/Learners/Ajax/ProgressionAjaxHandlers.php` returns 9
2. `grep -c 'wp_ajax_' src/Learners/Ajax/ProgressionAjaxHandlers.php` returns 9
3. `php -l src/Learners/Ajax/ProgressionAjaxHandlers.php` returns no syntax errors
</verification>

<success_criteria>
- Five new AJAX handlers exist in ProgressionAjaxHandlers.php
- All handlers have nonce verification and capability checks
- Bulk complete bypasses portfolio requirement by calling model directly
- Hours log handler returns both progression info and log entries
- Toggle hold validates current status before toggling
- All actions registered in register_progression_ajax_handlers()
</success_criteria>

<output>
After completion, create `.planning/phases/45-admin-management/45-01-SUMMARY.md`
</output>
