---
phase: 41-architectural-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/verify-architecture.php
  - .planning/phases/41-architectural-verification/41-01-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - "All PHP files parse without syntax errors"
    - "Service classes exist for Learner, Agent, Client modules"
    - "Controller methods are under 100 lines each"
    - "ClientsModel and AgentModel extend BaseModel"
    - "No duplicate get/set/toArray methods outside BaseModel"
    - "All repositories use quoteIdentifier() for dynamic columns"
    - "Complex SQL queries have bypass comments"
    - "All public methods have return type hints"
    - "AppConstants class exists with SCREAMING_SNAKE_CASE constants"
    - "No magic numbers remain in business logic"
  artifacts:
    - path: "tests/verify-architecture.php"
      provides: "Automated verification script for all 28 requirements"
    - path: ".planning/phases/41-architectural-verification/41-01-SUMMARY.md"
      provides: "Verification results report"
  key_links:
    - from: "tests/verify-architecture.php"
      to: "all src/ and core/ PHP files"
      via: "static analysis (grep, token_get_all, reflection)"
      pattern: "PASS|FAIL for each requirement"
---

<objective>
Create and run an automated verification script that checks all 28 v4.0 requirements via static code analysis. The script runs `php -l` on all files, uses grep/regex to verify structural patterns, and produces a PASS/FAIL report for each requirement.

Purpose: Prove that phases 36-40 delivered on all 28 requirements without manual inspection.
Output: tests/verify-architecture.php script + VERIFICATION results in SUMMARY.md
</objective>

<execution_context>
@/home/laudes/.claude/get-shit-done/workflows/execute-plan.md
@/home/laudes/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@docs/plans/2026-02-16-phase3-medium-priority-design.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive verification script</name>
  <files>tests/verify-architecture.php</files>
  <action>
Create a PHP CLI script at `tests/verify-architecture.php` that verifies all 28 requirements. The script should be runnable via `php tests/verify-architecture.php` from the plugin root. It should NOT require WordPress -- just pure PHP file analysis using file_get_contents, preg_match, token_get_all, etc.

The script must check each requirement and output PASS/FAIL with details:

**SVC-01..04 (Service Layer):**
- SVC-01: Verify `src/Learners/Services/LearnerService.php` exists and contains at least 3 public methods
- SVC-02: Verify `src/Agents/Services/AgentService.php` exists and contains at least 3 public methods
- SVC-03: Verify `src/Clients/Services/ClientService.php` exists and contains at least 3 public methods
- SVC-04: For each Controller file in `src/*/Controllers/*.php`, count lines per public method (using token analysis or regex between `public function` declarations). Flag any method >100 lines. Also check AJAX handlers in `src/*/Ajax/*.php`.

**MDL-01..04 (Model Architecture):**
- MDL-01: Verify `ClientsModel.php` contains `extends BaseModel` in class declaration
- MDL-02: Verify `AgentModel.php` contains `extends BaseModel` in class declaration
- MDL-03: Grep for `function get(`, `function set(`, `function toArray(` in ClientsModel.php and AgentModel.php. If found, verify they are overrides (call parent::) not duplicates. The key check: these methods should NOT exist as standalone implementations that ignore BaseModel.
- MDL-04: Verify both models have a `validate()` method or inherit one from BaseModel

**ADDR-01..05 (Address Storage):**
- ADDR-01: Verify a migration script exists. Search for files matching `*migration*agent*address*` or `*agent*location*migration*` in schema/ directory. Also check for migration logic in AgentRepository or AgentService (search for "location_id" or "locations" table references).
- ADDR-02: Verify AgentRepository reads from locations table -- grep for `locations` or `location_id` in AgentRepository.php read methods (getAgent, getAgentById, etc.)
- ADDR-03: Verify dual-write exists -- grep for BOTH locations table write AND old column write in AgentRepository.php or AgentService.php
- ADDR-04: Verify AgentService or AgentsController references LocationsModel or location linking during form submission
- ADDR-05: Cannot verify data preservation statically. Mark as "MANUAL CHECK REQUIRED -- verify agent addresses exist in locations table after migration"

**REPO-01..06 (Repository Pattern):**
- REPO-01: Scan all `*Repository.php` files for direct SQL (regex: `SELECT\s+.*FROM|INSERT\s+INTO|UPDATE\s+.*SET|DELETE\s+FROM` in string literals). Count total and classify.
- REPO-02: Verify LearnerRepository.php uses `findBy` or `$this->findBy` at least once
- REPO-03: Verify AgentRepository.php uses `findBy` or `$this->findBy` at least once
- REPO-04: Verify ClientRepository.php uses `findBy` or `$this->findBy` at least once
- REPO-05: Grep all repository files for `quoteIdentifier`. Count usages. Also check for any dynamic column name usage without quoteIdentifier (look for `ORDER BY {$` or similar patterns without quoting).
- REPO-06: Grep all repository files for `// Complex query:` bypass comments. Count them.

**TYPE-01..05 (Return Type Hints):**
- TYPE-01: In all `*Controller.php` files, find `public function` declarations. Check each has a return type (`: void`, `: string`, `: array`, etc.). Count typed vs untyped.
- TYPE-02: In all `*Model.php` files, same check.
- TYPE-03: In all `*Service.php` files, same check.
- TYPE-04: In all `*Repository.php` files, same check.
- TYPE-05: Verify no `public function foo(): mixed` exists (mixed should be documented with union types). Search for `: mixed` return types. If found, verify they are justified (polymorphic getters like getAgentMeta).

**CONST-01..04 (Constants):**
- CONST-01: Verify AppConstants.php exists and contains pagination-related constants (grep for PAGE_SIZE, PER_PAGE, PAGINATION, or LIMIT in SCREAMING_SNAKE_CASE)
- CONST-02: Verify AppConstants.php contains timeout constants (grep for TIMEOUT)
- CONST-03: Verify AppConstants.php or module-specific constants contain quantum/score limits (grep for QUANTUM, SCORE, MAX)
- CONST-04: Scan business logic files (Controllers, Services, Repositories) for bare magic numbers. Use regex to find numeric literals (e.g., `= 10;`, `= 20;`, `= 50;`, `= 100;`, `= 120;`) that are NOT inside SQL strings, NOT array indices, NOT comparison with 0/1, NOT in comments. Report any suspicious hits.

**Output format:** The script should print a structured report:
```
=== WeCoza v4.0 Architectural Verification ===

[SVC-01] Learner business logic extracted: PASS (LearnerService.php has 8 public methods)
[SVC-02] Agent business logic extracted: PASS (AgentService.php has 5 public methods)
...
[CONST-04] No magic numbers in business logic: PASS (0 suspicious hits)

=== SUMMARY ===
Passed: 25/28
Failed: 2/28
Manual: 1/28
```

Do NOT use overly strict checks that produce false positives. For TYPE-05, `: mixed` is acceptable for documented polymorphic methods. For CONST-04, skip known safe patterns (array indices, HTTP status codes in wp_send_json calls, 0/1 boolean-like values).
  </action>
  <verify>Run `php tests/verify-architecture.php` from the plugin root. Script should execute without errors and produce a PASS/FAIL report for all 28 requirements.</verify>
  <done>Script produces a report covering all 28 requirements. Each requirement gets PASS, FAIL, or MANUAL CHECK REQUIRED status with evidence.</done>
</task>

<task type="auto">
  <name>Task 2: Run PHP syntax check on all modified files</name>
  <files>tests/verify-architecture.php</files>
  <action>
Run `php -l` on ALL PHP files in the plugin to verify zero syntax errors. This covers Success Criteria #1 from the phase requirements.

Execute from plugin root:
```bash
find . -name "*.php" -not -path "./vendor/*" | xargs -I {} php -l {} 2>&1
```

If any syntax errors found, document them in the verification report.

Also run the verification script created in Task 1:
```bash
php tests/verify-architecture.php
```

Capture the full output. Analyze results for each of the 28 requirements. Document findings.

If any requirements FAIL:
- Document the specific failure with file paths and line numbers
- Assess severity: is it a genuine gap or a false positive in the check?
- For genuine gaps, note them for gap closure
- For false positives, adjust the verification script to be more accurate and re-run

Create the SUMMARY.md with the full verification results.
  </action>
  <verify>All PHP files pass syntax check (`php -l` returns 0 errors). Verification script runs successfully. SUMMARY.md contains complete results.</verify>
  <done>Zero syntax errors across all PHP files. Verification report documents status of all 28 requirements with PASS/FAIL/MANUAL evidence. Any genuine gaps are clearly identified for follow-up.</done>
</task>

</tasks>

<verification>
1. `php tests/verify-architecture.php` runs without PHP errors
2. Script covers all 28 requirements (SVC-01..04, MDL-01..04, ADDR-01..05, REPO-01..06, TYPE-01..05, CONST-01..04)
3. Each requirement gets a clear PASS/FAIL/MANUAL status with supporting evidence
4. `find . -name "*.php" -not -path "./vendor/*" | xargs php -l` shows zero syntax errors
5. SUMMARY.md contains actionable results
</verification>

<success_criteria>
- All 28 requirements verified programmatically where possible
- Zero PHP syntax errors across all plugin files
- Verification report identifies any gaps with specific file/line details
- Script is reusable for future regression checks
</success_criteria>

<output>
After completion, create `.planning/phases/41-architectural-verification/41-01-SUMMARY.md`
</output>
